root@ubuntu:/opt/krakenbot-staging# # Copiar dump al contenedor
docker cp /tmp/krakenbot_full.dump krakenbot-staging-db:/tmp/

# Restaurar
docker exec -it krakenbot-staging-db pg_restore -U krakenstaging -d krakenbot_staging --clean --no-owner /tmp/krakenbot_full.dump

# Sanitizar credenciales
docker exec -it krakenbot-staging-db psql -U krakenstaging -d krakenbot_staging -c "
UPDATE api_config SET
  kraken_api_key = NULL,
  kraken_api_secret = NULL,
  revolutx_api_key = NULL,
  revolutx_private_key = NULL,
  telegram_token = NULL,
  telegram_chat_id = NULL;
UPDATE bot_config SET dry_run_mode = true;
"

# Reiniciar app
docker restart krakenbot-staging-app

# Ver logs
docker logs -f krakenbot-staging-app
Successfully copied 1.74MB to krakenbot-staging-db:/tmp/
pg_restore: error: could not execute query: ERROR:  index "trades_kraken_order_id_uq" does not exist
Command was: DROP INDEX public.trades_kraken_order_id_uq;
pg_restore: error: could not execute query: ERROR:  index "idx_regime_state_pair" does not exist
Command was: DROP INDEX public.idx_regime_state_pair;
pg_restore: error: could not execute query: ERROR:  constraint "trade_fills_txid_key" of relation "trade_fills" does not exist
Command was: ALTER TABLE ONLY public.trade_fills DROP CONSTRAINT trade_fills_txid_key;
pg_restore: error: could not execute query: ERROR:  constraint "regime_state_pair_key" of relation "regime_state" does not exist
Command was: ALTER TABLE ONLY public.regime_state DROP CONSTRAINT regime_state_pair_key;
pg_restore: error: could not execute query: ERROR:  constraint "lot_matches_sell_fill_txid_lot_id_key" of relation "lot_matches" does not exist
Command was: ALTER TABLE ONLY public.lot_matches DROP CONSTRAINT lot_matches_sell_fill_txid_lot_id_key;
pg_restore: error: could not execute query: ERROR:  column "id" of relation "regime_state" does not exist
Command was: ALTER TABLE public.regime_state ALTER COLUMN id DROP DEFAULT;
pg_restore: error: could not execute query: ERROR:  sequence "regime_state_id_seq" does not exist
Command was: DROP SEQUENCE public.regime_state_id_seq;
pg_restore: error: could not execute query: ERROR:  extension "pgcrypto" does not exist
Command was: DROP EXTENSION pgcrypto;
pg_restore: warning: errors ignored on restore: 8
ERROR:  column "revolutx_api_key" of relation "api_config" does not exist
LINE 5:   revolutx_api_key = NULL,
          ^
krakenbot-staging-app

> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/app/drizzle.config.ts'
Using 'pg' driver for database querying
[⣷] Pulling schema from database...
[✓] Pulling schema from database...
[✓] Changes applied

> rest-express@1.0.0 start
> NODE_ENV=production node dist/index.cjs

11:46:24 PM [websocket] [WS] Servidor WebSocket inicializado en /ws/events
11:46:24 PM [websocket] [WS-LOGS] Terminal WebSocket inicializado en /ws/logs (docker: false)
[ExchangeFactory] Trading: kraken, Data: kraken
[startup] ExchangeFactory initialized. Active: kraken
11:46:24 PM [trading] [REGIME_PARAMS] enter=27 exit=23 hardExit=19 confirm=3 minHold=20 cooldown=60min
11:46:24 PM [trading] [EXCHANGE] Trading: kraken, Data: kraken
[telegram] Heartbeat iniciado (cada 12h)
[telegram] Reporte diario programado para las 14:00 (Europe/Madrid)
11:46:24 PM [express] serving on port 5000
npm error path /app
npm error command failed
npm error signal SIGTERM
npm error command sh -c NODE_ENV=production node dist/index.cjs
npm error A complete log of this run can be found in: /root/.npm/_logs/2026-01-09T23_46_23_844Z-debug-0.log

> rest-express@1.0.0 db:push
> drizzle-kit push

No config path provided, using default 'drizzle.config.ts'
Reading config file '/app/drizzle.config.ts'
Using 'pg' driver for database querying
[⣷] Pulling schema from database...
[⣯] Pulling schema from database...
[⣟] Pulling schema from database...
[✓] Pulling schema from database...
· You're about to add training_trades_buy_txid_unique unique constraint to the table, which contains 150 items. If this statement fails, you will receive an error from the database. Do you want to truncate training_trades table?

❯ No, add the constraint without truncating the table
  Yes, truncate the table
> rest-express@1.0.0 start
> NODE_ENV=production node dist/index.cjs

11:47:31 PM [websocket] [WS] Servidor WebSocket inicializado en /ws/events
11:47:31 PM [websocket] [WS-LOGS] Terminal WebSocket inicializado en /ws/logs (docker: false)
[startup] Error loading API credentials: error: column "kraken_enabled" does not exist
    at /app/dist/index.cjs:70:13356
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async /app/dist/index.cjs:70:28733
    at async M2.getApiConfig (/app/dist/index.cjs:70:32703)
    at async cJ (/app/dist/index.cjs:779:2385)
    at async /app/dist/index.cjs:813:5777 {
  length: 114,
  severity: 'ERROR',
  code: '42703',
  detail: undefined,
  hint: undefined,
  position: '73',
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'parse_relation.c',
  line: '3722',
  routine: 'errorMissingColumn'
}
11:47:31 PM [express] serving on port 5000
