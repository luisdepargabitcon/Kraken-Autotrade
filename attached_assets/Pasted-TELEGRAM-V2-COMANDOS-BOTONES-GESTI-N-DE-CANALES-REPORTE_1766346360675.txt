TELEGRAM V2 (COMANDOS + BOTONES + GESTIÃ“N DE CANALES) + REPORTE TÃ‰CNICO DIARIO NAS (14:00)

OBJETIVOS
1) Actualizar TODOS los mensajes de comandos (/start, /stop, /status, /sync, etc.) al mismo â€œdiseÃ±oâ€ de tus capturas (bloques con secciones, emojis, checks).
2) Actualizar â€œbotonesâ€ (inline keyboard) para que reflejen las opciones nuevas:
   - SMART_GUARD always-on (no SELL por seÃ±al)
   - Sync UPSERT por kraken_order_id
   - Orphan cleanup
   - GestiÃ³n de canales (Trading / Sistema / Errores / Noticias)
   - Daily report ON/OFF y hora
3) AÃ±adir un â€œReporte TÃ©cnico Diarioâ€ (NAS + bot) a las 14:00 hora local, como en tus imÃ¡genes:
   - Estado conexiones (Kraken/DB/Telegram)
   - Recursos NAS (CPU/Mem/Disk/Uptime)
   - Estado bot (modo, estrategia, pares, posiciones, exposiciÃ³n, PnL diario)
   - Enviar a canal â€œSistemaâ€ (y opcionalmente a â€œTradingâ€)

ASUNCIONES (si algo no existe, crearlo)
- Ya existe tabla/config de chats Telegram (telegram_chats) o equivalente.
- Ya existe servicio Telegram (server/services/telegram.ts) con sendMessage y callback queries.
- El servidor corre en Node/TS.

CAMBIOS REQUERIDOS

A) MENÃš PRINCIPAL CON BOTONES (INLINE KEYBOARD)
1) Implementar comando /menu (y tambiÃ©n botÃ³n â€œMenÃºâ€ en respuestas) que envÃ­e un mensaje con inline keyboard:

Botones (2 columnas recomendado):
- ğŸ“Š Estado (/status)
- ğŸ”„ Sync Kraken (/sync)
- ğŸ›¡ï¸ Modo SMART_GUARD (info + reglas)
- ğŸ“ˆ Trading (pares/estrategia)
- ğŸ“£ Canales (gestiÃ³n)
- ğŸ§¹ Orphan cleanup
- â° Reporte diario (config)
- ğŸŸ¢ Start / ğŸ”´ Stop

2) Implementar handlers de callback_query para cada botÃ³n:
   - callback_data: "MENU_STATUS", "MENU_SYNC", "MENU_CHANNELS", "MENU_DAILY", etc.
   - Cada callback responde editando el mensaje o enviando uno nuevo (evitar spam).

B) GESTIÃ“N DE CANALES (BOTONES + COMANDOS)
Objetivo: poder configurar a quÃ© chatId(s) se envÃ­a cada tipo de mensaje.

Tipos de canal (mÃ­nimo):
- TRADING: operaciones BUY/SELL y seÃ±ales relevantes
- SYSTEM: heartbeat, daily report, status tÃ©cnico
- ERRORS: errores/alertas crÃ­ticas (opcional)
- NEWS: noticias (si existe)

3) Comandos mÃ­nimos:
- /channels  -> muestra configuraciÃ³n actual y botones
- /set_trading_here -> marca el chat actual como canal TRADING
- /set_system_here  -> marca el chat actual como canal SYSTEM
- /unset_here       -> desregistra el chat actual
- /list_channels     -> lista todos los chats registrados y sus roles

4) UI con botones en /channels:
ğŸ“£ GESTIÃ“N DE CANALES
- âœ… TRADING: <chatId o nombre>
- âœ… SYSTEM: <chatId o nombre>
- â¬œ ERRORS: <â€¦>
- â¬œ NEWS: <â€¦>

Botones:
- â€œâœ… Usar este chat como TRADINGâ€
- â€œâœ… Usar este chat como SYSTEMâ€
- â€œâŒ Quitar este chatâ€
- â€œğŸ“ƒ Listarâ€
- â€œâ¬…ï¸ MenÃºâ€

ImplementaciÃ³n:
- En DB: tabla telegram_channels o reutilizar telegram_chats con columna "roles" (array/text) o flags boolean.
- Permitir varios chats por rol si quieres (ej. TRADING en canal + grupo); si no, imponer 1 por rol (mÃ¡s simple).

C) COMANDOS: MENSAJES â€œDISEÃ‘O CAPTURASâ€, DETALLADOS PERO BREVES
5) Estandarizar respuestas de comandos con el mismo layout (sin MarkdownV2, plain text):
- /start: confirma arranque + modo + dry_run/real + estrategia + pares + canales destino
- /stop: confirma parada + timestamp
- /status: bloque tipo â€œğŸ’— HEARTBEAT / SISTEMA OPERATIVOâ€ como capturas
- /sync: â€œğŸ”„ SYNC KRAKENâ€ + contadores: updated/inserted/skipped + duraciÃ³n
- /orphan_cleanup: â€œğŸ§¹ ORPHAN CLEANUPâ€ + quÃ© hizo + advertencia PnL N/A
- /help: lista breve de comandos + botÃ³n â€œMenÃºâ€

D) REPORTE TÃ‰CNICO DIARIO NAS (14:00)
6) AÃ±adir scheduler diario a las 14:00 (hora local) que envÃ­e un reporte al canal SYSTEM.
- Usar node-cron (recomendado) o scheduler existente (si ya tenÃ©is heartbeat jobs).
- Cron: "0 14 * * *"
- TZ: usar process.env.TZ si existe; si no, setear "Europe/Madrid" o el timezone del sistema.
- Evitar duplicados si se reinicia: guardar lastDailyReportDate (YYYY-MM-DD) en DB/config y no reenviar si ya se mandÃ³ hoy.

7) Datos que debe incluir el Daily Report (similar a tus imÃ¡genes):
ğŸ’— HEARTBEAT AUTOMÃTICO (REPORTE DIARIO 14:00)

âœ… Estado del sistema:
â€¢ Kraken: OK/ERROR
â€¢ DB: OK/ERROR
â€¢ Telegram: OK/ERROR

ğŸ“Š Recursos NAS:
â€¢ CPU: xx.x%  | Load: x.xx
â€¢ Memoria: used/total (xx.x%)
â€¢ Disco: used/total (xx.x%)  (usar "/" o la ruta del volumen principal)
â€¢ Uptime: Xd Yh Zm

ğŸ¤– Estado del bot:
â€¢ Entorno: NAS/PROD o REPLIT/DEV
â€¢ Modo: SMART_GUARD (ON) | DRY_RUN: true/false
â€¢ Estrategia: Momentum (Velas 15m)  (o la activa)
â€¢ Pares activos: BTC/USD, ETH/USD, â€¦
â€¢ Posiciones: abiertas=N | exposiciÃ³n USD=â€¦ | max lots/pair=â€¦
â€¢ PnL dÃ­a: $â€¦  (si existe dailyPnL)
â€¢ Ãšltima operaciÃ³n: <tipo> <par> <hora> (opcional)

ğŸ“£ Canales:
â€¢ TRADING: <â€¦>
â€¢ SYSTEM: <â€¦>

8) ImplementaciÃ³n de mÃ©tricas:
- CPU/Mem/Uptime: usar librerÃ­a "systeminformation" (npm i systeminformation) o fallback a "os".
- Disco: systeminformation.fsSize() o fallback "df -h /" via child_process.
- Estado conexiones: funciones existentes ping/health (Kraken/DB) o checks ligeros.
- Bot: usar estado ya disponible (config snapshot + open positions + dailyPnL).

E) MENSAJES DE TRADES (BUY/SELL) MANTENIENDO â€œDISEÃ‘O CAPTURASâ€
9) Mantener el formato tipo capturas para BUY/SELL (ya definido), y asegurarse:
- SELL incluye â€œğŸ’° Resultado del cierre: PnL cierre: +/- $X.XXâ€
- SELL muestra â€œğŸ›¡ï¸ Salida (SMART_GUARD): Tipo: TP/TRAIL/BE/SL/SCALE-OUT/EMERGENCYâ€
- Strategy/timeframe heredado (ya implementado) para evitar â€œCiclosâ€ incorrecto.

ACEPTACIÃ“N / TEST
1) /menu muestra botones correctos y cada botÃ³n funciona.
2) /channels permite setear este chat como TRADING o SYSTEM y persiste en DB.
3) /status devuelve mensaje estilo capturas con recursos y estado.
4) Daily report: se envÃ­a 1 vez al dÃ­a a las 14:00 al canal SYSTEM (no duplica con reinicios).
5) BUY/SELL siguen enviÃ¡ndose al canal TRADING con el mismo diseÃ±o, y SELL incluye PnL cierre USD.
6) SMART_GUARD: no se ejecutan SELL por seÃ±al; si se produce intento, solo log o mensaje â€œSELL ignoradoâ€.

ENTREGABLE
- PR con: scheduler daily report + comandos/menÃº + gestiÃ³n canales + mensajes actualizados + docs en replit.md con ejemplos y lista de comandos/botones.
