

===== FILE: ./replit.md =====
# KrakenBot - Autonomous Trading Bot

## Overview
KrakenBot is an autonomous cryptocurrency trading bot for the Kraken exchange. It features a web-based dashboard for monitoring, portfolio management (BTC, ETH, SOL, USD), and real-time Telegram notifications. Designed for 24/7 operation, it can be deployed on Replit or self-hosted via Docker. Its core purpose is to automate trading decisions based on predefined strategies and robust risk management, aiming to capitalize on market movements while protecting capital.

## User Preferences
- Preferred communication style: Simple, everyday language.
- **Entornos**: NAS es la fuente de verdad (producci√≥n y dataset IA). Replit solo para desarrollo y pruebas.
- **Sincronizaci√≥n**: No implementar export/import ni DB remota entre NAS y Replit.

## System Architecture

### Frontend
- **Framework**: React with TypeScript.
- **Styling**: Tailwind CSS, utilizing shadcn/ui components (New York style).
- **State Management**: TanStack React Query for server-side state.
- **Build**: Vite.
- **Real-time Events**: WebSocket-based event streaming and terminal logs to the Monitor page.

### Backend
- **Framework**: Express.js with TypeScript.
- **Runtime**: Node.js.
- **API**: RESTful endpoints (`/api/*`).
- **Services**: KrakenService for exchange interaction, TelegramService for notifications, AiService for ML filter.

### Data Storage
- **Database**: PostgreSQL with Drizzle ORM.
- **Schema**: Defined in `shared/schema.ts`.
- **Key Tables**: `bot_config`, `api_config`, `trades`, `notifications`, `open_positions`, `training_trades`, `ai_config`.

### Trading Engine
- **Core Loop**: Executes every 10-30 seconds for balance checks, resets, stop-loss/take-profit, and strategy analysis.
- **Strategies**: Momentum, Mean Reversion, Scalping, Grid Trading.
- **Multi-Timeframe Analysis (MTF)**: Analyzes 5-min, 1-hour, and 4-hour trends.
- **Trade Execution**: Market orders, database logging, position updates, Telegram notifications.
- **Position Modes**: SINGLE (one position per pair), DCA (multiple entries), and SMART_GUARD (intelligent capital protection).

### Risk Management
- **Filters**: Commission profitability, exposure control (per pair, total, per trade), bid-ask spread, trading hours.
- **Dynamic Adjustments**: Dynamic position sizing based on signal confidence.
- **Loss Control**: Stop-Loss/Take-Profit, Trailing Stop, Daily Loss Limit, Cooldown System.
- **Kraken Compliance**: Adherence to Kraken minimum trade volumes and real balance verification.
- **Position Persistence**: Open positions are stored in the database.
- **Configuration Snapshot**: New positions store a snapshot of trading parameters at entry.

### SMART_GUARD Mode
- **Purpose**: Intelligent capital protection with strict entry validation.
- **Sizing v2 (Auto Fallback)**:
  - `sgMinEntryUsd` es un "objetivo preferido", no un bloqueo.
  - Si `availableUsd >= sgMinEntryUsd` ‚Üí orden = `sgMinEntryUsd` exacto (no m√°s).
  - Si `availableUsd < sgMinEntryUsd` ‚Üí orden = saldo disponible (fallback autom√°tico).
  - `floorUsd = max(minOrderExchangeUsd, $20)` ‚Üí m√≠nimo absoluto (hard block).
  - Si `availableUsd < floorUsd` ‚Üí trade bloqueado.
  - **Fee Cushion**: Si `sgFeeCushionPct` o `sgFeeCushionAuto` activo, resta reserva para fees antes de sizing.
  - **sgAllowUnderMin DEPRECATED**: Ya no afecta el comportamiento (siempre fallback autom√°tico).
- **Reason Codes**:
  - `SMART_GUARD_ENTRY_USING_CONFIG_MIN`: Saldo suficiente, usa sgMinEntryUsd.
  - `SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE`: Saldo insuficiente, usa saldo disponible.
  - `SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN`: Saldo < floorUsd (hard block).
  - `SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION`: Fee cushion reduce saldo por debajo de floorUsd.
- **Break-Even Protection**: Moves stop-loss to entry price + fees when profit reaches sgBeAtPct.
- **Trailing Stop**: Activates at sgTrailStartPct profit, follows at sgTrailDistancePct, updates at sgTrailStepPct steps.
- **Fixed Take-Profit**: Optional sgTpFixedPct for guaranteed profit capture.
- **Scale-Out**: Optional partial profit taking at sgScaleOutPct before fixed TP.
- **Per-Pair Overrides**: sgPairOverrides allows customizing parameters per trading pair via API and UI.
- **Diagnostic Endpoint**: GET /api/scan/diagnostic provides scan results with Spanish reasons.
- **Test Endpoint**: POST /api/test/sg-sizing para simular sizing v2 (solo en dev/dryRun).
- **Telegram Alerts**: Notifications for key events (Break-Even activation, Trailing Stop activation/updates, Scale-Out execution) with 5-min throttle on trailing updates.
- **Override API**: GET/PUT/DELETE /api/config/sg-overrides/:pair for managing per-pair parameters.
- **Event Types**: SG_BREAK_EVEN_ACTIVATED, SG_TRAILING_ACTIVATED, SG_TRAILING_STOP_UPDATED, SG_SCALE_OUT_EXECUTED, CONFIG_OVERRIDE_UPDATED.

### Environment Safety
- **DRY_RUN Mode**: Prevents real orders from being sent to exchange.
- **Auto-Detection**: Replit environment (REPLIT_DEPLOYMENT, REPL_ID) forces DRY_RUN automatically.
- **NAS Control**: On NAS, dryRunMode can be toggled via bot_config.
- **Simulation**: In DRY_RUN, executeTrade() logs events and sends "[DRY_RUN] Trade Simulado" Telegram messages without touching Kraken.
- **Production Safety**: NAS is the source of truth for production trading; Replit is development/testing only.

### FIFO Position Matching
- **Purpose**: Automatic position closing with partial fills tracking to eliminate "phantom positions."
- **Tables**:
  - `trade_fills`: Individual fills with UNIQUE(txid), matched flag for idempotency.
  - `lot_matches`: FIFO matching audit trail with UNIQUE(sellFillTxid, lotId).
  - `open_positions.qtyRemaining/qtyFilled`: Track partial consumption of buy lots.
- **FIFO Logic**:
  - Sell fills match against oldest buy lots first (ORDER BY openedAt ASC).
  - Uses SELECT FOR UPDATE within transaction to prevent concurrent double-consumption.
  - Pro-rates buy/sell fees based on matched quantity for accurate P&L.
- **Orphan Handling**: 
  - Fills only marked `matched=true` when fully processed (sellRemaining ‚âà 0).
  - Orphan fills (no matching lots) remain unmatched for future retry.
- **API Endpoints**:
  - `POST /api/fifo/init-lots`: Initialize qtyRemaining = amount for existing lots.
  - `POST /api/fifo/process-sells`: Process all unmatched sell fills.
  - `POST /api/fifo/ingest-fill`: Ingest a new fill and trigger FIFO matching.
  - `GET /api/fifo/open-lots`: Get lots with qtyRemaining > 0.
- **Auto-Integration**: After each real sell execution in `executeTrade()`, the trading engine automatically:
  1. Creates a TradeFill record with txid, pair, price, amount, and estimated fee
  2. Triggers `fifoMatcher.processSellFill()` to match against open buy lots
  3. Logs matching results (lots closed, P&L, orphan qty)
  4. Only runs for real trades (DRY_RUN mode is safely bypassed with triple guard)
- **Transaction Safety**: All operations (lot select, match insert, qty update, fill mark) run within same tx handle.

### AI Filter Module
- **Purpose**: Machine learning filter to approve/reject trade signals based on historical performance.
- **Phases**: Red (data collection), Yellow (ready to train), Green (filter active).
- **Training Data**: `training_trades` table stores BUY/SELL pairs with PnL labels. Backfill reconstructs data.
- **Discard Reasons**: Excludes invalid or anomalous trades from training data.
- **Diagnostic Metrics**: Provides aggregated counts of discard reasons and open trades/lots.

### Telegram Integration
- **Functionality**: Sends notifications for bot status, trade executions, risk management triggers, and errors.
- **Commands (Docker/NAS)**: Supports commands like `/estado`, `/pausar`, `/reanudar`.
- **Modes**: Polling for Docker/NAS deployments (commands), disabled for Replit (notifications only).
- **Features**: Rate limiting to prevent spam and multi-chat support.

## External Dependencies

- **Kraken Exchange API**:
    - **Package**: `node-kraken-api`.
    - **Purpose**: Trading operations (execute, fetch balances, market data).
    - **Configuration**: API key/secret stored in `api_config` table.

- **Telegram Bot API**:
    - **Package**: `node-telegram-bot-api`.
    - **Purpose**: Send notifications and receive commands.
    - **Configuration**: Bot token and chat ID stored in `api_config` table.

- **PostgreSQL Database**:
    - **ORM**: Drizzle ORM.
    - **Connection**: Via `DATABASE_URL` environment variable.
    - **Driver**: `pg`.

===== FILE: ./docker-compose.yml =====
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: kraken-bot-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: krakenbot
      POSTGRES_PASSWORD: ${DB_PASSWORD:-KrakenBot2024Seguro}
      POSTGRES_DB: krakenbot
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - krakenbot-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U krakenbot"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  app:
    image: node:20-alpine
    container_name: kraken-bot-app
    restart: unless-stopped
    working_dir: /app
    ports:
      - "3000:5000"
    environment:
      NODE_ENV: production
      DOCKER_ENV: "true"
      PORT: 5000
      DATABASE_URL: postgres://krakenbot:${DB_PASSWORD:-KrakenBot2024Seguro}@postgres:5432/krakenbot
      KRAKEN_API_KEY: ${KRAKEN_API_KEY:-}
      KRAKEN_API_SECRET: ${KRAKEN_API_SECRET:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      WS_ADMIN_TOKEN: ${WS_ADMIN_TOKEN:-}
      TERMINAL_TOKEN: ${TERMINAL_TOKEN:-}
      ENABLE_DOCKER_LOGS_STREAM: "true"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - krakenbot-network
    volumes:
      - /share/ZFS37_DATA/share/Container/krakenbot:/app
      - node_modules:/app/node_modules
      - /var/run/docker.sock:/var/run/docker.sock
    command: >
      sh -c "
        apk add --no-cache docker-cli git &&
        npm install --include=dev &&
        npx tsx script/build.ts &&
        npx tsx script/migrate.ts &&
        npm start
      "
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  krakenbot-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  node_modules:
    driver: local


===== FILE: ./Dockerfile =====
FROM node:20-alpine

WORKDIR /app

RUN apk add --no-cache libc6-compat git

COPY package.json package-lock.json* ./

RUN npm install

COPY . .

# Create VERSION file with git commit hash (if .git exists)
RUN if [ -d .git ]; then git rev-parse --short HEAD > VERSION; else echo "unknown" > VERSION; fi

RUN npm run build

EXPOSE 5000

ENV NODE_ENV=production
ENV PORT=5000

CMD ["sh", "-c", "npm run db:push && npm start"]


===== FILE: ./vite-plugin-meta-images.ts =====
import type { Plugin } from 'vite';
import fs from 'fs';
import path from 'path';

/**
 * Vite plugin that updates og:image and twitter:image meta tags
 * to point to the app's opengraph image with the correct Replit domain.
 */
export function metaImagesPlugin(): Plugin {
  return {
    name: 'vite-plugin-meta-images',
    transformIndexHtml(html) {
      const baseUrl = getDeploymentUrl();
      if (!baseUrl) {
        log('[meta-images] no Replit deployment domain found, skipping meta tag updates');
        return html;
      }

      // Check if opengraph image exists in public directory
      const publicDir = path.resolve(process.cwd(), 'client', 'public');
      const opengraphPngPath = path.join(publicDir, 'opengraph.png');
      const opengraphJpgPath = path.join(publicDir, 'opengraph.jpg');
      const opengraphJpegPath = path.join(publicDir, 'opengraph.jpeg');

      let imageExt: string | null = null;
      if (fs.existsSync(opengraphPngPath)) {
        imageExt = 'png';
      } else if (fs.existsSync(opengraphJpgPath)) {
        imageExt = 'jpg';
      } else if (fs.existsSync(opengraphJpegPath)) {
        imageExt = 'jpeg';
      }

      if (!imageExt) {
        log('[meta-images] OpenGraph image not found, skipping meta tag updates');
        return html;
      }

      const imageUrl = `${baseUrl}/opengraph.${imageExt}`;

      log('[meta-images] updating meta image tags to:', imageUrl);

      html = html.replace(
        /<meta\s+property="og:image"\s+content="[^"]*"\s*\/>/g,
        `<meta property="og:image" content="${imageUrl}" />`
      );

      html = html.replace(
        /<meta\s+name="twitter:image"\s+content="[^"]*"\s*\/>/g,
        `<meta name="twitter:image" content="${imageUrl}" />`
      );

      return html;
    },
  };
}

function getDeploymentUrl(): string | null {
  if (process.env.REPLIT_INTERNAL_APP_DOMAIN) {
    const url = `https://${process.env.REPLIT_INTERNAL_APP_DOMAIN}`;
    log('[meta-images] using internal app domain:', url);
    return url;
  }

  if (process.env.REPLIT_DEV_DOMAIN) {
    const url = `https://${process.env.REPLIT_DEV_DOMAIN}`;
    log('[meta-images] using dev domain:', url);
    return url;
  }

  return null;
}

function log(...args: any[]): void {
  if (process.env.NODE_ENV === 'production') {
    console.log(...args);
  }
}


===== FILE: ./tsconfig.json =====
{
  "include": ["client/src/**/*", "shared/**/*", "server/**/*"],
  "exclude": ["node_modules", "build", "dist", "**/*.test.ts"],
  "compilerOptions": {
    "incremental": true,
    "tsBuildInfoFile": "./node_modules/typescript/tsbuildinfo",
    "noEmit": true,
    "module": "ESNext",
    "strict": true,
    "lib": ["esnext", "dom", "dom.iterable"],
    "jsx": "preserve",
    "esModuleInterop": true,
    "skipLibCheck": true,
    "allowImportingTsExtensions": true,
    "moduleResolution": "bundler",
    "baseUrl": ".",
    "types": ["node", "vite/client"],
    "paths": {
      "@/*": ["./client/src/*"],
      "@shared/*": ["./shared/*"]
    }
  }
}


===== FILE: ./vite.config.ts =====
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import tailwindcss from "@tailwindcss/vite";
import path from "path";
import runtimeErrorOverlay from "@replit/vite-plugin-runtime-error-modal";
import { metaImagesPlugin } from "./vite-plugin-meta-images";

export default defineConfig({
  plugins: [
    react(),
    runtimeErrorOverlay(),
    tailwindcss(),
    metaImagesPlugin(),
    ...(process.env.NODE_ENV !== "production" &&
    process.env.REPL_ID !== undefined
      ? [
          await import("@replit/vite-plugin-cartographer").then((m) =>
            m.cartographer(),
          ),
          await import("@replit/vite-plugin-dev-banner").then((m) =>
            m.devBanner(),
          ),
        ]
      : []),
  ],
  resolve: {
    alias: {
      "@": path.resolve(import.meta.dirname, "client", "src"),
      "@shared": path.resolve(import.meta.dirname, "shared"),
      "@assets": path.resolve(import.meta.dirname, "attached_assets"),
    },
  },
  css: {
    postcss: {
      plugins: [],
    },
  },
  root: path.resolve(import.meta.dirname, "client"),
  build: {
    outDir: path.resolve(import.meta.dirname, "dist/public"),
    emptyOutDir: true,
  },
  server: {
    host: "0.0.0.0",
    allowedHosts: true,
    fs: {
      strict: true,
      deny: ["**/.*"],
    },
  },
});


===== FILE: ./scripts/deploy-to-nas.md =====
# Gu√≠a de Despliegue a QNAP NAS

## M√©todo 1: Actualizaci√≥n R√°pida (Recomendado)

### Paso 1: Descargar el proyecto actualizado

En Replit, descarga el proyecto como ZIP:
1. Haz clic en los tres puntos (...) en la barra lateral
2. Selecciona "Download as zip"

### Paso 2: Subir al NAS

1. Abre File Station en tu QNAP
2. Navega a: `/share/ZFS37_DATA/share/Container/krakenbot`
3. Crea una carpeta de backup: `krakenbot_backup_FECHA`
4. Copia los archivos actuales a la carpeta de backup
5. Extrae el ZIP descargado y reemplaza los archivos (excepto `.env`)

### Paso 3: Reconstruir y reiniciar

Conecta por SSH a tu NAS y ejecuta:

```bash
cd /share/ZFS37_DATA/share/Container/krakenbot

# Detener el contenedor actual
docker-compose down

# Reconstruir la imagen con los nuevos cambios
docker-compose build --no-cache

# Iniciar de nuevo
docker-compose up -d

# Ver logs para confirmar que funciona
docker logs -f krakenbot
```

---

## M√©todo 2: Git (Automatizado)

Si configuraste Git en el NAS:

```bash
cd /share/ZFS37_DATA/share/Container/krakenbot

# Guardar cambios locales
git stash

# Obtener actualizaciones
git pull origin main

# Restaurar cambios locales
git stash pop

# Reconstruir y reiniciar
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

---

## M√©todo 3: Script Autom√°tico

1. Copia el archivo `scripts/update-nas.sh` a tu NAS
2. Dale permisos de ejecuci√≥n: `chmod +x update-nas.sh`
3. Ejecuta: `./update-nas.sh`

---

## Archivos que NO debes sobreescribir

- `.env` - Contiene la configuraci√≥n de base de datos
- `data/` - Si tienes datos persistentes fuera de PostgreSQL

## Verificaci√≥n post-actualizaci√≥n

1. Abre http://192.168.1.104:3000
2. Verifica que Kraken est√° conectado (indicador verde)
3. Verifica que Telegram est√° conectado (indicador verde)
4. Revisa que las pesta√±as PANEL, ESTRATEGIAS, HISTORIAL, CARTERA y AJUSTES funcionan

## Soluci√≥n de problemas

### El contenedor no inicia
```bash
docker logs krakenbot
```

### Error de base de datos
```bash
docker-compose down
docker volume rm krakenbot_postgres_data
docker-compose up -d
```
(Nota: Esto borrar√° todos los datos de la base de datos)

### Restaurar backup
```bash
docker-compose down
cp -r /share/ZFS37_DATA/share/Container/krakenbot_backups/BACKUP_NAME/* .
docker-compose up -d
```


===== FILE: ./scripts/update-nas.sh =====
#!/bin/bash

# Script de actualizaci√≥n para KrakenBot en QNAP NAS
# Uso: ./update-nas.sh

set -e

# Configuraci√≥n - Ajusta seg√∫n tu entorno
NAS_PATH="/share/ZFS37_DATA/share/Container/krakenbot"
CONTAINER_NAME="krakenbot"
BACKUP_DIR="/share/ZFS37_DATA/share/Container/krakenbot_backups"

echo "================================================"
echo "  KRAKENBOT - Script de Actualizaci√≥n para NAS"
echo "================================================"
echo ""

# Crear directorio de backups si no existe
mkdir -p "$BACKUP_DIR"

# Backup de la versi√≥n actual
BACKUP_NAME="krakenbot_backup_$(date +%Y%m%d_%H%M%S)"
echo "[1/5] Creando backup de la versi√≥n actual..."
if [ -d "$NAS_PATH" ]; then
    cp -r "$NAS_PATH" "$BACKUP_DIR/$BACKUP_NAME"
    echo "      Backup guardado en: $BACKUP_DIR/$BACKUP_NAME"
else
    echo "      No se encontr√≥ instalaci√≥n previa, saltando backup..."
fi

# Detener el contenedor actual
echo ""
echo "[2/5] Deteniendo contenedor actual..."
docker stop "$CONTAINER_NAME" 2>/dev/null || echo "      Contenedor no estaba corriendo"

# Actualizar archivos (asume que los nuevos archivos est√°n en el directorio actual)
echo ""
echo "[3/5] Actualizando archivos..."
# Preservar el .env y la base de datos
if [ -f "$NAS_PATH/.env" ]; then
    cp "$NAS_PATH/.env" /tmp/krakenbot_env_backup
fi

# Copiar nuevos archivos (ajusta la ruta origen seg√∫n necesites)
# rsync -av --exclude='.env' --exclude='node_modules' --exclude='.git' ./ "$NAS_PATH/"

echo "      Archivos actualizados"

# Restaurar .env
if [ -f "/tmp/krakenbot_env_backup" ]; then
    cp /tmp/krakenbot_env_backup "$NAS_PATH/.env"
    echo "      Archivo .env restaurado"
fi

# Reconstruir imagen Docker
echo ""
echo "[4/5] Reconstruyendo imagen Docker..."
cd "$NAS_PATH"
docker-compose build --no-cache

# Reiniciar contenedor
echo ""
echo "[5/5] Iniciando contenedor actualizado..."
docker-compose up -d

echo ""
echo "================================================"
echo "  ¬°Actualizaci√≥n completada!"
echo "================================================"
echo ""
echo "  El bot est√° disponible en: http://192.168.1.104:3000"
echo ""
echo "  Para ver los logs:"
echo "    docker logs -f $CONTAINER_NAME"
echo ""
echo "  En caso de problemas, restaurar backup:"
echo "    docker-compose down"
echo "    rm -rf $NAS_PATH/*"
echo "    cp -r $BACKUP_DIR/$BACKUP_NAME/* $NAS_PATH/"
echo "    docker-compose up -d"
echo ""


===== FILE: ./GUIA_INSTALACION.md =====
# ü§ñ GU√çA COMPLETA: KrakenBot en tu QNAP NAS

**Bot de Trading Aut√≥nomo para Kraken Exchange**

Esta gu√≠a te lleva paso a paso desde cero hasta tener el bot funcionando.

---

# üìã ANTES DE EMPEZAR

## Lo que vas a necesitar:

| Cosa | Para qu√© |
|------|----------|
| NAS QNAP | Donde correr√° el bot 24/7 |
| Cuenta Kraken | Para hacer trading |
| Cuenta Telegram | Para recibir notificaciones |
| 30 minutos | Tiempo aproximado de instalaci√≥n |

---

# PASO 1: PREPARAR TU NAS

## 1.1 Instalar Container Station

1. Abre la interfaz web de tu NAS: `http://TU_IP_NAS:8080`
2. Inicia sesi√≥n con tu usuario administrador
3. Abre el **App Center** (icono de bolsa de compras)
4. Busca: `Container Station`
5. Haz clic en **Instalar**
6. Espera 5-10 minutos a que termine

## 1.2 Crear la carpeta del proyecto

1. Abre **File Station** en tu NAS
2. Navega a: `Container`
3. Crea una nueva carpeta llamada: `krakenbot`
4. Ruta final: `/share/Container/krakenbot/`

---

# PASO 2: DESCARGAR Y COPIAR EL PROYECTO

## 2.1 Descargar el proyecto

1. En Replit, haz clic en los **tres puntos (‚ãÆ)** arriba del explorador de archivos
2. Selecciona **"Download as zip"**
3. Guarda el archivo ZIP en tu ordenador

## 2.2 Copiar al NAS

1. Descomprime el ZIP en tu ordenador
2. Abre **File Station** en tu NAS
3. Navega a: `/share/Container/krakenbot/`
4. Arrastra y suelta TODOS los archivos dentro

### Estructura final:
```
/share/Container/krakenbot/
‚îú‚îÄ‚îÄ üìÅ client/
‚îú‚îÄ‚îÄ üìÅ server/
‚îú‚îÄ‚îÄ üìÅ shared/
‚îú‚îÄ‚îÄ üìÑ docker-compose.yml
‚îú‚îÄ‚îÄ üìÑ Dockerfile
‚îú‚îÄ‚îÄ üìÑ package.json
‚îî‚îÄ‚îÄ üìÑ ... (resto de archivos)
```

---

# PASO 3: OBTENER API KEYS DE KRAKEN

## 3.1 Crear cuenta en Kraken (si no tienes)

1. Ve a: **https://www.kraken.com**
2. Haz clic en **Crear cuenta**
3. Completa el registro
4. **Importante:** Verifica tu identidad (KYC)

## 3.2 Generar las API Keys

1. Inicia sesi√≥n en Kraken
2. Haz clic en tu nombre (arriba a la derecha)
3. Ve a: **Seguridad** ‚Üí **API**
4. Haz clic en **Crear clave API**

## 3.3 Configurar permisos

Marca SOLO estas opciones:
- ‚úÖ Query Funds
- ‚úÖ Query Open Orders & Trades
- ‚úÖ Query Closed Orders & Trades
- ‚úÖ Create & Modify Orders

**‚ö†Ô∏è NUNCA marques:**
- ‚ùå Withdraw Funds (Retirar fondos)

## 3.4 Guardar las claves

Haz clic en **Generar clave** y copia:

| Dato | Ejemplo | Gu√°rdalo en un lugar seguro |
|------|---------|----------------------------|
| API Key | `xAbCdEfGhIjK...` | ‚úÖ |
| Private Key (Secret) | `aBcDeFgHiJkL...` | ‚úÖ |

**‚ö†Ô∏è El Secret solo se muestra UNA VEZ. Si lo pierdes, crea una nueva API Key.**

---

# PASO 4: CREAR BOT DE TELEGRAM

## 4.1 Crear el Bot

1. Abre **Telegram** en tu m√≥vil o PC
2. Busca: `@BotFather`
3. Escribe: `/newbot`
4. Nombre del bot: `KrakenBot Alertas`
5. Username: `MiKrakenBot_bot` (debe terminar en `bot`)
6. **Copia el Token** que te da:
   ```
   7123456789:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw
   ```

## 4.2 Obtener tu Chat ID

1. En Telegram, busca: `@userinfobot`
2. Env√≠ale cualquier mensaje
3. **Copia el n√∫mero de "Id"**: `123456789`

## 4.3 Resumen de datos de Telegram

| Dato | Ejemplo |
|------|---------|
| Bot Token | `7123456789:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw` |
| Chat ID | `123456789` |

---

# PASO 5: CONFIGURAR LA CONTRASE√ëA

## 5.1 Editar docker-compose.yml

1. En File Station, navega a: `/share/Container/krakenbot/`
2. Haz clic derecho en `docker-compose.yml`
3. Selecciona **Abrir con editor de texto**
4. Busca estas dos l√≠neas:
   ```yaml
   POSTGRES_PASSWORD: TuPasswordSegura123!
   ```
   y
   ```yaml
   DATABASE_URL: postgres://krakenbot:TuPasswordSegura123!@postgres:5432/krakenbot
   ```
5. Cambia `TuPasswordSegura123!` por tu propia contrase√±a **en ambas l√≠neas**
6. Guarda el archivo

---

# PASO 6: INICIAR EL BOT

## Opci√≥n A: Desde Container Station (Recomendado)

1. Abre **Container Station** en tu NAS
2. Ve a **Aplicaciones** (o "Applications")
3. Haz clic en **Crear** (o "Create")
4. Nombre: `krakenbot`
5. En "Ruta YAML" selecciona: `/share/Container/krakenbot/docker-compose.yml`
6. Haz clic en **Crear**
7. Espera 3-5 minutos mientras se instala todo

## Opci√≥n B: Desde terminal/SSH

### En Windows:
1. Abre **PowerShell**
2. Escribe:
   ```
   ssh admin@192.168.1.XXX
   ```
   (cambia XXX por la IP de tu NAS)
3. Introduce tu contrase√±a del NAS
4. Ejecuta:
   ```bash
   cd /share/Container/krakenbot
   docker-compose up -d
   ```

### En Mac/Linux:
1. Abre **Terminal**
2. Escribe:
   ```bash
   ssh admin@192.168.1.XXX
   cd /share/Container/krakenbot
   docker-compose up -d
   ```

## Ver el progreso de instalaci√≥n:
```bash
docker-compose logs -f app
```

Ver√°s algo como:
```
üöÄ Instalando dependencias...
üî® Compilando aplicacion...
üì¶ Sincronizando base de datos...
‚úÖ Iniciando KrakenBot...
```

---

# PASO 7: CONFIGURAR EL BOT DESDE LA WEB

## 7.1 Acceder al Panel de Control

1. Abre tu navegador
2. Ve a: `http://TU_IP_NAS:3000`
   - Ejemplo: `http://192.168.1.100:3000`
3. Ver√°s el dashboard del bot

## 7.2 Ir a Ajustes

1. En el men√∫ superior, haz clic en **AJUSTES**

## 7.3 Conectar Kraken

1. En la secci√≥n **"API de Kraken"**:
   - **API Key:** Pega tu API Key de Kraken
   - **API Secret:** Pega tu Private Key/Secret
2. Haz clic en **Conectar a Kraken**
3. Debe aparecer: ‚úÖ **CONECTADO**

## 7.4 Conectar Telegram

1. En la secci√≥n **"Notificaciones Telegram"**:
   - **Bot Token:** Pega el token que te dio BotFather
   - **Chat ID:** Pega tu n√∫mero de ID
2. Haz clic en **Probar Conexi√≥n**
3. **Revisa Telegram** - deber√≠as recibir un mensaje de prueba

---

# PASO 8: ACTIVAR EL BOT

1. Haz clic en **PANEL** en el men√∫ superior
2. En **"CONTROL DEL SISTEMA"**:
   - Elige una **Estrategia** (empieza con MOMENTUM_ALPHA_V2)
   - Elige **Nivel de Riesgo** (empieza con BAJO)
3. Haz clic en el bot√≥n **INICIAR**
4. El indicador cambiar√° a üü¢ **EN L√çNEA**
5. Recibir√°s una notificaci√≥n en Telegram

---

# ‚úÖ ¬°LISTO!

Tu bot de trading est√° funcionando en tu NAS 24/7.

---

# üìñ COMANDOS √öTILES

Conecta por SSH a tu NAS y usa estos comandos:

| Acci√≥n | Comando |
|--------|---------|
| Ver logs en tiempo real | `docker-compose logs -f app` |
| Reiniciar el bot | `docker-compose restart app` |
| Parar el bot | `docker-compose down` |
| Iniciar el bot | `docker-compose up -d` |
| Ver estado | `docker-compose ps` |

---

# ‚ùì SOLUCI√ìN DE PROBLEMAS

## "No puedo acceder a http://IP:3000"
- Verifica que la IP es correcta
- Espera 5 minutos (la primera instalaci√≥n tarda)
- Revisa los logs: `docker-compose logs -f app`

## "Error al conectar con Kraken"
- Revisa que copiaste bien la API Key y el Secret
- Verifica que la API Key tiene los permisos correctos
- Aseg√∫rate que tu cuenta Kraken est√° verificada

## "No recibo notificaciones en Telegram"
- Env√≠a un mensaje a tu bot primero (cualquier cosa)
- Verifica que el Chat ID es correcto
- Comprueba que el Token es correcto

## "El contenedor no arranca"
- Revisa los logs: `docker-compose logs app`
- Verifica que la contrase√±a es igual en las dos l√≠neas del docker-compose.yml
- Aseg√∫rate que hay espacio en disco

---

# üîí SEGURIDAD

1. **NUNCA** compartas tus API Keys
2. **NUNCA** actives permisos de retiro en Kraken
3. Usa contrase√±as seguras
4. El bot solo tiene acceso a tu red local
5. Empieza con cantidades peque√±as

---

# üìä RESUMEN DE DATOS

Guarda esta tabla en un lugar seguro:

| Dato | Valor | D√≥nde se usa |
|------|-------|--------------|
| IP del NAS | `192.168.1.___` | Acceder al panel |
| URL del Panel | `http://IP:3000` | Navegador |
| Kraken API Key | `____________` | Ajustes ‚Üí Kraken |
| Kraken Secret | `____________` | Ajustes ‚Üí Kraken |
| Telegram Token | `____________` | Ajustes ‚Üí Telegram |
| Telegram Chat ID | `____________` | Ajustes ‚Üí Telegram |
| Password BD | `____________` | docker-compose.yml |

---

# ‚ö†Ô∏è ADVERTENCIA LEGAL

- Este bot opera con **dinero real**
- Los mercados de criptomonedas son **muy vol√°tiles**
- **Nunca inviertas** m√°s de lo que puedas perder
- El bot es una herramienta, **no garantiza ganancias**
- T√∫ eres el √∫nico responsable de tus operaciones

---

**¬°Buena suerte con tu trading!** üöÄ


===== FILE: ./server/routes.ts =====
import type { Express } from "express";
import { createServer, type Server } from "http";
import { storage } from "./storage";
import { krakenService } from "./services/kraken";
import { telegramService } from "./services/telegram";
import { TradingEngine } from "./services/tradingEngine";
import { botLogger } from "./services/botLogger";
import { aiService } from "./services/aiService";
import { eventsWs } from "./services/eventsWebSocket";
import { terminalWsServer } from "./services/terminalWebSocket";
import { environment } from "./services/environment";
import { z } from "zod";

let tradingEngine: TradingEngine | null = null;

export function initializeWebSockets(httpServer: Server): void {
  eventsWs.initialize(httpServer);
  terminalWsServer.initialize(httpServer);
  
  httpServer.on("upgrade", (req, socket, head) => {
    const pathname = new URL(req.url || "", `http://${req.headers.host}`).pathname;
    
    if (pathname === "/ws/events") {
      eventsWs.handleUpgrade(req, socket, head);
    } else if (pathname === "/ws/logs") {
      terminalWsServer.handleUpgrade(req, socket, head);
    } else {
      socket.destroy();
    }
  });
}

export async function registerRoutes(
  httpServer: Server,
  app: Express
): Promise<Server> {
  
  // Health check endpoint - MUST be registered before any other routes
  // Returns JSON for monitoring/load balancers (not index.html)
  // Returns 503 on errors so monitors can detect failures
  app.get("/api/health", async (req, res) => {
    try {
      const schemaStatus = await storage.checkSchemaHealth();
      if (!schemaStatus.healthy) {
        // Schema issues - return 503 so monitors detect the problem
        return res.status(503).json({
          status: "unhealthy",
          timestamp: new Date().toISOString(),
          schema: schemaStatus,
          uptime: process.uptime(),
          message: "Schema migration required. Missing columns: " + schemaStatus.missingColumns.join(", "),
        });
      }
      res.json({
        status: "ok",
        timestamp: new Date().toISOString(),
        schema: schemaStatus,
        uptime: process.uptime(),
      });
    } catch (error) {
      // Return 503 on errors so monitors can detect failures
      res.status(503).json({
        status: "error",
        timestamp: new Date().toISOString(),
        error: error instanceof Error ? error.message : "Unknown error",
      });
    }
  });

  // Load saved API credentials on startup
  try {
    const apiConfig = await storage.getApiConfig();
    if (apiConfig) {
      if (apiConfig.krakenApiKey && apiConfig.krakenApiSecret && apiConfig.krakenConnected) {
        krakenService.initialize({
          apiKey: apiConfig.krakenApiKey,
          apiSecret: apiConfig.krakenApiSecret,
        });
        console.log("[startup] Kraken API credentials loaded from database");
      }
      if (apiConfig.telegramToken && apiConfig.telegramChatId && apiConfig.telegramConnected) {
        telegramService.initialize({
          token: apiConfig.telegramToken,
          chatId: apiConfig.telegramChatId,
        });
        console.log("[startup] Telegram credentials loaded from database");
      }
    }
    
    // Initialize trading engine
    tradingEngine = new TradingEngine(krakenService, telegramService);
    
    // Set engine controller for Telegram commands
    telegramService.setEngineController({
      start: async () => { await tradingEngine?.start(); },
      stop: async () => { await tradingEngine?.stop(); },
      isActive: () => tradingEngine?.isActive() ?? false,
      getBalance: async () => krakenService.isInitialized() ? await krakenService.getBalance() as Record<string, string> : {},
      getOpenPositions: () => tradingEngine?.getOpenPositions() ?? new Map(),
    });
    
    // Start heartbeat for Telegram notifications
    telegramService.startHeartbeat();
    
    // Auto-start if bot was active
    const botConfig = await storage.getBotConfig();
    if (botConfig?.isActive && krakenService.isInitialized()) {
      console.log("[startup] Starting trading engine...");
      tradingEngine.start();
    }
  } catch (error) {
    console.error("[startup] Error loading API credentials:", error);
  }

  app.get("/api/config", async (req, res) => {
    try {
      const config = await storage.getBotConfig();
      res.json(config);
    } catch (error) {
      res.status(500).json({ error: "Failed to get config" });
    }
  });

  app.post("/api/config", async (req, res) => {
    try {
      const body = { ...req.body };
      
      // Validar y clampar porcentajes a rango 0-100
      const pctFields = ["riskPerTradePct", "maxPairExposurePct", "maxTotalExposurePct"];
      for (const field of pctFields) {
        if (body[field] !== undefined) {
          const val = parseFloat(body[field]);
          if (isNaN(val)) {
            return res.status(400).json({ error: `${field} debe ser un n√∫mero v√°lido` });
          }
          if (val < 0 || val > 100) {
            return res.status(400).json({ error: `${field} debe estar entre 0 y 100 (valor recibido: ${val})` });
          }
          body[field] = val.toFixed(2);
        }
      }
      
      const updated = await storage.updateBotConfig(body);
      
      if (req.body.isActive !== undefined && tradingEngine) {
        if (req.body.isActive) {
          await tradingEngine.start();
        } else {
          await tradingEngine.stop();
        }
      }
      
      res.json(updated);
    } catch (error) {
      res.status(500).json({ error: "Failed to update config" });
    }
  });

  app.get("/api/config/api", async (req, res) => {
    try {
      const config = await storage.getApiConfig();
      res.json({
        krakenConnected: config?.krakenConnected || false,
        telegramConnected: config?.telegramConnected || false,
        hasKrakenKeys: !!(config?.krakenApiKey && config?.krakenApiSecret),
        hasTelegramKeys: !!(config?.telegramToken && config?.telegramChatId),
      });
    } catch (error) {
      res.status(500).json({ error: "Failed to get API config" });
    }
  });

  app.get("/api/trading/status", async (req, res) => {
    try {
      res.json({
        engineRunning: tradingEngine?.isActive() || false,
        krakenConnected: krakenService.isInitialized(),
        telegramConnected: telegramService.isInitialized(),
      });
    } catch (error) {
      res.status(500).json({ error: "Failed to get trading status" });
    }
  });

  // === DIAGN√ìSTICO DEL SCAN ===
  app.get("/api/scan/diagnostic", async (req, res) => {
    try {
      if (!tradingEngine) {
        return res.status(503).json({ error: "Motor de trading no inicializado" });
      }
      const diagnostic = await tradingEngine.getScanDiagnostic();
      res.json(diagnostic);
    } catch (error: any) {
      console.error("[scan/diagnostic] Error:", error.message);
      res.status(500).json({ error: "Error obteniendo diagn√≥stico del scan" });
    }
  });

  app.post("/api/config/kraken", async (req, res) => {
    try {
      const { apiKey, apiSecret } = req.body;
      
      if (!apiKey || !apiSecret) {
        return res.status(400).json({ error: "API key and secret required" });
      }

      krakenService.initialize({ apiKey, apiSecret });
      
      const balance = await krakenService.getBalance();
      
      await storage.updateApiConfig({
        krakenApiKey: apiKey,
        krakenApiSecret: apiSecret,
        krakenConnected: true,
      });
      
      res.json({ success: true, message: "Kraken connected successfully", balance });
    } catch (error) {
      await storage.updateApiConfig({ krakenConnected: false });
      res.status(500).json({ error: "Failed to connect to Kraken" });
    }
  });

  app.post("/api/config/telegram", async (req, res) => {
    try {
      const { token, chatId } = req.body;
      
      if (!token || !chatId) {
        return res.status(400).json({ error: "Token and chat ID required" });
      }

      telegramService.initialize({ token, chatId });
      
      const sent = await telegramService.sendMessage("‚úÖ Telegram conectado correctamente!");
      
      if (!sent) {
        return res.status(500).json({ error: "Failed to send test message" });
      }
      
      await storage.updateApiConfig({
        telegramToken: token,
        telegramChatId: chatId,
        telegramConnected: true,
      });
      
      res.json({ success: true, message: "Telegram connected successfully" });
    } catch (error) {
      await storage.updateApiConfig({ telegramConnected: false });
      res.status(500).json({ error: "Failed to connect to Telegram" });
    }
  });

  // === SMART_GUARD Per-Pair Overrides ===
  const SG_OVERRIDE_SCHEMA = z.object({
    sgMinEntryUsd: z.number().min(0).max(100000).optional(),
    sgAllowUnderMin: z.boolean().optional(),
    sgBeAtPct: z.number().min(0).max(100).optional(),
    sgFeeCushionPct: z.number().min(0).max(10).optional(),
    sgFeeCushionAuto: z.boolean().optional(),
    sgTrailStartPct: z.number().min(0).max(100).optional(),
    sgTrailDistancePct: z.number().min(0).max(50).optional(),
    sgTrailStepPct: z.number().min(0).max(10).optional(),
    sgTpFixedEnabled: z.boolean().optional(),
    sgTpFixedPct: z.number().min(0).max(500).optional(),
    sgScaleOutEnabled: z.boolean().optional(),
    sgScaleOutPct: z.number().min(0).max(100).optional(),
    sgMinPartUsd: z.number().min(0).max(10000).optional(),
    sgScaleOutThreshold: z.number().min(0).max(100).optional(),
  });

  const TRADEABLE_PAIRS = ["BTC/USD", "ETH/USD", "SOL/USD", "XRP/USD", "TON/USD"];

  app.get("/api/config/sg-overrides", async (req, res) => {
    try {
      const config = await storage.getBotConfig();
      const overrides = (config?.sgPairOverrides as Record<string, unknown>) || {};
      res.json({
        pairs: TRADEABLE_PAIRS,
        overrides,
        global: {
          sgMinEntryUsd: config?.sgMinEntryUsd,
          sgAllowUnderMin: config?.sgAllowUnderMin,
          sgBeAtPct: config?.sgBeAtPct,
          sgFeeCushionPct: config?.sgFeeCushionPct,
          sgFeeCushionAuto: config?.sgFeeCushionAuto,
          sgTrailStartPct: config?.sgTrailStartPct,
          sgTrailDistancePct: config?.sgTrailDistancePct,
          sgTrailStepPct: config?.sgTrailStepPct,
          sgTpFixedEnabled: config?.sgTpFixedEnabled,
          sgTpFixedPct: config?.sgTpFixedPct,
          sgScaleOutEnabled: config?.sgScaleOutEnabled,
          sgScaleOutPct: config?.sgScaleOutPct,
          sgMinPartUsd: config?.sgMinPartUsd,
          sgScaleOutThreshold: config?.sgScaleOutThreshold,
        },
      });
    } catch (error) {
      res.status(500).json({ error: "Failed to get SG overrides" });
    }
  });

  app.put("/api/config/sg-overrides/:pair", async (req, res) => {
    try {
      // Normalize pair: accept both BTC-USD and BTC/USD in URL
      const pairRaw = decodeURIComponent(req.params.pair).replace(/-/g, "/");
      if (!TRADEABLE_PAIRS.includes(pairRaw)) {
        return res.status(400).json({ error: `Par inv√°lido: ${pairRaw}` });
      }

      // Coerce string values to numbers where expected
      const body = { ...req.body };
      for (const key of Object.keys(body)) {
        if (typeof body[key] === "string" && !["sgAllowUnderMin", "sgFeeCushionAuto", "sgTpFixedEnabled", "sgScaleOutEnabled"].includes(key)) {
          const num = parseFloat(body[key]);
          if (!isNaN(num)) body[key] = num;
        }
      }

      const parsed = SG_OVERRIDE_SCHEMA.safeParse(body);
      if (!parsed.success) {
        return res.status(400).json({ error: "Datos inv√°lidos", details: parsed.error.flatten() });
      }

      const config = await storage.getBotConfig();
      const currentOverrides = (config?.sgPairOverrides as Record<string, unknown>) || {};
      const existingPair = (currentOverrides[pairRaw] as Record<string, unknown>) || {};
      
      // Merge with existing override for this pair
      const newPairOverride = { ...existingPair, ...parsed.data };
      const newOverrides = { ...currentOverrides, [pairRaw]: newPairOverride };

      await storage.updateBotConfig({ sgPairOverrides: newOverrides });

      // Log the change
      const envInfo = environment.getInfo();
      await botLogger.info("CONFIG_OVERRIDE_UPDATED", `Override actualizado para ${pairRaw}`, {
        pair: pairRaw,
        changedKeys: Object.keys(parsed.data),
        env: envInfo.env,
        instanceId: envInfo.instanceId,
      });

      res.json({ success: true, pair: pairRaw, override: newPairOverride });
    } catch (error) {
      res.status(500).json({ error: "Failed to update SG override" });
    }
  });

  app.delete("/api/config/sg-overrides/:pair", async (req, res) => {
    try {
      // Normalize pair: accept both BTC-USD and BTC/USD in URL
      const pairRaw = decodeURIComponent(req.params.pair).replace(/-/g, "/");
      if (!TRADEABLE_PAIRS.includes(pairRaw)) {
        return res.status(400).json({ error: `Par inv√°lido: ${pairRaw}` });
      }

      const config = await storage.getBotConfig();
      const currentOverrides = (config?.sgPairOverrides as Record<string, unknown>) || {};
      
      if (!(pairRaw in currentOverrides)) {
        return res.status(404).json({ error: `No hay override para ${pairRaw}` });
      }

      const { [pairRaw]: removed, ...newOverrides } = currentOverrides;
      await storage.updateBotConfig({ sgPairOverrides: newOverrides });

      // Log the change
      const envInfo = environment.getInfo();
      await botLogger.info("CONFIG_OVERRIDE_UPDATED", `Override eliminado para ${pairRaw}`, {
        pair: pairRaw,
        changedKeys: ["DELETED"],
        env: envInfo.env,
        instanceId: envInfo.instanceId,
      });

      res.json({ success: true, pair: pairRaw, message: "Override eliminado" });
    } catch (error) {
      res.status(500).json({ error: "Failed to delete SG override" });
    }
  });

  app.post("/api/telegram/send", async (req, res) => {
    try {
      const { message } = req.body;
      
      if (!message) {
        return res.status(400).json({ error: "Mensaje requerido" });
      }

      if (!telegramService.isInitialized()) {
        return res.status(400).json({ error: "Telegram no est√° configurado" });
      }

      const sent = await telegramService.sendMessage(message);
      
      if (!sent) {
        return res.status(500).json({ error: "Error enviando mensaje" });
      }
      
      res.json({ success: true, message: "Mensaje enviado" });
    } catch (error) {
      res.status(500).json({ error: "Error enviando mensaje a Telegram" });
    }
  });

  app.get("/api/telegram/chats", async (req, res) => {
    try {
      const chats = await storage.getTelegramChats();
      res.json(chats);
    } catch (error) {
      res.status(500).json({ error: "Error obteniendo chats" });
    }
  });

  app.post("/api/telegram/chats", async (req, res) => {
    try {
      const { name, chatId, alertTrades, alertErrors, alertSystem, alertBalance } = req.body;
      
      if (!name || !chatId) {
        return res.status(400).json({ error: "Nombre y Chat ID son requeridos" });
      }

      if (!telegramService.isInitialized()) {
        return res.status(400).json({ error: "Telegram no est√° configurado. Configura primero el token principal." });
      }

      const existingChats = await storage.getTelegramChats();
      const duplicate = existingChats.find(c => c.chatId === chatId);
      if (duplicate) {
        return res.status(400).json({ error: "Este Chat ID ya est√° configurado." });
      }

      const testSent = await telegramService.sendToChat(chatId, "‚úÖ Chat configurado correctamente en KrakenBot!");
      if (!testSent) {
        return res.status(400).json({ error: "No se pudo enviar mensaje al chat. Verifica el Chat ID." });
      }

      const chat = await storage.createTelegramChat({
        name,
        chatId,
        alertTrades: alertTrades ?? true,
        alertErrors: alertErrors ?? true,
        alertSystem: alertSystem ?? true,
        alertBalance: alertBalance ?? false,
        isActive: true,
      });
      
      res.json(chat);
    } catch (error) {
      res.status(500).json({ error: "Error creando chat" });
    }
  });

  app.put("/api/telegram/chats/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const { name, chatId, alertTrades, alertErrors, alertSystem, alertBalance, isActive } = req.body;
      
      const chat = await storage.updateTelegramChat(id, {
        name,
        chatId,
        alertTrades,
        alertErrors,
        alertSystem,
        alertBalance,
        isActive,
      });
      
      res.json(chat);
    } catch (error) {
      res.status(500).json({ error: "Error actualizando chat" });
    }
  });

  app.delete("/api/telegram/chats/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      await storage.deleteTelegramChat(id);
      res.json({ success: true });
    } catch (error) {
      res.status(500).json({ error: "Error eliminando chat" });
    }
  });

  app.get("/api/dashboard", async (req, res) => {
    try {
      const apiConfig = await storage.getApiConfig();
      const botConfig = await storage.getBotConfig();
      const trades = await storage.getTrades(10);
      
      let balances: Record<string, string> = {};
      let prices: Record<string, { price: string; change: string }> = {};
      
      if (krakenService.isInitialized()) {
        try {
          balances = await krakenService.getBalance() as Record<string, string>;
          
          const pairs = ["XXBTZUSD", "XETHZUSD", "SOLUSD", "XXRPZUSD", "TONUSD"];
          for (const pair of pairs) {
            try {
              const ticker = await krakenService.getTicker(pair);
              const tickerData: any = Object.values(ticker)[0];
              if (tickerData) {
                const currentPrice = parseFloat(tickerData.c?.[0] || "0");
                const openPrice = parseFloat(tickerData.o || "0");
                const change = openPrice > 0 ? ((currentPrice - openPrice) / openPrice * 100).toFixed(2) : "0";
                prices[pair] = { price: tickerData.c?.[0] || "0", change };
              }
            } catch (e) {}
          }
        } catch (e) {}
      }
      
      res.json({
        krakenConnected: apiConfig?.krakenConnected || false,
        telegramConnected: apiConfig?.telegramConnected || false,
        botActive: botConfig?.isActive || false,
        strategy: botConfig?.strategy || "momentum",
        activePairs: botConfig?.activePairs || ["BTC/USD", "ETH/USD", "SOL/USD"],
        balances,
        prices,
        recentTrades: trades,
      });
    } catch (error) {
      res.status(500).json({ error: "Failed to get dashboard data" });
    }
  });

  app.get("/api/trades", async (req, res) => {
    try {
      const limit = parseInt(req.query.limit as string) || 50;
      const trades = await storage.getTrades(limit);
      res.json(trades);
    } catch (error) {
      res.status(500).json({ error: "Failed to get trades" });
    }
  });

  app.get("/api/open-positions", async (req, res) => {
    try {
      const positions = await storage.getOpenPositions();
      
      const positionsWithPnl = await Promise.all(positions.map(async (pos) => {
        let currentPrice = 0;
        let unrealizedPnlUsd = 0;
        let unrealizedPnlPct = 0;
        
        if (krakenService.isInitialized()) {
          try {
            const krakenPair = krakenService.formatPair(pos.pair);
            const ticker = await krakenService.getTicker(krakenPair);
            const tickerData: any = Object.values(ticker)[0];
            if (tickerData?.c?.[0]) {
              currentPrice = parseFloat(tickerData.c[0]);
              const entryPrice = parseFloat(pos.entryPrice);
              const amount = parseFloat(pos.amount);
              unrealizedPnlUsd = (currentPrice - entryPrice) * amount;
              unrealizedPnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;
            }
          } catch (e) {}
        }
        
        const amount = parseFloat(pos.amount);
        const entryPrice = parseFloat(pos.entryPrice);
        const entryValueUsd = entryPrice * amount;
        const currentValueUsd = currentPrice * amount;
        
        return {
          ...pos,
          currentPrice: currentPrice.toString(),
          unrealizedPnlUsd: unrealizedPnlUsd.toFixed(2),
          unrealizedPnlPct: unrealizedPnlPct.toFixed(2),
          entryValueUsd: entryValueUsd.toFixed(2),
          currentValueUsd: currentValueUsd.toFixed(2),
        };
      }));
      
      res.json(positionsWithPnl);
    } catch (error) {
      console.error("[api/open-positions] Error:", error);
      res.status(500).json({ error: "Failed to get open positions" });
    }
  });

  // === CIERRE MANUAL DE POSICI√ìN ===
  app.post("/api/positions/:pair/close", async (req, res) => {
    try {
      const pair = req.params.pair.replace("-", "/"); // Convert BTC-USD back to BTC/USD
      const { reason, lotId } = req.body; // Optional lotId for multi-lot support
      
      const correlationId = `MANUAL-CLOSE-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;
      
      // Verificar que la posici√≥n existe
      const positions = await storage.getOpenPositions();
      let position;
      if (lotId) {
        // Specific lot requested
        position = positions.find(p => p.lotId === lotId);
      } else {
        // Close first position for the pair
        position = positions.find(p => p.pair === pair);
      }
      
      if (!position) {
        await botLogger.warn("MANUAL_CLOSE_FAILED", `Intento de cierre manual fallido - posici√≥n no encontrada`, {
          pair,
          lotId: lotId || "not_specified",
          correlationId,
          reason: reason || "Usuario solicit√≥ cierre manual",
        });
        
        return res.status(404).json({
          success: false,
          error: "POSITION_NOT_FOUND",
          message: `No se encontr√≥ posici√≥n abierta para ${pair}`,
        });
      }
      
      // Obtener precio actual (con fallback para DRY_RUN)
      let currentPrice: number;
      const botConfig = await storage.getBotConfig();
      const isDryRun = botConfig?.dryRunMode || environment.isReplit;
      
      if (krakenService.isInitialized()) {
        try {
          const krakenPair = krakenService.formatPair(pair);
          const ticker = await krakenService.getTicker(krakenPair);
          const tickerData: any = Object.values(ticker)[0];
          
          if (tickerData?.c?.[0]) {
            currentPrice = parseFloat(tickerData.c[0]);
          } else {
            throw new Error("No ticker data");
          }
        } catch (e) {
          if (!isDryRun) {
            return res.status(500).json({
              success: false,
              error: "PRICE_UNAVAILABLE",
              message: "No se pudo obtener el precio actual",
            });
          }
          // En DRY_RUN, usar precio de entrada como fallback
          currentPrice = parseFloat(position.entryPrice);
        }
      } else {
        if (!isDryRun) {
          return res.status(503).json({
            success: false,
            error: "KRAKEN_NOT_INITIALIZED",
            message: "Kraken API no est√° conectada",
          });
        }
        // En DRY_RUN, usar precio de entrada como fallback (simulaci√≥n)
        currentPrice = parseFloat(position.entryPrice);
      }
      const amount = parseFloat(position.amount);
      const entryPrice = parseFloat(position.entryPrice);
      const pnlUsd = (currentPrice - entryPrice) * amount;
      const pnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;
      
      const positionLotId = position.lotId;
      
      // Log el intento de cierre manual
      await botLogger.info("MANUAL_CLOSE_INITIATED", `Cierre manual iniciado por usuario`, {
        correlationId,
        pair,
        lotId: positionLotId,
        amount,
        entryPrice,
        currentPrice,
        estimatedPnlUsd: pnlUsd.toFixed(2),
        estimatedPnlPct: pnlPct.toFixed(2),
        reason: reason || "Usuario solicit√≥ cierre manual",
      });
      
      // Ejecutar la venta a trav√©s del trading engine
      if (!tradingEngine) {
        return res.status(503).json({
          success: false,
          error: "ENGINE_NOT_RUNNING",
          message: "Motor de trading no est√° activo",
        });
      }
      
      const closeResult = await tradingEngine.forceClosePosition(pair, currentPrice, correlationId, reason || "Cierre manual por usuario", positionLotId);
      
      if (closeResult.success) {
        await botLogger.info("MANUAL_CLOSE_SUCCESS", `Posici√≥n cerrada manualmente`, {
          correlationId,
          pair,
          lotId: closeResult.lotId || positionLotId,
          amount,
          exitPrice: currentPrice,
          realizedPnlUsd: closeResult.pnlUsd?.toFixed(2),
          realizedPnlPct: closeResult.pnlPct?.toFixed(2),
          krakenOrderId: closeResult.orderId,
          dryRun: closeResult.dryRun,
        });
        
        res.json({
          success: true,
          correlationId,
          pair,
          lotId: closeResult.lotId || positionLotId,
          amount,
          exitPrice: currentPrice,
          realizedPnlUsd: closeResult.pnlUsd?.toFixed(2),
          realizedPnlPct: closeResult.pnlPct?.toFixed(2),
          orderId: closeResult.orderId,
          message: closeResult.dryRun 
            ? `[DRY_RUN] Cierre simulado de ${pair}`
            : `Posici√≥n ${pair} cerrada exitosamente`,
        });
      } else {
        // Caso DUST: devolver 200 con flag isDust para que UI ofrezca "Eliminar hu√©rfana"
        if (closeResult.isDust) {
          await botLogger.warn("MANUAL_CLOSE_DUST", `Posici√≥n DUST detectada - no se puede cerrar`, {
            correlationId,
            pair,
            lotId: positionLotId,
            error: closeResult.error,
          });
          
          return res.json({
            success: false,
            correlationId,
            error: "DUST_POSITION",
            isDust: true,
            lotId: positionLotId,
            message: closeResult.error || "Balance real menor al m√≠nimo de Kraken",
          });
        }
        
        await botLogger.error("MANUAL_CLOSE_FAILED", `Error al cerrar posici√≥n manualmente`, {
          correlationId,
          pair,
          lotId: positionLotId,
          error: closeResult.error,
        });
        
        res.status(500).json({
          success: false,
          correlationId,
          error: "CLOSE_FAILED",
          message: closeResult.error || "Error al cerrar la posici√≥n",
        });
      }
      
    } catch (error: any) {
      const pair = req.params.pair?.replace("-", "/") || "UNKNOWN";
      const { lotId } = req.body || {};
      const botConfigErr = await storage.getBotConfig();
      const isDryRunErr = botConfigErr?.dryRunMode || environment.isReplit;
      
      console.error("[api/positions/close] FULL ERROR:", {
        message: error.message,
        stack: error.stack,
        pair,
        lotId: lotId || "not_specified",
        isDryRun: isDryRunErr,
        timestamp: new Date().toISOString(),
      });
      
      await botLogger.error("MANUAL_CLOSE_EXCEPTION", `Excepci√≥n no controlada en cierre manual`, {
        pair,
        lotId: lotId || "not_specified",
        isDryRun: isDryRunErr,
        errorMessage: error.message,
        errorStack: error.stack,
      });
      
      res.status(500).json({
        success: false,
        error: "INTERNAL_ERROR",
        message: `Error al procesar cierre: ${error.message}`,
        stack: process.env.NODE_ENV === "development" ? error.stack : undefined,
      });
    }
  });

  // === ELIMINAR POSICI√ìN HU√âRFANA (DUST) ===
  // Solo elimina el registro interno de DB/memoria, NO env√≠a orden a Kraken
  app.delete("/api/positions/:lotId/orphan", async (req, res) => {
    try {
      const lotId = req.params.lotId;
      const { reason } = req.body || {};
      
      // Verificar que la posici√≥n existe en DB
      const dbPosition = await storage.getOpenPositionByLotId(lotId);
      if (!dbPosition) {
        return res.status(404).json({
          success: false,
          error: "POSITION_NOT_FOUND",
          message: `No se encontr√≥ posici√≥n con lotId: ${lotId}`,
        });
      }
      
      const pair = dbPosition.pair;
      
      // Eliminar de DB
      await storage.deleteOpenPositionByLotId(lotId);
      
      // Eliminar de memoria del trading engine
      if (tradingEngine) {
        const positions = tradingEngine.getOpenPositions();
        positions.delete(lotId);
      }
      
      await botLogger.info("ORPHAN_POSITION_DELETED", `Posici√≥n hu√©rfana eliminada manualmente`, {
        pair,
        lotId,
        amount: dbPosition.amount,
        entryPrice: dbPosition.entryPrice,
        reason: reason || "orphan_dust_cleanup",
        env: environment.isReplit ? "REPLIT" : "NAS",
      });
      
      // Notificar por Telegram
      if (telegramService?.isInitialized()) {
        await telegramService.sendMessage(`
üóëÔ∏è *Posici√≥n Hu√©rfana Eliminada*

*Par:* ${pair}
*Lot:* \`${lotId.substring(0, 8)}...\`
*Cantidad:* ${dbPosition.amount}

_Eliminada manualmente desde dashboard (sin orden a Kraken)_
        `.trim());
      }
      
      res.json({
        success: true,
        lotId,
        pair,
        deleted: true,
        message: `Posici√≥n hu√©rfana eliminada de BD`,
      });
      
    } catch (error: any) {
      console.error("[api/positions/orphan] Error:", error.message);
      res.status(500).json({
        success: false,
        error: "INTERNAL_ERROR",
        message: error.message,
      });
    }
  });

  // === RECONCILIAR POSICIONES CON KRAKEN ===
  // Compara balances reales con posiciones en BD y elimina hu√©rfanas
  app.post("/api/positions/reconcile", async (req, res) => {
    try {
      if (!krakenService) {
        return res.status(503).json({ 
          success: false, 
          error: "Kraken service not initialized" 
        });
      }

      // Obtener todas las posiciones abiertas de BD
      const openPositions = await storage.getOpenPositions();
      if (openPositions.length === 0) {
        return res.json({
          success: true,
          message: "No hay posiciones abiertas en BD",
          reconciled: 0,
          orphans: [],
        });
      }

      // Obtener balances reales de Kraken
      const balances = await krakenService.getBalance() as Record<string, string>;
      
      // M√≠nimos de orden por par (hardcoded ya que getAssetPairs es para todos los pares)
      const orderMinMap: Record<string, number> = {
        "BTC/USD": 0.0001,
        "ETH/USD": 0.004,
        "SOL/USD": 0.2,
        "XRP/USD": 10,
        "TON/USD": 10,
      };
      
      // Obtener m√≠nimos de orden por par
      const orphanPositions: Array<{ lotId: string; pair: string; amount: string; reason: string }> = [];
      const validPositions: Array<{ lotId: string; pair: string; amount: string }> = [];
      
      for (const pos of openPositions) {
        const assetMap: Record<string, string> = {
          "BTC/USD": "XXBT",
          "ETH/USD": "XETH",
          "SOL/USD": "SOL",
          "XRP/USD": "XXRP",
          "TON/USD": "TON",
        };
        const assetKey = assetMap[pos.pair];
        if (!assetKey) {
          // Par desconocido, marcar como hu√©rfana
          orphanPositions.push({
            lotId: pos.lotId,
            pair: pos.pair,
            amount: pos.amount,
            reason: "Par no reconocido",
          });
          continue;
        }

        const realBalance = parseFloat(balances[assetKey] || "0");
        const positionAmount = parseFloat(pos.amount);
        
        // Obtener m√≠nimo de orden para este par
        const orderMin = orderMinMap[pos.pair] || 0.0001;
        
        // Si el balance real es menor al m√≠nimo de orden, es hu√©rfana
        if (realBalance < orderMin) {
          orphanPositions.push({
            lotId: pos.lotId,
            pair: pos.pair,
            amount: pos.amount,
            reason: `Balance real (${realBalance.toFixed(8)}) < m√≠nimo (${orderMin})`,
          });
        } else {
          validPositions.push({
            lotId: pos.lotId,
            pair: pos.pair,
            amount: pos.amount,
          });
        }
      }

      // Auto-limpiar hu√©rfanas si se solicita
      const autoClean = req.body?.autoClean === true;
      let cleaned = 0;
      
      if (autoClean && orphanPositions.length > 0) {
        for (const orphan of orphanPositions) {
          try {
            await storage.deleteOpenPositionByLotId(orphan.lotId);
            if (tradingEngine) {
              tradingEngine.getOpenPositions().delete(orphan.lotId);
            }
            cleaned++;
          } catch (err) {
            console.error(`Error limpiando hu√©rfana ${orphan.lotId}:`, err);
          }
        }
        
        await botLogger.info("ORPHAN_POSITION_DELETED", `Reconciliaci√≥n completada`, {
          total: openPositions.length,
          orphans: orphanPositions.length,
          cleaned,
          valid: validPositions.length,
        });
        
        if (telegramService?.isInitialized()) {
          await telegramService.sendMessage(`
üîÑ *Reconciliaci√≥n Completada*

*Total posiciones:* ${openPositions.length}
*Hu√©rfanas eliminadas:* ${cleaned}
*V√°lidas:* ${validPositions.length}
          `.trim());
        }
      }

      res.json({
        success: true,
        total: openPositions.length,
        orphans: orphanPositions,
        valid: validPositions,
        cleaned,
        message: autoClean 
          ? `Reconciliaci√≥n completada: ${cleaned} hu√©rfanas eliminadas`
          : `Encontradas ${orphanPositions.length} posiciones hu√©rfanas`,
      });
      
    } catch (error: any) {
      console.error("[api/positions/reconcile] Error:", error.message);
      res.status(500).json({
        success: false,
        error: "INTERNAL_ERROR",
        message: error.message,
      });
    }
  });

  app.get("/api/trades/closed", async (req, res) => {
    try {
      const limit = parseInt(req.query.limit as string) || 10;
      const offset = parseInt(req.query.offset as string) || 0;
      const pair = req.query.pair as string | undefined;
      const result = (req.query.result as 'winner' | 'loser' | 'all') || 'all';
      const type = (req.query.type as 'all' | 'buy' | 'sell') || 'all';
      
      const { trades, total } = await storage.getClosedTrades({ limit, offset, pair, result, type });
      
      res.json({
        trades: trades.map(t => {
          const price = parseFloat(t.price);
          const amount = parseFloat(t.amount);
          const totalUsd = price * amount;
          const entryValueUsd = t.entryPrice ? parseFloat(t.entryPrice) * amount : null;
          
          return {
            ...t,
            totalUsd: totalUsd.toFixed(2),
            entryValueUsd: entryValueUsd?.toFixed(2) || null,
            realizedPnlUsd: t.realizedPnlUsd ? parseFloat(t.realizedPnlUsd).toFixed(2) : null,
            realizedPnlPct: t.realizedPnlPct ? parseFloat(t.realizedPnlPct).toFixed(2) : null,
          };
        }),
        total,
        limit,
        offset,
      });
    } catch (error) {
      console.error("[api/trades/closed] Error:", error);
      res.status(500).json({ error: "Failed to get closed trades" });
    }
  });

  app.get("/api/performance", async (req, res) => {
    try {
      const trades = await storage.getTrades(500);
      
      const STARTING_EQUITY = 1000;
      
      const sortedTrades = [...trades].sort((a, b) => {
        const dateA = a.executedAt ? new Date(a.executedAt).getTime() : new Date(a.createdAt).getTime();
        const dateB = b.executedAt ? new Date(b.executedAt).getTime() : new Date(b.createdAt).getTime();
        return dateA - dateB;
      });

      const pairPrices: Record<string, { lastBuyPrice: number; lastBuyAmount: number }> = {};
      let currentEquity = STARTING_EQUITY;
      let totalPnl = 0;
      let wins = 0;
      let losses = 0;
      let maxEquity = STARTING_EQUITY;
      let maxDrawdown = 0;

      const firstTradeTime = sortedTrades.length > 0 
        ? new Date(sortedTrades[0].executedAt || sortedTrades[0].createdAt).toISOString()
        : new Date().toISOString();
      
      const curve: { time: string; equity: number; pnl?: number }[] = [
        { time: firstTradeTime, equity: STARTING_EQUITY }
      ];

      for (const trade of sortedTrades) {
        const pair = trade.pair;
        const price = parseFloat(trade.price);
        const amount = parseFloat(trade.amount);
        const time = trade.executedAt ? new Date(trade.executedAt).toISOString() : new Date(trade.createdAt).toISOString();

        if (trade.type === "buy") {
          pairPrices[pair] = { lastBuyPrice: price, lastBuyAmount: amount };
        } else if (trade.type === "sell") {
          const lastBuy = pairPrices[pair];
          if (lastBuy && lastBuy.lastBuyPrice > 0) {
            const pnl = (price - lastBuy.lastBuyPrice) * Math.min(amount, lastBuy.lastBuyAmount);
            totalPnl += pnl;
            currentEquity += pnl;

            if (pnl > 0) wins++;
            else if (pnl < 0) losses++;

            curve.push({ time, equity: currentEquity, pnl });

            if (currentEquity > maxEquity) maxEquity = currentEquity;
            const drawdown = ((maxEquity - currentEquity) / maxEquity) * 100;
            if (drawdown > maxDrawdown) maxDrawdown = drawdown;

            delete pairPrices[pair];
          }
        }
      }

      const totalTrades = wins + losses;
      const winRatePct = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
      const totalPnlPct = (totalPnl / STARTING_EQUITY) * 100;

      res.json({
        curve,
        summary: {
          startingEquity: STARTING_EQUITY,
          endingEquity: currentEquity,
          totalPnlUsd: totalPnl,
          totalPnlPct,
          maxDrawdownPct: maxDrawdown,
          winRatePct,
          totalTrades,
          wins,
          losses
        }
      });
    } catch (error) {
      console.error("Error calculating performance:", error);
      res.status(500).json({ error: "Failed to calculate performance" });
    }
  });

  app.get("/api/market/:pair", async (req, res) => {
    try {
      const { pair } = req.params;
      const ticker = await krakenService.getTicker(pair);
      
      const tickerData: any = Object.values(ticker)[0] || {};
      const data = await storage.saveMarketData({
        pair,
        price: tickerData.c?.[0] || "0",
        volume24h: tickerData.v?.[1] || "0",
        change24h: "0",
      });
      
      res.json(data);
    } catch (error) {
      res.status(500).json({ error: "Failed to get market data" });
    }
  });

  app.get("/api/balance", async (req, res) => {
    try {
      if (!krakenService.isInitialized()) {
        return res.status(400).json({ error: "Kraken not configured" });
      }
      
      const balance = await krakenService.getBalance();
      res.json(balance);
    } catch (error) {
      res.status(500).json({ error: "Failed to get balance" });
    }
  });

  app.post("/api/trade", async (req, res) => {
    try {
      if (!krakenService.isInitialized()) {
        return res.status(400).json({ error: "Kraken not configured" });
      }

      const { pair, type, ordertype, volume, price } = req.body;
      
      const tradeId = `T-${Date.now()}`;
      
      const trade = await storage.createTrade({
        tradeId,
        pair,
        type,
        price: price || "0",
        amount: volume,
        status: "pending",
      });

      const order = await krakenService.placeOrder({
        pair,
        type,
        ordertype,
        volume,
        price,
      });

      await storage.updateTradeStatus(tradeId, "filled", (order as any).txid?.[0]);
      
      await telegramService.sendTradeNotification({
        type,
        pair,
        price: price || "market",
        amount: volume,
        status: "filled",
      });

      res.json({ success: true, trade, order });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to place trade" });
    }
  });

  app.get("/api/notifications", async (req, res) => {
    try {
      const notifications = await storage.getUnsentNotifications();
      res.json(notifications);
    } catch (error) {
      res.status(500).json({ error: "Failed to get notifications" });
    }
  });

  app.post("/api/trades/sync", async (req, res) => {
    try {
      if (!krakenService.isInitialized()) {
        return res.status(400).json({ error: "Kraken not configured" });
      }

      // Obtener todo el historial de trades con paginaci√≥n
      const tradesHistory = await krakenService.getTradesHistory({ fetchAll: true });
      const krakenTrades = tradesHistory.trades || {};
      
      let synced = 0;
      let skipped = 0;
      const errors: string[] = [];
      
      // Agrupar trades por par para c√°lculo de P&L
      const tradesByPair: Record<string, { buys: any[]; sells: any[] }> = {};
      
      for (const [txid, trade] of Object.entries(krakenTrades)) {
        const t = trade as any;
        const pair = krakenService.formatPairReverse(t.pair);
        
        if (!tradesByPair[pair]) {
          tradesByPair[pair] = { buys: [], sells: [] };
        }
        
        const tradeData = {
          txid,
          pair,
          type: t.type,
          price: parseFloat(t.price),
          amount: parseFloat(t.vol),
          cost: parseFloat(t.cost),
          fee: parseFloat(t.fee),
          time: new Date(t.time * 1000),
        };
        
        if (t.type === 'buy') {
          tradesByPair[pair].buys.push(tradeData);
        } else {
          tradesByPair[pair].sells.push(tradeData);
        }
        
        try {
          // === FIX DUPLICADOS v2: Triple verificaci√≥n ===
          const ordertxid = t.ordertxid;
          const executedAt = new Date(t.time * 1000);
          
          // 1. Verificar por ORDER ID (lo que guard√≥ el bot)
          if (ordertxid) {
            const existingByOrderId = await storage.getTradeByKrakenOrderId(ordertxid);
            if (existingByOrderId) {
              skipped++;
              continue;
            }
          }
          
          // 2. Verificar por FILL ID (sync previo)
          const existingByFillId = await storage.getTradeByKrakenOrderId(txid);
          if (existingByFillId) {
            skipped++;
            continue;
          }
          
          // 3. Verificar por caracter√≠sticas (pair + amount + type + timestamp < 60s)
          const existingByTraits = await storage.findDuplicateTrade(pair, t.vol, t.type, executedAt);
          if (existingByTraits) {
            skipped++;
            continue;
          }
          
          // No existe duplicado, insertar
          const result = await storage.upsertTradeByKrakenId({
            tradeId: `KRAKEN-${txid}`,
            pair,
            type: t.type,
            price: t.price,
            amount: t.vol,
            status: "filled",
            krakenOrderId: txid,
            executedAt,
          });
          
          if (result.inserted) {
            synced++;
          } else {
            skipped++;
          }
        } catch (e: any) {
          errors.push(`${txid}: ${e.message}`);
        }
      }
      
      // Calcular P&L para SELLs emparej√°ndolos con BUYs (FIFO)
      let pnlCalculated = 0;
      for (const [pair, trades] of Object.entries(tradesByPair)) {
        // Ordenar por tiempo
        trades.buys.sort((a, b) => a.time.getTime() - b.time.getTime());
        trades.sells.sort((a, b) => a.time.getTime() - b.time.getTime());
        
        let buyIndex = 0;
        let buyRemaining = trades.buys[0]?.amount || 0;
        
        for (const sell of trades.sells) {
          let sellRemaining = sell.amount;
          let totalCost = 0;
          let totalAmount = 0;
          let totalBuyFees = 0; // Accumulated buy-side fees for matched portion
          
          // Emparejar con BUYs (FIFO)
          while (sellRemaining > 0 && buyIndex < trades.buys.length) {
            const buy = trades.buys[buyIndex];
            const matchAmount = Math.min(buyRemaining, sellRemaining);
            
            // Pro-rate buy fee based on matched portion
            const buyFeeForMatch = (matchAmount / buy.amount) * buy.fee;
            
            totalCost += matchAmount * buy.price;
            totalAmount += matchAmount;
            totalBuyFees += buyFeeForMatch;
            
            sellRemaining -= matchAmount;
            buyRemaining -= matchAmount;
            
            if (buyRemaining <= 0.00000001) {
              buyIndex++;
              buyRemaining = trades.buys[buyIndex]?.amount || 0;
            }
          }
          
          // Only calculate P&L for matched portion
          if (totalAmount > 0) {
            const avgEntryPrice = totalCost / totalAmount;
            // Use totalAmount (matched) not sell.amount for revenue calculation
            const revenue = totalAmount * sell.price;
            const cost = totalCost;
            // Include both buy and sell fees in net P&L
            const totalFees = totalBuyFees + sell.fee;
            const pnlGross = revenue - cost;
            const pnlNet = pnlGross - totalFees;
            const pnlPct = cost > 0 ? (pnlGross / cost) * 100 : 0;
            
            // Actualizar el trade SELL con P&L
            const existingSell = await storage.getTradeByKrakenOrderId(sell.txid);
            if (existingSell && (!existingSell.realizedPnlUsd || existingSell.realizedPnlUsd === null)) {
              await storage.updateTradePnl(
                existingSell.id,
                avgEntryPrice.toFixed(8),
                pnlNet.toFixed(8),  // Use net P&L (after all fees)
                pnlPct.toFixed(4)
              );
              pnlCalculated++;
            }
          }
        }
      }

      // Nota: El cierre autom√°tico de posiciones abiertas requiere tracking de volumen
      // acumulado (parciales) y se manejar√° via endpoints separados o manualmente.
      // El sync solo registra trades y calcula P&L.

      res.json({ 
        success: true, 
        synced, 
        skipped,
        pnlCalculated,
        total: Object.keys(krakenTrades).length,
        errors: errors.length > 0 ? errors.slice(0, 10) : undefined,
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to sync trades" });
    }
  });

  // Endpoint para limpiar duplicados existentes
  app.post("/api/trades/cleanup-duplicates", async (req, res) => {
    try {
      const duplicates = await storage.getDuplicateTradesByKrakenId();
      
      if (duplicates.length === 0) {
        return res.json({ success: true, message: "No hay duplicados", deleted: 0 });
      }
      
      const deleted = await storage.deleteDuplicateTrades();
      
      res.json({ 
        success: true, 
        duplicatesFound: duplicates.length,
        deleted,
        details: duplicates.slice(0, 20),
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to cleanup duplicates" });
    }
  });

  // Endpoint para ver duplicados sin eliminar
  app.get("/api/trades/duplicates", async (req, res) => {
    try {
      const duplicates = await storage.getDuplicateTradesByKrakenId();
      res.json({ 
        count: duplicates.length,
        duplicates: duplicates.slice(0, 50),
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to get duplicates" });
    }
  });

  // FIFO Matcher endpoints
  app.post("/api/fifo/init-lots", async (req, res) => {
    try {
      const { fifoMatcher } = await import("./services/fifoMatcher");
      const initialized = await fifoMatcher.initializeLots();
      res.json({ success: true, lotsInitialized: initialized });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to initialize lots" });
    }
  });

  app.post("/api/fifo/process-sells", async (req, res) => {
    try {
      const { fifoMatcher } = await import("./services/fifoMatcher");
      const result = await fifoMatcher.processAllUnmatchedSells();
      res.json({ success: true, ...result });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to process sells" });
    }
  });

  app.post("/api/fifo/ingest-fill", async (req, res) => {
    try {
      const { txid, orderId, pair, type, price, amount, cost, fee, executedAt } = req.body;
      
      if (!txid || !pair || !type || !price || !amount) {
        return res.status(400).json({ error: "Missing required fields: txid, pair, type, price, amount" });
      }

      const fillResult = await storage.upsertTradeFill({
        txid,
        orderId: orderId || txid,
        pair,
        type: type.toLowerCase(),
        price: price.toString(),
        amount: amount.toString(),
        cost: (cost || parseFloat(price) * parseFloat(amount)).toString(),
        fee: (fee || 0).toString(),
        matched: false,
        executedAt: new Date(executedAt || Date.now()),
      });

      if (!fillResult.inserted) {
        return res.json({ success: true, message: "Fill already exists", fill: fillResult.fill });
      }

      if (type.toUpperCase() === "SELL") {
        const { fifoMatcher } = await import("./services/fifoMatcher");
        const matchResult = await fifoMatcher.processSellFill(fillResult.fill!);
        return res.json({ success: true, fill: fillResult.fill, matchResult });
      }

      res.json({ success: true, fill: fillResult.fill });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to ingest fill" });
    }
  });

  app.get("/api/fifo/open-lots", async (req, res) => {
    try {
      const lots = await storage.getOpenPositionsWithQtyRemaining();
      res.json({
        count: lots.length,
        lots: lots.map(l => ({
          lotId: l.lotId,
          pair: l.pair,
          entryPrice: l.entryPrice,
          amount: l.amount,
          qtyRemaining: l.qtyRemaining || l.amount,
          qtyFilled: l.qtyFilled || "0",
          openedAt: l.openedAt,
        })),
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to get open lots" });
    }
  });

  app.get("/api/kraken/trades", async (req, res) => {
    try {
      if (!krakenService.isInitialized()) {
        const localTrades = await storage.getTrades(50);
        return res.json(localTrades.map(t => ({
          id: t.tradeId,
          krakenOrderId: t.krakenOrderId,
          pair: t.pair,
          type: t.type,
          price: t.price,
          amount: t.amount,
          time: t.executedAt?.toISOString() || t.createdAt.toISOString(),
          status: t.status,
        })));
      }

      const tradesHistory = await krakenService.getTradesHistory();
      const trades = tradesHistory.trades || {};
      
      const formattedTrades = Object.entries(trades).map(([txid, trade]) => {
        const t = trade as any;
        return {
          id: txid.substring(0, 10),
          krakenOrderId: txid,
          pair: krakenService.formatPairReverse(t.pair),
          type: t.type,
          price: t.price,
          amount: t.vol,
          cost: t.cost,
          fee: t.fee,
          time: new Date(t.time * 1000).toISOString(),
          status: "filled",
        };
      }).sort((a, b) => new Date(b.time).getTime() - new Date(a.time).getTime());

      res.json(formattedTrades);
    } catch (error: any) {
      console.error("[api/kraken/trades] Error:", error.message);
      const localTrades = await storage.getTrades(50);
      res.json(localTrades.map(t => ({
        id: t.tradeId,
        krakenOrderId: t.krakenOrderId,
        pair: t.pair,
        type: t.type,
        price: t.price,
        amount: t.amount,
        time: t.executedAt?.toISOString() || t.createdAt.toISOString(),
        status: t.status,
      })));
    }
  });

  app.get("/api/events", async (req, res) => {
    try {
      const limit = Math.min(parseInt(req.query.limit as string) || 50, 200);
      const level = req.query.level as string;
      
      const events = await botLogger.getDbEvents(limit);
      
      const filtered = level 
        ? events.filter(e => e.level === level.toUpperCase())
        : events;
      
      res.json(filtered.map(e => {
        const meta = e.meta ? JSON.parse(e.meta) : null;
        return {
          id: e.id,
          timestamp: e.timestamp,
          level: e.level,
          type: e.type,
          message: e.message,
          meta,
          env: meta?.env || null,
          instanceId: meta?.instanceId || null,
        };
      }));
    } catch (error: any) {
      console.error("[api/events] Error:", error.message);
      res.status(500).json({ error: "Failed to fetch events" });
    }
  });

  app.get("/api/ai/status", async (req, res) => {
    try {
      const status = await aiService.getStatus();
      res.json(status);
    } catch (error: any) {
      console.error("[api/ai/status] Error:", error.message);
      res.status(500).json({ errorCode: "STATUS_ERROR", message: "Error al obtener el estado de la IA" });
    }
  });

  app.get("/api/ai/diagnostic", async (req, res) => {
    try {
      const diagnostic = await aiService.getDiagnostic();
      const config = await storage.getBotConfig();
      const dryRun = environment.isReplit || (config?.dryRunMode ?? false);
      res.json({
        ...diagnostic,
        env: environment.envTag,
        instanceId: environment.instanceId,
        dryRun,
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message });
    }
  });

  app.get("/api/environment", async (req, res) => {
    try {
      const config = await storage.getBotConfig();
      const dryRun = environment.isReplit || (config?.dryRunMode ?? false);
      
      // Obtener git commit hash
      let gitCommit = "unknown";
      try {
        const { execSync } = await import("child_process");
        gitCommit = execSync("git rev-parse --short HEAD", { encoding: "utf-8" }).trim();
      } catch {
        // Git no disponible, usar archivo de versi√≥n si existe
        try {
          const fs = await import("fs");
          if (fs.existsSync("VERSION")) {
            gitCommit = fs.readFileSync("VERSION", "utf-8").trim();
          }
        } catch {}
      }
      
      res.json({
        env: environment.envTag,
        instanceId: environment.instanceId,
        isReplit: environment.isReplit,
        isNAS: environment.isNAS,
        dryRun,
        gitCommit,
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message });
    }
  });

  app.post("/api/ai/backfill", async (req, res) => {
    try {
      const result = await aiService.runBackfill();
      res.json(result);
    } catch (error: any) {
      res.status(500).json({ success: false, error: error.message });
    }
  });

  // Endpoint para limpiar duplicados en training_trades
  app.post("/api/ai/cleanup-duplicates", async (req, res) => {
    try {
      const duplicates = await storage.getDuplicateTrainingTradesByBuyTxid();
      
      if (duplicates.length === 0) {
        return res.json({ success: true, message: "No hay duplicados en training_trades", deleted: 0 });
      }
      
      const deleted = await storage.deleteDuplicateTrainingTrades();
      
      res.json({ 
        success: true, 
        duplicatesFound: duplicates.length,
        deleted,
        details: duplicates.slice(0, 20),
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to cleanup training trades duplicates" });
    }
  });

  // Endpoint para ver duplicados en training_trades sin eliminar
  app.get("/api/ai/duplicates", async (req, res) => {
    try {
      const duplicates = await storage.getDuplicateTrainingTradesByBuyTxid();
      res.json({ 
        count: duplicates.length,
        duplicates: duplicates.slice(0, 50),
      });
    } catch (error: any) {
      res.status(500).json({ error: error.message || "Failed to get training trades duplicates" });
    }
  });

  app.get("/api/ai/samples", async (req, res) => {
    try {
      const complete = req.query.complete === "true" ? true : req.query.complete === "false" ? false : undefined;
      const limit = parseInt(req.query.limit as string) || 100;
      const samples = await storage.getAiSamples({ complete, limit });
      const count = await storage.getAiSamplesCount(complete);
      res.json({ samples, total: count });
    } catch (error: any) {
      console.error("[api/ai/samples] Error:", error.message);
      res.status(500).json({ errorCode: "SAMPLES_ERROR", message: "Error al obtener las muestras de IA" });
    }
  });

  app.post("/api/ai/retrain", async (req, res) => {
    try {
      const result = await aiService.runTraining();
      if (!result.success && result.errorCode === "INSUFFICIENT_DATA") {
        res.status(409).json({
          errorCode: result.errorCode,
          message: result.message,
          required: result.required,
          current: result.current
        });
      } else if (!result.success) {
        res.status(500).json({
          errorCode: result.errorCode || "TRAINING_ERROR",
          message: result.message
        });
      } else {
        res.json({ success: true, message: result.message, metrics: result.metrics });
      }
    } catch (error: any) {
      console.error("[api/ai/retrain] Error:", error.message);
      res.status(500).json({ errorCode: "TRAINING_ERROR", message: "Error interno al reentrenar el modelo" });
    }
  });

  app.post("/api/ai/train", async (req, res) => {
    try {
      const result = await aiService.runTraining();
      if (!result.success && result.errorCode === "INSUFFICIENT_DATA") {
        res.status(409).json({
          errorCode: result.errorCode,
          message: result.message,
          required: result.required,
          current: result.current
        });
      } else if (!result.success) {
        res.status(500).json({
          errorCode: result.errorCode || "TRAINING_ERROR",
          message: result.message
        });
      } else {
        res.json({ success: true, message: result.message, metrics: result.metrics });
      }
    } catch (error: any) {
      console.error("[api/ai/train] Error:", error.message);
      res.status(500).json({ errorCode: "TRAINING_ERROR", message: `Error interno al entrenar el modelo: ${error.message}` });
    }
  });

  app.get("/api/ai/shadow/report", async (req, res) => {
    try {
      const report = await storage.getAiShadowReport();
      res.json(report);
    } catch (error: any) {
      console.error("[api/ai/shadow/report] Error:", error.message);
      res.status(500).json({ errorCode: "SHADOW_REPORT_ERROR", message: "Error al obtener el informe de shadow" });
    }
  });

  app.post("/api/ai/toggle", async (req, res) => {
    try {
      const { filterEnabled, shadowEnabled, threshold } = req.body;
      
      if (filterEnabled !== undefined) {
        await aiService.toggleFilter(filterEnabled);
      }
      if (shadowEnabled !== undefined) {
        await aiService.toggleShadow(shadowEnabled);
      }
      if (threshold !== undefined) {
        await aiService.setThreshold(parseFloat(threshold));
      }
      
      const status = await aiService.getStatus();
      res.json({ success: true, status });
    } catch (error: any) {
      console.error("[api/ai/toggle] Error:", error.message);
      res.status(500).json({ errorCode: "TOGGLE_ERROR", message: "Error al cambiar la configuraci√≥n de IA" });
    }
  });

  // ============================================================
  // TEST ENDPOINT: Simular se√±al BUY para validar SMART_GUARD
  // Solo disponible en REPLIT/DEV o cuando dryRun=true
  // ============================================================
  app.post("/api/test/signal", async (req, res) => {
    try {
      const envInfo = environment.getInfo();
      const botConfig = await storage.getBotConfig();
      const dryRun = botConfig?.dryRunMode ?? true;
      
      // SEGURIDAD: Solo permitir en REPLIT/DEV o dryRun=true
      if (envInfo.isNAS && !dryRun) {
        return res.status(403).json({
          error: "FORBIDDEN",
          message: "Este endpoint solo est√° disponible en entorno de desarrollo (REPLIT/DEV) o con dryRun activado",
          env: envInfo.env,
          dryRun,
        });
      }
      
      // Validar body
      const testSignalSchema = z.object({
        pair: z.string().min(1),
        signal: z.enum(["BUY"]),
        price: z.number().positive().optional(),
        forceOrderUsd: z.number().positive().optional(),
        forceHasPosition: z.boolean().optional(),
        forceOpenLots: z.number().int().min(0).optional(),
      });
      
      const parsed = testSignalSchema.safeParse(req.body);
      if (!parsed.success) {
        return res.status(400).json({
          error: "VALIDATION_ERROR",
          message: "Par√°metros inv√°lidos",
          details: parsed.error.issues,
        });
      }
      
      const { pair, signal, price, forceOrderUsd, forceHasPosition, forceOpenLots } = parsed.data;
      const correlationId = `TEST-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
      
      // Obtener datos del mercado si no se proporciona precio
      let currentPrice = price;
      if (!currentPrice) {
        try {
          const ticker = await krakenService.getTicker(pair);
          currentPrice = parseFloat(ticker?.c?.[0] || "0");
        } catch {
          currentPrice = 100; // Fallback para test
        }
      }
      
      // Obtener configuraci√≥n SMART_GUARD
      const positionMode = botConfig?.positionMode || "SINGLE";
      const sgMinEntryUsd = parseFloat(botConfig?.sgMinEntryUsd?.toString() || "100");
      const sgAllowUnderMin = botConfig?.sgAllowUnderMin ?? true;
      const sgMaxOpenLotsPerPair = 1; // Por defecto 1, se implementar√° en paso 3
      const SG_ABSOLUTE_MIN_USD = 20;
      
      // Obtener balance USD
      let usdBalance = 0;
      try {
        const balances = await krakenService.getBalance() as Record<string, string>;
        usdBalance = parseFloat(balances?.ZUSD || balances?.USD || "0");
      } catch {
        usdBalance = 100; // Fallback para test
      }
      
      // Simular orderUsdFinal
      const orderUsdFinal = forceOrderUsd ?? Math.min(usdBalance * 0.95, sgMinEntryUsd);
      
      // Simular si hay posici√≥n abierta
      const hasPosition = forceHasPosition ?? (tradingEngine?.getOpenPositions().has(pair) ?? false);
      const openLots = forceOpenLots ?? (hasPosition ? 1 : 0);
      
      // Construir meta base
      const baseMeta = {
        correlationId,
        pair,
        signal,
        env: envInfo.env,
        instanceId: envInfo.instanceId,
        testMode: true,
        positionMode,
        usdDisponible: usdBalance,
        orderUsdProposed: sgMinEntryUsd,
        orderUsdFinal,
        sgMinEntryUsd,
        sgAllowUnderMin,
        sgMaxOpenLotsPerPair,
        absoluteMinOrderUsd: SG_ABSOLUTE_MIN_USD,
        hasPosition,
        openLots,
        currentPrice,
      };
      
      let result: { decision: string; reason: string; message: string };
      
      // === VALIDACI√ìN 1: Posici√≥n abierta en SMART_GUARD/SINGLE ===
      if ((positionMode === "SINGLE" || positionMode === "SMART_GUARD") && hasPosition && openLots >= sgMaxOpenLotsPerPair) {
        const reason = positionMode === "SMART_GUARD" 
          ? (openLots >= sgMaxOpenLotsPerPair ? "SMART_GUARD_MAX_LOTS_REACHED" : "SMART_GUARD_POSITION_EXISTS")
          : "SINGLE_MODE_POSITION_EXISTS";
        
        await botLogger.info("TRADE_SKIPPED", `[TEST] Se√±al BUY bloqueada - ${reason}`, {
          ...baseMeta,
          reason,
          existingLots: openLots,
        });
        
        result = {
          decision: "TRADE_SKIPPED",
          reason,
          message: reason === "SMART_GUARD_MAX_LOTS_REACHED"
            ? `M√°ximo de lotes abiertos alcanzado (${openLots}/${sgMaxOpenLotsPerPair})`
            : "Ya hay posici√≥n abierta en este par",
        };
      }
      // === VALIDACI√ìN 2: M√≠nimo absoluto exchange (MIN_ORDER_ABSOLUTE) - Prioridad m√°s alta ===
      else if (orderUsdFinal < SG_ABSOLUTE_MIN_USD) {
        const reason = "MIN_ORDER_ABSOLUTE";
        
        await botLogger.info("TRADE_SKIPPED", `[TEST] Se√±al BUY bloqueada - m√≠nimo absoluto exchange`, {
          ...baseMeta,
          reason,
        });
        
        result = {
          decision: "TRADE_SKIPPED",
          reason,
          message: `M√≠nimo absoluto exchange no alcanzado: $${orderUsdFinal.toFixed(2)} < $${SG_ABSOLUTE_MIN_USD}`,
        };
      }
      // === VALIDACI√ìN 3: M√≠nimo por orden (MIN_ORDER_USD) ===
      else if (positionMode === "SMART_GUARD" && !sgAllowUnderMin && orderUsdFinal < sgMinEntryUsd) {
        const reason = "MIN_ORDER_USD";
        
        await botLogger.info("TRADE_SKIPPED", `[TEST] Se√±al BUY bloqueada - m√≠nimo por orden no alcanzado`, {
          ...baseMeta,
          reason,
        });
        
        result = {
          decision: "TRADE_SKIPPED",
          reason,
          message: `M√≠nimo por orden no alcanzado: $${orderUsdFinal.toFixed(2)} < $${sgMinEntryUsd.toFixed(2)} (allowUnderMin=OFF)`,
        };
      }
      // === CASO POSITIVO: Trade permitido (simulado) ===
      else {
        const reason = "TEST_TRADE_ALLOWED";
        
        await botLogger.info("TEST_TRADE_SIMULATED", `[TEST] Se√±al BUY pasar√≠a todas las validaciones`, {
          ...baseMeta,
          reason,
        });
        
        result = {
          decision: "TEST_TRADE_SIMULATED",
          reason,
          message: `Trade de $${orderUsdFinal.toFixed(2)} pasar√≠a todas las validaciones en ${positionMode}`,
        };
      }
      
      res.json({
        success: true,
        correlationId,
        ...result,
        meta: baseMeta,
      });
      
    } catch (error: any) {
      console.error("[api/test/signal] Error:", error.message);
      res.status(500).json({
        error: "TEST_SIGNAL_ERROR",
        message: `Error al procesar se√±al de prueba: ${error.message}`,
      });
    }
  });

  // ============================================================
  // TEST ENDPOINT: Simular eventos SMART_GUARD para testing
  // Solo disponible en REPLIT/DEV o cuando dryRun=true
  // ============================================================
  app.post("/api/test/sg-event", async (req, res) => {
    try {
      const envInfo = environment.getInfo();
      const botConfig = await storage.getBotConfig();
      const dryRun = botConfig?.dryRunMode ?? true;
      
      // SEGURIDAD: Solo permitir en REPLIT/DEV o dryRun=true
      if (envInfo.isNAS && !dryRun) {
        return res.status(403).json({
          error: "FORBIDDEN",
          message: "Este endpoint solo est√° disponible en entorno de desarrollo (REPLIT/DEV) o con dryRun activado",
        });
      }
      
      const testEventSchema = z.object({
        event: z.enum(["SG_BREAK_EVEN_ACTIVATED", "SG_TRAILING_ACTIVATED", "SG_TRAILING_STOP_UPDATED", "SG_SCALE_OUT_EXECUTED"]),
        pair: z.string().default("BTC/USD"),
        lotId: z.string().optional(),
        entryPrice: z.number().positive().default(100000),
        currentPrice: z.number().positive().optional(),
        profitPct: z.number().default(2.5),
        stopPrice: z.number().positive().optional(),
        scaleOutQty: z.number().positive().optional(),
        scaleOutUsd: z.number().positive().optional(),
      });
      
      const parsed = testEventSchema.safeParse(req.body);
      if (!parsed.success) {
        return res.status(400).json({ error: "VALIDATION_ERROR", details: parsed.error.issues });
      }
      
      const { event, pair, entryPrice, profitPct } = parsed.data;
      const lotId = parsed.data.lotId || `TEST-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
      const currentPrice = parsed.data.currentPrice || entryPrice * (1 + profitPct / 100);
      const stopPrice = parsed.data.stopPrice || currentPrice * 0.98;
      
      const baseMeta = {
        pair,
        lotId,
        entryPrice,
        currentPrice,
        profitPct: profitPct.toFixed(2) + "%",
        env: envInfo.env,
        instanceId: envInfo.instanceId,
        testMode: true,
      };
      
      let message = "";
      let telegramMsg = "";
      const prefix = environment.getMessagePrefix(true); // Test events are always DRY_RUN
      
      switch (event) {
        case "SG_BREAK_EVEN_ACTIVATED":
          message = `SMART_GUARD Break-Even activado en ${pair}`;
          telegramMsg = `${prefix}‚öñÔ∏è *Break-Even Activado*\n` +
            `Par: ${pair}\n` +
            `Lote: \`${lotId}\`\n` +
            `Entrada: $${entryPrice.toFixed(2)}\n` +
            `Precio actual: $${currentPrice.toFixed(2)}\n` +
            `Profit: +${profitPct.toFixed(2)}%\n` +
            `Stop movido a: $${stopPrice.toFixed(2)}`;
          await botLogger.info(event, message, { ...baseMeta, stopPrice });
          await telegramService.sendAlertToMultipleChats(telegramMsg, "status");
          break;
          
        case "SG_TRAILING_ACTIVATED":
          message = `SMART_GUARD Trailing Stop activado en ${pair}`;
          telegramMsg = `${prefix}üéØ *Trailing Stop Activado*\n` +
            `Par: ${pair}\n` +
            `Lote: \`${lotId}\`\n` +
            `Entrada: $${entryPrice.toFixed(2)}\n` +
            `Precio actual: $${currentPrice.toFixed(2)}\n` +
            `Profit: +${profitPct.toFixed(2)}%\n` +
            `Stop din√°mico: $${stopPrice.toFixed(2)}`;
          await botLogger.info(event, message, { ...baseMeta, stopPrice });
          await telegramService.sendAlertToMultipleChats(telegramMsg, "status");
          break;
          
        case "SG_TRAILING_STOP_UPDATED":
          const oldStop = stopPrice * 0.99;
          message = `SMART_GUARD Trailing Stop actualizado en ${pair}`;
          telegramMsg = `${prefix}üìà *Trailing Stop Actualizado*\n` +
            `Par: ${pair}\n` +
            `Lote: \`${lotId}\`\n` +
            `Stop: $${oldStop.toFixed(2)} ‚Üí $${stopPrice.toFixed(2)}\n` +
            `Profit actual: +${profitPct.toFixed(2)}%`;
          await botLogger.info(event, message, { ...baseMeta, stopPrice, oldStop });
          await telegramService.sendAlertToMultipleChats(telegramMsg, "status");
          break;
          
        case "SG_SCALE_OUT_EXECUTED":
          const scaleOutQty = parsed.data.scaleOutQty || 0.001;
          const scaleOutUsd = parsed.data.scaleOutUsd || scaleOutQty * currentPrice;
          message = `SMART_GUARD Scale-Out ejecutado en ${pair}`;
          telegramMsg = `${prefix}üìä *Scale-Out Ejecutado*\n` +
            `Par: ${pair}\n` +
            `Lote: \`${lotId}\`\n` +
            `Vendido: ${scaleOutQty} ($${scaleOutUsd.toFixed(2)})\n` +
            `Profit: +${profitPct.toFixed(2)}%`;
          await botLogger.info(event, message, { ...baseMeta, scaleOutQty, scaleOutUsd });
          await telegramService.sendAlertToMultipleChats(telegramMsg, "status");
          break;
      }
      
      res.json({
        success: true,
        event,
        message,
        meta: baseMeta,
        telegramSent: true,
      });
      
    } catch (error: any) {
      console.error("[api/test/sg-event] Error:", error.message);
      res.status(500).json({ error: "TEST_SG_EVENT_ERROR", message: error.message });
    }
  });

  // ============================================================
  // TEST ENDPOINT: Probar multi-lot (crear posiciones de prueba)
  // ============================================================
  app.post("/api/test/create-position", async (req, res) => {
    try {
      const envInfo = environment.getInfo();
      const botConfig = await storage.getBotConfig();
      const dryRun = botConfig?.dryRunMode ?? true;
      
      if (envInfo.isNAS && !dryRun) {
        return res.status(403).json({ error: "FORBIDDEN" });
      }
      
      const schema = z.object({
        pair: z.string().default("BTC/USD"),
        amount: z.number().positive().default(0.001),
        entryPrice: z.number().positive().default(100000),
      });
      
      const parsed = schema.safeParse(req.body);
      if (!parsed.success) {
        return res.status(400).json({ error: "VALIDATION_ERROR", details: parsed.error.issues });
      }
      
      const { pair, amount, entryPrice } = parsed.data;
      const lotId = `TEST-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
      
      // Add to trading engine's open positions
      if (tradingEngine) {
        const position = {
          pair,
          amount,
          entryPrice,
          timestamp: new Date().toISOString(),
          lotId,
          strategy: "test",
          signalConfidence: 80,
          // SMART_GUARD flags
          sgBreakEvenActivated: false,
          sgTrailingActivated: false,
          sgCurrentStopPrice: null,
          sgScaleOutDone: false,
          configSnapshotJson: botConfig ? JSON.stringify({
            sgMinEntryUsd: botConfig.sgMinEntryUsd,
            sgBeAtPct: botConfig.sgBeAtPct,
            sgTrailStartPct: botConfig.sgTrailStartPct,
            sgTrailDistancePct: botConfig.sgTrailDistancePct,
          }) : null,
        };
        
        tradingEngine.getOpenPositions().set(lotId, position);
        
        // Count lots for this pair
        const allPositions = tradingEngine.getOpenPositions();
        let pairLots = 0;
        Array.from(allPositions.values()).forEach((pos: any) => {
          if (pos.pair === pair) pairLots++;
        });
        
        await botLogger.info("TEST_POSITION_CREATED", `Posici√≥n de prueba creada: ${pair} x${amount}`, {
          pair, lotId, amount, entryPrice, pairLots, env: envInfo.env,
        });
        
        res.json({
          success: true,
          lotId,
          position,
          pairLotsCount: pairLots,
        });
      } else {
        res.status(500).json({ error: "ENGINE_NOT_READY" });
      }
      
    } catch (error: any) {
      res.status(500).json({ error: "CREATE_POSITION_ERROR", message: error.message });
    }
  });

  // ============================================================
  // TEST ENDPOINT: Eliminar posici√≥n de prueba
  // ============================================================
  app.delete("/api/test/position/:lotId", async (req, res) => {
    try {
      const envInfo = environment.getInfo();
      const botConfig = await storage.getBotConfig();
      const dryRun = botConfig?.dryRunMode ?? true;
      
      if (envInfo.isNAS && !dryRun) {
        return res.status(403).json({ error: "FORBIDDEN" });
      }
      
      const { lotId } = req.params;
      
      if (tradingEngine) {
        const deleted = tradingEngine.getOpenPositions().delete(lotId);
        res.json({ success: true, deleted, lotId });
      } else {
        res.status(500).json({ error: "ENGINE_NOT_READY" });
      }
      
    } catch (error: any) {
      res.status(500).json({ error: "DELETE_POSITION_ERROR", message: error.message });
    }
  });

  // ============================================================
  // TEST ENDPOINT: Simular sizing SMART_GUARD v2
  // Para validar la l√≥gica: 469‚Üí200, 250‚Üí200, 150‚Üí150, 25‚Üí25, 19‚Üíblock
  // ============================================================
  app.post("/api/test/sg-sizing", async (req, res) => {
    try {
      const envInfo = environment.getInfo();
      const botConfig = await storage.getBotConfig();
      const dryRun = botConfig?.dryRunMode ?? true;
      
      if (envInfo.isNAS && !dryRun) {
        return res.status(403).json({ error: "FORBIDDEN" });
      }
      
      const schema = z.object({
        availableUsd: z.number().min(0),
        sgMinEntryUsd: z.number().positive().default(200),
        minOrderExchangeUsd: z.number().positive().default(10), // m√≠nimo del exchange en USD
        feeCushionPct: z.number().min(0).default(0),
      });
      
      const parsed = schema.safeParse(req.body);
      if (!parsed.success) {
        return res.status(400).json({ error: "VALIDATION_ERROR", details: parsed.error.issues });
      }
      
      const { availableUsd, sgMinEntryUsd, minOrderExchangeUsd, feeCushionPct } = parsed.data;
      
      // Constantes
      const SG_ABSOLUTE_MIN_USD = 20;
      
      // SMART_GUARD v2: sin buffer de slippage para sizing exacto
      const usdDisponible = availableUsd;
      
      // floorUsd = max(minOrderExchangeUsd, MIN_ORDER_ABSOLUTE_USD)
      const floorUsd = Math.max(SG_ABSOLUTE_MIN_USD, minOrderExchangeUsd);
      
      // Fee cushion
      const cushionAmount = availableUsd * (feeCushionPct / 100);
      const availableAfterCushion = usdDisponible - cushionAmount;
      
      // === SMART_GUARD v2 SIZING LOGIC ===
      let orderUsd: number;
      let reasonCode: string;
      let blocked = false;
      
      if (availableAfterCushion >= sgMinEntryUsd) {
        // Caso A: Saldo suficiente ‚Üí usar sgMinEntryUsd EXACTO
        orderUsd = sgMinEntryUsd;
        reasonCode = "SMART_GUARD_ENTRY_USING_CONFIG_MIN";
        
      } else if (availableAfterCushion >= floorUsd) {
        // Caso B: Fallback autom√°tico ‚Üí usar saldo disponible
        orderUsd = availableAfterCushion;
        reasonCode = "SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE";
        
      } else if (usdDisponible >= floorUsd && availableAfterCushion < floorUsd) {
        // Caso C: Fee cushion lo baja de floorUsd ‚Üí BLOCKED
        orderUsd = availableAfterCushion;
        reasonCode = "SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION";
        blocked = true;
        
      } else {
        // Caso D: Saldo < floorUsd ‚Üí BLOCKED
        orderUsd = usdDisponible;
        reasonCode = "SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN";
        blocked = true;
      }
      
      res.json({
        success: true,
        blocked,
        reasonCode,
        orderUsd: parseFloat(orderUsd.toFixed(2)),
        details: {
          input: {
            availableUsd,
            sgMinEntryUsd,
            minOrderExchangeUsd,
            feeCushionPct,
          },
          calculated: {
            usdDisponible: parseFloat(usdDisponible.toFixed(2)),
            floorUsd,
            cushionAmount: parseFloat(cushionAmount.toFixed(2)),
            availableAfterCushion: parseFloat(availableAfterCushion.toFixed(2)),
          },
          thresholds: {
            SG_ABSOLUTE_MIN_USD,
            minOrderExchangeUsd,
            floorUsd,
          },
        },
      });
      
    } catch (error: any) {
      res.status(500).json({ error: "SG_SIZING_TEST_ERROR", message: error.message });
    }
  });

  return httpServer;
}


===== FILE: ./server/storage.ts =====
import { 
  type BotConfig, 
  type Trade, 
  type Notification, 
  type MarketData,
  type ApiConfig,
  type TelegramChat,
  type OpenPosition,
  type AiTradeSample,
  type AiShadowDecision,
  type AiConfig,
  type TrainingTrade,
  type InsertBotConfig,
  type InsertTrade,
  type InsertNotification,
  type InsertMarketData,
  type InsertApiConfig,
  type InsertTelegramChat,
  type InsertOpenPosition,
  type InsertAiTradeSample,
  type InsertAiShadowDecision,
  type InsertAiConfig,
  type InsertTrainingTrade,
  type TradeFill,
  type LotMatch,
  type InsertTradeFill,
  type InsertLotMatch,
  botConfig as botConfigTable,
  trades as tradesTable,
  notifications as notificationsTable,
  marketData as marketDataTable,
  apiConfig as apiConfigTable,
  telegramChats as telegramChatsTable,
  openPositions as openPositionsTable,
  tradeFills as tradeFillsTable,
  lotMatches as lotMatchesTable,
  aiTradeSamples as aiTradeSamplesTable,
  aiShadowDecisions as aiShadowDecisionsTable,
  aiConfig as aiConfigTable,
  trainingTrades as trainingTradesTable
} from "@shared/schema";
import { db } from "./db";
import { eq, desc, and, gt, lt, sql, isNull } from "drizzle-orm";

export interface IStorage {
  getBotConfig(): Promise<BotConfig | undefined>;
  updateBotConfig(config: Partial<InsertBotConfig>): Promise<BotConfig>;
  
  getApiConfig(): Promise<ApiConfig | undefined>;
  updateApiConfig(config: Partial<InsertApiConfig>): Promise<ApiConfig>;
  
  createTrade(trade: InsertTrade): Promise<Trade>;
  getTrades(limit?: number): Promise<Trade[]>;
  getClosedTrades(options: { limit?: number; offset?: number; pair?: string; result?: 'winner' | 'loser' | 'all'; type?: 'all' | 'buy' | 'sell' }): Promise<{ trades: Trade[]; total: number }>;
  updateTradeStatus(tradeId: string, status: string, krakenOrderId?: string): Promise<void>;
  getTradeByKrakenOrderId(krakenOrderId: string): Promise<Trade | undefined>;
  getTradeByLotId(lotId: string): Promise<Trade | undefined>;
  getSellMatchingBuy(pair: string, buyLotId: string): Promise<Trade | undefined>;
  upsertTradeByKrakenId(trade: InsertTrade): Promise<{ inserted: boolean; trade?: Trade }>;
  getDuplicateTradesByKrakenId(): Promise<{ krakenOrderId: string; count: number; ids: number[] }[]>;
  deleteDuplicateTrades(): Promise<number>;
  updateTradePnl(id: number, entryPrice: string, realizedPnlUsd: string, realizedPnlPct: string): Promise<void>;
  getUnmatchedBuys(pair: string): Promise<Trade[]>;
  
  createNotification(notification: InsertNotification): Promise<Notification>;
  getUnsentNotifications(): Promise<Notification[]>;
  markNotificationSent(id: number): Promise<void>;
  
  saveMarketData(data: InsertMarketData): Promise<MarketData>;
  getLatestMarketData(pair: string): Promise<MarketData | undefined>;
  
  getTelegramChats(): Promise<TelegramChat[]>;
  getActiveTelegramChats(): Promise<TelegramChat[]>;
  createTelegramChat(chat: InsertTelegramChat): Promise<TelegramChat>;
  updateTelegramChat(id: number, chat: Partial<InsertTelegramChat>): Promise<TelegramChat>;
  deleteTelegramChat(id: number): Promise<void>;
  
  getOpenPositions(): Promise<OpenPosition[]>;
  getOpenPosition(pair: string): Promise<OpenPosition | undefined>;
  getOpenPositionByLotId(lotId: string): Promise<OpenPosition | undefined>;
  getOpenPositionsByPair(pair: string): Promise<OpenPosition[]>;
  saveOpenPosition(position: InsertOpenPosition): Promise<OpenPosition>;
  saveOpenPositionByLotId(position: InsertOpenPosition): Promise<OpenPosition>;
  updateOpenPosition(pair: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined>;
  updateOpenPositionByLotId(lotId: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined>;
  updateOpenPositionLotId(id: number, lotId: string): Promise<void>;
  deleteOpenPosition(pair: string): Promise<void>;
  deleteOpenPositionByLotId(lotId: string): Promise<void>;
  getOpenPositionsWithQtyRemaining(): Promise<OpenPosition[]>;
  updateOpenPositionQty(lotId: string, qtyRemaining: string, qtyFilled: string): Promise<void>;
  initializeQtyRemainingForAll(): Promise<number>;
  
  // Trade fills
  upsertTradeFill(fill: InsertTradeFill): Promise<{ inserted: boolean; fill?: TradeFill }>;
  getTradeFillByTxid(txid: string): Promise<TradeFill | undefined>;
  getUnmatchedSellFills(pair: string): Promise<TradeFill[]>;
  markFillAsMatched(txid: string): Promise<void>;
  
  // Lot matches (FIFO matcher audit trail)
  createLotMatch(match: InsertLotMatch): Promise<LotMatch>;
  getLotMatchesByLotId(lotId: string): Promise<LotMatch[]>;
  getLotMatchBySellFillAndLot(sellFillTxid: string, lotId: string): Promise<LotMatch | undefined>;
  
  saveAiSample(sample: InsertAiTradeSample): Promise<AiTradeSample>;
  updateAiSample(sampleId: number, updates: Partial<InsertAiTradeSample>): Promise<AiTradeSample | undefined>;
  getAiSamples(options?: { complete?: boolean; limit?: number }): Promise<AiTradeSample[]>;
  getAiSamplesCount(complete?: boolean): Promise<number>;
  
  saveAiShadowDecision(decision: InsertAiShadowDecision): Promise<AiShadowDecision>;
  updateAiShadowFinalPnl(tradeId: string, pnl: string): Promise<void>;
  getAiShadowReport(): Promise<{ total: number; blocked: number; blockedLosers: number; passedLosers: number }>;
  
  getAiConfig(): Promise<AiConfig | undefined>;
  updateAiConfig(config: Partial<InsertAiConfig>): Promise<AiConfig>;
  
  saveTrainingTrade(trade: InsertTrainingTrade): Promise<TrainingTrade>;
  updateTrainingTrade(id: number, updates: Partial<InsertTrainingTrade>): Promise<TrainingTrade | undefined>;
  getTrainingTradeByBuyTxid(buyTxid: string): Promise<TrainingTrade | undefined>;
  getTrainingTrades(options?: { closed?: boolean; labeled?: boolean; limit?: number }): Promise<TrainingTrade[]>;
  getDuplicateTrainingTradesByBuyTxid(): Promise<{ buyTxid: string; count: number; ids: number[] }[]>;
  deleteDuplicateTrainingTrades(): Promise<number>;
  getTrainingTradesCount(options?: { closed?: boolean; labeled?: boolean; hasOpenLots?: boolean }): Promise<number>;
  getDiscardReasonsDataset(): Promise<Record<string, number>>;
  getAllTradesForBackfill(): Promise<Trade[]>;
  runTrainingTradesBackfill(): Promise<{ created: number; closed: number; labeled: number; discardReasons: Record<string, number> }>;
  
  // Schema health check and auto-migration
  checkSchemaHealth(): Promise<{ healthy: boolean; missingColumns: string[]; migrationRan: boolean }>;
  runSchemaMigration(): Promise<{ success: boolean; columnsAdded: string[]; error?: string }>;
}

export class DatabaseStorage implements IStorage {
  private schemaMigrationAttempted = false;
  
  async getBotConfig(): Promise<BotConfig | undefined> {
    try {
      const configs = await db.select().from(botConfigTable).limit(1);
      if (configs.length === 0) {
        const [newConfig] = await db.insert(botConfigTable).values({}).returning();
        return newConfig;
      }
      return configs[0];
    } catch (error) {
      // If schema is outdated, try auto-migration ONCE then retry
      if (!this.schemaMigrationAttempted && error instanceof Error && error.message.includes('does not exist')) {
        console.log('[storage] Schema issue detected, attempting auto-migration...');
        this.schemaMigrationAttempted = true;
        const migrationResult = await this.runSchemaMigration();
        if (migrationResult.success) {
          console.log('[storage] Auto-migration successful, retrying getBotConfig...');
          return this.getBotConfig();
        }
        // Migration failed - propagate error
        console.error('[storage] Auto-migration failed:', migrationResult.error);
      }
      // No fallback - surface the error so operators know to fix schema
      throw error;
    }
  }

  async updateBotConfig(config: Partial<InsertBotConfig>): Promise<BotConfig> {
    const existing = await this.getBotConfig();
    if (!existing) {
      const [newConfig] = await db.insert(botConfigTable).values(config as InsertBotConfig).returning();
      return newConfig;
    }
    const [updated] = await db.update(botConfigTable)
      .set({ ...config, updatedAt: new Date() })
      .where(eq(botConfigTable.id, existing.id))
      .returning();
    return updated;
  }

  async getApiConfig(): Promise<ApiConfig | undefined> {
    const configs = await db.select().from(apiConfigTable).limit(1);
    if (configs.length === 0) {
      const [newConfig] = await db.insert(apiConfigTable).values({}).returning();
      return newConfig;
    }
    return configs[0];
  }

  async updateApiConfig(config: Partial<InsertApiConfig>): Promise<ApiConfig> {
    const existing = await this.getApiConfig();
    if (!existing) {
      const [newConfig] = await db.insert(apiConfigTable).values(config as InsertApiConfig).returning();
      return newConfig;
    }
    const [updated] = await db.update(apiConfigTable)
      .set({ ...config, updatedAt: new Date() })
      .where(eq(apiConfigTable.id, existing.id))
      .returning();
    return updated;
  }

  async createTrade(trade: InsertTrade): Promise<Trade> {
    const [newTrade] = await db.insert(tradesTable).values(trade).returning();
    return newTrade;
  }

  // Upsert trade - inserta solo si no existe (por krakenOrderId)
  async upsertTradeByKrakenId(trade: InsertTrade): Promise<{ inserted: boolean; trade?: Trade }> {
    if (!trade.krakenOrderId) {
      const [newTrade] = await db.insert(tradesTable).values(trade).returning();
      return { inserted: true, trade: newTrade };
    }
    
    // Verificar si existe
    const existing = await this.getTradeByKrakenOrderId(trade.krakenOrderId);
    if (existing) {
      return { inserted: false, trade: existing };
    }
    
    try {
      const [newTrade] = await db.insert(tradesTable).values(trade).returning();
      return { inserted: true, trade: newTrade };
    } catch (e: any) {
      // Handle unique constraint violation gracefully
      if (e.code === '23505') {
        return { inserted: false };
      }
      throw e;
    }
  }

  // Obtener duplicados por krakenOrderId para limpieza
  async getDuplicateTradesByKrakenId(): Promise<{ krakenOrderId: string; count: number; ids: number[] }[]> {
    const result = await db.execute(sql`
      SELECT kraken_order_id, COUNT(*) as count, ARRAY_AGG(id ORDER BY id) as ids
      FROM trades
      WHERE kraken_order_id IS NOT NULL
      GROUP BY kraken_order_id
      HAVING COUNT(*) > 1
    `);
    return (result.rows as any[]).map(row => ({
      krakenOrderId: row.kraken_order_id,
      count: parseInt(row.count),
      ids: row.ids,
    }));
  }

  // Eliminar duplicados manteniendo el m√°s antiguo (menor id)
  async deleteDuplicateTrades(): Promise<number> {
    const duplicates = await this.getDuplicateTradesByKrakenId();
    let deleted = 0;
    
    for (const dup of duplicates) {
      // Mantener el primer id (m√°s antiguo), eliminar el resto
      const idsToDelete = dup.ids.slice(1);
      for (const id of idsToDelete) {
        await db.delete(tradesTable).where(eq(tradesTable.id, id));
        deleted++;
      }
    }
    
    return deleted;
  }

  // Actualizar P&L de un trade
  async updateTradePnl(id: number, entryPrice: string, realizedPnlUsd: string, realizedPnlPct: string): Promise<void> {
    await db.update(tradesTable)
      .set({ entryPrice, realizedPnlUsd, realizedPnlPct })
      .where(eq(tradesTable.id, id));
  }

  // Obtener trades BUY sin emparejar para un par (para calcular P&L)
  async getUnmatchedBuys(pair: string): Promise<Trade[]> {
    return await db.select().from(tradesTable)
      .where(and(
        eq(tradesTable.pair, pair),
        eq(tradesTable.type, 'buy'),
        eq(tradesTable.status, 'filled')
      ))
      .orderBy(tradesTable.executedAt);
  }

  async getTrades(limit: number = 50): Promise<Trade[]> {
    return await db.select().from(tradesTable).orderBy(desc(tradesTable.createdAt)).limit(limit);
  }

  async getClosedTrades(options: { limit?: number; offset?: number; pair?: string; result?: 'winner' | 'loser' | 'all'; type?: 'all' | 'buy' | 'sell' }): Promise<{ trades: Trade[]; total: number }> {
    const { limit = 10, offset = 0, pair, result = 'all', type = 'all' } = options;
    
    const conditions: any[] = [];
    
    if (type !== 'all') {
      conditions.push(eq(tradesTable.type, type));
    }
    
    if (pair) {
      conditions.push(eq(tradesTable.pair, pair));
    }
    
    if (result === 'winner') {
      conditions.push(gt(tradesTable.realizedPnlUsd, '0'));
    } else if (result === 'loser') {
      conditions.push(lt(tradesTable.realizedPnlUsd, '0'));
    }
    
    const whereClause = conditions.length > 0 ? (conditions.length === 1 ? conditions[0] : and(...conditions)) : undefined;
    
    const tradesQuery = db.select().from(tradesTable)
      .orderBy(desc(tradesTable.executedAt))
      .limit(limit)
      .offset(offset);
    
    const countQuery = db.select({ count: sql<number>`count(*)` }).from(tradesTable);
    
    const trades = whereClause ? await tradesQuery.where(whereClause) : await tradesQuery;
    const countResult = whereClause ? await countQuery.where(whereClause) : await countQuery;
    
    return { trades, total: Number(countResult[0]?.count || 0) };
  }

  async updateTradeStatus(tradeId: string, status: string, krakenOrderId?: string): Promise<void> {
    await db.update(tradesTable)
      .set({ status, krakenOrderId, executedAt: new Date() })
      .where(eq(tradesTable.tradeId, tradeId));
  }

  async getTradeByKrakenOrderId(krakenOrderId: string): Promise<Trade | undefined> {
    const trades = await db.select().from(tradesTable)
      .where(eq(tradesTable.krakenOrderId, krakenOrderId))
      .limit(1);
    return trades[0];
  }

  // Check for duplicate trade by characteristics (pair + amount + type + timestamp within 60 seconds)
  async findDuplicateTrade(pair: string, amount: string, type: string, executedAt: Date): Promise<Trade | undefined> {
    const trades = await db.select().from(tradesTable)
      .where(and(
        eq(tradesTable.pair, pair),
        eq(tradesTable.amount, amount),
        eq(tradesTable.type, type),
        sql`ABS(EXTRACT(EPOCH FROM (${tradesTable.executedAt} - ${executedAt}))) < 60`
      ))
      .limit(1);
    return trades[0];
  }

  async getTradeByLotId(lotId: string): Promise<Trade | undefined> {
    // lotId typically equals krakenOrderId for synced trades
    const trades = await db.select().from(tradesTable)
      .where(eq(tradesTable.krakenOrderId, lotId))
      .limit(1);
    return trades[0];
  }

  async getSellMatchingBuy(pair: string, buyLotId: string): Promise<Trade | undefined> {
    // Find the BUY trade first to get its timestamp (case-insensitive)
    const buyTrade = await db.select().from(tradesTable)
      .where(and(
        eq(tradesTable.krakenOrderId, buyLotId),
        sql`UPPER(${tradesTable.type}) = 'BUY'`
      ))
      .limit(1);
    
    if (!buyTrade[0]) return undefined;
    
    // Find any SELL for the same pair that happened after this BUY (case-insensitive)
    const sellTrades = await db.select().from(tradesTable)
      .where(and(
        eq(tradesTable.pair, pair),
        sql`UPPER(${tradesTable.type}) = 'SELL'`,
        gt(tradesTable.executedAt, buyTrade[0].executedAt!)
      ))
      .orderBy(tradesTable.executedAt)
      .limit(1);
    
    return sellTrades[0];
  }

  async createNotification(notification: InsertNotification): Promise<Notification> {
    const [newNotification] = await db.insert(notificationsTable).values(notification).returning();
    return newNotification;
  }

  async getUnsentNotifications(): Promise<Notification[]> {
    return await db.select().from(notificationsTable)
      .where(eq(notificationsTable.telegramSent, false))
      .orderBy(desc(notificationsTable.createdAt));
  }

  async markNotificationSent(id: number): Promise<void> {
    await db.update(notificationsTable)
      .set({ telegramSent: true, sentAt: new Date() })
      .where(eq(notificationsTable.id, id));
  }

  async saveMarketData(data: InsertMarketData): Promise<MarketData> {
    const [newData] = await db.insert(marketDataTable).values(data).returning();
    return newData;
  }

  async getLatestMarketData(pair: string): Promise<MarketData | undefined> {
    const data = await db.select().from(marketDataTable)
      .where(eq(marketDataTable.pair, pair))
      .orderBy(desc(marketDataTable.timestamp))
      .limit(1);
    return data[0];
  }

  async getTelegramChats(): Promise<TelegramChat[]> {
    return await db.select().from(telegramChatsTable).orderBy(desc(telegramChatsTable.createdAt));
  }

  async getActiveTelegramChats(): Promise<TelegramChat[]> {
    return await db.select().from(telegramChatsTable)
      .where(eq(telegramChatsTable.isActive, true))
      .orderBy(desc(telegramChatsTable.createdAt));
  }

  async createTelegramChat(chat: InsertTelegramChat): Promise<TelegramChat> {
    const [newChat] = await db.insert(telegramChatsTable).values(chat).returning();
    return newChat;
  }

  async updateTelegramChat(id: number, chat: Partial<InsertTelegramChat>): Promise<TelegramChat> {
    const [updated] = await db.update(telegramChatsTable)
      .set(chat)
      .where(eq(telegramChatsTable.id, id))
      .returning();
    return updated;
  }

  async deleteTelegramChat(id: number): Promise<void> {
    await db.delete(telegramChatsTable).where(eq(telegramChatsTable.id, id));
  }

  async getOpenPositions(): Promise<OpenPosition[]> {
    return await db.select().from(openPositionsTable);
  }

  async getOpenPosition(pair: string): Promise<OpenPosition | undefined> {
    const positions = await db.select().from(openPositionsTable)
      .where(eq(openPositionsTable.pair, pair))
      .limit(1);
    return positions[0];
  }

  async getOpenPositionByLotId(lotId: string): Promise<OpenPosition | undefined> {
    const positions = await db.select().from(openPositionsTable)
      .where(eq(openPositionsTable.lotId, lotId))
      .limit(1);
    return positions[0];
  }

  async getOpenPositionsByPair(pair: string): Promise<OpenPosition[]> {
    return await db.select().from(openPositionsTable)
      .where(eq(openPositionsTable.pair, pair));
  }

  async saveOpenPosition(position: InsertOpenPosition): Promise<OpenPosition> {
    const existing = await this.getOpenPosition(position.pair);
    if (existing) {
      const [updated] = await db.update(openPositionsTable)
        .set({ ...position, updatedAt: new Date() })
        .where(eq(openPositionsTable.pair, position.pair))
        .returning();
      return updated;
    }
    const [newPosition] = await db.insert(openPositionsTable).values(position).returning();
    return newPosition;
  }

  async saveOpenPositionByLotId(position: InsertOpenPosition): Promise<OpenPosition> {
    if (!position.lotId) {
      throw new Error("lotId is required for saveOpenPositionByLotId");
    }
    const existing = await this.getOpenPositionByLotId(position.lotId);
    if (existing) {
      const [updated] = await db.update(openPositionsTable)
        .set({ ...position, updatedAt: new Date() })
        .where(eq(openPositionsTable.lotId, position.lotId))
        .returning();
      return updated;
    }
    const [newPosition] = await db.insert(openPositionsTable).values(position).returning();
    return newPosition;
  }

  async updateOpenPosition(pair: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined> {
    const [updated] = await db.update(openPositionsTable)
      .set({ ...updates, updatedAt: new Date() })
      .where(eq(openPositionsTable.pair, pair))
      .returning();
    return updated;
  }

  async updateOpenPositionByLotId(lotId: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined> {
    const [updated] = await db.update(openPositionsTable)
      .set({ ...updates, updatedAt: new Date() })
      .where(eq(openPositionsTable.lotId, lotId))
      .returning();
    return updated;
  }

  async updateOpenPositionLotId(id: number, lotId: string): Promise<void> {
    await db.update(openPositionsTable)
      .set({ lotId, updatedAt: new Date() })
      .where(eq(openPositionsTable.id, id));
  }

  async deleteOpenPosition(pair: string): Promise<void> {
    await db.delete(openPositionsTable).where(eq(openPositionsTable.pair, pair));
  }

  async deleteOpenPositionByLotId(lotId: string): Promise<void> {
    await db.delete(openPositionsTable).where(eq(openPositionsTable.lotId, lotId));
  }

  async getOpenPositionsWithQtyRemaining(): Promise<OpenPosition[]> {
    // Returns only positions with qtyRemaining > 0 (or null which means not yet initialized)
    return await db.select().from(openPositionsTable)
      .where(sql`${openPositionsTable.qtyRemaining} > 0 OR ${openPositionsTable.qtyRemaining} IS NULL`)
      .orderBy(openPositionsTable.openedAt);
  }

  async updateOpenPositionQty(lotId: string, qtyRemaining: string, qtyFilled: string): Promise<void> {
    await db.update(openPositionsTable)
      .set({ qtyRemaining, qtyFilled, updatedAt: new Date() })
      .where(eq(openPositionsTable.lotId, lotId));
  }

  async initializeQtyRemainingForAll(): Promise<number> {
    // Initialize qtyRemaining = amount for all positions where qtyRemaining is null
    const result = await db.execute(sql`
      UPDATE open_positions 
      SET qty_remaining = amount, qty_filled = '0'
      WHERE qty_remaining IS NULL
    `);
    return Number(result.rowCount || 0);
  }

  // Trade fills
  async upsertTradeFill(fill: InsertTradeFill): Promise<{ inserted: boolean; fill?: TradeFill }> {
    const existing = await this.getTradeFillByTxid(fill.txid);
    if (existing) {
      return { inserted: false, fill: existing };
    }
    try {
      const [newFill] = await db.insert(tradeFillsTable).values(fill).returning();
      return { inserted: true, fill: newFill };
    } catch (error: any) {
      if (error.code === '23505') { // Unique violation
        const existingFill = await this.getTradeFillByTxid(fill.txid);
        return { inserted: false, fill: existingFill };
      }
      throw error;
    }
  }

  async getTradeFillByTxid(txid: string): Promise<TradeFill | undefined> {
    const fills = await db.select().from(tradeFillsTable)
      .where(eq(tradeFillsTable.txid, txid))
      .limit(1);
    return fills[0];
  }

  async getUnmatchedSellFills(pair: string): Promise<TradeFill[]> {
    return await db.select().from(tradeFillsTable)
      .where(and(
        eq(tradeFillsTable.pair, pair),
        sql`UPPER(${tradeFillsTable.type}) = 'SELL'`,
        eq(tradeFillsTable.matched, false)
      ))
      .orderBy(tradeFillsTable.executedAt);
  }

  async markFillAsMatched(txid: string): Promise<void> {
    await db.update(tradeFillsTable)
      .set({ matched: true })
      .where(eq(tradeFillsTable.txid, txid));
  }

  // Lot matches
  async createLotMatch(match: InsertLotMatch): Promise<LotMatch> {
    try {
      const [newMatch] = await db.insert(lotMatchesTable).values(match).returning();
      return newMatch;
    } catch (error: any) {
      if (error.code === '23505') { // Unique violation - already exists
        const existing = await this.getLotMatchBySellFillAndLot(match.sellFillTxid, match.lotId);
        if (existing) return existing;
      }
      throw error;
    }
  }

  async getLotMatchesByLotId(lotId: string): Promise<LotMatch[]> {
    return await db.select().from(lotMatchesTable)
      .where(eq(lotMatchesTable.lotId, lotId))
      .orderBy(lotMatchesTable.createdAt);
  }

  async getLotMatchBySellFillAndLot(sellFillTxid: string, lotId: string): Promise<LotMatch | undefined> {
    const matches = await db.select().from(lotMatchesTable)
      .where(and(
        eq(lotMatchesTable.sellFillTxid, sellFillTxid),
        eq(lotMatchesTable.lotId, lotId)
      ))
      .limit(1);
    return matches[0];
  }

  async saveAiSample(sample: InsertAiTradeSample): Promise<AiTradeSample> {
    const [newSample] = await db.insert(aiTradeSamplesTable).values(sample).returning();
    return newSample;
  }

  async updateAiSample(sampleId: number, updates: Partial<InsertAiTradeSample>): Promise<AiTradeSample | undefined> {
    const [updated] = await db.update(aiTradeSamplesTable)
      .set(updates)
      .where(eq(aiTradeSamplesTable.id, sampleId))
      .returning();
    return updated;
  }

  async getAiSamples(options?: { complete?: boolean; limit?: number }): Promise<AiTradeSample[]> {
    const { complete, limit = 1000 } = options || {};
    if (complete !== undefined) {
      return await db.select().from(aiTradeSamplesTable)
        .where(eq(aiTradeSamplesTable.isComplete, complete))
        .orderBy(desc(aiTradeSamplesTable.createdAt))
        .limit(limit);
    }
    return await db.select().from(aiTradeSamplesTable)
      .orderBy(desc(aiTradeSamplesTable.createdAt))
      .limit(limit);
  }

  async getAiSamplesCount(complete?: boolean): Promise<number> {
    if (complete !== undefined) {
      const result = await db.select({ count: sql<number>`count(*)` })
        .from(aiTradeSamplesTable)
        .where(eq(aiTradeSamplesTable.isComplete, complete));
      return Number(result[0]?.count || 0);
    }
    const result = await db.select({ count: sql<number>`count(*)` }).from(aiTradeSamplesTable);
    return Number(result[0]?.count || 0);
  }

  async saveAiShadowDecision(decision: InsertAiShadowDecision): Promise<AiShadowDecision> {
    const [newDecision] = await db.insert(aiShadowDecisionsTable).values(decision).returning();
    return newDecision;
  }

  async updateAiShadowFinalPnl(tradeId: string, pnl: string): Promise<void> {
    await db.update(aiShadowDecisionsTable)
      .set({ finalPnlNet: pnl })
      .where(eq(aiShadowDecisionsTable.tradeId, tradeId));
  }

  async getAiShadowReport(): Promise<{ total: number; blocked: number; blockedLosers: number; passedLosers: number }> {
    const allDecisions = await db.select().from(aiShadowDecisionsTable)
      .where(sql`${aiShadowDecisionsTable.finalPnlNet} IS NOT NULL`);
    
    const total = allDecisions.length;
    const blocked = allDecisions.filter(d => d.wouldBlock).length;
    const blockedLosers = allDecisions.filter(d => d.wouldBlock && parseFloat(d.finalPnlNet || '0') < 0).length;
    const passedLosers = allDecisions.filter(d => !d.wouldBlock && parseFloat(d.finalPnlNet || '0') < 0).length;
    
    return { total, blocked, blockedLosers, passedLosers };
  }

  async getAiConfig(): Promise<AiConfig | undefined> {
    const configs = await db.select().from(aiConfigTable).limit(1);
    if (configs.length === 0) {
      const [newConfig] = await db.insert(aiConfigTable).values({}).returning();
      return newConfig;
    }
    return configs[0];
  }

  async updateAiConfig(config: Partial<InsertAiConfig>): Promise<AiConfig> {
    const existing = await this.getAiConfig();
    if (!existing) {
      const [newConfig] = await db.insert(aiConfigTable).values(config as InsertAiConfig).returning();
      return newConfig;
    }
    const [updated] = await db.update(aiConfigTable)
      .set({ ...config, updatedAt: new Date() })
      .where(eq(aiConfigTable.id, existing.id))
      .returning();
    return updated;
  }

  async saveTrainingTrade(trade: InsertTrainingTrade): Promise<TrainingTrade> {
    const [newTrade] = await db.insert(trainingTradesTable).values(trade).returning();
    return newTrade;
  }

  async updateTrainingTrade(id: number, updates: Partial<InsertTrainingTrade>): Promise<TrainingTrade | undefined> {
    const [updated] = await db.update(trainingTradesTable)
      .set(updates)
      .where(eq(trainingTradesTable.id, id))
      .returning();
    return updated;
  }

  async getTrainingTradeByBuyTxid(buyTxid: string): Promise<TrainingTrade | undefined> {
    const trades = await db.select().from(trainingTradesTable)
      .where(eq(trainingTradesTable.buyTxid, buyTxid))
      .limit(1);
    return trades[0];
  }

  // Obtener duplicados por buyTxid para limpieza de training_trades
  async getDuplicateTrainingTradesByBuyTxid(): Promise<{ buyTxid: string; count: number; ids: number[] }[]> {
    const result = await db.execute(sql`
      SELECT buy_txid, COUNT(*) as count, ARRAY_AGG(id ORDER BY id) as ids
      FROM training_trades
      GROUP BY buy_txid
      HAVING COUNT(*) > 1
    `);
    return (result.rows as any[]).map(row => ({
      buyTxid: row.buy_txid,
      count: parseInt(row.count),
      ids: row.ids,
    }));
  }

  // Eliminar duplicados en training_trades manteniendo el m√°s antiguo
  async deleteDuplicateTrainingTrades(): Promise<number> {
    const duplicates = await this.getDuplicateTrainingTradesByBuyTxid();
    let deleted = 0;
    
    for (const dup of duplicates) {
      const idsToDelete = dup.ids.slice(1);
      for (const id of idsToDelete) {
        await db.delete(trainingTradesTable).where(eq(trainingTradesTable.id, id));
        deleted++;
      }
    }
    
    return deleted;
  }

  async getTrainingTrades(options?: { closed?: boolean; labeled?: boolean; limit?: number }): Promise<TrainingTrade[]> {
    const { closed, labeled, limit = 1000 } = options || {};
    const conditions: any[] = [];
    
    if (closed !== undefined) {
      conditions.push(eq(trainingTradesTable.isClosed, closed));
    }
    if (labeled !== undefined) {
      conditions.push(eq(trainingTradesTable.isLabeled, labeled));
    }
    
    const whereClause = conditions.length > 0 
      ? (conditions.length === 1 ? conditions[0] : and(...conditions)) 
      : undefined;
    
    const query = db.select().from(trainingTradesTable)
      .orderBy(desc(trainingTradesTable.entryTs))
      .limit(limit);
    
    return whereClause ? await query.where(whereClause) : await query;
  }

  async getTrainingTradesCount(options?: { closed?: boolean; labeled?: boolean; hasOpenLots?: boolean }): Promise<number> {
    const { closed, labeled, hasOpenLots } = options || {};
    const conditions: any[] = [];
    
    if (closed !== undefined) {
      conditions.push(eq(trainingTradesTable.isClosed, closed));
    }
    if (labeled !== undefined) {
      conditions.push(eq(trainingTradesTable.isLabeled, labeled));
    }
    if (hasOpenLots === true) {
      conditions.push(sql`${trainingTradesTable.qtyRemaining} > 0`);
    }
    
    const whereClause = conditions.length > 0 
      ? (conditions.length === 1 ? conditions[0] : and(...conditions)) 
      : undefined;
    
    const query = db.select({ count: sql<number>`count(*)` }).from(trainingTradesTable);
    const result = whereClause ? await query.where(whereClause) : await query;
    return Number(result[0]?.count || 0);
  }

  async getDiscardReasonsDataset(): Promise<Record<string, number>> {
    const result = await db.select({
      discardReason: trainingTradesTable.discardReason,
      count: sql<number>`count(*)`,
    })
    .from(trainingTradesTable)
    .where(sql`${trainingTradesTable.discardReason} IS NOT NULL`)
    .groupBy(trainingTradesTable.discardReason);
    
    const reasons: Record<string, number> = {};
    for (const row of result) {
      if (row.discardReason) {
        reasons[row.discardReason] = Number(row.count);
      }
    }
    return reasons;
  }

  async getAllTradesForBackfill(): Promise<Trade[]> {
    return await db.select().from(tradesTable)
      .where(eq(tradesTable.status, 'filled'))
      .orderBy(tradesTable.executedAt);
  }

  async runTrainingTradesBackfill(): Promise<{ created: number; closed: number; labeled: number; discardReasons: Record<string, number> }> {
    const allTrades = await this.getAllTradesForBackfill();
    const discardReasons: Record<string, number> = {};
    let created = 0;
    let closed = 0;
    let labeled = 0;
    
    const KRAKEN_FEE_RATE = 0.004;
    const PNL_OUTLIER_THRESHOLD = 100; // Increased from 50% - crypto is volatile
    const MAX_HOLD_TIME_DAYS = 30;
    const MIN_FEE_PCT = 0.1; // Lowered from 0.5% - discount tiers exist
    const MAX_FEE_PCT = 2.5; // Raised from 2.0% - allow for spread costs
    const QTY_EPSILON = 0.00000001;
    
    const tradesByPair: Record<string, Trade[]> = {};
    for (const trade of allTrades) {
      if (!tradesByPair[trade.pair]) tradesByPair[trade.pair] = [];
      tradesByPair[trade.pair].push(trade);
    }
    
    for (const pair of Object.keys(tradesByPair)) {
      // Ordenaci√≥n estable FIFO: timestamp + id (tie-breaker determinista)
      const pairTrades = tradesByPair[pair].sort((a, b) => {
        const timeA = a.executedAt ? new Date(a.executedAt).getTime() : 0;
        const timeB = b.executedAt ? new Date(b.executedAt).getTime() : 0;
        if (timeA !== timeB) return timeA - timeB;
        // Tie-breaker: ID de base de datos (determinista)
        return a.id - b.id;
      });
      
      interface OpenLot {
        dbId: number | null;
        buyTxid: string;
        entryPrice: number;
        entryAmount: number;
        qtyRemaining: number;
        entryTs: Date;
        costUsd: number;
        entryFee: number;
        sellTxids: string[];
        totalRevenue: number;
        totalExitFee: number;
        lastSellTs: Date | null;
        lastSellPrice: number;
      }
      
      const openLots: OpenLot[] = [];
      
      for (const trade of pairTrades) {
        const tradeTime = trade.executedAt ? new Date(trade.executedAt) : null;
        const tradeAmount = parseFloat(trade.amount || '0');
        const tradePrice = parseFloat(trade.price || '0');
        const tradeTxid = trade.krakenOrderId || trade.tradeId;
        
        if (!tradeTime) {
          discardReasons['sin_fecha_ejecucion'] = (discardReasons['sin_fecha_ejecucion'] || 0) + 1;
          continue;
        }
        
        if (tradeAmount <= 0 || tradePrice <= 0) {
          discardReasons['datos_invalidos'] = (discardReasons['datos_invalidos'] || 0) + 1;
          continue;
        }
        
        if (trade.type === 'buy') {
          const existing = await this.getTrainingTradeByBuyTxid(tradeTxid);
          if (existing) {
            const qtyRem = parseFloat(existing.qtyRemaining || existing.entryAmount || '0');
            
            // Si ya est√° cerrado y etiquetado/descartado, es inmutable - no reprocesar
            if (existing.isClosed && qtyRem <= QTY_EPSILON) {
              // Trade ya procesado completamente - skip sin modificar
              continue;
            }
            
            // Solo a√±adir a openLots si tiene cantidad restante para procesar
            if (qtyRem > QTY_EPSILON) {
              openLots.push({
                dbId: existing.id,
                buyTxid: tradeTxid,
                entryPrice: parseFloat(existing.entryPrice),
                entryAmount: parseFloat(existing.entryAmount),
                qtyRemaining: qtyRem,
                entryTs: new Date(existing.entryTs),
                costUsd: parseFloat(existing.costUsd),
                entryFee: parseFloat(existing.entryFee || '0'),
                sellTxids: (existing.sellTxidsJson as string[]) || [],
                totalRevenue: parseFloat(existing.revenueUsd || '0'),
                totalExitFee: parseFloat(existing.exitFee || '0'),
                lastSellTs: existing.exitTs ? new Date(existing.exitTs) : null,
                lastSellPrice: parseFloat(existing.exitPrice || '0'),
              });
            }
            continue;
          }
          
          const buyCost = tradeAmount * tradePrice;
          const entryFee = buyCost * KRAKEN_FEE_RATE;
          
          const trainingTrade: InsertTrainingTrade = {
            pair,
            buyTxid: tradeTxid,
            entryPrice: trade.price,
            entryAmount: trade.amount,
            qtyRemaining: trade.amount,
            costUsd: buyCost.toFixed(8),
            entryFee: entryFee.toFixed(8),
            entryTs: tradeTime,
            sellTxidsJson: [],
            isClosed: false,
            isLabeled: false,
          };
          
          const saved = await this.saveTrainingTrade(trainingTrade);
          created++;
          
          openLots.push({
            dbId: saved.id,
            buyTxid: tradeTxid,
            entryPrice: tradePrice,
            entryAmount: tradeAmount,
            qtyRemaining: tradeAmount,
            entryTs: tradeTime,
            costUsd: buyCost,
            entryFee,
            sellTxids: [],
            totalRevenue: 0,
            totalExitFee: 0,
            lastSellTs: null,
            lastSellPrice: 0,
          });
          
        } else if (trade.type === 'sell') {
          let remainingToSell = tradeAmount;
          const sellPrice = tradePrice;
          const sellTime = tradeTime;
          
          if (openLots.length === 0) {
            discardReasons['venta_sin_compra_previa'] = (discardReasons['venta_sin_compra_previa'] || 0) + 1;
            continue;
          }
          
          while (remainingToSell > QTY_EPSILON && openLots.length > 0) {
            const lot = openLots[0];
            const consumeQty = Math.min(remainingToSell, lot.qtyRemaining);
            const proportion = consumeQty / lot.entryAmount;
            const sellRevenue = consumeQty * sellPrice;
            const sellFee = sellRevenue * KRAKEN_FEE_RATE;
            
            lot.qtyRemaining -= consumeQty;
            remainingToSell -= consumeQty;
            lot.sellTxids.push(tradeTxid);
            lot.totalRevenue += sellRevenue;
            lot.totalExitFee += sellFee;
            lot.lastSellTs = sellTime;
            lot.lastSellPrice = sellPrice;
            
            if (lot.qtyRemaining <= QTY_EPSILON) {
              const pnlGross = lot.totalRevenue - lot.costUsd;
              const pnlNet = pnlGross - lot.entryFee - lot.totalExitFee;
              const pnlPct = (pnlNet / lot.costUsd) * 100;
              const holdTimeMinutes = Math.round((lot.lastSellTs!.getTime() - lot.entryTs.getTime()) / 60000);
              
              let discardReason: string | null = null;
              
              const totalFeePct = ((lot.entryFee + lot.totalExitFee) / lot.costUsd) * 100;
              if (totalFeePct > MAX_FEE_PCT || totalFeePct < MIN_FEE_PCT) {
                discardReason = 'comisiones_anormales';
              } else if (Math.abs(pnlPct) > PNL_OUTLIER_THRESHOLD) {
                discardReason = 'pnl_atipico';
              } else if (holdTimeMinutes / (60 * 24) > MAX_HOLD_TIME_DAYS) {
                discardReason = 'hold_excesivo';
              } else if (holdTimeMinutes < 0) {
                discardReason = 'timestamps_invalidos';
              }
              
              if (discardReason) {
                discardReasons[discardReason] = (discardReasons[discardReason] || 0) + 1;
              }
              
              const avgExitPrice = lot.totalRevenue / lot.entryAmount;
              
              await this.updateTrainingTrade(lot.dbId!, {
                sellTxid: lot.sellTxids[lot.sellTxids.length - 1],
                sellTxidsJson: lot.sellTxids,
                exitPrice: avgExitPrice.toFixed(8),
                exitAmount: lot.entryAmount.toFixed(8),
                qtyRemaining: '0',
                revenueUsd: lot.totalRevenue.toFixed(8),
                exitFee: lot.totalExitFee.toFixed(8),
                pnlGross: pnlGross.toFixed(8),
                pnlNet: pnlNet.toFixed(8),
                pnlPct: pnlPct.toFixed(4),
                holdTimeMinutes,
                labelWin: discardReason ? undefined : (pnlNet > 0 ? 1 : 0),
                exitTs: lot.lastSellTs!,
                isClosed: true,
                isLabeled: discardReason ? false : true,
                discardReason: discardReason || undefined,
              });
              
              closed++;
              if (!discardReason) labeled++;
              
              openLots.shift();
            } else {
              await this.updateTrainingTrade(lot.dbId!, {
                qtyRemaining: lot.qtyRemaining.toFixed(8),
                sellTxidsJson: lot.sellTxids,
              });
            }
          }
          
          if (remainingToSell > QTY_EPSILON) {
            discardReasons['venta_excede_lotes'] = (discardReasons['venta_excede_lotes'] || 0) + 1;
          }
        }
      }
      
      for (const lot of openLots) {
        if (lot.qtyRemaining > QTY_EPSILON && lot.qtyRemaining < lot.entryAmount) {
          await this.updateTrainingTrade(lot.dbId!, {
            qtyRemaining: lot.qtyRemaining.toFixed(8),
            sellTxidsJson: lot.sellTxids,
          });
        }
      }
    }
    
    // Invariance check: if qtyRemaining <= epsilon then normalize to 0 and ensure isClosed=true
    const allTrainingTrades = await db.select().from(trainingTradesTable);
    for (const trade of allTrainingTrades) {
      const qty = parseFloat(trade.qtyRemaining || trade.entryAmount || '0');
      if (qty <= QTY_EPSILON && qty > 0) {
        // Normalize tiny residuals to exactly 0
        await this.updateTrainingTrade(trade.id, { qtyRemaining: '0', isClosed: true });
      } else if (qty <= QTY_EPSILON && !trade.isClosed) {
        // qty is already 0 but isClosed is false - fix invariance
        await this.updateTrainingTrade(trade.id, { isClosed: true });
      }
    }
    
    return { created, closed, labeled, discardReasons };
  }

  async checkSchemaHealth(): Promise<{ healthy: boolean; missingColumns: string[]; migrationRan: boolean }> {
    const missingColumns: string[] = [];
    
    // Check required columns in bot_config table
    const requiredBotConfigColumns = [
      { column: 'sg_max_open_lots_per_pair', table: 'bot_config' },
      { column: 'sg_pair_overrides', table: 'bot_config' },
      { column: 'dry_run_mode', table: 'bot_config' },
      { column: 'sg_min_entry_usd', table: 'bot_config' },
      { column: 'sg_allow_under_min', table: 'bot_config' },
      { column: 'sg_be_at_pct', table: 'bot_config' },
      { column: 'sg_trail_start_pct', table: 'bot_config' },
      { column: 'sg_trail_distance_pct', table: 'bot_config' },
      { column: 'sg_trail_step_pct', table: 'bot_config' },
      { column: 'sg_tp_fixed_enabled', table: 'bot_config' },
      { column: 'sg_tp_fixed_pct', table: 'bot_config' },
      { column: 'sg_scale_out_enabled', table: 'bot_config' },
      { column: 'sg_scale_out_pct', table: 'bot_config' },
      { column: 'sg_min_part_usd', table: 'bot_config' },
      { column: 'sg_scale_out_threshold', table: 'bot_config' },
      { column: 'sg_fee_cushion_pct', table: 'bot_config' },
      { column: 'sg_fee_cushion_auto', table: 'bot_config' },
    ];
    
    const requiredOpenPositionsColumns = [
      { column: 'lot_id', table: 'open_positions' },
      { column: 'sg_break_even_activated', table: 'open_positions' },
      { column: 'sg_trailing_activated', table: 'open_positions' },
      { column: 'sg_current_stop_price', table: 'open_positions' },
      { column: 'sg_scale_out_done', table: 'open_positions' },
      { column: 'config_snapshot_json', table: 'open_positions' },
    ];
    
    const allRequiredColumns = [...requiredBotConfigColumns, ...requiredOpenPositionsColumns];
    
    // Health check ONLY reports status - does NOT auto-migrate
    // Migration should be run by script/migrate.ts (Docker startup) or manually
    // This ensures the migration flow has a single source of truth
    for (const { column, table } of allRequiredColumns) {
      const result = await db.execute(sql`
        SELECT column_name FROM information_schema.columns 
        WHERE table_name = ${table} AND column_name = ${column}
      `);
      if (result.rows.length === 0) {
        missingColumns.push(`${table}.${column}`);
      }
    }
    
    if (missingColumns.length > 0) {
      console.warn(`[schema] Health check: missing columns detected: ${missingColumns.join(', ')}`);
      console.warn('[schema] Run "npx tsx script/migrate.ts" to fix schema issues');
    }
    
    return { healthy: missingColumns.length === 0, missingColumns, migrationRan: false };
  }

  async runSchemaMigration(): Promise<{ success: boolean; columnsAdded: string[]; error?: string }> {
    const columnsAdded: string[] = [];
    
    try {
      // Define all migrations with safe ADD COLUMN IF NOT EXISTS
      const migrations = [
        // bot_config columns
        { table: 'bot_config', column: 'sg_max_open_lots_per_pair', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_max_open_lots_per_pair INTEGER DEFAULT 1' },
        { table: 'bot_config', column: 'sg_pair_overrides', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_pair_overrides JSONB' },
        { table: 'bot_config', column: 'dry_run_mode', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS dry_run_mode BOOLEAN DEFAULT false' },
        { table: 'bot_config', column: 'sg_min_entry_usd', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_entry_usd DECIMAL(10,2) DEFAULT 100.00' },
        { table: 'bot_config', column: 'sg_allow_under_min', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_allow_under_min BOOLEAN DEFAULT true' },
        { table: 'bot_config', column: 'sg_be_at_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_be_at_pct DECIMAL(5,2) DEFAULT 1.50' },
        { table: 'bot_config', column: 'sg_trail_start_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_start_pct DECIMAL(5,2) DEFAULT 2.00' },
        { table: 'bot_config', column: 'sg_trail_distance_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_distance_pct DECIMAL(5,2) DEFAULT 1.50' },
        { table: 'bot_config', column: 'sg_trail_step_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_step_pct DECIMAL(5,2) DEFAULT 0.25' },
        { table: 'bot_config', column: 'sg_tp_fixed_enabled', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_enabled BOOLEAN DEFAULT false' },
        { table: 'bot_config', column: 'sg_tp_fixed_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_pct DECIMAL(5,2) DEFAULT 10.00' },
        { table: 'bot_config', column: 'sg_scale_out_enabled', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_enabled BOOLEAN DEFAULT false' },
        { table: 'bot_config', column: 'sg_scale_out_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_pct DECIMAL(5,2) DEFAULT 35.00' },
        { table: 'bot_config', column: 'sg_min_part_usd', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_part_usd DECIMAL(10,2) DEFAULT 50.00' },
        { table: 'bot_config', column: 'sg_scale_out_threshold', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_threshold DECIMAL(5,2) DEFAULT 80.00' },
        { table: 'bot_config', column: 'sg_fee_cushion_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_pct DECIMAL(5,2) DEFAULT 0.45' },
        { table: 'bot_config', column: 'sg_fee_cushion_auto', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_auto BOOLEAN DEFAULT true' },
        
        // open_positions columns
        { table: 'open_positions', column: 'lot_id', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS lot_id TEXT' },
        { table: 'open_positions', column: 'sg_break_even_activated', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_break_even_activated BOOLEAN DEFAULT false' },
        { table: 'open_positions', column: 'sg_trailing_activated', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_trailing_activated BOOLEAN DEFAULT false' },
        { table: 'open_positions', column: 'sg_current_stop_price', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_current_stop_price DECIMAL(18,8)' },
        { table: 'open_positions', column: 'sg_scale_out_done', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_scale_out_done BOOLEAN DEFAULT false' },
        { table: 'open_positions', column: 'config_snapshot_json', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS config_snapshot_json JSONB' },
      ];
      
      for (const migration of migrations) {
        try {
          await db.execute(sql.raw(migration.sql));
          columnsAdded.push(`${migration.table}.${migration.column}`);
        } catch (e) {
          // Column may already exist, continue
        }
      }
      
      // Backfill lot_id for existing positions without it
      try {
        await db.execute(sql`
          UPDATE open_positions 
          SET lot_id = 'LEGACY-' || id::text || '-' || SUBSTRING(MD5(pair || opened_at::text) FROM 1 FOR 6)
          WHERE lot_id IS NULL
        `);
        
        // Add unique constraint if not exists (safe: only if all lot_ids are unique)
        const duplicates = await db.execute(sql`
          SELECT lot_id, COUNT(*) FROM open_positions WHERE lot_id IS NOT NULL GROUP BY lot_id HAVING COUNT(*) > 1
        `);
        if (duplicates.rows.length === 0) {
          try {
            await db.execute(sql`
              ALTER TABLE open_positions ADD CONSTRAINT open_positions_lot_id_unique UNIQUE (lot_id)
            `);
          } catch (e) {
            // Constraint may already exist
          }
        }
      } catch (e) {
        console.log('[schema] lot_id backfill note:', e);
      }
      
      console.log(`[schema] Migration completed. Columns added: ${columnsAdded.join(', ') || 'none (all exist)'}`);
      return { success: true, columnsAdded };
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      console.error('[schema] Migration failed:', errorMessage);
      return { success: false, columnsAdded, error: errorMessage };
    }
  }
}

export const storage = new DatabaseStorage();


===== FILE: ./server/tests/smartguard-sizing-test.ts =====
/**
 * SMART_GUARD Sizing Test Script
 * 
 * Tests the following cases:
 * - Case A: balance=199, sgMinEntryUsd=100, allowUnderMin=true ‚Üí compra m√≠nima = 100
 * - Case B: balance=70, allowUnderMin=true ‚Üí compra = ~70 (>=20)
 * - Case C: balance=70, allowUnderMin=false ‚Üí bloqueo MIN_ORDER_USD
 * - Case D: maxTotalExposure alcanzada ‚Üí bloqueo EXPOSURE_ZERO
 * 
 * Run with: npx tsx server/tests/smartguard-sizing-test.ts
 */

const SG_ABSOLUTE_MIN_USD = 20;

interface MinimumValidationParams {
  positionMode: string;
  orderUsdFinal: number;
  orderUsdProposed: number;
  usdDisponible: number;
  exposureAvailable: number;
  pair: string;
  sgMinEntryUsd?: number;
  sgAllowUnderMin?: boolean;
  dryRun?: boolean;
  env?: string;
}

interface MinimumValidationResult {
  valid: boolean;
  skipReason?: "MIN_ORDER_ABSOLUTE" | "MIN_ORDER_USD";
  message?: string;
}

function validateMinimumsOrSkip(params: MinimumValidationParams): MinimumValidationResult {
  const {
    positionMode,
    orderUsdFinal,
    sgMinEntryUsd = 100,
    sgAllowUnderMin = true,
  } = params;

  if (orderUsdFinal < SG_ABSOLUTE_MIN_USD) {
    return {
      valid: false,
      skipReason: "MIN_ORDER_ABSOLUTE",
      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < m√≠nimo absoluto $${SG_ABSOLUTE_MIN_USD}`,
    };
  }

  if (positionMode === "SMART_GUARD" && !sgAllowUnderMin && orderUsdFinal < sgMinEntryUsd) {
    return {
      valid: false,
      skipReason: "MIN_ORDER_USD",
      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < sgMinEntryUsd $${sgMinEntryUsd.toFixed(2)} (sgAllowUnderMin=OFF)`,
    };
  }

  return { valid: true };
}

interface TestCase {
  name: string;
  balance: number;
  sgMinEntryUsd: number;
  sgAllowUnderMin: boolean;
  riskPerTradePct: number;
  maxTradeUSD: number;
  currentTotalExposure: number;
  maxTotalExposurePct: number;
  expectedOutcome: "TRADE" | "MIN_ORDER_ABSOLUTE" | "MIN_ORDER_USD" | "EXPOSURE_ZERO";
  expectedOrderUsdFinal?: number;
}

function calculateSmartGuardSizing(
  balance: number,
  sgMinEntryUsd: number,
  sgAllowUnderMin: boolean,
  riskPerTradePct: number,
  maxTradeUSD: number,
  currentTotalExposure: number,
  maxTotalExposurePct: number
): { orderUsdFinal: number; skipReason?: string; message?: string } {
  const usdDisponible = balance * 0.95;
  
  const riskBasedAmount = balance * (riskPerTradePct / 100);
  const maxByRisk = Math.min(riskBasedAmount, maxTradeUSD);
  const orderUsdProposed = Math.min(maxByRisk, usdDisponible);
  
  let tradeAmountUSD: number;
  
  if (usdDisponible >= sgMinEntryUsd) {
    tradeAmountUSD = Math.max(orderUsdProposed, sgMinEntryUsd);
    tradeAmountUSD = Math.min(tradeAmountUSD, usdDisponible, maxTradeUSD);
  } else if (sgAllowUnderMin) {
    tradeAmountUSD = usdDisponible;
  } else {
    tradeAmountUSD = usdDisponible;
  }
  
  const maxTotalExposureUsd = balance * (maxTotalExposurePct / 100);
  const maxTotalAvailable = Math.max(0, maxTotalExposureUsd - currentTotalExposure);
  const maxByBalance = balance * 0.95;
  const effectiveMaxAllowed = Math.min(maxTotalAvailable, maxByBalance);
  
  const minVolume = 0.00005;
  const currentPrice = 90000;
  const minRequiredUSD = minVolume * currentPrice;
  
  if (effectiveMaxAllowed < minRequiredUSD) {
    return {
      orderUsdFinal: 0,
      skipReason: "EXPOSURE_ZERO",
      message: `Sin exposici√≥n disponible. effectiveMaxAllowed=$${effectiveMaxAllowed.toFixed(2)} < minRequired=$${minRequiredUSD.toFixed(2)}`,
    };
  }
  
  const orderUsdFinal = tradeAmountUSD;
  
  const validation = validateMinimumsOrSkip({
    positionMode: "SMART_GUARD",
    orderUsdFinal,
    orderUsdProposed,
    usdDisponible,
    exposureAvailable: effectiveMaxAllowed,
    pair: "BTC/USD",
    sgMinEntryUsd,
    sgAllowUnderMin,
  });
  
  if (!validation.valid) {
    return {
      orderUsdFinal,
      skipReason: validation.skipReason,
      message: validation.message,
    };
  }
  
  return { orderUsdFinal };
}

const testCases: TestCase[] = [
  {
    name: "Case A: balance=199, sgMinEntryUsd=100, allowUnderMin=true",
    balance: 199,
    sgMinEntryUsd: 100,
    sgAllowUnderMin: true,
    riskPerTradePct: 15,
    maxTradeUSD: 100,
    currentTotalExposure: 0,
    maxTotalExposurePct: 60,
    expectedOutcome: "TRADE",
    expectedOrderUsdFinal: 100,
  },
  {
    name: "Case B: balance=70, allowUnderMin=true ‚Üí compra ~66.5 (>=20)",
    balance: 70,
    sgMinEntryUsd: 100,
    sgAllowUnderMin: true,
    riskPerTradePct: 15,
    maxTradeUSD: 100,
    currentTotalExposure: 0,
    maxTotalExposurePct: 60,
    expectedOutcome: "TRADE",
    expectedOrderUsdFinal: 66.5,
  },
  {
    name: "Case C: balance=70, allowUnderMin=false ‚Üí bloqueo MIN_ORDER_USD",
    balance: 70,
    sgMinEntryUsd: 100,
    sgAllowUnderMin: false,
    riskPerTradePct: 15,
    maxTradeUSD: 100,
    currentTotalExposure: 0,
    maxTotalExposurePct: 60,
    expectedOutcome: "MIN_ORDER_USD",
  },
  {
    name: "Case D: maxTotalExposure alcanzada ‚Üí bloqueo EXPOSURE_ZERO",
    balance: 199,
    sgMinEntryUsd: 100,
    sgAllowUnderMin: true,
    riskPerTradePct: 15,
    maxTradeUSD: 100,
    currentTotalExposure: 120,
    maxTotalExposurePct: 60,
    expectedOutcome: "EXPOSURE_ZERO",
  },
  {
    name: "Case E: balance=15 (bajo absoluto) ‚Üí bloqueo MIN_ORDER_ABSOLUTE",
    balance: 15,
    sgMinEntryUsd: 100,
    sgAllowUnderMin: true,
    riskPerTradePct: 15,
    maxTradeUSD: 100,
    currentTotalExposure: 0,
    maxTotalExposurePct: 60,
    expectedOutcome: "MIN_ORDER_ABSOLUTE",
  },
];

console.log("=".repeat(80));
console.log("SMART_GUARD SIZING TEST SCRIPT");
console.log("=".repeat(80));
console.log("");

let passed = 0;
let failed = 0;

for (const tc of testCases) {
  const result = calculateSmartGuardSizing(
    tc.balance,
    tc.sgMinEntryUsd,
    tc.sgAllowUnderMin,
    tc.riskPerTradePct,
    tc.maxTradeUSD,
    tc.currentTotalExposure,
    tc.maxTotalExposurePct
  );
  
  const actualOutcome = result.skipReason || "TRADE";
  const isOutcomeCorrect = actualOutcome === tc.expectedOutcome;
  const isAmountCorrect = tc.expectedOrderUsdFinal === undefined || 
    Math.abs(result.orderUsdFinal - tc.expectedOrderUsdFinal) < 0.1;
  
  const testPassed = isOutcomeCorrect && isAmountCorrect;
  
  console.log(`TEST: ${tc.name}`);
  console.log(`  Input: balance=$${tc.balance}, sgMinEntryUsd=$${tc.sgMinEntryUsd}, allowUnderMin=${tc.sgAllowUnderMin}`);
  console.log(`  Input: riskPct=${tc.riskPerTradePct}%, maxTrade=$${tc.maxTradeUSD}, currentExposure=$${tc.currentTotalExposure}, maxExposurePct=${tc.maxTotalExposurePct}%`);
  console.log(`  Expected: outcome=${tc.expectedOutcome}${tc.expectedOrderUsdFinal ? `, orderUsdFinal=$${tc.expectedOrderUsdFinal}` : ""}`);
  console.log(`  Actual: outcome=${actualOutcome}, orderUsdFinal=$${result.orderUsdFinal.toFixed(2)}${result.message ? ` (${result.message})` : ""}`);
  console.log(`  Result: ${testPassed ? "‚úÖ PASSED" : "‚ùå FAILED"}`);
  console.log("");
  
  if (testPassed) passed++;
  else failed++;
}

console.log("=".repeat(80));
console.log(`SUMMARY: ${passed} passed, ${failed} failed`);
console.log("=".repeat(80));

process.exit(failed > 0 ? 1 : 0);


===== FILE: ./server/index.ts =====
import express, { type Request, Response, NextFunction } from "express";
import { registerRoutes, initializeWebSockets } from "./routes";
import { serveStatic } from "./static";
import { createServer } from "http";

const app = express();
const httpServer = createServer(app);

initializeWebSockets(httpServer);

declare module "http" {
  interface IncomingMessage {
    rawBody: unknown;
  }
}

app.use(
  express.json({
    verify: (req, _res, buf) => {
      req.rawBody = buf;
    },
  }),
);

app.use(express.urlencoded({ extended: false }));

export function log(message: string, source = "express") {
  const formattedTime = new Date().toLocaleTimeString("en-US", {
    hour: "numeric",
    minute: "2-digit",
    second: "2-digit",
    hour12: true,
  });

  console.log(`${formattedTime} [${source}] ${message}`);
}

app.use((req, res, next) => {
  const start = Date.now();
  const path = req.path;
  let capturedJsonResponse: Record<string, any> | undefined = undefined;

  const originalResJson = res.json;
  res.json = function (bodyJson, ...args) {
    capturedJsonResponse = bodyJson;
    return originalResJson.apply(res, [bodyJson, ...args]);
  };

  res.on("finish", () => {
    const duration = Date.now() - start;
    if (path.startsWith("/api")) {
      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;
      if (capturedJsonResponse) {
        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;
      }

      log(logLine);
    }
  });

  next();
});

(async () => {
  await registerRoutes(httpServer, app);

  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {
    const status = err.status || err.statusCode || 500;
    const message = err.message || "Internal Server Error";

    res.status(status).json({ message });
    throw err;
  });

  // importantly only setup vite in development and after
  // setting up all the other routes so the catch-all route
  // doesn't interfere with the other routes
  if (process.env.NODE_ENV === "production") {
    serveStatic(app);
  } else {
    const { setupVite } = await import("./vite");
    await setupVite(httpServer, app);
  }

  // ALWAYS serve the app on the port specified in the environment variable PORT
  // Other ports are firewalled. Default to 5000 if not specified.
  // this serves both the API and the client.
  // It is the only port that is not firewalled.
  const port = parseInt(process.env.PORT || "5000", 10);
  httpServer.listen(
    {
      port,
      host: "0.0.0.0",
      reusePort: true,
    },
    () => {
      log(`serving on port ${port}`);
    },
  );
})();


===== FILE: ./server/db.ts =====
import { drizzle } from "drizzle-orm/node-postgres";
import pg from "pg";
import * as schema from "@shared/schema";

const { Pool } = pg;

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL environment variable is not set");
}

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

export const db = drizzle(pool, { schema });


===== FILE: ./server/services/tradingEngine.ts =====
import { KrakenService } from "./kraken";
import { TelegramService } from "./telegram";
import { botLogger } from "./botLogger";
import { storage } from "../storage";
import { log } from "../index";
import { aiService, AiFeatures } from "./aiService";
import { environment } from "./environment";
import { fifoMatcher } from "./fifoMatcher";

interface PriceData {
  price: number;
  timestamp: number;
  high: number;
  low: number;
  volume: number;
}

interface TradeSignal {
  action: "buy" | "sell" | "hold";
  pair: string;
  confidence: number;
  reason: string;
}

interface RiskConfig {
  maxTradeUSD: number;
}

const RISK_LEVELS: Record<string, RiskConfig> = {
  low: {
    maxTradeUSD: 20,
  },
  medium: {
    maxTradeUSD: 50,
  },
  high: {
    maxTradeUSD: 100,
  },
};

const DUST_THRESHOLD_USD = 5; // Minimum USD value to attempt selling

const SMALL_ACCOUNT_FACTOR = 0.95;

// Kraken fee structure (taker fees for market orders)
const KRAKEN_FEE_PCT = 0.26; // 0.26% per trade
const ROUND_TRIP_FEE_PCT = KRAKEN_FEE_PCT * 2; // ~0.52% for buy + sell
const MIN_PROFIT_MULTIPLIER = 2; // Take-profit debe ser al menos 2x las fees

// Defensive improvements
const MAX_SPREAD_PCT = 0.5; // No comprar si spread > 0.5%
const TRADING_HOURS_START = 8; // UTC - inicio de horario de trading
const TRADING_HOURS_END = 22; // UTC - fin de horario de trading
const POST_STOPLOSS_COOLDOWN_MS = 30 * 60 * 1000; // 30 min cooldown tras stop-loss
const CONFIDENCE_SIZING_THRESHOLDS = {
  high: { min: 0.8, factor: 1.0 },    // 100% del monto
  medium: { min: 0.7, factor: 0.75 }, // 75% del monto
  low: { min: 0.6, factor: 0.5 },     // 50% del monto
};

// SMART_GUARD: umbral absoluto m√≠nimo para evitar comisiones absurdas
const SG_ABSOLUTE_MIN_USD = 20;

// === VALIDACI√ìN CENTRALIZADA DE M√çNIMOS (fuente √∫nica de verdad) ===
// Reason codes para SMART_GUARD sizing
type SmartGuardReasonCode = 
  | "SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN"   // saldo < floorUsd (hard block)
  | "SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION"    // availableAfterCushion < floorUsd
  | "SMART_GUARD_ENTRY_USING_CONFIG_MIN"       // saldo >= sgMinEntryUsd, usando sgMinEntryUsd
  | "SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE"; // saldo < sgMinEntryUsd, usando saldo disponible

interface MinimumValidationParams {
  positionMode: string;
  orderUsdFinal: number;
  orderUsdProposed: number;
  usdDisponible: number;
  exposureAvailable: number;
  pair: string;
  sgMinEntryUsd?: number;
  sgAllowUnderMin?: boolean; // DEPRECATED - se ignora (siempre auto fallback)
  dryRun?: boolean;
  env?: string;
  floorUsd?: number;
  availableAfterCushion?: number;
}

interface MinimumValidationResult {
  valid: boolean;
  skipReason?: SmartGuardReasonCode | "MIN_ORDER_ABSOLUTE" | "MIN_ORDER_USD";
  reasonCode?: SmartGuardReasonCode;
  message?: string;
  meta?: Record<string, any>;
}

function validateMinimumsOrSkip(params: MinimumValidationParams): MinimumValidationResult {
  const {
    positionMode,
    orderUsdFinal,
    orderUsdProposed,
    usdDisponible,
    exposureAvailable,
    pair,
    sgMinEntryUsd = 100,
    sgAllowUnderMin = true, // DEPRECATED - ignorado
    dryRun = false,
    env = "UNKNOWN",
    floorUsd,
    availableAfterCushion,
  } = params;

  const effectiveFloor = floorUsd ?? SG_ABSOLUTE_MIN_USD;

  const meta = {
    pair,
    usdDisponible,
    orderUsdProposed,
    orderUsdFinal,
    sgMinEntryUsd,
    sgAllowUnderMin_DEPRECATED: sgAllowUnderMin,
    exposureAvailable,
    env,
    dryRun,
    absoluteMinUsd: SG_ABSOLUTE_MIN_USD,
    floorUsd: effectiveFloor,
    availableAfterCushion,
  };

  // REGLA 1: Hard block - si orderUsdFinal < floorUsd (exchange min + absoluto)
  if (orderUsdFinal < effectiveFloor) {
    return {
      valid: false,
      skipReason: "SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN",
      reasonCode: "SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN",
      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < floorUsd $${effectiveFloor.toFixed(2)} (m√≠n exchange + absoluto)`,
      meta,
    };
  }

  // REGLA 2: Hard block - si availableAfterCushion < floorUsd (fee cushion applied)
  if (availableAfterCushion !== undefined && availableAfterCushion < effectiveFloor) {
    return {
      valid: false,
      skipReason: "SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION",
      reasonCode: "SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION",
      message: `Trade bloqueado: availableAfterCushion $${availableAfterCushion.toFixed(2)} < floorUsd $${effectiveFloor.toFixed(2)}`,
      meta,
    };
  }

  // Fallback para modos no-SMART_GUARD
  if (orderUsdFinal < SG_ABSOLUTE_MIN_USD) {
    return {
      valid: false,
      skipReason: "MIN_ORDER_ABSOLUTE",
      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < m√≠nimo absoluto $${SG_ABSOLUTE_MIN_USD}`,
      meta,
    };
  }

  return { valid: true };
}

interface ConfigSnapshot {
  stopLossPercent: number;
  takeProfitPercent: number;
  trailingStopEnabled: boolean;
  trailingStopPercent: number;
  positionMode: string;
  // SMART_GUARD specific fields (only populated when positionMode === "SMART_GUARD")
  sgMinEntryUsd?: number;
  sgAllowUnderMin?: boolean;
  sgBeAtPct?: number;
  sgFeeCushionPct?: number;
  sgFeeCushionAuto?: boolean;
  sgTrailStartPct?: number;
  sgTrailDistancePct?: number;
  sgTrailStepPct?: number;
  sgTpFixedEnabled?: boolean;
  sgTpFixedPct?: number;
  sgScaleOutEnabled?: boolean;
  sgScaleOutPct?: number;
  sgMinPartUsd?: number;
  sgScaleOutThreshold?: number;
}

interface OpenPosition {
  lotId: string; // Unique identifier for this lot (multi-lot support)
  pair: string; // Pair for this position
  amount: number;
  entryPrice: number;
  highestPrice: number;
  openedAt: number;
  entryStrategyId: string;
  entrySignalTf: string;
  signalConfidence?: number;
  signalReason?: string;
  aiSampleId?: number;
  entryMode?: string;
  configSnapshot?: ConfigSnapshot;
  // SMART_GUARD dynamic state
  sgBreakEvenActivated?: boolean;
  sgCurrentStopPrice?: number;
  sgTrailingActivated?: boolean;
  sgScaleOutDone?: boolean;
}

function generateLotId(pair: string): string {
  const timestamp = Date.now();
  const random = Math.random().toString(36).substring(2, 8);
  return `LOT-${pair.replace("/", "")}-${timestamp}-${random}`;
}

interface CandleTrackingState {
  lastEvaluatedCandleTs: number;
  lastEvaluatedPair: string;
}

interface OHLCCandle {
  time: number;
  open: number;
  high: number;
  low: number;
  close: number;
  volume: number;
}

interface MultiTimeframeData {
  tf5m: OHLCCandle[];
  tf1h: OHLCCandle[];
  tf4h: OHLCCandle[];
  lastUpdate: number;
}

interface TrendAnalysis {
  shortTerm: "bullish" | "bearish" | "neutral";
  mediumTerm: "bullish" | "bearish" | "neutral";
  longTerm: "bullish" | "bearish" | "neutral";
  alignment: number;
  confidence: number;
  summary: string;
}

export class TradingEngine {
  private krakenService: KrakenService;
  private telegramService: TelegramService;
  private isRunning: boolean = false;
  private intervalId: NodeJS.Timeout | null = null;
  private priceHistory: Map<string, PriceData[]> = new Map();
  private lastTradeTime: Map<string, number> = new Map();
  private openPositions: Map<string, OpenPosition> = new Map(); // Key is lotId for multi-lot support
  private currentUsdBalance: number = 0;
  private mtfCache: Map<string, MultiTimeframeData> = new Map();
  private readonly PRICE_HISTORY_LENGTH = 50;
  private readonly MIN_TRADE_INTERVAL_MS = 60000;
  private readonly MTF_CACHE_TTL = 300000;
  
  private dailyPnL: number = 0;
  private dailyStartBalance: number = 0;
  private lastDayReset: string = "";
  private isDailyLimitReached: boolean = false;
  
  private pairCooldowns: Map<string, number> = new Map();
  private lastExposureAlert: Map<string, number> = new Map();
  private stopLossCooldowns: Map<string, number> = new Map();
  private spreadFilterEnabled: boolean = true;
  private readonly COOLDOWN_DURATION_MS = 15 * 60 * 1000;
  private readonly EXPOSURE_ALERT_INTERVAL_MS = 30 * 60 * 1000;
  
  // Tracking para Momentum (Velas) - √∫ltima vela evaluada por par+timeframe
  private lastEvaluatedCandle: Map<string, number> = new Map();
  
  // Fallback minimums (only used if Kraken API fails)
  private readonly FALLBACK_MINIMUMS: Record<string, number> = {
    "BTC/USD": 0.0001,
    "ETH/USD": 0.01,
    "SOL/USD": 0.02,
    "XRP/USD": 1.65,
    "TON/USD": 1,
    "ETH/BTC": 0.01,
  };

  private normalizeVolume(pair: string, volume: number): number {
    const stepSize = this.krakenService.getStepSize(pair);
    if (stepSize === null) {
      log(`[WARNING] No step size for ${pair}, using 8 decimal fallback`, "trading");
      const fallbackDecimals = 8;
      return Math.floor(volume * Math.pow(10, fallbackDecimals)) / Math.pow(10, fallbackDecimals);
    }
    const decimals = Math.abs(Math.log10(stepSize));
    return Math.floor(volume * Math.pow(10, decimals)) / Math.pow(10, decimals);
  }

  private getOrderMin(pair: string): number {
    const orderMin = this.krakenService.getOrderMin(pair);
    if (orderMin === null) {
      log(`[WARNING] No orderMin for ${pair}, using fallback`, "trading");
      return this.FALLBACK_MINIMUMS[pair] || 0.01;
    }
    return orderMin;
  }

  private hasPairMetadata(pair: string): boolean {
    return this.krakenService.hasMetadata(pair);
  }
  
  // Timeframe en segundos para calcular cierre de vela
  private readonly TIMEFRAME_SECONDS: Record<string, number> = {
    "5m": 5 * 60,
    "15m": 15 * 60,
    "1h": 60 * 60,
  };

  // Engine tick tracking (heartbeat cada 60s)
  private tickIntervalId: NodeJS.Timeout | null = null;
  private lastTickTime: number = 0;
  private lastScanTime: number = 0;
  private readonly TICK_INTERVAL_MS = 60 * 1000; // 60 seconds
  private lastScanResults: Map<string, { signal: string; reason: string; cooldownSec?: number; exposureAvailable?: number }> = new Map();
  
  // SMART_GUARD alert throttle: key = "lotId:eventType", value = timestamp
  private sgAlertThrottle: Map<string, number> = new Map();
  private readonly SG_TRAIL_UPDATE_THROTTLE_MS = 5 * 60 * 1000; // 5 minutes between trailing stop updates
  
  // DRY_RUN mode: audit without sending real orders
  private dryRunMode: boolean = false;
  private readonly isReplitEnvironment: boolean = !!process.env.REPLIT_DEPLOYMENT || !!process.env.REPL_ID;

  constructor(krakenService: KrakenService, telegramService: TelegramService) {
    this.krakenService = krakenService;
    this.telegramService = telegramService;
    
    // Auto-enable dry run on Replit to prevent accidental real trades
    if (this.isReplitEnvironment) {
      this.dryRunMode = true;
      log("[SAFETY] Entorno Replit detectado - DRY_RUN activado autom√°ticamente", "trading");
    }
  }

  // === MULTI-LOT HELPERS ===
  private getPositionsByPair(pair: string): OpenPosition[] {
    const positions: OpenPosition[] = [];
    this.openPositions.forEach((position) => {
      if (position.pair === pair) {
        positions.push(position);
      }
    });
    return positions;
  }

  private getFirstPositionByPair(pair: string): OpenPosition | undefined {
    for (const position of this.openPositions.values()) {
      if (position.pair === pair) {
        return position;
      }
    }
    return undefined;
  }

  private countLotsForPair(pair: string): number {
    let count = 0;
    this.openPositions.forEach((position) => {
      if (position.pair === pair) {
        count++;
      }
    });
    return count;
  }

  // === SMART_GUARD ALERT HELPERS ===
  private shouldSendSgAlert(lotId: string, eventType: string, throttleMs?: number): boolean {
    const key = `${lotId}:${eventType}`;
    const lastAlert = this.sgAlertThrottle.get(key);
    const now = Date.now();
    const cooldown = throttleMs ?? 0;
    
    if (lastAlert && now - lastAlert < cooldown) {
      return false;
    }
    this.sgAlertThrottle.set(key, now);
    return true;
  }

  private async sendSgEventAlert(
    eventType: "SG_BREAK_EVEN_ACTIVATED" | "SG_TRAILING_ACTIVATED" | "SG_TRAILING_STOP_UPDATED" | "SG_SCALE_OUT_EXECUTED",
    position: OpenPosition,
    currentPrice: number,
    extra: { stopPrice?: number; profitPct: number; reason: string }
  ) {
    const { lotId, pair, entryPrice } = position;
    const shortLotId = lotId.substring(0, 12);
    const envPrefix = environment.getMessagePrefix(this.dryRunMode);
    const envInfo = environment.getInfo();

    // Emit event for /api/events
    await botLogger.info(eventType, `${eventType} en ${pair}`, {
      pair,
      lotId,
      entryPrice,
      currentPrice,
      stopPrice: extra.stopPrice,
      profitPct: extra.profitPct,
      env: envInfo.env,
      instanceId: envInfo.instanceId,
      reason: extra.reason,
    });

    // Send Telegram notification
    if (this.telegramService.isInitialized()) {
      let emoji = "";
      let title = "";
      
      switch (eventType) {
        case "SG_BREAK_EVEN_ACTIVATED":
          emoji = "‚öñÔ∏è";
          title = "Break-Even Activado";
          break;
        case "SG_TRAILING_ACTIVATED":
          emoji = "üìà";
          title = "Trailing Stop Activado";
          break;
        case "SG_TRAILING_STOP_UPDATED":
          emoji = "üîº";
          title = "Stop Actualizado";
          break;
        case "SG_SCALE_OUT_EXECUTED":
          emoji = "üìä";
          title = "Scale-Out Ejecutado";
          break;
      }

      const message = `
${emoji} *${envPrefix}${title}*

*Par:* ${pair}
*Lote:* \`${shortLotId}\`
*Entry:* $${entryPrice.toFixed(2)}
*Actual:* $${currentPrice.toFixed(2)}
*Profit:* ${extra.profitPct >= 0 ? '+' : ''}${extra.profitPct.toFixed(2)}%
${extra.stopPrice ? `*Nuevo Stop:* $${extra.stopPrice.toFixed(4)}` : ''}

_${extra.reason}_
      `.trim();

      await this.telegramService.sendAlertToMultipleChats(message, "status");
    }
  }

  private getUniquePairs(): string[] {
    const pairs = new Set<string>();
    this.openPositions.forEach((position) => {
      pairs.add(position.pair);
    });
    return Array.from(pairs);
  }

  private calculatePairExposure(pair: string): number {
    let total = 0;
    this.openPositions.forEach((position) => {
      if (position.pair === pair) {
        total += position.amount * position.entryPrice;
      }
    });
    return total;
  }

  private calculateTotalExposure(): number {
    let total = 0;
    this.openPositions.forEach((position) => {
      total += position.amount * position.entryPrice;
    });
    return total;
  }

  private getAvailableExposure(pair: string, config: any, freshUsdBalance?: number): { 
    maxPairAvailable: number; 
    maxTotalAvailable: number; 
    maxAllowed: number;
  } {
    const maxPairExposurePct = parseFloat(config.maxPairExposurePct?.toString() || "25");
    const maxTotalExposurePct = parseFloat(config.maxTotalExposurePct?.toString() || "60");

    const currentPairExposure = this.calculatePairExposure(pair);
    const currentTotalExposure = this.calculateTotalExposure();

    const usdBalance = freshUsdBalance ?? this.currentUsdBalance;
    const maxPairExposureUsd = usdBalance * (maxPairExposurePct / 100);
    const maxTotalExposureUsd = usdBalance * (maxTotalExposurePct / 100);

    const maxPairAvailable = Math.max(0, maxPairExposureUsd - currentPairExposure);
    const maxTotalAvailable = Math.max(0, maxTotalExposureUsd - currentTotalExposure);
    
    return {
      maxPairAvailable,
      maxTotalAvailable,
      maxAllowed: Math.min(maxPairAvailable, maxTotalAvailable)
    };
  }

  // === SMART_GUARD: Obtener par√°metros con overrides por par ===
  private getSmartGuardParams(pair: string, config: any): {
    sgMinEntryUsd: number;
    sgAllowUnderMin: boolean;
    sgBeAtPct: number;
    sgFeeCushionPct: number;
    sgFeeCushionAuto: boolean;
    sgTrailStartPct: number;
    sgTrailDistancePct: number;
    sgTrailStepPct: number;
    sgTpFixedEnabled: boolean;
    sgTpFixedPct: number;
    sgScaleOutEnabled: boolean;
    sgScaleOutPct: number;
    sgMinPartUsd: number;
    sgScaleOutThreshold: number;
  } {
    // Valores base de config global
    const base = {
      sgMinEntryUsd: parseFloat(config?.sgMinEntryUsd?.toString() || "100"),
      sgAllowUnderMin: config?.sgAllowUnderMin ?? true,
      sgBeAtPct: parseFloat(config?.sgBeAtPct?.toString() || "1.5"),
      sgFeeCushionPct: parseFloat(config?.sgFeeCushionPct?.toString() || "0.45"),
      sgFeeCushionAuto: config?.sgFeeCushionAuto ?? true,
      sgTrailStartPct: parseFloat(config?.sgTrailStartPct?.toString() || "2"),
      sgTrailDistancePct: parseFloat(config?.sgTrailDistancePct?.toString() || "1.5"),
      sgTrailStepPct: parseFloat(config?.sgTrailStepPct?.toString() || "0.25"),
      sgTpFixedEnabled: config?.sgTpFixedEnabled ?? false,
      sgTpFixedPct: parseFloat(config?.sgTpFixedPct?.toString() || "10"),
      sgScaleOutEnabled: config?.sgScaleOutEnabled ?? false,
      sgScaleOutPct: parseFloat(config?.sgScaleOutPct?.toString() || "35"),
      sgMinPartUsd: parseFloat(config?.sgMinPartUsd?.toString() || "50"),
      sgScaleOutThreshold: parseFloat(config?.sgScaleOutThreshold?.toString() || "80"),
    };

    // Aplicar overrides por par si existen
    const overrides = config?.sgPairOverrides?.[pair];
    if (overrides) {
      const merged = { ...base };
      // Floats
      if (overrides.sgMinEntryUsd !== undefined) merged.sgMinEntryUsd = parseFloat(overrides.sgMinEntryUsd.toString());
      if (overrides.sgBeAtPct !== undefined) merged.sgBeAtPct = parseFloat(overrides.sgBeAtPct.toString());
      if (overrides.sgFeeCushionPct !== undefined) merged.sgFeeCushionPct = parseFloat(overrides.sgFeeCushionPct.toString());
      if (overrides.sgTrailStartPct !== undefined) merged.sgTrailStartPct = parseFloat(overrides.sgTrailStartPct.toString());
      if (overrides.sgTrailDistancePct !== undefined) merged.sgTrailDistancePct = parseFloat(overrides.sgTrailDistancePct.toString());
      if (overrides.sgTrailStepPct !== undefined) merged.sgTrailStepPct = parseFloat(overrides.sgTrailStepPct.toString());
      if (overrides.sgTpFixedPct !== undefined) merged.sgTpFixedPct = parseFloat(overrides.sgTpFixedPct.toString());
      if (overrides.sgMinPartUsd !== undefined) merged.sgMinPartUsd = parseFloat(overrides.sgMinPartUsd.toString());
      if (overrides.sgScaleOutPct !== undefined) merged.sgScaleOutPct = parseFloat(overrides.sgScaleOutPct.toString());
      if (overrides.sgScaleOutThreshold !== undefined) merged.sgScaleOutThreshold = parseFloat(overrides.sgScaleOutThreshold.toString());
      // Booleans
      if (overrides.sgAllowUnderMin !== undefined) merged.sgAllowUnderMin = !!overrides.sgAllowUnderMin;
      if (overrides.sgFeeCushionAuto !== undefined) merged.sgFeeCushionAuto = !!overrides.sgFeeCushionAuto;
      if (overrides.sgTpFixedEnabled !== undefined) merged.sgTpFixedEnabled = !!overrides.sgTpFixedEnabled;
      if (overrides.sgScaleOutEnabled !== undefined) merged.sgScaleOutEnabled = !!overrides.sgScaleOutEnabled;
      return merged;
    }

    return base;
  }

  private isPairInCooldown(pair: string): boolean {
    const cooldownUntil = this.pairCooldowns.get(pair);
    if (!cooldownUntil) return false;
    
    if (Date.now() >= cooldownUntil) {
      this.pairCooldowns.delete(pair);
      return false;
    }
    return true;
  }

  private setPairCooldown(pair: string): void {
    const cooldownUntil = Date.now() + this.COOLDOWN_DURATION_MS;
    this.pairCooldowns.set(pair, cooldownUntil);
    log(`${pair} en cooldown por ${this.COOLDOWN_DURATION_MS / 60000} minutos`, "trading");
  }

  private shouldSendExposureAlert(pair: string): boolean {
    const lastAlert = this.lastExposureAlert.get(pair) || 0;
    if (Date.now() - lastAlert < this.EXPOSURE_ALERT_INTERVAL_MS) {
      return false;
    }
    this.lastExposureAlert.set(pair, Date.now());
    return true;
  }

  // === MEJORA 1: Filtro de Spread ===
  private calculateSpreadPct(bid: number, ask: number): number {
    if (bid <= 0 || ask <= 0) return 0;
    const midPrice = (bid + ask) / 2;
    return ((ask - bid) / midPrice) * 100;
  }

  private isSpreadAcceptable(tickerData: any): { acceptable: boolean; spreadPct: number } {
    if (!this.spreadFilterEnabled) {
      return { acceptable: true, spreadPct: 0 };
    }
    
    const bid = parseFloat(tickerData.b?.[0] || "0");
    const ask = parseFloat(tickerData.a?.[0] || "0");
    const spreadPct = this.calculateSpreadPct(bid, ask);
    
    return {
      acceptable: spreadPct <= MAX_SPREAD_PCT,
      spreadPct,
    };
  }

  // === MEJORA 2: Horarios de Trading ===
  private isWithinTradingHours(config: any): { withinHours: boolean; hourUTC: number; start: number; end: number } {
    const tradingHoursEnabled = config.tradingHoursEnabled ?? true;
    const start = parseInt(config.tradingHoursStart?.toString() || "8");
    const end = parseInt(config.tradingHoursEnd?.toString() || "22");
    
    if (!tradingHoursEnabled) {
      return { withinHours: true, hourUTC: new Date().getUTCHours(), start, end };
    }
    
    const now = new Date();
    const hourUTC = now.getUTCHours();
    
    return { withinHours: hourUTC >= start && hourUTC < end, hourUTC, start, end };
  }

  // === MEJORA 3: Position Sizing Din√°mico ===
  private getConfidenceSizingFactor(confidence: number): number {
    if (confidence >= CONFIDENCE_SIZING_THRESHOLDS.high.min) {
      return CONFIDENCE_SIZING_THRESHOLDS.high.factor;
    } else if (confidence >= CONFIDENCE_SIZING_THRESHOLDS.medium.min) {
      return CONFIDENCE_SIZING_THRESHOLDS.medium.factor;
    } else if (confidence >= CONFIDENCE_SIZING_THRESHOLDS.low.min) {
      return CONFIDENCE_SIZING_THRESHOLDS.low.factor;
    }
    return 0; // No trade if confidence < 0.6
  }

  // === ENGINE TICK: Heartbeat cada 60s ===
  private async emitEngineTick(): Promise<void> {
    if (!this.isRunning) return;

    try {
      const config = await storage.getBotConfig();
      const now = Date.now();
      const loopLatencyMs = this.lastScanTime > 0 ? now - this.lastScanTime : 0;
      
      const openPositionsPairs = Array.from(this.openPositions.keys());
      
      await botLogger.info("ENGINE_TICK", "Motor activo - escaneo en curso", {
        activePairs: config?.activePairs || [],
        openPositionsCount: this.openPositions.size,
        openPositionsPairs,
        lastScanAt: this.lastScanTime > 0 ? new Date(this.lastScanTime).toISOString() : null,
        loopLatencyMs,
        balanceUsd: this.currentUsdBalance,
        isDailyLimitReached: this.isDailyLimitReached,
        dailyPnL: this.dailyPnL,
      });

      this.lastTickTime = now;

      // Emitir MARKET_SCAN_SUMMARY si hay resultados
      if (this.lastScanResults.size > 0) {
        const scanSummary: Record<string, any> = {};
        this.lastScanResults.forEach((result, pair) => {
          scanSummary[pair] = result;
        });

        await botLogger.info("MARKET_SCAN_SUMMARY", "Resumen de escaneo de mercado", {
          pairs: scanSummary,
          scanTime: new Date(this.lastScanTime).toISOString(),
        });
      }
    } catch (error: any) {
      log(`Error emitiendo ENGINE_TICK: ${error.message}`, "trading");
    }
  }

  // Helper to get cooldown remaining seconds
  private getCooldownRemainingSec(pair: string): number | undefined {
    const cooldownUntil = this.pairCooldowns.get(pair);
    if (!cooldownUntil) return undefined;
    const remaining = Math.max(0, Math.floor((cooldownUntil - Date.now()) / 1000));
    return remaining > 0 ? remaining : undefined;
  }

  private getStopLossCooldownRemainingSec(pair: string): number | undefined {
    const cooldownUntil = this.stopLossCooldowns.get(pair);
    if (!cooldownUntil) return undefined;
    const remaining = Math.max(0, Math.floor((cooldownUntil - Date.now()) / 1000));
    return remaining > 0 ? remaining : undefined;
  }

  // === MEJORA 4: Cooldown Post Stop-Loss ===
  private isPairInStopLossCooldown(pair: string): boolean {
    const cooldownUntil = this.stopLossCooldowns.get(pair);
    if (!cooldownUntil) return false;
    
    if (Date.now() >= cooldownUntil) {
      this.stopLossCooldowns.delete(pair);
      return false;
    }
    return true;
  }

  private setStopLossCooldown(pair: string): void {
    const cooldownUntil = Date.now() + POST_STOPLOSS_COOLDOWN_MS;
    this.stopLossCooldowns.set(pair, cooldownUntil);
    log(`${pair} en cooldown post-SL por ${POST_STOPLOSS_COOLDOWN_MS / 60000} minutos`, "trading");
  }

  private isProfitableAfterFees(takeProfitPct: number): { 
    isProfitable: boolean; 
    minProfitRequired: number; 
    roundTripFees: number;
    netExpectedProfit: number;
  } {
    const roundTripFees = ROUND_TRIP_FEE_PCT;
    const minProfitRequired = roundTripFees * MIN_PROFIT_MULTIPLIER;
    const netExpectedProfit = takeProfitPct - roundTripFees;
    
    return {
      isProfitable: takeProfitPct >= minProfitRequired,
      minProfitRequired,
      roundTripFees,
      netExpectedProfit,
    };
  }

  // === MOMENTUM (VELAS) - Helpers ===
  private getTimeframeIntervalMinutes(timeframe: string): number {
    switch (timeframe) {
      case "5m": return 5;
      case "15m": return 15;
      case "1h": return 60;
      default: return 5;
    }
  }

  private async getLastClosedCandle(pair: string, timeframe: string): Promise<OHLCCandle | null> {
    try {
      const intervalMinutes = this.getTimeframeIntervalMinutes(timeframe);
      const candles = await this.krakenService.getOHLC(pair, intervalMinutes);
      if (!candles || candles.length < 2) return null;
      return candles[candles.length - 2];
    } catch (error: any) {
      log(`Error obteniendo vela cerrada ${pair}/${timeframe}: ${error.message}`, "trading");
      return null;
    }
  }

  private isNewCandleClosed(pair: string, timeframe: string, candleTime: number): boolean {
    const key = `${pair}:${timeframe}`;
    const lastTs = this.lastEvaluatedCandle.get(key) || 0;
    if (candleTime > lastTs) {
      this.lastEvaluatedCandle.set(key, candleTime);
      return true;
    }
    return false;
  }

  private async analyzeWithCandleStrategy(
    pair: string,
    timeframe: string,
    candle: OHLCCandle
  ): Promise<TradeSignal> {
    const intervalMinutes = this.getTimeframeIntervalMinutes(timeframe);
    const candles = await this.krakenService.getOHLC(pair, intervalMinutes);
    if (!candles || candles.length < 20) {
      return { action: "hold", pair, confidence: 0, reason: "Datos insuficientes para an√°lisis de velas" };
    }
    
    const closedCandles = candles.slice(0, -1);
    return this.momentumCandlesStrategy(pair, closedCandles, candle.close);
  }

  private momentumCandlesStrategy(pair: string, candles: OHLCCandle[], currentPrice: number): TradeSignal {
    if (candles.length < 20) {
      return { action: "hold", pair, confidence: 0, reason: "Historial de velas insuficiente" };
    }
    
    const closes = candles.map(c => c.close);
    const shortEMA = this.calculateEMA(closes.slice(-10), 10);
    const longEMA = this.calculateEMA(closes.slice(-20), 20);
    const rsi = this.calculateRSI(closes.slice(-14));
    const macd = this.calculateMACD(closes);
    const bollinger = this.calculateBollingerBands(closes);
    
    const lastCandle = candles[candles.length - 1];
    const prevCandle = candles[candles.length - 2];
    const isBullishCandle = lastCandle.close > lastCandle.open;
    const isBearishCandle = lastCandle.close < lastCandle.open;
    const candleBody = Math.abs(lastCandle.close - lastCandle.open);
    const candleRange = lastCandle.high - lastCandle.low;
    const bodyRatio = candleRange > 0 ? candleBody / candleRange : 0;
    
    const avgVolume = candles.slice(-10).reduce((sum, c) => sum + c.volume, 0) / 10;
    const volumeRatio = avgVolume > 0 ? lastCandle.volume / avgVolume : 1;
    const isHighVolume = volumeRatio > 1.5;
    
    let buySignals = 0;
    let sellSignals = 0;
    const reasons: string[] = [];

    if (shortEMA > longEMA) buySignals++;
    else if (shortEMA < longEMA) sellSignals++;

    if (rsi < 30) { buySignals += 2; reasons.push(`RSI sobrevendido (${rsi.toFixed(0)})`); }
    else if (rsi < 45) { buySignals++; }
    else if (rsi > 70) { sellSignals += 2; reasons.push(`RSI sobrecomprado (${rsi.toFixed(0)})`); }
    else if (rsi > 55) { sellSignals++; }

    if (macd.histogram > 0 && macd.macd > macd.signal) { buySignals++; reasons.push("MACD alcista"); }
    else if (macd.histogram < 0 && macd.macd < macd.signal) { sellSignals++; reasons.push("MACD bajista"); }

    if (bollinger.percentB < 20) { buySignals++; reasons.push("Precio en Bollinger inferior"); }
    else if (bollinger.percentB > 80) { sellSignals++; reasons.push("Precio en Bollinger superior"); }

    if (isBullishCandle && bodyRatio > 0.6) {
      buySignals++;
      reasons.push("Vela alcista fuerte");
    } else if (isBearishCandle && bodyRatio > 0.6) {
      sellSignals++;
      reasons.push("Vela bajista fuerte");
    }

    if (isHighVolume) {
      if (isBullishCandle) { buySignals++; reasons.push(`Volumen alto alcista (${volumeRatio.toFixed(1)}x)`); }
      else if (isBearishCandle) { sellSignals++; reasons.push(`Volumen alto bajista (${volumeRatio.toFixed(1)}x)`); }
    }

    if (isBullishCandle && prevCandle && prevCandle.close < prevCandle.open) {
      if (lastCandle.close > prevCandle.open) {
        buySignals++;
        reasons.push("Engulfing alcista");
      }
    }
    if (isBearishCandle && prevCandle && prevCandle.close > prevCandle.open) {
      if (lastCandle.close < prevCandle.open) {
        sellSignals++;
        reasons.push("Engulfing bajista");
      }
    }

    const confidence = Math.min(0.95, 0.5 + (Math.max(buySignals, sellSignals) * 0.07));
    
    if (buySignals >= 4 && buySignals > sellSignals && rsi < 70) {
      return {
        action: "buy",
        pair,
        confidence,
        reason: `Momentum Velas COMPRA: ${reasons.join(", ")} | Se√±ales: ${buySignals}/${sellSignals}`,
      };
    }
    
    if (sellSignals >= 4 && sellSignals > buySignals && rsi > 30) {
      return {
        action: "sell",
        pair,
        confidence,
        reason: `Momentum Velas VENTA: ${reasons.join(", ")} | Se√±ales: ${sellSignals}/${buySignals}`,
      };
    }

    return { action: "hold", pair, confidence: 0.3, reason: `Sin se√±al clara velas (${buySignals}/${sellSignals})` };
  }

  async start() {
    if (this.isRunning) return;
    
    const config = await storage.getBotConfig();
    if (!config?.isActive) {
      log("Bot no est√° activo, no se inicia el motor de trading", "trading");
      return;
    }

    if (!this.krakenService.isInitialized()) {
      log("Kraken no est√° configurado, no se puede iniciar el trading", "trading");
      return;
    }

    // Load dynamic pair metadata from Kraken API (step sizes, order minimums)
    const activePairs = config.activePairs || ["BTC/USD", "ETH/USD", "SOL/USD", "XRP/USD"];
    try {
      await this.krakenService.loadPairMetadata(activePairs);
      // Verify all active pairs have metadata
      const missingPairs = activePairs.filter(p => !this.krakenService.hasMetadata(p));
      if (missingPairs.length > 0) {
        log(`[CRITICAL] Missing metadata for pairs: ${missingPairs.join(", ")}. Using fallback values.`, "trading");
      }
      this.krakenService.startMetadataRefresh(activePairs);
    } catch (error: any) {
      log(`[CRITICAL] Failed to load pair metadata: ${error.message}. Trading will use fallback values.`, "trading");
      // Continue with fallbacks - don't block trading entirely for API failures
    }

    if (!this.telegramService.isInitialized()) {
      log("Telegram no est√° configurado, continuando sin notificaciones", "trading");
    }
    
    // Load dryRunMode from config (Replit always forces dry run regardless of DB setting)
    const dbDryRun = (config as any).dryRunMode ?? false;
    if (this.isReplitEnvironment) {
      this.dryRunMode = true;
      log("[SAFETY] Modo DRY_RUN forzado en Replit - no se enviar√°n √≥rdenes reales", "trading");
    } else {
      this.dryRunMode = dbDryRun;
      if (this.dryRunMode) {
        log("[INFO] Modo DRY_RUN activado desde configuraci√≥n", "trading");
      }
    }

    try {
      const balances = await this.krakenService.getBalance();
      this.currentUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || "0");
      log(`Balance inicial USD: $${this.currentUsdBalance.toFixed(2)}`, "trading");
    } catch (error: any) {
      log(`Error obteniendo balance inicial: ${error.message}`, "trading");
      return;
    }

    this.isRunning = true;
    log("Motor de trading iniciado", "trading");
    
    await this.loadOpenPositionsFromDB();
    
    const modeLabel = this.dryRunMode ? "DRY_RUN (simulaci√≥n)" : "LIVE (√≥rdenes reales)";
    
    await botLogger.info("BOT_STARTED", "Motor de trading iniciado", {
      strategy: config.strategy,
      riskLevel: config.riskLevel,
      activePairs: config.activePairs,
      balanceUsd: this.currentUsdBalance,
      openPositions: this.openPositions.size,
      dryRunMode: this.dryRunMode,
      isReplitEnvironment: this.isReplitEnvironment,
    });
    
    if (this.telegramService.isInitialized()) {
      const dryRunNote = this.dryRunMode ? "\n‚ö†Ô∏è *Modo:* DRY\\_RUN (sin √≥rdenes reales)" : "";
      await this.telegramService.sendMessage(`ü§ñ *KrakenBot Iniciado*

El bot de trading aut√≥nomo est√° activo.
*Estrategia:* ${config.strategy}
*Nivel de riesgo:* ${config.riskLevel}
*Pares activos:* ${config.activePairs.join(", ")}
*Balance USD:* $${this.currentUsdBalance.toFixed(2)}${dryRunNote}`);
    }
    
    const intervalMs = this.getIntervalForStrategy(config.strategy);
    this.intervalId = setInterval(() => this.runTradingCycle(), intervalMs);
    
    // Iniciar tick interval para ENGINE_TICK cada 60s
    this.tickIntervalId = setInterval(() => this.emitEngineTick(), this.TICK_INTERVAL_MS);
    
    this.runTradingCycle();
  }

  async stop() {
    if (!this.isRunning) return;
    
    this.isRunning = false;
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    if (this.tickIntervalId) {
      clearInterval(this.tickIntervalId);
      this.tickIntervalId = null;
    }
    
    log("Motor de trading detenido", "trading");
    
    await botLogger.info("BOT_STOPPED", "Motor de trading detenido");
    
    if (this.telegramService.isInitialized()) {
      await this.telegramService.sendMessage("üõë *KrakenBot Detenido*\n\nEl bot de trading ha sido desactivado.");
    }
  }

  private getIntervalForStrategy(strategy: string): number {
    switch (strategy) {
      case "scalping": return 10000;
      case "grid": return 15000;
      case "momentum": return 30000;
      case "mean_reversion": return 30000;
      default: return 30000;
    }
  }

  private async loadOpenPositionsFromDB() {
    try {
      const positions = await storage.getOpenPositions();
      this.openPositions.clear();
      
      for (const pos of positions) {
        const hasSnapshot = pos.configSnapshotJson && pos.entryMode;
        const configSnapshot = hasSnapshot ? (pos.configSnapshotJson as ConfigSnapshot) : undefined;
        
        // Use existing lotId or generate one for legacy positions
        const lotId = pos.lotId || generateLotId(pos.pair);
        
        this.openPositions.set(lotId, {
          lotId,
          pair: pos.pair,
          amount: parseFloat(pos.amount),
          entryPrice: parseFloat(pos.entryPrice),
          highestPrice: parseFloat(pos.highestPrice),
          openedAt: new Date(pos.openedAt).getTime(),
          entryStrategyId: pos.entryStrategyId || "momentum_cycle",
          entrySignalTf: pos.entrySignalTf || "cycle",
          signalConfidence: pos.signalConfidence ? parseFloat(pos.signalConfidence) : undefined,
          signalReason: pos.signalReason || undefined,
          entryMode: pos.entryMode || undefined,
          configSnapshot,
          // SMART_GUARD state
          sgBreakEvenActivated: pos.sgBreakEvenActivated ?? false,
          sgCurrentStopPrice: pos.sgCurrentStopPrice ? parseFloat(pos.sgCurrentStopPrice) : undefined,
          sgTrailingActivated: pos.sgTrailingActivated ?? false,
          sgScaleOutDone: pos.sgScaleOutDone ?? false,
        });
        
        // If position lacked lotId, update DB
        if (!pos.lotId) {
          await storage.updateOpenPositionLotId(pos.id, lotId);
          log(`Migrated legacy position ${pos.pair} -> lotId: ${lotId}`, "trading");
        }
        
        const snapshotInfo = hasSnapshot ? `[snapshot: ${pos.entryMode}]` : "[legacy: uses current config]";
        log(`Posici√≥n recuperada: ${pos.pair} (${lotId}) - ${pos.amount} @ $${pos.entryPrice} (${pos.entryStrategyId}/${pos.entrySignalTf}) ${snapshotInfo}`, "trading");
      }
      
      if (positions.length > 0) {
        log(`${positions.length} posiciones abiertas (${this.openPositions.size} lotes) cargadas desde la base de datos`, "trading");
        if (this.telegramService.isInitialized()) {
          const escapeMarkdown = (text: string) => text.replace(/[_*[\]()~`>#+=|{}.!-]/g, '\\$&');
          const positionsList = positions.map(p => {
            const hasSnap = p.configSnapshotJson && p.entryMode;
            const snapLabel = hasSnap ? `üì∏${escapeMarkdown(p.entryMode || '')}` : `‚öôÔ∏èlegacy`;
            return `‚Ä¢ ${p.pair}: ${p.amount} @ $${parseFloat(p.entryPrice).toFixed(2)} (${snapLabel})`;
          }).join("\n");
          await this.telegramService.sendMessage(`üìÇ *Posiciones Abiertas*\n\n${positionsList}`);
        }
      }
    } catch (error: any) {
      log(`Error cargando posiciones: ${error.message}`, "trading");
    }
  }

  private async savePositionToDB(pair: string, position: OpenPosition) {
    try {
      await storage.saveOpenPositionByLotId({
        lotId: position.lotId,
        pair,
        entryPrice: position.entryPrice.toString(),
        amount: position.amount.toString(),
        highestPrice: position.highestPrice.toString(),
        entryStrategyId: position.entryStrategyId,
        entrySignalTf: position.entrySignalTf,
        signalConfidence: position.signalConfidence?.toString(),
        signalReason: position.signalReason,
        entryMode: position.entryMode,
        configSnapshotJson: position.configSnapshot,
        // SMART_GUARD state
        sgBreakEvenActivated: position.sgBreakEvenActivated,
        sgCurrentStopPrice: position.sgCurrentStopPrice?.toString(),
        sgTrailingActivated: position.sgTrailingActivated,
        sgScaleOutDone: position.sgScaleOutDone,
      });
    } catch (error: any) {
      log(`Error guardando posici√≥n ${pair} (${position.lotId}): ${error.message}`, "trading");
    }
  }

  private async deletePositionFromDBByLotId(lotId: string) {
    try {
      await storage.deleteOpenPositionByLotId(lotId);
    } catch (error: any) {
      log(`Error eliminando posici√≥n ${lotId}: ${error.message}`, "trading");
    }
  }

  private async updatePositionHighestPriceByLotId(lotId: string, highestPrice: number) {
    try {
      await storage.updateOpenPositionByLotId(lotId, {
        highestPrice: highestPrice.toString(),
      });
    } catch (error: any) {
      log(`Error actualizando highestPrice ${lotId}: ${error.message}`, "trading");
    }
  }

  private async runTradingCycle() {
    try {
      const config = await storage.getBotConfig();
      if (!config?.isActive) {
        await this.stop();
        return;
      }

      // Actualizar tiempo de escaneo y limpiar resultados anteriores
      this.lastScanTime = Date.now();
      this.lastScanResults.clear();

      const balances = await this.krakenService.getBalance();
      this.currentUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || "0");
      
      // Reset diario del P&L
      const today = new Date().toISOString().split("T")[0];
      if (this.lastDayReset !== today) {
        const previousDayPnL = this.dailyPnL;
        this.dailyPnL = 0;
        this.dailyStartBalance = this.currentUsdBalance;
        this.lastDayReset = today;
        this.isDailyLimitReached = false;
        log(`Nuevo d√≠a de trading: ${today}. Balance inicial: $${this.dailyStartBalance.toFixed(2)}`, "trading");
        
        await botLogger.info("DAILY_LIMIT_RESET", `Nuevo d√≠a de trading: ${today}`, {
          date: today,
          previousDayPnL,
          startBalance: this.dailyStartBalance,
        });
      }

      // Verificar l√≠mite de p√©rdida diaria
      const dailyLossLimitEnabled = config.dailyLossLimitEnabled ?? true;
      const dailyLossLimitPercent = parseFloat(config.dailyLossLimitPercent?.toString() || "10");
      
      if (dailyLossLimitEnabled && this.dailyStartBalance > 0) {
        const currentLossPercent = (this.dailyPnL / this.dailyStartBalance) * 100;
        
        if (currentLossPercent <= -dailyLossLimitPercent && !this.isDailyLimitReached) {
          this.isDailyLimitReached = true;
          log(`üõë L√çMITE DE P√âRDIDA DIARIA ALCANZADO: ${currentLossPercent.toFixed(2)}% (l√≠mite: -${dailyLossLimitPercent}%)`, "trading");
          
          await botLogger.warn("DAILY_LIMIT_HIT", "L√≠mite de p√©rdida diaria alcanzado. Bot pausado para nuevas compras.", {
            dailyPnL: this.dailyPnL,
            dailyPnLPercent: currentLossPercent,
            limitPercent: dailyLossLimitPercent,
            startBalance: this.dailyStartBalance,
          });
          
          if (this.telegramService.isInitialized()) {
            await this.telegramService.sendAlert(
              "L√≠mite de P√©rdida Diaria Alcanzado",
              `El bot ha pausado las operaciones de COMPRA.\n\n` +
              `üìä *P&L del d√≠a:* ${currentLossPercent.toFixed(2)}%\n` +
              `üí∞ *P√©rdida:* $${Math.abs(this.dailyPnL).toFixed(2)}\n` +
              `‚öôÔ∏è *L√≠mite configurado:* -${dailyLossLimitPercent}%\n\n` +
              `_Las operaciones de cierre (Stop-Loss, Take-Profit) siguen activas._\n` +
              `_El trading normal se reanudar√° ma√±ana autom√°ticamente._`
            );
          }
        }
      }
      
      const riskConfig = RISK_LEVELS[config.riskLevel] || RISK_LEVELS.medium;

      const stopLossPercent = parseFloat(config.stopLossPercent?.toString() || "5");
      const takeProfitPercent = parseFloat(config.takeProfitPercent?.toString() || "7");
      const trailingStopEnabled = config.trailingStopEnabled ?? false;
      const trailingStopPercent = parseFloat(config.trailingStopPercent?.toString() || "2");

      // Stop-Loss y Take-Profit siempre se verifican (incluso con l√≠mite alcanzado)
      for (const pair of config.activePairs) {
        await this.checkStopLossTakeProfit(pair, stopLossPercent, takeProfitPercent, trailingStopEnabled, trailingStopPercent, balances);
      }

      // No abrir nuevas posiciones si se alcanz√≥ el l√≠mite diario
      if (this.isDailyLimitReached) {
        return;
      }

      if (this.currentUsdBalance < 5) {
        log(`Saldo USD insuficiente: $${this.currentUsdBalance.toFixed(2)}`, "trading");
        return;
      }

      // MEJORA 2: Verificar horarios de trading
      const tradingHoursCheck = this.isWithinTradingHours(config);
      if (!tradingHoursCheck.withinHours) {
        log(`Fuera de horario de trading (${tradingHoursCheck.hourUTC}h UTC). Horario: ${tradingHoursCheck.start}h-${tradingHoursCheck.end}h UTC`, "trading");
        return;
      }

      const signalTimeframe = config.signalTimeframe || "cycle";
      const isCandleMode = signalTimeframe !== "cycle" && config.strategy === "momentum";

      for (const pair of config.activePairs) {
        // Inicializar entrada por defecto para diagn√≥stico (se sobrescribe si hay se√±al)
        if (!this.lastScanResults.has(pair)) {
          this.lastScanResults.set(pair, {
            signal: "NONE",
            reason: "Sin se√±al en este ciclo",
            exposureAvailable: this.getAvailableExposure(pair, config, this.currentUsdBalance),
          });
        }
        
        if (isCandleMode) {
          const candle = await this.getLastClosedCandle(pair, signalTimeframe);
          if (!candle) continue;
          
          if (this.isNewCandleClosed(pair, signalTimeframe, candle.time)) {
            log(`Nueva vela cerrada ${pair}/${signalTimeframe} @ ${new Date(candle.time * 1000).toISOString()}`, "trading");
            await this.analyzePairAndTradeWithCandles(pair, signalTimeframe, candle, riskConfig, balances);
          }
        } else {
          await this.analyzePairAndTrade(pair, config.strategy, riskConfig, balances);
        }
      }
    } catch (error: any) {
      log(`Error en ciclo de trading: ${error.message}`, "trading");
    }
  }

  private async checkStopLossTakeProfit(
    pair: string,
    stopLossPercent: number,
    takeProfitPercent: number,
    trailingStopEnabled: boolean,
    trailingStopPercent: number,
    balances: any
  ) {
    // Get all positions for this pair (multi-lot support)
    const positions = this.getPositionsByPair(pair);
    if (positions.length === 0) return;

    try {
      const krakenPair = this.formatKrakenPair(pair);
      const ticker = await this.krakenService.getTicker(krakenPair);
      const tickerData: any = Object.values(ticker)[0];
      if (!tickerData) return;

      const currentPrice = parseFloat(tickerData.c?.[0] || "0");

      // Process each position for this pair independently
      for (const position of positions) {
        if (position.amount <= 0) continue;
        
        await this.checkSinglePositionSLTP(
          pair, position, currentPrice, stopLossPercent, takeProfitPercent,
          trailingStopEnabled, trailingStopPercent, balances
        );
      }
    } catch (error: any) {
      log(`Error verificando SL/TP para ${pair}: ${error.message}`, "trading");
    }
  }

  private async checkSinglePositionSLTP(
    pair: string,
    position: OpenPosition,
    currentPrice: number,
    stopLossPercent: number,
    takeProfitPercent: number,
    trailingStopEnabled: boolean,
    trailingStopPercent: number,
    balances: any
  ) {
    const lotId = position.lotId;
    const priceChange = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;

    if (currentPrice > position.highestPrice) {
      position.highestPrice = currentPrice;
      this.openPositions.set(lotId, position);
      await this.updatePositionHighestPriceByLotId(lotId, currentPrice);
    }

    // Check if this is a SMART_GUARD position - use dedicated logic
    if (position.entryMode === "SMART_GUARD" && position.configSnapshot) {
      await this.checkSmartGuardExit(pair, position, currentPrice, priceChange);
      return;
    }

    // Use snapshot params if available (new positions), else use current config (legacy)
    let effectiveSL: number;
    let effectiveTP: number;
    let effectiveTrailingEnabled: boolean;
    let effectiveTrailingPct: number;
    let paramsSource: string;

    if (position.configSnapshot) {
      effectiveSL = position.configSnapshot.stopLossPercent;
      effectiveTP = position.configSnapshot.takeProfitPercent;
      effectiveTrailingEnabled = position.configSnapshot.trailingStopEnabled;
      effectiveTrailingPct = position.configSnapshot.trailingStopPercent;
      paramsSource = `snapshot (${position.entryMode})`;
    } else {
      effectiveSL = stopLossPercent;
      effectiveTP = takeProfitPercent;
      effectiveTrailingEnabled = trailingStopEnabled;
      effectiveTrailingPct = trailingStopPercent;
      paramsSource = "current config (legacy)";
    }

    let shouldSell = false;
    let reason = "";
    let emoji = "";

    if (priceChange <= -effectiveSL) {
      shouldSell = true;
      reason = `Stop-Loss activado (${priceChange.toFixed(2)}% < -${effectiveSL}%) [${paramsSource}]`;
      emoji = "üõë";
      this.setStopLossCooldown(pair);
      await botLogger.warn("STOP_LOSS_HIT", `Stop-Loss activado en ${pair}`, {
        pair,
        lotId,
        entryPrice: position.entryPrice,
        currentPrice,
        priceChange,
        stopLossPercent: effectiveSL,
        paramsSource,
        cooldownMinutes: POST_STOPLOSS_COOLDOWN_MS / 60000,
      });
    }
    else if (priceChange >= effectiveTP) {
      shouldSell = true;
      reason = `Take-Profit activado (${priceChange.toFixed(2)}% > ${effectiveTP}%) [${paramsSource}]`;
      emoji = "üéØ";
      await botLogger.info("TAKE_PROFIT_HIT", `Take-Profit alcanzado en ${pair}`, {
        pair,
        lotId,
        entryPrice: position.entryPrice,
        currentPrice,
        priceChange,
        takeProfitPercent: effectiveTP,
        paramsSource,
      });
    }
    else if (effectiveTrailingEnabled && position.highestPrice > position.entryPrice) {
      const dropFromHigh = ((position.highestPrice - currentPrice) / position.highestPrice) * 100;
      if (dropFromHigh >= effectiveTrailingPct && priceChange > 0) {
        shouldSell = true;
        reason = `Trailing Stop activado (cay√≥ ${dropFromHigh.toFixed(2)}% desde m√°ximo $${position.highestPrice.toFixed(2)}) [${paramsSource}]`;
        emoji = "üìâ";
        await botLogger.info("TRAILING_STOP_HIT", `Trailing Stop activado en ${pair}`, {
          pair,
          lotId,
          entryPrice: position.entryPrice,
          highestPrice: position.highestPrice,
          currentPrice,
          dropFromHigh,
          trailingStopPercent: effectiveTrailingPct,
          paramsSource,
        });
      }
    }

    if (shouldSell) {
      const minVolume = this.getOrderMin(pair);
      const sellAmount = position.amount;

      if (sellAmount < minVolume) {
        log(`Cantidad a vender (${sellAmount}) menor al m√≠nimo de Kraken (${minVolume}) para ${pair} (${lotId})`, "trading");
        return;
      }

      // VERIFICACI√ìN DE BALANCE REAL: Evitar "EOrder:Insufficient funds"
      const freshBalances = await this.krakenService.getBalance();
      const realAssetBalance = this.getAssetBalance(pair, freshBalances);
      
      // Si el balance real es menor al 99.5% del esperado (tolerancia para fees ~0.26%)
      if (realAssetBalance < sellAmount * 0.995) {
        log(`‚ö†Ô∏è Discrepancia de balance en ${pair} (${lotId}): Registrado ${sellAmount}, Real ${realAssetBalance}`, "trading");
        
        // Si balance real es pr√°cticamente cero (< m√≠nimo de Kraken), eliminar posici√≥n
        if (realAssetBalance < minVolume) {
          log(`Posici√≥n hu√©rfana eliminada en ${pair} (${lotId}): balance real (${realAssetBalance}) < m√≠nimo (${minVolume})`, "trading");
          
          // NO modificar dailyPnL: si fue vendida manualmente, el usuario ya tiene el USD
          // Pero S√ç debemos reconciliar exposure y cooldowns
          
          // Refrescar balance USD para tener m√©tricas consistentes
          this.currentUsdBalance = parseFloat(freshBalances?.ZUSD || freshBalances?.USD || "0");
          
          this.openPositions.delete(lotId);
          await this.deletePositionFromDBByLotId(lotId);
          
          // Limpiar cooldowns obsoletos y establecer uno nuevo (15 min)
          this.stopLossCooldowns.delete(pair);
          this.lastExposureAlert.delete(pair);
          this.setPairCooldown(pair);
          this.lastTradeTime.set(pair, Date.now());
          
          if (this.telegramService.isInitialized()) {
            await this.telegramService.sendMessage(`
üîÑ *Posici√≥n Hu√©rfana Eliminada*

*Par:* ${pair}
*Lot:* ${lotId}
*Registrada:* ${sellAmount.toFixed(8)}
*Real en Kraken:* ${realAssetBalance.toFixed(8)}

_La posici√≥n no existe en Kraken y fue eliminada._
            `.trim());
          }
          
          await botLogger.warn("ORPHAN_POSITION_CLEANED", `Posici√≥n hu√©rfana eliminada en ${pair}`, {
            pair,
            lotId,
            registeredAmount: sellAmount,
            realBalance: realAssetBalance,
            newUsdBalance: this.currentUsdBalance,
          });
          return;
        }
        
        // Si hay algo de balance pero menos del registrado, ajustar posici√≥n al real
        log(`Ajustando posici√≥n ${pair} (${lotId}) de ${sellAmount} a ${realAssetBalance}`, "trading");
        position.amount = realAssetBalance;
        this.openPositions.set(lotId, position);
        await this.savePositionToDB(pair, position);
        
        // Notificar ajuste
        if (this.telegramService.isInitialized()) {
          await this.telegramService.sendMessage(`
üîß *Posici√≥n Ajustada*

*Par:* ${pair}
*Lot:* ${lotId}
*Cantidad anterior:* ${sellAmount.toFixed(8)}
*Cantidad real:* ${realAssetBalance.toFixed(8)}

_Se usar√° la cantidad real para la venta._
          `.trim());
        }
        
        // Continuar con la venta usando el balance real
      }

      log(`${emoji} ${reason} para ${pair} (${lotId})`, "trading");

      // Usar position.amount (puede haber sido ajustado al balance real)
      const actualSellAmount = position.amount;
      const pnl = (currentPrice - position.entryPrice) * actualSellAmount;
      const pnlPercent = priceChange;

      const sellContext = { entryPrice: position.entryPrice, aiSampleId: position.aiSampleId };
      const success = await this.executeTrade(pair, "sell", actualSellAmount.toFixed(8), currentPrice, reason, undefined, undefined, undefined, sellContext);
      
      if (success && this.telegramService.isInitialized()) {
        const pnlEmoji = pnl >= 0 ? "üí∞" : "üìâ";
        await this.telegramService.sendAlertToMultipleChats(`
${emoji} *${reason}*

*Par:* ${pair}
*Lot:* ${lotId}
*Precio entrada:* $${position.entryPrice.toFixed(2)}
*Precio actual:* $${currentPrice.toFixed(2)}
*Cantidad vendida:* ${actualSellAmount.toFixed(8)}

${pnlEmoji} *P&L:* ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)
        `.trim(), "trades");
      }

      if (success) {
        this.openPositions.delete(lotId);
        await this.deletePositionFromDBByLotId(lotId);
        this.lastTradeTime.set(pair, Date.now());
      }
    }
  }

  private async checkSmartGuardExit(
    pair: string,
    position: OpenPosition,
    currentPrice: number,
    priceChange: number
  ) {
    const snapshot = position.configSnapshot!;
    const paramsSource = `SMART_GUARD snapshot`;
    
    // Get snapshot params with defaults
    const beAtPct = snapshot.sgBeAtPct ?? 1.5;
    const feeCushionPct = snapshot.sgFeeCushionPct ?? 0.45;
    const trailStartPct = snapshot.sgTrailStartPct ?? 2.0;
    const trailDistancePct = snapshot.sgTrailDistancePct ?? 1.5;
    const trailStepPct = snapshot.sgTrailStepPct ?? 0.25;
    const tpFixedEnabled = snapshot.sgTpFixedEnabled ?? false;
    const tpFixedPct = snapshot.sgTpFixedPct ?? 10;
    const scaleOutEnabled = snapshot.sgScaleOutEnabled ?? false;
    const scaleOutPct = snapshot.sgScaleOutPct ?? 35;
    const minPartUsd = snapshot.sgMinPartUsd ?? 50;
    const scaleOutThreshold = snapshot.sgScaleOutThreshold ?? 80;
    
    // Also use the standard SL from snapshot as ultimate protection
    const ultimateSL = snapshot.stopLossPercent;
    
    let shouldSellFull = false;
    let shouldScaleOut = false;
    let sellReason = "";
    let emoji = "";
    let positionModified = false;
    
    // Calculate break-even price (entry + fee cushion)
    const breakEvenPrice = position.entryPrice * (1 + feeCushionPct / 100);
    
    // 1. ULTIMATE STOP-LOSS - Emergency exit (always active)
    if (priceChange <= -ultimateSL) {
      shouldSellFull = true;
      sellReason = `Stop-Loss emergencia SMART_GUARD (${priceChange.toFixed(2)}% < -${ultimateSL}%) [${paramsSource}]`;
      emoji = "üõë";
      this.setStopLossCooldown(pair);
      await botLogger.warn("SG_EMERGENCY_STOPLOSS", `SMART_GUARD Stop-Loss emergencia en ${pair}`, {
        pair, entryPrice: position.entryPrice, currentPrice, priceChange, ultimateSL, paramsSource,
      });
    }
    
    // 2. FIXED TAKE-PROFIT (if enabled)
    else if (tpFixedEnabled && priceChange >= tpFixedPct) {
      shouldSellFull = true;
      sellReason = `Take-Profit fijo SMART_GUARD (${priceChange.toFixed(2)}% >= ${tpFixedPct}%) [${paramsSource}]`;
      emoji = "üéØ";
      await botLogger.info("SG_TP_FIXED", `SMART_GUARD TP fijo alcanzado en ${pair}`, {
        pair, entryPrice: position.entryPrice, currentPrice, priceChange, tpFixedPct, paramsSource,
      });
    }
    
    // 3. BREAK-EVEN ACTIVATION - Move stop to breakeven when profit >= beAtPct
    else if (!position.sgBreakEvenActivated && priceChange >= beAtPct) {
      position.sgBreakEvenActivated = true;
      position.sgCurrentStopPrice = breakEvenPrice;
      positionModified = true;
      log(`SMART_GUARD ${pair}: Break-even activado (+${priceChange.toFixed(2)}%), stop movido a $${breakEvenPrice.toFixed(4)}`, "trading");
      
      // Send alert (only once per lot, no throttle needed as flag prevents re-entry)
      if (this.shouldSendSgAlert(position.lotId, "SG_BREAK_EVEN_ACTIVATED")) {
        await this.sendSgEventAlert("SG_BREAK_EVEN_ACTIVATED", position, currentPrice, {
          stopPrice: breakEvenPrice,
          profitPct: priceChange,
          reason: `Profit +${beAtPct}% alcanzado, stop movido a break-even + comisiones`,
        });
      }
    }
    
    // 4. TRAILING STOP ACTIVATION - Start trailing when profit >= trailStartPct
    if (!position.sgTrailingActivated && priceChange >= trailStartPct) {
      position.sgTrailingActivated = true;
      const trailStopPrice = currentPrice * (1 - trailDistancePct / 100);
      // Only update stop if higher than current
      if (!position.sgCurrentStopPrice || trailStopPrice > position.sgCurrentStopPrice) {
        position.sgCurrentStopPrice = trailStopPrice;
      }
      positionModified = true;
      log(`SMART_GUARD ${pair}: Trailing activado (+${priceChange.toFixed(2)}%), stop din√°mico @ $${position.sgCurrentStopPrice!.toFixed(4)}`, "trading");
      
      // Send alert (only once per lot)
      if (this.shouldSendSgAlert(position.lotId, "SG_TRAILING_ACTIVATED")) {
        await this.sendSgEventAlert("SG_TRAILING_ACTIVATED", position, currentPrice, {
          stopPrice: position.sgCurrentStopPrice,
          profitPct: priceChange,
          reason: `Profit +${trailStartPct}% alcanzado, trailing stop iniciado a ${trailDistancePct}% del m√°ximo`,
        });
      }
    }
    
    // 5. TRAILING STOP UPDATE - Ratchet up stop with step increments
    if (position.sgTrailingActivated && position.sgCurrentStopPrice) {
      const newTrailStop = currentPrice * (1 - trailDistancePct / 100);
      const minStepPrice = position.sgCurrentStopPrice * (1 + trailStepPct / 100);
      
      // Only update if new stop is higher by at least one step
      if (newTrailStop > minStepPrice) {
        const oldStop = position.sgCurrentStopPrice;
        position.sgCurrentStopPrice = newTrailStop;
        positionModified = true;
        log(`SMART_GUARD ${pair}: Trailing step $${oldStop.toFixed(4)} ‚Üí $${newTrailStop.toFixed(4)} (+${trailStepPct}%)`, "trading");
        
        // Send alert with throttle (max 1 per 5 min)
        if (this.shouldSendSgAlert(position.lotId, "SG_TRAILING_STOP_UPDATED", this.SG_TRAIL_UPDATE_THROTTLE_MS)) {
          await this.sendSgEventAlert("SG_TRAILING_STOP_UPDATED", position, currentPrice, {
            stopPrice: newTrailStop,
            profitPct: priceChange,
            reason: `Stop actualizado: $${oldStop.toFixed(2)} ‚Üí $${newTrailStop.toFixed(2)}`,
          });
        }
      }
    }
    
    // 6. CHECK IF STOP PRICE HIT
    if (position.sgCurrentStopPrice && currentPrice <= position.sgCurrentStopPrice) {
      const stopType = position.sgTrailingActivated ? "Trailing Stop" : "Break-even Stop";
      shouldSellFull = true;
      sellReason = `${stopType} SMART_GUARD ($${currentPrice.toFixed(2)} <= $${position.sgCurrentStopPrice.toFixed(2)}) [${paramsSource}]`;
      emoji = position.sgTrailingActivated ? "üìâ" : "‚öñÔ∏è";
      await botLogger.info("SG_STOP_HIT", `SMART_GUARD ${stopType} activado en ${pair}`, {
        pair, entryPrice: position.entryPrice, currentPrice, stopPrice: position.sgCurrentStopPrice,
        stopType, paramsSource,
      });
    }
    
    // 7. SCALE-OUT (optional, only if exceptional signal)
    if (!shouldSellFull && scaleOutEnabled && !position.sgScaleOutDone) {
      // Only scale out if signal confidence >= threshold and part is worth selling
      const partValue = position.amount * currentPrice * (scaleOutPct / 100);
      if (position.signalConfidence && position.signalConfidence >= scaleOutThreshold && partValue >= minPartUsd) {
        if (priceChange >= trailStartPct) { // Only scale out in profit
          shouldScaleOut = true;
          sellReason = `Scale-out SMART_GUARD (${scaleOutPct}% @ +${priceChange.toFixed(2)}%, conf=${position.signalConfidence}%) [${paramsSource}]`;
          emoji = "üìä";
          position.sgScaleOutDone = true;
          positionModified = true;
          
          // Send alert (only once as sgScaleOutDone flag prevents re-entry)
          if (this.shouldSendSgAlert(position.lotId, "SG_SCALE_OUT_EXECUTED")) {
            await this.sendSgEventAlert("SG_SCALE_OUT_EXECUTED", position, currentPrice, {
              profitPct: priceChange,
              reason: `Vendido ${scaleOutPct}% de posici√≥n ($${partValue.toFixed(2)}) a +${priceChange.toFixed(2)}%`,
            });
          }
        }
      }
    }
    
    const lotId = position.lotId;
    
    // Save position changes
    if (positionModified && !shouldSellFull && !shouldScaleOut) {
      this.openPositions.set(lotId, position);
      await this.savePositionToDB(pair, position);
    }
    
    // Execute sell if needed
    if (shouldSellFull || shouldScaleOut) {
      const minVolume = this.getOrderMin(pair);
      let sellAmount = shouldScaleOut 
        ? position.amount * (scaleOutPct / 100)
        : position.amount;
      
      if (sellAmount < minVolume) {
        log(`SMART_GUARD: Cantidad a vender (${sellAmount}) menor al m√≠nimo (${minVolume}) para ${pair} (${lotId})`, "trading");
        return;
      }
      
      // Balance verification
      const freshBalances = await this.krakenService.getBalance();
      const realAssetBalance = this.getAssetBalance(pair, freshBalances);
      
      if (realAssetBalance < sellAmount * 0.995) {
        if (realAssetBalance < minVolume) {
          log(`SMART_GUARD: Posici√≥n hu√©rfana en ${pair} (${lotId}), eliminando`, "trading");
          this.openPositions.delete(lotId);
          await this.deletePositionFromDBByLotId(lotId);
          this.setPairCooldown(pair);
          return;
        }
        sellAmount = realAssetBalance;
        position.amount = realAssetBalance;
      }
      
      log(`${emoji} ${sellReason} para ${pair} (${lotId})`, "trading");
      
      const pnl = (currentPrice - position.entryPrice) * sellAmount;
      const sellContext = { entryPrice: position.entryPrice, aiSampleId: position.aiSampleId };
      const success = await this.executeTrade(pair, "sell", sellAmount.toFixed(8), currentPrice, sellReason, undefined, undefined, undefined, sellContext);
      
      if (success && this.telegramService.isInitialized()) {
        const pnlEmoji = pnl >= 0 ? "üí∞" : "üìâ";
        await this.telegramService.sendAlertToMultipleChats(`
${emoji} *${sellReason}*

*Par:* ${pair}
*Lot:* ${lotId}
*Precio entrada:* $${position.entryPrice.toFixed(2)}
*Precio actual:* $${currentPrice.toFixed(2)}
*Cantidad vendida:* ${sellAmount.toFixed(8)}

${pnlEmoji} *P&L:* ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%)
        `.trim(), "trades");
      }
      
      if (success) {
        // Reduce position amount by what was sold
        position.amount -= sellAmount;
        
        // Use epsilon comparison for floating-point safety (treat < 0.00000001 as zero)
        const EPSILON = 1e-8;
        const positionIsEmpty = shouldSellFull || position.amount < EPSILON;
        
        if (positionIsEmpty) {
          this.openPositions.delete(lotId);
          await this.deletePositionFromDBByLotId(lotId);
          log(`SMART_GUARD ${pair} (${lotId}): Posici√≥n cerrada completamente`, "trading");
        } else {
          // Partial sell (scale-out) - save reduced position
          this.openPositions.set(lotId, position);
          await this.savePositionToDB(pair, position);
          log(`SMART_GUARD ${pair} (${lotId}): Venta parcial, restante: ${position.amount.toFixed(8)}`, "trading");
        }
        this.lastTradeTime.set(pair, Date.now());
      }
    }
  }

  private async analyzePairAndTrade(
    pair: string,
    strategy: string,
    riskConfig: RiskConfig,
    balances: any
  ) {
    try {
      const lastTrade = this.lastTradeTime.get(pair) || 0;
      if (Date.now() - lastTrade < this.MIN_TRADE_INTERVAL_MS) {
        return;
      }

      const krakenPair = this.formatKrakenPair(pair);
      const ticker = await this.krakenService.getTicker(krakenPair);
      const tickerData: any = Object.values(ticker)[0];
      
      if (!tickerData) return;

      const currentPrice = parseFloat(tickerData.c?.[0] || "0");
      const high24h = parseFloat(tickerData.h?.[1] || tickerData.h?.[0] || "0");
      const low24h = parseFloat(tickerData.l?.[1] || tickerData.l?.[0] || "0");
      const volume = parseFloat(tickerData.v?.[1] || tickerData.v?.[0] || "0");

      this.updatePriceHistory(pair, {
        price: currentPrice,
        timestamp: Date.now(),
        high: high24h,
        low: low24h,
        volume,
      });

      const history = this.priceHistory.get(pair) || [];
      if (history.length < 5) return;

      const signal = await this.analyzeWithStrategy(strategy, pair, history, currentPrice);
      
      // Registrar resultado del escaneo
      const signalStr = signal.action === "hold" ? "NONE" : signal.action.toUpperCase();
      const botConfigForScan = await storage.getBotConfig();
      const exposure = this.getAvailableExposure(pair, botConfigForScan, this.currentUsdBalance);
      this.lastScanResults.set(pair, {
        signal: signalStr,
        reason: signal.reason || "Sin se√±al",
        cooldownSec: this.getCooldownRemainingSec(pair),
        exposureAvailable: exposure.maxAllowed,
      });
      
      if (signal.action === "hold" || signal.confidence < 0.6) {
        return;
      }

      const assetBalance = this.getAssetBalance(pair, balances);
      const existingPositions = this.getPositionsByPair(pair);
      const existingPosition = existingPositions[0];

      if (signal.action === "buy") {
        if (this.isPairInCooldown(pair)) {
          const cooldownSec = this.getCooldownRemainingSec(pair);
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - par en cooldown`, {
            pair,
            signal: "BUY",
            reason: "PAIR_COOLDOWN",
            cooldownRemainingSec: cooldownSec,
            signalReason: signal.reason,
          });
          return;
        }

        // MODO SINGLE o SMART_GUARD: Bloquear compras si ya hay posici√≥n abierta
        const botConfigCheck = await storage.getBotConfig();
        const positionMode = botConfigCheck?.positionMode || "SINGLE";
        const sgMaxLotsPerPair = botConfigCheck?.sgMaxOpenLotsPerPair ?? 1;
        
        // En SINGLE siempre 1 slot. En SMART_GUARD respetamos sgMaxOpenLotsPerPair.
        const maxLotsForMode = positionMode === "SMART_GUARD" ? sgMaxLotsPerPair : 1;
        const currentOpenLots = this.countLotsForPair(pair);
        
        if ((positionMode === "SINGLE" || positionMode === "SMART_GUARD") && currentOpenLots >= maxLotsForMode) {
          const reasonCode = positionMode === "SMART_GUARD" 
            ? "SMART_GUARD_MAX_LOTS_REACHED" 
            : "SINGLE_MODE_POSITION_EXISTS";
          
          log(`${pair}: Compra bloqueada - Modo ${positionMode}, lotes abiertos ${currentOpenLots}/${maxLotsForMode}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - m√°ximo de lotes alcanzado`, {
            pair,
            signal: "BUY",
            reason: reasonCode,
            currentOpenLots,
            maxOpenLots: maxLotsForMode,
            existingAmount: existingPosition?.amount || 0,
            signalReason: signal.reason,
          });
          this.lastScanResults.set(pair, {
            signal: "BUY",
            reason: reasonCode,
            exposureAvailable: 0,
          });
          return;
        }

        // MEJORA 4: Verificar cooldown post stop-loss
        if (this.isPairInStopLossCooldown(pair)) {
          const cooldownSec = this.getStopLossCooldownRemainingSec(pair);
          log(`${pair}: En cooldown post stop-loss`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - cooldown post stop-loss`, {
            pair,
            signal: "BUY",
            reason: "STOPLOSS_COOLDOWN",
            cooldownRemainingSec: cooldownSec,
            signalReason: signal.reason,
          });
          return;
        }

        // MEJORA 1: Verificar spread antes de comprar
        const spreadCheck = this.isSpreadAcceptable(tickerData);
        if (!spreadCheck.acceptable) {
          log(`${pair}: Spread demasiado alto (${spreadCheck.spreadPct.toFixed(3)}% > ${MAX_SPREAD_PCT}%)`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - spread alto`, {
            pair,
            signal: "BUY",
            reason: "SPREAD_TOO_HIGH",
            spreadPct: spreadCheck.spreadPct,
            maxSpreadPct: MAX_SPREAD_PCT,
            signalReason: signal.reason,
          });
          return;
        }

        if (existingPosition && existingPosition.amount * currentPrice > riskConfig.maxTradeUSD * 2) {
          log(`Posici√≥n existente en ${pair} ya es grande: $${(existingPosition.amount * currentPrice).toFixed(2)}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - posici√≥n existente demasiado grande`, {
            pair,
            signal: "BUY",
            reason: "POSITION_TOO_LARGE",
            currentPositionUsd: existingPosition.amount * currentPrice,
            maxTradeUsd: riskConfig.maxTradeUSD * 2,
          });
          return;
        }

        const minVolume = this.getOrderMin(pair);
        const minRequiredUSD = minVolume * currentPrice;
        const freshUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || "0");

        if (freshUsdBalance < minRequiredUSD) {
          log(`Saldo USD insuficiente para ${pair}: $${freshUsdBalance.toFixed(2)} < $${minRequiredUSD.toFixed(2)}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - fondos insuficientes`, {
            pair,
            signal: "BUY",
            reason: "INSUFFICIENT_FUNDS",
            availableUsd: freshUsdBalance,
            minRequiredUsd: minRequiredUSD,
          });
          this.setPairCooldown(pair);
          return;
        }

        const botConfig = await storage.getBotConfig();
        const riskPerTradePct = parseFloat(botConfig?.riskPerTradePct?.toString() || "15");
        const takeProfitPct = parseFloat(botConfig?.takeProfitPercent?.toString() || "7");
        
        // === C√ÅLCULO DE TAMA√ëO DE ORDEN (tradeAmountUSD) ===
        // SMART_GUARD v2: sgMinEntryUsd es un "objetivo preferido", no un bloqueo
        // - Si saldo >= sgMinEntryUsd ‚Üí usar sgMinEntryUsd exactamente (no m√°s)
        // - Si saldo < sgMinEntryUsd ‚Üí fallback autom√°tico a saldo disponible
        // - floorUsd = max(exchangeMin, absoluteMin) ‚Üí hard block si saldo < floorUsd
        let tradeAmountUSD: number;
        let wasAdjusted = false;
        let originalAmount: number;
        let sgReasonCode: SmartGuardReasonCode | undefined;
        
        // Para SMART_GUARD: calcular orderUsdProposed por l√≥gica normal, luego validar m√≠nimos
        const sgParams = positionMode === "SMART_GUARD" ? this.getSmartGuardParams(pair, botConfig) : null;
        const sgMinEntryUsd = sgParams?.sgMinEntryUsd || 100;
        const sgAllowUnderMin = sgParams?.sgAllowUnderMin ?? true; // DEPRECATED - se ignora
        const sgFeeCushionPct = sgParams?.sgFeeCushionPct || 0;
        const sgFeeCushionAuto = sgParams?.sgFeeCushionAuto ?? false;
        
        // Calcular fee cushion efectivo (auto = 2 * KRAKEN_FEE_PCT)
        const effectiveCushionPct = sgFeeCushionAuto ? (KRAKEN_FEE_PCT * 2) : sgFeeCushionPct;
        
        // usdDisponible = saldo real disponible (sin buffer en SMART_GUARD v2 para sizing exacto)
        const usdDisponible = freshUsdBalance;
        
        // === NUEVA L√ìGICA SMART_GUARD v2 ===
        // floorUsd = max(minOrderExchangeUsd, MIN_ORDER_ABSOLUTE_USD) - HARD BLOCK
        const floorUsd = Math.max(SG_ABSOLUTE_MIN_USD, minRequiredUSD);
        
        // availableAfterCushion = saldo menos reserva para fees
        const cushionAmount = freshUsdBalance * (effectiveCushionPct / 100);
        const availableAfterCushion = usdDisponible - cushionAmount;
        
        if (positionMode === "SMART_GUARD") {
          // === SMART_GUARD v2 SIZING ===
          // Regla 1: sgMinEntryUsd es "objetivo preferido"
          // Regla 2: Si saldo >= sgMinEntryUsd ‚Üí usar sgMinEntryUsd EXACTO
          // Regla 3: Si saldo < sgMinEntryUsd ‚Üí fallback a saldo disponible (si >= floorUsd)
          // Regla 4: Si saldo < floorUsd ‚Üí BLOQUEAR
          
          originalAmount = sgMinEntryUsd; // El objetivo propuesto siempre es sgMinEntryUsd
          
          if (availableAfterCushion >= sgMinEntryUsd) {
            // Caso A: Saldo suficiente ‚Üí usar sgMinEntryUsd EXACTO (no m√°s)
            tradeAmountUSD = sgMinEntryUsd;
            sgReasonCode = "SMART_GUARD_ENTRY_USING_CONFIG_MIN";
            
          } else if (availableAfterCushion >= floorUsd) {
            // Caso B: Saldo insuficiente para config, pero >= floorUsd ‚Üí fallback autom√°tico
            tradeAmountUSD = availableAfterCushion;
            sgReasonCode = "SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE";
            
          } else if (usdDisponible >= floorUsd && availableAfterCushion < floorUsd) {
            // Caso C: Fee cushion lo baja de floorUsd ‚Üí se bloquear√° en validaci√≥n
            tradeAmountUSD = availableAfterCushion;
            sgReasonCode = "SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION";
            
          } else {
            // Caso D: Saldo < floorUsd ‚Üí se bloquear√° en validaci√≥n
            tradeAmountUSD = usdDisponible;
            sgReasonCode = "SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN";
          }
          
          log(`SMART_GUARD ${pair}: Sizing v2 - order=$${tradeAmountUSD.toFixed(2)}, reason=${sgReasonCode}`, "trading");
          log(`  ‚Üí availableUsd=$${usdDisponible.toFixed(2)}, sgMinEntryUsd=$${sgMinEntryUsd.toFixed(2)}, floorUsd=$${floorUsd.toFixed(2)} [exch=$${minRequiredUSD.toFixed(2)}, abs=$${SG_ABSOLUTE_MIN_USD}]`, "trading");
          log(`  ‚Üí cushionPct=${effectiveCushionPct.toFixed(2)}%, cushionAmt=$${cushionAmount.toFixed(2)}, availableAfterCushion=$${availableAfterCushion.toFixed(2)}`, "trading");
          log(`  ‚Üí sgAllowUnderMin=${sgAllowUnderMin} (DEPRECATED - ignorado, siempre fallback autom√°tico)`, "trading");
          
          // La validaci√≥n final de m√≠nimos se hace DESPU√âS con validateMinimumsOrSkip()
        } else {
          // Modos SINGLE/DCA: l√≥gica original con exposure limits
          
          // Verificar que el take-profit sea rentable despu√©s de comisiones
          const profitCheck = this.isProfitableAfterFees(takeProfitPct);
          if (!profitCheck.isProfitable) {
            log(`${pair}: Trade rechazado - Take-Profit (${takeProfitPct}%) < m√≠nimo rentable (${profitCheck.minProfitRequired.toFixed(2)}%). Fees round-trip: ${profitCheck.roundTripFees.toFixed(2)}%`, "trading");
            
            await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - take-profit menor que fees`, {
              pair,
              signal: "BUY",
              reason: "LOW_PROFITABILITY",
              takeProfitPct,
              roundTripFees: profitCheck.roundTripFees,
              minProfitRequired: profitCheck.minProfitRequired,
              netExpectedProfit: profitCheck.netExpectedProfit,
            });
            
            return;
          }
          
          tradeAmountUSD = freshUsdBalance * (riskPerTradePct / 100);
          tradeAmountUSD = Math.min(tradeAmountUSD, riskConfig.maxTradeUSD);

          // MEJORA 3: Position sizing din√°mico basado en confianza
          const confidenceFactor = this.getConfidenceSizingFactor(signal.confidence);
          const originalBeforeConfidence = tradeAmountUSD;
          tradeAmountUSD = tradeAmountUSD * confidenceFactor;
          
          if (confidenceFactor < 1.0) {
            log(`${pair}: Sizing ajustado por confianza (${(signal.confidence * 100).toFixed(0)}%): $${originalBeforeConfidence.toFixed(2)} -> $${tradeAmountUSD.toFixed(2)} (${(confidenceFactor * 100).toFixed(0)}%)`, "trading");
          }

          if (tradeAmountUSD < minRequiredUSD && freshUsdBalance >= minRequiredUSD) {
            const smallAccountAmount = freshUsdBalance * SMALL_ACCOUNT_FACTOR;
            tradeAmountUSD = Math.min(smallAccountAmount, riskConfig.maxTradeUSD);
          }
          
          originalAmount = tradeAmountUSD;
        }

        const exposure = this.getAvailableExposure(pair, botConfig, freshUsdBalance);
        const maxByBalance = Math.max(0, freshUsdBalance * 0.95);
        // POL√çTICA UNIFICADA: SMART_GUARD S√ç respeta maxTotalExposurePct para evitar sobreapalancamiento
        // Pero NO aplica maxPairExposurePct (permite concentraci√≥n en un par si hay se√±al fuerte)
        const effectiveMaxAllowed = positionMode === "SMART_GUARD" 
          ? Math.min(exposure.maxTotalAvailable, maxByBalance)  // Solo limita por exposici√≥n TOTAL
          : Math.min(exposure.maxAllowed, maxByBalance);  // SINGLE/DCA limita por par Y total
        
        if (effectiveMaxAllowed < minRequiredUSD) {
          log(`${pair}: Sin exposici√≥n disponible. Disponible: $${effectiveMaxAllowed.toFixed(2)}, M√≠nimo: $${minRequiredUSD.toFixed(2)}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - sin exposici√≥n disponible`, {
            pair,
            signal: "BUY",
            reason: "EXPOSURE_ZERO",
            exposureAvailable: effectiveMaxAllowed,
            minRequiredUsd: minRequiredUSD,
          });
          this.setPairCooldown(pair);
          
          if (this.shouldSendExposureAlert(pair)) {
            await botLogger.info("PAIR_COOLDOWN", `${pair} en cooldown - sin exposici√≥n disponible`, {
              pair,
              maxAllowed: effectiveMaxAllowed,
              minRequired: minRequiredUSD,
              cooldownMinutes: this.COOLDOWN_DURATION_MS / 60000,
            });

            if (this.telegramService.isInitialized()) {
              await this.telegramService.sendAlertToMultipleChats(`
‚è∏Ô∏è *Par en Espera*

*${pair}* sin exposici√≥n disponible.
*Disponible:* $${exposure.maxAllowed.toFixed(2)}
*M√≠nimo requerido:* $${minRequiredUSD.toFixed(2)}

_Cooldown: ${this.COOLDOWN_DURATION_MS / 60000} min. Se reintentar√° autom√°ticamente._
              `.trim(), "system");
            }
          }
          return;
        }

        // Ajustar por l√≠mite de exposici√≥n (solo para SINGLE/DCA, SMART_GUARD ya valid√≥ arriba)
        if (positionMode !== "SMART_GUARD" && tradeAmountUSD > effectiveMaxAllowed) {
          originalAmount = tradeAmountUSD;
          tradeAmountUSD = effectiveMaxAllowed;
          wasAdjusted = true;
          
          log(`${pair}: Trade ajustado de $${originalAmount.toFixed(2)} a $${tradeAmountUSD.toFixed(2)} (l√≠mite exposici√≥n)`, "trading");
          
          await botLogger.info("TRADE_ADJUSTED", `Trade ajustado por l√≠mite de exposici√≥n`, {
            pair,
            originalAmountUsd: originalAmount,
            adjustedAmountUsd: tradeAmountUSD,
            maxPairAvailable: exposure.maxPairAvailable,
            maxTotalAvailable: exposure.maxTotalAvailable,
            riskPerTradePct,
          });
        }

        const tradeVolume = tradeAmountUSD / currentPrice;

        if (tradeVolume < minVolume) {
          log(`${pair}: Volumen ${tradeVolume.toFixed(8)} < m√≠nimo ${minVolume}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - volumen < m√≠nimo`, {
            pair,
            signal: "BUY",
            reason: "VOLUME_BELOW_MINIMUM",
            calculatedVolume: tradeVolume,
            minVolume,
          });
          this.setPairCooldown(pair);
          return;
        }

        // === VALIDACI√ìN FINAL √öNICA Y CENTRALIZADA (fuente de verdad) ===
        // Se ejecuta ANTES de executeTrade() para REAL y DRY_RUN
        const orderUsdFinal = tradeAmountUSD;
        const envPrefix = environment.isReplit ? "REPLIT/DEV" : "NAS/PROD";
        const currentOpenLotsForLog = this.countLotsForPair(pair);
        const sgMaxLotsPerPairConfig = botConfig?.sgMaxOpenLotsPerPair ?? 1;
        const maxLotsForModeConfig = positionMode === "SMART_GUARD" ? sgMaxLotsPerPairConfig : 1;
        
        const validationResult = validateMinimumsOrSkip({
          positionMode,
          orderUsdFinal,
          orderUsdProposed: originalAmount || tradeAmountUSD,
          usdDisponible: freshUsdBalance,
          exposureAvailable: effectiveMaxAllowed,
          pair,
          sgMinEntryUsd,
          sgAllowUnderMin, // DEPRECATED - se ignora en validaci√≥n
          dryRun: this.dryRunMode,
          env: envPrefix,
          floorUsd: positionMode === "SMART_GUARD" ? floorUsd : undefined,
          availableAfterCushion: positionMode === "SMART_GUARD" ? availableAfterCushion : undefined,
        });
        
        if (!validationResult.valid) {
          // === [BUY_EVAL] LOGS v2: Valores detallados para auditor√≠a ===
          log(`[BUY_EVAL] ${pair}: mode=${positionMode}, sgReasonCode=${sgReasonCode}`, "trading");
          log(`[BUY_EVAL] ${pair}: availableUsd=$${usdDisponible.toFixed(2)}, sgMinEntryUsd=$${sgMinEntryUsd.toFixed(2)}, floorUsd=$${floorUsd.toFixed(2)}`, "trading");
          log(`[BUY_EVAL] ${pair}: orderUsd=$${orderUsdFinal.toFixed(2)}, availableAfterCushion=$${availableAfterCushion.toFixed(2)}`, "trading");
          log(`[BUY_EVAL] ${pair}: currentOpenLots=${currentOpenLotsForLog}/${maxLotsForModeConfig}`, "trading");
          log(`[BUY_EVAL] ${pair}: DECISION skipReason=${validationResult.skipReason} msg=${validationResult.message}`, "trading");
          log(`[FINAL CHECK] ${pair}: SKIP - ${validationResult.message}`, "trading");
          
          this.lastScanResults.set(pair, {
            signal: "BUY",
            reason: validationResult.skipReason!,
            exposureAvailable: orderUsdFinal,
          });
          
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY bloqueada - ${validationResult.skipReason}`, {
            pair,
            signal: "BUY",
            reason: validationResult.skipReason,
            sgReasonCode,
            ...validationResult.meta,
          });
          
          this.setPairCooldown(pair);
          return;
        }
        
        // Log de decisi√≥n final antes de ejecutar (con nuevo reason code)
        if (positionMode === "SMART_GUARD" && sgReasonCode) {
          log(`[FINAL CHECK] ${pair}: ALLOWED - ${sgReasonCode} orderUsd=$${orderUsdFinal.toFixed(2)}`, "trading");
        }

        if (wasAdjusted) {
          log(`${pair}: Ejecutando compra AJUSTADA $${tradeAmountUSD.toFixed(2)} (original: $${originalAmount.toFixed(2)})`, "trading");
        } else {
          log(`${pair}: Ejecutando compra $${tradeAmountUSD.toFixed(2)} (${riskPerTradePct}% de $${freshUsdBalance.toFixed(2)})`, "trading");
        }

        const adjustmentInfo = wasAdjusted ? {
          wasAdjusted: true,
          originalAmountUsd: originalAmount,
          adjustedAmountUsd: tradeAmountUSD
        } : undefined;
        
        // Meta completa para trazabilidad v2
        const executionMeta = {
          mode: positionMode,
          usdDisponible: freshUsdBalance,
          orderUsdProposed: originalAmount || tradeAmountUSD,
          orderUsdFinal,
          sgMinEntryUsd,
          floorUsd,
          availableAfterCushion,
          sgReasonCode,
          sgAllowUnderMin_DEPRECATED: sgAllowUnderMin,
          dryRun: this.dryRunMode,
          env: envPrefix,
        };

        const success = await this.executeTrade(pair, "buy", tradeVolume.toFixed(8), currentPrice, signal.reason, adjustmentInfo, undefined, executionMeta);
        if (success) {
          this.lastTradeTime.set(pair, Date.now());
        }

      } else if (signal.action === "sell") {
        if (assetBalance <= 0 && (!existingPosition || existingPosition.amount <= 0)) {
          await botLogger.info("TRADE_SKIPPED", `Se√±al SELL ignorada - sin posici√≥n para vender`, {
            pair,
            signal: "SELL",
            reason: "NO_POSITION",
            assetBalance,
            signalReason: signal.reason,
          });
          return;
        }

        // === FIX: Vender lote completo, no 50% ===
        // Usar min(lot.amount, realAssetBalance) para evitar insufficient funds
        // Si no hay lot trackeado, usar balance real del wallet
        const lotAmount = existingPosition?.amount ?? assetBalance;
        const realAssetBalance = assetBalance;
        const rawSellVolume = Math.min(lotAmount, realAssetBalance);
        
        // Normalizar al stepSize de Kraken para evitar errores de precisi√≥n
        const sellVolume = this.normalizeVolume(pair, rawSellVolume);
        
        const minVolumeSell = this.getOrderMin(pair);
        const sellValueUsd = sellVolume * currentPrice;

        // === DUST DETECTION: No intentar vender si es dust ===
        if (sellVolume < minVolumeSell) {
          await botLogger.info("TRADE_SKIPPED", `SELL skipped - dust position (volumen < m√≠nimo)`, {
            pair,
            signal: "SELL",
            reason: "DUST_POSITION",
            lotAmount,
            realAssetBalance,
            sellVolume,
            minVolume: minVolumeSell,
            sellValueUsd,
            signalReason: signal.reason,
          });
          return;
        }
        
        if (sellValueUsd < DUST_THRESHOLD_USD) {
          await botLogger.info("TRADE_SKIPPED", `SELL skipped - dust position (valor < $${DUST_THRESHOLD_USD})`, {
            pair,
            signal: "SELL",
            reason: "DUST_POSITION",
            lotAmount,
            realAssetBalance,
            sellVolume,
            sellValueUsd,
            dustThresholdUsd: DUST_THRESHOLD_USD,
            signalReason: signal.reason,
          });
          return;
        }

        log(`${pair}: SELL signal - vendiendo ${sellVolume.toFixed(8)} (lot: ${lotAmount.toFixed(8)}, balance: ${realAssetBalance.toFixed(8)}, value: $${sellValueUsd.toFixed(2)})`, "trading");

        const sellContext = existingPosition 
          ? { entryPrice: existingPosition.entryPrice, aiSampleId: existingPosition.aiSampleId }
          : undefined;
        const success = await this.executeTrade(pair, "sell", sellVolume.toFixed(8), currentPrice, signal.reason, undefined, undefined, undefined, sellContext);
        if (success) {
          this.lastTradeTime.set(pair, Date.now());
        }
      }
    } catch (error: any) {
      log(`Error analizando ${pair}: ${error.message}`, "trading");
    }
  }

  private async analyzePairAndTradeWithCandles(
    pair: string,
    timeframe: string,
    candle: OHLCCandle,
    riskConfig: RiskConfig,
    balances: any
  ) {
    try {
      const lastTrade = this.lastTradeTime.get(pair) || 0;
      if (Date.now() - lastTrade < this.MIN_TRADE_INTERVAL_MS) {
        return;
      }

      const signal = await this.analyzeWithCandleStrategy(pair, timeframe, candle);
      const strategyId = `momentum_candles_${timeframe}`;
      
      // Registrar resultado del escaneo para candles
      const signalStr = signal.action === "hold" ? "NONE" : signal.action.toUpperCase();
      const botConfigForScan = await storage.getBotConfig();
      const exposureScan = this.getAvailableExposure(pair, botConfigForScan, this.currentUsdBalance);
      this.lastScanResults.set(pair, {
        signal: signalStr,
        reason: signal.reason || "Sin se√±al",
        cooldownSec: this.getCooldownRemainingSec(pair),
        exposureAvailable: exposureScan.maxAllowed,
      });
      
      if (signal.action === "hold" || signal.confidence < 0.6) {
        return;
      }

      const krakenPair = this.formatKrakenPair(pair);
      const ticker = await this.krakenService.getTicker(krakenPair);
      const tickerData: any = Object.values(ticker)[0];
      if (!tickerData) return;

      const currentPrice = parseFloat(tickerData.c?.[0] || "0");
      const assetBalance = this.getAssetBalance(pair, balances);
      const existingPositions = this.getPositionsByPair(pair);
      const existingPosition = existingPositions[0];

      if (signal.action === "buy") {
        if (this.isPairInCooldown(pair)) {
          const cooldownSec = this.getCooldownRemainingSec(pair);
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - par en cooldown`, {
            pair,
            signal: "BUY",
            reason: "PAIR_COOLDOWN",
            cooldownRemainingSec: cooldownSec,
            signalReason: signal.reason,
          });
          return;
        }

        // MODO SINGLE o SMART_GUARD: Bloquear compras si ya hay posici√≥n abierta
        const botConfigCheck = await storage.getBotConfig();
        const positionMode = botConfigCheck?.positionMode || "SINGLE";
        const sgMaxLotsPerPair = botConfigCheck?.sgMaxOpenLotsPerPair ?? 1;
        
        // En SINGLE siempre 1 slot. En SMART_GUARD respetamos sgMaxOpenLotsPerPair.
        const maxLotsForMode = positionMode === "SMART_GUARD" ? sgMaxLotsPerPair : 1;
        const currentOpenLots = this.countLotsForPair(pair);
        
        if ((positionMode === "SINGLE" || positionMode === "SMART_GUARD") && currentOpenLots >= maxLotsForMode) {
          const reasonCode = positionMode === "SMART_GUARD" 
            ? "SMART_GUARD_MAX_LOTS_REACHED" 
            : "SINGLE_MODE_POSITION_EXISTS";
          
          log(`${pair}: Compra bloqueada - Modo ${positionMode}, lotes abiertos ${currentOpenLots}/${maxLotsForMode}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - m√°ximo de lotes alcanzado`, {
            pair,
            signal: "BUY",
            reason: reasonCode,
            currentOpenLots,
            maxOpenLots: maxLotsForMode,
            existingAmount: existingPosition?.amount || 0,
            signalReason: signal.reason,
          });
          this.lastScanResults.set(pair, {
            signal: "BUY",
            reason: reasonCode,
            exposureAvailable: 0,
          });
          return;
        }

        if (this.isPairInStopLossCooldown(pair)) {
          const cooldownSec = this.getStopLossCooldownRemainingSec(pair);
          log(`${pair}: En cooldown post stop-loss`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - cooldown post stop-loss`, {
            pair,
            signal: "BUY",
            reason: "STOPLOSS_COOLDOWN",
            cooldownRemainingSec: cooldownSec,
            signalReason: signal.reason,
          });
          return;
        }

        const spreadCheck = this.isSpreadAcceptable(tickerData);
        if (!spreadCheck.acceptable) {
          log(`${pair}: Spread demasiado alto (${spreadCheck.spreadPct.toFixed(3)}% > ${MAX_SPREAD_PCT}%)`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - spread alto`, {
            pair,
            signal: "BUY",
            reason: "SPREAD_TOO_HIGH",
            spreadPct: spreadCheck.spreadPct,
            maxSpreadPct: MAX_SPREAD_PCT,
            signalReason: signal.reason,
          });
          return;
        }

        if (existingPosition && existingPosition.amount * currentPrice > riskConfig.maxTradeUSD * 2) {
          log(`Posici√≥n existente en ${pair} ya es grande: $${(existingPosition.amount * currentPrice).toFixed(2)}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - posici√≥n existente demasiado grande`, {
            pair,
            signal: "BUY",
            reason: "POSITION_TOO_LARGE",
            currentPositionUsd: existingPosition.amount * currentPrice,
            maxTradeUsd: riskConfig.maxTradeUSD * 2,
          });
          return;
        }

        const minVolume = this.getOrderMin(pair);
        const minRequiredUSD = minVolume * currentPrice;
        const freshUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || "0");

        if (freshUsdBalance < minRequiredUSD) {
          log(`Saldo USD insuficiente para ${pair}: $${freshUsdBalance.toFixed(2)} < $${minRequiredUSD.toFixed(2)}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - fondos insuficientes`, {
            pair,
            signal: "BUY",
            reason: "INSUFFICIENT_FUNDS",
            availableUsd: freshUsdBalance,
            minRequiredUsd: minRequiredUSD,
          });
          this.setPairCooldown(pair);
          return;
        }

        const botConfig = await storage.getBotConfig();
        const riskPerTradePct = parseFloat(botConfig?.riskPerTradePct?.toString() || "15");
        const takeProfitPct = parseFloat(botConfig?.takeProfitPercent?.toString() || "7");
        
        // === C√ÅLCULO DE TAMA√ëO DE ORDEN (tradeAmountUSD) - UNIFICADO CON analyzePairAndTrade ===
        let tradeAmountUSD: number;
        let wasAdjusted = false;
        let originalAmount: number;
        let sgReasonCode: SmartGuardReasonCode | undefined;
        
        // SMART_GUARD: obtener par√°metros
        const sgParams = positionMode === "SMART_GUARD" ? this.getSmartGuardParams(pair, botConfig) : null;
        const sgMinEntryUsd = sgParams?.sgMinEntryUsd || 100;
        const sgAllowUnderMin = sgParams?.sgAllowUnderMin ?? true;
        const sgFeeCushionPct = sgParams?.sgFeeCushionPct || 0;
        const sgFeeCushionAuto = sgParams?.sgFeeCushionAuto ?? false;
        
        const effectiveCushionPct = sgFeeCushionAuto ? (KRAKEN_FEE_PCT * 2) : sgFeeCushionPct;
        const usdDisponible = freshUsdBalance;
        const floorUsd = Math.max(SG_ABSOLUTE_MIN_USD, minRequiredUSD);
        const cushionAmount = freshUsdBalance * (effectiveCushionPct / 100);
        const availableAfterCushion = usdDisponible - cushionAmount;
        
        if (positionMode === "SMART_GUARD") {
          // === SMART_GUARD v2 SIZING (mismo que analyzePairAndTrade) ===
          originalAmount = sgMinEntryUsd;
          
          if (availableAfterCushion >= sgMinEntryUsd) {
            tradeAmountUSD = sgMinEntryUsd;
            sgReasonCode = "SMART_GUARD_ENTRY_USING_CONFIG_MIN";
          } else if (availableAfterCushion >= floorUsd) {
            tradeAmountUSD = availableAfterCushion;
            sgReasonCode = "SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE";
          } else if (usdDisponible >= floorUsd && availableAfterCushion < floorUsd) {
            tradeAmountUSD = availableAfterCushion;
            sgReasonCode = "SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION";
          } else {
            tradeAmountUSD = usdDisponible;
            sgReasonCode = "SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN";
          }
          
          log(`SMART_GUARD ${pair} [${strategyId}]: Sizing v2 - order=$${tradeAmountUSD.toFixed(2)}, reason=${sgReasonCode}`, "trading");
          log(`  ‚Üí availableUsd=$${usdDisponible.toFixed(2)}, sgMinEntryUsd=$${sgMinEntryUsd.toFixed(2)}, floorUsd=$${floorUsd.toFixed(2)}`, "trading");
        } else {
          // Modos SINGLE/DCA: l√≥gica original
          const profitCheck = this.isProfitableAfterFees(takeProfitPct);
          if (!profitCheck.isProfitable) {
            log(`${pair}: Trade rechazado - Take-Profit (${takeProfitPct}%) < m√≠nimo rentable`, "trading");
            await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - take-profit menor que fees`, {
              pair,
              signal: "BUY",
              reason: "LOW_PROFITABILITY",
              takeProfitPct,
              roundTripFees: profitCheck.roundTripFees,
              minProfitRequired: profitCheck.minProfitRequired,
              strategyId,
            });
            return;
          }
          
          tradeAmountUSD = freshUsdBalance * (riskPerTradePct / 100);
          tradeAmountUSD = Math.min(tradeAmountUSD, riskConfig.maxTradeUSD);

          const confidenceFactor = this.getConfidenceSizingFactor(signal.confidence);
          tradeAmountUSD = tradeAmountUSD * confidenceFactor;

          if (tradeAmountUSD < minRequiredUSD && freshUsdBalance >= minRequiredUSD) {
            const smallAccountAmount = freshUsdBalance * SMALL_ACCOUNT_FACTOR;
            tradeAmountUSD = Math.min(smallAccountAmount, riskConfig.maxTradeUSD);
          }
          
          originalAmount = tradeAmountUSD;
        }

        const exposure = this.getAvailableExposure(pair, botConfig, freshUsdBalance);
        const maxByBalance = Math.max(0, freshUsdBalance * 0.95);
        const effectiveMaxAllowed = positionMode === "SMART_GUARD"
          ? Math.min(exposure.maxTotalAvailable, maxByBalance)
          : Math.min(exposure.maxAllowed, maxByBalance);
        
        if (effectiveMaxAllowed < minRequiredUSD) {
          log(`${pair}: Sin exposici√≥n disponible`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - sin exposici√≥n disponible`, {
            pair,
            signal: "BUY",
            reason: "EXPOSURE_ZERO",
            exposureAvailable: effectiveMaxAllowed,
            minRequiredUsd: minRequiredUSD,
          });
          this.setPairCooldown(pair);
          return;
        }

        // Ajustar por l√≠mite de exposici√≥n (solo para SINGLE/DCA)
        if (positionMode !== "SMART_GUARD" && tradeAmountUSD > effectiveMaxAllowed) {
          originalAmount = tradeAmountUSD;
          tradeAmountUSD = effectiveMaxAllowed;
          wasAdjusted = true;
        }

        const tradeVolume = tradeAmountUSD / currentPrice;

        if (tradeVolume < minVolume) {
          log(`${pair}: Volumen ${tradeVolume.toFixed(8)} < m√≠nimo ${minVolume}`, "trading");
          await botLogger.info("TRADE_SKIPPED", `Se√±al BUY ignorada - volumen < m√≠nimo`, {
            pair,
            signal: "BUY",
            reason: "VOLUME_BELOW_MINIMUM",
            calculatedVolume: tradeVolume,
            minVolume,
            strategyId,
          });
          this.setPairCooldown(pair);
          return;
        }

        const adjustmentInfo = wasAdjusted ? {
          wasAdjusted: true,
          originalAmountUsd: originalAmount,
          adjustedAmountUsd: tradeAmountUSD
        } : undefined;

        const success = await this.executeTrade(
          pair, 
          "buy", 
          tradeVolume.toFixed(8), 
          currentPrice, 
          `${signal.reason} [${strategyId}]`, 
          adjustmentInfo,
          { strategyId, timeframe, confidence: signal.confidence }
        );
        
        if (success) {
          this.lastTradeTime.set(pair, Date.now());
        }

      } else if (signal.action === "sell") {
        if (assetBalance <= 0 && (!existingPosition || existingPosition.amount <= 0)) {
          await botLogger.info("TRADE_SKIPPED", `Se√±al SELL ignorada - sin posici√≥n para vender`, {
            pair,
            signal: "SELL",
            reason: "NO_POSITION",
            assetBalance,
            strategyId,
            signalReason: signal.reason,
          });
          return;
        }

        // === FIX: Vender lote completo, no 50% ===
        // Si no hay lot trackeado, usar balance real del wallet
        const lotAmount = existingPosition?.amount ?? assetBalance;
        const realAssetBalance = assetBalance;
        const rawSellVolume = Math.min(lotAmount, realAssetBalance);
        const sellVolume = this.normalizeVolume(pair, rawSellVolume);
        
        const minVolumeSell = this.getOrderMin(pair);
        const sellValueUsd = sellVolume * currentPrice;

        // === DUST DETECTION ===
        if (sellVolume < minVolumeSell) {
          await botLogger.info("TRADE_SKIPPED", `SELL skipped - dust position (volumen < m√≠nimo)`, {
            pair,
            signal: "SELL",
            reason: "DUST_POSITION",
            lotAmount,
            realAssetBalance,
            sellVolume,
            minVolume: minVolumeSell,
            sellValueUsd,
            strategyId,
          });
          return;
        }
        
        if (sellValueUsd < DUST_THRESHOLD_USD) {
          await botLogger.info("TRADE_SKIPPED", `SELL skipped - dust position (valor < $${DUST_THRESHOLD_USD})`, {
            pair,
            signal: "SELL",
            reason: "DUST_POSITION",
            lotAmount,
            realAssetBalance,
            sellVolume,
            sellValueUsd,
            dustThresholdUsd: DUST_THRESHOLD_USD,
            strategyId,
          });
          return;
        }

        log(`${pair}: SELL signal [${strategyId}] - vendiendo ${sellVolume.toFixed(8)} (value: $${sellValueUsd.toFixed(2)})`, "trading");

        const sellContext = existingPosition 
          ? { entryPrice: existingPosition.entryPrice, aiSampleId: existingPosition.aiSampleId }
          : undefined;
        const success = await this.executeTrade(pair, "sell", sellVolume.toFixed(8), currentPrice, `${signal.reason} [${strategyId}]`, undefined, undefined, undefined, sellContext);
        if (success) {
          this.lastTradeTime.set(pair, Date.now());
        }
      }
    } catch (error: any) {
      log(`Error analizando ${pair} con velas: ${error.message}`, "trading");
    }
  }

  private async analyzeWithStrategy(
    strategy: string,
    pair: string,
    history: PriceData[],
    currentPrice: number
  ): Promise<TradeSignal> {
    const mtfData = await this.getMultiTimeframeData(pair);
    const mtfAnalysis = mtfData ? this.analyzeMultiTimeframe(mtfData) : null;

    let signal: TradeSignal;
    switch (strategy) {
      case "momentum":
        signal = this.momentumStrategy(pair, history, currentPrice);
        break;
      case "mean_reversion":
        signal = this.meanReversionStrategy(pair, history, currentPrice);
        break;
      case "scalping":
        signal = this.scalpingStrategy(pair, history, currentPrice);
        break;
      case "grid":
        signal = this.gridStrategy(pair, history, currentPrice);
        break;
      default:
        return { action: "hold", pair, confidence: 0, reason: "Estrategia desconocida" };
    }

    if (mtfAnalysis && signal.action !== "hold") {
      const mtfBoost = this.applyMTFFilter(signal, mtfAnalysis);
      if (mtfBoost.filtered) {
        return { action: "hold", pair, confidence: 0.3, reason: `Se√±al filtrada por MTF: ${mtfBoost.reason}` };
      }
      signal.confidence = Math.min(0.95, signal.confidence + mtfBoost.confidenceBoost);
      signal.reason += ` | MTF: ${mtfAnalysis.summary}`;
    }

    return signal;
  }

  private applyMTFFilter(signal: TradeSignal, mtf: TrendAnalysis): { filtered: boolean; confidenceBoost: number; reason: string } {
    if (signal.action === "buy") {
      if (mtf.longTerm === "bearish" && mtf.mediumTerm === "bearish") {
        return { filtered: true, confidenceBoost: 0, reason: "Tendencia 1h y 4h bajista" };
      }
      if (mtf.alignment < -0.5) {
        return { filtered: true, confidenceBoost: 0, reason: `Alineaci√≥n MTF negativa (${mtf.alignment.toFixed(2)})` };
      }
      if (mtf.alignment > 0.5) {
        return { filtered: false, confidenceBoost: 0.15, reason: "Confirmado por MTF alcista" };
      }
      if (mtf.longTerm === "bullish") {
        return { filtered: false, confidenceBoost: 0.1, reason: "Tendencia 4h alcista" };
      }
    }

    if (signal.action === "sell") {
      if (mtf.longTerm === "bullish" && mtf.mediumTerm === "bullish") {
        return { filtered: true, confidenceBoost: 0, reason: "Tendencia 1h y 4h alcista" };
      }
      if (mtf.alignment > 0.5) {
        return { filtered: true, confidenceBoost: 0, reason: `Alineaci√≥n MTF positiva (${mtf.alignment.toFixed(2)})` };
      }
      if (mtf.alignment < -0.5) {
        return { filtered: false, confidenceBoost: 0.15, reason: "Confirmado por MTF bajista" };
      }
      if (mtf.longTerm === "bearish") {
        return { filtered: false, confidenceBoost: 0.1, reason: "Tendencia 4h bajista" };
      }
    }

    return { filtered: false, confidenceBoost: 0, reason: "Sin filtro MTF aplicado" };
  }

  private momentumStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {
    const prices = history.map(h => h.price);
    const shortEMA = this.calculateEMA(prices.slice(-10), 10);
    const longEMA = this.calculateEMA(prices.slice(-20), 20);
    const rsi = this.calculateRSI(prices.slice(-14));
    const macd = this.calculateMACD(prices);
    const bollinger = this.calculateBollingerBands(prices);
    const volumeAnalysis = this.detectAbnormalVolume(history);
    
    const trend = (currentPrice - prices[0]) / prices[0] * 100;
    
    let buySignals = 0;
    let sellSignals = 0;
    const reasons: string[] = [];

    if (shortEMA > longEMA) buySignals++;
    else if (shortEMA < longEMA) sellSignals++;

    if (rsi < 30) { buySignals += 2; reasons.push(`RSI sobrevendido (${rsi.toFixed(0)})`); }
    else if (rsi < 45) { buySignals++; }
    else if (rsi > 70) { sellSignals += 2; reasons.push(`RSI sobrecomprado (${rsi.toFixed(0)})`); }
    else if (rsi > 55) { sellSignals++; }

    if (macd.histogram > 0 && macd.macd > macd.signal) { buySignals++; reasons.push("MACD alcista"); }
    else if (macd.histogram < 0 && macd.macd < macd.signal) { sellSignals++; reasons.push("MACD bajista"); }

    if (bollinger.percentB < 20) { buySignals++; reasons.push("Precio cerca de Bollinger inferior"); }
    else if (bollinger.percentB > 80) { sellSignals++; reasons.push("Precio cerca de Bollinger superior"); }

    if (volumeAnalysis.isAbnormal) {
      if (volumeAnalysis.direction === "bullish") { buySignals++; reasons.push(`Volumen alto alcista (${volumeAnalysis.ratio.toFixed(1)}x)`); }
      else if (volumeAnalysis.direction === "bearish") { sellSignals++; reasons.push(`Volumen alto bajista (${volumeAnalysis.ratio.toFixed(1)}x)`); }
    }

    if (trend > 1) buySignals++;
    else if (trend < -1) sellSignals++;

    const confidence = Math.min(0.95, 0.5 + (Math.max(buySignals, sellSignals) * 0.08));
    
    if (buySignals >= 4 && buySignals > sellSignals && rsi < 70) {
      return {
        action: "buy",
        pair,
        confidence,
        reason: `Momentum alcista: ${reasons.join(", ")} | Se√±ales: ${buySignals} compra vs ${sellSignals} venta`,
      };
    }
    
    if (sellSignals >= 4 && sellSignals > buySignals && rsi > 30) {
      return {
        action: "sell",
        pair,
        confidence,
        reason: `Momentum bajista: ${reasons.join(", ")} | Se√±ales: ${sellSignals} venta vs ${buySignals} compra`,
      };
    }

    return { action: "hold", pair, confidence: 0.3, reason: `Sin se√±al clara (${buySignals} compra / ${sellSignals} venta)` };
  }

  private meanReversionStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {
    const prices = history.map(h => h.price);
    const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
    const stdDev = Math.sqrt(prices.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / prices.length);
    const zScore = (currentPrice - mean) / stdDev;
    
    const bollinger = this.calculateBollingerBands(prices);
    const rsi = this.calculateRSI(prices.slice(-14));
    const volumeAnalysis = this.detectAbnormalVolume(history);
    
    const reasons: string[] = [];
    let confidence = 0.6;

    if (zScore < -2 || bollinger.percentB < 5) {
      confidence += 0.15;
      reasons.push(`Extremadamente sobrevendido (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);
      
      if (rsi < 25) { confidence += 0.1; reasons.push(`RSI muy bajo (${rsi.toFixed(0)})`); }
      if (volumeAnalysis.isAbnormal && volumeAnalysis.direction === "bearish") {
        confidence += 0.05;
        reasons.push("Volumen de capitulaci√≥n");
      }
      
      return {
        action: "buy",
        pair,
        confidence: Math.min(0.95, confidence),
        reason: `Mean Reversion COMPRA: ${reasons.join(", ")}`,
      };
    }
    
    if (zScore < -1.5 || bollinger.percentB < 15) {
      if (rsi < 35) { confidence += 0.1; reasons.push(`RSI bajo (${rsi.toFixed(0)})`); }
      reasons.push(`Sobrevendido (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);
      
      return {
        action: "buy",
        pair,
        confidence: Math.min(0.85, confidence),
        reason: `Mean Reversion COMPRA: ${reasons.join(", ")}`,
      };
    }
    
    if (zScore > 2 || bollinger.percentB > 95) {
      confidence += 0.15;
      reasons.push(`Extremadamente sobrecomprado (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);
      
      if (rsi > 75) { confidence += 0.1; reasons.push(`RSI muy alto (${rsi.toFixed(0)})`); }
      if (volumeAnalysis.isAbnormal && volumeAnalysis.direction === "bullish") {
        confidence += 0.05;
        reasons.push("Volumen de euforia");
      }
      
      return {
        action: "sell",
        pair,
        confidence: Math.min(0.95, confidence),
        reason: `Mean Reversion VENTA: ${reasons.join(", ")}`,
      };
    }
    
    if (zScore > 1.5 || bollinger.percentB > 85) {
      if (rsi > 65) { confidence += 0.1; reasons.push(`RSI alto (${rsi.toFixed(0)})`); }
      reasons.push(`Sobrecomprado (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);
      
      return {
        action: "sell",
        pair,
        confidence: Math.min(0.85, confidence),
        reason: `Mean Reversion VENTA: ${reasons.join(", ")}`,
      };
    }

    return { action: "hold", pair, confidence: 0.3, reason: `Precio en rango normal (Z=${zScore.toFixed(2)})` };
  }

  private scalpingStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {
    if (history.length < 15) {
      return { action: "hold", pair, confidence: 0, reason: "Datos insuficientes para scalping" };
    }

    const prices = history.map(h => h.price);
    const recentPrices = prices.slice(-5);
    const avgPrice = recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length;
    const priceChange = (currentPrice - avgPrice) / avgPrice * 100;
    
    const volatility = this.calculateVolatility(recentPrices);
    const rsi = this.calculateRSI(prices.slice(-14));
    const volumeAnalysis = this.detectAbnormalVolume(history);
    const macd = this.calculateMACD(prices);
    const atr = this.calculateATR(history, 14);
    const atrPercent = this.calculateATRPercent(history, 14);
    
    const reasons: string[] = [];
    let confidence = 0.65;

    // Filtro de volatilidad m√≠nima usando ATR
    if (atrPercent < 0.1) {
      return { action: "hold", pair, confidence: 0.2, reason: `Volatilidad ATR muy baja (${atrPercent.toFixed(2)}%)` };
    }

    // Ajustar umbral de entrada basado en ATR
    const entryThreshold = Math.max(0.2, atrPercent * 0.3);

    if (priceChange < -entryThreshold && volatility > 0.15) {
      reasons.push(`Ca√≠da r√°pida ${priceChange.toFixed(2)}%`);
      reasons.push(`ATR: ${atrPercent.toFixed(2)}%`);
      
      if (volumeAnalysis.isAbnormal && volumeAnalysis.ratio > 1.5) {
        confidence += 0.1;
        reasons.push(`Volumen alto (${volumeAnalysis.ratio.toFixed(1)}x)`);
      }
      if (rsi < 40) {
        confidence += 0.05;
        reasons.push(`RSI bajo (${rsi.toFixed(0)})`);
      }
      if (macd.histogram < 0 && macd.histogram > -0.5) {
        confidence += 0.05;
        reasons.push("MACD cerca de cruce");
      }
      // Bonus de confianza si ATR es alto (m√°s oportunidad de profit)
      if (atrPercent > 0.5) {
        confidence += 0.05;
      }
      
      return {
        action: "buy",
        pair,
        confidence: Math.min(0.9, confidence),
        reason: `Scalping COMPRA: ${reasons.join(", ")}`,
      };
    }
    
    if (priceChange > entryThreshold && volatility > 0.15) {
      reasons.push(`Subida r√°pida +${priceChange.toFixed(2)}%`);
      reasons.push(`ATR: ${atrPercent.toFixed(2)}%`);
      
      if (volumeAnalysis.isAbnormal && volumeAnalysis.ratio > 1.5) {
        confidence += 0.1;
        reasons.push(`Volumen alto (${volumeAnalysis.ratio.toFixed(1)}x)`);
      }
      if (rsi > 60) {
        confidence += 0.05;
        reasons.push(`RSI alto (${rsi.toFixed(0)})`);
      }
      if (atrPercent > 0.5) {
        confidence += 0.05;
      }
      
      return {
        action: "sell",
        pair,
        confidence: Math.min(0.9, confidence),
        reason: `Scalping VENTA: ${reasons.join(", ")}`,
      };
    }

    return { action: "hold", pair, confidence: 0.3, reason: `Sin oportunidad (cambio: ${priceChange.toFixed(2)}%, ATR: ${atrPercent.toFixed(2)}%)` };
  }

  private gridStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {
    if (history.length < 15) {
      return { action: "hold", pair, confidence: 0, reason: "Datos insuficientes para grid" };
    }

    const prices = history.map(h => h.price);
    const high = Math.max(...prices);
    const low = Math.min(...prices);
    
    // Usar ATR para determinar el espaciado del grid din√°micamente
    const atr = this.calculateATR(history, 14);
    const atrPercent = this.calculateATRPercent(history, 14);
    
    // El grid size se basa en ATR para adaptarse a la volatilidad del mercado
    // Usamos 1.5x ATR como espaciado entre niveles del grid
    const atrBasedGridSize = atr * 1.5;
    const rangeBasedGridSize = (high - low) / 5;
    
    // Usamos el mayor de los dos para evitar niveles demasiado cercanos
    const gridSize = Math.max(atrBasedGridSize, rangeBasedGridSize);
    
    if (gridSize <= 0) {
      return { action: "hold", pair, confidence: 0, reason: "Grid size inv√°lido" };
    }
    
    // Calcular niveles basados en precio medio
    const midPrice = (high + low) / 2;
    const distanceFromMid = currentPrice - midPrice;
    const levelFromMid = Math.round(distanceFromMid / gridSize);
    
    const prevPrice = prices[prices.length - 2];
    const prevDistanceFromMid = prevPrice - midPrice;
    const prevLevelFromMid = Math.round(prevDistanceFromMid / gridSize);
    
    // Niveles de soporte/resistencia basados en ATR
    const supportLevel = midPrice - (2 * gridSize);
    const resistanceLevel = midPrice + (2 * gridSize);
    
    let confidence = 0.7;
    
    // Ajustar confianza basado en ATR
    if (atrPercent > 0.5 && atrPercent < 2) {
      confidence += 0.1; // Volatilidad ideal para grid
    } else if (atrPercent > 2) {
      confidence -= 0.1; // Demasiada volatilidad
    }
    
    if (currentPrice <= supportLevel && levelFromMid < prevLevelFromMid) {
      return {
        action: "buy",
        pair,
        confidence: Math.min(0.85, confidence),
        reason: `Grid ATR: Precio en soporte $${supportLevel.toFixed(2)} (ATR: ${atrPercent.toFixed(2)}%, nivel: ${levelFromMid})`,
      };
    }
    
    if (currentPrice >= resistanceLevel && levelFromMid > prevLevelFromMid) {
      return {
        action: "sell",
        pair,
        confidence: Math.min(0.85, confidence),
        reason: `Grid ATR: Precio en resistencia $${resistanceLevel.toFixed(2)} (ATR: ${atrPercent.toFixed(2)}%, nivel: ${levelFromMid})`,
      };
    }

    return { action: "hold", pair, confidence: 0.3, reason: `Grid: Nivel ${levelFromMid}, ATR: ${atrPercent.toFixed(2)}%` };
  }

  private calculateEMA(prices: number[], period: number): number {
    if (prices.length === 0) return 0;
    const multiplier = 2 / (period + 1);
    let ema = prices[0];
    for (let i = 1; i < prices.length; i++) {
      ema = (prices[i] - ema) * multiplier + ema;
    }
    return ema;
  }

  private calculateRSI(prices: number[]): number {
    if (prices.length < 2) return 50;
    
    let gains = 0, losses = 0;
    for (let i = 1; i < prices.length; i++) {
      const change = prices[i] - prices[i - 1];
      if (change > 0) gains += change;
      else losses -= change;
    }
    
    const avgGain = gains / (prices.length - 1);
    const avgLoss = losses / (prices.length - 1);
    
    if (avgLoss === 0) return 100;
    const rs = avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
  }

  private calculateVolatility(prices: number[]): number {
    if (prices.length < 2) return 0;
    const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
    const variance = prices.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / prices.length;
    return (Math.sqrt(variance) / mean) * 100;
  }

  private calculateMACD(prices: number[]): { macd: number; signal: number; histogram: number } {
    if (prices.length < 26) {
      return { macd: 0, signal: 0, histogram: 0 };
    }
    
    const ema12 = this.calculateEMA(prices.slice(-12), 12);
    const ema26 = this.calculateEMA(prices.slice(-26), 26);
    const macd = ema12 - ema26;
    
    const macdHistory: number[] = [];
    for (let i = 26; i <= prices.length; i++) {
      const e12 = this.calculateEMA(prices.slice(i - 12, i), 12);
      const e26 = this.calculateEMA(prices.slice(i - 26, i), 26);
      macdHistory.push(e12 - e26);
    }
    
    const signal = macdHistory.length >= 9 ? this.calculateEMA(macdHistory.slice(-9), 9) : 0;
    const histogram = macd - signal;
    
    return { macd, signal, histogram };
  }

  private calculateBollingerBands(prices: number[], period: number = 20, stdDevMultiplier: number = 2): { 
    upper: number; 
    middle: number; 
    lower: number; 
    percentB: number;
  } {
    if (prices.length < period) {
      const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
      return { upper: avg, middle: avg, lower: avg, percentB: 50 };
    }
    
    const recentPrices = prices.slice(-period);
    const middle = recentPrices.reduce((a, b) => a + b, 0) / period;
    const stdDev = Math.sqrt(
      recentPrices.reduce((sum, p) => sum + Math.pow(p - middle, 2), 0) / period
    );
    
    const upper = middle + (stdDevMultiplier * stdDev);
    const lower = middle - (stdDevMultiplier * stdDev);
    const currentPrice = prices[prices.length - 1];
    const percentB = ((currentPrice - lower) / (upper - lower)) * 100;
    
    return { upper, middle, lower, percentB };
  }

  private calculateATR(history: PriceData[], period: number = 14): number {
    if (history.length < period + 1) {
      return 0;
    }
    
    const trueRanges: number[] = [];
    for (let i = 1; i < history.length; i++) {
      const current = history[i];
      const previous = history[i - 1];
      
      const tr1 = current.high - current.low;
      const tr2 = Math.abs(current.high - previous.price);
      const tr3 = Math.abs(current.low - previous.price);
      
      const trueRange = Math.max(tr1, tr2, tr3);
      trueRanges.push(trueRange);
    }
    
    const recentTRs = trueRanges.slice(-period);
    const atr = recentTRs.reduce((a, b) => a + b, 0) / recentTRs.length;
    
    return atr;
  }

  private calculateATRPercent(history: PriceData[], period: number = 14): number {
    const atr = this.calculateATR(history, period);
    if (history.length === 0 || atr === 0) return 0;
    
    const currentPrice = history[history.length - 1].price;
    return (atr / currentPrice) * 100;
  }

  private detectAbnormalVolume(history: PriceData[]): { isAbnormal: boolean; ratio: number; direction: string } {
    if (history.length < 10) {
      return { isAbnormal: false, ratio: 1, direction: "neutral" };
    }
    
    const volumes = history.map(h => h.volume);
    const currentVolume = volumes[volumes.length - 1];
    const avgVolume = volumes.slice(0, -1).reduce((a, b) => a + b, 0) / (volumes.length - 1);
    
    if (avgVolume <= 0 || !isFinite(avgVolume) || currentVolume <= 0) {
      return { isAbnormal: false, ratio: 1, direction: "neutral" };
    }
    
    const ratio = currentVolume / avgVolume;
    
    if (!isFinite(ratio) || isNaN(ratio)) {
      return { isAbnormal: false, ratio: 1, direction: "neutral" };
    }
    
    const isAbnormal = ratio > 2.0 || ratio < 0.3;
    
    const priceChange = (history[history.length - 1].price - history[history.length - 2].price);
    const direction = priceChange > 0 ? "bullish" : priceChange < 0 ? "bearish" : "neutral";
    
    return { isAbnormal, ratio, direction };
  }

  private updatePriceHistory(pair: string, data: PriceData) {
    if (!this.priceHistory.has(pair)) {
      this.priceHistory.set(pair, []);
    }
    const history = this.priceHistory.get(pair)!;
    history.push(data);
    if (history.length > this.PRICE_HISTORY_LENGTH) {
      history.shift();
    }
  }

  private formatKrakenPair(pair: string): string {
    const pairMap: Record<string, string> = {
      "BTC/USD": "XXBTZUSD",
      "ETH/USD": "XETHZUSD",
      "SOL/USD": "SOLUSD",
      "XRP/USD": "XXRPZUSD",
      "TON/USD": "TONUSD",
      "ETH/BTC": "XETHXXBT",
      "BTC/ETH": "XXBTZXETH",
      "SOL/ETH": "SOLETH",
    };
    return pairMap[pair] || pair.replace("/", "");
  }

  private getAssetBalance(pair: string, balances: any): number {
    const asset = pair.split("/")[0];
    const assetMap: Record<string, string[]> = {
      "BTC": ["XXBT", "XBT", "BTC"],
      "ETH": ["XETH", "ETH"],
      "SOL": ["SOL"],
      "XRP": ["XXRP", "XRP"],
      "TON": ["TON"],
    };
    
    const keys = assetMap[asset] || [asset];
    for (const key of keys) {
      if (balances?.[key]) {
        return parseFloat(balances[key]);
      }
    }
    return 0;
  }

  // === HELPER: Validar cantidad de venta antes de enviar orden ===
  // Solo para flujo SELL/cierre. NO afecta BUY ni sizing global.
  private async validateSellAmount(
    pair: string,
    lotId: string,
    requestedAmount: number
  ): Promise<{
    canSell: boolean;
    sellAmountFinal: number;
    reason: string;
    isDust: boolean;
    realAssetBalance: number;
    orderMin: number;
    stepSize: number;
    needsPositionAdjust: boolean;
  }> {
    const stepSize = this.krakenService.getStepSize(pair) || 0.00000001;
    const orderMin = this.getOrderMin(pair);
    
    // 1) Obtener balance real del asset base
    let freshBalances: any;
    try {
      freshBalances = await this.krakenService.getBalance();
    } catch (error: any) {
      log(`[MANUAL_CLOSE_EVAL] ${pair} ${lotId}: ERROR getBalance - ${error.message}`, "trading");
      return {
        canSell: false,
        sellAmountFinal: 0,
        reason: `Error obteniendo balance de Kraken: ${error.message}`,
        isDust: false,
        realAssetBalance: 0,
        orderMin,
        stepSize,
        needsPositionAdjust: false,
      };
    }
    
    const realAssetBalance = this.getAssetBalance(pair, freshBalances);
    
    // 2) Calcular sellAmount seguro = min(requested, realBalance)
    let sellAmountRaw = Math.min(requestedAmount, realAssetBalance);
    
    // 3) Normalizar al stepSize (truncar, no redondear)
    const decimals = Math.abs(Math.log10(stepSize));
    const sellAmountFinal = Math.floor(sellAmountRaw * Math.pow(10, decimals)) / Math.pow(10, decimals);
    
    // 4) Caso DUST: balance real < orderMin
    if (realAssetBalance < orderMin) {
      const logMsg = `[MANUAL_CLOSE_EVAL] ${pair} ${lotId} | lotAmount=${requestedAmount.toFixed(8)} realBalance=${realAssetBalance.toFixed(8)} orderMin=${orderMin} stepSize=${stepSize} sellFinal=0 decision=DUST`;
      log(logMsg, "trading");
      
      return {
        canSell: false,
        sellAmountFinal: 0,
        reason: `Balance real (${realAssetBalance.toFixed(8)}) menor al m√≠nimo de Kraken (${orderMin}). Posici√≥n marcada como DUST.`,
        isDust: true,
        realAssetBalance,
        orderMin,
        stepSize,
        needsPositionAdjust: false,
      };
    }
    
    // 5) Verificar si sellAmountFinal queda por debajo del m√≠nimo tras normalizar
    if (sellAmountFinal < orderMin) {
      const logMsg = `[MANUAL_CLOSE_EVAL] ${pair} ${lotId} | lotAmount=${requestedAmount.toFixed(8)} realBalance=${realAssetBalance.toFixed(8)} orderMin=${orderMin} stepSize=${stepSize} sellFinal=${sellAmountFinal.toFixed(8)} decision=BELOW_MIN_AFTER_NORMALIZE`;
      log(logMsg, "trading");
      
      return {
        canSell: false,
        sellAmountFinal: 0,
        reason: `Cantidad normalizada (${sellAmountFinal.toFixed(8)}) menor al m√≠nimo de Kraken (${orderMin}).`,
        isDust: true,
        realAssetBalance,
        orderMin,
        stepSize,
        needsPositionAdjust: false,
      };
    }
    
    // 6) Detectar discrepancia: position.amount > realAssetBalance
    const needsPositionAdjust = requestedAmount > realAssetBalance * 1.005; // tolerancia 0.5%
    
    const logMsg = `[MANUAL_CLOSE_EVAL] ${pair} ${lotId} | lotAmount=${requestedAmount.toFixed(8)} realBalance=${realAssetBalance.toFixed(8)} orderMin=${orderMin} stepSize=${stepSize} sellFinal=${sellAmountFinal.toFixed(8)} decision=CAN_SELL${needsPositionAdjust ? " (adjusted)" : ""}`;
    log(logMsg, "trading");
    
    return {
      canSell: true,
      sellAmountFinal,
      reason: needsPositionAdjust 
        ? `Cantidad ajustada de ${requestedAmount.toFixed(8)} a ${sellAmountFinal.toFixed(8)} (balance real)` 
        : "OK",
      isDust: false,
      realAssetBalance,
      orderMin,
      stepSize,
      needsPositionAdjust,
    };
  }

  private async executeTrade(
    pair: string,
    type: "buy" | "sell",
    volume: string,
    price: number,
    reason: string,
    adjustmentInfo?: { wasAdjusted: boolean; originalAmountUsd: number; adjustedAmountUsd: number },
    strategyMeta?: { strategyId: string; timeframe: string; confidence: number },
    executionMeta?: { mode: string; usdDisponible: number; orderUsdProposed: number; orderUsdFinal: number; minOrderUsd: number; allowUnderMin: boolean; dryRun: boolean },
    sellContext?: { entryPrice: number; aiSampleId?: number } // For sells: pass entry price for correct P&L calculation
  ): Promise<boolean> {
    try {
      const volumeNum = parseFloat(volume);
      const totalUSD = volumeNum * price;
      
      // === DRY_RUN MODE: Simular sin enviar orden real ===
      if (this.dryRunMode) {
        const envPrefix = environment.isReplit ? "[REPLIT/DEV][DRY\\_RUN]" : "[NAS/PROD][DRY\\_RUN]";
        const envPrefixLog = environment.isReplit ? "[REPLIT/DEV][DRY_RUN]" : "[NAS/PROD][DRY_RUN]";
        
        // === DOBLE CINTUR√ìN: Validaci√≥n redundante para DRY_RUN ===
        // Si falla m√≠nimos, ni simula ni env√≠a mensaje de trade
        if (type === "buy" && executionMeta) {
          const positionMode = executionMeta.mode || "SINGLE";
          const orderUsdFinal = totalUSD;
          const sgMinEntryUsd = executionMeta.minOrderUsd || 100;
          const sgAllowUnderMin = executionMeta.allowUnderMin ?? true;
          
          const doubleBeltValidation = validateMinimumsOrSkip({
            positionMode,
            orderUsdFinal,
            orderUsdProposed: executionMeta.orderUsdProposed || orderUsdFinal,
            usdDisponible: executionMeta.usdDisponible || 0,
            exposureAvailable: executionMeta.orderUsdFinal || 0,
            pair,
            sgMinEntryUsd,
            sgAllowUnderMin,
            dryRun: true,
            env: envPrefixLog,
          });
          
          if (!doubleBeltValidation.valid) {
            log(`${envPrefixLog} BLOQUEADO - ${doubleBeltValidation.message}`, "trading");
            await botLogger.info("TRADE_SKIPPED", `${envPrefixLog} Trade bloqueado en double-belt`, {
              pair,
              type,
              reason: doubleBeltValidation.skipReason,
              ...doubleBeltValidation.meta,
            });
            // NO enviar Telegram de simulaci√≥n - solo log
            return false;
          }
        }
        
        const simTxid = `DRY-${Date.now()}`;
        log(`${envPrefixLog} SIMULACI√ìN ${type.toUpperCase()} ${volume} ${pair} @ $${price.toFixed(2)} (Total: $${totalUSD.toFixed(2)})`, "trading");
        
        await botLogger.info("DRY_RUN_TRADE", `${envPrefixLog} Trade simulado - NO enviado al exchange`, {
          pair,
          type,
          volume: volumeNum,
          price,
          totalUsd: totalUSD,
          simTxid,
          reason,
          ...(executionMeta || {}),
        });
        
        // Enviar Telegram de simulaci√≥n con prefijo correcto
        if (this.telegramService.isInitialized()) {
          const sgInfo = executionMeta && executionMeta.mode === "SMART_GUARD"
            ? `\n*Min. Orden:* $${executionMeta.minOrderUsd?.toFixed(2) || "N/A"}\n*Permitir Menor:* ${executionMeta.allowUnderMin ? "S√ç" : "NO"}`
            : "";
          
          await this.telegramService.sendMessage(`
üß™ *${envPrefix} Trade Simulado*

*Tipo:* ${type.toUpperCase()}
*Par:* ${pair}
*Cantidad:* ${volume}
*Precio:* $${price.toFixed(2)}
*Total:* $${totalUSD.toFixed(2)}${sgInfo}

_‚ö†Ô∏è Modo simulaci√≥n - NO se envi√≥ orden real_
          `.trim());
        }
        
        return true; // Simular √©xito para flujo normal
      }
      
      log(`Ejecutando ${type.toUpperCase()} ${volume} ${pair} @ $${price.toFixed(2)}`, "trading");
      
      const order = await this.krakenService.placeOrder({
        pair,
        type,
        ordertype: "market",
        volume,
      });

      const txid = order.txid?.[0];
      if (!txid) {
        log(`Orden sin txid - posible fallo`, "trading");
        return false;
      }

      const tradeId = `AUTO-${Date.now()}`;
      await storage.createTrade({
        tradeId,
        pair,
        type,
        price: price.toString(),
        amount: volume,
        status: "filled",
        krakenOrderId: txid,
        executedAt: new Date(),
      });

      // volumeNum ya declarado arriba
      if (type === "buy") {
        this.currentUsdBalance -= volumeNum * price;
        const existingPositions = this.getPositionsByPair(pair);
        const existing = existingPositions[0]; // First position for DCA mode
        let newPosition: OpenPosition;
        
        const entryStrategyId = strategyMeta?.strategyId || "momentum_cycle";
        const entrySignalTf = strategyMeta?.timeframe || "cycle";
        const signalConfidence = strategyMeta?.confidence;
        
        const currentConfig = await storage.getBotConfig();
        const entryMode = currentConfig?.positionMode || "SINGLE";
        
        // In SMART_GUARD with multi-lot, always create new positions
        const shouldCreateNewLot = entryMode === "SMART_GUARD" || !existing || existing.amount <= 0;
        
        if (!shouldCreateNewLot && existing) {
          // DCA mode: update existing position
          const totalAmount = existing.amount + volumeNum;
          const avgPrice = (existing.amount * existing.entryPrice + volumeNum * price) / totalAmount;
          newPosition = { 
            ...existing,
            amount: totalAmount, 
            entryPrice: avgPrice,
            highestPrice: Math.max(existing.highestPrice, price),
          };
          this.openPositions.set(existing.lotId, newPosition);
          log(`DCA entry: ${pair} (${existing.lotId}) - preserved snapshot from original entry`, "trading");
        } else {
          // NEW POSITION: create snapshot of current config with unique lotId
          const lotId = generateLotId(pair);
          
          const configSnapshot: ConfigSnapshot = {
            stopLossPercent: parseFloat(currentConfig?.stopLossPercent?.toString() || "5"),
            takeProfitPercent: parseFloat(currentConfig?.takeProfitPercent?.toString() || "7"),
            trailingStopEnabled: currentConfig?.trailingStopEnabled ?? false,
            trailingStopPercent: parseFloat(currentConfig?.trailingStopPercent?.toString() || "2"),
            positionMode: entryMode,
          };
          
          // Add SMART_GUARD specific params using getSmartGuardParams() for per-pair override support
          if (entryMode === "SMART_GUARD") {
            const sgParams = this.getSmartGuardParams(pair, currentConfig);
            configSnapshot.sgMinEntryUsd = sgParams.sgMinEntryUsd;
            configSnapshot.sgAllowUnderMin = sgParams.sgAllowUnderMin;
            configSnapshot.sgBeAtPct = sgParams.sgBeAtPct;
            configSnapshot.sgFeeCushionPct = sgParams.sgFeeCushionPct;
            configSnapshot.sgFeeCushionAuto = sgParams.sgFeeCushionAuto;
            configSnapshot.sgTrailStartPct = sgParams.sgTrailStartPct;
            configSnapshot.sgTrailDistancePct = sgParams.sgTrailDistancePct;
            configSnapshot.sgTrailStepPct = sgParams.sgTrailStepPct;
            configSnapshot.sgTpFixedEnabled = sgParams.sgTpFixedEnabled;
            configSnapshot.sgTpFixedPct = sgParams.sgTpFixedPct;
            configSnapshot.sgScaleOutEnabled = sgParams.sgScaleOutEnabled;
            configSnapshot.sgScaleOutPct = sgParams.sgScaleOutPct;
            configSnapshot.sgMinPartUsd = sgParams.sgMinPartUsd;
            configSnapshot.sgScaleOutThreshold = sgParams.sgScaleOutThreshold;
          }
          
          newPosition = { 
            lotId,
            pair,
            amount: volumeNum, 
            entryPrice: price,
            highestPrice: price,
            openedAt: Date.now(),
            entryStrategyId,
            entrySignalTf,
            signalConfidence,
            signalReason: reason,
            entryMode,
            configSnapshot,
            // SMART_GUARD initial state
            sgBreakEvenActivated: false,
            sgCurrentStopPrice: undefined,
            sgTrailingActivated: false,
            sgScaleOutDone: false,
          };
          this.openPositions.set(lotId, newPosition);
          
          const lotCount = this.countLotsForPair(pair);
          if (entryMode === "SMART_GUARD") {
            log(`NEW LOT #${lotCount}: ${pair} (${lotId}) - SMART_GUARD snapshot saved (BE=${configSnapshot.sgBeAtPct}%, trail=${configSnapshot.sgTrailDistancePct}%, TP=${configSnapshot.sgTpFixedEnabled ? configSnapshot.sgTpFixedPct + '%' : 'OFF'})`, "trading");
          } else {
            log(`NEW POSITION: ${pair} (${lotId}) - snapshot saved (SL=${configSnapshot.stopLossPercent}%, TP=${configSnapshot.takeProfitPercent}%, trailing=${configSnapshot.trailingStopEnabled}, mode=${entryMode})`, "trading");
          }
        }
        
        // AI Sample collection: save features for ALL buy entries (not just new positions)
        if (!newPosition.aiSampleId) {
          try {
            const features = aiService.extractFeatures({
              rsi: 50, // Will be enriched from actual indicators in future
              confidence: signalConfidence ?? 50,
            });
            const sampleTradeId = `SAMPLE-${Date.now()}-${pair}`;
            const sample = await storage.saveAiSample({
              tradeId: sampleTradeId,
              pair,
              side: "buy",
              entryPrice: price.toString(),
              entryTs: new Date(),
              featuresJson: features,
            });
            if (sample?.id) {
              newPosition.aiSampleId = sample.id;
              log(`[AI] Sample #${sample.id} guardado para ${pair}`, "trading");
            }
          } catch (aiErr: any) {
            log(`[AI] Error guardando sample: ${aiErr.message}`, "trading");
          }
        }
        
        await this.savePositionToDB(pair, newPosition);
      } else {
        // SELL: Update balance and P&L tracking
        // Note: Position management for sells is now handled by the callers 
        // (checkSinglePositionSLTP, checkSmartGuardExit, forceClosePosition)
        // which have the lotId context. This block only updates balance/P&L metrics.
        this.currentUsdBalance += volumeNum * price;
        
        // Calculate P&L using sellContext if provided (for correct per-lot tracking)
        if (sellContext) {
          const pnl = (price - sellContext.entryPrice) * volumeNum;
          this.dailyPnL += pnl;
          log(`P&L de operaci√≥n: $${pnl.toFixed(2)} | P&L diario acumulado: $${this.dailyPnL.toFixed(2)}`, "trading");
          
          // AI Sample update: mark sample complete with PnL result
          if (sellContext.aiSampleId) {
            try {
              await storage.updateAiSample(sellContext.aiSampleId, {
                exitPrice: price.toString(),
                exitTs: new Date(),
                pnlGross: pnl.toString(),
                pnlNet: pnl.toString(),
                labelWin: pnl > 0 ? 1 : 0,
                isComplete: true,
              });
              log(`[AI] Sample #${sellContext.aiSampleId} actualizado: PnL=${pnl.toFixed(2)} (${pnl > 0 ? 'WIN' : 'LOSS'})`, "trading");
            } catch (aiErr: any) {
              log(`[AI] Error actualizando sample: ${aiErr.message}`, "trading");
            }
          }
        } else {
          // No sellContext provided - this is a bug, log warning
          log(`[WARN] Sell ejecutado sin sellContext para ${pair} - P&L no registrado. Todos los sell deben proporcionar sellContext.`, "trading");
        }
        // Position deletion is handled by the caller (checkSinglePositionSLTP, checkSmartGuardExit, etc.)
      }

      const emoji = type === "buy" ? "üü¢" : "üî¥";
      const totalUSDFormatted = totalUSD.toFixed(2);
      
      if (this.telegramService.isInitialized()) {
        let adjustmentNote = "";
        if (adjustmentInfo?.wasAdjusted) {
          adjustmentNote = `\nüìâ _Ajustado por exposici√≥n: $${adjustmentInfo.originalAmountUsd.toFixed(2)} ‚Üí $${adjustmentInfo.adjustedAmountUsd.toFixed(2)}_\n`;
        }
        
        const strategyLabel = strategyMeta?.strategyId ? 
          ((strategyMeta?.timeframe && strategyMeta.timeframe !== "cycle") ? 
            `Momentum (Velas ${strategyMeta.timeframe})` : 
            "Momentum (Ciclos)") : 
          "Momentum (Ciclos)";
        const confidenceLabel = strategyMeta?.confidence ? ` | Confianza: ${(strategyMeta.confidence * 100).toFixed(0)}%` : "";
        
        await this.telegramService.sendMessage(`
${emoji} *Operaci√≥n Autom√°tica Ejecutada*

*Tipo:* ${type.toUpperCase()}
*Par:* ${pair}
*Cantidad:* ${volume}
*Precio:* $${price.toFixed(2)}
*Total:* $${totalUSDFormatted}
*ID:* ${txid}
*Estrategia:* ${strategyLabel}${confidenceLabel}
${adjustmentNote}
*Raz√≥n:* ${reason}

_KrakenBot.AI - Trading Aut√≥nomo_
        `.trim());
      }

      log(`Orden ejecutada: ${txid}`, "trading");
      
      await botLogger.info("TRADE_EXECUTED", `Trade ${type.toUpperCase()} ejecutado en ${pair}`, {
        pair,
        type,
        volume: volumeNum,
        price,
        totalUsd: volumeNum * price,
        txid,
        reason,
        strategyId: strategyMeta?.strategyId || "momentum_cycle",
        timeframe: strategyMeta?.timeframe || "cycle",
        confidence: strategyMeta?.confidence,
      });
      
      // FIFO Matcher: Ingest real sell fill and trigger automatic matching
      // Only runs for real sells - DRY_RUN returns early at line ~3161
      // Triple guard: check dryRunMode AND executionMeta.dryRun for belt-and-suspenders safety
      const isSimulation = this.dryRunMode || (executionMeta?.dryRun ?? false);
      if (type === "sell" && !isSimulation) {
        try {
          const fee = volumeNum * price * (KRAKEN_FEE_PCT / 100); // Use existing fee constant
          await storage.upsertTradeFill({
            txid,
            pair,
            type: "sell",
            price: price.toString(),
            amount: volume,
            fee: fee.toFixed(8),
            matched: false,
          });
          
          const sellFill = await storage.getTradeFillByTxid(txid);
          if (sellFill) {
            const matchResult = await fifoMatcher.processSellFill(sellFill);
            log(`[FIFO] Auto-matched sell ${txid}: matched=${matchResult.totalMatched.toFixed(8)}, lots_closed=${matchResult.lotsClosed}, pnl=$${matchResult.pnlNet.toFixed(2)}`, "trading");
            
            if (matchResult.lotsClosed > 0) {
              await botLogger.info("FIFO_LOTS_CLOSED", `FIFO cerr√≥ ${matchResult.lotsClosed} lotes autom√°ticamente`, {
                pair,
                sellTxid: txid,
                matchedQty: matchResult.totalMatched,
                lotsClosed: matchResult.lotsClosed,
                pnlNet: matchResult.pnlNet,
              });
            }
          }
        } catch (fifoErr: any) {
          log(`[FIFO] Error procesando sell ${txid}: ${fifoErr.message}`, "trading");
        }
      }
      
      return true;
    } catch (error: any) {
      log(`Error ejecutando orden: ${error.message}`, "trading");
      
      await botLogger.error("TRADE_FAILED", `Error ejecutando ${type} en ${pair}`, {
        pair,
        type,
        volume,
        price,
        error: error.message,
      });
      
      if (this.telegramService.isInitialized()) {
        await this.telegramService.sendMessage(`
‚ö†Ô∏è *Error en Operaci√≥n*

*Par:* ${pair}
*Tipo:* ${type}
*Error:* ${error.message}

_KrakenBot.AI_
        `.trim());
      }
      return false;
    }
  }

  private async getMultiTimeframeData(pair: string): Promise<MultiTimeframeData | null> {
    try {
      const cached = this.mtfCache.get(pair);
      if (cached && Date.now() - cached.lastUpdate < this.MTF_CACHE_TTL) {
        return cached;
      }

      const [tf5m, tf1h, tf4h] = await Promise.all([
        this.krakenService.getOHLC(pair, 5),
        this.krakenService.getOHLC(pair, 60),
        this.krakenService.getOHLC(pair, 240),
      ]);

      const data: MultiTimeframeData = {
        tf5m: tf5m.slice(-50),
        tf1h: tf1h.slice(-50),
        tf4h: tf4h.slice(-50),
        lastUpdate: Date.now(),
      };

      this.mtfCache.set(pair, data);
      log(`MTF datos actualizados para ${pair}: 5m=${tf5m.length}, 1h=${tf1h.length}, 4h=${tf4h.length}`, "trading");
      return data;
    } catch (error: any) {
      log(`Error obteniendo datos MTF para ${pair}: ${error.message}`, "trading");
      return null;
    }
  }

  private analyzeTimeframeTrend(candles: OHLCCandle[]): "bullish" | "bearish" | "neutral" {
    if (candles.length < 10) return "neutral";

    const closes = candles.map(c => c.close);
    const ema10 = this.calculateEMA(closes.slice(-10), 10);
    const ema20 = this.calculateEMA(closes.slice(-20), 20);
    const currentPrice = closes[closes.length - 1];

    const priceVsEma10 = (currentPrice - ema10) / ema10 * 100;
    const ema10VsEma20 = (ema10 - ema20) / ema20 * 100;

    let score = 0;
    if (priceVsEma10 > 0.5) score += 2;
    else if (priceVsEma10 > 0) score += 1;
    else if (priceVsEma10 < -0.5) score -= 2;
    else if (priceVsEma10 < 0) score -= 1;

    if (ema10VsEma20 > 0.3) score += 2;
    else if (ema10VsEma20 > 0) score += 1;
    else if (ema10VsEma20 < -0.3) score -= 2;
    else if (ema10VsEma20 < 0) score -= 1;

    const recentCandles = candles.slice(-5);
    const higherHighs = recentCandles.filter((c, i) => i > 0 && c.high > recentCandles[i-1].high).length;
    const lowerLows = recentCandles.filter((c, i) => i > 0 && c.low < recentCandles[i-1].low).length;
    
    if (higherHighs >= 3) score += 1;
    if (lowerLows >= 3) score -= 1;

    if (score >= 3) return "bullish";
    if (score <= -3) return "bearish";
    return "neutral";
  }

  private analyzeMultiTimeframe(mtfData: MultiTimeframeData): TrendAnalysis {
    const shortTerm = this.analyzeTimeframeTrend(mtfData.tf5m);
    const mediumTerm = this.analyzeTimeframeTrend(mtfData.tf1h);
    const longTerm = this.analyzeTimeframeTrend(mtfData.tf4h);

    const trendValues = { bullish: 1, neutral: 0, bearish: -1 };
    const totalScore = trendValues[shortTerm] + trendValues[mediumTerm] * 1.5 + trendValues[longTerm] * 2;
    
    const allAligned = (shortTerm === mediumTerm && mediumTerm === longTerm && shortTerm !== "neutral");
    const twoAligned = (shortTerm === mediumTerm || mediumTerm === longTerm || shortTerm === longTerm);
    
    let alignment = 0;
    let confidence = 0.5;
    
    if (allAligned) {
      alignment = trendValues[shortTerm];
      confidence = 0.9;
    } else if (twoAligned && shortTerm !== "neutral") {
      alignment = totalScore > 0 ? 0.7 : totalScore < 0 ? -0.7 : 0;
      confidence = 0.7;
    } else {
      alignment = totalScore / 4.5;
      confidence = 0.5;
    }

    let summary = "";
    if (allAligned) {
      summary = `Tendencia ${shortTerm === "bullish" ? "ALCISTA" : "BAJISTA"} confirmada en todos los timeframes (5m/1h/4h)`;
    } else {
      summary = `5m: ${shortTerm}, 1h: ${mediumTerm}, 4h: ${longTerm}`;
    }

    return { shortTerm, mediumTerm, longTerm, alignment, confidence, summary };
  }

  isActive(): boolean {
    return this.isRunning;
  }

  // === CIERRE MANUAL DE POSICI√ìN ===
  async forceClosePosition(
    pair: string,
    currentPrice: number,
    correlationId: string,
    reason: string,
    lotId?: string // Optional: specify which lot to close (for multi-lot support)
  ): Promise<{
    success: boolean;
    error?: string;
    orderId?: string;
    pnlUsd?: number;
    pnlPct?: number;
    dryRun?: boolean;
    lotId?: string;
    isDust?: boolean; // Flag para indicar que la posici√≥n es DUST y no se puede cerrar
  }> {
    try {
      // Find the position to close
      let position: OpenPosition | undefined;
      if (lotId) {
        position = this.openPositions.get(lotId);
      } else {
        // Close the first position for this pair
        const positions = this.getPositionsByPair(pair);
        position = positions[0];
      }
      
      if (!position || position.amount <= 0) {
        return {
          success: false,
          error: "No se encontr√≥ posici√≥n abierta en memoria para este par",
        };
      }

      const positionLotId = position.lotId;
      const amount = position.amount;
      const entryPrice = position.entryPrice;
      const pnlUsd = (currentPrice - entryPrice) * amount;
      const pnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;

      log(`[MANUAL_CLOSE] Iniciando cierre de ${pair} (${positionLotId}): ${amount.toFixed(8)} @ $${currentPrice.toFixed(2)}`, "trading");

      // En DRY_RUN, simular el cierre
      if (this.dryRunMode) {
        const simTxid = `MANUAL-DRY-${Date.now()}`;
        log(`[DRY_RUN] SIMULACI√ìN cierre manual ${pair} (${positionLotId}) - ${amount.toFixed(8)} @ $${currentPrice.toFixed(2)}`, "trading");

        // Actualizar memoria y DB para reflejar el cierre (aunque sea simulado)
        this.openPositions.delete(positionLotId);
        await storage.deleteOpenPositionByLotId(positionLotId);

        // Registrar el trade de cierre
        const tradeId = `MANUAL-${Date.now()}`;
        await storage.createTrade({
          tradeId,
          pair,
          type: "sell",
          price: currentPrice.toString(),
          amount: amount.toFixed(8),
          status: "filled",
          krakenOrderId: simTxid,
          entryPrice: entryPrice.toString(),
          realizedPnlUsd: pnlUsd.toString(),
          realizedPnlPct: pnlPct.toString(),
          executedAt: new Date(),
        });

        // Notificar por Telegram
        if (this.telegramService.isInitialized()) {
          await this.telegramService.sendMessage(`
üß™ *[DRY\\_RUN] Cierre Manual Simulado*

*Par:* ${pair}
*Cantidad:* ${amount.toFixed(8)}
*Precio entrada:* $${entryPrice.toFixed(2)}
*Precio salida:* $${currentPrice.toFixed(2)}
*PnL:* ${pnlUsd >= 0 ? "+" : ""}$${pnlUsd.toFixed(2)} (${pnlPct >= 0 ? "+" : ""}${pnlPct.toFixed(2)}%)

_‚ö†Ô∏è Modo simulaci√≥n - NO se envi√≥ orden real_
          `.trim());
        }

        return {
          success: true,
          orderId: simTxid,
          pnlUsd,
          pnlPct,
          dryRun: true,
          lotId: positionLotId,
        };
      }

      // === VALIDACI√ìN PRE-SELL: Verificar balance real y detectar DUST ===
      const validation = await this.validateSellAmount(pair, positionLotId, amount);
      
      if (!validation.canSell) {
        // Caso DUST: no se puede vender, devolver error con flag isDust
        if (validation.isDust) {
          // Enviar alerta Telegram
          if (this.telegramService.isInitialized()) {
            await this.telegramService.sendMessage(`
‚ö†Ô∏è *Posici√≥n DUST Detectada*

*Par:* ${pair}
*Lot:* ${positionLotId}
*Cantidad registrada:* ${amount.toFixed(8)}
*Balance real:* ${validation.realAssetBalance.toFixed(8)}
*M√≠nimo Kraken:* ${validation.orderMin}

_No se puede cerrar - usar "Eliminar hu√©rfana" en UI_
            `.trim());
          }
        }
        
        return {
          success: false,
          error: validation.reason,
          lotId: positionLotId,
          isDust: validation.isDust,
        };
      }
      
      // Si hubo ajuste de cantidad, actualizar posici√≥n interna
      const sellAmountFinal = validation.sellAmountFinal;
      if (validation.needsPositionAdjust) {
        log(`[MANUAL_CLOSE] Ajustando posici√≥n ${pair} (${positionLotId}) de ${amount} a ${sellAmountFinal}`, "trading");
        position.amount = sellAmountFinal;
        this.openPositions.set(positionLotId, position);
        await this.savePositionToDB(pair, position);
      }
      
      // Recalcular PnL con cantidad real
      const actualPnlUsd = (currentPrice - entryPrice) * sellAmountFinal;
      const actualPnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;

      // PRODUCCI√ìN: Ejecutar orden real de venta
      const order = await this.krakenService.placeOrder({
        pair,
        type: "sell",
        ordertype: "market",
        volume: sellAmountFinal.toFixed(8),
      });

      const txid = order.txid?.[0];
      if (!txid) {
        return {
          success: false,
          error: "Orden enviada pero no se recibi√≥ txid de confirmaci√≥n",
        };
      }

      // Actualizar memoria y DB (usar lotId para multi-lot)
      this.openPositions.delete(positionLotId);
      await storage.deleteOpenPositionByLotId(positionLotId);

      // Registrar el trade de cierre
      const tradeId = `MANUAL-${Date.now()}`;
      await storage.createTrade({
        tradeId,
        pair,
        type: "sell",
        price: currentPrice.toString(),
        amount: sellAmountFinal.toFixed(8),
        status: "filled",
        krakenOrderId: txid,
        entryPrice: entryPrice.toString(),
        realizedPnlUsd: actualPnlUsd.toString(),
        realizedPnlPct: actualPnlPct.toString(),
        executedAt: new Date(),
      });

      // Notificar por Telegram
      if (this.telegramService.isInitialized()) {
        const pnlEmoji = actualPnlUsd >= 0 ? "üü¢" : "üî¥";
        await this.telegramService.sendMessage(`
${pnlEmoji} *Cierre Manual Ejecutado*

*Par:* ${pair}
*Cantidad:* ${sellAmountFinal.toFixed(8)}
*Precio entrada:* $${entryPrice.toFixed(2)}
*Precio salida:* $${currentPrice.toFixed(2)}
*PnL:* ${actualPnlUsd >= 0 ? "+" : ""}$${actualPnlUsd.toFixed(2)} (${actualPnlPct >= 0 ? "+" : ""}${actualPnlPct.toFixed(2)}%)
*Order ID:* \`${txid}\`

_Cierre solicitado manualmente desde dashboard_
        `.trim());
      }

      log(`[MANUAL_CLOSE] Cierre exitoso ${pair} (${positionLotId}) - Order: ${txid}, PnL: $${actualPnlUsd.toFixed(2)}`, "trading");

      return {
        success: true,
        orderId: txid,
        pnlUsd: actualPnlUsd,
        pnlPct: actualPnlPct,
        dryRun: false,
        lotId: positionLotId,
      };

    } catch (error: any) {
      log(`[MANUAL_CLOSE] Error al cerrar ${pair}: ${error.message}`, "trading");
      return {
        success: false,
        error: error.message,
      };
    }
  }

  getOpenPositions(): Map<string, { amount: number; entryPrice: number }> {
    return this.openPositions;
  }

  // === DIAGN√ìSTICO: Obtener resultados del scan con razones en espa√±ol ===
  async getScanDiagnostic(): Promise<{
    pairs: Array<{
      pair: string;
      signal: string;
      razon: string;
      cooldownSec?: number;
      exposureAvailable?: number;
      hasPosition: boolean;
      positionUsd?: number;
    }>;
    positionMode: string;
    usdBalance: number;
    totalOpenPositions: number;
    lastScanAt: string | null;
  }> {
    const config = await storage.getBotConfig();
    const positionMode = config?.positionMode || "SINGLE";
    
    // Mapeo de razones a espa√±ol (seg√∫n documento SMART_GUARD)
    const reasonTranslations: Record<string, string> = {
      "PAIR_COOLDOWN": "En enfriamiento - esperando reintentos",
      "SINGLE_MODE_POSITION_EXISTS": "Ya hay posici√≥n abierta en este par",
      "SMART_GUARD_POSITION_EXISTS": "Ya hay posici√≥n abierta en este par",
      "SMART_GUARD_MAX_LOTS_REACHED": "M√°ximo de lotes abiertos alcanzado para este par",
      "STOPLOSS_COOLDOWN": "Enfriamiento post stop-loss activo",
      "SPREAD_TOO_HIGH": "Spread demasiado alto para operar",
      "POSITION_TOO_LARGE": "Posici√≥n existente demasiado grande",
      "INSUFFICIENT_FUNDS": "Fondos USD insuficientes",
      "LOW_PROFITABILITY": "Take-profit menor que comisiones",
      "EXPOSURE_ZERO": "Sin exposici√≥n disponible",
      "VOLUME_BELOW_MINIMUM": "Volumen calculado < m√≠nimo Kraken",
      "SG_MIN_ENTRY_NOT_MET": "M√≠nimo por operaci√≥n no alcanzado (tiene saldo, pero tama√±o qued√≥ por debajo)",
      "SG_REDUCED_ENTRY": "Saldo por debajo del m√≠nimo ‚Äî entro con lo disponible",
      "MIN_ORDER_ABSOLUTE": "Por debajo del m√≠nimo absoluto ($20) ‚Äî m√≠nimo exchange no alcanzado",
      "MIN_ORDER_USD": "SKIP - M√≠nimo por orden no alcanzado (allowUnderMin=OFF)",
      "NO_POSITION": "Sin posici√≥n para vender",
      "AI_FILTER_REJECTED": "Se√±al rechazada por filtro IA",
      "Sin se√±al": "Sin se√±al de trading activa",
    };

    const pairs: Array<{
      pair: string;
      signal: string;
      razon: string;
      cooldownSec?: number;
      exposureAvailable?: number;
      hasPosition: boolean;
      positionUsd?: number;
    }> = [];

    // Helper: buscar posiciones por par (openPositions usa lotId como clave, no pair)
    const getPositionsForPair = (targetPair: string): OpenPosition[] => {
      const positions: OpenPosition[] = [];
      this.openPositions.forEach((pos) => {
        if (pos.pair === targetPair && pos.amount > 0) {
          positions.push(pos);
        }
      });
      return positions;
    };

    // Si hay datos de escaneo, usar esos
    if (this.lastScanResults.size > 0) {
      this.lastScanResults.forEach((result, pair) => {
        const pairPositions = getPositionsForPair(pair);
        const hasPosition = pairPositions.length > 0;
        const totalPositionUsd = pairPositions.reduce((sum, p) => sum + (p.amount * p.entryPrice), 0);
        
        // Traducir la raz√≥n
        let razon = result.reason;
        for (const [key, value] of Object.entries(reasonTranslations)) {
          if (razon.includes(key) || razon === key) {
            razon = value;
            break;
          }
        }

        // Obtener cooldown si no viene en el resultado
        const cooldownSec = result.cooldownSec ?? this.getCooldownRemainingSec(pair);

        pairs.push({
          pair,
          signal: result.signal,
          razon,
          cooldownSec: cooldownSec > 0 ? cooldownSec : undefined,
          exposureAvailable: result.exposureAvailable,
          hasPosition,
          positionUsd: hasPosition ? totalPositionUsd : undefined,
        });
      });
    } else {
      // Si no hay datos de escaneo, mostrar pares activos con info b√°sica
      const activePairs = config?.activePairs || [];
      for (const pair of activePairs) {
        const pairPositions = getPositionsForPair(pair);
        const hasPosition = pairPositions.length > 0;
        const totalPositionUsd = pairPositions.reduce((sum, p) => sum + (p.amount * p.entryPrice), 0);
        const exposure = this.getAvailableExposure(pair, config, this.currentUsdBalance);
        
        // Determinar raz√≥n basada en el estado real
        let razon = "Bot inactivo - act√≠valo para escanear";
        if (this.isRunning) {
          if (this.lastScanTime > 0) {
            // El bot ha escaneado pero este par no tiene resultado (puede ser por filtro u otra raz√≥n)
            razon = "Sin se√±al activa";
          } else {
            razon = "Esperando primer escaneo...";
          }
        }
        
        const cooldownSec = this.getCooldownRemainingSec(pair);
        pairs.push({
          pair,
          signal: "NONE",
          razon,
          cooldownSec: cooldownSec > 0 ? cooldownSec : undefined,
          exposureAvailable: exposure,
          hasPosition,
          positionUsd: hasPosition ? totalPositionUsd : undefined,
        });
      }
    }

    return {
      pairs,
      positionMode,
      usdBalance: this.currentUsdBalance,
      totalOpenPositions: this.openPositions.size,
      lastScanAt: this.lastScanTime > 0 ? new Date(this.lastScanTime).toISOString() : null,
    };
  }
}


===== FILE: ./server/services/fifoMatcher.ts =====
import { db } from "../db";
import { storage } from "../storage";
import { sql, eq, and } from "drizzle-orm";
import { 
  openPositions as openPositionsTable,
  lotMatches as lotMatchesTable,
  tradeFills as tradeFillsTable
} from "@shared/schema";
import type { TradeFill, OpenPosition, LotMatch } from "@shared/schema";

export interface MatchResult {
  sellFillTxid: string;
  pair: string;
  totalMatched: number;
  remainingUnmatched: number;
  lotsUpdated: number;
  lotsClosed: number;
  matchesCreated: LotMatch[];
  orphanQty: number;
  pnlNet: number;
  fullyMatched: boolean;
}

export class FifoMatcher {
  async processSellFill(sellFill: TradeFill): Promise<MatchResult> {
    const result: MatchResult = {
      sellFillTxid: sellFill.txid,
      pair: sellFill.pair,
      totalMatched: 0,
      remainingUnmatched: parseFloat(sellFill.amount),
      lotsUpdated: 0,
      lotsClosed: 0,
      matchesCreated: [],
      orphanQty: 0,
      pnlNet: 0,
      fullyMatched: false,
    };

    const sellQty = parseFloat(sellFill.amount);
    const sellPrice = parseFloat(sellFill.price);
    const sellFeeTotal = parseFloat(sellFill.fee);
    let sellRemaining = sellQty;

    // Use transaction with row-level locking - ALL operations inside tx
    await db.transaction(async (tx) => {
      // SELECT FOR UPDATE to lock lots for this pair
      const openLots = await tx.select().from(openPositionsTable)
        .where(sql`${openPositionsTable.pair} = ${sellFill.pair} 
          AND (${openPositionsTable.qtyRemaining} > 0 OR ${openPositionsTable.qtyRemaining} IS NULL)`)
        .orderBy(openPositionsTable.openedAt)
        .for("update");
      
      if (openLots.length === 0) {
        console.log(`[FifoMatcher] No open lots for ${sellFill.pair}, orphan qty=${sellRemaining.toFixed(8)}`);
        result.orphanQty = sellRemaining;
        result.remainingUnmatched = sellRemaining;
        return;
      }

      for (const lot of openLots) {
        if (sellRemaining <= 0.00000001) break;

        const lotQtyRemaining = parseFloat(lot.qtyRemaining || lot.amount);
        if (lotQtyRemaining <= 0.00000001) continue;
        
        const matchQty = Math.min(sellRemaining, lotQtyRemaining);
        
        // Check for existing match WITHIN TRANSACTION (idempotency)
        const existingMatches = await tx.select().from(lotMatchesTable)
          .where(and(
            eq(lotMatchesTable.sellFillTxid, sellFill.txid),
            eq(lotMatchesTable.lotId, lot.lotId)
          ));
        
        if (existingMatches.length > 0) {
          const existingMatch = existingMatches[0];
          console.log(`[FifoMatcher] Match already exists for ${sellFill.txid} + ${lot.lotId}, adjusting sellRemaining`);
          sellRemaining -= parseFloat(existingMatch.matchedQty);
          result.totalMatched += parseFloat(existingMatch.matchedQty);
          result.pnlNet += parseFloat(existingMatch.pnlNet);
          continue;
        }

        const buyPrice = parseFloat(lot.entryPrice);
        const buyFeeTotal = this.getBuyFee(lot);
        const buyFeeAllocated = (matchQty / parseFloat(lot.amount)) * buyFeeTotal;
        const sellFeeAllocated = (matchQty / sellQty) * sellFeeTotal;

        const revenue = matchQty * sellPrice;
        const cost = matchQty * buyPrice;
        const pnlGross = revenue - cost;
        const pnlNet = pnlGross - buyFeeAllocated - sellFeeAllocated;

        const newQtyRemaining = lotQtyRemaining - matchQty;
        const newQtyFilled = parseFloat(lot.qtyFilled || "0") + matchQty;

        try {
          // Create lot match WITHIN TRANSACTION
          const [match] = await tx.insert(lotMatchesTable).values({
            sellFillTxid: sellFill.txid,
            lotId: lot.lotId,
            matchedQty: matchQty.toFixed(8),
            buyPrice: buyPrice.toFixed(8),
            sellPrice: sellPrice.toFixed(8),
            buyFeeAllocated: buyFeeAllocated.toFixed(8),
            sellFeeAllocated: sellFeeAllocated.toFixed(8),
            pnlNet: pnlNet.toFixed(8),
          }).returning();
          
          result.matchesCreated.push(match);
          result.pnlNet += pnlNet;
          sellRemaining -= matchQty;
          result.totalMatched += matchQty;
        } catch (error: any) {
          if (error.code === '23505') {
            // Duplicate - race condition, reconcile within tx
            const existing = await tx.select().from(lotMatchesTable)
              .where(and(
                eq(lotMatchesTable.sellFillTxid, sellFill.txid),
                eq(lotMatchesTable.lotId, lot.lotId)
              ));
            if (existing.length > 0) {
              sellRemaining -= parseFloat(existing[0].matchedQty);
              result.totalMatched += parseFloat(existing[0].matchedQty);
              result.pnlNet += parseFloat(existing[0].pnlNet);
            }
            continue;
          }
          console.error(`[FifoMatcher] Error creating match:`, error.message);
          throw error;
        }

        // Update lot quantities within transaction
        await tx.update(openPositionsTable)
          .set({ 
            qtyRemaining: newQtyRemaining.toFixed(8), 
            qtyFilled: newQtyFilled.toFixed(8),
            updatedAt: new Date() 
          })
          .where(eq(openPositionsTable.lotId, lot.lotId));
        result.lotsUpdated++;

        if (newQtyRemaining <= 0.00000001) {
          await tx.delete(openPositionsTable)
            .where(eq(openPositionsTable.lotId, lot.lotId));
          result.lotsClosed++;
          console.log(`[FifoMatcher] Lot ${lot.lotId} fully closed`);
        }
      }

      // Only mark fill as matched if fully processed (sellRemaining ‚âà 0)
      if (sellRemaining <= 0.00000001) {
        await tx.update(tradeFillsTable)
          .set({ matched: true })
          .where(eq(tradeFillsTable.txid, sellFill.txid));
        result.fullyMatched = true;
      }
    });

    result.remainingUnmatched = sellRemaining;
    if (sellRemaining > 0.00000001) {
      result.orphanQty = sellRemaining;
      console.log(`[FifoMatcher] ${sellRemaining.toFixed(8)} qty unmatched (no more open lots) - fill NOT marked as matched for retry`);
    }
    
    console.log(`[FifoMatcher] Processed ${sellFill.txid}: matched=${result.totalMatched.toFixed(8)}, lots_closed=${result.lotsClosed}, pnl=${result.pnlNet.toFixed(2)}, fullyMatched=${result.fullyMatched}`);
    
    return result;
  }

  private getBuyFee(lot: OpenPosition): number {
    // Try to get actual fee from config snapshot
    if (lot.configSnapshotJson) {
      const snapshot = lot.configSnapshotJson as any;
      if (snapshot.entryFee) {
        return parseFloat(snapshot.entryFee);
      }
    }
    // Fallback: estimate from cost at Kraken rate (0.4% taker)
    const amount = parseFloat(lot.amount);
    const price = parseFloat(lot.entryPrice);
    const cost = amount * price;
    return cost * 0.004;
  }

  async processAllUnmatchedSells(): Promise<{ processed: number; errors: string[] }> {
    const pairs = ["BTC/USD", "ETH/USD", "SOL/USD", "XRP/USD", "TON/USD"];
    let processed = 0;
    const errors: string[] = [];

    for (const pair of pairs) {
      const unmatchedSells = await storage.getUnmatchedSellFills(pair);
      for (const sellFill of unmatchedSells) {
        try {
          await this.processSellFill(sellFill);
          processed++;
        } catch (error: any) {
          errors.push(`${sellFill.txid}: ${error.message}`);
        }
      }
    }

    return { processed, errors };
  }

  async initializeLots(): Promise<number> {
    return await storage.initializeQtyRemainingForAll();
  }
}

export const fifoMatcher = new FifoMatcher();


===== FILE: ./server/services/botLogger.ts =====
import { db } from "../db";
import { botEvents } from "@shared/schema";
import type { BotEvent, InsertBotEvent } from "@shared/schema";
import { desc } from "drizzle-orm";
import { eventsWs } from "./eventsWebSocket";
import { environment } from "./environment";

export type LogLevel = "INFO" | "WARN" | "ERROR";

export type EventType = 
  | "TRADE_EXECUTED"
  | "TRADE_BLOCKED"
  | "TRADE_FAILED"
  | "TRADE_ADJUSTED"
  | "TRADE_REJECTED_LOW_PROFIT"
  | "TRADE_SKIPPED"
  | "PAIR_COOLDOWN"
  | "DAILY_LIMIT_HIT"
  | "DAILY_LIMIT_RESET"
  | "BOT_STARTED"
  | "BOT_STOPPED"
  | "BOT_PAUSED"
  | "BOT_RESUMED"
  | "ENGINE_TICK"
  | "MARKET_SCAN_SUMMARY"
  | "KRAKEN_ERROR"
  | "KRAKEN_CONNECTED"
  | "TELEGRAM_ERROR"
  | "TELEGRAM_CONNECTED"
  | "SIGNAL_GENERATED"
  | "POSITION_OPENED"
  | "POSITION_CLOSED"
  | "STOP_LOSS_HIT"
  | "TAKE_PROFIT_HIT"
  | "TRAILING_STOP_HIT"
  | "ORPHAN_POSITION_CLEANED"
  | "NONCE_ERROR"
  | "BALANCE_CHECK"
  | "SYSTEM_ERROR"
  // SMART_GUARD events
  | "SG_EMERGENCY_STOPLOSS"
  | "SG_TP_FIXED"
  | "SG_BREAKEVEN_ACTIVATED"
  | "SG_TRAILING_ACTIVATED"
  | "SG_TRAILING_STOP_UPDATED"
  | "SG_STOP_HIT"
  | "SG_SCALE_OUT"
  | "SG_SCALE_OUT_EXECUTED"
  | "SG_BREAK_EVEN_ACTIVATED"
  // Config events
  | "CONFIG_OVERRIDE_UPDATED"
  // DRY_RUN mode
  | "DRY_RUN_TRADE"
  // TEST endpoint events
  | "TEST_TRADE_SIMULATED"
  | "TEST_POSITION_CREATED"
  // Manual close events
  | "MANUAL_CLOSE_INITIATED"
  | "MANUAL_CLOSE_SUCCESS"
  | "MANUAL_CLOSE_FAILED"
  | "MANUAL_CLOSE_EXCEPTION"
  | "MANUAL_CLOSE_DUST"
  | "ORPHAN_POSITION_DELETED";

interface LogMeta {
  [key: string]: any;
}

interface MemoryEvent {
  timestamp: string;
  level: LogLevel;
  type: EventType;
  message: string;
  meta?: LogMeta;
  env: string;
  instanceId: string;
}

const MAX_MEMORY_EVENTS = 100;

class BotLogger {
  private memoryEvents: MemoryEvent[] = [];
  private persistToDb: boolean = true;

  private formatConsoleLog(level: LogLevel, type: EventType, message: string): string {
    const timestamp = new Date().toISOString();
    const levelColor = level === "ERROR" ? "\x1b[31m" : level === "WARN" ? "\x1b[33m" : "\x1b[36m";
    const reset = "\x1b[0m";
    return `${levelColor}[${timestamp}] [${level}] [${type}]${reset} ${message}`;
  }

  private async log(level: LogLevel, type: EventType, message: string, meta?: LogMeta): Promise<void> {
    const timestamp = new Date().toISOString();
    const env = environment.envTag;
    const instanceId = environment.instanceId;
    
    console.log(this.formatConsoleLog(level, type, message));
    if (meta) {
      console.log("  Meta:", JSON.stringify(meta, null, 2));
    }

    const enrichedMeta = { ...meta, env, instanceId };
    const event: MemoryEvent = { timestamp, level, type, message, meta: enrichedMeta, env, instanceId };
    this.memoryEvents.unshift(event);
    if (this.memoryEvents.length > MAX_MEMORY_EVENTS) {
      this.memoryEvents.pop();
    }

    let insertedId: number | undefined;
    if (this.persistToDb) {
      try {
        const result = await db.insert(botEvents).values({
          level,
          type,
          message,
          meta: enrichedMeta ? JSON.stringify(enrichedMeta) : null,
        }).returning({ id: botEvents.id });
        insertedId = result[0]?.id;
      } catch (error) {
        console.error("[BotLogger] Error persisting event to DB:", error);
      }
    }

    try {
      eventsWs.broadcast({
        id: insertedId,
        timestamp,
        level,
        type,
        message,
        meta: enrichedMeta,
        env,
        instanceId,
      });
    } catch (error) {
      // Silently fail if WS not initialized yet
    }
  }

  async info(type: EventType, message: string, meta?: LogMeta): Promise<void> {
    await this.log("INFO", type, message, meta);
  }

  async warn(type: EventType, message: string, meta?: LogMeta): Promise<void> {
    await this.log("WARN", type, message, meta);
  }

  async error(type: EventType, message: string, meta?: LogMeta): Promise<void> {
    await this.log("ERROR", type, message, meta);
  }

  getMemoryEvents(limit: number = 50): MemoryEvent[] {
    return this.memoryEvents.slice(0, limit);
  }

  async getDbEvents(limit: number = 50): Promise<BotEvent[]> {
    try {
      return await db.select()
        .from(botEvents)
        .orderBy(desc(botEvents.timestamp))
        .limit(limit);
    } catch (error) {
      console.error("[BotLogger] Error fetching events from DB:", error);
      return [];
    }
  }

  setPersistToDb(persist: boolean): void {
    this.persistToDb = persist;
  }
}

export const botLogger = new BotLogger();


===== FILE: ./server/services/kraken.ts =====
import * as KrakenAPI from "node-kraken-api";
import { telegramService } from "./telegram";
import { storage } from "../storage";

const { Kraken } = KrakenAPI as any;

interface KrakenConfig {
  apiKey: string;
  apiSecret: string;
}

export interface PairMetadata {
  lotDecimals: number;
  orderMin: number;
  pairDecimals: number;
  stepSize: number;
}

const NONCE_ALERT_INTERVAL_MS = 30 * 60 * 1000;
const MAX_RETRIES = 3;
const RETRY_DELAYS = [500, 1000, 2000];
const METADATA_REFRESH_INTERVAL_MS = 6 * 60 * 60 * 1000; // 6 hours

export class KrakenService {
  private client: any | null = null;
  private publicClient: any;
  private lastNonceAlertTime: number = 0;
  private lastNonce: number = 0;
  private pairMetadataCache: Map<string, PairMetadata> = new Map();
  private metadataLastRefresh: number = 0;
  private metadataRefreshTimer: NodeJS.Timeout | null = null;

  constructor() {
    this.publicClient = new Kraken();
  }

  async loadPairMetadata(pairs: string[]): Promise<void> {
    try {
      console.log(`[kraken] Loading pair metadata for: ${pairs.join(", ")}`);
      const response = await this.publicClient.assetPairs();
      
      for (const pair of pairs) {
        const krakenPair = this.formatPair(pair);
        const pairData = response[krakenPair];
        
        if (pairData) {
          const lotDecimals = pairData.lot_decimals || 8;
          const orderMin = parseFloat(pairData.ordermin) || 0.01;
          const pairDecimals = pairData.pair_decimals || 5;
          const stepSize = Math.pow(10, -lotDecimals);
          
          this.pairMetadataCache.set(pair, {
            lotDecimals,
            orderMin,
            pairDecimals,
            stepSize,
          });
          
          console.log(`[kraken] ${pair}: lotDecimals=${lotDecimals}, orderMin=${orderMin}, stepSize=${stepSize}`);
        } else {
          console.warn(`[kraken] No metadata found for ${pair} (${krakenPair})`);
        }
      }
      
      this.metadataLastRefresh = Date.now();
      console.log(`[kraken] Pair metadata loaded successfully for ${this.pairMetadataCache.size} pairs`);
    } catch (error: any) {
      console.error(`[kraken] Failed to load pair metadata: ${error.message}`);
      if (this.pairMetadataCache.size === 0) {
        console.error(`[kraken] CRITICAL: No pair metadata available - trades will be skipped`);
      }
    }
  }

  startMetadataRefresh(pairs: string[]): void {
    if (this.metadataRefreshTimer) {
      clearInterval(this.metadataRefreshTimer);
    }
    
    this.metadataRefreshTimer = setInterval(async () => {
      console.log(`[kraken] Refreshing pair metadata...`);
      await this.loadPairMetadata(pairs);
    }, METADATA_REFRESH_INTERVAL_MS);
    
    console.log(`[kraken] Metadata refresh scheduled every ${METADATA_REFRESH_INTERVAL_MS / 3600000}h`);
  }

  getPairMetadata(pair: string): PairMetadata | null {
    return this.pairMetadataCache.get(pair) || null;
  }

  getStepSize(pair: string): number | null {
    const metadata = this.pairMetadataCache.get(pair);
    return metadata ? metadata.stepSize : null;
  }

  getOrderMin(pair: string): number | null {
    const metadata = this.pairMetadataCache.get(pair);
    return metadata ? metadata.orderMin : null;
  }

  hasMetadata(pair: string): boolean {
    return this.pairMetadataCache.has(pair);
  }

  initialize(config: KrakenConfig) {
    this.client = new Kraken({
      key: config.apiKey,
      secret: config.apiSecret,
      gennonce: () => this.generateNonce(),
    });
  }

  private generateNonce(): number {
    let nonce = Date.now() * 1000 + Math.floor(Math.random() * 1000);
    if (nonce <= this.lastNonce) {
      nonce = this.lastNonce + 1;
    }
    this.lastNonce = nonce;
    return nonce;
  }

  isInitialized(): boolean {
    return this.client !== null;
  }

  private async executeWithNonceRetry<T>(
    endpoint: string,
    operation: () => Promise<T>
  ): Promise<T> {
    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
      try {
        if (attempt > 1) {
          await new Promise(resolve => setTimeout(resolve, RETRY_DELAYS[attempt - 2]));
        }
        return await operation();
      } catch (error: any) {
        const isNonceError = error.message?.includes("EAPI:Invalid nonce") || 
                            error.message?.includes("Invalid nonce");
        
        if (isNonceError) {
          console.log(`[kraken] Nonce error on '${endpoint}', retrying (${attempt}/${MAX_RETRIES})...`);
          
          if (attempt === MAX_RETRIES) {
            console.error(`[kraken] CRITICAL: Persistent nonce error on '${endpoint}' after ${attempt}/${MAX_RETRIES} attempts`);
            await this.sendNonceAlert(endpoint);
            throw new Error(`Persistent nonce error on '${endpoint}' - possible duplicate instance running`);
          }
          continue;
        }
        throw error;
      }
    }
    throw new Error(`Failed after ${MAX_RETRIES} retries on '${endpoint}'`);
  }

  private async sendNonceAlert(endpoint: string): Promise<void> {
    const now = Date.now();
    
    if (now - this.lastNonceAlertTime < NONCE_ALERT_INTERVAL_MS) {
      console.log(`[kraken] Skipping Telegram nonce alert (rate limited, last sent ${Math.round((now - this.lastNonceAlertTime) / 1000)}s ago)`);
      return;
    }

    try {
      const config = await storage.getBotConfig();
      if (config && config.nonceErrorAlertsEnabled === false) {
        console.log(`[kraken] Nonce error alerts disabled in config, skipping Telegram notification`);
        return;
      }

      await telegramService.sendAlert(
        "Error de Nonce con Kraken",
        `Error persistente de nonce en '${endpoint}' despu√©s de 3 intentos.\n\n` +
        `‚ö†Ô∏è Verifica que no haya otra instancia del bot usando la misma API key de Kraken.\n\n` +
        `_Este mensaje se enviar√° m√°ximo cada 30 minutos mientras persista el problema._`
      );
      this.lastNonceAlertTime = now;
      console.log(`[kraken] Nonce alert sent to Telegram`);
    } catch (alertError) {
      console.error(`[kraken] Failed to send nonce alert to Telegram:`, alertError);
    }
  }

  async getBalance() {
    if (!this.client) throw new Error("Kraken client not initialized");
    return await this.executeWithNonceRetry("getBalance", () => this.client.balance());
  }

  async getTicker(pair: string) {
    const krakenPair = this.formatPair(pair);
    const response = await this.publicClient.ticker({ pair: krakenPair });
    return response;
  }

  async getAssetPairs() {
    return await this.publicClient.assetPairs();
  }

  async placeOrder(params: {
    pair: string;
    type: "buy" | "sell";
    ordertype: string;
    price?: string;
    volume: string;
  }) {
    if (!this.client) throw new Error("Kraken client not initialized");
    
    const krakenPair = this.formatPair(params.pair);
    const orderParams: any = {
      pair: krakenPair,
      type: params.type,
      ordertype: params.ordertype,
      volume: params.volume,
    };

    if (params.price) {
      orderParams.price = params.price;
    }

    return await this.executeWithNonceRetry("addOrder", () => this.client.addOrder(orderParams));
  }

  async cancelOrder(txid: string) {
    if (!this.client) throw new Error("Kraken client not initialized");
    return await this.executeWithNonceRetry("cancelOrder", () => this.client.cancelOrder({ txid }));
  }

  async getOpenOrders() {
    if (!this.client) throw new Error("Kraken client not initialized");
    return await this.executeWithNonceRetry("openOrders", () => this.client.openOrders());
  }

  async getClosedOrders(limit: number = 50) {
    if (!this.client) throw new Error("Kraken client not initialized");
    return await this.executeWithNonceRetry("closedOrders", () => this.client.closedOrders({ ofs: 0 }));
  }

  async getTradesHistory(options?: { start?: number; end?: number; fetchAll?: boolean }): Promise<any> {
    if (!this.client) throw new Error("Kraken client not initialized");
    
    const params: any = { type: "all" };
    if (options?.start) params.start = options.start;
    if (options?.end) params.end = options.end;
    
    // Si no se pide todo el historial, devolver solo la primera p√°gina
    if (!options?.fetchAll) {
      return await this.executeWithNonceRetry("tradesHistory", () => this.client.tradesHistory(params));
    }
    
    // Fetch all trades with pagination
    const allTrades: Record<string, any> = {};
    let offset = 0;
    let totalCount = 0;
    const RATE_LIMIT_DELAY = 2000; // 2 segundos entre llamadas
    
    console.log("[kraken] Fetching all trades history with pagination...");
    
    while (true) {
      const paginatedParams = { ...params, ofs: offset };
      
      const response: any = await this.executeWithNonceRetry("tradesHistory", () => 
        this.client.tradesHistory(paginatedParams)
      );
      
      const trades = response.trades || {};
      const count = response.count || 0;
      
      if (offset === 0) {
        totalCount = count;
        console.log(`[kraken] Total trades in Kraken: ${totalCount}`);
      }
      
      const tradeIds = Object.keys(trades);
      if (tradeIds.length === 0) {
        console.log(`[kraken] No more trades at offset ${offset}`);
        break;
      }
      
      // Merge trades
      for (const [id, trade] of Object.entries(trades)) {
        allTrades[id] = trade;
      }
      
      console.log(`[kraken] Fetched ${tradeIds.length} trades at offset ${offset}, total collected: ${Object.keys(allTrades).length}`);
      
      offset += 50;
      
      if (offset >= totalCount) {
        console.log(`[kraken] Reached end of trades history`);
        break;
      }
      
      // Rate limiting - esperar entre llamadas
      await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY));
    }
    
    console.log(`[kraken] Finished fetching ${Object.keys(allTrades).length} total trades`);
    
    return { trades: allTrades, count: Object.keys(allTrades).length };
  }

  async getOHLC(pair: string, interval: number = 5): Promise<{
    time: number;
    open: number;
    high: number;
    low: number;
    close: number;
    volume: number;
  }[]> {
    const krakenPair = this.formatPair(pair);
    const response = await this.publicClient.ohlc({ pair: krakenPair, interval });
    
    const pairData = Object.values(response).find(Array.isArray) as any[];
    if (!pairData) return [];
    
    return pairData.map((candle: any[]) => ({
      time: candle[0],
      open: parseFloat(candle[1]),
      high: parseFloat(candle[2]),
      low: parseFloat(candle[3]),
      close: parseFloat(candle[4]),
      volume: parseFloat(candle[6]),
    }));
  }

  formatPairReverse(krakenPair: string): string {
    const pairMap: Record<string, string> = {
      "XXBTZUSD": "BTC/USD",
      "XETHZUSD": "ETH/USD",
      "SOLUSD": "SOL/USD",
      "XXRPZUSD": "XRP/USD",
      "XRPUSD": "XRP/USD",
      "TONUSD": "TON/USD",
      "XXBTZXETH": "BTC/ETH",
      "XETHXXBT": "ETH/BTC",
      "ETHXBT": "ETH/BTC",
      "SOLETH": "SOL/ETH",
    };
    return pairMap[krakenPair] || krakenPair;
  }

  formatPair(pair: string): string {
    const pairMap: Record<string, string> = {
      "BTC/USD": "XXBTZUSD",
      "ETH/USD": "XETHZUSD",
      "SOL/USD": "SOLUSD",
      "XRP/USD": "XXRPZUSD",
      "TON/USD": "TONUSD",
      "ETH/BTC": "XETHXXBT",
      "BTC/ETH": "XXBTZXETH",
      "SOL/ETH": "SOLETH",
    };
    return pairMap[pair] || pair;
  }
}

export const krakenService = new KrakenService();


===== FILE: ./server/services/telegram.ts =====
import TelegramBot from "node-telegram-bot-api";
import { storage } from "../storage";
import type { TelegramChat } from "@shared/schema";
import { environment } from "./environment";

interface TelegramConfig {
  token: string;
  chatId: string;
}

type AlertType = "trades" | "errors" | "system" | "balance" | "status";

type EngineController = {
  start: () => Promise<void>;
  stop: () => Promise<void>;
  isActive: () => boolean;
  getBalance?: () => Promise<Record<string, string>>;
  getOpenPositions?: () => Map<string, { amount: number; entryPrice: number }>;
};

export class TelegramService {
  private bot: TelegramBot | null = null;
  private chatId: string = "";
  private engineController: EngineController | null = null;
  private startTime: Date = new Date();
  private heartbeatInterval: NodeJS.Timeout | null = null;

  setEngineController(controller: EngineController) {
    this.engineController = controller;
  }

  initialize(config: TelegramConfig) {
    if (this.bot) {
      try {
        this.bot.stopPolling();
        this.bot.removeAllListeners();
      } catch (e) {}
    }
    
    // Activar polling solo en Docker (NAS) - detectamos por variable de entorno
    const isDocker = process.env.DOCKER_ENV === 'true' || process.env.NODE_ENV === 'production';
    const enablePolling = isDocker;
    
    console.log(`[telegram] Inicializando bot - Polling: ${enablePolling ? 'ACTIVADO (Docker/NAS)' : 'DESACTIVADO (Replit)'}`);
    
    this.bot = new TelegramBot(config.token, { polling: enablePolling });
    this.chatId = config.chatId;
    this.setupCommands();
  }

  private setupCommands() {
    if (!this.bot) return;

    this.bot.onText(/\/estado/, async (msg) => {
      await this.handleEstado(msg.chat.id);
    });

    this.bot.onText(/\/pausar/, async (msg) => {
      await this.handlePausar(msg.chat.id);
    });

    this.bot.onText(/\/reanudar/, async (msg) => {
      await this.handleReanudar(msg.chat.id);
    });

    this.bot.onText(/\/ultimas/, async (msg) => {
      await this.handleUltimas(msg.chat.id);
    });

    this.bot.onText(/\/ayuda/, async (msg) => {
      await this.handleAyuda(msg.chat.id);
    });

    this.bot.onText(/\/balance/, async (msg) => {
      await this.handleBalance(msg.chat.id);
    });

    this.bot.onText(/\/config/, async (msg) => {
      await this.handleConfig(msg.chat.id);
    });

    this.bot.onText(/\/exposicion/, async (msg) => {
      await this.handleExposicion(msg.chat.id);
    });

    this.bot.onText(/\/uptime/, async (msg) => {
      await this.handleUptime(msg.chat.id);
    });

    this.bot.on("polling_error", (error) => {
      console.error("Telegram polling error:", error.message);
    });
  }

  private async handleEstado(chatId: number) {
    try {
      const config = await storage.getBotConfig();
      
      const engineActive = this.engineController?.isActive() ?? false;
      const configActive = config?.isActive ?? false;
      const status = engineActive ? "‚úÖ ACTIVO (motor funcionando)" : 
                     configActive ? "‚ö†Ô∏è ACTIVADO (motor detenido)" : "‚è∏Ô∏è PAUSADO";
      const strategy = config?.strategy || "momentum";
      const riskLevel = config?.riskLevel || "medium";
      const pairs = config?.activePairs?.join(", ") || "BTC/USD, ETH/USD, SOL/USD";

      const chats = await storage.getActiveTelegramChats();
      const chatsInfo = chats.length > 0 
        ? `${chats.length} chat(s) configurados` 
        : "Sin chats adicionales";

      const message = `
üìä *Estado del Bot*

*Estado:* ${status}
*Estrategia:* ${strategy}
*Nivel de riesgo:* ${riskLevel}
*Pares activos:* ${pairs}
*Chats Telegram:* ${chatsInfo}

_Usa /ayuda para ver los comandos disponibles_
      `.trim();

      await this.bot?.sendMessage(chatId, message, { parse_mode: "Markdown" });
    } catch (error: any) {
      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo estado: ${error.message}`);
    }
  }

  private async handlePausar(chatId: number) {
    try {
      await storage.updateBotConfig({ isActive: false });
      
      if (this.engineController) {
        await this.engineController.stop();
      }
      
      await this.bot?.sendMessage(chatId, "‚è∏Ô∏è *Bot pausado correctamente*\n\nEl motor de trading se ha detenido.\nUsa /reanudar para volver a activarlo.", { parse_mode: "Markdown" });
    } catch (error: any) {
      await this.bot?.sendMessage(chatId, `‚ùå Error pausando bot: ${error.message}`);
    }
  }

  private async handleReanudar(chatId: number) {
    try {
      await storage.updateBotConfig({ isActive: true });
      
      if (this.engineController) {
        await this.engineController.start();
      }
      
      await this.bot?.sendMessage(chatId, "‚úÖ *Bot activado correctamente*\n\nEl motor de trading ha comenzado a analizar el mercado.", { parse_mode: "Markdown" });
    } catch (error: any) {
      await this.bot?.sendMessage(chatId, `‚ùå Error activando bot: ${error.message}`);
    }
  }

  private async handleUltimas(chatId: number) {
    try {
      const trades = await storage.getTrades(5);
      
      if (trades.length === 0) {
        await this.bot?.sendMessage(chatId, "üì≠ No hay operaciones recientes.");
        return;
      }

      let message = "üìà *√öltimas operaciones:*\n\n";
      
      for (const trade of trades) {
        const emoji = trade.type === "buy" ? "üü¢" : "üî¥";
        const tipo = trade.type === "buy" ? "Compra" : "Venta";
        const fecha = trade.executedAt ? new Date(trade.executedAt).toLocaleDateString("es-ES") : "Pendiente";
        
        message += `${emoji} *${tipo}* ${trade.pair}\n`;
        message += `   Precio: $${parseFloat(trade.price).toFixed(2)}\n`;
        message += `   Cantidad: ${trade.amount}\n`;
        message += `   Fecha: ${fecha}\n\n`;
      }

      await this.bot?.sendMessage(chatId, message.trim(), { parse_mode: "Markdown" });
    } catch (error: any) {
      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo operaciones: ${error.message}`);
    }
  }

  private async handleAyuda(chatId: number) {
    const message = `
ü§ñ *Comandos disponibles:*

/estado - Ver estado del bot
/balance - Ver balance actual
/config - Ver configuraci√≥n de riesgo
/exposicion - Ver exposici√≥n por par
/uptime - Ver tiempo encendido
/pausar - Pausar el bot
/reanudar - Activar el bot
/ultimas - Ver √∫ltimas operaciones
/ayuda - Ver esta ayuda

_KrakenBot.AI - Trading Aut√≥nomo_
    `.trim();

    await this.bot?.sendMessage(chatId, message, { parse_mode: "Markdown" });
  }

  private async handleBalance(chatId: number) {
    try {
      if (!this.engineController?.getBalance) {
        await this.bot?.sendMessage(chatId, "‚ö†Ô∏è Kraken no est√° conectado. Configura las credenciales primero.");
        return;
      }
      const balances = await this.engineController.getBalance();
      const usd = parseFloat(balances?.ZUSD || balances?.USD || "0");
      const btc = parseFloat(balances?.XXBT || balances?.XBT || "0");
      const eth = parseFloat(balances?.XETH || balances?.ETH || "0");
      const sol = parseFloat(balances?.SOL || "0");

      const message = `
üí∞ *Balance Actual*

*USD:* $${usd.toFixed(2)}
*BTC:* ${btc.toFixed(6)}
*ETH:* ${eth.toFixed(6)}
*SOL:* ${sol.toFixed(4)}

_Actualizado: ${new Date().toLocaleString("es-ES")}_
      `.trim();

      await this.bot?.sendMessage(chatId, message, { parse_mode: "Markdown" });
    } catch (error: any) {
      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo balance: ${error.message}`);
    }
  }

  private async handleConfig(chatId: number) {
    try {
      const config = await storage.getBotConfig();
      const sl = parseFloat(config?.stopLossPercent?.toString() || "5");
      const tp = parseFloat(config?.takeProfitPercent?.toString() || "7");
      const trailing = config?.trailingStopEnabled ? `${config.trailingStopPercent}%` : "Desactivado";
      const pairExp = parseFloat(config?.maxPairExposurePct?.toString() || "25");
      const totalExp = parseFloat(config?.maxTotalExposurePct?.toString() || "60");
      const riskTrade = parseFloat(config?.riskPerTradePct?.toString() || "15");

      const message = `
‚öôÔ∏è *Configuraci√≥n de Riesgo*

üõë *Stop-Loss:* ${sl}%
üéØ *Take-Profit:* ${tp}%
üìâ *Trailing Stop:* ${trailing}
üíµ *Riesgo por trade:* ${riskTrade}%
üî∏ *Exp. por par:* ${pairExp}%
üîπ *Exp. total:* ${totalExp}%

_Estrategia: ${config?.strategy || "momentum"}_
      `.trim();

      await this.bot?.sendMessage(chatId, message, { parse_mode: "Markdown" });
    } catch (error: any) {
      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo configuraci√≥n: ${error.message}`);
    }
  }

  private async handleExposicion(chatId: number) {
    try {
      const positions = this.engineController?.getOpenPositions?.() || new Map();
      
      if (positions.size === 0) {
        await this.bot?.sendMessage(chatId, "üìä *Sin posiciones abiertas*\n\nNo hay exposici√≥n actual.", { parse_mode: "Markdown" });
        return;
      }

      let message = "üìä *Exposici√≥n Actual*\n\n";
      let totalExp = 0;

      positions.forEach((pos, pair) => {
        const exposure = pos.amount * pos.entryPrice;
        totalExp += exposure;
        const pnl = "N/A";
        message += `*${pair}:* $${exposure.toFixed(2)}\n`;
        message += `   Entrada: $${pos.entryPrice.toFixed(2)}\n`;
        message += `   Cantidad: ${pos.amount.toFixed(6)}\n\n`;
      });

      message += `*Total expuesto:* $${totalExp.toFixed(2)}`;

      await this.bot?.sendMessage(chatId, message.trim(), { parse_mode: "Markdown" });
    } catch (error: any) {
      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo exposici√≥n: ${error.message}`);
    }
  }

  private async handleUptime(chatId: number) {
    const now = new Date();
    const diff = now.getTime() - this.startTime.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

    const engineActive = this.engineController?.isActive() ?? false;
    const status = engineActive ? "‚úÖ Motor activo" : "‚è∏Ô∏è Motor pausado";

    const message = `
‚è±Ô∏è *Uptime del Bot*

*Tiempo encendido:* ${days}d ${hours}h ${minutes}m
*Estado:* ${status}
*Iniciado:* ${this.startTime.toLocaleString("es-ES")}

_KrakenBot.AI_
    `.trim();

    await this.bot?.sendMessage(chatId, message, { parse_mode: "Markdown" });
  }

  startHeartbeat() {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
    }

    const TWELVE_HOURS = 12 * 60 * 60 * 1000;
    
    this.heartbeatInterval = setInterval(async () => {
      await this.sendHeartbeat();
    }, TWELVE_HOURS);

    console.log("[telegram] Heartbeat iniciado (cada 12h)");
  }

  private async sendHeartbeat() {
    try {
      const config = await storage.getBotConfig();
      const engineActive = this.engineController?.isActive() ?? false;
      const status = engineActive ? "‚úÖ Activo" : "‚è∏Ô∏è Pausado";
      
      const now = new Date();
      const diff = now.getTime() - this.startTime.getTime();
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

      const trades = await storage.getTrades(5);
      const recentOps = trades.length > 0 ? `${trades.length} recientes` : "Sin operaciones";

      const message = `
üíì *Heartbeat - KrakenBot*

*Estado:* ${status}
*Uptime:* ${days}d ${hours}h
*Estrategia:* ${config?.strategy || "momentum"}
*Pares:* ${config?.activePairs?.join(", ") || "N/A"}
*Ops recientes:* ${recentOps}

_${now.toLocaleString("es-ES")}_
      `.trim();

      const chats = await storage.getActiveTelegramChats();
      for (const chat of chats) {
        if (chat.alertHeartbeat) {
          await this.sendToChat(chat.chatId, message);
        }
      }

      if (this.chatId) {
        await this.sendMessage(message);
      }
    } catch (error) {
      console.error("[telegram] Error enviando heartbeat:", error);
    }
  }

  isInitialized(): boolean {
    return this.bot !== null && this.chatId !== "";
  }

  async sendMessage(message: string, options?: { skipPrefix?: boolean }): Promise<boolean> {
    if (!this.bot || !this.chatId) {
      console.warn("Telegram not initialized, skipping notification");
      return false;
    }

    try {
      const prefix = options?.skipPrefix ? "" : await this.getMessagePrefix();
      const fullMessage = prefix + message;
      await this.bot.sendMessage(this.chatId, fullMessage, { parse_mode: "Markdown" });
      return true;
    } catch (error) {
      console.error("Failed to send Telegram message:", error);
      return false;
    }
  }

  private async getMessagePrefix(): Promise<string> {
    try {
      const config = await storage.getBotConfig();
      const dryRun = config?.dryRunMode ?? false;
      return environment.getMessagePrefix(dryRun);
    } catch {
      return environment.getMessagePrefix(false);
    }
  }

  async sendToChat(chatId: string, message: string, options?: { skipPrefix?: boolean }): Promise<boolean> {
    if (!this.bot) {
      console.warn("Telegram bot not initialized");
      return false;
    }

    try {
      const prefix = options?.skipPrefix ? "" : await this.getMessagePrefix();
      const fullMessage = prefix + message;
      await this.bot.sendMessage(chatId, fullMessage, { parse_mode: "Markdown" });
      return true;
    } catch (error) {
      console.error(`Failed to send message to chat ${chatId}:`, error);
      return false;
    }
  }

  async sendAlertToMultipleChats(message: string, alertType: AlertType): Promise<void> {
    if (!this.bot) return;

    const sentChatIds = new Set<string>();

    try {
      if (this.chatId) {
        await this.sendMessage(message);
        sentChatIds.add(this.chatId);
      }

      const chats = await storage.getActiveTelegramChats();
      
      for (const chat of chats) {
        if (sentChatIds.has(chat.chatId)) continue;
        
        const shouldSend = this.shouldSendToChat(chat, alertType);
        if (shouldSend) {
          await this.sendToChat(chat.chatId, message);
          sentChatIds.add(chat.chatId);
        }
      }
    } catch (error) {
      console.error("Error sending to multiple chats:", error);
    }
  }

  private shouldSendToChat(chat: TelegramChat, alertType: AlertType): boolean {
    switch (alertType) {
      case "trades":
        return chat.alertTrades;
      case "errors":
        return chat.alertErrors;
      case "system":
        return chat.alertSystem;
      case "balance":
        return chat.alertBalance;
      default:
        return false;
    }
  }

  async sendTradeNotification(trade: {
    type: string;
    pair: string;
    price: string;
    amount: string;
    status: string;
  }) {
    const emoji = trade.type === "buy" || trade.type === "COMPRA" ? "üü¢" : "üî¥";
    const message = `
${emoji} *Nueva Operaci√≥n*

*Tipo:* ${trade.type.toUpperCase()}
*Par:* ${trade.pair}
*Precio:* $${trade.price}
*Cantidad:* ${trade.amount}
*Estado:* ${trade.status}

_KrakenBot.AI - Trading Aut√≥nomo_
    `.trim();

    await this.sendAlertToMultipleChats(message, "trades");
  }

  async sendAlert(title: string, description: string) {
    const message = `
‚ö†Ô∏è *${title}*

${description}

_KrakenBot.AI - Sistema de Alertas_
    `.trim();

    await this.sendAlertToMultipleChats(message, "errors");
  }

  async sendSystemStatus(isActive: boolean, strategy: string) {
    const emoji = isActive ? "‚úÖ" : "‚è∏Ô∏è";
    const status = isActive ? "EN L√çNEA" : "PAUSADO";
    const message = `
${emoji} *Estado del Sistema*

*Status:* ${status}
*Estrategia:* ${strategy}

_KrakenBot.AI - Monitoreo_
    `.trim();

    await this.sendAlertToMultipleChats(message, "system");
  }

  async sendBalanceAlert(title: string, description: string) {
    const message = `
üí∞ *${title}*

${description}

_KrakenBot.AI - Balance_
    `.trim();

    await this.sendAlertToMultipleChats(message, "balance");
  }
}

export const telegramService = new TelegramService();


===== FILE: ./server/services/eventsWebSocket.ts =====
import { WebSocketServer, WebSocket } from "ws";
import type { Server } from "http";
import { db } from "../db";
import { botEvents } from "@shared/schema";
import { desc } from "drizzle-orm";
import { log } from "../index";

const WS_PATH = "/ws/events";
const SNAPSHOT_LIMIT = 50;
const HEARTBEAT_INTERVAL = 30000;

interface WsClient extends WebSocket {
  isAlive: boolean;
  connectedAt: Date;
}

interface WsMessage {
  type: "EVENTS_SNAPSHOT" | "BOT_EVENT" | "WS_STATUS" | "ERROR";
  payload: any;
}

class EventsWebSocketServer {
  private wss: WebSocketServer | null = null;
  private clients: Set<WsClient> = new Set();
  private heartbeatInterval: NodeJS.Timeout | null = null;

  initialize(server: Server): void {
    this.wss = new WebSocketServer({ 
      noServer: true,
      perMessageDeflate: false,
    });

    this.wss.on("connection", async (ws: WebSocket, req) => {
      const client = ws as WsClient;
      const url = new URL(req.url || "", `http://${req.headers.host}`);
      const token = url.searchParams.get("token");
      const expectedToken = process.env.WS_ADMIN_TOKEN;

      if (!expectedToken) {
        log(`[WS] WS_ADMIN_TOKEN no configurado - conexi√≥n sin autenticaci√≥n permitida (desarrollo)`, "websocket");
      } else if (token !== expectedToken) {
        log(`[WS] Conexi√≥n rechazada - token inv√°lido desde ${req.socket.remoteAddress}`, "websocket");
        this.sendMessage(client, { type: "ERROR", payload: { message: "Token inv√°lido" } });
        client.close(4001, "Unauthorized");
        return;
      }

      client.isAlive = true;
      client.connectedAt = new Date();
      this.clients.add(client);

      log(`[WS] Cliente conectado. Total: ${this.clients.size}`, "websocket");

      setTimeout(async () => {
        if (client.readyState !== WebSocket.OPEN) {
          log(`[WS] Cliente cerrado antes de enviar datos iniciales`, "websocket");
          return;
        }
        
        this.sendMessage(client, {
          type: "WS_STATUS",
          payload: {
            connectedAt: client.connectedAt.toISOString(),
            serverTime: new Date().toISOString(),
            clientsConnected: this.clients.size,
          },
        });
        
        try {
          const snapshot = await this.getEventsSnapshot();
          if (client.readyState === WebSocket.OPEN) {
            this.sendMessage(client, {
              type: "EVENTS_SNAPSHOT",
              payload: snapshot,
            });
          }
        } catch (error) {
          log(`[WS] Error enviando snapshot: ${error}`, "websocket");
        }
      }, 500);

      client.on("pong", () => {
        client.isAlive = true;
      });

      client.on("close", () => {
        this.clients.delete(client);
        log(`[WS] Cliente desconectado. Total: ${this.clients.size}`, "websocket");
      });

      client.on("error", (error) => {
        log(`[WS] Error en cliente: ${error.message}`, "websocket");
        this.clients.delete(client);
      });
    });

    this.startHeartbeat();
    log(`[WS] Servidor WebSocket inicializado en ${WS_PATH}`, "websocket");
  }

  private startHeartbeat(): void {
    this.heartbeatInterval = setInterval(() => {
      this.clients.forEach((client) => {
        if (!client.isAlive) {
          log(`[WS] Cliente muerto detectado, cerrando conexi√≥n`, "websocket");
          client.terminate();
          this.clients.delete(client);
          return;
        }
        client.isAlive = false;
        client.ping();
      });
    }, HEARTBEAT_INTERVAL);
  }

  private sendMessage(client: WsClient, message: WsMessage): void {
    if (client.readyState === WebSocket.OPEN) {
      try {
        client.send(JSON.stringify(message));
      } catch (error) {
        log(`[WS] Error enviando mensaje: ${error}`, "websocket");
      }
    }
  }

  private async getEventsSnapshot(): Promise<any[]> {
    try {
      const events = await db.select()
        .from(botEvents)
        .orderBy(desc(botEvents.timestamp))
        .limit(SNAPSHOT_LIMIT);

      return events.map(e => ({
        id: e.id,
        timestamp: e.timestamp,
        level: e.level,
        type: e.type,
        message: e.message,
        meta: e.meta ? JSON.parse(e.meta) : null,
      }));
    } catch (error) {
      log(`[WS] Error obteniendo snapshot: ${error}`, "websocket");
      return [];
    }
  }

  broadcast(event: {
    id?: number;
    timestamp: string;
    level: string;
    type: string;
    message: string;
    meta?: any;
    env?: string;
    instanceId?: string;
  }): void {
    const message: WsMessage = {
      type: "BOT_EVENT",
      payload: event,
    };

    const messageStr = JSON.stringify(message);
    let sentCount = 0;

    this.clients.forEach((client) => {
      if (client.readyState === WebSocket.OPEN) {
        try {
          client.send(messageStr);
          sentCount++;
        } catch (error) {
          log(`[WS] Error en broadcast: ${error}`, "websocket");
        }
      }
    });
  }

  getClientCount(): number {
    return this.clients.size;
  }

  handleUpgrade(req: any, socket: any, head: any): void {
    if (!this.wss) return;
    this.wss.handleUpgrade(req, socket, head, (ws) => {
      this.wss!.emit("connection", ws, req);
    });
  }

  shutdown(): void {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
    }
    this.clients.forEach((client) => {
      client.close(1001, "Server shutting down");
    });
    this.wss?.close();
  }
}

export const eventsWs = new EventsWebSocketServer();


===== FILE: ./server/services/environment.ts =====
import { randomUUID } from "crypto";
import { hostname } from "os";

type EnvTag = "REPLIT/DEV" | "NAS/PROD";

class EnvironmentService {
  private _envTag: EnvTag;
  private _instanceId: string;
  private _isReplit: boolean;

  constructor() {
    this._isReplit = !!(process.env.REPLIT_DEPLOYMENT || process.env.REPL_ID);
    this._envTag = this._isReplit ? "REPLIT/DEV" : "NAS/PROD";
    this._instanceId = `${hostname()}-${process.pid}-${randomUUID().slice(0, 8)}`;
  }

  get envTag(): EnvTag {
    return this._envTag;
  }

  get instanceId(): string {
    return this._instanceId;
  }

  get isReplit(): boolean {
    return this._isReplit;
  }

  get isNAS(): boolean {
    return !this._isReplit;
  }

  getMessagePrefix(dryRun: boolean): string {
    if (this._isReplit || dryRun) {
      return `[${this._envTag}][DRY_RUN] `;
    }
    return `[${this._envTag}] `;
  }

  getInfo(): { env: EnvTag; instanceId: string; isReplit: boolean; isNAS: boolean } {
    return {
      env: this._envTag,
      instanceId: this._instanceId,
      isReplit: this._isReplit,
      isNAS: !this._isReplit,
    };
  }
}

export const environment = new EnvironmentService();


===== FILE: ./server/services/terminalWebSocket.ts =====
import { WebSocketServer, WebSocket } from "ws";
import type { Server } from "http";
import { spawn, ChildProcess } from "child_process";
import { log } from "../index";

const WS_PATH = "/ws/logs";
const MAX_LOG_HISTORY = 200;
const HEARTBEAT_INTERVAL = 30000;

interface WsClient extends WebSocket {
  isAlive: boolean;
  connectedAt: Date;
  activeSource: string | null;
  activeProcess: ChildProcess | null;
}

interface WsMessage {
  type: "LOG_LINE" | "LOG_HISTORY" | "WS_STATUS" | "ERROR" | "SOURCE_CHANGED" | "SOURCE_STOPPED";
  payload: any;
}

interface LogSource {
  id: string;
  name: string;
  type: "docker_compose" | "docker_container" | "file";
  command?: string[];
  containerName?: string;
  filePath?: string;
}

const PREDEFINED_SOURCES: LogSource[] = [
  {
    id: "docker_compose",
    name: "Docker Compose (todos)",
    type: "docker_compose",
    command: ["docker", "compose", "logs", "-f", "--tail=200"],
  },
  {
    id: "krakenbot_container",
    name: "KrakenBot Container",
    type: "docker_container",
    containerName: "kraken-bot-app",
  },
  {
    id: "postgres_container",
    name: "PostgreSQL Container",
    type: "docker_container",
    containerName: "kraken-bot-db",
  },
  {
    id: "app_log",
    name: "App Log File",
    type: "file",
    filePath: "/var/log/krakenbot/app.log",
  },
];

class TerminalWebSocketServer {
  private wss: WebSocketServer | null = null;
  private clients: Set<WsClient> = new Set();
  private heartbeatInterval: NodeJS.Timeout | null = null;
  private dockerEnabled: boolean = false;

  initialize(server: Server): void {
    this.dockerEnabled = process.env.ENABLE_DOCKER_LOGS_STREAM === "true";

    this.wss = new WebSocketServer({ 
      noServer: true,
      perMessageDeflate: false,
    });

    this.wss.on("connection", async (ws: WebSocket, req) => {
      const client = ws as WsClient;
      const url = new URL(req.url || "", `http://${req.headers.host}`);
      const token = url.searchParams.get("token");
      const expectedToken = process.env.TERMINAL_TOKEN;

      if (!expectedToken) {
        log(`[WS-LOGS] TERMINAL_TOKEN no configurado - conexi√≥n rechazada`, "websocket");
        this.sendMessage(client, { type: "ERROR", payload: { message: "TERMINAL_TOKEN no configurado" } });
        client.close(4001, "Unauthorized");
        return;
      }

      if (token !== expectedToken) {
        log(`[WS-LOGS] Conexi√≥n rechazada - token inv√°lido desde ${req.socket.remoteAddress}`, "websocket");
        this.sendMessage(client, { type: "ERROR", payload: { message: "Token inv√°lido" } });
        client.close(4001, "Unauthorized");
        return;
      }

      client.isAlive = true;
      client.connectedAt = new Date();
      client.activeSource = null;
      client.activeProcess = null;
      this.clients.add(client);

      log(`[WS-LOGS] Cliente conectado. Total: ${this.clients.size}`, "websocket");

      const availableSources = this.getAvailableSources();
      this.sendMessage(client, {
        type: "WS_STATUS",
        payload: {
          connectedAt: client.connectedAt.toISOString(),
          serverTime: new Date().toISOString(),
          dockerEnabled: this.dockerEnabled,
          availableSources: availableSources.map(s => ({ id: s.id, name: s.name, type: s.type })),
        },
      });

      client.on("message", (data) => {
        try {
          const message = JSON.parse(data.toString());
          this.handleClientMessage(client, message);
        } catch (e) {
          log(`[WS-LOGS] Error parseando mensaje: ${e}`, "websocket");
        }
      });

      client.on("pong", () => {
        client.isAlive = true;
      });

      client.on("close", () => {
        this.stopClientProcess(client);
        this.clients.delete(client);
        log(`[WS-LOGS] Cliente desconectado. Total: ${this.clients.size}`, "websocket");
      });

      client.on("error", (error) => {
        log(`[WS-LOGS] Error en cliente: ${error.message}`, "websocket");
        this.stopClientProcess(client);
        this.clients.delete(client);
      });
    });

    this.startHeartbeat();
    log(`[WS-LOGS] Terminal WebSocket inicializado en ${WS_PATH} (docker: ${this.dockerEnabled})`, "websocket");
  }

  private getAvailableSources(): LogSource[] {
    return PREDEFINED_SOURCES.filter(source => {
      if (source.type === "docker_compose" || source.type === "docker_container") {
        return this.dockerEnabled;
      }
      return true;
    });
  }

  private handleClientMessage(client: WsClient, message: any): void {
    switch (message.type) {
      case "START_SOURCE":
        this.startLogSource(client, message.sourceId);
        break;
      case "STOP_SOURCE":
        this.stopClientProcess(client);
        this.sendMessage(client, { type: "SOURCE_STOPPED", payload: { sourceId: client.activeSource } });
        client.activeSource = null;
        break;
      default:
        log(`[WS-LOGS] Mensaje desconocido: ${message.type}`, "websocket");
    }
  }

  private startLogSource(client: WsClient, sourceId: string): void {
    const source = this.getAvailableSources().find(s => s.id === sourceId);
    
    if (!source) {
      this.sendMessage(client, { 
        type: "ERROR", 
        payload: { message: `Fuente no disponible: ${sourceId}` } 
      });
      return;
    }

    this.stopClientProcess(client);

    let command: string[];
    
    switch (source.type) {
      case "docker_compose":
        command = source.command || ["docker", "compose", "logs", "-f", "--tail=200"];
        break;
      case "docker_container":
        command = ["docker", "logs", "-f", "--tail=200", source.containerName || ""];
        break;
      case "file":
        command = ["tail", "-f", "-n", "200", source.filePath || ""];
        break;
      default:
        this.sendMessage(client, { type: "ERROR", payload: { message: "Tipo de fuente no soportado" } });
        return;
    }

    try {
      const proc = spawn(command[0], command.slice(1), {
        stdio: ["ignore", "pipe", "pipe"],
      });

      client.activeProcess = proc;
      client.activeSource = sourceId;

      log(`[WS-LOGS] Iniciando fuente ${sourceId}: ${command.join(" ")}`, "websocket");

      this.sendMessage(client, { 
        type: "SOURCE_CHANGED", 
        payload: { sourceId, sourceName: source.name } 
      });

      proc.stdout?.on("data", (data) => {
        const lines = data.toString().split("\n").filter((l: string) => l.trim());
        lines.forEach((line: string) => {
          this.sendMessage(client, { type: "LOG_LINE", payload: { line, sourceId } });
        });
      });

      proc.stderr?.on("data", (data) => {
        const lines = data.toString().split("\n").filter((l: string) => l.trim());
        lines.forEach((line: string) => {
          this.sendMessage(client, { type: "LOG_LINE", payload: { line, sourceId, isError: true } });
        });
      });

      proc.on("close", (code) => {
        log(`[WS-LOGS] Proceso terminado (${sourceId}): c√≥digo ${code}`, "websocket");
        if (client.activeSource === sourceId) {
          this.sendMessage(client, { 
            type: "SOURCE_STOPPED", 
            payload: { sourceId, exitCode: code } 
          });
          client.activeSource = null;
          client.activeProcess = null;
        }
      });

      proc.on("error", (err) => {
        log(`[WS-LOGS] Error en proceso (${sourceId}): ${err.message}`, "websocket");
        this.sendMessage(client, { 
          type: "ERROR", 
          payload: { message: `Error al iniciar fuente: ${err.message}` } 
        });
        client.activeSource = null;
        client.activeProcess = null;
      });

    } catch (error: any) {
      log(`[WS-LOGS] Error spawning proceso: ${error.message}`, "websocket");
      this.sendMessage(client, { 
        type: "ERROR", 
        payload: { message: `Error al ejecutar comando: ${error.message}` } 
      });
    }
  }

  private stopClientProcess(client: WsClient): void {
    if (client.activeProcess) {
      try {
        client.activeProcess.kill("SIGTERM");
      } catch (e) {
        // Process may already be dead
      }
      client.activeProcess = null;
    }
  }

  private startHeartbeat(): void {
    this.heartbeatInterval = setInterval(() => {
      this.clients.forEach((client) => {
        if (!client.isAlive) {
          log(`[WS-LOGS] Cliente muerto detectado, cerrando conexi√≥n`, "websocket");
          this.stopClientProcess(client);
          client.terminate();
          this.clients.delete(client);
          return;
        }
        client.isAlive = false;
        client.ping();
      });
    }, HEARTBEAT_INTERVAL);
  }

  private sendMessage(client: WsClient, message: WsMessage): void {
    if (client.readyState === WebSocket.OPEN) {
      try {
        client.send(JSON.stringify(message));
      } catch (error) {
        log(`[WS-LOGS] Error enviando mensaje: ${error}`, "websocket");
      }
    }
  }

  getClientCount(): number {
    return this.clients.size;
  }

  handleUpgrade(req: any, socket: any, head: any): void {
    if (!this.wss) return;
    this.wss.handleUpgrade(req, socket, head, (ws) => {
      this.wss!.emit("connection", ws, req);
    });
  }

  shutdown(): void {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
    }
    this.clients.forEach((client) => {
      this.stopClientProcess(client);
      client.close(1001, "Server shutting down");
    });
    if (this.wss) {
      this.wss.close();
    }
  }
}

export const terminalWsServer = new TerminalWebSocketServer();


===== FILE: ./server/services/aiService.ts =====
import { storage } from "../storage";
import { spawn } from "child_process";
import * as fs from "fs";
import * as path from "path";

export interface AiFeatures {
  rsi14: number;
  macdLine: number;
  macdSignal: number;
  macdHist: number;
  bbUpper: number;
  bbMiddle: number;
  bbLower: number;
  atr14: number;
  ema12: number;
  ema26: number;
  volume24hChange: number;
  priceChange1h: number;
  priceChange4h: number;
  priceChange24h: number;
  spreadPct: number;
  confidence: number;
}

export interface AiPrediction {
  approve: boolean;
  score: number;
  threshold: number;
}

export interface AiStatus {
  phase: "red" | "yellow" | "green";
  phaseLabel: string;
  completeSamples: number;
  minSamplesForTrain: number;
  minSamplesForActivate: number;
  canTrain: boolean;
  canActivate: boolean;
  filterEnabled: boolean;
  shadowEnabled: boolean;
  modelLoaded: boolean;
  lastTrainTs: Date | null;
  threshold: number;
  metrics: {
    accuracy?: number;
    precision?: number;
    recall?: number;
    f1?: number;
    tradesBlocked?: number;
    lossesAvoided?: number;
  } | null;
}

export interface AiDiagnostic {
  operationsCount: number;
  trainingTradesTotal: number;
  closedTradesCount: number;
  labeledTradesCount: number;
  openTradesCount: number;
  openLotsCount: number;
  openTradesDescription: string;
  openLotsDescription: string;
  lastBackfillRun: Date | null;
  lastBackfillError: string | null;
  lastTrainRun: Date | null;
  lastTrainError: string | null;
  modelVersion: string | null;
  discardReasonsDataset: Record<string, number>;
  lastBackfillDiscardReasons: Record<string, number>;
  winRate: number | null;
  avgPnlNet: number | null;
  avgHoldTimeMinutes: number | null;
}

const MODEL_DIR = "/tmp/models";
const MODEL_PATH = `${MODEL_DIR}/ai_filter.joblib`;
const STATUS_PATH = `${MODEL_DIR}/ai_status.json`;

const MIN_SAMPLES_TRAIN = 300;
const MIN_SAMPLES_ACTIVATE = 300;

const LEGACY_KEY_MAP: Record<string, string> = {
  'no_matching_sell': 'venta_sin_compra_previa',
  'invalid_data': 'datos_invalidos',
  'outlier_pnl': 'pnl_atipico',
  'excessive_hold': 'hold_excesivo',
  'abnormal_fees': 'comisiones_anormales',
  'invalid_timestamps': 'timestamps_invalidos',
  'sell_exceeds_lots': 'venta_excede_lotes',
  'no_execution_date': 'sin_fecha_ejecucion',
};

function translateDiscardReasons(reasons: Record<string, number>): Record<string, number> {
  const translated: Record<string, number> = {};
  for (const [key, count] of Object.entries(reasons)) {
    const translatedKey = LEGACY_KEY_MAP[key] || key;
    translated[translatedKey] = (translated[translatedKey] || 0) + count;
  }
  return translated;
}

class AiService {
  private modelLoaded: boolean = false;
  private cachedMetrics: any = null;

  extractFeatures(indicators: {
    rsi?: number;
    macd?: { line: number; signal: number; histogram: number };
    bollinger?: { upper: number; middle: number; lower: number };
    atr?: number;
    ema12?: number;
    ema26?: number;
    volume24hChange?: number;
    priceChange1h?: number;
    priceChange4h?: number;
    priceChange24h?: number;
    spreadPct?: number;
    confidence?: number;
  }): AiFeatures {
    return {
      rsi14: indicators.rsi ?? 50,
      macdLine: indicators.macd?.line ?? 0,
      macdSignal: indicators.macd?.signal ?? 0,
      macdHist: indicators.macd?.histogram ?? 0,
      bbUpper: indicators.bollinger?.upper ?? 0,
      bbMiddle: indicators.bollinger?.middle ?? 0,
      bbLower: indicators.bollinger?.lower ?? 0,
      atr14: indicators.atr ?? 0,
      ema12: indicators.ema12 ?? 0,
      ema26: indicators.ema26 ?? 0,
      volume24hChange: indicators.volume24hChange ?? 0,
      priceChange1h: indicators.priceChange1h ?? 0,
      priceChange4h: indicators.priceChange4h ?? 0,
      priceChange24h: indicators.priceChange24h ?? 0,
      spreadPct: indicators.spreadPct ?? 0,
      confidence: indicators.confidence ?? 50,
    };
  }

  async getStatus(): Promise<AiStatus> {
    const aiConfig = await storage.getAiConfig();
    const labeledCount = await storage.getTrainingTradesCount({ labeled: true });
    
    let phase: "red" | "yellow" | "green" = "red";
    let phaseLabel = "Recolectando datos";
    
    if (labeledCount >= MIN_SAMPLES_ACTIVATE && aiConfig?.filterEnabled) {
      phase = "green";
      phaseLabel = "Filtro activo";
    } else if (labeledCount >= MIN_SAMPLES_TRAIN) {
      phase = "yellow";
      phaseLabel = "Listo para entrenar";
    }

    const modelExists = fs.existsSync(MODEL_PATH);
    
    let metrics = null;
    if (fs.existsSync(STATUS_PATH)) {
      try {
        const statusData = fs.readFileSync(STATUS_PATH, "utf-8");
        metrics = JSON.parse(statusData);
        this.cachedMetrics = metrics;
      } catch (e) {
        metrics = this.cachedMetrics;
      }
    }

    return {
      phase,
      phaseLabel,
      completeSamples: labeledCount,
      minSamplesForTrain: MIN_SAMPLES_TRAIN,
      minSamplesForActivate: MIN_SAMPLES_ACTIVATE,
      canTrain: labeledCount >= MIN_SAMPLES_TRAIN,
      canActivate: labeledCount >= MIN_SAMPLES_ACTIVATE && modelExists,
      filterEnabled: aiConfig?.filterEnabled ?? false,
      shadowEnabled: aiConfig?.shadowEnabled ?? false,
      modelLoaded: modelExists && this.modelLoaded,
      lastTrainTs: aiConfig?.lastTrainTs ?? null,
      threshold: parseFloat(aiConfig?.threshold ?? "0.60"),
      metrics,
    };
  }

  async getDiagnostic(): Promise<AiDiagnostic> {
    const aiConfig = await storage.getAiConfig();
    const allTrades = await storage.getAllTradesForBackfill();
    const trainingTradesTotal = await storage.getTrainingTradesCount();
    const closedCount = await storage.getTrainingTradesCount({ closed: true });
    const labeledCount = await storage.getTrainingTradesCount({ labeled: true });
    const openCount = await storage.getTrainingTradesCount({ closed: false });
    const openLotsCount = await storage.getTrainingTradesCount({ hasOpenLots: true });
    
    const labeledTrades = await storage.getTrainingTrades({ labeled: true });
    
    const rawDiscardReasonsDataset = await storage.getDiscardReasonsDataset();
    const discardReasonsDataset = translateDiscardReasons(rawDiscardReasonsDataset);
    
    const rawLastBackfillDiscardReasons: Record<string, number> = 
      (aiConfig?.lastBackfillDiscardReasonsJson as Record<string, number>) || {};
    const lastBackfillDiscardReasons = translateDiscardReasons(rawLastBackfillDiscardReasons);
    
    let winRate: number | null = null;
    let avgPnlNet: number | null = null;
    let avgHoldTimeMinutes: number | null = null;
    
    if (labeledTrades.length > 0) {
      const wins = labeledTrades.filter(t => t.labelWin === 1).length;
      winRate = (wins / labeledTrades.length) * 100;
      
      const pnlSum = labeledTrades.reduce((sum, t) => sum + parseFloat(t.pnlNet || '0'), 0);
      avgPnlNet = pnlSum / labeledTrades.length;
      
      const holdSum = labeledTrades.reduce((sum, t) => sum + (t.holdTimeMinutes || 0), 0);
      avgHoldTimeMinutes = holdSum / labeledTrades.length;
    }
    
    return {
      operationsCount: allTrades.length,
      trainingTradesTotal,
      closedTradesCount: closedCount,
      labeledTradesCount: labeledCount,
      openTradesCount: openCount,
      openLotsCount,
      openTradesDescription: "training_trades con isClosed=false",
      openLotsDescription: "training_trades con qtyRemaining > 0",
      lastBackfillRun: aiConfig?.lastBackfillTs ?? null,
      lastBackfillError: aiConfig?.lastBackfillError ?? null,
      lastTrainRun: aiConfig?.lastTrainTs ?? null,
      lastTrainError: aiConfig?.lastTrainError ?? null,
      modelVersion: aiConfig?.modelVersion ?? null,
      discardReasonsDataset,
      lastBackfillDiscardReasons,
      winRate,
      avgPnlNet,
      avgHoldTimeMinutes,
    };
  }

  async predict(features: AiFeatures): Promise<AiPrediction> {
    const aiConfig = await storage.getAiConfig();
    const threshold = parseFloat(aiConfig?.threshold ?? "0.60");
    
    if (!fs.existsSync(MODEL_PATH)) {
      return { approve: true, score: 0.5, threshold };
    }

    try {
      const featuresJson = JSON.stringify(features);
      const result = await this.runPythonPredict(featuresJson);
      const score = parseFloat(result.score);
      
      return {
        approve: score >= threshold,
        score,
        threshold,
      };
    } catch (error) {
      console.error("[AI] Prediction error:", error);
      return { approve: true, score: 0.5, threshold };
    }
  }

  private runPythonPredict(featuresJson: string): Promise<{ score: string }> {
    return new Promise((resolve, reject) => {
      const pythonScript = path.join(process.cwd(), "server/services/mlTrainer.py");
      
      if (!fs.existsSync(pythonScript)) {
        resolve({ score: "0.5" });
        return;
      }

      const proc = spawn("python3", [pythonScript, "predict", featuresJson], {
        cwd: process.cwd(),
      });

      let stdout = "";
      let stderr = "";

      proc.stdout.on("data", (data) => (stdout += data.toString()));
      proc.stderr.on("data", (data) => (stderr += data.toString()));

      proc.on("close", (code) => {
        if (code !== 0) {
          console.error("[AI] Python predict error:", stderr);
          resolve({ score: "0.5" });
          return;
        }
        try {
          const result = JSON.parse(stdout.trim());
          resolve({ score: result.score?.toString() ?? "0.5" });
        } catch (e) {
          resolve({ score: "0.5" });
        }
      });

      proc.on("error", (err) => {
        console.error("[AI] Python spawn error:", err);
        resolve({ score: "0.5" });
      });
    });
  }

  async runTraining(): Promise<{ 
    success: boolean; 
    message: string; 
    errorCode?: string;
    required?: number;
    current?: number;
    metrics?: { accuracy: number; precision: number; recall: number; f1: number; trainSize: number; valSize: number } 
  }> {
    const labeledTrades = await storage.getTrainingTrades({ labeled: true });
    
    if (labeledTrades.length < MIN_SAMPLES_TRAIN) {
      return { 
        success: false, 
        errorCode: "INSUFFICIENT_DATA",
        message: `Datos insuficientes para entrenar el modelo. Necesitas ${MIN_SAMPLES_TRAIN} trades cerrados etiquetados. Actualmente hay ${labeledTrades.length}.`,
        required: MIN_SAMPLES_TRAIN,
        current: labeledTrades.length
      };
    }

    if (!fs.existsSync(MODEL_DIR)) {
      fs.mkdirSync(MODEL_DIR, { recursive: true });
    }

    const sortedTrades = [...labeledTrades].sort((a, b) => {
      const timeA = a.entryTs ? new Date(a.entryTs).getTime() : 0;
      const timeB = b.entryTs ? new Date(b.entryTs).getTime() : 0;
      return timeA - timeB;
    });

    const validTrades = sortedTrades.filter(trade => {
      const entryTime = trade.entryTs ? new Date(trade.entryTs).getTime() : 0;
      const exitTime = trade.exitTs ? new Date(trade.exitTs).getTime() : 0;
      const entryPrice = parseFloat(trade.entryPrice || '0');
      const exitPrice = parseFloat(trade.exitPrice || '0');
      const amount = parseFloat(trade.entryAmount || '0');
      
      if (exitTime <= entryTime) return false;
      if (entryPrice <= 0 || exitPrice <= 0) return false;
      if (amount <= 0) return false;
      if (trade.holdTimeMinutes !== null && trade.holdTimeMinutes < 0) return false;
      
      return true;
    });

    if (validTrades.length < MIN_SAMPLES_TRAIN) {
      return { 
        success: false, 
        errorCode: "INSUFFICIENT_DATA",
        message: `Datos insuficientes para entrenar el modelo. Solo hay ${validTrades.length} trades v√°lidos despu√©s de validaci√≥n. Necesitas ${MIN_SAMPLES_TRAIN}.`,
        required: MIN_SAMPLES_TRAIN,
        current: validTrades.length
      };
    }

    const splitIdx = Math.floor(validTrades.length * 0.8);
    const trainTrades = validTrades.slice(0, splitIdx);
    const valTrades = validTrades.slice(splitIdx);

    const trainingData = {
      train: trainTrades.map(trade => ({
        tradeId: trade.buyTxid,
        pair: trade.pair,
        entryPrice: trade.entryPrice,
        exitPrice: trade.exitPrice,
        pnlNet: trade.pnlNet,
        pnlPct: trade.pnlPct,
        holdTimeMinutes: trade.holdTimeMinutes,
        labelWin: trade.labelWin,
        featuresJson: trade.featuresJson || {},
        entryTs: trade.entryTs,
      })),
      val: valTrades.map(trade => ({
        tradeId: trade.buyTxid,
        pair: trade.pair,
        entryPrice: trade.entryPrice,
        exitPrice: trade.exitPrice,
        pnlNet: trade.pnlNet,
        pnlPct: trade.pnlPct,
        holdTimeMinutes: trade.holdTimeMinutes,
        labelWin: trade.labelWin,
        featuresJson: trade.featuresJson || {},
        entryTs: trade.entryTs,
      })),
    };

    const samplesPath = `${MODEL_DIR}/training_samples.json`;
    fs.writeFileSync(samplesPath, JSON.stringify(trainingData, null, 2));

    const modelVersion = `v${Date.now()}`;

    return new Promise((resolve) => {
      const pythonScript = path.join(process.cwd(), "server/services/mlTrainer.py");
      
      if (!fs.existsSync(pythonScript)) {
        storage.updateAiConfig({ lastTrainError: "Script de entrenamiento no encontrado" });
        resolve({ success: false, message: "Script de entrenamiento no encontrado" });
        return;
      }

      const proc = spawn("python3", [pythonScript, "train", samplesPath], {
        cwd: process.cwd(),
      });

      let stdout = "";
      let stderr = "";

      proc.stdout.on("data", (data) => (stdout += data.toString()));
      proc.stderr.on("data", (data) => (stderr += data.toString()));

      proc.on("close", async (code) => {
        if (code !== 0) {
          console.error("[AI] Training failed:", stderr);
          const errorMsg = stderr.slice(0, 500) || 'Unknown training error';
          await storage.updateAiConfig({ lastTrainError: errorMsg });
          resolve({ success: false, message: `Error en entrenamiento: ${errorMsg.slice(0, 200)}` });
          return;
        }

        try {
          const result = JSON.parse(stdout.trim());
          const metrics = {
            accuracy: result.metrics?.accuracy ?? 0,
            precision: result.metrics?.precision ?? 0,
            recall: result.metrics?.recall ?? 0,
            f1: result.metrics?.f1 ?? 0,
            trainSize: trainTrades.length,
            valSize: valTrades.length,
          };
          
          await storage.updateAiConfig({
            lastTrainTs: new Date(),
            lastTrainError: null,
            nSamples: validTrades.length,
            modelPath: MODEL_PATH,
            modelVersion,
            metricsJson: metrics,
          });

          this.modelLoaded = true;
          
          resolve({
            success: true,
            message: `Modelo ${modelVersion} entrenado: ${trainTrades.length} train / ${valTrades.length} val. Accuracy: ${(metrics.accuracy * 100).toFixed(1)}%`,
            metrics,
          });
        } catch (e: any) {
          await storage.updateAiConfig({
            lastTrainTs: new Date(),
            lastTrainError: null,
            modelVersion,
          });
          resolve({ success: true, message: `Modelo ${modelVersion} entrenado (sin m√©tricas parseables)` });
        }
      });

      proc.on("error", async (err) => {
        console.error("[AI] Training spawn error:", err);
        await storage.updateAiConfig({ lastTrainError: err.message });
        resolve({ success: false, message: `Error: ${err.message}` });
      });
    });
  }

  async runBackfill(): Promise<{ success: boolean; message: string; stats: { created: number; closed: number; labeled: number; discardReasons: Record<string, number> } }> {
    try {
      const stats = await storage.runTrainingTradesBackfill();
      
      await storage.updateAiConfig({
        lastBackfillTs: new Date(),
        lastBackfillError: null,
        lastBackfillDiscardReasonsJson: stats.discardReasons,
      });
      
      return {
        success: true,
        message: `Backfill completado: ${stats.created} trades creados, ${stats.closed} cerrados, ${stats.labeled} etiquetados`,
        stats,
      };
    } catch (error: any) {
      const errorMsg = error.message || 'Unknown error';
      await storage.updateAiConfig({
        lastBackfillTs: new Date(),
        lastBackfillError: errorMsg,
      });
      
      return {
        success: false,
        message: `Error en backfill: ${errorMsg}`,
        stats: { created: 0, closed: 0, labeled: 0, discardReasons: {} },
      };
    }
  }

  async toggleFilter(enabled: boolean): Promise<void> {
    await storage.updateAiConfig({ filterEnabled: enabled });
  }

  async toggleShadow(enabled: boolean): Promise<void> {
    await storage.updateAiConfig({ shadowEnabled: enabled });
  }

  async setThreshold(threshold: number): Promise<void> {
    await storage.updateAiConfig({ threshold: threshold.toFixed(4) });
  }
}

export const aiService = new AiService();


===== FILE: ./server/services/mlTrainer.py =====
#!/usr/bin/env python3
"""
AI Filter Model Trainer for KrakenBot
Uses RandomForest with walk-forward validation
"""

import sys
import json
import os
import pickle

MODEL_DIR = "/tmp/models"
MODEL_PATH = f"{MODEL_DIR}/ai_filter.joblib"
STATUS_PATH = f"{MODEL_DIR}/ai_status.json"

def ensure_model_dir():
    if not os.path.exists(MODEL_DIR):
        os.makedirs(MODEL_DIR, exist_ok=True)

def extract_features_from_sample(sample):
    """Extract feature vector from a sample's featuresJson"""
    features = sample.get("featuresJson", {})
    if isinstance(features, str):
        features = json.loads(features)
    
    return [
        float(features.get("rsi14", 50)),
        float(features.get("macdLine", 0)),
        float(features.get("macdSignal", 0)),
        float(features.get("macdHist", 0)),
        float(features.get("bbUpper", 0)),
        float(features.get("bbMiddle", 0)),
        float(features.get("bbLower", 0)),
        float(features.get("atr14", 0)),
        float(features.get("ema12", 0)),
        float(features.get("ema26", 0)),
        float(features.get("volume24hChange", 0)),
        float(features.get("priceChange1h", 0)),
        float(features.get("priceChange4h", 0)),
        float(features.get("priceChange24h", 0)),
        float(features.get("spreadPct", 0)),
        float(features.get("confidence", 50)),
    ]

def train(samples_path):
    """Train RandomForest model on samples"""
    try:
        from sklearn.ensemble import RandomForestClassifier
        from sklearn.model_selection import TimeSeriesSplit
        from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score
        import numpy as np
    except ImportError:
        print(json.dumps({"success": False, "error": "sklearn not installed"}))
        sys.exit(1)
    
    ensure_model_dir()
    
    with open(samples_path, 'r') as f:
        samples = json.load(f)
    
    complete_samples = [s for s in samples if s.get("isComplete") and s.get("labelWin") is not None]
    
    if len(complete_samples) < 50:
        print(json.dumps({"success": False, "error": f"Not enough samples: {len(complete_samples)}"}))
        sys.exit(1)
    
    X = []
    y = []
    
    for sample in complete_samples:
        try:
            features = extract_features_from_sample(sample)
            label = int(sample["labelWin"])
            X.append(features)
            y.append(label)
        except Exception as e:
            continue
    
    X = np.array(X)
    y = np.array(y)
    
    tscv = TimeSeriesSplit(n_splits=min(5, len(X) // 20))
    
    accuracies = []
    precisions = []
    recalls = []
    f1s = []
    
    for train_idx, test_idx in tscv.split(X):
        X_train, X_test = X[train_idx], X[test_idx]
        y_train, y_test = y[train_idx], y[test_idx]
        
        model = RandomForestClassifier(
            n_estimators=100,
            max_depth=10,
            min_samples_split=5,
            min_samples_leaf=2,
            random_state=42,
            class_weight='balanced'
        )
        
        model.fit(X_train, y_train)
        y_pred = model.predict(X_test)
        
        accuracies.append(accuracy_score(y_test, y_pred))
        precisions.append(precision_score(y_test, y_pred, zero_division=0))
        recalls.append(recall_score(y_test, y_pred, zero_division=0))
        f1s.append(f1_score(y_test, y_pred, zero_division=0))
    
    final_model = RandomForestClassifier(
        n_estimators=100,
        max_depth=10,
        min_samples_split=5,
        min_samples_leaf=2,
        random_state=42,
        class_weight='balanced'
    )
    final_model.fit(X, y)
    
    with open(MODEL_PATH, 'wb') as f:
        pickle.dump(final_model, f)
    
    metrics = {
        "accuracy": float(np.mean(accuracies)),
        "precision": float(np.mean(precisions)),
        "recall": float(np.mean(recalls)),
        "f1": float(np.mean(f1s)),
        "nSamples": len(complete_samples),
        "trainedAt": str(os.popen('date -u +"%Y-%m-%dT%H:%M:%SZ"').read().strip())
    }
    
    with open(STATUS_PATH, 'w') as f:
        json.dump(metrics, f, indent=2)
    
    print(json.dumps({"success": True, "metrics": metrics}))

def predict(features_json):
    """Predict approval probability for given features"""
    ensure_model_dir()
    
    if not os.path.exists(MODEL_PATH):
        print(json.dumps({"score": 0.5, "error": "Model not found"}))
        return
    
    try:
        with open(MODEL_PATH, 'rb') as f:
            model = pickle.load(f)
        
        features = json.loads(features_json)
        
        X = [[
            float(features.get("rsi14", 50)),
            float(features.get("macdLine", 0)),
            float(features.get("macdSignal", 0)),
            float(features.get("macdHist", 0)),
            float(features.get("bbUpper", 0)),
            float(features.get("bbMiddle", 0)),
            float(features.get("bbLower", 0)),
            float(features.get("atr14", 0)),
            float(features.get("ema12", 0)),
            float(features.get("ema26", 0)),
            float(features.get("volume24hChange", 0)),
            float(features.get("priceChange1h", 0)),
            float(features.get("priceChange4h", 0)),
            float(features.get("priceChange24h", 0)),
            float(features.get("spreadPct", 0)),
            float(features.get("confidence", 50)),
        ]]
        
        proba = model.predict_proba(X)[0]
        score = float(proba[1]) if len(proba) > 1 else 0.5
        
        print(json.dumps({"score": score}))
        
    except Exception as e:
        print(json.dumps({"score": 0.5, "error": str(e)}))

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(json.dumps({"error": "Usage: mlTrainer.py <train|predict> <arg>"}))
        sys.exit(1)
    
    command = sys.argv[1]
    
    if command == "train" and len(sys.argv) >= 3:
        train(sys.argv[2])
    elif command == "predict" and len(sys.argv) >= 3:
        predict(sys.argv[2])
    else:
        print(json.dumps({"error": f"Unknown command: {command}"}))
        sys.exit(1)


===== FILE: ./server/vite.ts =====
import { type Express } from "express";
import { createServer as createViteServer, createLogger } from "vite";
import { type Server } from "http";
import viteConfig from "../vite.config";
import fs from "fs";
import path from "path";
import { nanoid } from "nanoid";

const viteLogger = createLogger();

export async function setupVite(server: Server, app: Express) {
  const serverOptions = {
    middlewareMode: true,
    hmr: { server, path: "/vite-hmr" },
    allowedHosts: true as const,
  };

  const vite = await createViteServer({
    ...viteConfig,
    configFile: false,
    customLogger: {
      ...viteLogger,
      error: (msg, options) => {
        viteLogger.error(msg, options);
        process.exit(1);
      },
    },
    server: serverOptions,
    appType: "custom",
  });

  app.use(vite.middlewares);

  app.use("*", async (req, res, next) => {
    const url = req.originalUrl;

    try {
      const clientTemplate = path.resolve(
        import.meta.dirname,
        "..",
        "client",
        "index.html",
      );

      // always reload the index.html file from disk incase it changes
      let template = await fs.promises.readFile(clientTemplate, "utf-8");
      template = template.replace(
        `src="/src/main.tsx"`,
        `src="/src/main.tsx?v=${nanoid()}"`,
      );
      const page = await vite.transformIndexHtml(url, template);
      res.status(200).set({ "Content-Type": "text/html" }).end(page);
    } catch (e) {
      vite.ssrFixStacktrace(e as Error);
      next(e);
    }
  });
}


===== FILE: ./server/static.ts =====
import express, { type Express } from "express";
import fs from "fs";
import path from "path";

export function serveStatic(app: Express) {
  const distPath = path.resolve(__dirname, "public");
  if (!fs.existsSync(distPath)) {
    throw new Error(
      `Could not find the build directory: ${distPath}, make sure to build the client first`,
    );
  }

  app.use(express.static(distPath));

  // fall through to index.html if the file doesn't exist
  app.use("*", (_req, res) => {
    res.sendFile(path.resolve(distPath, "index.html"));
  });
}


===== FILE: ./package-lock.json =====
{
  "name": "rest-express",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "rest-express",
      "version": "1.0.0",
      "license": "MIT",
      "dependencies": {
        "@hookform/resolvers": "^3.10.0",
        "@jridgewell/trace-mapping": "^0.3.25",
        "@radix-ui/react-accordion": "^1.2.12",
        "@radix-ui/react-alert-dialog": "^1.1.15",
        "@radix-ui/react-aspect-ratio": "^1.1.8",
        "@radix-ui/react-avatar": "^1.1.11",
        "@radix-ui/react-checkbox": "^1.3.3",
        "@radix-ui/react-collapsible": "^1.1.12",
        "@radix-ui/react-context-menu": "^2.2.16",
        "@radix-ui/react-dialog": "^1.1.15",
        "@radix-ui/react-dropdown-menu": "^2.1.16",
        "@radix-ui/react-hover-card": "^1.1.15",
        "@radix-ui/react-label": "^2.1.8",
        "@radix-ui/react-menubar": "^1.1.16",
        "@radix-ui/react-navigation-menu": "^1.2.14",
        "@radix-ui/react-popover": "^1.1.15",
        "@radix-ui/react-progress": "^1.1.8",
        "@radix-ui/react-radio-group": "^1.3.8",
        "@radix-ui/react-scroll-area": "^1.2.10",
        "@radix-ui/react-select": "^2.2.6",
        "@radix-ui/react-separator": "^1.1.8",
        "@radix-ui/react-slider": "^1.3.6",
        "@radix-ui/react-slot": "^1.2.4",
        "@radix-ui/react-switch": "^1.2.6",
        "@radix-ui/react-tabs": "^1.1.13",
        "@radix-ui/react-toast": "^1.2.7",
        "@radix-ui/react-toggle": "^1.1.10",
        "@radix-ui/react-toggle-group": "^1.1.11",
        "@radix-ui/react-tooltip": "^1.2.8",
        "@tanstack/react-query": "^5.60.5",
        "@types/node-telegram-bot-api": "^0.64.13",
        "class-variance-authority": "^0.7.1",
        "clsx": "^2.1.1",
        "cmdk": "^1.1.1",
        "connect-pg-simple": "^10.0.0",
        "date-fns": "^3.6.0",
        "drizzle-orm": "^0.39.3",
        "drizzle-zod": "^0.7.0",
        "embla-carousel-react": "^8.6.0",
        "express": "^4.21.2",
        "express-session": "^1.18.1",
        "framer-motion": "^12.23.24",
        "input-otp": "^1.4.2",
        "lucide-react": "^0.545.0",
        "memorystore": "^1.6.7",
        "next-themes": "^0.4.6",
        "node-kraken-api": "^2.2.2",
        "node-telegram-bot-api": "^0.66.0",
        "passport": "^0.7.0",
        "passport-local": "^1.0.0",
        "pg": "^8.16.3",
        "react": "^19.2.0",
        "react-day-picker": "^9.11.1",
        "react-dom": "^19.2.0",
        "react-hook-form": "^7.66.0",
        "react-resizable-panels": "^2.1.9",
        "recharts": "^2.15.4",
        "sonner": "^2.0.7",
        "tailwind-merge": "^3.3.1",
        "tailwindcss-animate": "^1.0.7",
        "tw-animate-css": "^1.4.0",
        "vaul": "^1.1.2",
        "wouter": "^3.3.5",
        "ws": "^8.18.0",
        "zod": "^3.25.76",
        "zod-validation-error": "^3.4.0"
      },
      "devDependencies": {
        "@replit/vite-plugin-cartographer": "^0.4.4",
        "@replit/vite-plugin-dev-banner": "^0.1.1",
        "@replit/vite-plugin-runtime-error-modal": "^0.0.4",
        "@tailwindcss/vite": "^4.1.14",
        "@types/connect-pg-simple": "^7.0.3",
        "@types/express": "4.17.21",
        "@types/express-session": "^1.18.0",
        "@types/node": "^20.19.0",
        "@types/passport": "^1.0.16",
        "@types/passport-local": "^1.0.38",
        "@types/react": "^19.2.0",
        "@types/react-dom": "^19.2.0",
        "@types/ws": "^8.5.13",
        "@vitejs/plugin-react": "^5.0.4",
        "autoprefixer": "^10.4.21",
        "drizzle-kit": "^0.31.4",
        "esbuild": "^0.25.0",
        "postcss": "^8.5.6",
        "tailwindcss": "^4.1.14",
        "tsx": "^4.20.5",
        "typescript": "5.6.3",
        "vite": "^7.1.9"
      },
      "optionalDependencies": {
        "bufferutil": "^4.0.8"
      }
    },
    "node_modules/@babel/code-frame": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/code-frame/-/code-frame-7.27.1.tgz",
      "integrity": "sha512-cjQ7ZlQ0Mv3b47hABuTevyTuYN4i+loJKGeV9flcCgIK37cCXRh+L1bd3iBHlynerhQ7BhCkn2BPbQUL+rGqFg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-validator-identifier": "^7.27.1",
        "js-tokens": "^4.0.0",
        "picocolors": "^1.1.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/compat-data": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/compat-data/-/compat-data-7.28.4.tgz",
      "integrity": "sha512-YsmSKC29MJwf0gF8Rjjrg5LQCmyh+j/nD8/eP7f+BeoQTKYqs9RoWbjGOdy0+1Ekr68RJZMUOPVQaQisnIo4Rw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/core": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/core/-/core-7.28.4.tgz",
      "integrity": "sha512-2BCOP7TN8M+gVDj7/ht3hsaO/B/n5oDbiAyyvnRlNOs+u1o+JWNYTQrmpuNp1/Wq2gcFrI01JAW+paEKDMx/CA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.3",
        "@babel/helper-compilation-targets": "^7.27.2",
        "@babel/helper-module-transforms": "^7.28.3",
        "@babel/helpers": "^7.28.4",
        "@babel/parser": "^7.28.4",
        "@babel/template": "^7.27.2",
        "@babel/traverse": "^7.28.4",
        "@babel/types": "^7.28.4",
        "@jridgewell/remapping": "^2.3.5",
        "convert-source-map": "^2.0.0",
        "debug": "^4.1.0",
        "gensync": "^1.0.0-beta.2",
        "json5": "^2.2.3",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/babel"
      }
    },
    "node_modules/@babel/generator": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/generator/-/generator-7.28.3.tgz",
      "integrity": "sha512-3lSpxGgvnmZznmBkCRnVREPUFJv2wrv9iAoFDvADJc0ypmdOxdUtcLeBgBJ6zE0PMeTKnxeQzyk0xTBq4Ep7zw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.28.3",
        "@babel/types": "^7.28.2",
        "@jridgewell/gen-mapping": "^0.3.12",
        "@jridgewell/trace-mapping": "^0.3.28",
        "jsesc": "^3.0.2"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-compilation-targets": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/helper-compilation-targets/-/helper-compilation-targets-7.27.2.tgz",
      "integrity": "sha512-2+1thGUUWWjLTYTHZWK1n8Yga0ijBz1XAhUXcKy81rd5g6yh7hGqMp45v7cadSbEHc9G3OTv45SyneRN3ps4DQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/compat-data": "^7.27.2",
        "@babel/helper-validator-option": "^7.27.1",
        "browserslist": "^4.24.0",
        "lru-cache": "^5.1.1",
        "semver": "^6.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-globals": {
      "version": "7.28.0",
      "resolved": "https://registry.npmjs.org/@babel/helper-globals/-/helper-globals-7.28.0.tgz",
      "integrity": "sha512-+W6cISkXFa1jXsDEdYA8HeevQT/FULhxzR99pxphltZcVaugps53THCeiWA8SguxxpSp3gKPiuYfSWopkLQ4hw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-imports": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-imports/-/helper-module-imports-7.27.1.tgz",
      "integrity": "sha512-0gSFWUPNXNopqtIPQvlD5WgXYI5GY2kP2cCvoT8kczjbfcfuIljTbcWrulD1CIPIX2gt1wghbDy08yE1p+/r3w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/traverse": "^7.27.1",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-module-transforms": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/helper-module-transforms/-/helper-module-transforms-7.28.3.tgz",
      "integrity": "sha512-gytXUbs8k2sXS9PnQptz5o0QnpLL51SwASIORY6XaBKF88nsOT0Zw9szLqlSGQDP/4TljBAD5y98p2U1fqkdsw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-module-imports": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1",
        "@babel/traverse": "^7.28.3"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0"
      }
    },
    "node_modules/@babel/helper-plugin-utils": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-plugin-utils/-/helper-plugin-utils-7.27.1.tgz",
      "integrity": "sha512-1gn1Up5YXka3YYAHGKpbideQ5Yjf1tDa9qYcgysz+cNCXukyLl6DjPXhD3VRwSb8c0J9tA4b2+rHEZtc6R0tlw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.27.1.tgz",
      "integrity": "sha512-D2hP9eA+Sqx1kBZgzxZh0y1trbuU+JoDkiEwqhQ36nodYqJwyEIhPSdMNd7lOm/4io72luTPWH20Yda0xOuUow==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-option": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-option/-/helper-validator-option-7.27.1.tgz",
      "integrity": "sha512-YvjJow9FxbhFFKDSuFnVCe2WxXk1zWc22fFePVNEaWJEu8IrZVlda6N0uHwzZrUM1il7NC9Mlp4MaJYbYd9JSg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helpers": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/helpers/-/helpers-7.28.4.tgz",
      "integrity": "sha512-HFN59MmQXGHVyYadKLVumYsA9dBFun/ldYxipEjzA4196jpLZd8UjEEBLkbEkvfYreDqJhZxYAWFPtrfhNpj4w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.4"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.4.tgz",
      "integrity": "sha512-yZbBqeM6TkpP9du/I2pUZnJsRMGGvOuIrhjzC1AwHwW+6he4mni6Bp/m8ijn0iOuZuPI2BfkCoSRunpyjnrQKg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.4"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-self": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-self/-/plugin-transform-react-jsx-self-7.27.1.tgz",
      "integrity": "sha512-6UzkCs+ejGdZ5mFFC/OCUrv028ab2fp1znZmCZjAOBKiBK2jXD1O+BPSfX8X2qjJ75fZBMSnQn3Rq2mrBJK2mw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/plugin-transform-react-jsx-source": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/plugin-transform-react-jsx-source/-/plugin-transform-react-jsx-source-7.27.1.tgz",
      "integrity": "sha512-zbwoTsBruTeKB9hSq73ha66iFeJHuaFkUbwvqElnygoNbj/jHRsSeokowZFN3CZ64IvEqcmmkVe89OPXc7ldAw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-plugin-utils": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      },
      "peerDependencies": {
        "@babel/core": "^7.0.0-0"
      }
    },
    "node_modules/@babel/runtime": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/runtime/-/runtime-7.28.4.tgz",
      "integrity": "sha512-Q/N6JNWvIvPnLDvjlE1OUBLPQHH6l3CltCEsHIujp45zQUSSh8K+gHnaEX45yAT1nyngnINhvWtzN+Nb9D8RAQ==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/template": {
      "version": "7.27.2",
      "resolved": "https://registry.npmjs.org/@babel/template/-/template-7.27.2.tgz",
      "integrity": "sha512-LPDZ85aEJyYSd18/DkjNh4/y1ntkE5KwUHWTiqgRxruuZL2F1yuHligVHLvcHY2vMHXttKFpJn6LwfI7cw7ODw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/parser": "^7.27.2",
        "@babel/types": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/traverse": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/traverse/-/traverse-7.28.4.tgz",
      "integrity": "sha512-YEzuboP2qvQavAcjgQNVgsvHIDv6ZpwXvcvjmyySP2DIMuByS/6ioU5G9pYrWHM6T2YDfc7xga9iNzYOs12CFQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/code-frame": "^7.27.1",
        "@babel/generator": "^7.28.3",
        "@babel/helper-globals": "^7.28.0",
        "@babel/parser": "^7.28.4",
        "@babel/template": "^7.27.2",
        "@babel/types": "^7.28.4",
        "debug": "^4.3.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/types": {
      "version": "7.28.4",
      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.4.tgz",
      "integrity": "sha512-bkFqkLhh3pMBUQQkpVgWDWq/lqzc2678eUyDlTBhRqhCHFguYYGM0Efga7tYk4TogG/3x0EEl66/OQ+WGbWB/Q==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/helper-string-parser": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@cypress/request": {
      "version": "3.0.9",
      "resolved": "https://registry.npmjs.org/@cypress/request/-/request-3.0.9.tgz",
      "integrity": "sha512-I3l7FdGRXluAS44/0NguwWlO83J18p0vlr2FYHrJkWdNYhgVoiYo61IXPqaOsL+vNxU1ZqMACzItGK3/KKDsdw==",
      "license": "Apache-2.0",
      "dependencies": {
        "aws-sign2": "~0.7.0",
        "aws4": "^1.8.0",
        "caseless": "~0.12.0",
        "combined-stream": "~1.0.6",
        "extend": "~3.0.2",
        "forever-agent": "~0.6.1",
        "form-data": "~4.0.4",
        "http-signature": "~1.4.0",
        "is-typedarray": "~1.0.0",
        "isstream": "~0.1.2",
        "json-stringify-safe": "~5.0.1",
        "mime-types": "~2.1.19",
        "performance-now": "^2.1.0",
        "qs": "6.14.0",
        "safe-buffer": "^5.1.2",
        "tough-cookie": "^5.0.0",
        "tunnel-agent": "^0.6.0",
        "uuid": "^8.3.2"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/@cypress/request-promise": {
      "version": "5.0.0",
      "resolved": "https://registry.npmjs.org/@cypress/request-promise/-/request-promise-5.0.0.tgz",
      "integrity": "sha512-eKdYVpa9cBEw2kTBlHeu1PP16Blwtum6QHg/u9s/MoHkZfuo1pRGka1VlUHXF5kdew82BvOJVVGk0x8X0nbp+w==",
      "license": "ISC",
      "dependencies": {
        "bluebird": "^3.5.0",
        "request-promise-core": "1.1.3",
        "stealthy-require": "^1.1.1",
        "tough-cookie": "^4.1.3"
      },
      "engines": {
        "node": ">=0.10.0"
      },
      "peerDependencies": {
        "@cypress/request": "^3.0.0"
      }
    },
    "node_modules/@cypress/request-promise/node_modules/tough-cookie": {
      "version": "4.1.4",
      "resolved": "https://registry.npmjs.org/tough-cookie/-/tough-cookie-4.1.4.tgz",
      "integrity": "sha512-Loo5UUvLD9ScZ6jh8beX1T6sO1w2/MpCRpEP7V280GKMVUQ0Jzar2U3UJPsrdbziLEMMhu3Ujnq//rhiFuIeag==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "psl": "^1.1.33",
        "punycode": "^2.1.1",
        "universalify": "^0.2.0",
        "url-parse": "^1.5.3"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/@cypress/request/node_modules/form-data": {
      "version": "4.0.5",
      "resolved": "https://registry.npmjs.org/form-data/-/form-data-4.0.5.tgz",
      "integrity": "sha512-8RipRLol37bNs2bhoV67fiTEvdTrbMUYcFTiy3+wuuOnUog2QBHCZWXDRijWQfAkhBj2Uf5UnVaiWwA5vdd82w==",
      "license": "MIT",
      "dependencies": {
        "asynckit": "^0.4.0",
        "combined-stream": "^1.0.8",
        "es-set-tostringtag": "^2.1.0",
        "hasown": "^2.0.2",
        "mime-types": "^2.1.12"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/@cypress/request/node_modules/qs": {
      "version": "6.14.0",
      "resolved": "https://registry.npmjs.org/qs/-/qs-6.14.0.tgz",
      "integrity": "sha512-YWWTjgABSKcvs/nWBi9PycY/JiPJqOD4JA6o9Sej2AtvSGarXxKC3OQSk4pAarbdQlKAh5D4FCQkJNkW+GAn3w==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "side-channel": "^1.1.0"
      },
      "engines": {
        "node": ">=0.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/@date-fns/tz": {
      "version": "1.4.1",
      "resolved": "https://registry.npmjs.org/@date-fns/tz/-/tz-1.4.1.tgz",
      "integrity": "sha512-P5LUNhtbj6YfI3iJjw5EL9eUAG6OitD0W3fWQcpQjDRc/QIsL0tRNuO1PcDvPccWL1fSTXXdE1ds+l95DV/OFA==",
      "license": "MIT"
    },
    "node_modules/@drizzle-team/brocli": {
      "version": "0.10.2",
      "resolved": "https://registry.npmjs.org/@drizzle-team/brocli/-/brocli-0.10.2.tgz",
      "integrity": "sha512-z33Il7l5dKjUgGULTqBsQBQwckHh5AbIuxhdsIxDDiZAzBOrZO6q9ogcWC65kU382AfynTfgNumVcNIjuIua6w==",
      "dev": true,
      "license": "Apache-2.0"
    },
    "node_modules/@esbuild-kit/core-utils": {
      "version": "3.3.2",
      "resolved": "https://registry.npmjs.org/@esbuild-kit/core-utils/-/core-utils-3.3.2.tgz",
      "integrity": "sha512-sPRAnw9CdSsRmEtnsl2WXWdyquogVpB3yZ3dgwJfe8zrOzTsV7cJvmwrKVa+0ma5BoiGJ+BoqkMvawbayKUsqQ==",
      "deprecated": "Merged into tsx: https://tsx.is",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "esbuild": "~0.18.20",
        "source-map-support": "^0.5.21"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/android-arm": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.18.20.tgz",
      "integrity": "sha512-fyi7TDI/ijKKNZTUJAQqiG5T7YjJXgnzkURqmGj13C6dCqckZBLdl4h7bkhHt/t0WP+zO9/zwroDvANaOqO5Sw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/android-arm64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.18.20.tgz",
      "integrity": "sha512-Nz4rJcchGDtENV0eMKUNa6L12zz2zBDXuhj/Vjh18zGqB44Bi7MBMSXjgunJgjRhCmKOjnPuZp4Mb6OKqtMHLQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/android-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.18.20.tgz",
      "integrity": "sha512-8GDdlePJA8D6zlZYJV/jnrRAi6rOiNaCC/JclcXpB+KIuvfBN4owLtgzY2bsxnx666XjJx2kDPUmnTtR8qKQUg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/darwin-arm64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.18.20.tgz",
      "integrity": "sha512-bxRHW5kHU38zS2lPTPOyuyTm+S+eobPUnTNkdJEfAddYgEcll4xkT8DB9d2008DtTbl7uJag2HuE5NZAZgnNEA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/darwin-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.18.20.tgz",
      "integrity": "sha512-pc5gxlMDxzm513qPGbCbDukOdsGtKhfxD1zJKXjCCcU7ju50O7MeAZ8c4krSJcOIJGFR+qx21yMMVYwiQvyTyQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/freebsd-arm64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.18.20.tgz",
      "integrity": "sha512-yqDQHy4QHevpMAaxhhIwYPMv1NECwOvIpGCZkECn8w2WFHXjEwrBn3CeNIYsibZ/iZEUemj++M26W3cNR5h+Tw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/freebsd-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.18.20.tgz",
      "integrity": "sha512-tgWRPPuQsd3RmBZwarGVHZQvtzfEBOreNuxEMKFcd5DaDn2PbBxfwLcj4+aenoh7ctXcbXmOQIn8HI6mCSw5MQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-arm": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.18.20.tgz",
      "integrity": "sha512-/5bHkMWnq1EgKr1V+Ybz3s1hWXok7mDFUMQ4cG10AfW3wL02PSZi5kFpYKrptDsgb2WAJIvRcDm+qIvXf/apvg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-arm64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.18.20.tgz",
      "integrity": "sha512-2YbscF+UL7SQAVIpnWvYwM+3LskyDmPhe31pE7/aoTMFKKzIc9lLbyGUpmmb8a8AixOL61sQ/mFh3jEjHYFvdA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-ia32": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.18.20.tgz",
      "integrity": "sha512-P4etWwq6IsReT0E1KHU40bOnzMHoH73aXp96Fs8TIT6z9Hu8G6+0SHSw9i2isWrD2nbx2qo5yUqACgdfVGx7TA==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-loong64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.18.20.tgz",
      "integrity": "sha512-nXW8nqBTrOpDLPgPY9uV+/1DjxoQ7DoB2N8eocyq8I9XuqJ7BiAMDMf9n1xZM9TgW0J8zrquIb/A7s3BJv7rjg==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-mips64el": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.18.20.tgz",
      "integrity": "sha512-d5NeaXZcHp8PzYy5VnXV3VSd2D328Zb+9dEq5HE6bw6+N86JVPExrA6O68OPwobntbNJ0pzCpUFZTo3w0GyetQ==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-ppc64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.18.20.tgz",
      "integrity": "sha512-WHPyeScRNcmANnLQkq6AfyXRFr5D6N2sKgkFo2FqguP44Nw2eyDlbTdZwd9GYk98DZG9QItIiTlFLHJHjxP3FA==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-riscv64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.18.20.tgz",
      "integrity": "sha512-WSxo6h5ecI5XH34KC7w5veNnKkju3zBRLEQNY7mv5mtBmrP/MjNBCAlsM2u5hDBlS3NGcTQpoBvRzqBcRtpq1A==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-s390x": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.18.20.tgz",
      "integrity": "sha512-+8231GMs3mAEth6Ja1iK0a1sQ3ohfcpzpRLH8uuc5/KVDFneH6jtAJLFGafpzpMRO6DzJ6AvXKze9LfFMrIHVQ==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/linux-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.18.20.tgz",
      "integrity": "sha512-UYqiqemphJcNsFEskc73jQ7B9jgwjWrSayxawS6UVFZGWrAAtkzjxSqnoclCXxWtfwLdzU+vTpcNYhpn43uP1w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/netbsd-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.18.20.tgz",
      "integrity": "sha512-iO1c++VP6xUBUmltHZoMtCUdPlnPGdBom6IrO4gyKPFFVBKioIImVooR5I83nTew5UOYrk3gIJhbZh8X44y06A==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/openbsd-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.18.20.tgz",
      "integrity": "sha512-e5e4YSsuQfX4cxcygw/UCPIEP6wbIL+se3sxPdCiMbFLBWu0eiZOJ7WoD+ptCLrmjZBK1Wk7I6D/I3NglUGOxg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/sunos-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.18.20.tgz",
      "integrity": "sha512-kDbFRFp0YpTQVVrqUd5FTYmWo45zGaXe0X8E1G/LKFC0v8x0vWrhOWSLITcCn63lmZIxfOMXtCfti/RxN/0wnQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/win32-arm64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.18.20.tgz",
      "integrity": "sha512-ddYFR6ItYgoaq4v4JmQQaAI5s7npztfV4Ag6NrhiaW0RrnOXqBkgwZLofVTlq1daVTQNhtI5oieTvkRPfZrePg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/win32-ia32": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.18.20.tgz",
      "integrity": "sha512-Wv7QBi3ID/rROT08SABTS7eV4hX26sVduqDOTe1MvGMjNd3EjOz4b7zeexIR62GTIEKrfJXKL9LFxTYgkyeu7g==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/@esbuild/win32-x64": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.18.20.tgz",
      "integrity": "sha512-kTdfRcSiDfQca/y9QIkng02avJ+NCaQvrMejlsB3RRv5sE9rRoeBPISaZpKxHELzRxZyLvNts1P27W3wV+8geQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@esbuild-kit/core-utils/node_modules/esbuild": {
      "version": "0.18.20",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.18.20.tgz",
      "integrity": "sha512-ceqxoedUrcayh7Y7ZX6NdbbDzGROiyVBgC4PriJThBKSVPWnnFHZAkfI1lJT8QFkOwH4qOS2SJkS4wvpGl8BpA==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=12"
      },
      "optionalDependencies": {
        "@esbuild/android-arm": "0.18.20",
        "@esbuild/android-arm64": "0.18.20",
        "@esbuild/android-x64": "0.18.20",
        "@esbuild/darwin-arm64": "0.18.20",
        "@esbuild/darwin-x64": "0.18.20",
        "@esbuild/freebsd-arm64": "0.18.20",
        "@esbuild/freebsd-x64": "0.18.20",
        "@esbuild/linux-arm": "0.18.20",
        "@esbuild/linux-arm64": "0.18.20",
        "@esbuild/linux-ia32": "0.18.20",
        "@esbuild/linux-loong64": "0.18.20",
        "@esbuild/linux-mips64el": "0.18.20",
        "@esbuild/linux-ppc64": "0.18.20",
        "@esbuild/linux-riscv64": "0.18.20",
        "@esbuild/linux-s390x": "0.18.20",
        "@esbuild/linux-x64": "0.18.20",
        "@esbuild/netbsd-x64": "0.18.20",
        "@esbuild/openbsd-x64": "0.18.20",
        "@esbuild/sunos-x64": "0.18.20",
        "@esbuild/win32-arm64": "0.18.20",
        "@esbuild/win32-ia32": "0.18.20",
        "@esbuild/win32-x64": "0.18.20"
      }
    },
    "node_modules/@esbuild-kit/esm-loader": {
      "version": "2.6.5",
      "resolved": "https://registry.npmjs.org/@esbuild-kit/esm-loader/-/esm-loader-2.6.5.tgz",
      "integrity": "sha512-FxEMIkJKnodyA1OaCUoEvbYRkoZlLZ4d/eXFu9Fh8CbBBgP5EmZxrfTRyN0qpXZ4vOvqnE5YdRdcrmUUXuU+dA==",
      "deprecated": "Merged into tsx: https://tsx.is",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@esbuild-kit/core-utils": "^3.3.2",
        "get-tsconfig": "^4.7.0"
      }
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.25.9.tgz",
      "integrity": "sha512-OaGtL73Jck6pBKjNIe24BnFE6agGl+6KxDtTfHhy1HmhthfKouEcOhqpSL64K4/0WCtbKFLOdzD/44cJ4k9opA==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.25.9.tgz",
      "integrity": "sha512-5WNI1DaMtxQ7t7B6xa572XMXpHAaI/9Hnhk8lcxF4zVN4xstUgTlvuGDorBguKEnZO70qwEcLpfifMLoxiPqHQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.25.9.tgz",
      "integrity": "sha512-IDrddSmpSv51ftWslJMvl3Q2ZT98fUSL2/rlUXuVqRXHCs5EUF1/f+jbjF5+NG9UffUDMCiTyh8iec7u8RlTLg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.25.9.tgz",
      "integrity": "sha512-I853iMZ1hWZdNllhVZKm34f4wErd4lMyeV7BLzEExGEIZYsOzqDWDf+y082izYUE8gtJnYHdeDpN/6tUdwvfiw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.25.9.tgz",
      "integrity": "sha512-XIpIDMAjOELi/9PB30vEbVMs3GV1v2zkkPnuyRRURbhqjyzIINwj+nbQATh4H9GxUgH1kFsEyQMxwiLFKUS6Rg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.25.9.tgz",
      "integrity": "sha512-jhHfBzjYTA1IQu8VyrjCX4ApJDnH+ez+IYVEoJHeqJm9VhG9Dh2BYaJritkYK3vMaXrf7Ogr/0MQ8/MeIefsPQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.25.9.tgz",
      "integrity": "sha512-z93DmbnY6fX9+KdD4Ue/H6sYs+bhFQJNCPZsi4XWJoYblUqT06MQUdBCpcSfuiN72AbqeBFu5LVQTjfXDE2A6Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.25.9.tgz",
      "integrity": "sha512-mrKX6H/vOyo5v71YfXWJxLVxgy1kyt1MQaD8wZJgJfG4gq4DpQGpgTB74e5yBeQdyMTbgxp0YtNj7NuHN0PoZg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.25.9.tgz",
      "integrity": "sha512-HBU2Xv78SMgaydBmdor38lg8YDnFKSARg1Q6AT0/y2ezUAKiZvc211RDFHlEZRFNRVhcMamiToo7bDx3VEOYQw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.25.9.tgz",
      "integrity": "sha512-BlB7bIcLT3G26urh5Dmse7fiLmLXnRlopw4s8DalgZ8ef79Jj4aUcYbk90g8iCa2467HX8SAIidbL7gsqXHdRw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.25.9.tgz",
      "integrity": "sha512-e7S3MOJPZGp2QW6AK6+Ly81rC7oOSerQ+P8L0ta4FhVi+/j/v2yZzx5CqqDaWjtPFfYz21Vi1S0auHrap3Ma3A==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.25.9.tgz",
      "integrity": "sha512-Sbe10Bnn0oUAB2AalYztvGcK+o6YFFA/9829PhOCUS9vkJElXGdphz0A3DbMdP8gmKkqPmPcMJmJOrI3VYB1JQ==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.25.9.tgz",
      "integrity": "sha512-YcM5br0mVyZw2jcQeLIkhWtKPeVfAerES5PvOzaDxVtIyZ2NUBZKNLjC5z3/fUlDgT6w89VsxP2qzNipOaaDyA==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.25.9.tgz",
      "integrity": "sha512-++0HQvasdo20JytyDpFvQtNrEsAgNG2CY1CLMwGXfFTKGBGQT3bOeLSYE2l1fYdvML5KUuwn9Z8L1EWe2tzs1w==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.25.9.tgz",
      "integrity": "sha512-uNIBa279Y3fkjV+2cUjx36xkx7eSjb8IvnL01eXUKXez/CBHNRw5ekCGMPM0BcmqBxBcdgUWuUXmVWwm4CH9kg==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.25.9.tgz",
      "integrity": "sha512-Mfiphvp3MjC/lctb+7D287Xw1DGzqJPb/J2aHHcHxflUo+8tmN/6d4k6I2yFR7BVo5/g7x2Monq4+Yew0EHRIA==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.25.9.tgz",
      "integrity": "sha512-iSwByxzRe48YVkmpbgoxVzn76BXjlYFXC7NvLYq+b+kDjyyk30J0JY47DIn8z1MO3K0oSl9fZoRmZPQI4Hklzg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-arm64/-/netbsd-arm64-0.25.9.tgz",
      "integrity": "sha512-9jNJl6FqaUG+COdQMjSCGW4QiMHH88xWbvZ+kRVblZsWrkXlABuGdFJ1E9L7HK+T0Yqd4akKNa/lO0+jDxQD4Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.25.9.tgz",
      "integrity": "sha512-RLLdkflmqRG8KanPGOU7Rpg829ZHu8nFy5Pqdi9U01VYtG9Y0zOG6Vr2z4/S+/3zIyOxiK6cCeYNWOFR9QP87g==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.25.9.tgz",
      "integrity": "sha512-YaFBlPGeDasft5IIM+CQAhJAqS3St3nJzDEgsgFixcfZeyGPCd6eJBWzke5piZuZ7CtL656eOSYKk4Ls2C0FRQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.25.9.tgz",
      "integrity": "sha512-1MkgTCuvMGWuqVtAvkpkXFmtL8XhWy+j4jaSO2wxfJtilVCi0ZE37b8uOdMItIHz4I6z1bWWtEX4CJwcKYLcuA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openharmony-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/openharmony-arm64/-/openharmony-arm64-0.25.9.tgz",
      "integrity": "sha512-4Xd0xNiMVXKh6Fa7HEJQbrpP3m3DDn43jKxMjxLLRjWnRsfxjORYJlXPO4JNcXtOyfajXorRKY9NkOpTHptErg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.25.9.tgz",
      "integrity": "sha512-WjH4s6hzo00nNezhp3wFIAfmGZ8U7KtrJNlFMRKxiI9mxEK1scOMAaa9i4crUtu+tBr+0IN6JCuAcSBJZfnphw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.25.9.tgz",
      "integrity": "sha512-mGFrVJHmZiRqmP8xFOc6b84/7xa5y5YvR1x8djzXpJBSv/UsNK6aqec+6JDjConTgvvQefdGhFDAs2DLAds6gQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.25.9.tgz",
      "integrity": "sha512-b33gLVU2k11nVx1OhX3C8QQP6UHQK4ZtN56oFWvVXvz2VkDoe6fbG8TOgHFxEvqeqohmRnIHe5A1+HADk4OQww==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.25.9.tgz",
      "integrity": "sha512-PPOl1mi6lpLNQxnGoyAfschAodRFYXJ+9fs6WHXz7CSWKbOqiMZsubC+BQsVKuul+3vKLuwTHsS2c2y9EoKwxQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@floating-ui/core": {
      "version": "1.7.3",
      "resolved": "https://registry.npmjs.org/@floating-ui/core/-/core-1.7.3.tgz",
      "integrity": "sha512-sGnvb5dmrJaKEZ+LDIpguvdX3bDlEllmv4/ClQ9awcmCZrlx5jQyyMWFM5kBI+EyNOCDDiKk8il0zeuX3Zlg/w==",
      "license": "MIT",
      "dependencies": {
        "@floating-ui/utils": "^0.2.10"
      }
    },
    "node_modules/@floating-ui/dom": {
      "version": "1.7.4",
      "resolved": "https://registry.npmjs.org/@floating-ui/dom/-/dom-1.7.4.tgz",
      "integrity": "sha512-OOchDgh4F2CchOX94cRVqhvy7b3AFb+/rQXyswmzmGakRfkMgoWVjfnLWkRirfLEfuD4ysVW16eXzwt3jHIzKA==",
      "license": "MIT",
      "dependencies": {
        "@floating-ui/core": "^1.7.3",
        "@floating-ui/utils": "^0.2.10"
      }
    },
    "node_modules/@floating-ui/react-dom": {
      "version": "2.1.6",
      "resolved": "https://registry.npmjs.org/@floating-ui/react-dom/-/react-dom-2.1.6.tgz",
      "integrity": "sha512-4JX6rEatQEvlmgU80wZyq9RT96HZJa88q8hp0pBd+LrczeDI4o6uA2M+uvxngVHo4Ihr8uibXxH6+70zhAFrVw==",
      "license": "MIT",
      "dependencies": {
        "@floating-ui/dom": "^1.7.4"
      },
      "peerDependencies": {
        "react": ">=16.8.0",
        "react-dom": ">=16.8.0"
      }
    },
    "node_modules/@floating-ui/utils": {
      "version": "0.2.10",
      "resolved": "https://registry.npmjs.org/@floating-ui/utils/-/utils-0.2.10.tgz",
      "integrity": "sha512-aGTxbpbg8/b5JfU1HXSrbH3wXZuLPJcNEcZQFMxLs3oSzgtVu6nFPkbbGGUvBcUjKV2YyB9Wxxabo+HEH9tcRQ==",
      "license": "MIT"
    },
    "node_modules/@hookform/resolvers": {
      "version": "3.10.0",
      "resolved": "https://registry.npmjs.org/@hookform/resolvers/-/resolvers-3.10.0.tgz",
      "integrity": "sha512-79Dv+3mDF7i+2ajj7SkypSKHhl1cbln1OGavqrsF7p6mbUv11xpqpacPsGDCTRvCSjEEIez2ef1NveSVL3b0Ag==",
      "peerDependencies": {
        "react-hook-form": "^7.0.0"
      }
    },
    "node_modules/@jridgewell/gen-mapping": {
      "version": "0.3.13",
      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.0",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/remapping": {
      "version": "2.3.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/remapping/-/remapping-2.3.5.tgz",
      "integrity": "sha512-LI9u/+laYG4Ds1TDKSJW2YPrIlcVYOwi2fUC6xB43lueCjgxV4lffOCZCtYFiH6TNOX+tQKXx97T4IKHbhyHEQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.5",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/resolve-uri": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
      "license": "MIT",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "license": "MIT"
    },
    "node_modules/@jridgewell/trace-mapping": {
      "version": "0.3.31",
      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.31.tgz",
      "integrity": "sha512-zzNR+SdQSDJzc8joaeP8QQoCQr8NuYx2dIIytl1QeBEZHJ9uW6hebsrYgbz8hJwUQao3TWCMtmfV8Nu1twOLAw==",
      "license": "MIT",
      "dependencies": {
        "@jridgewell/resolve-uri": "^3.1.0",
        "@jridgewell/sourcemap-codec": "^1.4.14"
      }
    },
    "node_modules/@neondatabase/serverless": {
      "version": "0.10.4",
      "resolved": "https://registry.npmjs.org/@neondatabase/serverless/-/serverless-0.10.4.tgz",
      "integrity": "sha512-2nZuh3VUO9voBauuh+IGYRhGU/MskWHt1IuZvHcJw6GLjDgtqj/KViKo7SIrLdGLdot7vFbiRRw+BgEy3wT9HA==",
      "license": "MIT",
      "optional": true,
      "peer": true,
      "dependencies": {
        "@types/pg": "8.11.6"
      }
    },
    "node_modules/@radix-ui/number": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/number/-/number-1.1.1.tgz",
      "integrity": "sha512-MkKCwxlXTgz6CFoJx3pCwn07GKp36+aZyu/u2Ln2VrA5DcdyCZkASEDBTd8x5whTQQL5CiYf4prXKLcgQdv29g=="
    },
    "node_modules/@radix-ui/primitive": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.2.tgz",
      "integrity": "sha512-XnbHrrprsNqZKQhStrSwgRUQzoCI1glLzdw79xiZPoofhGICeZRSQ3dIxAKH1gb3OHfNf4d6f+vAv3kil2eggA=="
    },
    "node_modules/@radix-ui/react-accordion": {
      "version": "1.2.12",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-accordion/-/react-accordion-1.2.12.tgz",
      "integrity": "sha512-T4nygeh9YE9dLRPhAHSeOZi7HBXo+0kYIPJXayZfvWOWA0+n3dESrZbjfDPUABkUNym6Hd+f2IR113To8D2GPA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-collapsible": "1.1.12",
        "@radix-ui/react-collection": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-accordion/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-accordion/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-alert-dialog": {
      "version": "1.1.15",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-alert-dialog/-/react-alert-dialog-1.1.15.tgz",
      "integrity": "sha512-oTVLkEw5GpdRe29BqJ0LSDFWI3qu0vR1M0mUkOQWDIUnY/QIkLpgDMWuKxP94c2NAC2LGcgVhG1ImF3jkZ5wXw==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-dialog": "1.1.15",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-slot": "1.2.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-alert-dialog/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-alert-dialog/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-arrow": {
      "version": "1.1.7",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-arrow/-/react-arrow-1.1.7.tgz",
      "integrity": "sha512-F+M1tLhO+mlQaOWspE8Wstg+z6PwxwRd8oQ8IXceWz92kfAmalTRf0EjrouQeo7QssEPfCn05B4Ihs1K9WQ/7w==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.1.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-aspect-ratio": {
      "version": "1.1.8",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-aspect-ratio/-/react-aspect-ratio-1.1.8.tgz",
      "integrity": "sha512-5nZrJTF7gH+e0nZS7/QxFz6tJV4VimhQb1avEgtsJxvvIp5JilL+c58HICsKzPxghdwaDt48hEfPM1au4zGy+w==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.1.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-aspect-ratio/node_modules/@radix-ui/react-primitive": {
      "version": "2.1.4",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-primitive/-/react-primitive-2.1.4.tgz",
      "integrity": "sha512-9hQc4+GNVtJAIEPEqlYqW5RiYdrr8ea5XQ0ZOnD6fgru+83kqT15mq2OCcbe8KnjRZl5vF3ks69AKz3kh1jrhg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-slot": "1.2.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-avatar": {
      "version": "1.1.11",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-avatar/-/react-avatar-1.1.11.tgz",
      "integrity": "sha512-0Qk603AHGV28BOBO34p7IgD5m+V5Sg/YovfayABkoDDBM5d3NCx0Mp4gGrjzLGes1jV5eNOE1r3itqOR33VC6Q==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-context": "1.1.3",
        "@radix-ui/react-primitive": "2.1.4",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-is-hydrated": "0.1.0",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-avatar/node_modules/@radix-ui/react-context": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-context/-/react-context-1.1.3.tgz",
      "integrity": "sha512-ieIFACdMpYfMEjF0rEf5KLvfVyIkOz6PDGyNnP+u+4xQ6jny3VCgA4OgXOwNx2aUkxn8zx9fiVcM8CfFYv9Lxw==",
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-avatar/node_modules/@radix-ui/react-primitive": {
      "version": "2.1.4",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-primitive/-/react-primitive-2.1.4.tgz",
      "integrity": "sha512-9hQc4+GNVtJAIEPEqlYqW5RiYdrr8ea5XQ0ZOnD6fgru+83kqT15mq2OCcbe8KnjRZl5vF3ks69AKz3kh1jrhg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-slot": "1.2.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-checkbox": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-checkbox/-/react-checkbox-1.3.3.tgz",
      "integrity": "sha512-wBbpv+NQftHDdG86Qc0pIyXk5IR3tM8Vd0nWLKDcX8nNn4nXFOFwsKuqw2okA/1D/mpaAkmuyndrPJTYDNZtFw==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-use-previous": "1.1.1",
        "@radix-ui/react-use-size": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-checkbox/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-checkbox/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-collapsible": {
      "version": "1.1.12",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-collapsible/-/react-collapsible-1.1.12.tgz",
      "integrity": "sha512-Uu+mSh4agx2ib1uIGPP4/CKNULyajb3p92LsVXmH2EHVMTfZWpll88XJ0j4W0z3f8NK1eYl1+Mf/szHPmcHzyA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-collapsible/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-collapsible/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-collection": {
      "version": "1.1.7",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-collection/-/react-collection-1.1.7.tgz",
      "integrity": "sha512-Fh9rGN0MoI4ZFUNyfFVNU4y9LUz93u9/0K+yLgA2bwRojxM8JU1DyvvMBabnZPBgMWREAJvU2jjVzq+LrFUglw==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-slot": "1.2.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-collection/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-compose-refs": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-compose-refs/-/react-compose-refs-1.1.2.tgz",
      "integrity": "sha512-z4eqJvfiNnFMHIIvXP3CY57y2WJs5g2v3X0zm9mEJkrkNv4rDxu+sg9Jh8EkXyeqBkB7SOcboo9dMVqhyrACIg==",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-context": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-context/-/react-context-1.1.2.tgz",
      "integrity": "sha512-jCi/QKUM2r1Ju5a3J64TH2A5SpKAgh0LpknyqdQ4m6DCV0xJ2HG1xARRwNGPQfi1SLdLWZ1OJz6F4OMBBNiGJA==",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-context-menu": {
      "version": "2.2.16",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-context-menu/-/react-context-menu-2.2.16.tgz",
      "integrity": "sha512-O8morBEW+HsVG28gYDZPTrT9UUovQUlJue5YO836tiTJhuIWBm/zQHc7j388sHWtdH/xUZurK9olD2+pcqx5ww==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-menu": "2.1.16",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-context-menu/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-context-menu/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-dialog": {
      "version": "1.1.15",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-dialog/-/react-dialog-1.1.15.tgz",
      "integrity": "sha512-TCglVRtzlffRNxRMEyR36DGBLJpeusFcgMVD9PZEzAKnUs1lKCgX5u9BmC2Yg+LL9MgZDugFFs1Vl+Jp4t/PGw==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-dismissable-layer": "1.1.11",
        "@radix-ui/react-focus-guards": "1.1.3",
        "@radix-ui/react-focus-scope": "1.1.7",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-portal": "1.1.9",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-slot": "1.2.3",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "aria-hidden": "^1.2.4",
        "react-remove-scroll": "^2.6.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-dialog/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-dialog/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-dialog/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-direction": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-direction/-/react-direction-1.1.1.tgz",
      "integrity": "sha512-1UEWRX6jnOA2y4H5WczZ44gOOjTEmlqv1uNW4GAJEO5+bauCBhv8snY65Iw5/VOS/ghKN9gr2KjnLKxrsvoMVw==",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-dismissable-layer": {
      "version": "1.1.11",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-dismissable-layer/-/react-dismissable-layer-1.1.11.tgz",
      "integrity": "sha512-Nqcp+t5cTB8BinFkZgXiMJniQH0PsUt2k51FUhbdfeKvc4ACcG2uQniY/8+h1Yv6Kza4Q7lD7PQV0z0oicE0Mg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-escape-keydown": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-dismissable-layer/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-dropdown-menu": {
      "version": "2.1.16",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-dropdown-menu/-/react-dropdown-menu-2.1.16.tgz",
      "integrity": "sha512-1PLGQEynI/3OX/ftV54COn+3Sud/Mn8vALg2rWnBLnRaGtJDduNW/22XjlGgPdpcIbiQxjKtb7BkcjP00nqfJw==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-menu": "2.1.16",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-dropdown-menu/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-dropdown-menu/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-focus-guards": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-focus-guards/-/react-focus-guards-1.1.3.tgz",
      "integrity": "sha512-0rFg/Rj2Q62NCm62jZw0QX7a3sz6QCQU0LpZdNrJX8byRGaGVTqbrW9jAoIAHyMQqsNpeZ81YgSizOt5WXq0Pw==",
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-focus-scope": {
      "version": "1.1.7",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-focus-scope/-/react-focus-scope-1.1.7.tgz",
      "integrity": "sha512-t2ODlkXBQyn7jkl6TNaw/MtVEVvIGelJDCG41Okq/KwUsJBwQ4XVZsHAVUkK4mBv3ewiAS3PGuUWuY2BoK4ZUw==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-callback-ref": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-hover-card": {
      "version": "1.1.15",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-hover-card/-/react-hover-card-1.1.15.tgz",
      "integrity": "sha512-qgTkjNT1CfKMoP0rcasmlH2r1DAiYicWsDsufxl940sT2wHNEWWv6FMWIQXWhVdmC1d/HYfbhQx60KYyAtKxjg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-dismissable-layer": "1.1.11",
        "@radix-ui/react-popper": "1.2.8",
        "@radix-ui/react-portal": "1.1.9",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-hover-card/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-hover-card/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-id": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-id/-/react-id-1.1.1.tgz",
      "integrity": "sha512-kGkGegYIdQsOb4XjsfM97rXsiHaBwco+hFI66oO4s9LU+PLAC5oJ7khdOVFxkhsmlbpUqDAvXw11CluXP+jkHg==",
      "dependencies": {
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-label": {
      "version": "2.1.8",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-label/-/react-label-2.1.8.tgz",
      "integrity": "sha512-FmXs37I6hSBVDlO4y764TNz1rLgKwjJMQ0EGte6F3Cb3f4bIuHB/iLa/8I9VKkmOy+gNHq8rql3j686ACVV21A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.1.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-label/node_modules/@radix-ui/react-primitive": {
      "version": "2.1.4",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-primitive/-/react-primitive-2.1.4.tgz",
      "integrity": "sha512-9hQc4+GNVtJAIEPEqlYqW5RiYdrr8ea5XQ0ZOnD6fgru+83kqT15mq2OCcbe8KnjRZl5vF3ks69AKz3kh1jrhg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-slot": "1.2.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-menu": {
      "version": "2.1.16",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-menu/-/react-menu-2.1.16.tgz",
      "integrity": "sha512-72F2T+PLlphrqLcAotYPp0uJMr5SjP5SL01wfEspJbru5Zs5vQaSHb4VB3ZMJPimgHHCHG7gMOeOB9H3Hdmtxg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-collection": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-dismissable-layer": "1.1.11",
        "@radix-ui/react-focus-guards": "1.1.3",
        "@radix-ui/react-focus-scope": "1.1.7",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-popper": "1.2.8",
        "@radix-ui/react-portal": "1.1.9",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-roving-focus": "1.1.11",
        "@radix-ui/react-slot": "1.2.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "aria-hidden": "^1.2.4",
        "react-remove-scroll": "^2.6.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-menu/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-menu/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-menubar": {
      "version": "1.1.16",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-menubar/-/react-menubar-1.1.16.tgz",
      "integrity": "sha512-EB1FktTz5xRRi2Er974AUQZWg2yVBb1yjip38/lgwtCVRd3a+maUoGHN/xs9Yv8SY8QwbSEb+YrxGadVWbEutA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-collection": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-menu": "2.1.16",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-roving-focus": "1.1.11",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-menubar/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-menubar/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-navigation-menu": {
      "version": "1.2.14",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-navigation-menu/-/react-navigation-menu-1.2.14.tgz",
      "integrity": "sha512-YB9mTFQvCOAQMHU+C/jVl96WmuWeltyUEpRJJky51huhds5W2FQr1J8D/16sQlf0ozxkPK8uF3niQMdUwZPv5w==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-collection": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-dismissable-layer": "1.1.11",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-use-layout-effect": "1.1.1",
        "@radix-ui/react-use-previous": "1.1.1",
        "@radix-ui/react-visually-hidden": "1.2.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-navigation-menu/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-navigation-menu/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-popover": {
      "version": "1.1.15",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-popover/-/react-popover-1.1.15.tgz",
      "integrity": "sha512-kr0X2+6Yy/vJzLYJUPCZEc8SfQcf+1COFoAqauJm74umQhta9M7lNJHP7QQS3vkvcGLQUbWpMzwrXYwrYztHKA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-dismissable-layer": "1.1.11",
        "@radix-ui/react-focus-guards": "1.1.3",
        "@radix-ui/react-focus-scope": "1.1.7",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-popper": "1.2.8",
        "@radix-ui/react-portal": "1.1.9",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-slot": "1.2.3",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "aria-hidden": "^1.2.4",
        "react-remove-scroll": "^2.6.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-popover/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-popover/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-popover/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-popper": {
      "version": "1.2.8",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-popper/-/react-popper-1.2.8.tgz",
      "integrity": "sha512-0NJQ4LFFUuWkE7Oxf0htBKS6zLkkjBH+hM1uk7Ng705ReR8m/uelduy1DBo0PyBXPKVnBA6YBlU94MBGXrSBCw==",
      "license": "MIT",
      "dependencies": {
        "@floating-ui/react-dom": "^2.0.0",
        "@radix-ui/react-arrow": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-layout-effect": "1.1.1",
        "@radix-ui/react-use-rect": "1.1.1",
        "@radix-ui/react-use-size": "1.1.1",
        "@radix-ui/rect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-portal": {
      "version": "1.1.9",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-portal/-/react-portal-1.1.9.tgz",
      "integrity": "sha512-bpIxvq03if6UNwXZ+HTK71JLh4APvnXntDc6XOX8UVq4XQOVl7lwok0AvIl+b8zgCw3fSaVTZMpAPPagXbKmHQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-presence": {
      "version": "1.1.5",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-presence/-/react-presence-1.1.5.tgz",
      "integrity": "sha512-/jfEwNDdQVBCNvjkGit4h6pMOzq8bHkopq458dPt2lMjx+eBQUohZNG9A7DtO/O5ukSbxuaNGXMjHicgwy6rQQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-primitive": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-primitive/-/react-primitive-2.1.3.tgz",
      "integrity": "sha512-m9gTwRkhy2lvCPe6QJp4d3G1TYEUHn/FzJUtq9MjH46an1wJU+GdoGC5VLof8RX8Ft/DlpshApkhswDLZzHIcQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-slot": "1.2.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-primitive/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-progress": {
      "version": "1.1.8",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-progress/-/react-progress-1.1.8.tgz",
      "integrity": "sha512-+gISHcSPUJ7ktBy9RnTqbdKW78bcGke3t6taawyZ71pio1JewwGSJizycs7rLhGTvMJYCQB1DBK4KQsxs7U8dA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-context": "1.1.3",
        "@radix-ui/react-primitive": "2.1.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-progress/node_modules/@radix-ui/react-context": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-context/-/react-context-1.1.3.tgz",
      "integrity": "sha512-ieIFACdMpYfMEjF0rEf5KLvfVyIkOz6PDGyNnP+u+4xQ6jny3VCgA4OgXOwNx2aUkxn8zx9fiVcM8CfFYv9Lxw==",
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-progress/node_modules/@radix-ui/react-primitive": {
      "version": "2.1.4",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-primitive/-/react-primitive-2.1.4.tgz",
      "integrity": "sha512-9hQc4+GNVtJAIEPEqlYqW5RiYdrr8ea5XQ0ZOnD6fgru+83kqT15mq2OCcbe8KnjRZl5vF3ks69AKz3kh1jrhg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-slot": "1.2.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-radio-group": {
      "version": "1.3.8",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-radio-group/-/react-radio-group-1.3.8.tgz",
      "integrity": "sha512-VBKYIYImA5zsxACdisNQ3BjCBfmbGH3kQlnFVqlWU4tXwjy7cGX8ta80BcrO+WJXIn5iBylEH3K6ZTlee//lgQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-roving-focus": "1.1.11",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-use-previous": "1.1.1",
        "@radix-ui/react-use-size": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-radio-group/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-radio-group/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-roving-focus": {
      "version": "1.1.11",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-roving-focus/-/react-roving-focus-1.1.11.tgz",
      "integrity": "sha512-7A6S9jSgm/S+7MdtNDSb+IU859vQqJ/QAtcYQcfFC6W8RS4IxIZDldLR0xqCFZ6DCyrQLjLPsxtTNch5jVA4lA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-collection": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-roving-focus/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-roving-focus/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-scroll-area": {
      "version": "1.2.10",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-scroll-area/-/react-scroll-area-1.2.10.tgz",
      "integrity": "sha512-tAXIa1g3sM5CGpVT0uIbUx/U3Gs5N8T52IICuCtObaos1S8fzsrPXG5WObkQN3S6NVl6wKgPhAIiBGbWnvc97A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/number": "1.1.1",
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-scroll-area/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-select": {
      "version": "2.2.6",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-select/-/react-select-2.2.6.tgz",
      "integrity": "sha512-I30RydO+bnn2PQztvo25tswPH+wFBjehVGtmagkU78yMdwTwVf12wnAOF+AeP8S2N8xD+5UPbGhkUfPyvT+mwQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/number": "1.1.1",
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-collection": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-dismissable-layer": "1.1.11",
        "@radix-ui/react-focus-guards": "1.1.3",
        "@radix-ui/react-focus-scope": "1.1.7",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-popper": "1.2.8",
        "@radix-ui/react-portal": "1.1.9",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-slot": "1.2.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-use-layout-effect": "1.1.1",
        "@radix-ui/react-use-previous": "1.1.1",
        "@radix-ui/react-visually-hidden": "1.2.3",
        "aria-hidden": "^1.2.4",
        "react-remove-scroll": "^2.6.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-select/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-select/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-select/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-separator": {
      "version": "1.1.8",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-separator/-/react-separator-1.1.8.tgz",
      "integrity": "sha512-sDvqVY4itsKwwSMEe0jtKgfTh+72Sy3gPmQpjqcQneqQ4PFmr/1I0YA+2/puilhggCe2gJcx5EBAYFkWkdpa5g==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.1.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-separator/node_modules/@radix-ui/react-primitive": {
      "version": "2.1.4",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-primitive/-/react-primitive-2.1.4.tgz",
      "integrity": "sha512-9hQc4+GNVtJAIEPEqlYqW5RiYdrr8ea5XQ0ZOnD6fgru+83kqT15mq2OCcbe8KnjRZl5vF3ks69AKz3kh1jrhg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-slot": "1.2.4"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-slider": {
      "version": "1.3.6",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slider/-/react-slider-1.3.6.tgz",
      "integrity": "sha512-JPYb1GuM1bxfjMRlNLE+BcmBC8onfCi60Blk7OBqi2MLTFdS+8401U4uFjnwkOr49BLmXxLC6JHkvAsx5OJvHw==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/number": "1.1.1",
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-collection": "1.1.7",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-use-layout-effect": "1.1.1",
        "@radix-ui/react-use-previous": "1.1.1",
        "@radix-ui/react-use-size": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-slider/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-slider/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-slot": {
      "version": "1.2.4",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.4.tgz",
      "integrity": "sha512-Jl+bCv8HxKnlTLVrcDE8zTMJ09R9/ukw4qBs/oZClOfoQk/cOTbDn+NceXfV7j09YPVQUryJPHurafcSg6EVKA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-switch": {
      "version": "1.2.6",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-switch/-/react-switch-1.2.6.tgz",
      "integrity": "sha512-bByzr1+ep1zk4VubeEVViV592vu2lHE2BZY5OnzehZqOOgogN80+mNtCqPkhn2gklJqOpxWgPoYTSnhBCqpOXQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-use-previous": "1.1.1",
        "@radix-ui/react-use-size": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-switch/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-switch/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-tabs": {
      "version": "1.1.13",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-tabs/-/react-tabs-1.1.13.tgz",
      "integrity": "sha512-7xdcatg7/U+7+Udyoj2zodtI9H/IIopqo+YOIcZOq1nJwXWBZ9p8xiu5llXlekDbZkca79a/fozEYQXIA4sW6A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-roving-focus": "1.1.11",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-tabs/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-tabs/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast": {
      "version": "1.2.7",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-toast/-/react-toast-1.2.7.tgz",
      "integrity": "sha512-0IWTbAUKvzdpOaWDMZisXZvScXzF0phaQjWspK8RUMEUxjLbli+886mB/kXTIC3F+t5vQ0n0vYn+dsX8s+WdfA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.2",
        "@radix-ui/react-collection": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-dismissable-layer": "1.1.6",
        "@radix-ui/react-portal": "1.1.5",
        "@radix-ui/react-presence": "1.1.3",
        "@radix-ui/react-primitive": "2.0.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-controllable-state": "1.1.1",
        "@radix-ui/react-use-layout-effect": "1.1.1",
        "@radix-ui/react-visually-hidden": "1.1.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast/node_modules/@radix-ui/react-collection": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-collection/-/react-collection-1.1.3.tgz",
      "integrity": "sha512-mM2pxoQw5HJ49rkzwOs7Y6J4oYH22wS8BfK2/bBxROlI4xuR0c4jEenQP63LlTlDkO6Buj2Vt+QYAYcOgqtrXA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-primitive": "2.0.3",
        "@radix-ui/react-slot": "1.2.0"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast/node_modules/@radix-ui/react-dismissable-layer": {
      "version": "1.1.6",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-dismissable-layer/-/react-dismissable-layer-1.1.6.tgz",
      "integrity": "sha512-7gpgMT2gyKym9Jz2ZhlRXSg2y6cNQIK8d/cqBZ0RBCaps8pFryCWXiUKI+uHGFrhMrbGUP7U6PWgiXzIxoyF3Q==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.2",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-primitive": "2.0.3",
        "@radix-ui/react-use-callback-ref": "1.1.1",
        "@radix-ui/react-use-escape-keydown": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast/node_modules/@radix-ui/react-portal": {
      "version": "1.1.5",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-portal/-/react-portal-1.1.5.tgz",
      "integrity": "sha512-ps/67ZqsFm+Mb6lSPJpfhRLrVL2i2fntgCmGMqqth4eaGUf+knAuuRtWVJrNjUhExgmdRqftSgzpf0DF0n6yXA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.0.3",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast/node_modules/@radix-ui/react-presence": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-presence/-/react-presence-1.1.3.tgz",
      "integrity": "sha512-IrVLIhskYhH3nLvtcBLQFZr61tBG7wx7O3kEmdzcYwRGAEBmBicGGL7ATzNgruYJ3xBTbuzEEq9OXJM3PAX3tA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast/node_modules/@radix-ui/react-primitive": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-primitive/-/react-primitive-2.0.3.tgz",
      "integrity": "sha512-Pf/t/GkndH7CQ8wE2hbkXA+WyZ83fhQQn5DDmwDiDo6AwN/fhaH8oqZ0jRjMrO2iaMhDi6P1HRx6AZwyMinY1g==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-slot": "1.2.0"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast/node_modules/@radix-ui/react-slot": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.0.tgz",
      "integrity": "sha512-ujc+V6r0HNDviYqIK3rW4ffgYiZ8g5DEHrGJVk4x7kTlLXRDILnKX9vAUYeIsLOoDpDJ0ujpqMkjH4w2ofuo6w==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toast/node_modules/@radix-ui/react-visually-hidden": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-visually-hidden/-/react-visually-hidden-1.1.3.tgz",
      "integrity": "sha512-oXSF3ZQRd5fvomd9hmUCb2EHSZbPp3ZSHAHJJU/DlF9XoFkJBBW8RHU/E8WEH+RbSfJd/QFA0sl8ClJXknBwHQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.0.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toggle": {
      "version": "1.1.10",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-toggle/-/react-toggle-1.1.10.tgz",
      "integrity": "sha512-lS1odchhFTeZv3xwHH31YPObmJn8gOg7Lq12inrr0+BH/l3Tsq32VfjqH1oh80ARM3mlkfMic15n0kg4sD1poQ==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toggle-group": {
      "version": "1.1.11",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-toggle-group/-/react-toggle-group-1.1.11.tgz",
      "integrity": "sha512-5umnS0T8JQzQT6HbPyO7Hh9dgd82NmS36DQr+X/YJ9ctFNCiiQd6IJAYYZ33LUwm8M+taCz5t2ui29fHZc4Y6Q==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-direction": "1.1.1",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-roving-focus": "1.1.11",
        "@radix-ui/react-toggle": "1.1.10",
        "@radix-ui/react-use-controllable-state": "1.2.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toggle-group/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-toggle-group/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-toggle/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-toggle/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-tooltip": {
      "version": "1.2.8",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-tooltip/-/react-tooltip-1.2.8.tgz",
      "integrity": "sha512-tY7sVt1yL9ozIxvmbtN5qtmH2krXcBCfjEiCgKGLqunJHvgvZG2Pcl2oQ3kbcZARb1BGEHdkLzcYGO8ynVlieg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/primitive": "1.1.3",
        "@radix-ui/react-compose-refs": "1.1.2",
        "@radix-ui/react-context": "1.1.2",
        "@radix-ui/react-dismissable-layer": "1.1.11",
        "@radix-ui/react-id": "1.1.1",
        "@radix-ui/react-popper": "1.2.8",
        "@radix-ui/react-portal": "1.1.9",
        "@radix-ui/react-presence": "1.1.5",
        "@radix-ui/react-primitive": "2.1.3",
        "@radix-ui/react-slot": "1.2.3",
        "@radix-ui/react-use-controllable-state": "1.2.2",
        "@radix-ui/react-visually-hidden": "1.2.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-tooltip/node_modules/@radix-ui/primitive": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/primitive/-/primitive-1.1.3.tgz",
      "integrity": "sha512-JTF99U/6XIjCBo0wqkU5sK10glYe27MRRsfwoiq5zzOEZLHU3A3KCMa5X/azekYRCJ0HlwI0crAXS/5dEHTzDg==",
      "license": "MIT"
    },
    "node_modules/@radix-ui/react-tooltip/node_modules/@radix-ui/react-slot": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-slot/-/react-slot-1.2.3.tgz",
      "integrity": "sha512-aeNmHnBxbi2St0au6VBVC7JXFlhLlOnvIIlePNniyUNAClzmtAUEY8/pBiK3iHjufOlwA+c20/8jngo7xcrg8A==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-compose-refs": "1.1.2"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-tooltip/node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.2.2.tgz",
      "integrity": "sha512-BjasUjixPFdS+NKkypcyyN5Pmg83Olst0+c6vGov0diwTEo6mgdqVR6hxcEgFuh4QrAs7Rc+9KuGJ9TVCj0Zzg==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-effect-event": "0.0.2",
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-callback-ref": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-callback-ref/-/react-use-callback-ref-1.1.1.tgz",
      "integrity": "sha512-FkBMwD+qbGQeMu1cOHnuGB6x4yzPjho8ap5WtbEJ26umhgqVXbhekKUQO+hZEL1vU92a3wHwdp0HAcqAUF5iDg==",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-controllable-state": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-controllable-state/-/react-use-controllable-state-1.1.1.tgz",
      "integrity": "sha512-YnEXIy8/ga01Y1PN0VfaNH//MhA91JlEGVBDxDzROqwrAtG5Yr2QGEPz8A/rJA3C7ZAHryOYGaUv8fLSW2H/mg==",
      "dependencies": {
        "@radix-ui/react-use-callback-ref": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-effect-event": {
      "version": "0.0.2",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-effect-event/-/react-use-effect-event-0.0.2.tgz",
      "integrity": "sha512-Qp8WbZOBe+blgpuUT+lw2xheLP8q0oatc9UpmiemEICxGvFLYmHm9QowVZGHtJlGbS6A6yJ3iViad/2cVjnOiA==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-escape-keydown": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-escape-keydown/-/react-use-escape-keydown-1.1.1.tgz",
      "integrity": "sha512-Il0+boE7w/XebUHyBjroE+DbByORGR9KKmITzbR7MyQ4akpORYP/ZmbhAr0DG7RmmBqoOnZdy2QlvajJ2QA59g==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-use-callback-ref": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-is-hydrated": {
      "version": "0.1.0",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-is-hydrated/-/react-use-is-hydrated-0.1.0.tgz",
      "integrity": "sha512-U+UORVEq+cTnRIaostJv9AGdV3G6Y+zbVd+12e18jQ5A3c0xL03IhnHuiU4UV69wolOQp5GfR58NW/EgdQhwOA==",
      "license": "MIT",
      "dependencies": {
        "use-sync-external-store": "^1.5.0"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-layout-effect": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-layout-effect/-/react-use-layout-effect-1.1.1.tgz",
      "integrity": "sha512-RbJRS4UWQFkzHTTwVymMTUv8EqYhOp8dOOviLj2ugtTiXRaRQS7GLGxZTLL1jWhMeoSCf5zmcZkqTl9IiYfXcQ==",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-previous": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-previous/-/react-use-previous-1.1.1.tgz",
      "integrity": "sha512-2dHfToCj/pzca2Ck724OZ5L0EVrr3eHRNsG/b3xQJLA2hZpVCS99bLAX+hm1IHXDEnzU6by5z/5MIY794/a8NQ==",
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-rect": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-rect/-/react-use-rect-1.1.1.tgz",
      "integrity": "sha512-QTYuDesS0VtuHNNvMh+CjlKJ4LJickCMUAqjlE3+j8w+RlRpwyX3apEQKGFzbZGdo7XNG1tXa+bQqIE7HIXT2w==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/rect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-use-size": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-use-size/-/react-use-size-1.1.1.tgz",
      "integrity": "sha512-ewrXRDTAqAXlkl6t/fkXWNAhFX9I+CkKlw6zjEwk86RSPKwZr3xpBRso655aqYafwtnbpHLj6toFzmd6xdVptQ==",
      "dependencies": {
        "@radix-ui/react-use-layout-effect": "1.1.1"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/react-visually-hidden": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/@radix-ui/react-visually-hidden/-/react-visually-hidden-1.2.3.tgz",
      "integrity": "sha512-pzJq12tEaaIhqjbzpCuv/OypJY/BPavOofm+dbab+MHLajy277+1lLm6JFcGgF5eskJ6mquGirhXY2GD/8u8Ug==",
      "license": "MIT",
      "dependencies": {
        "@radix-ui/react-primitive": "2.1.3"
      },
      "peerDependencies": {
        "@types/react": "*",
        "@types/react-dom": "*",
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        },
        "@types/react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/@radix-ui/rect": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/@radix-ui/rect/-/rect-1.1.1.tgz",
      "integrity": "sha512-HPwpGIzkl28mWyZqG52jiqDJ12waP11Pa1lGoiyUkIEuMLBP0oeK/C89esbXrxsky5we7dfd8U58nm0SgAWpVw==",
      "license": "MIT"
    },
    "node_modules/@replit/vite-plugin-cartographer": {
      "version": "0.4.4",
      "resolved": "https://registry.npmjs.org/@replit/vite-plugin-cartographer/-/vite-plugin-cartographer-0.4.4.tgz",
      "integrity": "sha512-Dn3i3gULFUlf+LvQ85S5k+ghmsrgNZwtmVTJyoUlpa04IB5tUMZrQFUWcYCzgpOW9aMKPX6ClSo173k/b9a2eg==",
      "dev": true,
      "dependencies": {
        "@babel/parser": "^7.26.9",
        "@babel/traverse": "^7.26.9",
        "@babel/types": "^7.26.9",
        "magic-string": "^0.30.12",
        "modern-screenshot": "^4.6.0"
      }
    },
    "node_modules/@replit/vite-plugin-dev-banner": {
      "version": "0.1.1",
      "resolved": "https://registry.npmjs.org/@replit/vite-plugin-dev-banner/-/vite-plugin-dev-banner-0.1.1.tgz",
      "integrity": "sha512-LnFraZhsZBbAwM/tm6SeWKa1/hboAZzXd2vtn8EdKrIXAYSeQbRWCr3WYnlFd6tnuq5tXkKQZ5m8WMpyOu3aCQ==",
      "dev": true
    },
    "node_modules/@replit/vite-plugin-runtime-error-modal": {
      "version": "0.0.4",
      "resolved": "https://registry.npmjs.org/@replit/vite-plugin-runtime-error-modal/-/vite-plugin-runtime-error-modal-0.0.4.tgz",
      "integrity": "sha512-Xqf8M7GOfU7qhq2QMiWUkOb47Vq5rxTz1ZX8yUUqRAYJg80jHa8vidXQ3eKsGNXSDs4Y2cQKTV0IqTekN2Yqgw==",
      "dev": true,
      "dependencies": {
        "@jridgewell/trace-mapping": "^0.3.25"
      }
    },
    "node_modules/@rolldown/pluginutils": {
      "version": "1.0.0-beta.43",
      "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.43.tgz",
      "integrity": "sha512-5Uxg7fQUCmfhax7FJke2+8B6cqgeUJUD9o2uXIKXhD+mG0mL6NObmVoi9wXEU1tY89mZKgAYA6fTbftx3q2ZPQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.52.5.tgz",
      "integrity": "sha512-8c1vW4ocv3UOMp9K+gToY5zL2XiiVw3k7f1ksf4yO1FlDFQ1C2u72iACFnSOceJFsWskc2WZNqeRhFRPzv+wtQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.52.5.tgz",
      "integrity": "sha512-mQGfsIEFcu21mvqkEKKu2dYmtuSZOBMmAl5CFlPGLY94Vlcm+zWApK7F/eocsNzp8tKmbeBP8yXyAbx0XHsFNA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.52.5.tgz",
      "integrity": "sha512-takF3CR71mCAGA+v794QUZ0b6ZSrgJkArC+gUiG6LB6TQty9T0Mqh3m2ImRBOxS2IeYBo4lKWIieSvnEk2OQWA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.52.5.tgz",
      "integrity": "sha512-W901Pla8Ya95WpxDn//VF9K9u2JbocwV/v75TE0YIHNTbhqUTv9w4VuQ9MaWlNOkkEfFwkdNhXgcLqPSmHy0fA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.52.5.tgz",
      "integrity": "sha512-QofO7i7JycsYOWxe0GFqhLmF6l1TqBswJMvICnRUjqCx8b47MTo46W8AoeQwiokAx3zVryVnxtBMcGcnX12LvA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.52.5.tgz",
      "integrity": "sha512-jr21b/99ew8ujZubPo9skbrItHEIE50WdV86cdSoRkKtmWa+DDr6fu2c/xyRT0F/WazZpam6kk7IHBerSL7LDQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.52.5.tgz",
      "integrity": "sha512-PsNAbcyv9CcecAUagQefwX8fQn9LQ4nZkpDboBOttmyffnInRy8R8dSg6hxxl2Re5QhHBf6FYIDhIj5v982ATQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.52.5.tgz",
      "integrity": "sha512-Fw4tysRutyQc/wwkmcyoqFtJhh0u31K+Q6jYjeicsGJJ7bbEq8LwPWV/w0cnzOqR2m694/Af6hpFayLJZkG2VQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.52.5.tgz",
      "integrity": "sha512-a+3wVnAYdQClOTlyapKmyI6BLPAFYs0JM8HRpgYZQO02rMR09ZcV9LbQB+NL6sljzG38869YqThrRnfPMCDtZg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.52.5.tgz",
      "integrity": "sha512-AvttBOMwO9Pcuuf7m9PkC1PUIKsfaAJ4AYhy944qeTJgQOqJYJ9oVl2nYgY7Rk0mkbsuOpCAYSs6wLYB2Xiw0Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loong64-gnu": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loong64-gnu/-/rollup-linux-loong64-gnu-4.52.5.tgz",
      "integrity": "sha512-DkDk8pmXQV2wVrF6oq5tONK6UHLz/XcEVow4JTTerdeV1uqPeHxwcg7aFsfnSm9L+OO8WJsWotKM2JJPMWrQtA==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.52.5.tgz",
      "integrity": "sha512-W/b9ZN/U9+hPQVvlGwjzi+Wy4xdoH2I8EjaCkMvzpI7wJUs8sWJ03Rq96jRnHkSrcHTpQe8h5Tg3ZzUPGauvAw==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.52.5.tgz",
      "integrity": "sha512-sjQLr9BW7R/ZiXnQiWPkErNfLMkkWIoCz7YMn27HldKsADEKa5WYdobaa1hmN6slu9oWQbB6/jFpJ+P2IkVrmw==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.52.5.tgz",
      "integrity": "sha512-hq3jU/kGyjXWTvAh2awn8oHroCbrPm8JqM7RUpKjalIRWWXE01CQOf/tUNWNHjmbMHg/hmNCwc/Pz3k1T/j/Lg==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.52.5.tgz",
      "integrity": "sha512-gn8kHOrku8D4NGHMK1Y7NA7INQTRdVOntt1OCYypZPRt6skGbddska44K8iocdpxHTMMNui5oH4elPH4QOLrFQ==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.52.5.tgz",
      "integrity": "sha512-hXGLYpdhiNElzN770+H2nlx+jRog8TyynpTVzdlc6bndktjKWyZyiCsuDAlpd+j+W+WNqfcyAWz9HxxIGfZm1Q==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.52.5.tgz",
      "integrity": "sha512-arCGIcuNKjBoKAXD+y7XomR9gY6Mw7HnFBv5Rw7wQRvwYLR7gBAgV7Mb2QTyjXfTveBNFAtPt46/36vV9STLNg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.52.5.tgz",
      "integrity": "sha512-QoFqB6+/9Rly/RiPjaomPLmR/13cgkIGfA40LHly9zcH1S0bN2HVFYk3a1eAyHQyjs3ZJYlXvIGtcCs5tko9Cw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.52.5.tgz",
      "integrity": "sha512-w0cDWVR6MlTstla1cIfOGyl8+qb93FlAVutcor14Gf5Md5ap5ySfQ7R9S/NjNaMLSFdUnKGEasmVnu3lCMqB7w==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.52.5.tgz",
      "integrity": "sha512-Aufdpzp7DpOTULJCuvzqcItSGDH73pF3ko/f+ckJhxQyHtp67rHw3HMNxoIdDMUITJESNE6a8uh4Lo4SLouOUg==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-gnu": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-gnu/-/rollup-win32-x64-gnu-4.52.5.tgz",
      "integrity": "sha512-UGBUGPFp1vkj6p8wCRraqNhqwX/4kNQPS57BCFc8wYh0g94iVIW33wJtQAx3G7vrjjNtRaxiMUylM0ktp/TRSQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.52.5.tgz",
      "integrity": "sha512-TAcgQh2sSkykPRWLrdyy2AiceMckNf5loITqXxFI5VuQjS5tSuw3WlwdN8qv8vzjLAUTvYaH/mVjSFpbkFbpTg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@tailwindcss/node": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/node/-/node-4.1.16.tgz",
      "integrity": "sha512-BX5iaSsloNuvKNHRN3k2RcCuTEgASTo77mofW0vmeHkfrDWaoFAFvNHpEgtu0eqyypcyiBkDWzSMxJhp3AUVcw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/remapping": "^2.3.4",
        "enhanced-resolve": "^5.18.3",
        "jiti": "^2.6.1",
        "lightningcss": "1.30.2",
        "magic-string": "^0.30.19",
        "source-map-js": "^1.2.1",
        "tailwindcss": "4.1.16"
      }
    },
    "node_modules/@tailwindcss/oxide": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide/-/oxide-4.1.16.tgz",
      "integrity": "sha512-2OSv52FRuhdlgyOQqgtQHuCgXnS8nFSYRp2tJ+4WZXKgTxqPy7SMSls8c3mPT5pkZ17SBToGM5LHEJBO7miEdg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 10"
      },
      "optionalDependencies": {
        "@tailwindcss/oxide-android-arm64": "4.1.16",
        "@tailwindcss/oxide-darwin-arm64": "4.1.16",
        "@tailwindcss/oxide-darwin-x64": "4.1.16",
        "@tailwindcss/oxide-freebsd-x64": "4.1.16",
        "@tailwindcss/oxide-linux-arm-gnueabihf": "4.1.16",
        "@tailwindcss/oxide-linux-arm64-gnu": "4.1.16",
        "@tailwindcss/oxide-linux-arm64-musl": "4.1.16",
        "@tailwindcss/oxide-linux-x64-gnu": "4.1.16",
        "@tailwindcss/oxide-linux-x64-musl": "4.1.16",
        "@tailwindcss/oxide-wasm32-wasi": "4.1.16",
        "@tailwindcss/oxide-win32-arm64-msvc": "4.1.16",
        "@tailwindcss/oxide-win32-x64-msvc": "4.1.16"
      }
    },
    "node_modules/@tailwindcss/oxide-android-arm64": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-android-arm64/-/oxide-android-arm64-4.1.16.tgz",
      "integrity": "sha512-8+ctzkjHgwDJ5caq9IqRSgsP70xhdhJvm+oueS/yhD5ixLhqTw9fSL1OurzMUhBwE5zK26FXLCz2f/RtkISqHA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-darwin-arm64": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-darwin-arm64/-/oxide-darwin-arm64-4.1.16.tgz",
      "integrity": "sha512-C3oZy5042v2FOALBZtY0JTDnGNdS6w7DxL/odvSny17ORUnaRKhyTse8xYi3yKGyfnTUOdavRCdmc8QqJYwFKA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-darwin-x64": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-darwin-x64/-/oxide-darwin-x64-4.1.16.tgz",
      "integrity": "sha512-vjrl/1Ub9+JwU6BP0emgipGjowzYZMjbWCDqwA2Z4vCa+HBSpP4v6U2ddejcHsolsYxwL5r4bPNoamlV0xDdLg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-freebsd-x64": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-freebsd-x64/-/oxide-freebsd-x64-4.1.16.tgz",
      "integrity": "sha512-TSMpPYpQLm+aR1wW5rKuUuEruc/oOX3C7H0BTnPDn7W/eMw8W+MRMpiypKMkXZfwH8wqPIRKppuZoedTtNj2tg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-arm-gnueabihf": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-arm-gnueabihf/-/oxide-linux-arm-gnueabihf-4.1.16.tgz",
      "integrity": "sha512-p0GGfRg/w0sdsFKBjMYvvKIiKy/LNWLWgV/plR4lUgrsxFAoQBFrXkZ4C0w8IOXfslB9vHK/JGASWD2IefIpvw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-arm64-gnu": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-arm64-gnu/-/oxide-linux-arm64-gnu-4.1.16.tgz",
      "integrity": "sha512-DoixyMmTNO19rwRPdqviTrG1rYzpxgyYJl8RgQvdAQUzxC1ToLRqtNJpU/ATURSKgIg6uerPw2feW0aS8SNr/w==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-arm64-musl": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-arm64-musl/-/oxide-linux-arm64-musl-4.1.16.tgz",
      "integrity": "sha512-H81UXMa9hJhWhaAUca6bU2wm5RRFpuHImrwXBUvPbYb+3jo32I9VIwpOX6hms0fPmA6f2pGVlybO6qU8pF4fzQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-x64-gnu": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-x64-gnu/-/oxide-linux-x64-gnu-4.1.16.tgz",
      "integrity": "sha512-ZGHQxDtFC2/ruo7t99Qo2TTIvOERULPl5l0K1g0oK6b5PGqjYMga+FcY1wIUnrUxY56h28FxybtDEla+ICOyew==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-linux-x64-musl": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-linux-x64-musl/-/oxide-linux-x64-musl-4.1.16.tgz",
      "integrity": "sha512-Oi1tAaa0rcKf1Og9MzKeINZzMLPbhxvm7rno5/zuP1WYmpiG0bEHq4AcRUiG2165/WUzvxkW4XDYCscZWbTLZw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-wasm32-wasi": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-wasm32-wasi/-/oxide-wasm32-wasi-4.1.16.tgz",
      "integrity": "sha512-B01u/b8LteGRwucIBmCQ07FVXLzImWESAIMcUU6nvFt/tYsQ6IHz8DmZ5KtvmwxD+iTYBtM1xwoGXswnlu9v0Q==",
      "bundleDependencies": [
        "@napi-rs/wasm-runtime",
        "@emnapi/core",
        "@emnapi/runtime",
        "@tybys/wasm-util",
        "@emnapi/wasi-threads",
        "tslib"
      ],
      "cpu": [
        "wasm32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "dependencies": {
        "@emnapi/core": "^1.5.0",
        "@emnapi/runtime": "^1.5.0",
        "@emnapi/wasi-threads": "^1.1.0",
        "@napi-rs/wasm-runtime": "^1.0.7",
        "@tybys/wasm-util": "^0.10.1",
        "tslib": "^2.4.0"
      },
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/@tailwindcss/oxide-win32-arm64-msvc": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-win32-arm64-msvc/-/oxide-win32-arm64-msvc-4.1.16.tgz",
      "integrity": "sha512-zX+Q8sSkGj6HKRTMJXuPvOcP8XfYON24zJBRPlszcH1Np7xuHXhWn8qfFjIujVzvH3BHU+16jBXwgpl20i+v9A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/oxide-win32-x64-msvc": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/oxide-win32-x64-msvc/-/oxide-win32-x64-msvc-4.1.16.tgz",
      "integrity": "sha512-m5dDFJUEejbFqP+UXVstd4W/wnxA4F61q8SoL+mqTypId2T2ZpuxosNSgowiCnLp2+Z+rivdU0AqpfgiD7yCBg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 10"
      }
    },
    "node_modules/@tailwindcss/vite": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/@tailwindcss/vite/-/vite-4.1.16.tgz",
      "integrity": "sha512-bbguNBcDxsRmi9nnlWJxhfDWamY3lmcyACHcdO1crxfzuLpOhHLLtEIN/nCbbAtj5rchUgQD17QVAKi1f7IsKg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@tailwindcss/node": "4.1.16",
        "@tailwindcss/oxide": "4.1.16",
        "tailwindcss": "4.1.16"
      },
      "peerDependencies": {
        "vite": "^5.2.0 || ^6 || ^7"
      }
    },
    "node_modules/@tanstack/query-core": {
      "version": "5.60.5",
      "resolved": "https://registry.npmjs.org/@tanstack/query-core/-/query-core-5.60.5.tgz",
      "integrity": "sha512-jiS1aC3XI3BJp83ZiTuDLerTmn9P3U95r6p+6/SNauLJaYxfIC4dMuWygwnBHIZxjn2zJqEpj3nysmPieoxfPQ==",
      "license": "MIT",
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/tannerlinsley"
      }
    },
    "node_modules/@tanstack/react-query": {
      "version": "5.60.5",
      "resolved": "https://registry.npmjs.org/@tanstack/react-query/-/react-query-5.60.5.tgz",
      "integrity": "sha512-M77bOsPwj1wYE56gk7iJvxGAr4IC12NWdIDhT+Eo8ldkWRHMvIR8I/rufIvT1OXoV/bl7EECwuRuMlxxWtvW2Q==",
      "license": "MIT",
      "dependencies": {
        "@tanstack/query-core": "5.60.5"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/tannerlinsley"
      },
      "peerDependencies": {
        "react": "^18 || ^19"
      }
    },
    "node_modules/@types/babel__core": {
      "version": "7.20.5",
      "resolved": "https://registry.npmjs.org/@types/babel__core/-/babel__core-7.20.5.tgz",
      "integrity": "sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.20.7",
        "@babel/types": "^7.20.7",
        "@types/babel__generator": "*",
        "@types/babel__template": "*",
        "@types/babel__traverse": "*"
      }
    },
    "node_modules/@types/babel__generator": {
      "version": "7.6.8",
      "resolved": "https://registry.npmjs.org/@types/babel__generator/-/babel__generator-7.6.8.tgz",
      "integrity": "sha512-ASsj+tpEDsEiFr1arWrlN6V3mdfjRMZt6LtK/Vp/kreFLnr5QH5+DhvD5nINYZXzwJvXeGq+05iUXcAzVrqWtw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__template": {
      "version": "7.4.4",
      "resolved": "https://registry.npmjs.org/@types/babel__template/-/babel__template-7.4.4.tgz",
      "integrity": "sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.1.0",
        "@babel/types": "^7.0.0"
      }
    },
    "node_modules/@types/babel__traverse": {
      "version": "7.20.6",
      "resolved": "https://registry.npmjs.org/@types/babel__traverse/-/babel__traverse-7.20.6.tgz",
      "integrity": "sha512-r1bzfrm0tomOI8g1SzvCaQHo6Lcv6zu0EA+W2kHrt8dyrHQxGzBBL4kdkzIS+jBMV+EYcMAEAqXqYaLJq5rOZg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.20.7"
      }
    },
    "node_modules/@types/body-parser": {
      "version": "1.19.5",
      "resolved": "https://registry.npmjs.org/@types/body-parser/-/body-parser-1.19.5.tgz",
      "integrity": "sha512-fB3Zu92ucau0iQ0JMCFQE7b/dv8Ot07NI3KaZIkIUNXq82k4eBAqUaneXfleGY9JWskeS9y+u0nXMyspcuQrCg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/connect": "*",
        "@types/node": "*"
      }
    },
    "node_modules/@types/caseless": {
      "version": "0.12.5",
      "resolved": "https://registry.npmjs.org/@types/caseless/-/caseless-0.12.5.tgz",
      "integrity": "sha512-hWtVTC2q7hc7xZ/RLbxapMvDMgUnDvKvMOpKal4DrMyfGBUfB1oKaZlIRr6mJL+If3bAP6sV/QneGzF6tJjZDg==",
      "license": "MIT"
    },
    "node_modules/@types/connect": {
      "version": "3.4.38",
      "resolved": "https://registry.npmjs.org/@types/connect/-/connect-3.4.38.tgz",
      "integrity": "sha512-K6uROf1LD88uDQqJCktA4yzL1YYAK6NgfsI0v/mTgyPKWsX1CnJ0XPSDhViejru1GcRkLWb8RlzFYJRqGUbaug==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/node": "*"
      }
    },
    "node_modules/@types/connect-pg-simple": {
      "version": "7.0.3",
      "resolved": "https://registry.npmjs.org/@types/connect-pg-simple/-/connect-pg-simple-7.0.3.tgz",
      "integrity": "sha512-NGCy9WBlW2bw+J/QlLnFZ9WjoGs6tMo3LAut6mY4kK+XHzue//lpNVpAvYRpIwM969vBRAM2Re0izUvV6kt+NA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/express": "*",
        "@types/express-session": "*",
        "@types/pg": "*"
      }
    },
    "node_modules/@types/d3-array": {
      "version": "3.2.1",
      "resolved": "https://registry.npmjs.org/@types/d3-array/-/d3-array-3.2.1.tgz",
      "integrity": "sha512-Y2Jn2idRrLzUfAKV2LyRImR+y4oa2AntrgID95SHJxuMUrkNXmanDSed71sRNZysveJVt1hLLemQZIady0FpEg==",
      "license": "MIT"
    },
    "node_modules/@types/d3-color": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/@types/d3-color/-/d3-color-3.1.3.tgz",
      "integrity": "sha512-iO90scth9WAbmgv7ogoq57O9YpKmFBbmoEoCHDB2xMBY0+/KVrqAaCDyCE16dUspeOvIxFFRI+0sEtqDqy2b4A==",
      "license": "MIT"
    },
    "node_modules/@types/d3-ease": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/@types/d3-ease/-/d3-ease-3.0.2.tgz",
      "integrity": "sha512-NcV1JjO5oDzoK26oMzbILE6HW7uVXOHLQvHshBUW4UMdZGfiY6v5BeQwh9a9tCzv+CeefZQHJt5SRgK154RtiA==",
      "license": "MIT"
    },
    "node_modules/@types/d3-interpolate": {
      "version": "3.0.4",
      "resolved": "https://registry.npmjs.org/@types/d3-interpolate/-/d3-interpolate-3.0.4.tgz",
      "integrity": "sha512-mgLPETlrpVV1YRJIglr4Ez47g7Yxjl1lj7YKsiMCb27VJH9W8NVM6Bb9d8kkpG/uAQS5AmbA48q2IAolKKo1MA==",
      "license": "MIT",
      "dependencies": {
        "@types/d3-color": "*"
      }
    },
    "node_modules/@types/d3-path": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/@types/d3-path/-/d3-path-3.1.0.tgz",
      "integrity": "sha512-P2dlU/q51fkOc/Gfl3Ul9kicV7l+ra934qBFXCFhrZMOL6du1TM0pm1ThYvENukyOn5h9v+yMJ9Fn5JK4QozrQ==",
      "license": "MIT"
    },
    "node_modules/@types/d3-scale": {
      "version": "4.0.8",
      "resolved": "https://registry.npmjs.org/@types/d3-scale/-/d3-scale-4.0.8.tgz",
      "integrity": "sha512-gkK1VVTr5iNiYJ7vWDI+yUFFlszhNMtVeneJ6lUTKPjprsvLLI9/tgEGiXJOnlINJA8FyA88gfnQsHbybVZrYQ==",
      "license": "MIT",
      "dependencies": {
        "@types/d3-time": "*"
      }
    },
    "node_modules/@types/d3-shape": {
      "version": "3.1.6",
      "resolved": "https://registry.npmjs.org/@types/d3-shape/-/d3-shape-3.1.6.tgz",
      "integrity": "sha512-5KKk5aKGu2I+O6SONMYSNflgiP0WfZIQvVUMan50wHsLG1G94JlxEVnCpQARfTtzytuY0p/9PXXZb3I7giofIA==",
      "license": "MIT",
      "dependencies": {
        "@types/d3-path": "*"
      }
    },
    "node_modules/@types/d3-time": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/@types/d3-time/-/d3-time-3.0.3.tgz",
      "integrity": "sha512-2p6olUZ4w3s+07q3Tm2dbiMZy5pCDfYwtLXXHUnVzXgQlZ/OyPtUz6OL382BkOuGlLXqfT+wqv8Fw2v8/0geBw==",
      "license": "MIT"
    },
    "node_modules/@types/d3-timer": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/@types/d3-timer/-/d3-timer-3.0.2.tgz",
      "integrity": "sha512-Ps3T8E8dZDam6fUyNiMkekK3XUsaUEik+idO9/YjPtfj2qruF8tFBXS7XhtE4iIXBLxhmLjP3SXpLhVf21I9Lw==",
      "license": "MIT"
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/express": {
      "version": "4.17.21",
      "resolved": "https://registry.npmjs.org/@types/express/-/express-4.17.21.tgz",
      "integrity": "sha512-ejlPM315qwLpaQlQDTjPdsUFSc6ZsP4AN6AlWnogPjQ7CVi7PYF3YVz+CY3jE2pwYf7E/7HlDAN0rV2GxTG0HQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/body-parser": "*",
        "@types/express-serve-static-core": "^4.17.33",
        "@types/qs": "*",
        "@types/serve-static": "*"
      }
    },
    "node_modules/@types/express-serve-static-core": {
      "version": "4.19.6",
      "resolved": "https://registry.npmjs.org/@types/express-serve-static-core/-/express-serve-static-core-4.19.6.tgz",
      "integrity": "sha512-N4LZ2xG7DatVqhCZzOGb1Yi5lMbXSZcmdLDe9EzSndPV2HpWYWzRbaerl2n27irrm94EPpprqa8KpskPT085+A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/node": "*",
        "@types/qs": "*",
        "@types/range-parser": "*",
        "@types/send": "*"
      }
    },
    "node_modules/@types/express-session": {
      "version": "1.18.0",
      "resolved": "https://registry.npmjs.org/@types/express-session/-/express-session-1.18.0.tgz",
      "integrity": "sha512-27JdDRgor6PoYlURY+Y5kCakqp5ulC0kmf7y+QwaY+hv9jEFuQOThgkjyA53RP3jmKuBsH5GR6qEfFmvb8mwOA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/express": "*"
      }
    },
    "node_modules/@types/http-errors": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/@types/http-errors/-/http-errors-2.0.4.tgz",
      "integrity": "sha512-D0CFMMtydbJAegzOyHjtiKPLlvnm3iTZyZRSZoLq2mRhDdmLfIWOCYPfQJ4cu2erKghU++QvjcUjp/5h7hESpA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/mime": {
      "version": "1.3.5",
      "resolved": "https://registry.npmjs.org/@types/mime/-/mime-1.3.5.tgz",
      "integrity": "sha512-/pyBZWSLD2n0dcHE3hq8s8ZvcETHtEuF+3E7XVt0Ig2nvsVQXdghHVcEkIWjy9A0wKfTn97a/PSDYohKIlnP/w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/node": {
      "version": "20.19.24",
      "resolved": "https://registry.npmjs.org/@types/node/-/node-20.19.24.tgz",
      "integrity": "sha512-FE5u0ezmi6y9OZEzlJfg37mqqf6ZDSF2V/NLjUyGrR9uTZ7Sb9F7bLNZ03S4XVUNRWGA7Ck4c1kK+YnuWjl+DA==",
      "license": "MIT",
      "dependencies": {
        "undici-types": "~6.21.0"
      }
    },
    "node_modules/@types/node-telegram-bot-api": {
      "version": "0.64.13",
      "resolved": "https://registry.npmjs.org/@types/node-telegram-bot-api/-/node-telegram-bot-api-0.64.13.tgz",
      "integrity": "sha512-/d3sYpZq4sDwKWAm9XsIsb8MclclJ1yPXZC7uAzZRrJIFY8yg/63oNrLf9CBTlaS/XGR1N66BwibfJQGiWVsqg==",
      "license": "MIT",
      "dependencies": {
        "@types/node": "*",
        "@types/request": "*"
      }
    },
    "node_modules/@types/passport": {
      "version": "1.0.17",
      "resolved": "https://registry.npmjs.org/@types/passport/-/passport-1.0.17.tgz",
      "integrity": "sha512-aciLyx+wDwT2t2/kJGJR2AEeBz0nJU4WuRX04Wu9Dqc5lSUtwu0WERPHYsLhF9PtseiAMPBGNUOtFjxZ56prsg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/express": "*"
      }
    },
    "node_modules/@types/passport-local": {
      "version": "1.0.38",
      "resolved": "https://registry.npmjs.org/@types/passport-local/-/passport-local-1.0.38.tgz",
      "integrity": "sha512-nsrW4A963lYE7lNTv9cr5WmiUD1ibYJvWrpE13oxApFsRt77b0RdtZvKbCdNIY4v/QZ6TRQWaDDEwV1kCTmcXg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/express": "*",
        "@types/passport": "*",
        "@types/passport-strategy": "*"
      }
    },
    "node_modules/@types/passport-strategy": {
      "version": "0.2.38",
      "resolved": "https://registry.npmjs.org/@types/passport-strategy/-/passport-strategy-0.2.38.tgz",
      "integrity": "sha512-GC6eMqqojOooq993Tmnmp7AUTbbQSgilyvpCYQjT+H6JfG/g6RGc7nXEniZlp0zyKJ0WUdOiZWLBZft9Yug1uA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/express": "*",
        "@types/passport": "*"
      }
    },
    "node_modules/@types/pg": {
      "version": "8.11.6",
      "resolved": "https://registry.npmjs.org/@types/pg/-/pg-8.11.6.tgz",
      "integrity": "sha512-/2WmmBXHLsfRqzfHW7BNZ8SbYzE8OSk7i3WjFYvfgRHj7S1xj+16Je5fUKv3lVdVzk/zn9TXOqf+avFCFIE0yQ==",
      "devOptional": true,
      "license": "MIT",
      "dependencies": {
        "@types/node": "*",
        "pg-protocol": "*",
        "pg-types": "^4.0.1"
      }
    },
    "node_modules/@types/qs": {
      "version": "6.9.16",
      "resolved": "https://registry.npmjs.org/@types/qs/-/qs-6.9.16.tgz",
      "integrity": "sha512-7i+zxXdPD0T4cKDuxCUXJ4wHcsJLwENa6Z3dCu8cfCK743OGy5Nu1RmAGqDPsoTDINVEcdXKRvR/zre+P2Ku1A==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/range-parser": {
      "version": "1.2.7",
      "resolved": "https://registry.npmjs.org/@types/range-parser/-/range-parser-1.2.7.tgz",
      "integrity": "sha512-hKormJbkJqzQGhziax5PItDUTMAM9uE2XXQmM37dyd4hVM+5aVl7oVxMVUiVQn2oCQFN/LKCZdvSM0pFRqbSmQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@types/react": {
      "version": "19.2.2",
      "resolved": "https://registry.npmjs.org/@types/react/-/react-19.2.2.tgz",
      "integrity": "sha512-6mDvHUFSjyT2B2yeNx2nUgMxh9LtOWvkhIU3uePn2I2oyNymUAX1NIsdgviM4CH+JSrp2D2hsMvJOkxY+0wNRA==",
      "devOptional": true,
      "license": "MIT",
      "dependencies": {
        "csstype": "^3.0.2"
      }
    },
    "node_modules/@types/react-dom": {
      "version": "19.2.2",
      "resolved": "https://registry.npmjs.org/@types/react-dom/-/react-dom-19.2.2.tgz",
      "integrity": "sha512-9KQPoO6mZCi7jcIStSnlOWn2nEF3mNmyr3rIAsGnAbQKYbRLyqmeSc39EVgtxXVia+LMT8j3knZLAZAh+xLmrw==",
      "devOptional": true,
      "license": "MIT",
      "peerDependencies": {
        "@types/react": "^19.2.0"
      }
    },
    "node_modules/@types/request": {
      "version": "2.48.13",
      "resolved": "https://registry.npmjs.org/@types/request/-/request-2.48.13.tgz",
      "integrity": "sha512-FGJ6udDNUCjd19pp0Q3iTiDkwhYup7J8hpMW9c4k53NrccQFFWKRho6hvtPPEhnXWKvukfwAlB6DbDz4yhH5Gg==",
      "license": "MIT",
      "dependencies": {
        "@types/caseless": "*",
        "@types/node": "*",
        "@types/tough-cookie": "*",
        "form-data": "^2.5.5"
      }
    },
    "node_modules/@types/send": {
      "version": "0.17.4",
      "resolved": "https://registry.npmjs.org/@types/send/-/send-0.17.4.tgz",
      "integrity": "sha512-x2EM6TJOybec7c52BX0ZspPodMsQUd5L6PRwOunVyVUhXiBSKf3AezDL8Dgvgt5o0UfKNfuA0eMLr2wLT4AiBA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/mime": "^1",
        "@types/node": "*"
      }
    },
    "node_modules/@types/serve-static": {
      "version": "1.15.7",
      "resolved": "https://registry.npmjs.org/@types/serve-static/-/serve-static-1.15.7.tgz",
      "integrity": "sha512-W8Ym+h8nhuRwaKPaDw34QUkwsGi6Rc4yYqvKFo5rm2FUEhCFbzVWrxXUxuKK8TASjWsysJY0nsmNCGhCOIsrOw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/http-errors": "*",
        "@types/node": "*",
        "@types/send": "*"
      }
    },
    "node_modules/@types/tough-cookie": {
      "version": "4.0.5",
      "resolved": "https://registry.npmjs.org/@types/tough-cookie/-/tough-cookie-4.0.5.tgz",
      "integrity": "sha512-/Ad8+nIOV7Rl++6f1BdKxFSMgmoqEoYbHRpPcx3JEfv8VRsQe9Z4mCXeJBzxs7mbHY/XOZZuXlRNfhpVPbs6ZA==",
      "license": "MIT"
    },
    "node_modules/@types/ws": {
      "version": "8.5.13",
      "resolved": "https://registry.npmjs.org/@types/ws/-/ws-8.5.13.tgz",
      "integrity": "sha512-osM/gWBTPKgHV8XkTunnegTRIsvF6owmf5w+JtAfOw472dptdm0dlGv4xCt6GwQRcC2XVOvvRE/0bAoQcL2QkA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/node": "*"
      }
    },
    "node_modules/@vitejs/plugin-react": {
      "version": "5.1.0",
      "resolved": "https://registry.npmjs.org/@vitejs/plugin-react/-/plugin-react-5.1.0.tgz",
      "integrity": "sha512-4LuWrg7EKWgQaMJfnN+wcmbAW+VSsCmqGohftWjuct47bv8uE4n/nPpq4XjJPsxgq00GGG5J8dvBczp8uxScew==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@babel/core": "^7.28.4",
        "@babel/plugin-transform-react-jsx-self": "^7.27.1",
        "@babel/plugin-transform-react-jsx-source": "^7.27.1",
        "@rolldown/pluginutils": "1.0.0-beta.43",
        "@types/babel__core": "^7.20.5",
        "react-refresh": "^0.18.0"
      },
      "engines": {
        "node": "^20.19.0 || >=22.12.0"
      },
      "peerDependencies": {
        "vite": "^4.2.0 || ^5.0.0 || ^6.0.0 || ^7.0.0"
      }
    },
    "node_modules/accepts": {
      "version": "1.3.8",
      "resolved": "https://registry.npmjs.org/accepts/-/accepts-1.3.8.tgz",
      "integrity": "sha512-PYAthTa2m2VKxuvSD3DPC/Gy+U+sOA1LAuT8mkmRuvw+NACSaeXEQ+NHcVF7rONl6qcaxV3Uuemwawk+7+SJLw==",
      "license": "MIT",
      "dependencies": {
        "mime-types": "~2.1.34",
        "negotiator": "0.6.3"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/ajv": {
      "version": "6.12.6",
      "resolved": "https://registry.npmjs.org/ajv/-/ajv-6.12.6.tgz",
      "integrity": "sha512-j3fVLgvTo527anyYyJOGTYJbG+vnnQYvE0m5mmkc1TK+nxAppkCLMIL0aZ4dblVCNoGShhm+kzE4ZUykBoMg4g==",
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "fast-deep-equal": "^3.1.1",
        "fast-json-stable-stringify": "^2.0.0",
        "json-schema-traverse": "^0.4.1",
        "uri-js": "^4.2.2"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/epoberezkin"
      }
    },
    "node_modules/aria-hidden": {
      "version": "1.2.4",
      "resolved": "https://registry.npmjs.org/aria-hidden/-/aria-hidden-1.2.4.tgz",
      "integrity": "sha512-y+CcFFwelSXpLZk/7fMB2mUbGtX9lKycf1MWJ7CaTIERyitVlyQx6C+sxcROU2BAJ24OiZyK+8wj2i8AlBoS3A==",
      "license": "MIT",
      "dependencies": {
        "tslib": "^2.0.0"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/array-buffer-byte-length": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/array-buffer-byte-length/-/array-buffer-byte-length-1.0.2.tgz",
      "integrity": "sha512-LHE+8BuR7RYGDKvnrmcuSq3tDcKv9OFEXQt/HpbZhY7V6h0zlUXutnAD82GiFx9rdieCMjkvtcsPqBwgUl1Iiw==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "is-array-buffer": "^3.0.5"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/array-flatten": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/array-flatten/-/array-flatten-1.1.1.tgz",
      "integrity": "sha512-PCVAQswWemu6UdxsDFFX/+gVeYqKAod3D3UVm91jHwynguOwAvYPhx8nNlM++NqRcK6CxxpUafjmhIdKiHibqg==",
      "license": "MIT"
    },
    "node_modules/array.prototype.findindex": {
      "version": "2.2.4",
      "resolved": "https://registry.npmjs.org/array.prototype.findindex/-/array.prototype.findindex-2.2.4.tgz",
      "integrity": "sha512-LLm4mhxa9v8j0A/RPnpQAP4svXToJFh+Hp1pNYl5ZD5qpB4zdx/D4YjpVcETkhFbUKWO3iGMVLvrOnnmkAJT6A==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.3",
        "define-properties": "^1.2.1",
        "es-abstract": "^1.23.6",
        "es-object-atoms": "^1.0.0",
        "es-shim-unscopables": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/arraybuffer.prototype.slice": {
      "version": "1.0.4",
      "resolved": "https://registry.npmjs.org/arraybuffer.prototype.slice/-/arraybuffer.prototype.slice-1.0.4.tgz",
      "integrity": "sha512-BNoCY6SXXPQ7gF2opIP4GBE+Xw7U+pHMYKuzjgCN3GwiaIR09UUeKfheyIry77QtrCBlC0KK0q5/TER/tYh3PQ==",
      "license": "MIT",
      "dependencies": {
        "array-buffer-byte-length": "^1.0.1",
        "call-bind": "^1.0.8",
        "define-properties": "^1.2.1",
        "es-abstract": "^1.23.5",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.6",
        "is-array-buffer": "^3.0.4"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/asn1": {
      "version": "0.2.6",
      "resolved": "https://registry.npmjs.org/asn1/-/asn1-0.2.6.tgz",
      "integrity": "sha512-ix/FxPn0MDjeyJ7i/yoHGFt/EX6LyNbxSEhPPXODPL+KB0VPk86UYfL0lMdy+KCnv+fmvIzySwaK5COwqVbWTQ==",
      "license": "MIT",
      "dependencies": {
        "safer-buffer": "~2.1.0"
      }
    },
    "node_modules/assert-plus": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/assert-plus/-/assert-plus-1.0.0.tgz",
      "integrity": "sha512-NfJ4UzBCcQGLDlQq7nHxH+tv3kyZ0hHQqF5BO6J7tNJeP5do1llPr8dZ8zHonfhAu0PHAdMkSo+8o0wxg9lZWw==",
      "license": "MIT",
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/async-function": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/async-function/-/async-function-1.0.0.tgz",
      "integrity": "sha512-hsU18Ae8CDTR6Kgu9DYf0EbCr/a5iGL0rytQDobUcdpYOKokk8LEjVphnXkDkgpi0wYVsqrXuP0bZxJaTqdgoA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/asynckit": {
      "version": "0.4.0",
      "resolved": "https://registry.npmjs.org/asynckit/-/asynckit-0.4.0.tgz",
      "integrity": "sha512-Oei9OH4tRh0YqU3GxhX79dM/mwVgvbZJaSNaRk+bshkj0S5cfHcgYakreBjrHwatXKbz+IoIdYLxrKim2MjW0Q==",
      "license": "MIT"
    },
    "node_modules/autoprefixer": {
      "version": "10.4.21",
      "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.21.tgz",
      "integrity": "sha512-O+A6LWV5LDHSJD3LjHYoNi4VLsj/Whi7k6zG12xTYaU4cQ8oxQGckXNX8cRHK5yOZ/ppVHe0ZBXGzSV9jXdVbQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/autoprefixer"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "browserslist": "^4.24.4",
        "caniuse-lite": "^1.0.30001702",
        "fraction.js": "^4.3.7",
        "normalize-range": "^0.1.2",
        "picocolors": "^1.1.1",
        "postcss-value-parser": "^4.2.0"
      },
      "bin": {
        "autoprefixer": "bin/autoprefixer"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      },
      "peerDependencies": {
        "postcss": "^8.1.0"
      }
    },
    "node_modules/available-typed-arrays": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/available-typed-arrays/-/available-typed-arrays-1.0.7.tgz",
      "integrity": "sha512-wvUjBtSGN7+7SjNpq/9M2Tg350UZD3q62IFZLbRAR1bSMlCo1ZaeW+BJ+D090e4hIIZLBcTDWe4Mh4jvUDajzQ==",
      "license": "MIT",
      "dependencies": {
        "possible-typed-array-names": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/aws-sign2": {
      "version": "0.7.0",
      "resolved": "https://registry.npmjs.org/aws-sign2/-/aws-sign2-0.7.0.tgz",
      "integrity": "sha512-08kcGqnYf/YmjoRhfxyu+CLxBjUtHLXLXX/vUfx9l2LYzG3c1m61nrpyFUZI6zeS+Li/wWMMidD9KgrqtGq3mA==",
      "license": "Apache-2.0",
      "engines": {
        "node": "*"
      }
    },
    "node_modules/aws4": {
      "version": "1.13.2",
      "resolved": "https://registry.npmjs.org/aws4/-/aws4-1.13.2.tgz",
      "integrity": "sha512-lHe62zvbTB5eEABUVi/AwVh0ZKY9rMMDhmm+eeyuuUQbQ3+J+fONVQOZyj+DdrvD4BY33uYniyRJ4UJIaSKAfw==",
      "license": "MIT"
    },
    "node_modules/baseline-browser-mapping": {
      "version": "2.8.21",
      "resolved": "https://registry.npmjs.org/baseline-browser-mapping/-/baseline-browser-mapping-2.8.21.tgz",
      "integrity": "sha512-JU0h5APyQNsHOlAM7HnQnPToSDQoEBZqzu/YBlqDnEeymPnZDREeXJA3KBMQee+dKteAxZ2AtvQEvVYdZf241Q==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "baseline-browser-mapping": "dist/cli.js"
      }
    },
    "node_modules/bcrypt-pbkdf": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/bcrypt-pbkdf/-/bcrypt-pbkdf-1.0.2.tgz",
      "integrity": "sha512-qeFIXtP4MSoi6NLqO12WfqARWWuCKi2Rn/9hJLEmtB5yTNr9DqFWkJRCf2qShWzPeAMRnOgCrq0sg/KLv5ES9w==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "tweetnacl": "^0.14.3"
      }
    },
    "node_modules/bl": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/bl/-/bl-1.2.3.tgz",
      "integrity": "sha512-pvcNpa0UU69UT341rO6AYy4FVAIkUHuZXRIWbq+zHnsVcRzDDjIAhGuuYoi0d//cwIwtt4pkpKycWEfjdV+vww==",
      "license": "MIT",
      "dependencies": {
        "readable-stream": "^2.3.5",
        "safe-buffer": "^5.1.1"
      }
    },
    "node_modules/bluebird": {
      "version": "3.7.2",
      "resolved": "https://registry.npmjs.org/bluebird/-/bluebird-3.7.2.tgz",
      "integrity": "sha512-XpNj6GDQzdfW+r2Wnn7xiSAd7TM3jzkxGXBGTtWKuSXv1xUV+azxAm8jdWZN06QTQk+2N2XB9jRDkvbmQmcRtg==",
      "license": "MIT"
    },
    "node_modules/body-parser": {
      "version": "1.20.3",
      "resolved": "https://registry.npmjs.org/body-parser/-/body-parser-1.20.3.tgz",
      "integrity": "sha512-7rAxByjUMqQ3/bHJy7D6OGXvx/MMc4IqBn/X0fcM1QUcAItpZrBEYhWGem+tzXH90c+G01ypMcYJBO9Y30203g==",
      "license": "MIT",
      "dependencies": {
        "bytes": "3.1.2",
        "content-type": "~1.0.5",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "http-errors": "2.0.0",
        "iconv-lite": "0.4.24",
        "on-finished": "2.4.1",
        "qs": "6.13.0",
        "raw-body": "2.5.2",
        "type-is": "~1.6.18",
        "unpipe": "1.0.0"
      },
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/body-parser/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/body-parser/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/browserslist": {
      "version": "4.27.0",
      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.27.0.tgz",
      "integrity": "sha512-AXVQwdhot1eqLihwasPElhX2tAZiBjWdJ9i/Zcj2S6QYIjkx62OKSfnobkriB81C3l4w0rVy3Nt4jaTBltYEpw==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "baseline-browser-mapping": "^2.8.19",
        "caniuse-lite": "^1.0.30001751",
        "electron-to-chromium": "^1.5.238",
        "node-releases": "^2.0.26",
        "update-browserslist-db": "^1.1.4"
      },
      "bin": {
        "browserslist": "cli.js"
      },
      "engines": {
        "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
      }
    },
    "node_modules/buffer-from": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/buffer-from/-/buffer-from-1.1.2.tgz",
      "integrity": "sha512-E+XQCRwSbaaiChtv6k6Dwgc+bx+Bs6vuKJHHl5kox/BaKbhiXzqQOwK4cO22yElGp2OCmjwVhT3HmxgyPGnJfQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/bufferutil": {
      "version": "4.0.8",
      "resolved": "https://registry.npmjs.org/bufferutil/-/bufferutil-4.0.8.tgz",
      "integrity": "sha512-4T53u4PdgsXqKaIctwF8ifXlRTTmEPJ8iEPWFdGZvcf7sbwYo6FKFEX9eNNAnzFZ7EzJAQ3CJeOtCRA4rDp7Pw==",
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "dependencies": {
        "node-gyp-build": "^4.3.0"
      },
      "engines": {
        "node": ">=6.14.2"
      }
    },
    "node_modules/bytes": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/bytes/-/bytes-3.1.2.tgz",
      "integrity": "sha512-/Nf7TyzTx6S3yRJObOAV7956r8cr2+Oj8AC5dt8wSP3BQAoeX58NoHyCU8P8zGkNXStjTSi6fzO6F0pBdcYbEg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/call-bind": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/call-bind/-/call-bind-1.0.8.tgz",
      "integrity": "sha512-oKlSFMcMwpUg2ednkhQ454wfWiU/ul3CkJe/PEHcTKuiX6RpbehUiFMXu13HalGZxfUwCQzZG747YXBn1im9ww==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.0",
        "es-define-property": "^1.0.0",
        "get-intrinsic": "^1.2.4",
        "set-function-length": "^1.2.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/call-bind-apply-helpers": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz",
      "integrity": "sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/call-bound": {
      "version": "1.0.4",
      "resolved": "https://registry.npmjs.org/call-bound/-/call-bound-1.0.4.tgz",
      "integrity": "sha512-+ys997U96po4Kx/ABpBCqhA9EuxJaQWDQg7295H4hBphv3IZg0boBKuwYpt4YXp6MZ5AmZQnU/tyMTlRpaSejg==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "get-intrinsic": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/caniuse-lite": {
      "version": "1.0.30001753",
      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001753.tgz",
      "integrity": "sha512-Bj5H35MD/ebaOV4iDLqPEtiliTN29qkGtEHCwawWn4cYm+bPJM2NsaP30vtZcnERClMzp52J4+aw2UNbK4o+zw==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "CC-BY-4.0"
    },
    "node_modules/caseless": {
      "version": "0.12.0",
      "resolved": "https://registry.npmjs.org/caseless/-/caseless-0.12.0.tgz",
      "integrity": "sha512-4tYFyifaFfGacoiObjJegolkwSU4xQNGbVgUiNYVUxbQ2x2lUsFvY4hVgVzGiIe6WLOPqycWXA40l+PWsxthUw==",
      "license": "Apache-2.0"
    },
    "node_modules/class-variance-authority": {
      "version": "0.7.1",
      "resolved": "https://registry.npmjs.org/class-variance-authority/-/class-variance-authority-0.7.1.tgz",
      "integrity": "sha512-Ka+9Trutv7G8M6WT6SeiRWz792K5qEqIGEGzXKhAE6xOWAY6pPH8U+9IY3oCMv6kqTmLsv7Xh/2w2RigkePMsg==",
      "dependencies": {
        "clsx": "^2.1.1"
      },
      "funding": {
        "url": "https://polar.sh/cva"
      }
    },
    "node_modules/clsx": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/clsx/-/clsx-2.1.1.tgz",
      "integrity": "sha512-eYm0QWBtUrBWZWG0d386OGAw16Z995PiOVo2B7bjWSbHedGl5e0ZWaq65kOGgUSNesEIDkB9ISbTg/JK9dhCZA==",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/cmdk": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/cmdk/-/cmdk-1.1.1.tgz",
      "integrity": "sha512-Vsv7kFaXm+ptHDMZ7izaRsP70GgrW9NBNGswt9OZaVBLlE0SNpDq8eu/VGXyF9r7M0azK3Wy7OlYXsuyYLFzHg==",
      "dependencies": {
        "@radix-ui/react-compose-refs": "^1.1.1",
        "@radix-ui/react-dialog": "^1.1.6",
        "@radix-ui/react-id": "^1.1.0",
        "@radix-ui/react-primitive": "^2.0.2"
      },
      "peerDependencies": {
        "react": "^18 || ^19 || ^19.0.0-rc",
        "react-dom": "^18 || ^19 || ^19.0.0-rc"
      }
    },
    "node_modules/combined-stream": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/combined-stream/-/combined-stream-1.0.8.tgz",
      "integrity": "sha512-FQN4MRfuJeHf7cBbBMJFXhKSDq+2kAArBlmRBvcvFE5BB1HZKXtSFASDhdlz9zOYwxh8lDdnvmMOe/+5cdoEdg==",
      "license": "MIT",
      "dependencies": {
        "delayed-stream": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/connect-pg-simple": {
      "version": "10.0.0",
      "resolved": "https://registry.npmjs.org/connect-pg-simple/-/connect-pg-simple-10.0.0.tgz",
      "integrity": "sha512-pBGVazlqiMrackzCr0eKhn4LO5trJXsOX0nQoey9wCOayh80MYtThCbq8eoLsjpiWgiok/h+1/uti9/2/Una8A==",
      "license": "MIT",
      "dependencies": {
        "pg": "^8.12.0"
      },
      "engines": {
        "node": "^18.18.0 || ^20.9.0 || >=22.0.0"
      }
    },
    "node_modules/content-disposition": {
      "version": "0.5.4",
      "resolved": "https://registry.npmjs.org/content-disposition/-/content-disposition-0.5.4.tgz",
      "integrity": "sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "5.2.1"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/content-type": {
      "version": "1.0.5",
      "resolved": "https://registry.npmjs.org/content-type/-/content-type-1.0.5.tgz",
      "integrity": "sha512-nTjqfcBFEipKdXCv4YDQWCfmcLZKm81ldF0pAopTvyrFGVbcR6P/VAAd5G7N+0tTr8QqiU0tFadD6FK4NtJwOA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/convert-source-map": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/convert-source-map/-/convert-source-map-2.0.0.tgz",
      "integrity": "sha512-Kvp459HrV2FEJ1CAsi1Ku+MY3kasH19TFykTz2xWmMeq6bk2NU3XXvfJ+Q61m0xktWwt+1HSYf3JZsTms3aRJg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/cookie": {
      "version": "0.7.1",
      "resolved": "https://registry.npmjs.org/cookie/-/cookie-0.7.1.tgz",
      "integrity": "sha512-6DnInpx7SJ2AK3+CTUE/ZM0vWTUboZCegxhC2xiIydHR9jNuTAASBrfEpHhiGOZw/nX51bHt6YQl8jsGo4y/0w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/cookie-signature": {
      "version": "1.0.6",
      "resolved": "https://registry.npmjs.org/cookie-signature/-/cookie-signature-1.0.6.tgz",
      "integrity": "sha512-QADzlaHc8icV8I7vbaJXJwod9HWYp8uCqf1xa4OfNu1T7JVxQIrUgOWtHdNDtPiywmFbiS12VjotIXLrKM3orQ==",
      "license": "MIT"
    },
    "node_modules/core-util-is": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/core-util-is/-/core-util-is-1.0.3.tgz",
      "integrity": "sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ==",
      "license": "MIT"
    },
    "node_modules/crc": {
      "version": "4.3.2",
      "resolved": "https://registry.npmjs.org/crc/-/crc-4.3.2.tgz",
      "integrity": "sha512-uGDHf4KLLh2zsHa8D8hIQ1H/HtFQhyHrc0uhHBcoKGol/Xnb+MPYfUMw7cvON6ze/GUESTudKayDcJC5HnJv1A==",
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "peerDependencies": {
        "buffer": ">=6.0.3"
      },
      "peerDependenciesMeta": {
        "buffer": {
          "optional": true
        }
      }
    },
    "node_modules/csstype": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/csstype/-/csstype-3.1.3.tgz",
      "integrity": "sha512-M1uQkMl8rQK/szD0LNhtqxIPLpimGm8sOBwU7lLnCpSbTyY3yeU1Vc7l4KT5zT4s/yOxHH5O7tIuuLOCnLADRw==",
      "license": "MIT"
    },
    "node_modules/d3-array": {
      "version": "3.2.4",
      "resolved": "https://registry.npmjs.org/d3-array/-/d3-array-3.2.4.tgz",
      "integrity": "sha512-tdQAmyA18i4J7wprpYq8ClcxZy3SC31QMeByyCFyRt7BVHdREQZ5lpzoe5mFEYZUWe+oq8HBvk9JjpibyEV4Jg==",
      "license": "ISC",
      "dependencies": {
        "internmap": "1 - 2"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-color": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-color/-/d3-color-3.1.0.tgz",
      "integrity": "sha512-zg/chbXyeBtMQ1LbD/WSoW2DpC3I0mpmPdW+ynRTj/x2DAWYrIY7qeZIHidozwV24m4iavr15lNwIwLxRmOxhA==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-ease": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-ease/-/d3-ease-3.0.1.tgz",
      "integrity": "sha512-wR/XK3D3XcLIZwpbvQwQ5fK+8Ykds1ip7A2Txe0yxncXSdq1L9skcG7blcedkOX+ZcgxGAmLX1FrRGbADwzi0w==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-format": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-format/-/d3-format-3.1.0.tgz",
      "integrity": "sha512-YyUI6AEuY/Wpt8KWLgZHsIU86atmikuoOmCfommt0LYHiQSPjvX2AcFc38PX0CBpr2RCyZhjex+NS/LPOv6YqA==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-interpolate": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-interpolate/-/d3-interpolate-3.0.1.tgz",
      "integrity": "sha512-3bYs1rOD33uo8aqJfKP3JWPAibgw8Zm2+L9vBKEHJ2Rg+viTR7o5Mmv5mZcieN+FRYaAOWX5SJATX6k1PWz72g==",
      "license": "ISC",
      "dependencies": {
        "d3-color": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-path": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-path/-/d3-path-3.1.0.tgz",
      "integrity": "sha512-p3KP5HCf/bvjBSSKuXid6Zqijx7wIfNW+J/maPs+iwR35at5JCbLUT0LzF1cnjbCHWhqzQTIN2Jpe8pRebIEFQ==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-scale": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/d3-scale/-/d3-scale-4.0.2.tgz",
      "integrity": "sha512-GZW464g1SH7ag3Y7hXjf8RoUuAFIqklOAq3MRl4OaWabTFJY9PN/E1YklhXLh+OQ3fM9yS2nOkCoS+WLZ6kvxQ==",
      "license": "ISC",
      "dependencies": {
        "d3-array": "2.10.0 - 3",
        "d3-format": "1 - 3",
        "d3-interpolate": "1.2.0 - 3",
        "d3-time": "2.1.1 - 3",
        "d3-time-format": "2 - 4"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-shape": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/d3-shape/-/d3-shape-3.2.0.tgz",
      "integrity": "sha512-SaLBuwGm3MOViRq2ABk3eLoxwZELpH6zhl3FbAoJ7Vm1gofKx6El1Ib5z23NUEhF9AsGl7y+dzLe5Cw2AArGTA==",
      "license": "ISC",
      "dependencies": {
        "d3-path": "^3.1.0"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-time": {
      "version": "3.1.0",
      "resolved": "https://registry.npmjs.org/d3-time/-/d3-time-3.1.0.tgz",
      "integrity": "sha512-VqKjzBLejbSMT4IgbmVgDjpkYrNWUYJnbCGo874u7MMKIWsILRX+OpX/gTk8MqjpT1A/c6HY2dCA77ZN0lkQ2Q==",
      "license": "ISC",
      "dependencies": {
        "d3-array": "2 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-time-format": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/d3-time-format/-/d3-time-format-4.1.0.tgz",
      "integrity": "sha512-dJxPBlzC7NugB2PDLwo9Q8JiTR3M3e4/XANkreKSUxF8vvXKqm1Yfq4Q5dl8budlunRVlUUaDUgFt7eA8D6NLg==",
      "license": "ISC",
      "dependencies": {
        "d3-time": "1 - 3"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/d3-timer": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/d3-timer/-/d3-timer-3.0.1.tgz",
      "integrity": "sha512-ndfJ/JxxMd3nw31uyKoY2naivF+r29V+Lc0svZxe1JvvIRmi8hUsrMvdOwgS1o6uBHmiz91geQ0ylPP0aj1VUA==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/dashdash": {
      "version": "1.14.1",
      "resolved": "https://registry.npmjs.org/dashdash/-/dashdash-1.14.1.tgz",
      "integrity": "sha512-jRFi8UDGo6j+odZiEpjazZaWqEal3w/basFjQHQEwVtZJGDpxbH1MeYluwCS8Xq5wmLJooDlMgvVarmWfGM44g==",
      "license": "MIT",
      "dependencies": {
        "assert-plus": "^1.0.0"
      },
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/data-view-buffer": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/data-view-buffer/-/data-view-buffer-1.0.2.tgz",
      "integrity": "sha512-EmKO5V3OLXh1rtK2wgXRansaK1/mtVdTUEiEI0W8RkvgT05kfxaH29PliLnpLP73yYO6142Q72QNa8Wx/A5CqQ==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "es-errors": "^1.3.0",
        "is-data-view": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/data-view-byte-length": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/data-view-byte-length/-/data-view-byte-length-1.0.2.tgz",
      "integrity": "sha512-tuhGbE6CfTM9+5ANGf+oQb72Ky/0+s3xKUpHvShfiz2RxMFgFPjsXuRLBVMtvMs15awe45SRb83D6wH4ew6wlQ==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "es-errors": "^1.3.0",
        "is-data-view": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/inspect-js"
      }
    },
    "node_modules/data-view-byte-offset": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/data-view-byte-offset/-/data-view-byte-offset-1.0.1.tgz",
      "integrity": "sha512-BS8PfmtDGnrgYdOonGZQdLZslWIeCGFP9tpan0hi1Co2Zr2NKADsvGYA8XxuG/4UWgJ6Cjtv+YJnB6MM69QGlQ==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "is-data-view": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/date-fns": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/date-fns/-/date-fns-3.6.0.tgz",
      "integrity": "sha512-fRHTG8g/Gif+kSh50gaGEdToemgfj74aRX3swtiouboip5JDLAyDE9F11nHMIcvOaXeOC6D7SpNhi7uFyB7Uww==",
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/kossnocorp"
      }
    },
    "node_modules/date-fns-jalali": {
      "version": "4.1.0-0",
      "resolved": "https://registry.npmjs.org/date-fns-jalali/-/date-fns-jalali-4.1.0-0.tgz",
      "integrity": "sha512-hTIP/z+t+qKwBDcmmsnmjWTduxCg+5KfdqWQvb2X/8C9+knYY6epN/pfxdDuyVlSVeFz0sM5eEfwIUQ70U4ckg==",
      "license": "MIT"
    },
    "node_modules/debug": {
      "version": "4.3.7",
      "resolved": "https://registry.npmjs.org/debug/-/debug-4.3.7.tgz",
      "integrity": "sha512-Er2nc/H7RrMXZBFCEim6TCmMk02Z8vLC2Rbi1KEBggpo0fS6l0S1nnapwmIi3yW/+GOJap1Krg4w0Hg80oCqgQ==",
      "license": "MIT",
      "dependencies": {
        "ms": "^2.1.3"
      },
      "engines": {
        "node": ">=6.0"
      },
      "peerDependenciesMeta": {
        "supports-color": {
          "optional": true
        }
      }
    },
    "node_modules/decimal.js-light": {
      "version": "2.5.1",
      "resolved": "https://registry.npmjs.org/decimal.js-light/-/decimal.js-light-2.5.1.tgz",
      "integrity": "sha512-qIMFpTMZmny+MMIitAB6D7iVPEorVw6YQRWkvarTkT4tBeSLLiHzcwj6q0MmYSFCiVpiqPJTJEYIrpcPzVEIvg==",
      "license": "MIT"
    },
    "node_modules/define-data-property": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/define-data-property/-/define-data-property-1.1.4.tgz",
      "integrity": "sha512-rBMvIzlpA8v6E+SJZoo++HAYqsLrkg7MSfIinMPFhmkorw7X+dOXVJQs+QT69zGkzMyfDnIMN2Wid1+NbL3T+A==",
      "license": "MIT",
      "dependencies": {
        "es-define-property": "^1.0.0",
        "es-errors": "^1.3.0",
        "gopd": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/define-properties": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/define-properties/-/define-properties-1.2.1.tgz",
      "integrity": "sha512-8QmQKqEASLd5nx0U1B1okLElbUuuttJ/AnYmRXbbbGDWh6uS208EjD4Xqq/I9wK7u0v6O08XhTWnt5XtEbR6Dg==",
      "license": "MIT",
      "dependencies": {
        "define-data-property": "^1.0.1",
        "has-property-descriptors": "^1.0.0",
        "object-keys": "^1.1.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/delayed-stream": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/delayed-stream/-/delayed-stream-1.0.0.tgz",
      "integrity": "sha512-ZySD7Nf91aLB0RxL4KGrKHBXl7Eds1DAmEdcoVawXnLD7SDhpNgtuII2aAkg7a7QS41jxPSZ17p4VdGnMHk3MQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.4.0"
      }
    },
    "node_modules/depd": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/depd/-/depd-2.0.0.tgz",
      "integrity": "sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/destroy": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/destroy/-/destroy-1.2.0.tgz",
      "integrity": "sha512-2sJGJTaXIIaR1w4iJSNoN0hnMY7Gpc/n8D4qSCJw8QqFWXf7cuAgnEHxBpweaVcPevC2l3KpjYCx3NypQQgaJg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8",
        "npm": "1.2.8000 || >= 1.4.16"
      }
    },
    "node_modules/detect-libc": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/detect-libc/-/detect-libc-2.0.3.tgz",
      "integrity": "sha512-bwy0MGW55bG41VqxxypOsdSdGqLwXPI/focwgTYCFMbdUiBAxLg9CFzG08sz2aqzknwiX7Hkl0bQENjg8iLByw==",
      "dev": true,
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/detect-node-es": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/detect-node-es/-/detect-node-es-1.1.0.tgz",
      "integrity": "sha512-ypdmJU/TbBby2Dxibuv7ZLW3Bs1QEmM7nHjEANfohJLvE0XVujisn1qPJcZxg+qDucsr+bP6fLD1rPS3AhJ7EQ=="
    },
    "node_modules/dom-helpers": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/dom-helpers/-/dom-helpers-5.2.1.tgz",
      "integrity": "sha512-nRCa7CK3VTrM2NmGkIy4cbK7IZlgBE/PYMn55rrXefr5xXDP0LdtfPnblFDoVdcAfslJ7or6iqAUnx0CCGIWQA==",
      "license": "MIT",
      "dependencies": {
        "@babel/runtime": "^7.8.7",
        "csstype": "^3.0.2"
      }
    },
    "node_modules/drizzle-kit": {
      "version": "0.31.4",
      "resolved": "https://registry.npmjs.org/drizzle-kit/-/drizzle-kit-0.31.4.tgz",
      "integrity": "sha512-tCPWVZWZqWVx2XUsVpJRnH9Mx0ClVOf5YUHerZ5so1OKSlqww4zy1R5ksEdGRcO3tM3zj0PYN6V48TbQCL1RfA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@drizzle-team/brocli": "^0.10.2",
        "@esbuild-kit/esm-loader": "^2.5.5",
        "esbuild": "^0.25.4",
        "esbuild-register": "^3.5.0"
      },
      "bin": {
        "drizzle-kit": "bin.cjs"
      }
    },
    "node_modules/drizzle-orm": {
      "version": "0.39.3",
      "resolved": "https://registry.npmjs.org/drizzle-orm/-/drizzle-orm-0.39.3.tgz",
      "integrity": "sha512-EZ8ZpYvDIvKU9C56JYLOmUskazhad+uXZCTCRN4OnRMsL+xAJ05dv1eCpAG5xzhsm1hqiuC5kAZUCS924u2DTw==",
      "license": "Apache-2.0",
      "peerDependencies": {
        "@aws-sdk/client-rds-data": ">=3",
        "@cloudflare/workers-types": ">=4",
        "@electric-sql/pglite": ">=0.2.0",
        "@libsql/client": ">=0.10.0",
        "@libsql/client-wasm": ">=0.10.0",
        "@neondatabase/serverless": ">=0.10.0",
        "@op-engineering/op-sqlite": ">=2",
        "@opentelemetry/api": "^1.4.1",
        "@planetscale/database": ">=1",
        "@prisma/client": "*",
        "@tidbcloud/serverless": "*",
        "@types/better-sqlite3": "*",
        "@types/pg": "*",
        "@types/sql.js": "*",
        "@vercel/postgres": ">=0.8.0",
        "@xata.io/client": "*",
        "better-sqlite3": ">=7",
        "bun-types": "*",
        "expo-sqlite": ">=14.0.0",
        "knex": "*",
        "kysely": "*",
        "mysql2": ">=2",
        "pg": ">=8",
        "postgres": ">=3",
        "sql.js": ">=1",
        "sqlite3": ">=5"
      },
      "peerDependenciesMeta": {
        "@aws-sdk/client-rds-data": {
          "optional": true
        },
        "@cloudflare/workers-types": {
          "optional": true
        },
        "@electric-sql/pglite": {
          "optional": true
        },
        "@libsql/client": {
          "optional": true
        },
        "@libsql/client-wasm": {
          "optional": true
        },
        "@neondatabase/serverless": {
          "optional": true
        },
        "@op-engineering/op-sqlite": {
          "optional": true
        },
        "@opentelemetry/api": {
          "optional": true
        },
        "@planetscale/database": {
          "optional": true
        },
        "@prisma/client": {
          "optional": true
        },
        "@tidbcloud/serverless": {
          "optional": true
        },
        "@types/better-sqlite3": {
          "optional": true
        },
        "@types/pg": {
          "optional": true
        },
        "@types/sql.js": {
          "optional": true
        },
        "@vercel/postgres": {
          "optional": true
        },
        "@xata.io/client": {
          "optional": true
        },
        "better-sqlite3": {
          "optional": true
        },
        "bun-types": {
          "optional": true
        },
        "expo-sqlite": {
          "optional": true
        },
        "knex": {
          "optional": true
        },
        "kysely": {
          "optional": true
        },
        "mysql2": {
          "optional": true
        },
        "pg": {
          "optional": true
        },
        "postgres": {
          "optional": true
        },
        "prisma": {
          "optional": true
        },
        "sql.js": {
          "optional": true
        },
        "sqlite3": {
          "optional": true
        }
      }
    },
    "node_modules/drizzle-zod": {
      "version": "0.7.0",
      "resolved": "https://registry.npmjs.org/drizzle-zod/-/drizzle-zod-0.7.0.tgz",
      "integrity": "sha512-xgCRYYVEzRkeXTS33GSMgoowe3vKsMNBjSI+cwG1oLQVEhAWWbqtb/AAMlm7tkmV4fG/uJjEmWzdzlEmTgWOoQ==",
      "license": "Apache-2.0",
      "peerDependencies": {
        "drizzle-orm": ">=0.36.0",
        "zod": ">=3.0.0"
      }
    },
    "node_modules/dunder-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/dunder-proto/-/dunder-proto-1.0.1.tgz",
      "integrity": "sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.1",
        "es-errors": "^1.3.0",
        "gopd": "^1.2.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/ecc-jsbn": {
      "version": "0.1.2",
      "resolved": "https://registry.npmjs.org/ecc-jsbn/-/ecc-jsbn-0.1.2.tgz",
      "integrity": "sha512-eh9O+hwRHNbG4BLTjEl3nw044CkGm5X6LoaCf7LPp7UU8Qrt47JYNi6nPX8xjW97TKGKm1ouctg0QSpZe9qrnw==",
      "license": "MIT",
      "dependencies": {
        "jsbn": "~0.1.0",
        "safer-buffer": "^2.1.0"
      }
    },
    "node_modules/ee-first": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/ee-first/-/ee-first-1.1.1.tgz",
      "integrity": "sha512-WMwm9LhRUo+WUaRN+vRuETqG89IgZphVSNkdFgeb6sS/E4OrDIN7t48CAewSHXc6C8lefD8KKfr5vY61brQlow==",
      "license": "MIT"
    },
    "node_modules/electron-to-chromium": {
      "version": "1.5.243",
      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.243.tgz",
      "integrity": "sha512-ZCphxFW3Q1TVhcgS9blfut1PX8lusVi2SvXQgmEEnK4TCmE1JhH2JkjJN+DNt0pJJwfBri5AROBnz2b/C+YU9g==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/embla-carousel": {
      "version": "8.6.0",
      "resolved": "https://registry.npmjs.org/embla-carousel/-/embla-carousel-8.6.0.tgz",
      "integrity": "sha512-SjWyZBHJPbqxHOzckOfo8lHisEaJWmwd23XppYFYVh10bU66/Pn5tkVkbkCMZVdbUE5eTCI2nD8OyIP4Z+uwkA=="
    },
    "node_modules/embla-carousel-react": {
      "version": "8.6.0",
      "resolved": "https://registry.npmjs.org/embla-carousel-react/-/embla-carousel-react-8.6.0.tgz",
      "integrity": "sha512-0/PjqU7geVmo6F734pmPqpyHqiM99olvyecY7zdweCw+6tKEXnrE90pBiBbMMU8s5tICemzpQ3hi5EpxzGW+JA==",
      "dependencies": {
        "embla-carousel": "8.6.0",
        "embla-carousel-reactive-utils": "8.6.0"
      },
      "peerDependencies": {
        "react": "^16.8.0 || ^17.0.1 || ^18.0.0 || ^19.0.0 || ^19.0.0-rc"
      }
    },
    "node_modules/embla-carousel-reactive-utils": {
      "version": "8.6.0",
      "resolved": "https://registry.npmjs.org/embla-carousel-reactive-utils/-/embla-carousel-reactive-utils-8.6.0.tgz",
      "integrity": "sha512-fMVUDUEx0/uIEDM0Mz3dHznDhfX+znCCDCeIophYb1QGVM7YThSWX+wz11zlYwWFOr74b4QLGg0hrGPJeG2s4A==",
      "peerDependencies": {
        "embla-carousel": "8.6.0"
      }
    },
    "node_modules/encodeurl": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-2.0.0.tgz",
      "integrity": "sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/end-of-stream": {
      "version": "1.4.5",
      "resolved": "https://registry.npmjs.org/end-of-stream/-/end-of-stream-1.4.5.tgz",
      "integrity": "sha512-ooEGc6HP26xXq/N+GCGOT0JKCLDGrq2bQUZrQ7gyrJiZANJ/8YDTxTpQBXGMn+WbIQXNVpyWymm7KYVICQnyOg==",
      "license": "MIT",
      "dependencies": {
        "once": "^1.4.0"
      }
    },
    "node_modules/enhanced-resolve": {
      "version": "5.18.3",
      "resolved": "https://registry.npmjs.org/enhanced-resolve/-/enhanced-resolve-5.18.3.tgz",
      "integrity": "sha512-d4lC8xfavMeBjzGr2vECC3fsGXziXZQyJxD868h2M/mBI3PwAuODxAkLkq5HYuvrPYcUtiLzsTo8U3PgX3Ocww==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "graceful-fs": "^4.2.4",
        "tapable": "^2.2.0"
      },
      "engines": {
        "node": ">=10.13.0"
      }
    },
    "node_modules/es-abstract": {
      "version": "1.24.0",
      "resolved": "https://registry.npmjs.org/es-abstract/-/es-abstract-1.24.0.tgz",
      "integrity": "sha512-WSzPgsdLtTcQwm4CROfS5ju2Wa1QQcVeT37jFjYzdFz1r9ahadC8B8/a4qxJxM+09F18iumCdRmlr96ZYkQvEg==",
      "license": "MIT",
      "dependencies": {
        "array-buffer-byte-length": "^1.0.2",
        "arraybuffer.prototype.slice": "^1.0.4",
        "available-typed-arrays": "^1.0.7",
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.4",
        "data-view-buffer": "^1.0.2",
        "data-view-byte-length": "^1.0.2",
        "data-view-byte-offset": "^1.0.1",
        "es-define-property": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.1.1",
        "es-set-tostringtag": "^2.1.0",
        "es-to-primitive": "^1.3.0",
        "function.prototype.name": "^1.1.8",
        "get-intrinsic": "^1.3.0",
        "get-proto": "^1.0.1",
        "get-symbol-description": "^1.1.0",
        "globalthis": "^1.0.4",
        "gopd": "^1.2.0",
        "has-property-descriptors": "^1.0.2",
        "has-proto": "^1.2.0",
        "has-symbols": "^1.1.0",
        "hasown": "^2.0.2",
        "internal-slot": "^1.1.0",
        "is-array-buffer": "^3.0.5",
        "is-callable": "^1.2.7",
        "is-data-view": "^1.0.2",
        "is-negative-zero": "^2.0.3",
        "is-regex": "^1.2.1",
        "is-set": "^2.0.3",
        "is-shared-array-buffer": "^1.0.4",
        "is-string": "^1.1.1",
        "is-typed-array": "^1.1.15",
        "is-weakref": "^1.1.1",
        "math-intrinsics": "^1.1.0",
        "object-inspect": "^1.13.4",
        "object-keys": "^1.1.1",
        "object.assign": "^4.1.7",
        "own-keys": "^1.0.1",
        "regexp.prototype.flags": "^1.5.4",
        "safe-array-concat": "^1.1.3",
        "safe-push-apply": "^1.0.0",
        "safe-regex-test": "^1.1.0",
        "set-proto": "^1.0.0",
        "stop-iteration-iterator": "^1.1.0",
        "string.prototype.trim": "^1.2.10",
        "string.prototype.trimend": "^1.0.9",
        "string.prototype.trimstart": "^1.0.8",
        "typed-array-buffer": "^1.0.3",
        "typed-array-byte-length": "^1.0.3",
        "typed-array-byte-offset": "^1.0.4",
        "typed-array-length": "^1.0.7",
        "unbox-primitive": "^1.1.0",
        "which-typed-array": "^1.1.19"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/es-define-property": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/es-define-property/-/es-define-property-1.0.1.tgz",
      "integrity": "sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-errors": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/es-errors/-/es-errors-1.3.0.tgz",
      "integrity": "sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-object-atoms": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/es-object-atoms/-/es-object-atoms-1.1.1.tgz",
      "integrity": "sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-set-tostringtag": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/es-set-tostringtag/-/es-set-tostringtag-2.1.0.tgz",
      "integrity": "sha512-j6vWzfrGVfyXxge+O0x5sh6cvxAog0a/4Rdd2K36zCMV5eJ+/+tOAngRO8cODMNWbVRdVlmGZQL2YS3yR8bIUA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.6",
        "has-tostringtag": "^1.0.2",
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-shim-unscopables": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/es-shim-unscopables/-/es-shim-unscopables-1.1.0.tgz",
      "integrity": "sha512-d9T8ucsEhh8Bi1woXCf+TIKDIROLG5WCkxg8geBCbvk22kzwC5G2OnXVMO6FUsvQlgUUXQ2itephWDLqDzbeCw==",
      "license": "MIT",
      "dependencies": {
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-to-primitive": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/es-to-primitive/-/es-to-primitive-1.3.0.tgz",
      "integrity": "sha512-w+5mJ3GuFL+NjVtJlvydShqE1eN3h3PbI7/5LAsYJP/2qtuMXjfL2LpHSRqo4b4eSF5K/DH1JXKUAHSB2UW50g==",
      "license": "MIT",
      "dependencies": {
        "is-callable": "^1.2.7",
        "is-date-object": "^1.0.5",
        "is-symbol": "^1.0.4"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/esbuild": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.25.9.tgz",
      "integrity": "sha512-CRbODhYyQx3qp7ZEwzxOk4JBqmD/seJrzPa/cGjY1VtIn5E09Oi9/dB4JwctnfZ8Q8iT7rioVv5k/FNT/uf54g==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=18"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.25.9",
        "@esbuild/android-arm": "0.25.9",
        "@esbuild/android-arm64": "0.25.9",
        "@esbuild/android-x64": "0.25.9",
        "@esbuild/darwin-arm64": "0.25.9",
        "@esbuild/darwin-x64": "0.25.9",
        "@esbuild/freebsd-arm64": "0.25.9",
        "@esbuild/freebsd-x64": "0.25.9",
        "@esbuild/linux-arm": "0.25.9",
        "@esbuild/linux-arm64": "0.25.9",
        "@esbuild/linux-ia32": "0.25.9",
        "@esbuild/linux-loong64": "0.25.9",
        "@esbuild/linux-mips64el": "0.25.9",
        "@esbuild/linux-ppc64": "0.25.9",
        "@esbuild/linux-riscv64": "0.25.9",
        "@esbuild/linux-s390x": "0.25.9",
        "@esbuild/linux-x64": "0.25.9",
        "@esbuild/netbsd-arm64": "0.25.9",
        "@esbuild/netbsd-x64": "0.25.9",
        "@esbuild/openbsd-arm64": "0.25.9",
        "@esbuild/openbsd-x64": "0.25.9",
        "@esbuild/openharmony-arm64": "0.25.9",
        "@esbuild/sunos-x64": "0.25.9",
        "@esbuild/win32-arm64": "0.25.9",
        "@esbuild/win32-ia32": "0.25.9",
        "@esbuild/win32-x64": "0.25.9"
      }
    },
    "node_modules/esbuild-register": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/esbuild-register/-/esbuild-register-3.6.0.tgz",
      "integrity": "sha512-H2/S7Pm8a9CL1uhp9OvjwrBh5Pvx0H8qVOxNu8Wed9Y7qv56MPtq+GGM8RJpq6glYJn9Wspr8uw7l55uyinNeg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "debug": "^4.3.4"
      },
      "peerDependencies": {
        "esbuild": ">=0.12 <1"
      }
    },
    "node_modules/escalade": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/escape-html": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/escape-html/-/escape-html-1.0.3.tgz",
      "integrity": "sha512-NiSupZ4OeuGwr68lGIeym/ksIZMJodUGOSCZ/FSnTxcrekbvqrgdUxlJOMpijaKZVjAJrWrGs/6Jy8OMuyj9ow==",
      "license": "MIT"
    },
    "node_modules/etag": {
      "version": "1.8.1",
      "resolved": "https://registry.npmjs.org/etag/-/etag-1.8.1.tgz",
      "integrity": "sha512-aIL5Fx7mawVa300al2BnEE4iNvo1qETxLrPI/o05L7z6go7fCw1J6EQmbK4FmJ2AS7kgVF/KEZWufBfdClMcPg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/eventemitter3": {
      "version": "4.0.7",
      "resolved": "https://registry.npmjs.org/eventemitter3/-/eventemitter3-4.0.7.tgz",
      "integrity": "sha512-8guHBZCwKnFhYdHr2ysuRWErTwhoN2X8XELRlrRwpmfeY2jjuUN4taQMsULKUVo1K4DvZl+0pgfyoysHxvmvEw==",
      "license": "MIT"
    },
    "node_modules/express": {
      "version": "4.21.2",
      "resolved": "https://registry.npmjs.org/express/-/express-4.21.2.tgz",
      "integrity": "sha512-28HqgMZAmih1Czt9ny7qr6ek2qddF4FclbMzwhCREB6OFfH+rXAnuNCwo1/wFvrtbgsQDb4kSbX9de9lFbrXnA==",
      "license": "MIT",
      "dependencies": {
        "accepts": "~1.3.8",
        "array-flatten": "1.1.1",
        "body-parser": "1.20.3",
        "content-disposition": "0.5.4",
        "content-type": "~1.0.4",
        "cookie": "0.7.1",
        "cookie-signature": "1.0.6",
        "debug": "2.6.9",
        "depd": "2.0.0",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "finalhandler": "1.3.1",
        "fresh": "0.5.2",
        "http-errors": "2.0.0",
        "merge-descriptors": "1.0.3",
        "methods": "~1.1.2",
        "on-finished": "2.4.1",
        "parseurl": "~1.3.3",
        "path-to-regexp": "0.1.12",
        "proxy-addr": "~2.0.7",
        "qs": "6.13.0",
        "range-parser": "~1.2.1",
        "safe-buffer": "5.2.1",
        "send": "0.19.0",
        "serve-static": "1.16.2",
        "setprototypeof": "1.2.0",
        "statuses": "2.0.1",
        "type-is": "~1.6.18",
        "utils-merge": "1.0.1",
        "vary": "~1.1.2"
      },
      "engines": {
        "node": ">= 0.10.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/express"
      }
    },
    "node_modules/express-session": {
      "version": "1.18.1",
      "resolved": "https://registry.npmjs.org/express-session/-/express-session-1.18.1.tgz",
      "integrity": "sha512-a5mtTqEaZvBCL9A9aqkrtfz+3SMDhOVUnjafjo+s7A9Txkq+SVX2DLvSp1Zrv4uCXa3lMSK3viWnh9Gg07PBUA==",
      "license": "MIT",
      "dependencies": {
        "cookie": "0.7.2",
        "cookie-signature": "1.0.7",
        "debug": "2.6.9",
        "depd": "~2.0.0",
        "on-headers": "~1.0.2",
        "parseurl": "~1.3.3",
        "safe-buffer": "5.2.1",
        "uid-safe": "~2.1.5"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/express-session/node_modules/cookie": {
      "version": "0.7.2",
      "resolved": "https://registry.npmjs.org/cookie/-/cookie-0.7.2.tgz",
      "integrity": "sha512-yki5XnKuf750l50uGTllt6kKILY4nQ1eNIQatoXEByZ5dWgnKqbnqmTrBE5B4N7lrMJKQ2ytWMiTO2o0v6Ew/w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/express-session/node_modules/cookie-signature": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/cookie-signature/-/cookie-signature-1.0.7.tgz",
      "integrity": "sha512-NXdYc3dLr47pBkpUCHtKSwIOQXLVn8dZEuywboCOJY/osA0wFSLlSawr3KN8qXJEyX66FcONTH8EIlVuK0yyFA==",
      "license": "MIT"
    },
    "node_modules/express-session/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/express-session/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/express/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/express/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/extend": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/extend/-/extend-3.0.2.tgz",
      "integrity": "sha512-fjquC59cD7CyW6urNXK0FBufkZcoiGG80wTuPujX590cB5Ttln20E2UB4S/WARVqhXffZl2LNgS+gQdPIIim/g==",
      "license": "MIT"
    },
    "node_modules/extsprintf": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/extsprintf/-/extsprintf-1.3.0.tgz",
      "integrity": "sha512-11Ndz7Nv+mvAC1j0ktTa7fAb0vLyGGX+rMHNBYQviQDGU0Hw7lhctJANqbPhu9nV9/izT/IntTgZ7Im/9LJs9g==",
      "engines": [
        "node >=0.6.0"
      ],
      "license": "MIT"
    },
    "node_modules/fast-deep-equal": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/fast-deep-equal/-/fast-deep-equal-3.1.3.tgz",
      "integrity": "sha512-f3qQ9oQy9j2AhBe/H9VC91wLmKBCCU/gDOnKNAYG5hswO7BLKj09Hc5HYNz9cGI++xlpDCIgDaitVs03ATR84Q==",
      "license": "MIT",
      "peer": true
    },
    "node_modules/fast-equals": {
      "version": "5.3.2",
      "resolved": "https://registry.npmjs.org/fast-equals/-/fast-equals-5.3.2.tgz",
      "integrity": "sha512-6rxyATwPCkaFIL3JLqw8qXqMpIZ942pTX/tbQFkRsDGblS8tNGtlUauA/+mt6RUfqn/4MoEr+WDkYoIQbibWuQ==",
      "license": "MIT",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/fast-json-stable-stringify": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/fast-json-stable-stringify/-/fast-json-stable-stringify-2.1.0.tgz",
      "integrity": "sha512-lhd/wF+Lk98HZoTCtlVraHtfh5XYijIjalXck7saUtuanSDyLMxnHhSXEDJqHxD7msR8D0uCmqlkwjCV8xvwHw==",
      "license": "MIT",
      "peer": true
    },
    "node_modules/fdir": {
      "version": "6.5.0",
      "resolved": "https://registry.npmjs.org/fdir/-/fdir-6.5.0.tgz",
      "integrity": "sha512-tIbYtZbucOs0BRGqPJkshJUYdL+SDH7dVM8gjy+ERp3WAUjLEFJE+02kanyHtwjWOnwrKYBiwAmM0p4kLJAnXg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12.0.0"
      },
      "peerDependencies": {
        "picomatch": "^3 || ^4"
      },
      "peerDependenciesMeta": {
        "picomatch": {
          "optional": true
        }
      }
    },
    "node_modules/file-type": {
      "version": "3.9.0",
      "resolved": "https://registry.npmjs.org/file-type/-/file-type-3.9.0.tgz",
      "integrity": "sha512-RLoqTXE8/vPmMuTI88DAzhMYC99I8BWv7zYP4A1puo5HIjEJ5EX48ighy4ZyKMG9EDXxBgW6e++cn7d1xuFghA==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/finalhandler": {
      "version": "1.3.1",
      "resolved": "https://registry.npmjs.org/finalhandler/-/finalhandler-1.3.1.tgz",
      "integrity": "sha512-6BN9trH7bp3qvnrRyzsBz+g3lZxTNZTbVO2EV1CS0WIcDbawYVdYvGflME/9QP0h0pYlCDBCTjYa9nZzMDpyxQ==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "on-finished": "2.4.1",
        "parseurl": "~1.3.3",
        "statuses": "2.0.1",
        "unpipe": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/finalhandler/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/finalhandler/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/for-each": {
      "version": "0.3.5",
      "resolved": "https://registry.npmjs.org/for-each/-/for-each-0.3.5.tgz",
      "integrity": "sha512-dKx12eRCVIzqCxFGplyFKJMPvLEWgmNtUrpTiJIR5u97zEhRG8ySrtboPHZXx7daLxQVrl643cTzbab2tkQjxg==",
      "license": "MIT",
      "dependencies": {
        "is-callable": "^1.2.7"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/forever-agent": {
      "version": "0.6.1",
      "resolved": "https://registry.npmjs.org/forever-agent/-/forever-agent-0.6.1.tgz",
      "integrity": "sha512-j0KLYPhm6zeac4lz3oJ3o65qvgQCcPubiyotZrXqEaG4hNagNYO8qdlUrX5vwqv9ohqeT/Z3j6+yW067yWWdUw==",
      "license": "Apache-2.0",
      "engines": {
        "node": "*"
      }
    },
    "node_modules/form-data": {
      "version": "2.5.5",
      "resolved": "https://registry.npmjs.org/form-data/-/form-data-2.5.5.tgz",
      "integrity": "sha512-jqdObeR2rxZZbPSGL+3VckHMYtu+f9//KXBsVny6JSX/pa38Fy+bGjuG8eW/H6USNQWhLi8Num++cU2yOCNz4A==",
      "license": "MIT",
      "dependencies": {
        "asynckit": "^0.4.0",
        "combined-stream": "^1.0.8",
        "es-set-tostringtag": "^2.1.0",
        "hasown": "^2.0.2",
        "mime-types": "^2.1.35",
        "safe-buffer": "^5.2.1"
      },
      "engines": {
        "node": ">= 0.12"
      }
    },
    "node_modules/forwarded": {
      "version": "0.2.0",
      "resolved": "https://registry.npmjs.org/forwarded/-/forwarded-0.2.0.tgz",
      "integrity": "sha512-buRG0fpBtRHSTCOASe6hD258tEubFoRLb4ZNA6NxMVHNw2gOcwHo9wyablzMzOA5z9xA9L1KNjk/Nt6MT9aYow==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/fraction.js": {
      "version": "4.3.7",
      "resolved": "https://registry.npmjs.org/fraction.js/-/fraction.js-4.3.7.tgz",
      "integrity": "sha512-ZsDfxO51wGAXREY55a7la9LScWpwv9RxIrYABrlvOFBlH/ShPnrtsXeuUIfXKKOVicNxQ+o8JTbJvjS4M89yew==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": "*"
      },
      "funding": {
        "type": "patreon",
        "url": "https://github.com/sponsors/rawify"
      }
    },
    "node_modules/framer-motion": {
      "version": "12.23.24",
      "resolved": "https://registry.npmjs.org/framer-motion/-/framer-motion-12.23.24.tgz",
      "integrity": "sha512-HMi5HRoRCTou+3fb3h9oTLyJGBxHfW+HnNE25tAXOvVx/IvwMHK0cx7IR4a2ZU6sh3IX1Z+4ts32PcYBOqka8w==",
      "license": "MIT",
      "dependencies": {
        "motion-dom": "^12.23.23",
        "motion-utils": "^12.23.6",
        "tslib": "^2.4.0"
      },
      "peerDependencies": {
        "@emotion/is-prop-valid": "*",
        "react": "^18.0.0 || ^19.0.0",
        "react-dom": "^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@emotion/is-prop-valid": {
          "optional": true
        },
        "react": {
          "optional": true
        },
        "react-dom": {
          "optional": true
        }
      }
    },
    "node_modules/fresh": {
      "version": "0.5.2",
      "resolved": "https://registry.npmjs.org/fresh/-/fresh-0.5.2.tgz",
      "integrity": "sha512-zJ2mQYM18rEFOudeV4GShTGIQ7RbzA7ozbU9I/XBpm7kqgMywgmylMwXHxZJmkVoYkna9d2pVXVXPdYTP9ej8Q==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/function.prototype.name": {
      "version": "1.1.8",
      "resolved": "https://registry.npmjs.org/function.prototype.name/-/function.prototype.name-1.1.8.tgz",
      "integrity": "sha512-e5iwyodOHhbMr/yNrc7fDYG4qlbIvI5gajyzPnb5TCwyhjApznQh1BMFou9b30SevY43gCJKXycoCBjMbsuW0Q==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.3",
        "define-properties": "^1.2.1",
        "functions-have-names": "^1.2.3",
        "hasown": "^2.0.2",
        "is-callable": "^1.2.7"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/functions-have-names": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/functions-have-names/-/functions-have-names-1.2.3.tgz",
      "integrity": "sha512-xckBUXyTIqT97tq2x2AMb+g163b5JFysYk0x4qxNFwbfQkmNZoiRHb6sPzI9/QV33WeuvVYBUIiD4NzNIyqaRQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/generator-function": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/generator-function/-/generator-function-2.0.1.tgz",
      "integrity": "sha512-SFdFmIJi+ybC0vjlHN0ZGVGHc3lgE0DxPAT0djjVg+kjOnSqclqmj0KQ7ykTOLP6YxoqOvuAODGdcHJn+43q3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/gensync": {
      "version": "1.0.0-beta.2",
      "resolved": "https://registry.npmjs.org/gensync/-/gensync-1.0.0-beta.2.tgz",
      "integrity": "sha512-3hN7NaskYvMDLQY55gnW3NQ+mesEAepTqlg+VEbj7zzqEMBVNhzcGYYeqFo/TlYz6eQiFcp1HcsCZO+nGgS8zg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/get-intrinsic": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/get-intrinsic/-/get-intrinsic-1.3.0.tgz",
      "integrity": "sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "es-define-property": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.1.1",
        "function-bind": "^1.1.2",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "has-symbols": "^1.1.0",
        "hasown": "^2.0.2",
        "math-intrinsics": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-nonce": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/get-nonce/-/get-nonce-1.0.1.tgz",
      "integrity": "sha512-FJhYRoDaiatfEkUK8HKlicmu/3SGFD51q3itKDGoSTysQJBnfOcxU5GxnhE1E6soB76MbT0MBtnKJuXyAx+96Q==",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/get-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/get-proto/-/get-proto-1.0.1.tgz",
      "integrity": "sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==",
      "license": "MIT",
      "dependencies": {
        "dunder-proto": "^1.0.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/get-symbol-description": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/get-symbol-description/-/get-symbol-description-1.1.0.tgz",
      "integrity": "sha512-w9UMqWwJxHNOvoNzSJ2oPF5wvYcvP7jUvYzhp67yEhTi17ZDBBC1z9pTdGuzjD+EFIqLSYRweZjqfiPzQ06Ebg==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.6"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-tsconfig": {
      "version": "4.8.1",
      "resolved": "https://registry.npmjs.org/get-tsconfig/-/get-tsconfig-4.8.1.tgz",
      "integrity": "sha512-k9PN+cFBmaLWtVz29SkUoqU5O0slLuHJXt/2P+tMVFT+phsSGXGkp9t3rQIqdz0e+06EHNGs3oM6ZX1s2zHxRg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "resolve-pkg-maps": "^1.0.0"
      },
      "funding": {
        "url": "https://github.com/privatenumber/get-tsconfig?sponsor=1"
      }
    },
    "node_modules/getpass": {
      "version": "0.1.7",
      "resolved": "https://registry.npmjs.org/getpass/-/getpass-0.1.7.tgz",
      "integrity": "sha512-0fzj9JxOLfJ+XGLhR8ze3unN0KZCgZwiSSDz168VERjK8Wl8kVSdcu2kspd4s4wtAa1y/qrVRiAA0WclVsu0ng==",
      "license": "MIT",
      "dependencies": {
        "assert-plus": "^1.0.0"
      }
    },
    "node_modules/globalthis": {
      "version": "1.0.4",
      "resolved": "https://registry.npmjs.org/globalthis/-/globalthis-1.0.4.tgz",
      "integrity": "sha512-DpLKbNU4WylpxJykQujfCcwYWiV/Jhm50Goo0wrVILAv5jOr9d+H+UR3PhSCD2rCCEIg0uc+G+muBTwD54JhDQ==",
      "license": "MIT",
      "dependencies": {
        "define-properties": "^1.2.1",
        "gopd": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/gopd": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/gopd/-/gopd-1.2.0.tgz",
      "integrity": "sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/graceful-fs": {
      "version": "4.2.11",
      "resolved": "https://registry.npmjs.org/graceful-fs/-/graceful-fs-4.2.11.tgz",
      "integrity": "sha512-RbJ5/jmFcNNCcDV5o9eTnBLJ/HszWV0P73bc+Ff4nS/rJj+YaS6IGyiOL0VoBYX+l1Wrl3k63h/KrH+nhJ0XvQ==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/har-schema": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/har-schema/-/har-schema-2.0.0.tgz",
      "integrity": "sha512-Oqluz6zhGX8cyRaTQlFMPw80bSJVG2x/cFb8ZPhUILGgHka9SsokCCOQgpveePerqidZOrT14ipqfJb7ILcW5Q==",
      "license": "ISC",
      "peer": true,
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/har-validator": {
      "version": "5.1.5",
      "resolved": "https://registry.npmjs.org/har-validator/-/har-validator-5.1.5.tgz",
      "integrity": "sha512-nmT2T0lljbxdQZfspsno9hgrG3Uir6Ks5afism62poxqBM6sDnMEuPmzTq8XN0OEwqKLLdh1jQI3qyE66Nzb3w==",
      "deprecated": "this library is no longer supported",
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "ajv": "^6.12.3",
        "har-schema": "^2.0.0"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/has-bigints": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/has-bigints/-/has-bigints-1.1.0.tgz",
      "integrity": "sha512-R3pbpkcIqv2Pm3dUwgjclDRVmWpTJW2DcMzcIhEXEx1oh/CEMObMm3KLmRJOdvhM7o4uQBnwr8pzRK2sJWIqfg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-property-descriptors": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/has-property-descriptors/-/has-property-descriptors-1.0.2.tgz",
      "integrity": "sha512-55JNKuIW+vq4Ke1BjOTjM2YctQIvCT7GFzHwmfZPGo5wnrgkid0YQtnAleFSqumZm4az3n2BS+erby5ipJdgrg==",
      "license": "MIT",
      "dependencies": {
        "es-define-property": "^1.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-proto": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/has-proto/-/has-proto-1.2.0.tgz",
      "integrity": "sha512-KIL7eQPfHQRC8+XluaIw7BHUwwqL19bQn4hzNgdr+1wXoU0KKj6rufu47lhY7KbJR2C6T6+PfyN0Ea7wkSS+qQ==",
      "license": "MIT",
      "dependencies": {
        "dunder-proto": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-symbols": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/has-symbols/-/has-symbols-1.1.0.tgz",
      "integrity": "sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-tostringtag": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/has-tostringtag/-/has-tostringtag-1.0.2.tgz",
      "integrity": "sha512-NqADB8VjPFLM2V0VvHUewwwsw0ZWBaIdgo+ieHtK3hasLz4qeCRjYcqfB6AQrBggRKppKF8L52/VqdVsO47Dlw==",
      "license": "MIT",
      "dependencies": {
        "has-symbols": "^1.0.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "license": "MIT",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/http-errors": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/http-errors/-/http-errors-2.0.0.tgz",
      "integrity": "sha512-FtwrG/euBzaEjYeRqOgly7G0qviiXoJWnvEH2Z1plBdXgbyjv34pHTSb9zoeHMyDy33+DWy5Wt9Wo+TURtOYSQ==",
      "license": "MIT",
      "dependencies": {
        "depd": "2.0.0",
        "inherits": "2.0.4",
        "setprototypeof": "1.2.0",
        "statuses": "2.0.1",
        "toidentifier": "1.0.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/http-signature": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/http-signature/-/http-signature-1.4.0.tgz",
      "integrity": "sha512-G5akfn7eKbpDN+8nPS/cb57YeA1jLTVxjpCj7tmm3QKPdyDy7T+qSC40e9ptydSWvkwjSXw1VbkpyEm39ukeAg==",
      "license": "MIT",
      "dependencies": {
        "assert-plus": "^1.0.0",
        "jsprim": "^2.0.2",
        "sshpk": "^1.18.0"
      },
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/iconv-lite": {
      "version": "0.4.24",
      "resolved": "https://registry.npmjs.org/iconv-lite/-/iconv-lite-0.4.24.tgz",
      "integrity": "sha512-v3MXnZAcvnywkTUEZomIActle7RXXeedOR31wwl7VlyoXO4Qi9arvSenNQWne1TcRwhCL1HwLI21bEqdpj8/rA==",
      "license": "MIT",
      "dependencies": {
        "safer-buffer": ">= 2.1.2 < 3"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/inherits": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/inherits/-/inherits-2.0.4.tgz",
      "integrity": "sha512-k/vGaX4/Yla3WzyMCvTQOXYeIHvqOKtnqBduzTHpzpQZzAskKMhZ2K+EnBiSM9zGSoIFeMpXKxa4dYeZIQqewQ==",
      "license": "ISC"
    },
    "node_modules/input-otp": {
      "version": "1.4.2",
      "resolved": "https://registry.npmjs.org/input-otp/-/input-otp-1.4.2.tgz",
      "integrity": "sha512-l3jWwYNvrEa6NTCt7BECfCm48GvwuZzkoeG3gBL2w4CHeOXW3eKFmf9UNYkNfYc3mxMrthMnxjIE07MT0zLBQA==",
      "peerDependencies": {
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0.0 || ^19.0.0-rc"
      }
    },
    "node_modules/internal-slot": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/internal-slot/-/internal-slot-1.1.0.tgz",
      "integrity": "sha512-4gd7VpWNQNB4UKKCFFVcp1AVv+FMOgs9NKzjHKusc8jTMhd5eL1NqQqOpE0KzMds804/yHlglp3uxgluOqAPLw==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "hasown": "^2.0.2",
        "side-channel": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/internmap": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/internmap/-/internmap-2.0.3.tgz",
      "integrity": "sha512-5Hh7Y1wQbvY5ooGgPbDaL5iYLAPzMTUrjMulskHLH6wnv/A+1q5rgEaiuqEjB+oxGXIVZs1FF+R/KPN3ZSQYYg==",
      "license": "ISC",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/ipaddr.js": {
      "version": "1.9.1",
      "resolved": "https://registry.npmjs.org/ipaddr.js/-/ipaddr.js-1.9.1.tgz",
      "integrity": "sha512-0KI/607xoxSToH7GjN1FfSbLoU0+btTicjsQSWQlh/hZykN8KpmMf7uYwPW3R+akZ6R/w18ZlXSHBYXiYUPO3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/is-array-buffer": {
      "version": "3.0.5",
      "resolved": "https://registry.npmjs.org/is-array-buffer/-/is-array-buffer-3.0.5.tgz",
      "integrity": "sha512-DDfANUiiG2wC1qawP66qlTugJeL5HyzMpfr8lLK+jMQirGzNod0B12cFB/9q838Ru27sBwfw78/rdoU7RERz6A==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.3",
        "get-intrinsic": "^1.2.6"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-async-function": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/is-async-function/-/is-async-function-2.1.1.tgz",
      "integrity": "sha512-9dgM/cZBnNvjzaMYHVoxxfPj2QXt22Ev7SuuPrs+xav0ukGB0S6d4ydZdEiM48kLx5kDV+QBPrpVnFyefL8kkQ==",
      "license": "MIT",
      "dependencies": {
        "async-function": "^1.0.0",
        "call-bound": "^1.0.3",
        "get-proto": "^1.0.1",
        "has-tostringtag": "^1.0.2",
        "safe-regex-test": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-bigint": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/is-bigint/-/is-bigint-1.1.0.tgz",
      "integrity": "sha512-n4ZT37wG78iz03xPRKJrHTdZbe3IicyucEtdRsV5yglwc3GyUfbAfpSeD0FJ41NbUNSt5wbhqfp1fS+BgnvDFQ==",
      "license": "MIT",
      "dependencies": {
        "has-bigints": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-boolean-object": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/is-boolean-object/-/is-boolean-object-1.2.2.tgz",
      "integrity": "sha512-wa56o2/ElJMYqjCjGkXri7it5FbebW5usLw/nPmCMs5DeZ7eziSYZhSmPRn0txqeW4LnAmQQU7FgqLpsEFKM4A==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "has-tostringtag": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-callable": {
      "version": "1.2.7",
      "resolved": "https://registry.npmjs.org/is-callable/-/is-callable-1.2.7.tgz",
      "integrity": "sha512-1BC0BVFhS/p0qtw6enp8e+8OD0UrK0oFLztSjNzhcKA3WDuJxxAPXzPuPtKkjEY9UUoEWlX/8fgKeu2S8i9JTA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-data-view": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/is-data-view/-/is-data-view-1.0.2.tgz",
      "integrity": "sha512-RKtWF8pGmS87i2D6gqQu/l7EYRlVdfzemCJN/P3UOs//x1QE7mfhvzHIApBTRf7axvT6DMGwSwBXYCT0nfB9xw==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "get-intrinsic": "^1.2.6",
        "is-typed-array": "^1.1.13"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-date-object": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/is-date-object/-/is-date-object-1.1.0.tgz",
      "integrity": "sha512-PwwhEakHVKTdRNVOw+/Gyh0+MzlCl4R6qKvkhuvLtPMggI1WAHt9sOwZxQLSGpUaDnrdyDsomoRgNnCfKNSXXg==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "has-tostringtag": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-finalizationregistry": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/is-finalizationregistry/-/is-finalizationregistry-1.1.1.tgz",
      "integrity": "sha512-1pC6N8qWJbWoPtEjgcL2xyhQOP491EQjeUo3qTKcmV8YSDDJrOepfG8pcC7h/QgnQHYSv0mJ3Z/ZWxmatVrysg==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-generator-function": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/is-generator-function/-/is-generator-function-1.1.2.tgz",
      "integrity": "sha512-upqt1SkGkODW9tsGNG5mtXTXtECizwtS2kA161M+gJPc1xdb/Ax629af6YrTwcOeQHbewrPNlE5Dx7kzvXTizA==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.4",
        "generator-function": "^2.0.0",
        "get-proto": "^1.0.1",
        "has-tostringtag": "^1.0.2",
        "safe-regex-test": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-map": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/is-map/-/is-map-2.0.3.tgz",
      "integrity": "sha512-1Qed0/Hr2m+YqxnM09CjA2d/i6YZNfF6R2oRAOj36eUdS6qIV/huPJNSEpKbupewFs+ZsJlxsjjPbc0/afW6Lw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-negative-zero": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/is-negative-zero/-/is-negative-zero-2.0.3.tgz",
      "integrity": "sha512-5KoIu2Ngpyek75jXodFvnafB6DJgr3u8uuK0LEZJjrU19DrMD3EVERaR8sjz8CCGgpZvxPl9SuE1GMVPFHx1mw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-number-object": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/is-number-object/-/is-number-object-1.1.1.tgz",
      "integrity": "sha512-lZhclumE1G6VYD8VHe35wFaIif+CTy5SJIi5+3y4psDgWu4wPDoBhF8NxUOinEc7pHgiTsT6MaBb92rKhhD+Xw==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "has-tostringtag": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-regex": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/is-regex/-/is-regex-1.2.1.tgz",
      "integrity": "sha512-MjYsKHO5O7mCsmRGxWcLWheFqN9DJ/2TmngvjKXihe6efViPqc274+Fx/4fYj/r03+ESvBdTXK0V6tA3rgez1g==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "gopd": "^1.2.0",
        "has-tostringtag": "^1.0.2",
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-set": {
      "version": "2.0.3",
      "resolved": "https://registry.npmjs.org/is-set/-/is-set-2.0.3.tgz",
      "integrity": "sha512-iPAjerrse27/ygGLxw+EBR9agv9Y6uLeYVJMu+QNCoouJ1/1ri0mGrcWpfCqFZuzzx3WjtwxG098X+n4OuRkPg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-shared-array-buffer": {
      "version": "1.0.4",
      "resolved": "https://registry.npmjs.org/is-shared-array-buffer/-/is-shared-array-buffer-1.0.4.tgz",
      "integrity": "sha512-ISWac8drv4ZGfwKl5slpHG9OwPNty4jOWPRIhBpxOoD+hqITiwuipOQ2bNthAzwA3B4fIjO4Nln74N0S9byq8A==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-string": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/is-string/-/is-string-1.1.1.tgz",
      "integrity": "sha512-BtEeSsoaQjlSPBemMQIrY1MY0uM6vnS1g5fmufYOtnxLGUZM2178PKbhsk7Ffv58IX+ZtcvoGwccYsh0PglkAA==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "has-tostringtag": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-symbol": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/is-symbol/-/is-symbol-1.1.1.tgz",
      "integrity": "sha512-9gGx6GTtCQM73BgmHQXfDmLtfjjTUDSyoxTCbp5WtoixAhfgsDirWIcVQ/IHpvI5Vgd5i/J5F7B9cN/WlVbC/w==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "has-symbols": "^1.1.0",
        "safe-regex-test": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-typed-array": {
      "version": "1.1.15",
      "resolved": "https://registry.npmjs.org/is-typed-array/-/is-typed-array-1.1.15.tgz",
      "integrity": "sha512-p3EcsicXjit7SaskXHs1hA91QxgTw46Fv6EFKKGS5DRFLD8yKnohjF3hxoju94b/OcMZoQukzpPpBE9uLVKzgQ==",
      "license": "MIT",
      "dependencies": {
        "which-typed-array": "^1.1.16"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-typedarray": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/is-typedarray/-/is-typedarray-1.0.0.tgz",
      "integrity": "sha512-cyA56iCMHAh5CdzjJIa4aohJyeO1YbwLi3Jc35MmRU6poroFjIGZzUzupGiRPOjgHg9TLu43xbpwXk523fMxKA==",
      "license": "MIT"
    },
    "node_modules/is-weakmap": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/is-weakmap/-/is-weakmap-2.0.2.tgz",
      "integrity": "sha512-K5pXYOm9wqY1RgjpL3YTkF39tni1XajUIkawTLUo9EZEVUFga5gSQJF8nNS7ZwJQ02y+1YCNYcMh+HIf1ZqE+w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-weakref": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/is-weakref/-/is-weakref-1.1.1.tgz",
      "integrity": "sha512-6i9mGWSlqzNMEqpCp93KwRS1uUOodk2OJ6b+sq7ZPDSy2WuI5NFIxp/254TytR8ftefexkWn5xNiHUNpPOfSew==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-weakset": {
      "version": "2.0.4",
      "resolved": "https://registry.npmjs.org/is-weakset/-/is-weakset-2.0.4.tgz",
      "integrity": "sha512-mfcwb6IzQyOKTs84CQMrOwW4gQcaTOAWJ0zzJCl2WSPDrWk/OzDaImWFH3djXhb24g4eudZfLRozAvPGw4d9hQ==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "get-intrinsic": "^1.2.6"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/isarray": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/isarray/-/isarray-1.0.0.tgz",
      "integrity": "sha512-VLghIWNM6ELQzo7zwmcg0NmTVyWKYjvIeM83yjp0wRDTmUnrM678fQbcKBo6n2CJEF0szoG//ytg+TKla89ALQ==",
      "license": "MIT"
    },
    "node_modules/isstream": {
      "version": "0.1.2",
      "resolved": "https://registry.npmjs.org/isstream/-/isstream-0.1.2.tgz",
      "integrity": "sha512-Yljz7ffyPbrLpLngrMtZ7NduUgVvi6wG9RJ9IUcyCd59YQ911PBJphODUcbOVbqYfxe1wuYf/LJ8PauMRwsM/g==",
      "license": "MIT"
    },
    "node_modules/jiti": {
      "version": "2.6.1",
      "resolved": "https://registry.npmjs.org/jiti/-/jiti-2.6.1.tgz",
      "integrity": "sha512-ekilCSN1jwRvIbgeg/57YFh8qQDNbwDb9xT/qu2DAHbFFZUicIl4ygVaAvzveMhMVr3LnpSKTNnwt8PoOfmKhQ==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "jiti": "lib/jiti-cli.mjs"
      }
    },
    "node_modules/js-tokens": {
      "version": "4.0.0",
      "resolved": "https://registry.npmjs.org/js-tokens/-/js-tokens-4.0.0.tgz",
      "integrity": "sha512-RdJUflcE3cUzKiMqQgsCu06FPu9UdIJO0beYbPhHN4k6apgJtifcoCtT9bcxOpYBtpD2kCM6Sbzg4CausW/PKQ==",
      "license": "MIT"
    },
    "node_modules/jsbn": {
      "version": "0.1.1",
      "resolved": "https://registry.npmjs.org/jsbn/-/jsbn-0.1.1.tgz",
      "integrity": "sha512-UVU9dibq2JcFWxQPA6KCqj5O42VOmAY3zQUfEKxU0KpTGXwNoCjkX1e13eHNvw/xPynt6pU0rZ1htjWTNTSXsg==",
      "license": "MIT"
    },
    "node_modules/jsesc": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/jsesc/-/jsesc-3.0.2.tgz",
      "integrity": "sha512-xKqzzWXDttJuOcawBt4KnKHHIf5oQ/Cxax+0PWFG+DFDgHNAdi+TXECADI+RYiFUMmx8792xsMbbgXj4CwnP4g==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "jsesc": "bin/jsesc"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/json-schema": {
      "version": "0.4.0",
      "resolved": "https://registry.npmjs.org/json-schema/-/json-schema-0.4.0.tgz",
      "integrity": "sha512-es94M3nTIfsEPisRafak+HDLfHXnKBhV3vU5eqPcS3flIWqcxJWgXHXiey3YrpaNsanY5ei1VoYEbOzijuq9BA==",
      "license": "(AFL-2.1 OR BSD-3-Clause)"
    },
    "node_modules/json-schema-traverse": {
      "version": "0.4.1",
      "resolved": "https://registry.npmjs.org/json-schema-traverse/-/json-schema-traverse-0.4.1.tgz",
      "integrity": "sha512-xbbCH5dCYU5T8LcEhhuh7HJ88HXuW3qsI3Y0zOZFKfZEHcpWiHU/Jxzk629Brsab/mMiHQti9wMP+845RPe3Vg==",
      "license": "MIT",
      "peer": true
    },
    "node_modules/json-stringify-safe": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/json-stringify-safe/-/json-stringify-safe-5.0.1.tgz",
      "integrity": "sha512-ZClg6AaYvamvYEE82d3Iyd3vSSIjQ+odgjaTzRuO3s7toCdFKczob2i0zCh7JE8kWn17yvAWhUVxvqGwUalsRA==",
      "license": "ISC"
    },
    "node_modules/json5": {
      "version": "2.2.3",
      "resolved": "https://registry.npmjs.org/json5/-/json5-2.2.3.tgz",
      "integrity": "sha512-XmOWe7eyHYH14cLdVPoyg+GOH3rYX++KpzrylJwSW98t3Nk+U8XOl8FWKOgwtzdb8lXGf6zYwDUzeHMWfxasyg==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "json5": "lib/cli.js"
      },
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/jsprim": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/jsprim/-/jsprim-2.0.2.tgz",
      "integrity": "sha512-gqXddjPqQ6G40VdnI6T6yObEC+pDNvyP95wdQhkWkg7crHH3km5qP1FsOXEkzEQwnz6gz5qGTn1c2Y52wP3OyQ==",
      "engines": [
        "node >=0.6.0"
      ],
      "license": "MIT",
      "dependencies": {
        "assert-plus": "1.0.0",
        "extsprintf": "1.3.0",
        "json-schema": "0.4.0",
        "verror": "1.10.0"
      }
    },
    "node_modules/lightningcss": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss/-/lightningcss-1.30.2.tgz",
      "integrity": "sha512-utfs7Pr5uJyyvDETitgsaqSyjCb2qNRAtuqUeWIAKztsOYdcACf2KtARYXg2pSvhkt+9NfoaNY7fxjl6nuMjIQ==",
      "dev": true,
      "license": "MPL-2.0",
      "dependencies": {
        "detect-libc": "^2.0.3"
      },
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      },
      "optionalDependencies": {
        "lightningcss-android-arm64": "1.30.2",
        "lightningcss-darwin-arm64": "1.30.2",
        "lightningcss-darwin-x64": "1.30.2",
        "lightningcss-freebsd-x64": "1.30.2",
        "lightningcss-linux-arm-gnueabihf": "1.30.2",
        "lightningcss-linux-arm64-gnu": "1.30.2",
        "lightningcss-linux-arm64-musl": "1.30.2",
        "lightningcss-linux-x64-gnu": "1.30.2",
        "lightningcss-linux-x64-musl": "1.30.2",
        "lightningcss-win32-arm64-msvc": "1.30.2",
        "lightningcss-win32-x64-msvc": "1.30.2"
      }
    },
    "node_modules/lightningcss-android-arm64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-android-arm64/-/lightningcss-android-arm64-1.30.2.tgz",
      "integrity": "sha512-BH9sEdOCahSgmkVhBLeU7Hc9DWeZ1Eb6wNS6Da8igvUwAe0sqROHddIlvU06q3WyXVEOYDZ6ykBZQnjTbmo4+A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-darwin-arm64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-darwin-arm64/-/lightningcss-darwin-arm64-1.30.2.tgz",
      "integrity": "sha512-ylTcDJBN3Hp21TdhRT5zBOIi73P6/W0qwvlFEk22fkdXchtNTOU4Qc37SkzV+EKYxLouZ6M4LG9NfZ1qkhhBWA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-darwin-x64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-darwin-x64/-/lightningcss-darwin-x64-1.30.2.tgz",
      "integrity": "sha512-oBZgKchomuDYxr7ilwLcyms6BCyLn0z8J0+ZZmfpjwg9fRVZIR5/GMXd7r9RH94iDhld3UmSjBM6nXWM2TfZTQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-freebsd-x64": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-freebsd-x64/-/lightningcss-freebsd-x64-1.30.2.tgz",
      "integrity": "sha512-c2bH6xTrf4BDpK8MoGG4Bd6zAMZDAXS569UxCAGcA7IKbHNMlhGQ89eRmvpIUGfKWNVdbhSbkQaWhEoMGmGslA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-arm-gnueabihf": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-arm-gnueabihf/-/lightningcss-linux-arm-gnueabihf-1.30.2.tgz",
      "integrity": "sha512-eVdpxh4wYcm0PofJIZVuYuLiqBIakQ9uFZmipf6LF/HRj5Bgm0eb3qL/mr1smyXIS1twwOxNWndd8z0E374hiA==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-arm64-gnu": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-arm64-gnu/-/lightningcss-linux-arm64-gnu-1.30.2.tgz",
      "integrity": "sha512-UK65WJAbwIJbiBFXpxrbTNArtfuznvxAJw4Q2ZGlU8kPeDIWEX1dg3rn2veBVUylA2Ezg89ktszWbaQnxD/e3A==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-arm64-musl": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-arm64-musl/-/lightningcss-linux-arm64-musl-1.30.2.tgz",
      "integrity": "sha512-5Vh9dGeblpTxWHpOx8iauV02popZDsCYMPIgiuw97OJ5uaDsL86cnqSFs5LZkG3ghHoX5isLgWzMs+eD1YzrnA==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-x64-gnu": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-x64-gnu/-/lightningcss-linux-x64-gnu-1.30.2.tgz",
      "integrity": "sha512-Cfd46gdmj1vQ+lR6VRTTadNHu6ALuw2pKR9lYq4FnhvgBc4zWY1EtZcAc6EffShbb1MFrIPfLDXD6Xprbnni4w==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-linux-x64-musl": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-linux-x64-musl/-/lightningcss-linux-x64-musl-1.30.2.tgz",
      "integrity": "sha512-XJaLUUFXb6/QG2lGIW6aIk6jKdtjtcffUT0NKvIqhSBY3hh9Ch+1LCeH80dR9q9LBjG3ewbDjnumefsLsP6aiA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-win32-arm64-msvc": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-win32-arm64-msvc/-/lightningcss-win32-arm64-msvc-1.30.2.tgz",
      "integrity": "sha512-FZn+vaj7zLv//D/192WFFVA0RgHawIcHqLX9xuWiQt7P0PtdFEVaxgF9rjM/IRYHQXNnk61/H/gb2Ei+kUQ4xQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lightningcss-win32-x64-msvc": {
      "version": "1.30.2",
      "resolved": "https://registry.npmjs.org/lightningcss-win32-x64-msvc/-/lightningcss-win32-x64-msvc-1.30.2.tgz",
      "integrity": "sha512-5g1yc73p+iAkid5phb4oVFMB45417DkRevRbt/El/gKXJk4jid+vPFF/AXbxn05Aky8PapwzZrdJShv5C0avjw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MPL-2.0",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">= 12.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/parcel"
      }
    },
    "node_modules/lodash": {
      "version": "4.17.21",
      "resolved": "https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz",
      "integrity": "sha512-v2kDEe57lecTulaDIuNTPy3Ry4gLGJ6Z1O3vE1krgXZNrsQ+LFTGHVxVjcXPs17LhbZVGedAJv8XZ1tvj5FvSg==",
      "license": "MIT"
    },
    "node_modules/loose-envify": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/loose-envify/-/loose-envify-1.4.0.tgz",
      "integrity": "sha512-lyuxPGr/Wfhrlem2CL/UcnUc1zcqKAImBDzukY7Y5F/yQiNdko6+fRLevlw1HgMySw7f611UIY408EtxRSoK3Q==",
      "license": "MIT",
      "dependencies": {
        "js-tokens": "^3.0.0 || ^4.0.0"
      },
      "bin": {
        "loose-envify": "cli.js"
      }
    },
    "node_modules/lru-cache": {
      "version": "5.1.1",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-5.1.1.tgz",
      "integrity": "sha512-KpNARQA3Iwv+jTA0utUVVbrh+Jlrr1Fv0e56GGzAFOXN7dk/FviaDW8LHmK52DlcH4WP2n6gI8vN1aesBFgo9w==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "yallist": "^3.0.2"
      }
    },
    "node_modules/lucide-react": {
      "version": "0.545.0",
      "resolved": "https://registry.npmjs.org/lucide-react/-/lucide-react-0.545.0.tgz",
      "integrity": "sha512-7r1/yUuflQDSt4f1bpn5ZAocyIxcTyVyBBChSVtBKn5M+392cPmI5YJMWOJKk/HUWGm5wg83chlAZtCcGbEZtw==",
      "license": "ISC",
      "peerDependencies": {
        "react": "^16.5.1 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/magic-string": {
      "version": "0.30.21",
      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.21.tgz",
      "integrity": "sha512-vd2F4YUyEXKGcLHoq+TEyCjxueSeHnFxyyjNp80yg0XV4vUhnDer/lvvlqM/arB5bXQN5K2/3oinyCRyx8T2CQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.5"
      }
    },
    "node_modules/math-intrinsics": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
      "integrity": "sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/media-typer": {
      "version": "0.3.0",
      "resolved": "https://registry.npmjs.org/media-typer/-/media-typer-0.3.0.tgz",
      "integrity": "sha512-dq+qelQ9akHpcOl/gUVRTxVIOkAJ1wR3QAvb4RsVjS8oVoFjDGTc679wJYmUmknUF5HwMLOgb5O+a3KxfWapPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/memorystore": {
      "version": "1.6.7",
      "resolved": "https://registry.npmjs.org/memorystore/-/memorystore-1.6.7.tgz",
      "integrity": "sha512-OZnmNY/NDrKohPQ+hxp0muBcBKrzKNtHr55DbqSx9hLsYVNnomSAMRAtI7R64t3gf3ID7tHQA7mG4oL3Hu9hdw==",
      "license": "MIT",
      "dependencies": {
        "debug": "^4.3.0",
        "lru-cache": "^4.0.3"
      },
      "engines": {
        "node": ">=0.10"
      }
    },
    "node_modules/memorystore/node_modules/lru-cache": {
      "version": "4.1.5",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-4.1.5.tgz",
      "integrity": "sha512-sWZlbEP2OsHNkXrMl5GYk/jKk70MBng6UU4YI/qGDYbgf6YbP4EvmqISbXCoJiRKs+1bSpFHVgQxvJ17F2li5g==",
      "license": "ISC",
      "dependencies": {
        "pseudomap": "^1.0.2",
        "yallist": "^2.1.2"
      }
    },
    "node_modules/memorystore/node_modules/yallist": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/yallist/-/yallist-2.1.2.tgz",
      "integrity": "sha512-ncTzHV7NvsQZkYe1DW7cbDLm0YpzHmZF5r/iyP3ZnQtMiJ+pjzisCiMNI+Sj+xQF5pXhSHxSB3uDbsBTzY/c2A==",
      "license": "ISC"
    },
    "node_modules/merge-descriptors": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/merge-descriptors/-/merge-descriptors-1.0.3.tgz",
      "integrity": "sha512-gaNvAS7TZ897/rVaZ0nMtAyxNyi/pdbjbAwUpFQpN70GqnVfOiXpeUUMKRBmzXaSQ8DdTX4/0ms62r2K+hE6mQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/methods": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/methods/-/methods-1.1.2.tgz",
      "integrity": "sha512-iclAHeNqNm68zFtnZ0e+1L2yUIdvzNoauKU4WBA3VvH/vPFieF7qfRlwUZU+DA9P9bPXIS90ulxoUoCH23sV2w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/mime/-/mime-1.6.0.tgz",
      "integrity": "sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==",
      "license": "MIT",
      "bin": {
        "mime": "cli.js"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/mime-db": {
      "version": "1.52.0",
      "resolved": "https://registry.npmjs.org/mime-db/-/mime-db-1.52.0.tgz",
      "integrity": "sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime-types": {
      "version": "2.1.35",
      "resolved": "https://registry.npmjs.org/mime-types/-/mime-types-2.1.35.tgz",
      "integrity": "sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==",
      "license": "MIT",
      "dependencies": {
        "mime-db": "1.52.0"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mitt": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/mitt/-/mitt-3.0.1.tgz",
      "integrity": "sha512-vKivATfr97l2/QBCYAkXYDbrIWPM2IIKEl7YPhjCvKlG3kE2gm+uBo6nEXK3M5/Ffh/FLpKExzOQ3JJoJGFKBw==",
      "license": "MIT"
    },
    "node_modules/modern-screenshot": {
      "version": "4.6.0",
      "resolved": "https://registry.npmjs.org/modern-screenshot/-/modern-screenshot-4.6.0.tgz",
      "integrity": "sha512-L7osQAWpJiWY1ST1elhLRSGD5i7og5uoICqiXs38whAjWtIayp3cBMJmyML4iyJcBhRfHOyciq1g1Ft5G0QvSg==",
      "dev": true
    },
    "node_modules/motion-dom": {
      "version": "12.23.23",
      "resolved": "https://registry.npmjs.org/motion-dom/-/motion-dom-12.23.23.tgz",
      "integrity": "sha512-n5yolOs0TQQBRUFImrRfs/+6X4p3Q4n1dUEqt/H58Vx7OW6RF+foWEgmTVDhIWJIMXOuNNL0apKH2S16en9eiA==",
      "license": "MIT",
      "dependencies": {
        "motion-utils": "^12.23.6"
      }
    },
    "node_modules/motion-utils": {
      "version": "12.23.6",
      "resolved": "https://registry.npmjs.org/motion-utils/-/motion-utils-12.23.6.tgz",
      "integrity": "sha512-eAWoPgr4eFEOFfg2WjIsMoqJTW6Z8MTUCgn/GZ3VRpClWBdnbjryiA3ZSNLyxCTmCQx4RmYX6jX1iWHbenUPNQ==",
      "license": "MIT"
    },
    "node_modules/ms": {
      "version": "2.1.3",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.1.3.tgz",
      "integrity": "sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==",
      "license": "MIT"
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/negotiator": {
      "version": "0.6.3",
      "resolved": "https://registry.npmjs.org/negotiator/-/negotiator-0.6.3.tgz",
      "integrity": "sha512-+EUsqGPLsM+j/zdChZjsnX51g4XrHFOIXwfnCVPGlQk/k5giakcKsuxCObBRu6DSm9opw/O6slWbJdghQM4bBg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/next-themes": {
      "version": "0.4.6",
      "resolved": "https://registry.npmjs.org/next-themes/-/next-themes-0.4.6.tgz",
      "integrity": "sha512-pZvgD5L0IEvX5/9GWyHMf3m8BKiVQwsCMHfoFosXtXBMnaS0ZnIJ9ST4b4NqLVKDEm8QBxoNNGNaBv2JNF6XNA==",
      "peerDependencies": {
        "react": "^16.8 || ^17 || ^18 || ^19 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17 || ^18 || ^19 || ^19.0.0-rc"
      }
    },
    "node_modules/node-gyp-build": {
      "version": "4.8.3",
      "resolved": "https://registry.npmjs.org/node-gyp-build/-/node-gyp-build-4.8.3.tgz",
      "integrity": "sha512-EMS95CMJzdoSKoIiXo8pxKoL8DYxwIZXYlLmgPb8KUv794abpnLK6ynsCAWNliOjREKruYKdzbh76HHYUHX7nw==",
      "license": "MIT",
      "optional": true,
      "bin": {
        "node-gyp-build": "bin.js",
        "node-gyp-build-optional": "optional.js",
        "node-gyp-build-test": "build-test.js"
      }
    },
    "node_modules/node-kraken-api": {
      "version": "2.2.2",
      "resolved": "https://registry.npmjs.org/node-kraken-api/-/node-kraken-api-2.2.2.tgz",
      "integrity": "sha512-f+BZpgT1gD9705hlsRDDGj9m96Psb0Gxu3Td/P2fs0/gFy58YQONrTPiqfYzOBxvpmYnuAMxCRuRmdmkw04eRw==",
      "deprecated": "Package no longer supported. Contact Support at https://www.npmjs.com/support for more info.",
      "license": "MIT",
      "dependencies": {
        "crc": "^4.1.0",
        "ts-ev": "^0.4.0",
        "ws": "^8.5.0"
      },
      "engines": {
        "node": ">=10.0.0"
      },
      "optionalDependencies": {
        "bufferutil": "^4.0.6",
        "utf-8-validate": "^5.0.9"
      }
    },
    "node_modules/node-releases": {
      "version": "2.0.27",
      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.27.tgz",
      "integrity": "sha512-nmh3lCkYZ3grZvqcCH+fjmQ7X+H0OeZgP40OierEaAptX4XofMh5kwNbWh7lBduUzCcV/8kZ+NDLCwm2iorIlA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/node-telegram-bot-api": {
      "version": "0.66.0",
      "resolved": "https://registry.npmjs.org/node-telegram-bot-api/-/node-telegram-bot-api-0.66.0.tgz",
      "integrity": "sha512-s4Hrg5q+VPl4/tJVG++pImxF6eb8tNJNj4KnDqAOKL6zGU34lo9RXmyAN158njwGN+v8hdNf8s9fWIYW9hPb5A==",
      "license": "MIT",
      "dependencies": {
        "@cypress/request": "^3.0.1",
        "@cypress/request-promise": "^5.0.0",
        "array.prototype.findindex": "^2.0.2",
        "bl": "^1.2.3",
        "debug": "^3.2.7",
        "eventemitter3": "^3.0.0",
        "file-type": "^3.9.0",
        "mime": "^1.6.0",
        "pump": "^2.0.0"
      },
      "engines": {
        "node": ">=0.12"
      }
    },
    "node_modules/node-telegram-bot-api/node_modules/debug": {
      "version": "3.2.7",
      "resolved": "https://registry.npmjs.org/debug/-/debug-3.2.7.tgz",
      "integrity": "sha512-CFjzYYAi4ThfiQvizrFQevTTXHtnCqWfe7x1AhgEscTz6ZbLbfoLRLPugTQyBth6f8ZERVUSyWHFD/7Wu4t1XQ==",
      "license": "MIT",
      "dependencies": {
        "ms": "^2.1.1"
      }
    },
    "node_modules/node-telegram-bot-api/node_modules/eventemitter3": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/eventemitter3/-/eventemitter3-3.1.2.tgz",
      "integrity": "sha512-tvtQIeLVHjDkJYnzf2dgVMxfuSGJeM/7UCG17TT4EumTfNtF+0nebF/4zWOIkCreAbtNqhGEboB6BWrwqNaw4Q==",
      "license": "MIT"
    },
    "node_modules/normalize-range": {
      "version": "0.1.2",
      "resolved": "https://registry.npmjs.org/normalize-range/-/normalize-range-0.1.2.tgz",
      "integrity": "sha512-bdok/XvKII3nUpklnV6P2hxtMNrCboOjAcyBuQnWEhO665FwrSNRxU+AqpsyvO6LgGYPspN+lu5CLtw4jPRKNA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/oauth-sign": {
      "version": "0.9.0",
      "resolved": "https://registry.npmjs.org/oauth-sign/-/oauth-sign-0.9.0.tgz",
      "integrity": "sha512-fexhUFFPTGV8ybAtSIGbV6gOkSv8UtRbDBnAyLQw4QPKkgNlsH2ByPGtMUqdWkos6YCRmAqViwgZrJc/mRDzZQ==",
      "license": "Apache-2.0",
      "peer": true,
      "engines": {
        "node": "*"
      }
    },
    "node_modules/object-assign": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/object-assign/-/object-assign-4.1.1.tgz",
      "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-inspect": {
      "version": "1.13.4",
      "resolved": "https://registry.npmjs.org/object-inspect/-/object-inspect-1.13.4.tgz",
      "integrity": "sha512-W67iLl4J2EXEGTbfeHCffrjDfitvLANg0UlX3wFUUSTx92KXRFegMHUVgSqE+wvhAbi4WqjGg9czysTV2Epbew==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/object-keys": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/object-keys/-/object-keys-1.1.1.tgz",
      "integrity": "sha512-NuAESUOUMrlIXOfHKzD6bpPu3tYt3xvjNdRIQ+FeT0lNb4K8WR70CaDxhuNguS2XG+GjkyMwOzsN5ZktImfhLA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/object.assign": {
      "version": "4.1.7",
      "resolved": "https://registry.npmjs.org/object.assign/-/object.assign-4.1.7.tgz",
      "integrity": "sha512-nK28WOo+QIjBkDduTINE4JkF/UJJKyf2EJxvJKfblDpyg0Q+pkOHNTL0Qwy6NP6FhE/EnzV73BxxqcJaXY9anw==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.3",
        "define-properties": "^1.2.1",
        "es-object-atoms": "^1.0.0",
        "has-symbols": "^1.1.0",
        "object-keys": "^1.1.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/obuf": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/obuf/-/obuf-1.1.2.tgz",
      "integrity": "sha512-PX1wu0AmAdPqOL1mWhqmlOd8kOIZQwGZw6rh7uby9fTc5lhaOWFLX3I6R1hrF9k3zUY40e6igsLGkDXK92LJNg==",
      "devOptional": true,
      "license": "MIT"
    },
    "node_modules/on-finished": {
      "version": "2.4.1",
      "resolved": "https://registry.npmjs.org/on-finished/-/on-finished-2.4.1.tgz",
      "integrity": "sha512-oVlzkg3ENAhCk2zdv7IJwd/QUD4z2RxRwpkcGY8psCVcCYZNq4wYnVWALHM+brtuJjePWiYF/ClmuDr8Ch5+kg==",
      "license": "MIT",
      "dependencies": {
        "ee-first": "1.1.1"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/on-headers": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/on-headers/-/on-headers-1.0.2.tgz",
      "integrity": "sha512-pZAE+FJLoyITytdqK0U5s+FIpjN0JP3OzFi/u8Rx+EV5/W+JTWGXG8xFzevE7AjBfDqHv/8vL8qQsIhHnqRkrA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/once": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/once/-/once-1.4.0.tgz",
      "integrity": "sha512-lNaJgI+2Q5URQBkccEKHTQOPaXdUxnZZElQTZY0MFUAuaEqe1E+Nyvgdz/aIyNi6Z9MzO5dv1H8n58/GELp3+w==",
      "license": "ISC",
      "dependencies": {
        "wrappy": "1"
      }
    },
    "node_modules/own-keys": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/own-keys/-/own-keys-1.0.1.tgz",
      "integrity": "sha512-qFOyK5PjiWZd+QQIh+1jhdb9LpxTF0qs7Pm8o5QHYZ0M3vKqSqzsZaEB6oWlxZ+q2sJBMI/Ktgd2N5ZwQoRHfg==",
      "license": "MIT",
      "dependencies": {
        "get-intrinsic": "^1.2.6",
        "object-keys": "^1.1.1",
        "safe-push-apply": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/parseurl": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/parseurl/-/parseurl-1.3.3.tgz",
      "integrity": "sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/passport": {
      "version": "0.7.0",
      "resolved": "https://registry.npmjs.org/passport/-/passport-0.7.0.tgz",
      "integrity": "sha512-cPLl+qZpSc+ireUvt+IzqbED1cHHkDoVYMo30jbJIdOOjQ1MQYZBPiNvmi8UM6lJuOpTPXJGZQk0DtC4y61MYQ==",
      "license": "MIT",
      "dependencies": {
        "passport-strategy": "1.x.x",
        "pause": "0.0.1",
        "utils-merge": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4.0"
      },
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/jaredhanson"
      }
    },
    "node_modules/passport-local": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/passport-local/-/passport-local-1.0.0.tgz",
      "integrity": "sha512-9wCE6qKznvf9mQYYbgJ3sVOHmCWoUNMVFoZzNoznmISbhnNNPhN9xfY3sLmScHMetEJeoY7CXwfhCe7argfQow==",
      "dependencies": {
        "passport-strategy": "1.x.x"
      },
      "engines": {
        "node": ">= 0.4.0"
      }
    },
    "node_modules/passport-strategy": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/passport-strategy/-/passport-strategy-1.0.0.tgz",
      "integrity": "sha512-CB97UUvDKJde2V0KDWWB3lyf6PC3FaZP7YxZ2G8OAtn9p4HI9j9JLP9qjOGZFvyl8uwNT8qM+hGnz/n16NI7oA==",
      "engines": {
        "node": ">= 0.4.0"
      }
    },
    "node_modules/path-to-regexp": {
      "version": "0.1.12",
      "resolved": "https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.12.tgz",
      "integrity": "sha512-RA1GjUVMnvYFxuqovrEqZoxxW5NUZqbwKtYz/Tt7nXerk0LbLblQmrsgdeOxV5SFHf0UDggjS/bSeOZwt1pmEQ==",
      "license": "MIT"
    },
    "node_modules/pause": {
      "version": "0.0.1",
      "resolved": "https://registry.npmjs.org/pause/-/pause-0.0.1.tgz",
      "integrity": "sha512-KG8UEiEVkR3wGEb4m5yZkVCzigAD+cVEJck2CzYZO37ZGJfctvVptVO192MwrtPhzONn6go8ylnOdMhKqi4nfg=="
    },
    "node_modules/performance-now": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/performance-now/-/performance-now-2.1.0.tgz",
      "integrity": "sha512-7EAHlyLHI56VEIdK57uwHdHKIaAGbnXPiw0yWbarQZOKaKpvUIgW0jWRVLiatnM+XXlSwsanIBH/hzGMJulMow==",
      "license": "MIT"
    },
    "node_modules/pg": {
      "version": "8.16.3",
      "resolved": "https://registry.npmjs.org/pg/-/pg-8.16.3.tgz",
      "integrity": "sha512-enxc1h0jA/aq5oSDMvqyW3q89ra6XIIDZgCX9vkMrnz5DFTw/Ny3Li2lFQ+pt3L6MCgm/5o2o8HW9hiJji+xvw==",
      "license": "MIT",
      "dependencies": {
        "pg-connection-string": "^2.9.1",
        "pg-pool": "^3.10.1",
        "pg-protocol": "^1.10.3",
        "pg-types": "2.2.0",
        "pgpass": "1.0.5"
      },
      "engines": {
        "node": ">= 16.0.0"
      },
      "optionalDependencies": {
        "pg-cloudflare": "^1.2.7"
      },
      "peerDependencies": {
        "pg-native": ">=3.0.1"
      },
      "peerDependenciesMeta": {
        "pg-native": {
          "optional": true
        }
      }
    },
    "node_modules/pg-cloudflare": {
      "version": "1.2.7",
      "resolved": "https://registry.npmjs.org/pg-cloudflare/-/pg-cloudflare-1.2.7.tgz",
      "integrity": "sha512-YgCtzMH0ptvZJslLM1ffsY4EuGaU0cx4XSdXLRFae8bPP4dS5xL1tNB3k2o/N64cHJpwU7dxKli/nZ2lUa5fLg==",
      "license": "MIT",
      "optional": true
    },
    "node_modules/pg-connection-string": {
      "version": "2.9.1",
      "resolved": "https://registry.npmjs.org/pg-connection-string/-/pg-connection-string-2.9.1.tgz",
      "integrity": "sha512-nkc6NpDcvPVpZXxrreI/FOtX3XemeLl8E0qFr6F2Lrm/I8WOnaWNhIPK2Z7OHpw7gh5XJThi6j6ppgNoaT1w4w==",
      "license": "MIT"
    },
    "node_modules/pg-int8": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/pg-int8/-/pg-int8-1.0.1.tgz",
      "integrity": "sha512-WCtabS6t3c8SkpDBUlb1kjOs7l66xsGdKpIPZsg4wR+B3+u9UAum2odSsF9tnvxg80h4ZxLWMy4pRjOsFIqQpw==",
      "license": "ISC",
      "engines": {
        "node": ">=4.0.0"
      }
    },
    "node_modules/pg-numeric": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/pg-numeric/-/pg-numeric-1.0.2.tgz",
      "integrity": "sha512-BM/Thnrw5jm2kKLE5uJkXqqExRUY/toLHda65XgFTBTFYZyopbKjBe29Ii3RbkvlsMoFwD+tHeGaCjjv0gHlyw==",
      "devOptional": true,
      "license": "ISC",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/pg-pool": {
      "version": "3.10.1",
      "resolved": "https://registry.npmjs.org/pg-pool/-/pg-pool-3.10.1.tgz",
      "integrity": "sha512-Tu8jMlcX+9d8+QVzKIvM/uJtp07PKr82IUOYEphaWcoBhIYkoHpLXN3qO59nAI11ripznDsEzEv8nUxBVWajGg==",
      "license": "MIT",
      "peerDependencies": {
        "pg": ">=8.0"
      }
    },
    "node_modules/pg-protocol": {
      "version": "1.10.3",
      "resolved": "https://registry.npmjs.org/pg-protocol/-/pg-protocol-1.10.3.tgz",
      "integrity": "sha512-6DIBgBQaTKDJyxnXaLiLR8wBpQQcGWuAESkRBX/t6OwA8YsqP+iVSiond2EDy6Y/dsGk8rh/jtax3js5NeV7JQ==",
      "license": "MIT"
    },
    "node_modules/pg-types": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/pg-types/-/pg-types-4.0.2.tgz",
      "integrity": "sha512-cRL3JpS3lKMGsKaWndugWQoLOCoP+Cic8oseVcbr0qhPzYD5DWXK+RZ9LY9wxRf7RQia4SCwQlXk0q6FCPrVng==",
      "devOptional": true,
      "license": "MIT",
      "dependencies": {
        "pg-int8": "1.0.1",
        "pg-numeric": "1.0.2",
        "postgres-array": "~3.0.1",
        "postgres-bytea": "~3.0.0",
        "postgres-date": "~2.1.0",
        "postgres-interval": "^3.0.0",
        "postgres-range": "^1.1.1"
      },
      "engines": {
        "node": ">=10"
      }
    },
    "node_modules/pg/node_modules/pg-types": {
      "version": "2.2.0",
      "resolved": "https://registry.npmjs.org/pg-types/-/pg-types-2.2.0.tgz",
      "integrity": "sha512-qTAAlrEsl8s4OiEQY69wDvcMIdQN6wdz5ojQiOy6YRMuynxenON0O5oCpJI6lshc6scgAY8qvJ2On/p+CXY0GA==",
      "license": "MIT",
      "dependencies": {
        "pg-int8": "1.0.1",
        "postgres-array": "~2.0.0",
        "postgres-bytea": "~1.0.0",
        "postgres-date": "~1.0.4",
        "postgres-interval": "^1.1.0"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/pg/node_modules/postgres-array": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/postgres-array/-/postgres-array-2.0.0.tgz",
      "integrity": "sha512-VpZrUqU5A69eQyW2c5CA1jtLecCsN2U/bD6VilrFDWq5+5UIEVO7nazS3TEcHf1zuPYO/sqGvUvW62g86RXZuA==",
      "license": "MIT",
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/pg/node_modules/postgres-bytea": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/postgres-bytea/-/postgres-bytea-1.0.0.tgz",
      "integrity": "sha512-xy3pmLuQqRBZBXDULy7KbaitYqLcmxigw14Q5sj8QBVLqEwXfeybIKVWiqAXTlcvdvb0+xkOtDbfQMOf4lST1w==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/pg/node_modules/postgres-date": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/postgres-date/-/postgres-date-1.0.7.tgz",
      "integrity": "sha512-suDmjLVQg78nMK2UZ454hAG+OAW+HQPZ6n++TNDUX+L0+uUlLywnoxJKDou51Zm+zTCjrCl0Nq6J9C5hP9vK/Q==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/pg/node_modules/postgres-interval": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/postgres-interval/-/postgres-interval-1.2.0.tgz",
      "integrity": "sha512-9ZhXKM/rw350N1ovuWHbGxnGh/SNJ4cnxHiM0rxE4VN41wsg8P8zWn9hv/buK00RP4WvlOyr/RBDiptyxVbkZQ==",
      "license": "MIT",
      "dependencies": {
        "xtend": "^4.0.0"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/pgpass": {
      "version": "1.0.5",
      "resolved": "https://registry.npmjs.org/pgpass/-/pgpass-1.0.5.tgz",
      "integrity": "sha512-FdW9r/jQZhSeohs1Z3sI1yxFQNFvMcnmfuj4WBMUTxOrAyLMaTcE1aAMBiTlbMNaXvBCQuVi0R7hd8udDSP7ug==",
      "license": "MIT",
      "dependencies": {
        "split2": "^4.1.0"
      }
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/picomatch": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
      "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/possible-typed-array-names": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/possible-typed-array-names/-/possible-typed-array-names-1.1.0.tgz",
      "integrity": "sha512-/+5VFTchJDoVj3bhoqi6UeymcD00DAwb1nJwamzPvHEszJ4FpF6SNNbUbOS8yI56qHzdV8eK0qEfOSiodkTdxg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/postcss-value-parser": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/postcss-value-parser/-/postcss-value-parser-4.2.0.tgz",
      "integrity": "sha512-1NNCs6uurfkVbeXG4S8JFT9t19m45ICnif8zWLd5oPSZ50QnwMfK+H3jv408d4jw/7Bttv5axS5IiHoLaVNHeQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/postgres-array": {
      "version": "3.0.2",
      "resolved": "https://registry.npmjs.org/postgres-array/-/postgres-array-3.0.2.tgz",
      "integrity": "sha512-6faShkdFugNQCLwucjPcY5ARoW1SlbnrZjmGl0IrrqewpvxvhSLHimCVzqeuULCbG0fQv7Dtk1yDbG3xv7Veog==",
      "devOptional": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/postgres-bytea": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/postgres-bytea/-/postgres-bytea-3.0.0.tgz",
      "integrity": "sha512-CNd4jim9RFPkObHSjVHlVrxoVQXz7quwNFpz7RY1okNNme49+sVyiTvTRobiLV548Hx/hb1BG+iE7h9493WzFw==",
      "devOptional": true,
      "license": "MIT",
      "dependencies": {
        "obuf": "~1.1.2"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/postgres-date": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/postgres-date/-/postgres-date-2.1.0.tgz",
      "integrity": "sha512-K7Juri8gtgXVcDfZttFKVmhglp7epKb1K4pgrkLxehjqkrgPhfG6OO8LHLkfaqkbpjNRnra018XwAr1yQFWGcA==",
      "devOptional": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/postgres-interval": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/postgres-interval/-/postgres-interval-3.0.0.tgz",
      "integrity": "sha512-BSNDnbyZCXSxgA+1f5UU2GmwhoI0aU5yMxRGO8CdFEcY2BQF9xm/7MqKnYoM1nJDk8nONNWDk9WeSmePFhQdlw==",
      "devOptional": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/postgres-range": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/postgres-range/-/postgres-range-1.1.4.tgz",
      "integrity": "sha512-i/hbxIE9803Alj/6ytL7UHQxRvZkI9O4Sy+J3HGc4F4oo/2eQAjTSNJ0bfxyse3bH0nuVesCk+3IRLaMtG3H6w==",
      "devOptional": true,
      "license": "MIT"
    },
    "node_modules/process-nextick-args": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/process-nextick-args/-/process-nextick-args-2.0.1.tgz",
      "integrity": "sha512-3ouUOpQhtgrbOa17J7+uxOTpITYWaGP7/AhoR3+A+/1e9skrzelGi/dXzEYyvbxubEF6Wn2ypscTKiKJFFn1ag==",
      "license": "MIT"
    },
    "node_modules/prop-types": {
      "version": "15.8.1",
      "resolved": "https://registry.npmjs.org/prop-types/-/prop-types-15.8.1.tgz",
      "integrity": "sha512-oj87CgZICdulUohogVAR7AjlC0327U4el4L6eAvOqCeudMDVU0NThNaV+b9Df4dXgSP1gXMTnPdhfe/2qDH5cg==",
      "license": "MIT",
      "dependencies": {
        "loose-envify": "^1.4.0",
        "object-assign": "^4.1.1",
        "react-is": "^16.13.1"
      }
    },
    "node_modules/prop-types/node_modules/react-is": {
      "version": "16.13.1",
      "resolved": "https://registry.npmjs.org/react-is/-/react-is-16.13.1.tgz",
      "integrity": "sha512-24e6ynE2H+OKt4kqsOvNd8kBpV65zoxbA4BVsEOB3ARVWQki/DHzaUoC5KuON/BiccDaCCTZBuOcfZs70kR8bQ==",
      "license": "MIT"
    },
    "node_modules/proxy-addr": {
      "version": "2.0.7",
      "resolved": "https://registry.npmjs.org/proxy-addr/-/proxy-addr-2.0.7.tgz",
      "integrity": "sha512-llQsMLSUDUPT44jdrU/O37qlnifitDP+ZwrmmZcoSKyLKvtZxpyV0n2/bD/N4tBAAZ/gJEdZU7KMraoK1+XYAg==",
      "license": "MIT",
      "dependencies": {
        "forwarded": "0.2.0",
        "ipaddr.js": "1.9.1"
      },
      "engines": {
        "node": ">= 0.10"
      }
    },
    "node_modules/pseudomap": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/pseudomap/-/pseudomap-1.0.2.tgz",
      "integrity": "sha512-b/YwNhb8lk1Zz2+bXXpS/LK9OisiZZ1SNsSLxN1x2OXVEhW2Ckr/7mWE5vrC1ZTiJlD9g19jWszTmJsB+oEpFQ==",
      "license": "ISC"
    },
    "node_modules/psl": {
      "version": "1.15.0",
      "resolved": "https://registry.npmjs.org/psl/-/psl-1.15.0.tgz",
      "integrity": "sha512-JZd3gMVBAVQkSs6HdNZo9Sdo0LNcQeMNP3CozBJb3JYC/QUYZTnKxP+f8oWRX4rHP5EurWxqAHTSwUCjlNKa1w==",
      "license": "MIT",
      "dependencies": {
        "punycode": "^2.3.1"
      },
      "funding": {
        "url": "https://github.com/sponsors/lupomontero"
      }
    },
    "node_modules/pump": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/pump/-/pump-2.0.1.tgz",
      "integrity": "sha512-ruPMNRkN3MHP1cWJc9OWr+T/xDP0jhXYCLfJcBuX54hhfIBnaQmAUMfDcG4DM5UMWByBbJY69QSphm3jtDKIkA==",
      "license": "MIT",
      "dependencies": {
        "end-of-stream": "^1.1.0",
        "once": "^1.3.1"
      }
    },
    "node_modules/punycode": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/punycode/-/punycode-2.3.1.tgz",
      "integrity": "sha512-vYt7UD1U9Wg6138shLtLOvdAu+8DsC/ilFtEVHcH+wydcSpNE20AfSOduf6MkRFahL5FY7X1oU7nKVZFtfq8Fg==",
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/qs": {
      "version": "6.13.0",
      "resolved": "https://registry.npmjs.org/qs/-/qs-6.13.0.tgz",
      "integrity": "sha512-+38qI9SOr8tfZ4QmJNplMUxqjbe7LKvvZgWdExBOmd+egZTtjLB67Gu0HRX3u/XOq7UU2Nx6nsjvS16Z9uwfpg==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "side-channel": "^1.0.6"
      },
      "engines": {
        "node": ">=0.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/querystringify": {
      "version": "2.2.0",
      "resolved": "https://registry.npmjs.org/querystringify/-/querystringify-2.2.0.tgz",
      "integrity": "sha512-FIqgj2EUvTa7R50u0rGsyTftzjYmv/a3hO345bZNrqabNqjtgiDMgmo4mkUjd+nzU5oF3dClKqFIPUKybUyqoQ==",
      "license": "MIT"
    },
    "node_modules/random-bytes": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/random-bytes/-/random-bytes-1.0.0.tgz",
      "integrity": "sha512-iv7LhNVO047HzYR3InF6pUcUsPQiHTM1Qal51DcGSuZFBil1aBBWG5eHPNek7bvILMaYJ/8RU1e8w1AMdHmLQQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/range-parser": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/range-parser/-/range-parser-1.2.1.tgz",
      "integrity": "sha512-Hrgsx+orqoygnmhFbKaHE6c296J+HTAQXoxEF6gNupROmmGJRoyzfG3ccAveqCBrwr/2yxQ5BVd/GTl5agOwSg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/raw-body": {
      "version": "2.5.2",
      "resolved": "https://registry.npmjs.org/raw-body/-/raw-body-2.5.2.tgz",
      "integrity": "sha512-8zGqypfENjCIqGhgXToC8aB2r7YrBX+AQAfIPs/Mlk+BtPTztOvTS01NRW/3Eh60J+a48lt8qsCzirQ6loCVfA==",
      "license": "MIT",
      "dependencies": {
        "bytes": "3.1.2",
        "http-errors": "2.0.0",
        "iconv-lite": "0.4.24",
        "unpipe": "1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/react": {
      "version": "19.2.0",
      "resolved": "https://registry.npmjs.org/react/-/react-19.2.0.tgz",
      "integrity": "sha512-tmbWg6W31tQLeB5cdIBOicJDJRR2KzXsV7uSK9iNfLWQ5bIZfxuPEHp7M8wiHyHnn0DD1i7w3Zmin0FtkrwoCQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-day-picker": {
      "version": "9.11.1",
      "resolved": "https://registry.npmjs.org/react-day-picker/-/react-day-picker-9.11.1.tgz",
      "integrity": "sha512-l3ub6o8NlchqIjPKrRFUCkTUEq6KwemQlfv3XZzzwpUeGwmDJ+0u0Upmt38hJyd7D/vn2dQoOoLV/qAp0o3uUw==",
      "license": "MIT",
      "dependencies": {
        "@date-fns/tz": "^1.4.1",
        "date-fns": "^4.1.0",
        "date-fns-jalali": "^4.1.0-0"
      },
      "engines": {
        "node": ">=18"
      },
      "funding": {
        "type": "individual",
        "url": "https://github.com/sponsors/gpbl"
      },
      "peerDependencies": {
        "react": ">=16.8.0"
      }
    },
    "node_modules/react-day-picker/node_modules/date-fns": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/date-fns/-/date-fns-4.1.0.tgz",
      "integrity": "sha512-Ukq0owbQXxa/U3EGtsdVBkR1w7KOQ5gIBqdH2hkvknzZPYvBxb/aa6E8L7tmjFtkwZBu3UXBbjIgPo/Ez4xaNg==",
      "license": "MIT",
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/kossnocorp"
      }
    },
    "node_modules/react-dom": {
      "version": "19.2.0",
      "resolved": "https://registry.npmjs.org/react-dom/-/react-dom-19.2.0.tgz",
      "integrity": "sha512-UlbRu4cAiGaIewkPyiRGJk0imDN2T3JjieT6spoL2UeSf5od4n5LB/mQ4ejmxhCFT1tYe8IvaFulzynWovsEFQ==",
      "license": "MIT",
      "dependencies": {
        "scheduler": "^0.27.0"
      },
      "peerDependencies": {
        "react": "^19.2.0"
      }
    },
    "node_modules/react-hook-form": {
      "version": "7.66.0",
      "resolved": "https://registry.npmjs.org/react-hook-form/-/react-hook-form-7.66.0.tgz",
      "integrity": "sha512-xXBqsWGKrY46ZqaHDo+ZUYiMUgi8suYu5kdrS20EG8KiL7VRQitEbNjm+UcrDYrNi1YLyfpmAeGjCZYXLT9YBw==",
      "license": "MIT",
      "engines": {
        "node": ">=18.0.0"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/react-hook-form"
      },
      "peerDependencies": {
        "react": "^16.8.0 || ^17 || ^18 || ^19"
      }
    },
    "node_modules/react-is": {
      "version": "18.3.1",
      "resolved": "https://registry.npmjs.org/react-is/-/react-is-18.3.1.tgz",
      "integrity": "sha512-/LLMVyas0ljjAtoYiPqYiL8VWXzUUdThrmU5+n20DZv+a+ClRoevUzw5JxU+Ieh5/c87ytoTBV9G1FiKfNJdmg==",
      "license": "MIT"
    },
    "node_modules/react-refresh": {
      "version": "0.18.0",
      "resolved": "https://registry.npmjs.org/react-refresh/-/react-refresh-0.18.0.tgz",
      "integrity": "sha512-QgT5//D3jfjJb6Gsjxv0Slpj23ip+HtOpnNgnb2S5zU3CB26G/IDPGoy4RJB42wzFE46DRsstbW6tKHoKbhAxw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/react-remove-scroll": {
      "version": "2.6.3",
      "resolved": "https://registry.npmjs.org/react-remove-scroll/-/react-remove-scroll-2.6.3.tgz",
      "integrity": "sha512-pnAi91oOk8g8ABQKGF5/M9qxmmOPxaAnopyTHYfqYEwJhyFrbbBtHuSgtKEoH0jpcxx5o3hXqH1mNd9/Oi+8iQ==",
      "dependencies": {
        "react-remove-scroll-bar": "^2.3.7",
        "react-style-singleton": "^2.2.3",
        "tslib": "^2.1.0",
        "use-callback-ref": "^1.3.3",
        "use-sidecar": "^1.1.3"
      },
      "engines": {
        "node": ">=10"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/react-remove-scroll-bar": {
      "version": "2.3.8",
      "resolved": "https://registry.npmjs.org/react-remove-scroll-bar/-/react-remove-scroll-bar-2.3.8.tgz",
      "integrity": "sha512-9r+yi9+mgU33AKcj6IbT9oRCO78WriSj6t/cF8DWBZJ9aOGPOTEDvdUDz1FwKim7QXWwmHqtdHnRJfhAxEG46Q==",
      "dependencies": {
        "react-style-singleton": "^2.2.2",
        "tslib": "^2.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/react-resizable-panels": {
      "version": "2.1.9",
      "resolved": "https://registry.npmjs.org/react-resizable-panels/-/react-resizable-panels-2.1.9.tgz",
      "integrity": "sha512-z77+X08YDIrgAes4jl8xhnUu1LNIRp4+E7cv4xHmLOxxUPO/ML7PSrE813b90vj7xvQ1lcf7g2uA9GeMZonjhQ==",
      "license": "MIT",
      "peerDependencies": {
        "react": "^16.14.0 || ^17.0.0 || ^18.0.0 || ^19.0.0 || ^19.0.0-rc",
        "react-dom": "^16.14.0 || ^17.0.0 || ^18.0.0 || ^19.0.0 || ^19.0.0-rc"
      }
    },
    "node_modules/react-smooth": {
      "version": "4.0.4",
      "resolved": "https://registry.npmjs.org/react-smooth/-/react-smooth-4.0.4.tgz",
      "integrity": "sha512-gnGKTpYwqL0Iii09gHobNolvX4Kiq4PKx6eWBCYYix+8cdw+cGo3do906l1NBPKkSWx1DghC1dlWG9L2uGd61Q==",
      "license": "MIT",
      "dependencies": {
        "fast-equals": "^5.0.1",
        "prop-types": "^15.8.1",
        "react-transition-group": "^4.4.5"
      },
      "peerDependencies": {
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0",
        "react-dom": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/react-style-singleton": {
      "version": "2.2.3",
      "resolved": "https://registry.npmjs.org/react-style-singleton/-/react-style-singleton-2.2.3.tgz",
      "integrity": "sha512-b6jSvxvVnyptAiLjbkWLE/lOnR4lfTtDAl+eUC7RZy+QQWc6wRzIV2CE6xBuMmDxc2qIihtDCZD5NPOFl7fRBQ==",
      "dependencies": {
        "get-nonce": "^1.0.0",
        "tslib": "^2.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/react-transition-group": {
      "version": "4.4.5",
      "resolved": "https://registry.npmjs.org/react-transition-group/-/react-transition-group-4.4.5.tgz",
      "integrity": "sha512-pZcd1MCJoiKiBR2NRxeCRg13uCXbydPnmB4EOeRrY7480qNWO8IIgQG6zlDkm6uRMsURXPuKq0GWtiM59a5Q6g==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "@babel/runtime": "^7.5.5",
        "dom-helpers": "^5.0.1",
        "loose-envify": "^1.4.0",
        "prop-types": "^15.6.2"
      },
      "peerDependencies": {
        "react": ">=16.6.0",
        "react-dom": ">=16.6.0"
      }
    },
    "node_modules/readable-stream": {
      "version": "2.3.8",
      "resolved": "https://registry.npmjs.org/readable-stream/-/readable-stream-2.3.8.tgz",
      "integrity": "sha512-8p0AUk4XODgIewSi0l8Epjs+EVnWiK7NoDIEGU0HhE7+ZyY8D1IMY7odu5lRrFXGg71L15KG8QrPmum45RTtdA==",
      "license": "MIT",
      "dependencies": {
        "core-util-is": "~1.0.0",
        "inherits": "~2.0.3",
        "isarray": "~1.0.0",
        "process-nextick-args": "~2.0.0",
        "safe-buffer": "~5.1.1",
        "string_decoder": "~1.1.1",
        "util-deprecate": "~1.0.1"
      }
    },
    "node_modules/readable-stream/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/recharts": {
      "version": "2.15.4",
      "resolved": "https://registry.npmjs.org/recharts/-/recharts-2.15.4.tgz",
      "integrity": "sha512-UT/q6fwS3c1dHbXv2uFgYJ9BMFHu3fwnd7AYZaEQhXuYQ4hgsxLvsUXzGdKeZrW5xopzDCvuA2N41WJ88I7zIw==",
      "license": "MIT",
      "dependencies": {
        "clsx": "^2.0.0",
        "eventemitter3": "^4.0.1",
        "lodash": "^4.17.21",
        "react-is": "^18.3.1",
        "react-smooth": "^4.0.4",
        "recharts-scale": "^0.4.4",
        "tiny-invariant": "^1.3.1",
        "victory-vendor": "^36.6.8"
      },
      "engines": {
        "node": ">=14"
      },
      "peerDependencies": {
        "react": "^16.0.0 || ^17.0.0 || ^18.0.0 || ^19.0.0",
        "react-dom": "^16.0.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/recharts-scale": {
      "version": "0.4.5",
      "resolved": "https://registry.npmjs.org/recharts-scale/-/recharts-scale-0.4.5.tgz",
      "integrity": "sha512-kivNFO+0OcUNu7jQquLXAxz1FIwZj8nrj+YkOKc5694NbjCvcT6aSZiIzNzd2Kul4o4rTto8QVR9lMNtxD4G1w==",
      "license": "MIT",
      "dependencies": {
        "decimal.js-light": "^2.4.1"
      }
    },
    "node_modules/reflect.getprototypeof": {
      "version": "1.0.10",
      "resolved": "https://registry.npmjs.org/reflect.getprototypeof/-/reflect.getprototypeof-1.0.10.tgz",
      "integrity": "sha512-00o4I+DVrefhv+nX0ulyi3biSHCPDe+yLv5o/p6d/UVlirijB8E16FtfwSAi4g3tcqrQ4lRAqQSoFEZJehYEcw==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "define-properties": "^1.2.1",
        "es-abstract": "^1.23.9",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.0.0",
        "get-intrinsic": "^1.2.7",
        "get-proto": "^1.0.1",
        "which-builtin-type": "^1.2.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/regexp.prototype.flags": {
      "version": "1.5.4",
      "resolved": "https://registry.npmjs.org/regexp.prototype.flags/-/regexp.prototype.flags-1.5.4.tgz",
      "integrity": "sha512-dYqgNSZbDwkaJ2ceRd9ojCGjBq+mOm9LmtXnAnEGyHhN/5R7iDW2TRw3h+o/jCFxus3P2LfWIIiwowAjANm7IA==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "define-properties": "^1.2.1",
        "es-errors": "^1.3.0",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "set-function-name": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/regexparam": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/regexparam/-/regexparam-3.0.0.tgz",
      "integrity": "sha512-RSYAtP31mvYLkAHrOlh25pCNQ5hWnT106VukGaaFfuJrZFkGRX5GhUAdPqpSDXxOhA2c4akmRuplv1mRqnBn6Q==",
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/request": {
      "version": "2.88.2",
      "resolved": "https://registry.npmjs.org/request/-/request-2.88.2.tgz",
      "integrity": "sha512-MsvtOrfG9ZcrOwAW+Qi+F6HbD0CWXEh9ou77uOb7FM2WPhwT7smM833PzanhJLsgXjN89Ir6V2PczXNnMpwKhw==",
      "deprecated": "request has been deprecated, see https://github.com/request/request/issues/3142",
      "license": "Apache-2.0",
      "peer": true,
      "dependencies": {
        "aws-sign2": "~0.7.0",
        "aws4": "^1.8.0",
        "caseless": "~0.12.0",
        "combined-stream": "~1.0.6",
        "extend": "~3.0.2",
        "forever-agent": "~0.6.1",
        "form-data": "~2.3.2",
        "har-validator": "~5.1.3",
        "http-signature": "~1.2.0",
        "is-typedarray": "~1.0.0",
        "isstream": "~0.1.2",
        "json-stringify-safe": "~5.0.1",
        "mime-types": "~2.1.19",
        "oauth-sign": "~0.9.0",
        "performance-now": "^2.1.0",
        "qs": "~6.5.2",
        "safe-buffer": "^5.1.2",
        "tough-cookie": "~2.5.0",
        "tunnel-agent": "^0.6.0",
        "uuid": "^3.3.2"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/request-promise-core": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/request-promise-core/-/request-promise-core-1.1.3.tgz",
      "integrity": "sha512-QIs2+ArIGQVp5ZYbWD5ZLCY29D5CfWizP8eWnm8FoGD1TX61veauETVQbrV60662V0oFBkrDOuaBI8XgtuyYAQ==",
      "license": "ISC",
      "dependencies": {
        "lodash": "^4.17.15"
      },
      "engines": {
        "node": ">=0.10.0"
      },
      "peerDependencies": {
        "request": "^2.34"
      }
    },
    "node_modules/request/node_modules/form-data": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/form-data/-/form-data-2.3.3.tgz",
      "integrity": "sha512-1lLKB2Mu3aGP1Q/2eCOx0fNbRMe7XdwktwOruhfqqd0rIJWwN4Dh+E3hrPSlDCXnSR7UtZ1N38rVXm+6+MEhJQ==",
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "asynckit": "^0.4.0",
        "combined-stream": "^1.0.6",
        "mime-types": "^2.1.12"
      },
      "engines": {
        "node": ">= 0.12"
      }
    },
    "node_modules/request/node_modules/http-signature": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/http-signature/-/http-signature-1.2.0.tgz",
      "integrity": "sha512-CAbnr6Rz4CYQkLYUtSNXxQPUH2gK8f3iWexVlsnMeD+GjlsQ0Xsy1cOX+mN3dtxYomRy21CiOzU8Uhw6OwncEQ==",
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "assert-plus": "^1.0.0",
        "jsprim": "^1.2.2",
        "sshpk": "^1.7.0"
      },
      "engines": {
        "node": ">=0.8",
        "npm": ">=1.3.7"
      }
    },
    "node_modules/request/node_modules/jsprim": {
      "version": "1.4.2",
      "resolved": "https://registry.npmjs.org/jsprim/-/jsprim-1.4.2.tgz",
      "integrity": "sha512-P2bSOMAc/ciLz6DzgjVlGJP9+BrJWu5UDGK70C2iweC5QBIeFf0ZXRvGjEj2uYgrY2MkAAhsSWHDWlFtEroZWw==",
      "license": "MIT",
      "peer": true,
      "dependencies": {
        "assert-plus": "1.0.0",
        "extsprintf": "1.3.0",
        "json-schema": "0.4.0",
        "verror": "1.10.0"
      },
      "engines": {
        "node": ">=0.6.0"
      }
    },
    "node_modules/request/node_modules/qs": {
      "version": "6.5.3",
      "resolved": "https://registry.npmjs.org/qs/-/qs-6.5.3.tgz",
      "integrity": "sha512-qxXIEh4pCGfHICj1mAJQ2/2XVZkjCDTcEgfoSQxc/fYivUZxTkk7L3bDBJSoNrEzXI17oUO5Dp07ktqE5KzczA==",
      "license": "BSD-3-Clause",
      "peer": true,
      "engines": {
        "node": ">=0.6"
      }
    },
    "node_modules/request/node_modules/tough-cookie": {
      "version": "2.5.0",
      "resolved": "https://registry.npmjs.org/tough-cookie/-/tough-cookie-2.5.0.tgz",
      "integrity": "sha512-nlLsUzgm1kfLXSXfRZMc1KLAugd4hqJHDTvc2hDIwS3mZAfMEuMbc03SujMF+GEcpaX/qboeycw6iO8JwVv2+g==",
      "license": "BSD-3-Clause",
      "peer": true,
      "dependencies": {
        "psl": "^1.1.28",
        "punycode": "^2.1.1"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/request/node_modules/uuid": {
      "version": "3.4.0",
      "resolved": "https://registry.npmjs.org/uuid/-/uuid-3.4.0.tgz",
      "integrity": "sha512-HjSDRw6gZE5JMggctHBcjVak08+KEVhSIiDzFnT9S9aegmp85S/bReBVTb4QTFaRNptJ9kuYaNhnbNEOkbKb/A==",
      "deprecated": "Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.",
      "license": "MIT",
      "peer": true,
      "bin": {
        "uuid": "bin/uuid"
      }
    },
    "node_modules/requires-port": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/requires-port/-/requires-port-1.0.0.tgz",
      "integrity": "sha512-KigOCHcocU3XODJxsu8i/j8T9tzT4adHiecwORRQ0ZZFcp7ahwXuRU1m+yuO90C5ZUyGeGfocHDI14M3L3yDAQ==",
      "license": "MIT"
    },
    "node_modules/resolve-pkg-maps": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/resolve-pkg-maps/-/resolve-pkg-maps-1.0.0.tgz",
      "integrity": "sha512-seS2Tj26TBVOC2NIc2rOe2y2ZO7efxITtLZcGSOnHHNOQ7CkiUBfw0Iw2ck6xkIhPwLhKNLS8BO+hEpngQlqzw==",
      "dev": true,
      "license": "MIT",
      "funding": {
        "url": "https://github.com/privatenumber/resolve-pkg-maps?sponsor=1"
      }
    },
    "node_modules/rollup": {
      "version": "4.52.5",
      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.52.5.tgz",
      "integrity": "sha512-3GuObel8h7Kqdjt0gxkEzaifHTqLVW56Y/bjN7PSQtkKr0w3V/QYSdt6QWYtd7A1xUtYQigtdUfgj1RvWVtorw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.52.5",
        "@rollup/rollup-android-arm64": "4.52.5",
        "@rollup/rollup-darwin-arm64": "4.52.5",
        "@rollup/rollup-darwin-x64": "4.52.5",
        "@rollup/rollup-freebsd-arm64": "4.52.5",
        "@rollup/rollup-freebsd-x64": "4.52.5",
        "@rollup/rollup-linux-arm-gnueabihf": "4.52.5",
        "@rollup/rollup-linux-arm-musleabihf": "4.52.5",
        "@rollup/rollup-linux-arm64-gnu": "4.52.5",
        "@rollup/rollup-linux-arm64-musl": "4.52.5",
        "@rollup/rollup-linux-loong64-gnu": "4.52.5",
        "@rollup/rollup-linux-ppc64-gnu": "4.52.5",
        "@rollup/rollup-linux-riscv64-gnu": "4.52.5",
        "@rollup/rollup-linux-riscv64-musl": "4.52.5",
        "@rollup/rollup-linux-s390x-gnu": "4.52.5",
        "@rollup/rollup-linux-x64-gnu": "4.52.5",
        "@rollup/rollup-linux-x64-musl": "4.52.5",
        "@rollup/rollup-openharmony-arm64": "4.52.5",
        "@rollup/rollup-win32-arm64-msvc": "4.52.5",
        "@rollup/rollup-win32-ia32-msvc": "4.52.5",
        "@rollup/rollup-win32-x64-gnu": "4.52.5",
        "@rollup/rollup-win32-x64-msvc": "4.52.5",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/safe-array-concat": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/safe-array-concat/-/safe-array-concat-1.1.3.tgz",
      "integrity": "sha512-AURm5f0jYEOydBj7VQlVvDrjeFgthDdEF5H1dP+6mNpoXOMo1quQqJ4wvJDyRZ9+pO3kGWoOdmV08cSv2aJV6Q==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.2",
        "get-intrinsic": "^1.2.6",
        "has-symbols": "^1.1.0",
        "isarray": "^2.0.5"
      },
      "engines": {
        "node": ">=0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/safe-array-concat/node_modules/isarray": {
      "version": "2.0.5",
      "resolved": "https://registry.npmjs.org/isarray/-/isarray-2.0.5.tgz",
      "integrity": "sha512-xHjhDr3cNBK0BzdUJSPXZntQUx/mwMS5Rw4A7lPJ90XGAO6ISP/ePDNuo0vhqOZU+UD5JoodwCAAoZQd3FeAKw==",
      "license": "MIT"
    },
    "node_modules/safe-buffer": {
      "version": "5.2.1",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.2.1.tgz",
      "integrity": "sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT"
    },
    "node_modules/safe-push-apply": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/safe-push-apply/-/safe-push-apply-1.0.0.tgz",
      "integrity": "sha512-iKE9w/Z7xCzUMIZqdBsp6pEQvwuEebH4vdpjcDWnyzaI6yl6O9FHvVpmGelvEHNsoY6wGblkxR6Zty/h00WiSA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "isarray": "^2.0.5"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/safe-push-apply/node_modules/isarray": {
      "version": "2.0.5",
      "resolved": "https://registry.npmjs.org/isarray/-/isarray-2.0.5.tgz",
      "integrity": "sha512-xHjhDr3cNBK0BzdUJSPXZntQUx/mwMS5Rw4A7lPJ90XGAO6ISP/ePDNuo0vhqOZU+UD5JoodwCAAoZQd3FeAKw==",
      "license": "MIT"
    },
    "node_modules/safe-regex-test": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/safe-regex-test/-/safe-regex-test-1.1.0.tgz",
      "integrity": "sha512-x/+Cz4YrimQxQccJf5mKEbIa1NzeCRNI5Ecl/ekmlYaampdNLPalVyIcCZNNH3MvmqBugV5TMYZXv0ljslUlaw==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "is-regex": "^1.2.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/safer-buffer": {
      "version": "2.1.2",
      "resolved": "https://registry.npmjs.org/safer-buffer/-/safer-buffer-2.1.2.tgz",
      "integrity": "sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==",
      "license": "MIT"
    },
    "node_modules/scheduler": {
      "version": "0.27.0",
      "resolved": "https://registry.npmjs.org/scheduler/-/scheduler-0.27.0.tgz",
      "integrity": "sha512-eNv+WrVbKu1f3vbYJT/xtiF5syA5HPIMtf9IgY/nKg0sWqzAUEvqY/xm7OcZc/qafLx/iO9FgOmeSAp4v5ti/Q==",
      "license": "MIT"
    },
    "node_modules/semver": {
      "version": "6.3.1",
      "resolved": "https://registry.npmjs.org/semver/-/semver-6.3.1.tgz",
      "integrity": "sha512-BR7VvDCVHO+q2xBEWskxS6DJE1qRnb7DxzUrogb71CWoSficBxYsiAGd+Kl0mmq/MprG9yArRkyrQxTO6XjMzA==",
      "dev": true,
      "license": "ISC",
      "bin": {
        "semver": "bin/semver.js"
      }
    },
    "node_modules/send": {
      "version": "0.19.0",
      "resolved": "https://registry.npmjs.org/send/-/send-0.19.0.tgz",
      "integrity": "sha512-dW41u5VfLXu8SJh5bwRmyYUbAoSB3c9uQh6L8h/KtsFREPWpbX1lrljJo186Jc4nmci/sGUZ9a0a0J2zgfq2hw==",
      "license": "MIT",
      "dependencies": {
        "debug": "2.6.9",
        "depd": "2.0.0",
        "destroy": "1.2.0",
        "encodeurl": "~1.0.2",
        "escape-html": "~1.0.3",
        "etag": "~1.8.1",
        "fresh": "0.5.2",
        "http-errors": "2.0.0",
        "mime": "1.6.0",
        "ms": "2.1.3",
        "on-finished": "2.4.1",
        "range-parser": "~1.2.1",
        "statuses": "2.0.1"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/send/node_modules/debug": {
      "version": "2.6.9",
      "resolved": "https://registry.npmjs.org/debug/-/debug-2.6.9.tgz",
      "integrity": "sha512-bC7ElrdJaJnPbAP+1EotYvqZsb3ecl5wi6Bfi6BJTUcNowp6cvspg0jXznRTKDjm/E7AdgFBVeAPVMNcKGsHMA==",
      "license": "MIT",
      "dependencies": {
        "ms": "2.0.0"
      }
    },
    "node_modules/send/node_modules/debug/node_modules/ms": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/ms/-/ms-2.0.0.tgz",
      "integrity": "sha512-Tpp60P6IUJDTuOq/5Z8cdskzJujfwqfOTkrwIwj7IRISpnkJnT6SyJ4PCPnGMoFjC9ddhal5KVIYtAt97ix05A==",
      "license": "MIT"
    },
    "node_modules/send/node_modules/encodeurl": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/encodeurl/-/encodeurl-1.0.2.tgz",
      "integrity": "sha512-TPJXq8JqFaVYm2CWmPvnP2Iyo4ZSM7/QKcSmuMLDObfpH5fi7RUGmd/rTDf+rut/saiDiQEeVTNgAmJEdAOx0w==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/serve-static": {
      "version": "1.16.2",
      "resolved": "https://registry.npmjs.org/serve-static/-/serve-static-1.16.2.tgz",
      "integrity": "sha512-VqpjJZKadQB/PEbEwvFdO43Ax5dFBZ2UECszz8bQ7pi7wt//PWe1P6MN7eCnjsatYtBT6EuiClbjSWP2WrIoTw==",
      "license": "MIT",
      "dependencies": {
        "encodeurl": "~2.0.0",
        "escape-html": "~1.0.3",
        "parseurl": "~1.3.3",
        "send": "0.19.0"
      },
      "engines": {
        "node": ">= 0.8.0"
      }
    },
    "node_modules/set-function-length": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/set-function-length/-/set-function-length-1.2.2.tgz",
      "integrity": "sha512-pgRc4hJ4/sNjWCSS9AmnS40x3bNMDTknHgL5UaMBTMyJnU90EgWh1Rz+MC9eFu4BuN/UwZjKQuY/1v3rM7HMfg==",
      "license": "MIT",
      "dependencies": {
        "define-data-property": "^1.1.4",
        "es-errors": "^1.3.0",
        "function-bind": "^1.1.2",
        "get-intrinsic": "^1.2.4",
        "gopd": "^1.0.1",
        "has-property-descriptors": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/set-function-name": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/set-function-name/-/set-function-name-2.0.2.tgz",
      "integrity": "sha512-7PGFlmtwsEADb0WYyvCMa1t+yke6daIG4Wirafur5kcf+MhUnPms1UeR0CKQdTZD81yESwMHbtn+TR+dMviakQ==",
      "license": "MIT",
      "dependencies": {
        "define-data-property": "^1.1.4",
        "es-errors": "^1.3.0",
        "functions-have-names": "^1.2.3",
        "has-property-descriptors": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/set-proto": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/set-proto/-/set-proto-1.0.0.tgz",
      "integrity": "sha512-RJRdvCo6IAnPdsvP/7m6bsQqNnn1FCBX5ZNtFL98MmFF/4xAIJTIg1YbHW5DC2W5SKZanrC6i4HsJqlajw/dZw==",
      "license": "MIT",
      "dependencies": {
        "dunder-proto": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/setprototypeof": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/setprototypeof/-/setprototypeof-1.2.0.tgz",
      "integrity": "sha512-E5LDX7Wrp85Kil5bhZv46j8jOeboKq5JMmYM3gVGdGH8xFpPWXUMsNrlODCrkoxMEeNi/XZIwuRvY4XNwYMJpw==",
      "license": "ISC"
    },
    "node_modules/side-channel": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/side-channel/-/side-channel-1.1.0.tgz",
      "integrity": "sha512-ZX99e6tRweoUXqR+VBrslhda51Nh5MTQwou5tnUDgbtyM0dBgmhEDtWGP/xbKn6hqfPRHujUNwz5fy/wbbhnpw==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3",
        "side-channel-list": "^1.0.0",
        "side-channel-map": "^1.0.1",
        "side-channel-weakmap": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-list": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/side-channel-list/-/side-channel-list-1.0.0.tgz",
      "integrity": "sha512-FCLHtRD/gnpCiCHEiJLOwdmFP+wzCmDEkc9y7NsYxeF4u7Btsn1ZuwgwJGxImImHicJArLP4R0yX4c2KCrMrTA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-map": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/side-channel-map/-/side-channel-map-1.0.1.tgz",
      "integrity": "sha512-VCjCNfgMsby3tTdo02nbjtM/ewra6jPHmpThenkTYh8pG9ucZ/1P8So4u4FGBek/BjpOVsDCMoLA/iuBKIFXRA==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/side-channel-weakmap": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/side-channel-weakmap/-/side-channel-weakmap-1.0.2.tgz",
      "integrity": "sha512-WPS/HvHQTYnHisLo9McqBHOJk2FkHO/tlpvldyrnem4aeQp4hai3gythswg6p01oSoTl58rcpiFAjF2br2Ak2A==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.5",
        "object-inspect": "^1.13.3",
        "side-channel-map": "^1.0.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/sonner": {
      "version": "2.0.7",
      "resolved": "https://registry.npmjs.org/sonner/-/sonner-2.0.7.tgz",
      "integrity": "sha512-W6ZN4p58k8aDKA4XPcx2hpIQXBRAgyiWVkYhT7CvK6D3iAu7xjvVyhQHg2/iaKJZ1XVJ4r7XuwGL+WGEK37i9w==",
      "license": "MIT",
      "peerDependencies": {
        "react": "^18.0.0 || ^19.0.0 || ^19.0.0-rc",
        "react-dom": "^18.0.0 || ^19.0.0 || ^19.0.0-rc"
      }
    },
    "node_modules/source-map": {
      "version": "0.6.1",
      "resolved": "https://registry.npmjs.org/source-map/-/source-map-0.6.1.tgz",
      "integrity": "sha512-UjgapumWlbMhkBgzT7Ykc5YXUT46F0iKu8SGXq0bcwP5dz/h0Plj6enJqjz1Zbq2l5WaqYnrVbwWOWMyF3F47g==",
      "dev": true,
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "dev": true,
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/source-map-support": {
      "version": "0.5.21",
      "resolved": "https://registry.npmjs.org/source-map-support/-/source-map-support-0.5.21.tgz",
      "integrity": "sha512-uBHU3L3czsIyYXKX88fdrGovxdSCoTGDRZ6SYXtSRxLZUzHg5P/66Ht6uoUlHu9EZod+inXhKo3qQgwXUT/y1w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "buffer-from": "^1.0.0",
        "source-map": "^0.6.0"
      }
    },
    "node_modules/split2": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/split2/-/split2-4.2.0.tgz",
      "integrity": "sha512-UcjcJOWknrNkF6PLX83qcHM6KHgVKNkV62Y8a5uYDVv9ydGQVwAHMKqHdJje1VTWpljG0WYpCDhrCdAOYH4TWg==",
      "license": "ISC",
      "engines": {
        "node": ">= 10.x"
      }
    },
    "node_modules/sshpk": {
      "version": "1.18.0",
      "resolved": "https://registry.npmjs.org/sshpk/-/sshpk-1.18.0.tgz",
      "integrity": "sha512-2p2KJZTSqQ/I3+HX42EpYOa2l3f8Erv8MWKsy2I9uf4wA7yFIkXRffYdsx86y6z4vHtV8u7g+pPlr8/4ouAxsQ==",
      "license": "MIT",
      "dependencies": {
        "asn1": "~0.2.3",
        "assert-plus": "^1.0.0",
        "bcrypt-pbkdf": "^1.0.0",
        "dashdash": "^1.12.0",
        "ecc-jsbn": "~0.1.1",
        "getpass": "^0.1.1",
        "jsbn": "~0.1.0",
        "safer-buffer": "^2.0.2",
        "tweetnacl": "~0.14.0"
      },
      "bin": {
        "sshpk-conv": "bin/sshpk-conv",
        "sshpk-sign": "bin/sshpk-sign",
        "sshpk-verify": "bin/sshpk-verify"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/statuses": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/statuses/-/statuses-2.0.1.tgz",
      "integrity": "sha512-RwNA9Z/7PrK06rYLIzFMlaF+l73iwpzsqRIFgbMLbTcLD6cOao82TaWefPXQvB2fOC4AjuYSEndS7N/mTCbkdQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/stealthy-require": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/stealthy-require/-/stealthy-require-1.1.1.tgz",
      "integrity": "sha512-ZnWpYnYugiOVEY5GkcuJK1io5V8QmNYChG62gSit9pQVGErXtrKuPC55ITaVSukmMta5qpMU7vqLt2Lnni4f/g==",
      "license": "ISC",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/stop-iteration-iterator": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/stop-iteration-iterator/-/stop-iteration-iterator-1.1.0.tgz",
      "integrity": "sha512-eLoXW/DHyl62zxY4SCaIgnRhuMr6ri4juEYARS8E6sCEqzKpOiE521Ucofdx+KnDZl5xmvGYaaKCk5FEOxJCoQ==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "internal-slot": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/string_decoder": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/string_decoder/-/string_decoder-1.1.1.tgz",
      "integrity": "sha512-n/ShnvDi6FHbbVfviro+WojiFzv+s8MPMHBczVePfUpDJLwoLT0ht1l4YwBCbi8pJAveEEdnkHyPyTP/mzRfwg==",
      "license": "MIT",
      "dependencies": {
        "safe-buffer": "~5.1.0"
      }
    },
    "node_modules/string_decoder/node_modules/safe-buffer": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/safe-buffer/-/safe-buffer-5.1.2.tgz",
      "integrity": "sha512-Gd2UZBJDkXlY7GbJxfsE8/nvKkUEU1G38c1siN6QP6a9PT9MmHB8GnpscSmMJSoF8LOIrt8ud/wPtojys4G6+g==",
      "license": "MIT"
    },
    "node_modules/string.prototype.trim": {
      "version": "1.2.10",
      "resolved": "https://registry.npmjs.org/string.prototype.trim/-/string.prototype.trim-1.2.10.tgz",
      "integrity": "sha512-Rs66F0P/1kedk5lyYyH9uBzuiI/kNRmwJAR9quK6VOtIpZ2G+hMZd+HQbbv25MgCA6gEffoMZYxlTod4WcdrKA==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.2",
        "define-data-property": "^1.1.4",
        "define-properties": "^1.2.1",
        "es-abstract": "^1.23.5",
        "es-object-atoms": "^1.0.0",
        "has-property-descriptors": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/string.prototype.trimend": {
      "version": "1.0.9",
      "resolved": "https://registry.npmjs.org/string.prototype.trimend/-/string.prototype.trimend-1.0.9.tgz",
      "integrity": "sha512-G7Ok5C6E/j4SGfyLCloXTrngQIQU3PWtXGst3yM7Bea9FRURf1S42ZHlZZtsNque2FN2PoUhfZXYLNWwEr4dLQ==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.2",
        "define-properties": "^1.2.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/string.prototype.trimstart": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/string.prototype.trimstart/-/string.prototype.trimstart-1.0.8.tgz",
      "integrity": "sha512-UXSH262CSZY1tfu3G3Secr6uGLCFVPMhIqHjlgCUtCCcgihYc/xKs9djMTMUOb2j1mVSeU8EU6NWc/iQKU6Gfg==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.7",
        "define-properties": "^1.2.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/tailwind-merge": {
      "version": "3.3.1",
      "resolved": "https://registry.npmjs.org/tailwind-merge/-/tailwind-merge-3.3.1.tgz",
      "integrity": "sha512-gBXpgUm/3rp1lMZZrM/w7D8GKqshif0zAymAhbCyIt8KMe+0v9DQ7cdYLR4FHH/cKpdTXb+A/tKKU3eolfsI+g==",
      "license": "MIT",
      "funding": {
        "type": "github",
        "url": "https://github.com/sponsors/dcastil"
      }
    },
    "node_modules/tailwindcss": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/tailwindcss/-/tailwindcss-4.1.16.tgz",
      "integrity": "sha512-pONL5awpaQX4LN5eiv7moSiSPd/DLDzKVRJz8Q9PgzmAdd1R4307GQS2ZpfiN7ZmekdQrfhZZiSE5jkLR4WNaA==",
      "license": "MIT"
    },
    "node_modules/tailwindcss-animate": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/tailwindcss-animate/-/tailwindcss-animate-1.0.7.tgz",
      "integrity": "sha512-bl6mpH3T7I3UFxuvDEXLxy/VuFxBk5bbzplh7tXI68mwMokNYd1t9qPBHlnyTwfa4JGC4zP516I1hYYtQ/vspA==",
      "peerDependencies": {
        "tailwindcss": ">=3.0.0 || insiders"
      }
    },
    "node_modules/tapable": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/tapable/-/tapable-2.3.0.tgz",
      "integrity": "sha512-g9ljZiwki/LfxmQADO3dEY1CbpmXT5Hm2fJ+QaGKwSXUylMybePR7/67YW7jOrrvjEgL1Fmz5kzyAjWVWLlucg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/webpack"
      }
    },
    "node_modules/tiny-invariant": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/tiny-invariant/-/tiny-invariant-1.3.3.tgz",
      "integrity": "sha512-+FbBPE1o9QAYvviau/qC5SE3caw21q3xkvWKBtja5vgqOWIHHJ3ioaq1VPfn/Szqctz2bU/oYeKd9/z5BL+PVg==",
      "license": "MIT"
    },
    "node_modules/tinyglobby": {
      "version": "0.2.15",
      "resolved": "https://registry.npmjs.org/tinyglobby/-/tinyglobby-0.2.15.tgz",
      "integrity": "sha512-j2Zq4NyQYG5XMST4cbs02Ak8iJUdxRM0XI5QyxXuZOzKOINmWurp3smXu3y5wDcJrptwpSjgXHzIQxR0omXljQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "fdir": "^6.5.0",
        "picomatch": "^4.0.3"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/SuperchupuDev"
      }
    },
    "node_modules/tldts": {
      "version": "6.1.86",
      "resolved": "https://registry.npmjs.org/tldts/-/tldts-6.1.86.tgz",
      "integrity": "sha512-WMi/OQ2axVTf/ykqCQgXiIct+mSQDFdH2fkwhPwgEwvJ1kSzZRiinb0zF2Xb8u4+OqPChmyI6MEu4EezNJz+FQ==",
      "license": "MIT",
      "dependencies": {
        "tldts-core": "^6.1.86"
      },
      "bin": {
        "tldts": "bin/cli.js"
      }
    },
    "node_modules/tldts-core": {
      "version": "6.1.86",
      "resolved": "https://registry.npmjs.org/tldts-core/-/tldts-core-6.1.86.tgz",
      "integrity": "sha512-Je6p7pkk+KMzMv2XXKmAE3McmolOQFdxkKw0R8EYNr7sELW46JqnNeTX8ybPiQgvg1ymCoF8LXs5fzFaZvJPTA==",
      "license": "MIT"
    },
    "node_modules/toidentifier": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/toidentifier/-/toidentifier-1.0.1.tgz",
      "integrity": "sha512-o5sSPKEkg/DIQNmH43V0/uerLrpzVedkUh8tGNvaeXpfpuwjKenlSox/2O/BTlZUtEe+JG7s5YhEz608PlAHRA==",
      "license": "MIT",
      "engines": {
        "node": ">=0.6"
      }
    },
    "node_modules/tough-cookie": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/tough-cookie/-/tough-cookie-5.1.2.tgz",
      "integrity": "sha512-FVDYdxtnj0G6Qm/DhNPSb8Ju59ULcup3tuJxkFb5K8Bv2pUXILbf0xZWU8PX8Ov19OXljbUyveOFwRMwkXzO+A==",
      "license": "BSD-3-Clause",
      "dependencies": {
        "tldts": "^6.1.32"
      },
      "engines": {
        "node": ">=16"
      }
    },
    "node_modules/ts-ev": {
      "version": "0.4.0",
      "resolved": "https://registry.npmjs.org/ts-ev/-/ts-ev-0.4.0.tgz",
      "integrity": "sha512-rLX6QdkC1/jA9sS4y9/DxHABTcOussp33J90h+TxHmya9CWvbGc9uLqdM4c/N4pNRmSdtq9zqhz7sB9KcN1NFQ==",
      "deprecated": "Package no longer supported. Contact Support at https://www.npmjs.com/support for more info.",
      "license": "MIT",
      "engines": {
        "node": ">=10.0.0"
      }
    },
    "node_modules/tslib": {
      "version": "2.8.1",
      "resolved": "https://registry.npmjs.org/tslib/-/tslib-2.8.1.tgz",
      "integrity": "sha512-oJFu94HQb+KVduSUQL7wnpmqnfmLsOA/nAh6b6EH0wCEoK0/mPeXU6c3wKDV83MkOuHPRHtSXKKU99IBazS/2w==",
      "license": "0BSD"
    },
    "node_modules/tsx": {
      "version": "4.20.5",
      "resolved": "https://registry.npmjs.org/tsx/-/tsx-4.20.5.tgz",
      "integrity": "sha512-+wKjMNU9w/EaQayHXb7WA7ZaHY6hN8WgfvHNQ3t1PnU91/7O8TcTnIhCDYTZwnt8JsO9IBqZ30Ln1r7pPF52Aw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "esbuild": "~0.25.0",
        "get-tsconfig": "^4.7.5"
      },
      "bin": {
        "tsx": "dist/cli.mjs"
      },
      "engines": {
        "node": ">=18.0.0"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      }
    },
    "node_modules/tunnel-agent": {
      "version": "0.6.0",
      "resolved": "https://registry.npmjs.org/tunnel-agent/-/tunnel-agent-0.6.0.tgz",
      "integrity": "sha512-McnNiV1l8RYeY8tBgEpuodCC1mLUdbSN+CYBL7kJsJNInOP8UjDDEwdk6Mw60vdLLrr5NHKZhMAOSrR2NZuQ+w==",
      "license": "Apache-2.0",
      "dependencies": {
        "safe-buffer": "^5.0.1"
      },
      "engines": {
        "node": "*"
      }
    },
    "node_modules/tw-animate-css": {
      "version": "1.4.0",
      "resolved": "https://registry.npmjs.org/tw-animate-css/-/tw-animate-css-1.4.0.tgz",
      "integrity": "sha512-7bziOlRqH0hJx80h/3mbicLW7o8qLsH5+RaLR2t+OHM3D0JlWGODQKQ4cxbK7WlvmUxpcj6Kgu6EKqjrGFe3QQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/Wombosvideo"
      }
    },
    "node_modules/tweetnacl": {
      "version": "0.14.5",
      "resolved": "https://registry.npmjs.org/tweetnacl/-/tweetnacl-0.14.5.tgz",
      "integrity": "sha512-KXXFFdAbFXY4geFIwoyNK+f5Z1b7swfXABfL7HXCmoIWMKU3dmS26672A4EeQtDzLKy7SXmfBu51JolvEKwtGA==",
      "license": "Unlicense"
    },
    "node_modules/type-is": {
      "version": "1.6.18",
      "resolved": "https://registry.npmjs.org/type-is/-/type-is-1.6.18.tgz",
      "integrity": "sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==",
      "license": "MIT",
      "dependencies": {
        "media-typer": "0.3.0",
        "mime-types": "~2.1.24"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/typed-array-buffer": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/typed-array-buffer/-/typed-array-buffer-1.0.3.tgz",
      "integrity": "sha512-nAYYwfY3qnzX30IkA6AQZjVbtK6duGontcQm1WSG1MD94YLqK0515GNApXkoxKOWMusVssAHWLh9SeaoefYFGw==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "es-errors": "^1.3.0",
        "is-typed-array": "^1.1.14"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/typed-array-byte-length": {
      "version": "1.0.3",
      "resolved": "https://registry.npmjs.org/typed-array-byte-length/-/typed-array-byte-length-1.0.3.tgz",
      "integrity": "sha512-BaXgOuIxz8n8pIq3e7Atg/7s+DpiYrxn4vdot3w9KbnBhcRQq6o3xemQdIfynqSeXeDrF32x+WvfzmOjPiY9lg==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.8",
        "for-each": "^0.3.3",
        "gopd": "^1.2.0",
        "has-proto": "^1.2.0",
        "is-typed-array": "^1.1.14"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/typed-array-byte-offset": {
      "version": "1.0.4",
      "resolved": "https://registry.npmjs.org/typed-array-byte-offset/-/typed-array-byte-offset-1.0.4.tgz",
      "integrity": "sha512-bTlAFB/FBYMcuX81gbL4OcpH5PmlFHqlCCpAl8AlEzMz5k53oNDvN8p1PNOWLEmI2x4orp3raOFB51tv9X+MFQ==",
      "license": "MIT",
      "dependencies": {
        "available-typed-arrays": "^1.0.7",
        "call-bind": "^1.0.8",
        "for-each": "^0.3.3",
        "gopd": "^1.2.0",
        "has-proto": "^1.2.0",
        "is-typed-array": "^1.1.15",
        "reflect.getprototypeof": "^1.0.9"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/typed-array-length": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/typed-array-length/-/typed-array-length-1.0.7.tgz",
      "integrity": "sha512-3KS2b+kL7fsuk/eJZ7EQdnEmQoaho/r6KUef7hxvltNA5DR8NAUM+8wJMbJyZ4G9/7i3v5zPBIMN5aybAh2/Jg==",
      "license": "MIT",
      "dependencies": {
        "call-bind": "^1.0.7",
        "for-each": "^0.3.3",
        "gopd": "^1.0.1",
        "is-typed-array": "^1.1.13",
        "possible-typed-array-names": "^1.0.0",
        "reflect.getprototypeof": "^1.0.6"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/typescript": {
      "version": "5.6.3",
      "resolved": "https://registry.npmjs.org/typescript/-/typescript-5.6.3.tgz",
      "integrity": "sha512-hjcS1mhfuyi4WW8IWtjP7brDrG2cuDZukyrYrSauoXGNgx0S7zceP07adYkJycEr56BOUTNPzbInooiN3fn1qw==",
      "dev": true,
      "license": "Apache-2.0",
      "bin": {
        "tsc": "bin/tsc",
        "tsserver": "bin/tsserver"
      },
      "engines": {
        "node": ">=14.17"
      }
    },
    "node_modules/uid-safe": {
      "version": "2.1.5",
      "resolved": "https://registry.npmjs.org/uid-safe/-/uid-safe-2.1.5.tgz",
      "integrity": "sha512-KPHm4VL5dDXKz01UuEd88Df+KzynaohSL9fBh096KWAxSKZQDI2uBrVqtvRM4rwrIrRRKsdLNML/lnaaVSRioA==",
      "license": "MIT",
      "dependencies": {
        "random-bytes": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/unbox-primitive": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/unbox-primitive/-/unbox-primitive-1.1.0.tgz",
      "integrity": "sha512-nWJ91DjeOkej/TA8pXQ3myruKpKEYgqvpw9lz4OPHj/NWFNluYrjbz9j01CJ8yKQd2g4jFoOkINCTW2I5LEEyw==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.3",
        "has-bigints": "^1.0.2",
        "has-symbols": "^1.1.0",
        "which-boxed-primitive": "^1.1.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/undici-types": {
      "version": "6.21.0",
      "resolved": "https://registry.npmjs.org/undici-types/-/undici-types-6.21.0.tgz",
      "integrity": "sha512-iwDZqg0QAGrg9Rav5H4n0M64c3mkR59cJ6wQp+7C4nI0gsmExaedaYLNO44eT4AtBBwjbTiGPMlt2Md0T9H9JQ==",
      "license": "MIT"
    },
    "node_modules/universalify": {
      "version": "0.2.0",
      "resolved": "https://registry.npmjs.org/universalify/-/universalify-0.2.0.tgz",
      "integrity": "sha512-CJ1QgKmNg3CwvAv/kOFmtnEN05f0D/cn9QntgNOQlQF9dgvVTHj3t+8JPdjqawCHk7V/KA+fbUqzZ9XWhcqPUg==",
      "license": "MIT",
      "engines": {
        "node": ">= 4.0.0"
      }
    },
    "node_modules/unpipe": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/unpipe/-/unpipe-1.0.0.tgz",
      "integrity": "sha512-pjy2bYhSsufwWlKwPc+l3cN7+wuJlK6uz0YdJEOlQDbl6jo/YlPi4mb8agUkVC8BF7V8NuzeyPNqRksA3hztKQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/update-browserslist-db": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.1.4.tgz",
      "integrity": "sha512-q0SPT4xyU84saUX+tomz1WLkxUbuaJnR1xWt17M7fJtEJigJeWUNGUqrauFXsHnqev9y9JTRGwk13tFBuKby4A==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "escalade": "^3.2.0",
        "picocolors": "^1.1.1"
      },
      "bin": {
        "update-browserslist-db": "cli.js"
      },
      "peerDependencies": {
        "browserslist": ">= 4.21.0"
      }
    },
    "node_modules/uri-js": {
      "version": "4.4.1",
      "resolved": "https://registry.npmjs.org/uri-js/-/uri-js-4.4.1.tgz",
      "integrity": "sha512-7rKUyy33Q1yc98pQ1DAmLtwX109F7TIfWlW1Ydo8Wl1ii1SeHieeh0HHfPeL2fMXK6z0s8ecKs9frCuLJvndBg==",
      "license": "BSD-2-Clause",
      "peer": true,
      "dependencies": {
        "punycode": "^2.1.0"
      }
    },
    "node_modules/url-parse": {
      "version": "1.5.10",
      "resolved": "https://registry.npmjs.org/url-parse/-/url-parse-1.5.10.tgz",
      "integrity": "sha512-WypcfiRhfeUP9vvF0j6rw0J3hrWrw6iZv3+22h6iRMJ/8z1Tj6XfLP4DsUix5MhMPnXpiHDoKyoZ/bdCkwBCiQ==",
      "license": "MIT",
      "dependencies": {
        "querystringify": "^2.1.1",
        "requires-port": "^1.0.0"
      }
    },
    "node_modules/use-callback-ref": {
      "version": "1.3.3",
      "resolved": "https://registry.npmjs.org/use-callback-ref/-/use-callback-ref-1.3.3.tgz",
      "integrity": "sha512-jQL3lRnocaFtu3V00JToYz/4QkNWswxijDaCVNZRiRTO3HQDLsdu1ZtmIUvV4yPp+rvWm5j0y0TG/S61cuijTg==",
      "dependencies": {
        "tslib": "^2.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/use-sidecar": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/use-sidecar/-/use-sidecar-1.1.3.tgz",
      "integrity": "sha512-Fedw0aZvkhynoPYlA5WXrMCAMm+nSWdZt6lzJQ7Ok8S6Q+VsHmHpRWndVRJ8Be0ZbkfPc5LRYH+5XrzXcEeLRQ==",
      "dependencies": {
        "detect-node-es": "^1.1.0",
        "tslib": "^2.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "peerDependencies": {
        "@types/react": "*",
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0 || ^19.0.0-rc"
      },
      "peerDependenciesMeta": {
        "@types/react": {
          "optional": true
        }
      }
    },
    "node_modules/use-sync-external-store": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/use-sync-external-store/-/use-sync-external-store-1.6.0.tgz",
      "integrity": "sha512-Pp6GSwGP/NrPIrxVFAIkOQeyw8lFenOHijQWkUTrDvrF4ALqylP2C/KCkeS9dpUM3KvYRQhna5vt7IL95+ZQ9w==",
      "license": "MIT",
      "peerDependencies": {
        "react": "^16.8.0 || ^17.0.0 || ^18.0.0 || ^19.0.0"
      }
    },
    "node_modules/utf-8-validate": {
      "version": "5.0.10",
      "resolved": "https://registry.npmjs.org/utf-8-validate/-/utf-8-validate-5.0.10.tgz",
      "integrity": "sha512-Z6czzLq4u8fPOyx7TU6X3dvUZVvoJmxSQ+IcrlmagKhilxlhZgxPK6C5Jqbkw1IDUmFTM+cz9QDnnLTwDz/2gQ==",
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "dependencies": {
        "node-gyp-build": "^4.3.0"
      },
      "engines": {
        "node": ">=6.14.2"
      }
    },
    "node_modules/util-deprecate": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
      "license": "MIT"
    },
    "node_modules/utils-merge": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.1.tgz",
      "integrity": "sha512-pMZTvIkT1d+TFGvDOqodOclx0QWkkgi6Tdoa8gC8ffGAAqz9pzPTZWAybbsHHoED/ztMtkv/VoYTYyShUn81hA==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4.0"
      }
    },
    "node_modules/uuid": {
      "version": "8.3.2",
      "resolved": "https://registry.npmjs.org/uuid/-/uuid-8.3.2.tgz",
      "integrity": "sha512-+NYs2QeMWy+GWFOEm9xnn6HCDp0l7QBD7ml8zLUmJ+93Q5NF0NocErnwkTkXVFNiX3/fpC6afS8Dhb/gz7R7eg==",
      "license": "MIT",
      "bin": {
        "uuid": "dist/bin/uuid"
      }
    },
    "node_modules/vary": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/vary/-/vary-1.1.2.tgz",
      "integrity": "sha512-BNGbWLfd0eUPabhkXUVm0j8uuvREyTh5ovRa/dyow/BqAbZJyC+5fU+IzQOzmAKzYqYRAISoRhdQr3eIZ/PXqg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/vaul": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/vaul/-/vaul-1.1.2.tgz",
      "integrity": "sha512-ZFkClGpWyI2WUQjdLJ/BaGuV6AVQiJ3uELGk3OYtP+B6yCO7Cmn9vPFXVJkRaGkOJu3m8bQMgtyzNHixULceQA==",
      "dependencies": {
        "@radix-ui/react-dialog": "^1.1.1"
      },
      "peerDependencies": {
        "react": "^16.8 || ^17.0 || ^18.0 || ^19.0.0 || ^19.0.0-rc",
        "react-dom": "^16.8 || ^17.0 || ^18.0 || ^19.0.0 || ^19.0.0-rc"
      }
    },
    "node_modules/verror": {
      "version": "1.10.0",
      "resolved": "https://registry.npmjs.org/verror/-/verror-1.10.0.tgz",
      "integrity": "sha512-ZZKSmDAEFOijERBLkmYfJ+vmk3w+7hOLYDNkRCuRuMJGEmqYNCNLyBBFwWKVMhfwaEF3WOd0Zlw86U/WC/+nYw==",
      "engines": [
        "node >=0.6.0"
      ],
      "license": "MIT",
      "dependencies": {
        "assert-plus": "^1.0.0",
        "core-util-is": "1.0.2",
        "extsprintf": "^1.2.0"
      }
    },
    "node_modules/verror/node_modules/core-util-is": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/core-util-is/-/core-util-is-1.0.2.tgz",
      "integrity": "sha512-3lqz5YjWTYnW6dlDa5TLaTCcShfar1e40rmcJVwCBJC6mWlFuj0eCHIElmG1g5kyuJ/GD+8Wn4FFCcz4gJPfaQ==",
      "license": "MIT"
    },
    "node_modules/victory-vendor": {
      "version": "36.9.2",
      "resolved": "https://registry.npmjs.org/victory-vendor/-/victory-vendor-36.9.2.tgz",
      "integrity": "sha512-PnpQQMuxlwYdocC8fIJqVXvkeViHYzotI+NJrCuav0ZYFoq912ZHBk3mCeuj+5/VpodOjPe1z0Fk2ihgzlXqjQ==",
      "license": "MIT AND ISC",
      "dependencies": {
        "@types/d3-array": "^3.0.3",
        "@types/d3-ease": "^3.0.0",
        "@types/d3-interpolate": "^3.0.1",
        "@types/d3-scale": "^4.0.2",
        "@types/d3-shape": "^3.1.0",
        "@types/d3-time": "^3.0.0",
        "@types/d3-timer": "^3.0.0",
        "d3-array": "^3.1.6",
        "d3-ease": "^3.0.1",
        "d3-interpolate": "^3.0.1",
        "d3-scale": "^4.0.2",
        "d3-shape": "^3.1.0",
        "d3-time": "^3.0.0",
        "d3-timer": "^3.0.1"
      }
    },
    "node_modules/vite": {
      "version": "7.1.12",
      "resolved": "https://registry.npmjs.org/vite/-/vite-7.1.12.tgz",
      "integrity": "sha512-ZWyE8YXEXqJrrSLvYgrRP7p62OziLW7xI5HYGWFzOvupfAlrLvURSzv/FyGyy0eidogEM3ujU+kUG1zuHgb6Ug==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "esbuild": "^0.25.0",
        "fdir": "^6.5.0",
        "picomatch": "^4.0.3",
        "postcss": "^8.5.6",
        "rollup": "^4.43.0",
        "tinyglobby": "^0.2.15"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^20.19.0 || >=22.12.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^20.19.0 || >=22.12.0",
        "jiti": ">=1.21.0",
        "less": "^4.0.0",
        "lightningcss": "^1.21.0",
        "sass": "^1.70.0",
        "sass-embedded": "^1.70.0",
        "stylus": ">=0.54.8",
        "sugarss": "^5.0.0",
        "terser": "^5.16.0",
        "tsx": "^4.8.1",
        "yaml": "^2.4.2"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "jiti": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        },
        "tsx": {
          "optional": true
        },
        "yaml": {
          "optional": true
        }
      }
    },
    "node_modules/which-boxed-primitive": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/which-boxed-primitive/-/which-boxed-primitive-1.1.1.tgz",
      "integrity": "sha512-TbX3mj8n0odCBFVlY8AxkqcHASw3L60jIuF8jFP78az3C2YhmGvqbHBpAjTRH2/xqYunrJ9g1jSyjCjpoWzIAA==",
      "license": "MIT",
      "dependencies": {
        "is-bigint": "^1.1.0",
        "is-boolean-object": "^1.2.1",
        "is-number-object": "^1.1.1",
        "is-string": "^1.1.1",
        "is-symbol": "^1.1.1"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/which-builtin-type": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/which-builtin-type/-/which-builtin-type-1.2.1.tgz",
      "integrity": "sha512-6iBczoX+kDQ7a3+YJBnh3T+KZRxM/iYNPXicqk66/Qfm1b93iu+yOImkg0zHbj5LNOcNv1TEADiZ0xa34B4q6Q==",
      "license": "MIT",
      "dependencies": {
        "call-bound": "^1.0.2",
        "function.prototype.name": "^1.1.6",
        "has-tostringtag": "^1.0.2",
        "is-async-function": "^2.0.0",
        "is-date-object": "^1.1.0",
        "is-finalizationregistry": "^1.1.0",
        "is-generator-function": "^1.0.10",
        "is-regex": "^1.2.1",
        "is-weakref": "^1.0.2",
        "isarray": "^2.0.5",
        "which-boxed-primitive": "^1.1.0",
        "which-collection": "^1.0.2",
        "which-typed-array": "^1.1.16"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/which-builtin-type/node_modules/isarray": {
      "version": "2.0.5",
      "resolved": "https://registry.npmjs.org/isarray/-/isarray-2.0.5.tgz",
      "integrity": "sha512-xHjhDr3cNBK0BzdUJSPXZntQUx/mwMS5Rw4A7lPJ90XGAO6ISP/ePDNuo0vhqOZU+UD5JoodwCAAoZQd3FeAKw==",
      "license": "MIT"
    },
    "node_modules/which-collection": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/which-collection/-/which-collection-1.0.2.tgz",
      "integrity": "sha512-K4jVyjnBdgvc86Y6BkaLZEN933SwYOuBFkdmBu9ZfkcAbdVbpITnDmjvZ/aQjRXQrv5EPkTnD1s39GiiqbngCw==",
      "license": "MIT",
      "dependencies": {
        "is-map": "^2.0.3",
        "is-set": "^2.0.3",
        "is-weakmap": "^2.0.2",
        "is-weakset": "^2.0.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/which-typed-array": {
      "version": "1.1.19",
      "resolved": "https://registry.npmjs.org/which-typed-array/-/which-typed-array-1.1.19.tgz",
      "integrity": "sha512-rEvr90Bck4WZt9HHFC4DJMsjvu7x+r6bImz0/BrbWb7A2djJ8hnZMrWnHo9F8ssv0OMErasDhftrfROTyqSDrw==",
      "license": "MIT",
      "dependencies": {
        "available-typed-arrays": "^1.0.7",
        "call-bind": "^1.0.8",
        "call-bound": "^1.0.4",
        "for-each": "^0.3.5",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "has-tostringtag": "^1.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/wouter": {
      "version": "3.3.5",
      "resolved": "https://registry.npmjs.org/wouter/-/wouter-3.3.5.tgz",
      "integrity": "sha512-bx3fLQAMn+EhYbBdY3W1gw9ZfO/uchudxYMwOIBzF3HVgqNEEIT199vEoh7FLTC0Vz5+rpMO6NdFsOkGX1QQCw==",
      "license": "Unlicense",
      "dependencies": {
        "mitt": "^3.0.1",
        "regexparam": "^3.0.0",
        "use-sync-external-store": "^1.0.0"
      },
      "peerDependencies": {
        "react": ">=16.8.0"
      }
    },
    "node_modules/wrappy": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/wrappy/-/wrappy-1.0.2.tgz",
      "integrity": "sha512-l4Sp/DRseor9wL6EvV2+TuQn63dMkPjZ/sp9XkghTEbV9KlPS1xUsZ3u7/IQO4wxtcFB4bgpQPRcR3QCvezPcQ==",
      "license": "ISC"
    },
    "node_modules/ws": {
      "version": "8.18.0",
      "resolved": "https://registry.npmjs.org/ws/-/ws-8.18.0.tgz",
      "integrity": "sha512-8VbfWfHLbbwu3+N6OKsOMpBdT4kXPDDB9cJk2bJ6mh9ucxdlnNvH1e+roYkKmN9Nxw2yjz7VzeO9oOz2zJ04Pw==",
      "license": "MIT",
      "engines": {
        "node": ">=10.0.0"
      },
      "peerDependencies": {
        "bufferutil": "^4.0.1",
        "utf-8-validate": ">=5.0.2"
      },
      "peerDependenciesMeta": {
        "bufferutil": {
          "optional": true
        },
        "utf-8-validate": {
          "optional": true
        }
      }
    },
    "node_modules/xtend": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/xtend/-/xtend-4.0.2.tgz",
      "integrity": "sha512-LKYU1iAXJXUgAXn9URjiu+MWhyUXHsvfp7mcuYm9dSUKK0/CjtrUwFAxD82/mCWbtLsGjFIad0wIsod4zrTAEQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.4"
      }
    },
    "node_modules/yallist": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/yallist/-/yallist-3.1.1.tgz",
      "integrity": "sha512-a4UGQaWPH59mOXUYnAG2ewncQS4i4F43Tv3JoAM+s2VDAmS9NsK8GpDMLrCHPksFT7h3K6TOoUNn2pb7RoXx4g==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/zod": {
      "version": "3.25.76",
      "resolved": "https://registry.npmjs.org/zod/-/zod-3.25.76.tgz",
      "integrity": "sha512-gzUt/qt81nXsFGKIFcC3YnfEAx5NkunCfnDlvuBSSFS02bcXu4Lmea0AFIUwbLWxWPx3d9p8S5QoaujKcNQxcQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/colinhacks"
      }
    },
    "node_modules/zod-validation-error": {
      "version": "3.4.0",
      "resolved": "https://registry.npmjs.org/zod-validation-error/-/zod-validation-error-3.4.0.tgz",
      "integrity": "sha512-ZOPR9SVY6Pb2qqO5XHt+MkkTRxGXb4EVtnjc9JpXUOtUB1T9Ru7mZOT361AN3MsetVe7R0a1KZshJDZdgp9miQ==",
      "license": "MIT",
      "engines": {
        "node": ">=18.0.0"
      },
      "peerDependencies": {
        "zod": "^3.18.0"
      }
    }
  }
}


===== FILE: ./package.json =====
{
  "name": "rest-express",
  "version": "1.0.0",
  "type": "module",
  "license": "MIT",
  "scripts": {
    "dev:client": "vite dev --port 5000",
    "dev": "NODE_ENV=development tsx server/index.ts",
    "build": "tsx script/build.ts",
    "start": "NODE_ENV=production node dist/index.cjs",
    "check": "tsc",
    "db:push": "drizzle-kit push"
  },
  "dependencies": {
    "@hookform/resolvers": "^3.10.0",
    "@jridgewell/trace-mapping": "^0.3.25",
    "@radix-ui/react-accordion": "^1.2.12",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-aspect-ratio": "^1.1.8",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-collapsible": "^1.1.12",
    "@radix-ui/react-context-menu": "^2.2.16",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-hover-card": "^1.1.15",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-menubar": "^1.1.16",
    "@radix-ui/react-navigation-menu": "^1.2.14",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-radio-group": "^1.3.8",
    "@radix-ui/react-scroll-area": "^1.2.10",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slider": "^1.3.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@radix-ui/react-toast": "^1.2.7",
    "@radix-ui/react-toggle": "^1.1.10",
    "@radix-ui/react-toggle-group": "^1.1.11",
    "@radix-ui/react-tooltip": "^1.2.8",
    "@tanstack/react-query": "^5.60.5",
    "@types/node-telegram-bot-api": "^0.64.13",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "connect-pg-simple": "^10.0.0",
    "date-fns": "^3.6.0",
    "drizzle-orm": "^0.39.3",
    "drizzle-zod": "^0.7.0",
    "embla-carousel-react": "^8.6.0",
    "express": "^4.21.2",
    "express-session": "^1.18.1",
    "framer-motion": "^12.23.24",
    "input-otp": "^1.4.2",
    "lucide-react": "^0.545.0",
    "memorystore": "^1.6.7",
    "next-themes": "^0.4.6",
    "node-kraken-api": "^2.2.2",
    "node-telegram-bot-api": "^0.66.0",
    "passport": "^0.7.0",
    "passport-local": "^1.0.0",
    "pg": "^8.16.3",
    "react": "^19.2.0",
    "react-day-picker": "^9.11.1",
    "react-dom": "^19.2.0",
    "react-hook-form": "^7.66.0",
    "react-resizable-panels": "^2.1.9",
    "recharts": "^2.15.4",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.3.1",
    "tailwindcss-animate": "^1.0.7",
    "tw-animate-css": "^1.4.0",
    "vaul": "^1.1.2",
    "wouter": "^3.3.5",
    "ws": "^8.18.0",
    "zod": "^3.25.76",
    "zod-validation-error": "^3.4.0"
  },
  "devDependencies": {
    "@replit/vite-plugin-cartographer": "^0.4.4",
    "@replit/vite-plugin-dev-banner": "^0.1.1",
    "@replit/vite-plugin-runtime-error-modal": "^0.0.4",
    "@tailwindcss/vite": "^4.1.14",
    "@types/connect-pg-simple": "^7.0.3",
    "@types/express": "4.17.21",
    "@types/express-session": "^1.18.0",
    "@types/node": "^20.19.0",
    "@types/passport": "^1.0.16",
    "@types/passport-local": "^1.0.38",
    "@types/react": "^19.2.0",
    "@types/react-dom": "^19.2.0",
    "@types/ws": "^8.5.13",
    "@vitejs/plugin-react": "^5.0.4",
    "autoprefixer": "^10.4.21",
    "drizzle-kit": "^0.31.4",
    "esbuild": "^0.25.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.14",
    "tsx": "^4.20.5",
    "typescript": "5.6.3",
    "vite": "^7.1.9"
  },
  "optionalDependencies": {
    "bufferutil": "^4.0.8"
  }
}


===== FILE: ./drizzle.config.ts =====
import { defineConfig } from "drizzle-kit";

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL, ensure the database is provisioned");
}

export default defineConfig({
  out: "./migrations",
  schema: "./shared/schema.ts",
  dialect: "postgresql",
  dbCredentials: {
    url: process.env.DATABASE_URL,
  },
});


===== FILE: ./script/migrate.ts =====
#!/usr/bin/env npx tsx
/**
 * Non-interactive database migration script for Docker/NAS deployment.
 * This script runs before the app starts to ensure schema is up-to-date.
 * 
 * Usage: npx tsx script/migrate.ts
 * 
 * Features:
 * - No interactive prompts (unlike drizzle-kit push)
 * - Safe ADD COLUMN IF NOT EXISTS
 * - Backfills lot_id for existing positions
 * - Adds unique constraint only if safe
 */

import { drizzle } from "drizzle-orm/node-postgres";
import { sql } from "drizzle-orm";
import pg from "pg";

const { Pool } = pg;

async function runMigration() {
  console.log("[migrate] Starting non-interactive database migration...");
  
  const databaseUrl = process.env.DATABASE_URL;
  if (!databaseUrl) {
    console.error("[migrate] ERROR: DATABASE_URL not set");
    process.exit(1);
  }
  
  const pool = new Pool({ connectionString: databaseUrl });
  const db = drizzle(pool);
  
  try {
    // bot_config columns
    const botConfigMigrations = [
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_max_open_lots_per_pair INTEGER DEFAULT 1',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_pair_overrides JSONB',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS dry_run_mode BOOLEAN DEFAULT false',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_entry_usd DECIMAL(10,2) DEFAULT 100.00',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_allow_under_min BOOLEAN DEFAULT true',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_be_at_pct DECIMAL(5,2) DEFAULT 1.50',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_start_pct DECIMAL(5,2) DEFAULT 2.00',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_distance_pct DECIMAL(5,2) DEFAULT 1.50',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_step_pct DECIMAL(5,2) DEFAULT 0.25',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_enabled BOOLEAN DEFAULT false',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_pct DECIMAL(5,2) DEFAULT 10.00',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_enabled BOOLEAN DEFAULT false',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_pct DECIMAL(5,2) DEFAULT 35.00',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_part_usd DECIMAL(10,2) DEFAULT 50.00',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_threshold DECIMAL(5,2) DEFAULT 80.00',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_pct DECIMAL(5,2) DEFAULT 0.45',
      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_auto BOOLEAN DEFAULT true',
    ];
    
    // open_positions columns
    const openPositionsMigrations = [
      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS lot_id TEXT',
      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_break_even_activated BOOLEAN DEFAULT false',
      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_trailing_activated BOOLEAN DEFAULT false',
      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_current_stop_price DECIMAL(18,8)',
      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_scale_out_done BOOLEAN DEFAULT false',
      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS config_snapshot_json JSONB',
    ];
    
    console.log("[migrate] Applying bot_config migrations...");
    for (const migration of botConfigMigrations) {
      try {
        await db.execute(sql.raw(migration));
      } catch (e) {
        // Ignore errors (column may already exist)
      }
    }
    
    console.log("[migrate] Applying open_positions migrations...");
    for (const migration of openPositionsMigrations) {
      try {
        await db.execute(sql.raw(migration));
      } catch (e) {
        // Ignore errors
      }
    }
    
    // Backfill lot_id for existing positions
    console.log("[migrate] Backfilling lot_id for existing positions...");
    try {
      await db.execute(sql`
        UPDATE open_positions 
        SET lot_id = 'LEGACY-' || id::text || '-' || SUBSTRING(MD5(pair || opened_at::text) FROM 1 FOR 6)
        WHERE lot_id IS NULL
      `);
    } catch (e) {
      console.log("[migrate] lot_id backfill note:", e);
    }
    
    // Add unique constraint if safe
    console.log("[migrate] Checking lot_id uniqueness...");
    try {
      const duplicates = await db.execute(sql`
        SELECT lot_id, COUNT(*) FROM open_positions 
        WHERE lot_id IS NOT NULL 
        GROUP BY lot_id 
        HAVING COUNT(*) > 1
      `);
      
      if (duplicates.rows.length === 0) {
        // Check if constraint already exists
        const constraintExists = await db.execute(sql`
          SELECT constraint_name FROM information_schema.table_constraints 
          WHERE table_name = 'open_positions' AND constraint_name = 'open_positions_lot_id_unique'
        `);
        
        if (constraintExists.rows.length === 0) {
          console.log("[migrate] Adding unique constraint on lot_id...");
          await db.execute(sql`
            ALTER TABLE open_positions ADD CONSTRAINT open_positions_lot_id_unique UNIQUE (lot_id)
          `);
        } else {
          console.log("[migrate] lot_id unique constraint already exists");
        }
      } else {
        console.log("[migrate] WARNING: Duplicate lot_ids found, skipping unique constraint");
      }
    } catch (e) {
      console.log("[migrate] Constraint note:", e);
    }
    
    console.log("[migrate] Migration completed successfully!");
    await pool.end();
    process.exit(0);
  } catch (error) {
    console.error("[migrate] Migration failed:", error);
    await pool.end();
    process.exit(1);
  }
}

runMigration();


===== FILE: ./script/build.ts =====
import { build as esbuild } from "esbuild";
import { build as viteBuild } from "vite";
import { rm, readFile } from "fs/promises";

// server deps to bundle to reduce openat(2) syscalls
// which helps cold start times
const allowlist = [
  "@google/generative-ai",
  "axios",
  "connect-pg-simple",
  "cors",
  "date-fns",
  "drizzle-orm",
  "drizzle-zod",
  "express",
  "express-rate-limit",
  "express-session",
  "jsonwebtoken",
  "memorystore",
  "multer",
  "nanoid",
  "nodemailer",
  "node-kraken-api",
  "node-telegram-bot-api",
  "openai",
  "passport",
  "passport-local",
  "pg",
  "stripe",
  "uuid",
  "ws",
  "xlsx",
  "zod",
  "zod-validation-error",
];

async function buildAll() {
  await rm("dist", { recursive: true, force: true });

  console.log("building client...");
  await viteBuild();

  console.log("building server...");
  const pkg = JSON.parse(await readFile("package.json", "utf-8"));
  const allDeps = [
    ...Object.keys(pkg.dependencies || {}),
    ...Object.keys(pkg.devDependencies || {}),
  ];
  const externals = allDeps.filter((dep) => !allowlist.includes(dep));

  await esbuild({
    entryPoints: ["server/index.ts"],
    platform: "node",
    bundle: true,
    format: "cjs",
    outfile: "dist/index.cjs",
    define: {
      "process.env.NODE_ENV": '"production"',
    },
    minify: true,
    external: externals,
    logLevel: "info",
  });
}

buildAll().catch((err) => {
  console.error(err);
  process.exit(1);
});


===== FILE: ./postcss.config.js =====
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


===== FILE: ./components.json =====
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.ts",
    "css": "client/src/index.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  }
}


===== FILE: ./shared/schema.ts =====
import { sql } from "drizzle-orm";
import { pgTable, text, varchar, serial, timestamp, decimal, boolean, integer, jsonb, unique } from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

export const botConfig = pgTable("bot_config", {
  id: serial("id").primaryKey(),
  isActive: boolean("is_active").notNull().default(false),
  strategy: text("strategy").notNull().default("momentum"),
  signalTimeframe: text("signal_timeframe").notNull().default("cycle"),
  riskLevel: text("risk_level").notNull().default("medium"),
  activePairs: text("active_pairs").array().notNull().default(["BTC/USD", "ETH/USD", "SOL/USD"]),
  stopLossPercent: decimal("stop_loss_percent", { precision: 5, scale: 2 }).notNull().default("5.00"),
  takeProfitPercent: decimal("take_profit_percent", { precision: 5, scale: 2 }).notNull().default("7.00"),
  trailingStopEnabled: boolean("trailing_stop_enabled").notNull().default(false),
  trailingStopPercent: decimal("trailing_stop_percent", { precision: 5, scale: 2 }).notNull().default("2.00"),
  nonceErrorAlertsEnabled: boolean("nonce_error_alerts_enabled").notNull().default(true),
  dailyLossLimitEnabled: boolean("daily_loss_limit_enabled").notNull().default(true),
  dailyLossLimitPercent: decimal("daily_loss_limit_percent", { precision: 5, scale: 2 }).notNull().default("10.00"),
  maxPairExposurePct: decimal("max_pair_exposure_pct", { precision: 5, scale: 2 }).notNull().default("25.00"),
  maxTotalExposurePct: decimal("max_total_exposure_pct", { precision: 5, scale: 2 }).notNull().default("60.00"),
  riskPerTradePct: decimal("risk_per_trade_pct", { precision: 5, scale: 2 }).notNull().default("15.00"),
  tradingHoursEnabled: boolean("trading_hours_enabled").notNull().default(true),
  tradingHoursStart: decimal("trading_hours_start", { precision: 2, scale: 0 }).notNull().default("8"),
  tradingHoursEnd: decimal("trading_hours_end", { precision: 2, scale: 0 }).notNull().default("22"),
  positionMode: text("position_mode").notNull().default("SINGLE"),
  // SMART_GUARD configuration
  sgMinEntryUsd: decimal("sg_min_entry_usd", { precision: 10, scale: 2 }).notNull().default("100.00"),
  sgAllowUnderMin: boolean("sg_allow_under_min").notNull().default(true),
  sgBeAtPct: decimal("sg_be_at_pct", { precision: 5, scale: 2 }).notNull().default("1.50"),
  sgFeeCushionPct: decimal("sg_fee_cushion_pct", { precision: 5, scale: 2 }).notNull().default("0.45"),
  sgFeeCushionAuto: boolean("sg_fee_cushion_auto").notNull().default(true),
  sgTrailStartPct: decimal("sg_trail_start_pct", { precision: 5, scale: 2 }).notNull().default("2.00"),
  sgTrailDistancePct: decimal("sg_trail_distance_pct", { precision: 5, scale: 2 }).notNull().default("1.50"),
  sgTrailStepPct: decimal("sg_trail_step_pct", { precision: 5, scale: 2 }).notNull().default("0.25"),
  sgTpFixedEnabled: boolean("sg_tp_fixed_enabled").notNull().default(false),
  sgTpFixedPct: decimal("sg_tp_fixed_pct", { precision: 5, scale: 2 }).notNull().default("10.00"),
  sgScaleOutEnabled: boolean("sg_scale_out_enabled").notNull().default(false),
  sgScaleOutPct: decimal("sg_scale_out_pct", { precision: 5, scale: 2 }).notNull().default("35.00"),
  sgMinPartUsd: decimal("sg_min_part_usd", { precision: 10, scale: 2 }).notNull().default("50.00"),
  sgScaleOutThreshold: decimal("sg_scale_out_threshold", { precision: 5, scale: 2 }).notNull().default("80.00"),
  sgMaxOpenLotsPerPair: integer("sg_max_open_lots_per_pair").notNull().default(1),
  // SMART_GUARD pair overrides (JSON: { "BTC/USD": { trailDistancePct: 1.0 }, ... })
  sgPairOverrides: jsonb("sg_pair_overrides"),
  // DRY_RUN mode: audit/verify without sending real orders to exchange
  dryRunMode: boolean("dry_run_mode").notNull().default(false),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

export const apiConfig = pgTable("api_config", {
  id: serial("id").primaryKey(),
  krakenApiKey: text("kraken_api_key"),
  krakenApiSecret: text("kraken_api_secret"),
  krakenConnected: boolean("kraken_connected").notNull().default(false),
  telegramToken: text("telegram_token"),
  telegramChatId: text("telegram_chat_id"),
  telegramConnected: boolean("telegram_connected").notNull().default(false),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

export const trades = pgTable("trades", {
  id: serial("id").primaryKey(),
  tradeId: text("trade_id").notNull().unique(),
  pair: text("pair").notNull(),
  type: text("type").notNull(),
  price: decimal("price", { precision: 18, scale: 8 }).notNull(),
  amount: decimal("amount", { precision: 18, scale: 8 }).notNull(),
  status: text("status").notNull().default("pending"),
  krakenOrderId: text("kraken_order_id").unique(), // UNIQUE para evitar duplicados en sync
  entryPrice: decimal("entry_price", { precision: 18, scale: 8 }),
  realizedPnlUsd: decimal("realized_pnl_usd", { precision: 18, scale: 8 }),
  realizedPnlPct: decimal("realized_pnl_pct", { precision: 10, scale: 4 }),
  executedAt: timestamp("executed_at"),
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

export const notifications = pgTable("notifications", {
  id: serial("id").primaryKey(),
  type: text("type").notNull(),
  message: text("message").notNull(),
  telegramSent: boolean("telegram_sent").notNull().default(false),
  sentAt: timestamp("sent_at"),
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

export const marketData = pgTable("market_data", {
  id: serial("id").primaryKey(),
  pair: text("pair").notNull(),
  price: decimal("price", { precision: 18, scale: 8 }).notNull(),
  volume24h: decimal("volume_24h", { precision: 18, scale: 2 }),
  change24h: decimal("change_24h", { precision: 10, scale: 2 }),
  timestamp: timestamp("timestamp").notNull().defaultNow(),
});

export const telegramChats = pgTable("telegram_chats", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  chatId: text("chat_id").notNull(),
  alertTrades: boolean("alert_trades").notNull().default(true),
  alertErrors: boolean("alert_errors").notNull().default(true),
  alertSystem: boolean("alert_system").notNull().default(true),
  alertBalance: boolean("alert_balance").notNull().default(false),
  alertHeartbeat: boolean("alert_heartbeat").notNull().default(true),
  isActive: boolean("is_active").notNull().default(true),
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

export const botEvents = pgTable("bot_events", {
  id: serial("id").primaryKey(),
  timestamp: timestamp("timestamp").notNull().defaultNow(),
  level: text("level").notNull(),
  type: text("type").notNull(),
  message: text("message").notNull(),
  meta: text("meta"),
});

export const openPositions = pgTable("open_positions", {
  id: serial("id").primaryKey(),
  lotId: text("lot_id").notNull().unique(), // Unique identifier for each lot (multi-lot support)
  pair: text("pair").notNull(), // Removed unique constraint for multi-lot support
  entryPrice: decimal("entry_price", { precision: 18, scale: 8 }).notNull(),
  amount: decimal("amount", { precision: 18, scale: 8 }).notNull(),
  qtyRemaining: decimal("qty_remaining", { precision: 18, scale: 8 }), // Cantidad pendiente de vender (null = amount)
  qtyFilled: decimal("qty_filled", { precision: 18, scale: 8 }).default("0"), // Cantidad ya vendida
  highestPrice: decimal("highest_price", { precision: 18, scale: 8 }).notNull(),
  tradeId: text("trade_id"),
  krakenOrderId: text("kraken_order_id"),
  entryStrategyId: text("entry_strategy_id").notNull().default("momentum_cycle"),
  entrySignalTf: text("entry_signal_tf").notNull().default("cycle"),
  signalConfidence: decimal("signal_confidence", { precision: 5, scale: 2 }),
  signalReason: text("signal_reason"),
  entryMode: text("entry_mode"),
  configSnapshotJson: jsonb("config_snapshot_json"),
  // SMART_GUARD dynamic state
  sgBreakEvenActivated: boolean("sg_break_even_activated").default(false),
  sgCurrentStopPrice: decimal("sg_current_stop_price", { precision: 18, scale: 8 }),
  sgTrailingActivated: boolean("sg_trailing_activated").default(false),
  sgScaleOutDone: boolean("sg_scale_out_done").default(false),
  openedAt: timestamp("opened_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

// Trade fills from Kraken (granular level for partial fills)
export const tradeFills = pgTable("trade_fills", {
  id: serial("id").primaryKey(),
  txid: text("txid").notNull().unique(), // Kraken fill txid (UNIQUE para evitar duplicados)
  orderId: text("order_id").notNull(), // Kraken ordertxid (puede tener m√∫ltiples fills)
  pair: text("pair").notNull(),
  type: text("type").notNull(), // buy/sell
  price: decimal("price", { precision: 18, scale: 8 }).notNull(),
  amount: decimal("amount", { precision: 18, scale: 8 }).notNull(),
  cost: decimal("cost", { precision: 18, scale: 8 }).notNull(),
  fee: decimal("fee", { precision: 18, scale: 8 }).notNull(),
  matched: boolean("matched").notNull().default(false), // Flag para evitar re-procesar
  executedAt: timestamp("executed_at").notNull(),
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

// Lot matches for FIFO matching (audit trail)
export const lotMatches = pgTable("lot_matches", {
  id: serial("id").primaryKey(),
  sellFillTxid: text("sell_fill_txid").notNull(), // Fill txid del SELL
  lotId: text("lot_id").notNull(), // ID del lot (open_position)
  matchedQty: decimal("matched_qty", { precision: 18, scale: 8 }).notNull(),
  buyPrice: decimal("buy_price", { precision: 18, scale: 8 }).notNull(),
  sellPrice: decimal("sell_price", { precision: 18, scale: 8 }).notNull(),
  buyFeeAllocated: decimal("buy_fee_allocated", { precision: 18, scale: 8 }).notNull(),
  sellFeeAllocated: decimal("sell_fee_allocated", { precision: 18, scale: 8 }).notNull(),
  pnlNet: decimal("pnl_net", { precision: 18, scale: 8 }).notNull(),
  createdAt: timestamp("created_at").notNull().defaultNow(),
}, (table) => ({
  sellLotUnique: unique().on(table.sellFillTxid, table.lotId), // UNIQUE(sellFillTxid, lotId) para idempotencia
}));

export const aiTradeSamples = pgTable("ai_trade_samples", {
  id: serial("id").primaryKey(),
  tradeId: text("trade_id").unique().notNull(),
  pair: text("pair").notNull(),
  side: text("side").notNull(),
  entryTs: timestamp("entry_ts").notNull(),
  exitTs: timestamp("exit_ts"),
  entryPrice: decimal("entry_price", { precision: 18, scale: 8 }).notNull(),
  exitPrice: decimal("exit_price", { precision: 18, scale: 8 }),
  feesTotal: decimal("fees_total", { precision: 18, scale: 8 }),
  pnlGross: decimal("pnl_gross", { precision: 18, scale: 8 }),
  pnlNet: decimal("pnl_net", { precision: 18, scale: 8 }),
  labelWin: integer("label_win"),
  featuresJson: jsonb("features_json").notNull(),
  isComplete: boolean("is_complete").default(false),
  createdAt: timestamp("created_at").defaultNow(),
});

export const aiShadowDecisions = pgTable("ai_shadow_decisions", {
  id: serial("id").primaryKey(),
  tradeId: text("trade_id").notNull(),
  ts: timestamp("ts").defaultNow(),
  score: decimal("score", { precision: 5, scale: 4 }).notNull(),
  threshold: decimal("threshold", { precision: 5, scale: 4 }).notNull(),
  wouldBlock: boolean("would_block").notNull(),
  finalPnlNet: decimal("final_pnl_net", { precision: 18, scale: 8 }),
});

export const trainingTrades = pgTable("training_trades", {
  id: serial("id").primaryKey(),
  pair: text("pair").notNull(),
  strategyId: text("strategy_id"),
  buyTxid: text("buy_txid").notNull().unique(), // UNIQUE para evitar duplicados en backfill
  sellTxid: text("sell_txid"),
  sellTxidsJson: jsonb("sell_txids_json"),
  entryPrice: decimal("entry_price", { precision: 18, scale: 8 }).notNull(),
  exitPrice: decimal("exit_price", { precision: 18, scale: 8 }),
  entryAmount: decimal("entry_amount", { precision: 18, scale: 8 }).notNull(),
  exitAmount: decimal("exit_amount", { precision: 18, scale: 8 }),
  qtyRemaining: decimal("qty_remaining", { precision: 18, scale: 8 }),
  entryFee: decimal("entry_fee", { precision: 18, scale: 8 }).notNull().default("0"),
  exitFee: decimal("exit_fee", { precision: 18, scale: 8 }),
  costUsd: decimal("cost_usd", { precision: 18, scale: 8 }).notNull(),
  revenueUsd: decimal("revenue_usd", { precision: 18, scale: 8 }),
  pnlGross: decimal("pnl_gross", { precision: 18, scale: 8 }),
  pnlNet: decimal("pnl_net", { precision: 18, scale: 8 }),
  pnlPct: decimal("pnl_pct", { precision: 10, scale: 4 }),
  holdTimeMinutes: integer("hold_time_minutes"),
  labelWin: integer("label_win"),
  featuresJson: jsonb("features_json"),
  discardReason: text("discard_reason"),
  isClosed: boolean("is_closed").notNull().default(false),
  isLabeled: boolean("is_labeled").notNull().default(false),
  entryTs: timestamp("entry_ts").notNull(),
  exitTs: timestamp("exit_ts"),
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

export const aiConfig = pgTable("ai_config", {
  id: serial("id").primaryKey(),
  filterEnabled: boolean("filter_enabled").default(false),
  shadowEnabled: boolean("shadow_enabled").default(false),
  modelPath: text("model_path"),
  modelVersion: text("model_version"),
  lastTrainTs: timestamp("last_train_ts"),
  lastBackfillTs: timestamp("last_backfill_ts"),
  lastBackfillError: text("last_backfill_error"),
  lastBackfillDiscardReasonsJson: jsonb("last_backfill_discard_reasons_json"),
  lastTrainError: text("last_train_error"),
  nSamples: integer("n_samples").default(0),
  threshold: decimal("threshold", { precision: 5, scale: 4 }).default("0.60"),
  metricsJson: jsonb("metrics_json"),
  updatedAt: timestamp("updated_at").defaultNow(),
});

export const insertBotConfigSchema = createInsertSchema(botConfig).omit({ id: true, updatedAt: true });
export const insertTradeSchema = createInsertSchema(trades).omit({ id: true, createdAt: true });
export const insertNotificationSchema = createInsertSchema(notifications).omit({ id: true, createdAt: true });
export const insertMarketDataSchema = createInsertSchema(marketData).omit({ id: true, timestamp: true });
export const insertApiConfigSchema = createInsertSchema(apiConfig).omit({ id: true, updatedAt: true });
export const insertTelegramChatSchema = createInsertSchema(telegramChats).omit({ id: true, createdAt: true });
export const insertBotEventSchema = createInsertSchema(botEvents).omit({ id: true, timestamp: true });
export const insertOpenPositionSchema = createInsertSchema(openPositions).omit({ id: true, openedAt: true, updatedAt: true });
export const insertAiTradeSampleSchema = createInsertSchema(aiTradeSamples).omit({ id: true, createdAt: true });
export const insertAiShadowDecisionSchema = createInsertSchema(aiShadowDecisions).omit({ id: true, ts: true });
export const insertAiConfigSchema = createInsertSchema(aiConfig).omit({ id: true, updatedAt: true });
export const insertTrainingTradeSchema = createInsertSchema(trainingTrades).omit({ id: true, createdAt: true });
export const insertTradeFillSchema = createInsertSchema(tradeFills).omit({ id: true, createdAt: true });
export const insertLotMatchSchema = createInsertSchema(lotMatches).omit({ id: true, createdAt: true });

export type BotConfig = typeof botConfig.$inferSelect;
export type Trade = typeof trades.$inferSelect;
export type Notification = typeof notifications.$inferSelect;
export type MarketData = typeof marketData.$inferSelect;
export type ApiConfig = typeof apiConfig.$inferSelect;
export type TelegramChat = typeof telegramChats.$inferSelect;
export type BotEvent = typeof botEvents.$inferSelect;
export type OpenPosition = typeof openPositions.$inferSelect;
export type TradeFill = typeof tradeFills.$inferSelect;
export type LotMatch = typeof lotMatches.$inferSelect;
export type AiTradeSample = typeof aiTradeSamples.$inferSelect;
export type AiShadowDecision = typeof aiShadowDecisions.$inferSelect;
export type AiConfig = typeof aiConfig.$inferSelect;
export type TrainingTrade = typeof trainingTrades.$inferSelect;

export type InsertBotConfig = z.infer<typeof insertBotConfigSchema>;
export type InsertTrade = z.infer<typeof insertTradeSchema>;
export type InsertNotification = z.infer<typeof insertNotificationSchema>;
export type InsertMarketData = z.infer<typeof insertMarketDataSchema>;
export type InsertApiConfig = z.infer<typeof insertApiConfigSchema>;
export type InsertTelegramChat = z.infer<typeof insertTelegramChatSchema>;
export type InsertBotEvent = z.infer<typeof insertBotEventSchema>;
export type InsertOpenPosition = z.infer<typeof insertOpenPositionSchema>;
export type InsertTradeFill = z.infer<typeof insertTradeFillSchema>;
export type InsertLotMatch = z.infer<typeof insertLotMatchSchema>;
export type InsertAiTradeSample = z.infer<typeof insertAiTradeSampleSchema>;
export type InsertAiShadowDecision = z.infer<typeof insertAiShadowDecisionSchema>;
export type InsertAiConfig = z.infer<typeof insertAiConfigSchema>;
export type InsertTrainingTrade = z.infer<typeof insertTrainingTradeSchema>;


===== FILE: ./client/src/App.tsx =====
import { Switch, Route } from "wouter";
import { queryClient } from "./lib/queryClient";
import { QueryClientProvider } from "@tanstack/react-query";
import { Toaster } from "@/components/ui/toaster";
import { TooltipProvider } from "@/components/ui/tooltip";
import { EventsWebSocketProvider } from "@/context/EventsWebSocketContext";
import Dashboard from "@/pages/Dashboard";
import Settings from "@/pages/Settings";
import Terminal from "@/pages/Terminal";
import Strategies from "@/pages/Strategies";
import Wallet from "@/pages/Wallet";
import Integrations from "@/pages/Integrations";
import Guide from "@/pages/Guide";
import Monitor from "@/pages/Monitor";
import NotFound from "@/pages/not-found";

function Router() {
  return (
    <Switch>
      <Route path="/" component={Dashboard} />
      <Route path="/settings" component={Settings} />
      <Route path="/terminal" component={Terminal} />
      <Route path="/strategies" component={Strategies} />
      <Route path="/wallet" component={Wallet} />
      <Route path="/integrations" component={Integrations} />
      <Route path="/guide" component={Guide} />
      <Route path="/monitor" component={Monitor} />
      
      <Route component={NotFound} />
    </Switch>
  );
}

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <TooltipProvider>
        <EventsWebSocketProvider>
          <Toaster />
          <Router />
        </EventsWebSocketProvider>
      </TooltipProvider>
    </QueryClientProvider>
  );
}

export default App;


===== FILE: ./client/src/context/EventsWebSocketContext.tsx =====
import { ReactNode } from "react";
import { useEventsWebSocket } from "@/hooks/useEventsWebSocket";

interface EventsWebSocketProviderProps {
  children: ReactNode;
}

export function EventsWebSocketProvider({ children }: EventsWebSocketProviderProps) {
  return <>{children}</>;
}

export function useEventsFeed() {
  return useEventsWebSocket();
}


===== FILE: ./client/src/hooks/useEventsWebSocket.ts =====
import { useState, useEffect, useCallback, useRef, useSyncExternalStore } from "react";

export interface BotEvent {
  id?: number;
  timestamp: string;
  level: "INFO" | "WARN" | "ERROR";
  type: string;
  message: string;
  meta?: Record<string, any> | null;
}

type WsStatus = "connecting" | "connected" | "disconnected" | "reconnecting";

interface WsState {
  events: BotEvent[];
  status: WsStatus;
  error: string | null;
}

type Listener = () => void;

declare global {
  interface Window {
    __eventsWsSingleton?: EventsWebSocketSingleton;
  }
}

class EventsWebSocketSingleton {
  private ws: WebSocket | null = null;
  private state: WsState = { events: [], status: "disconnected", error: null };
  private listeners: Set<Listener> = new Set();
  private reconnectTimeout: NodeJS.Timeout | null = null;
  private reconnectAttempts = 0;
  private flushInterval: NodeJS.Timeout | null = null;
  private eventBuffer: BotEvent[] = [];
  private maxEvents = 500;
  private refCount = 0;
  private lastConnectTime = 0;
  private connectLock = false;

  static getInstance(): EventsWebSocketSingleton {
    if (!window.__eventsWsSingleton) {
      window.__eventsWsSingleton = new EventsWebSocketSingleton();
    }
    return window.__eventsWsSingleton;
  }

  subscribe(listener: Listener): () => void {
    this.listeners.add(listener);
    this.refCount++;
    
    if (this.refCount === 1 && this.state.status === "disconnected") {
      this.connect();
    }
    
    return () => {
      this.listeners.delete(listener);
      this.refCount--;
    };
  }

  getSnapshot(): WsState {
    return this.state;
  }

  private notify(): void {
    this.listeners.forEach(listener => listener());
  }

  private setState(partial: Partial<WsState>): void {
    this.state = { ...this.state, ...partial };
    this.notify();
  }

  private getWsUrl(): string {
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const token = localStorage.getItem("WS_ADMIN_TOKEN") || "";
    return `${protocol}//${window.location.host}/ws/events${token ? `?token=${token}` : ""}`;
  }

  private flushBuffer = (): void => {
    if (this.eventBuffer.length > 0) {
      const newEvents = [...this.eventBuffer, ...this.state.events].slice(0, this.maxEvents);
      this.eventBuffer = [];
      this.setState({ events: newEvents });
    }
  };

  connect(): void {
    if (this.connectLock) return;
    
    if (this.ws?.readyState === WebSocket.OPEN || 
        this.ws?.readyState === WebSocket.CONNECTING) return;

    const now = Date.now();
    if (now - this.lastConnectTime < 2000) {
      if (!this.reconnectTimeout) {
        this.reconnectTimeout = setTimeout(() => {
          this.reconnectTimeout = null;
          this.connect();
        }, 2000 - (now - this.lastConnectTime));
      }
      return;
    }

    this.connectLock = true;
    this.lastConnectTime = now;
    this.setState({ status: "connecting", error: null });

    try {
      const ws = new WebSocket(this.getWsUrl());
      this.ws = ws;

      ws.onopen = () => {
        this.connectLock = false;
        this.setState({ status: "connected", error: null });
        this.reconnectAttempts = 0;

        if (this.flushInterval) clearInterval(this.flushInterval);
        this.flushInterval = setInterval(this.flushBuffer, 300);
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.type === "EVENTS_SNAPSHOT") {
            this.setState({ events: data.payload || [] });
          } else if (data.type === "BOT_EVENT") {
            this.eventBuffer.unshift(data.payload);
          } else if (data.type === "ERROR") {
            this.setState({ error: data.payload?.message || "Error desconocido" });
          }
        } catch (e) {
          console.error("[WS] Error parseando mensaje:", e);
        }
      };

      ws.onclose = (event) => {
        this.ws = null;
        this.connectLock = false;
        
        if (this.flushInterval) {
          clearInterval(this.flushInterval);
          this.flushInterval = null;
        }

        if (event.code !== 4001 && event.code !== 1000 && this.refCount > 0) {
          const delay = Math.max(2000, Math.min(2000 * Math.pow(2, this.reconnectAttempts), 30000));
          this.reconnectAttempts++;
          this.setState({ status: "reconnecting" });
          
          this.reconnectTimeout = setTimeout(() => {
            if (this.refCount > 0) this.connect();
          }, delay);
        } else {
          this.setState({ status: "disconnected" });
        }
      };

      ws.onerror = () => {
        this.setState({ error: "Error de conexi√≥n WebSocket" });
      };
    } catch (e) {
      this.connectLock = false;
      this.setState({ error: "No se pudo establecer conexi√≥n WebSocket", status: "disconnected" });
    }
  }

  disconnect(): void {
    if (this.reconnectTimeout) {
      clearTimeout(this.reconnectTimeout);
      this.reconnectTimeout = null;
    }
    if (this.flushInterval) {
      clearInterval(this.flushInterval);
      this.flushInterval = null;
    }
    if (this.ws) {
      this.ws.close(1000, "User disconnect");
      this.ws = null;
    }
    this.setState({ status: "disconnected" });
  }

  clearEvents(): void {
    this.eventBuffer = [];
    this.setState({ events: [] });
  }
}

interface UseEventsWebSocketOptions {
  maxEvents?: number;
  autoConnect?: boolean;
}

export function useEventsWebSocket(_options: UseEventsWebSocketOptions = {}) {
  const singleton = EventsWebSocketSingleton.getInstance();
  
  const state = useSyncExternalStore(
    (listener) => singleton.subscribe(listener),
    () => singleton.getSnapshot()
  );

  const connect = useCallback(() => singleton.connect(), [singleton]);
  const disconnect = useCallback(() => singleton.disconnect(), [singleton]);
  const clearEvents = useCallback(() => singleton.clearEvents(), [singleton]);

  return {
    events: state.events,
    status: state.status,
    error: state.error,
    connect,
    disconnect,
    clearEvents,
    isConnected: state.status === "connected",
  };
}


===== FILE: ./client/src/hooks/useTerminalWebSocket.ts =====
import { useState, useEffect, useCallback, useRef } from "react";

export interface LogLine {
  id: number;
  timestamp: Date;
  line: string;
  sourceId: string;
  isError?: boolean;
}

export interface LogSource {
  id: string;
  name: string;
  type: "docker_compose" | "docker_container" | "file";
}

type WsStatus = "connecting" | "connected" | "disconnected" | "reconnecting";

interface UseTerminalWebSocketOptions {
  maxLines?: number;
  autoConnect?: boolean;
}

export function useTerminalWebSocket(options: UseTerminalWebSocketOptions = {}) {
  const { maxLines = 500, autoConnect = true } = options;
  
  const [lines, setLines] = useState<LogLine[]>([]);
  const [status, setStatus] = useState<WsStatus>("disconnected");
  const [error, setError] = useState<string | null>(null);
  const [sources, setSources] = useState<LogSource[]>([]);
  const [activeSource, setActiveSource] = useState<string | null>(null);
  const [dockerEnabled, setDockerEnabled] = useState(false);
  const [lineCount, setLineCount] = useState(0);
  const [lastLineTime, setLastLineTime] = useState<Date | null>(null);
  
  const wsRef = useRef<WebSocket | null>(null);
  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const reconnectAttemptsRef = useRef(0);
  const lineIdRef = useRef(0);

  const getWsUrl = useCallback(() => {
    const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
    const token = localStorage.getItem("TERMINAL_TOKEN") || "";
    return `${protocol}//${window.location.host}/ws/logs${token ? `?token=${token}` : ""}`;
  }, []);

  const connect = useCallback(() => {
    if (wsRef.current?.readyState === WebSocket.OPEN) return;

    setStatus("connecting");
    setError(null);

    try {
      const ws = new WebSocket(getWsUrl());
      wsRef.current = ws;

      ws.onopen = () => {
        setStatus("connected");
        setError(null);
        reconnectAttemptsRef.current = 0;
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          switch (data.type) {
            case "WS_STATUS":
              setSources(data.payload.availableSources || []);
              setDockerEnabled(data.payload.dockerEnabled);
              break;
            case "LOG_LINE":
              lineIdRef.current++;
              const newLine: LogLine = {
                id: lineIdRef.current,
                timestamp: new Date(),
                line: data.payload.line,
                sourceId: data.payload.sourceId,
                isError: data.payload.isError,
              };
              setLines((prev) => [...prev, newLine].slice(-maxLines));
              setLineCount((c) => c + 1);
              setLastLineTime(new Date());
              break;
            case "SOURCE_CHANGED":
              setActiveSource(data.payload.sourceId);
              setLines([]);
              setLineCount(0);
              break;
            case "SOURCE_STOPPED":
              setActiveSource(null);
              break;
            case "ERROR":
              setError(data.payload?.message || "Error desconocido");
              break;
          }
        } catch (e) {
          console.error("[WS-LOGS] Error parseando mensaje:", e);
        }
      };

      ws.onclose = (event) => {
        setStatus("disconnected");
        wsRef.current = null;
        setActiveSource(null);

        if (event.code !== 4001 && event.code !== 1000) {
          const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 10000);
          reconnectAttemptsRef.current++;
          setStatus("reconnecting");
          
          reconnectTimeoutRef.current = setTimeout(() => {
            connect();
          }, delay);
        }
      };

      ws.onerror = () => {
        setError("Error de conexi√≥n WebSocket");
      };
    } catch (e) {
      setError("No se pudo establecer conexi√≥n WebSocket");
      setStatus("disconnected");
    }
  }, [getWsUrl, maxLines]);

  const disconnect = useCallback(() => {
    if (reconnectTimeoutRef.current) {
      clearTimeout(reconnectTimeoutRef.current);
      reconnectTimeoutRef.current = null;
    }
    if (wsRef.current) {
      wsRef.current.close(1000, "User disconnect");
      wsRef.current = null;
    }
    setStatus("disconnected");
    setActiveSource(null);
  }, []);

  const startSource = useCallback((sourceId: string) => {
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({ type: "START_SOURCE", sourceId }));
    }
  }, []);

  const stopSource = useCallback(() => {
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({ type: "STOP_SOURCE" }));
    }
  }, []);

  const clearLines = useCallback(() => {
    setLines([]);
    setLineCount(0);
  }, []);

  useEffect(() => {
    if (autoConnect) {
      connect();
    }
    return () => {
      disconnect();
    };
  }, [autoConnect, connect, disconnect]);

  return {
    lines,
    status,
    error,
    sources,
    activeSource,
    dockerEnabled,
    lineCount,
    lastLineTime,
    connect,
    disconnect,
    startSource,
    stopSource,
    clearLines,
    isConnected: status === "connected",
  };
}


===== FILE: ./client/src/hooks/use-toast.ts =====
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType["ADD_TOAST"]
      toast: ToasterToast
    }
  | {
      type: ActionType["UPDATE_TOAST"]
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType["DISMISS_TOAST"]
      toastId?: ToasterToast["id"]
    }
  | {
      type: ActionType["REMOVE_TOAST"]
      toastId?: ToasterToast["id"]
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }


===== FILE: ./client/src/hooks/use-mobile.tsx =====
import * as React from "react"

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener("change", onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener("change", onChange)
  }, [])

  return !!isMobile
}


===== FILE: ./client/src/pages/Terminal.tsx =====
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useState, useMemo } from "react";
import { Nav } from "@/components/dashboard/Nav";
import generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { 
  ArrowUpRight, 
  ArrowDownRight, 
  Clock, 
  DollarSign, 
  TrendingUp, 
  TrendingDown, 
  RefreshCw, 
  ChevronLeft, 
  ChevronRight, 
  Download, 
  Activity, 
  CandlestickChart,
  CircleDot,
  Zap,
  Target,
  BarChart3,
  Layers,
  Square,
  X,
  Loader2,
  Trash2,
  AlertTriangle
} from "lucide-react";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { useToast } from "@/hooks/use-toast";

interface OpenPosition {
  id: number;
  pair: string;
  entryPrice: string;
  amount: string;
  highestPrice: string;
  openedAt: string;
  currentPrice: string;
  unrealizedPnlUsd: string;
  unrealizedPnlPct: string;
  entryValueUsd: string;
  currentValueUsd: string;
  entryStrategyId: string;
  entrySignalTf: string;
  signalConfidence: string | null;
  lotId?: string | null;
  entryMode?: string | null;
}

interface ClosedTrade {
  id: number;
  tradeId: string;
  pair: string;
  type: string;
  price: string;
  amount: string;
  status: string;
  entryPrice: string | null;
  totalUsd: string;
  entryValueUsd: string | null;
  realizedPnlUsd: string | null;
  realizedPnlPct: string | null;
  executedAt: string | null;
  createdAt: string;
}

interface ClosedTradesResponse {
  trades: ClosedTrade[];
  total: number;
  limit: number;
  offset: number;
}

export default function Terminal() {
  const [limit, setLimit] = useState(10);
  const [offset, setOffset] = useState(0);
  const [pairFilter, setPairFilter] = useState<string>("all");
  const [resultFilter, setResultFilter] = useState<string>("all");
  const [typeFilter, setTypeFilter] = useState<string>("all");
  const [syncing, setSyncing] = useState(false);
  const [activeTab, setActiveTab] = useState("positions");
  const [closingKey, setClosingKey] = useState<string | null>(null);
  const [deletingOrphanKey, setDeletingOrphanKey] = useState<string | null>(null);
  const [orphanDialogOpen, setOrphanDialogOpen] = useState(false);
  const [orphanToDelete, setOrphanToDelete] = useState<{ lotId: string; pair: string; amount: string } | null>(null);
  const [dustPositions, setDustPositions] = useState<Set<string>>(new Set());
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const getPositionKey = (pair: string, lotId?: string | null) => lotId || pair;

  const { data: botConfig } = useQuery<{ positionMode?: string; sgMaxOpenLotsPerPair?: number }>({
    queryKey: ["botConfig"],
    queryFn: async () => {
      const res = await fetch("/api/config");
      if (!res.ok) throw new Error("Failed to fetch config");
      return res.json();
    },
    refetchInterval: 60000,
  });

  const { data: openPositions, isLoading: loadingPositions, refetch: refetchPositions, isFetching: fetchingPositions } = useQuery<OpenPosition[]>({
    queryKey: ["openPositions"],
    queryFn: async () => {
      const res = await fetch("/api/open-positions");
      if (!res.ok) throw new Error("Failed to fetch open positions");
      return res.json();
    },
    refetchInterval: 30000,
  });

  const lotsCountByPair = useMemo(() => {
    if (!openPositions) return new Map<string, { count: number; max: number }>();
    const maxLots = botConfig?.sgMaxOpenLotsPerPair || 1;
    const counts = new Map<string, { count: number; max: number }>();
    for (const pos of openPositions) {
      const current = counts.get(pos.pair);
      counts.set(pos.pair, { count: (current?.count || 0) + 1, max: maxLots });
    }
    return counts;
  }, [openPositions, botConfig?.sgMaxOpenLotsPerPair]);

  const getLotsCountByPair = (pair: string) => {
    return lotsCountByPair.get(pair) || { count: 0, max: botConfig?.sgMaxOpenLotsPerPair || 1 };
  };

  const { data: closedData, isLoading: loadingClosed, refetch: refetchClosed, isFetching: fetchingClosed } = useQuery<ClosedTradesResponse>({
    queryKey: ["closedTrades", limit, offset, pairFilter, resultFilter, typeFilter],
    queryFn: async () => {
      const params = new URLSearchParams({
        limit: limit.toString(),
        offset: offset.toString(),
        result: resultFilter,
        type: typeFilter,
      });
      if (pairFilter !== "all") {
        params.set("pair", pairFilter);
      }
      const res = await fetch(`/api/trades/closed?${params}`);
      if (!res.ok) throw new Error("Failed to fetch closed trades");
      return res.json();
    },
  });

  const handleSyncFromKraken = async () => {
    setSyncing(true);
    try {
      const res = await fetch("/api/trades/sync", { method: "POST" });
      const data = await res.json();
      if (res.ok) {
        toast({
          title: "Sincronizado",
          description: `Se importaron ${data.synced} operaciones de Kraken (${data.total} en historial)`,
        });
        refetchClosed();
      } else {
        toast({
          title: "Error",
          description: data.error || "No se pudo sincronizar",
          variant: "destructive",
        });
      }
    } catch (e) {
      toast({
        title: "Error",
        description: "Error de conexi√≥n",
        variant: "destructive",
      });
    } finally {
      setSyncing(false);
    }
  };

  const closePositionMutation = useMutation({
    mutationFn: async ({ pair, lotId, amount }: { pair: string; lotId?: string | null; amount?: string }) => {
      const pairEncoded = pair.replace("/", "-");
      const body: { reason: string; lotId?: string } = { reason: "Cierre manual desde dashboard" };
      if (lotId) body.lotId = lotId;
      const res = await fetch(`/api/positions/${pairEncoded}/close`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      // Check for DUST response (comes as 200 with isDust flag)
      if (data.isDust && lotId) {
        return { ...data, _isDust: true, _lotId: lotId, _pair: pair, _amount: amount };
      }
      if (!res.ok) {
        throw new Error(data.message || "Error al cerrar posici√≥n");
      }
      return data;
    },
    onMutate: ({ pair, lotId }) => {
      setClosingKey(getPositionKey(pair, lotId));
    },
    onSuccess: (data) => {
      // Handle DUST position - show dialog to delete orphan
      if (data._isDust && data._lotId) {
        setDustPositions(prev => new Set(prev).add(data._lotId));
        setOrphanToDelete({ lotId: data._lotId, pair: data._pair, amount: data._amount || "?" });
        setOrphanDialogOpen(true);
        toast({
          title: "Posici√≥n DUST",
          description: data.message || "Balance real menor al m√≠nimo de Kraken",
          variant: "destructive",
        });
        return;
      }
      toast({
        title: data.message?.includes("DRY_RUN") ? "Cierre Simulado" : "Posici√≥n Cerrada",
        description: `${data.pair}: PnL ${parseFloat(data.realizedPnlUsd) >= 0 ? '+' : ''}$${data.realizedPnlUsd} (${parseFloat(data.realizedPnlPct) >= 0 ? '+' : ''}${data.realizedPnlPct}%)`,
      });
      queryClient.invalidateQueries({ queryKey: ["openPositions"] });
      queryClient.invalidateQueries({ queryKey: ["closedTrades"] });
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
    onSettled: () => {
      setClosingKey(null);
    },
  });

  // Mutation for deleting orphan DUST positions
  const deleteOrphanMutation = useMutation({
    mutationFn: async ({ lotId }: { lotId: string }) => {
      const res = await fetch(`/api/positions/${lotId}/orphan`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reason: "orphan_dust_cleanup" }),
      });
      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || "Error al eliminar posici√≥n hu√©rfana");
      }
      return res.json();
    },
    onMutate: ({ lotId }) => {
      setDeletingOrphanKey(lotId);
    },
    onSuccess: (data) => {
      toast({
        title: "Posici√≥n Hu√©rfana Eliminada",
        description: `${data.pair}: Registro interno eliminado (sin orden a Kraken)`,
      });
      setDustPositions(prev => {
        const next = new Set(prev);
        next.delete(data.lotId);
        return next;
      });
      queryClient.invalidateQueries({ queryKey: ["openPositions"] });
      queryClient.invalidateQueries({ queryKey: ["closedTrades"] });
      setOrphanDialogOpen(false);
      setOrphanToDelete(null);
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
    onSettled: () => {
      setDeletingOrphanKey(null);
    },
  });

  // Mutation for reconciling positions with Kraken
  const reconcileMutation = useMutation({
    mutationFn: async ({ autoClean }: { autoClean: boolean }) => {
      const res = await fetch("/api/positions/reconcile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ autoClean }),
      });
      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || "Error al reconciliar");
      }
      return res.json();
    },
    onSuccess: (data) => {
      if (data.cleaned > 0) {
        toast({
          title: "Reconciliaci√≥n Completada",
          description: `${data.cleaned} posiciones hu√©rfanas eliminadas`,
        });
        queryClient.invalidateQueries({ queryKey: ["openPositions"] });
      } else if (data.orphans?.length > 0) {
        toast({
          title: "Hu√©rfanas Detectadas",
          description: `${data.orphans.length} posiciones hu√©rfanas encontradas`,
          variant: "destructive",
        });
      } else {
        toast({
          title: "Todo OK",
          description: "No hay posiciones hu√©rfanas",
        });
      }
    },
    onError: (error: Error) => {
      toast({
        title: "Error",
        description: error.message,
        variant: "destructive",
      });
    },
  });

  const handleClosePosition = (pair: string, lotId?: string | null, amount?: string) => {
    const displayId = lotId ? lotId.substring(0, 8) : pair;
    if (confirm(`¬øCerrar ${lotId ? `lote ${displayId}` : `posici√≥n`} de ${pair}? Esta acci√≥n no se puede deshacer.`)) {
      closePositionMutation.mutate({ pair, lotId, amount });
    }
  };

  const handleDeleteOrphan = (lotId: string, pair: string, amount: string) => {
    setOrphanToDelete({ lotId, pair, amount });
    setOrphanDialogOpen(true);
  };

  const confirmDeleteOrphan = () => {
    if (orphanToDelete) {
      deleteOrphanMutation.mutate({ lotId: orphanToDelete.lotId });
    }
  };

  const handleReconcile = () => {
    if (confirm("¬øReconciliar posiciones con Kraken? Esto eliminar√° autom√°ticamente las posiciones hu√©rfanas (sin balance real).")) {
      reconcileMutation.mutate({ autoClean: true });
    }
  };

  const formatDate = (dateStr: string | null) => {
    if (!dateStr) return "-";
    const date = new Date(dateStr);
    return date.toLocaleDateString("es-ES", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  };

  const formatPrice = (price: string) => {
    const num = parseFloat(price);
    if (num >= 1000) {
      return num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    return num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 6 });
  };

  const formatStrategyLabel = (strategyId: string, timeframe: string) => {
    const strategyMap: Record<string, string> = {
      "momentum": "MOM",
      "momentum_candles_5m": "MOM",
      "momentum_candles_15m": "MOM",
      "momentum_candles_1h": "MOM",
      "mean_reversion": "REV",
      "scalping": "SCA",
      "grid": "GRD",
    };
    const tfMap: Record<string, string> = {
      "cycle": "CYC",
      "5m": "5M",
      "15m": "15M",
      "1h": "1H",
    };
    const strategyName = strategyMap[strategyId] || strategyId.split('_')[0]?.substring(0, 3).toUpperCase() || "MOM";
    const tfLabel = tfMap[timeframe] || timeframe.toUpperCase();
    const isCandles = timeframe !== "cycle";
    return { strategyName, tfLabel, isCandles };
  };

  const totalPages = closedData ? Math.ceil(closedData.total / limit) : 0;
  const currentPage = Math.floor(offset / limit) + 1;

  const handlePrevPage = () => {
    if (offset > 0) {
      setOffset(Math.max(0, offset - limit));
    }
  };

  const handleNextPage = () => {
    if (closedData && offset + limit < closedData.total) {
      setOffset(offset + limit);
    }
  };

  const handleLimitChange = (value: string) => {
    const newLimit = value === "all" ? 1000 : parseInt(value);
    setLimit(newLimit);
    setOffset(0);
  };

  const availablePairs = ["BTC/USD", "ETH/USD", "SOL/USD", "XRP/USD", "TON/USD"];

  const totalUnrealizedPnl = openPositions?.reduce((sum, pos) => sum + parseFloat(pos.unrealizedPnlUsd), 0) || 0;
  const positionsCount = openPositions?.length || 0;

  return (
    <div className="min-h-screen bg-background flex flex-col relative overflow-hidden">
      <div 
        className="fixed inset-0 z-0 opacity-15 pointer-events-none" 
        style={{ 
          backgroundImage: `url(${generatedImage})`, 
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          mixBlendMode: 'overlay'
        }} 
      />
      
      <div className="relative z-10 flex flex-col min-h-screen">
        <Nav />
        
        <main className="flex-1 p-3 md:p-4 lg:p-6 max-w-7xl mx-auto w-full">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
            <div className="flex items-center gap-3">
              <div className="h-10 w-10 bg-gradient-to-br from-cyan-500/20 to-blue-600/20 rounded-lg flex items-center justify-center border border-cyan-500/30">
                <BarChart3 className="h-5 w-5 text-cyan-400" />
              </div>
              <div>
                <h1 className="text-xl md:text-2xl font-bold font-mono tracking-tight text-foreground">TERMINAL</h1>
                <p className="text-xs text-muted-foreground font-mono">POSICIONES Y OPERACIONES</p>
              </div>
            </div>
            
            <div className="flex items-center gap-3">
              <div 
                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border ${
                  botConfig?.positionMode === 'DCA' 
                    ? 'bg-purple-500/10 border-purple-500/30' 
                    : 'bg-amber-500/10 border-amber-500/30'
                }`}
                data-testid="badge-position-mode"
              >
                {botConfig?.positionMode === 'DCA' 
                  ? <Layers className="h-3 w-3 text-purple-400" /> 
                  : <Square className="h-3 w-3 text-amber-400" />
                }
                <span className="font-mono text-xs text-muted-foreground">MODO:</span>
                <span className={`font-mono text-sm font-bold ${
                  botConfig?.positionMode === 'DCA' ? 'text-purple-400' : 'text-amber-400'
                }`}>
                  {botConfig?.positionMode || 'SINGLE'}
                </span>
              </div>
              <div className="flex items-center gap-2 px-3 py-1.5 bg-card/50 rounded-lg border border-border/50">
                <CircleDot className={`h-3 w-3 ${positionsCount > 0 ? 'text-green-400 animate-pulse' : 'text-muted-foreground'}`} />
                <span className="font-mono text-xs text-muted-foreground">ACTIVAS:</span>
                <span className="font-mono text-sm font-bold">{positionsCount}</span>
              </div>
              <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border ${totalUnrealizedPnl >= 0 ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'}`}>
                {totalUnrealizedPnl >= 0 ? <TrendingUp className="h-3 w-3 text-green-400" /> : <TrendingDown className="h-3 w-3 text-red-400" />}
                <span className="font-mono text-xs text-muted-foreground">P&L:</span>
                <span className={`font-mono text-sm font-bold ${totalUnrealizedPnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                  {totalUnrealizedPnl >= 0 ? '+' : ''}${totalUnrealizedPnl.toFixed(2)}
                </span>
              </div>
            </div>
          </div>

          <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
              <TabsList className="bg-card/50 border border-border/50 p-1">
                <TabsTrigger 
                  value="positions" 
                  className="font-mono text-xs data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400"
                  data-testid="tab-positions"
                >
                  <Target className="h-3.5 w-3.5 mr-1.5" />
                  POSICIONES
                </TabsTrigger>
                <TabsTrigger 
                  value="history" 
                  className="font-mono text-xs data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400"
                  data-testid="tab-history"
                >
                  <Activity className="h-3.5 w-3.5 mr-1.5" />
                  HISTORIAL
                </TabsTrigger>
              </TabsList>

              {activeTab === "positions" && (
                <Button 
                  variant="outline" 
                  size="sm" 
                  onClick={() => refetchPositions()}
                  disabled={fetchingPositions}
                  className="font-mono text-xs border-border/50 hover:border-cyan-500/50 hover:text-cyan-400"
                  data-testid="button-refresh-positions"
                >
                  <RefreshCw className={`h-3.5 w-3.5 mr-1.5 ${fetchingPositions ? 'animate-spin' : ''}`} />
                  ACTUALIZAR
                </Button>
              )}

              {activeTab === "history" && (
                <div className="flex flex-wrap items-center gap-2">
                  <Select value={typeFilter} onValueChange={setTypeFilter}>
                    <SelectTrigger className="w-[90px] h-8 text-xs font-mono bg-card/50 border-border/50" data-testid="select-type-filter">
                      <SelectValue placeholder="Tipo" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="all">TODAS</SelectItem>
                      <SelectItem value="buy">COMPRAS</SelectItem>
                      <SelectItem value="sell">VENTAS</SelectItem>
                    </SelectContent>
                  </Select>

                  <Select value={pairFilter} onValueChange={setPairFilter}>
                    <SelectTrigger className="w-[100px] h-8 text-xs font-mono bg-card/50 border-border/50" data-testid="select-pair-filter">
                      <SelectValue placeholder="Par" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="all">TODOS</SelectItem>
                      {availablePairs.map(pair => (
                        <SelectItem key={pair} value={pair}>{pair}</SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  
                  <Select value={resultFilter} onValueChange={setResultFilter}>
                    <SelectTrigger className="w-[100px] h-8 text-xs font-mono bg-card/50 border-border/50" data-testid="select-result-filter">
                      <SelectValue placeholder="Resultado" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="all">TODAS</SelectItem>
                      <SelectItem value="winner">GANADORAS</SelectItem>
                      <SelectItem value="loser">PERDEDORAS</SelectItem>
                    </SelectContent>
                  </Select>

                  <Select value={limit.toString()} onValueChange={handleLimitChange}>
                    <SelectTrigger className="w-[70px] h-8 text-xs font-mono bg-card/50 border-border/50" data-testid="select-limit">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="10">10</SelectItem>
                      <SelectItem value="25">25</SelectItem>
                      <SelectItem value="50">50</SelectItem>
                      <SelectItem value="100">100</SelectItem>
                      <SelectItem value="all">TODO</SelectItem>
                    </SelectContent>
                  </Select>

                  <Button 
                    variant="outline" 
                    size="sm" 
                    onClick={handleSyncFromKraken}
                    disabled={syncing}
                    className="text-xs font-mono border-border/50 hover:border-cyan-500/50 hover:text-cyan-400"
                    data-testid="button-sync-kraken"
                  >
                    <Download className={`h-3.5 w-3.5 mr-1 ${syncing ? 'animate-pulse' : ''}`} />
                    SYNC
                  </Button>

                  <Button 
                    variant="ghost" 
                    size="sm" 
                    onClick={() => refetchClosed()}
                    disabled={fetchingClosed}
                    className="text-muted-foreground hover:text-cyan-400"
                    data-testid="button-refresh-closed"
                  >
                    <RefreshCw className={`h-3.5 w-3.5 ${fetchingClosed ? 'animate-spin' : ''}`} />
                  </Button>
                </div>
              )}
            </div>

            <TabsContent value="positions" className="mt-0">
              <Card className="bg-card/40 border-border/50 backdrop-blur-sm">
                <CardHeader className="py-3 px-4 border-b border-border/30">
                  <div className="flex items-center justify-between">
                    <CardTitle className="text-sm font-mono text-muted-foreground flex items-center gap-2">
                      <Zap className="h-4 w-4 text-cyan-400" />
                      POSICIONES ABIERTAS
                    </CardTitle>
                    <div className="flex items-center gap-3">
                      <span className="text-xs font-mono text-muted-foreground">
                        {openPositions?.length || 0} activa{openPositions?.length !== 1 ? 's' : ''}
                      </span>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={handleReconcile}
                        disabled={reconcileMutation.isPending}
                        className="h-7 text-[10px] font-mono border-orange-500/50 text-orange-400 hover:bg-orange-500/10"
                        data-testid="button-reconcile"
                        title="Compara balances reales de Kraken y elimina posiciones hu√©rfanas"
                      >
                        {reconcileMutation.isPending ? (
                          <Loader2 className="h-3 w-3 animate-spin mr-1" />
                        ) : (
                          <RefreshCw className="h-3 w-3 mr-1" />
                        )}
                        RECONCILIAR
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="p-0">
                  {loadingPositions ? (
                    <div className="flex items-center justify-center py-12">
                      <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cyan-400"></div>
                    </div>
                  ) : openPositions && openPositions.length > 0 ? (
                    <div className="divide-y divide-border/20">
                      {openPositions.map((pos) => {
                        const pnlUsd = parseFloat(pos.unrealizedPnlUsd);
                        const pnlPct = parseFloat(pos.unrealizedPnlPct);
                        const isProfit = pnlUsd >= 0;
                        const strategyInfo = formatStrategyLabel(pos.entryStrategyId || "momentum", pos.entrySignalTf || "cycle");
                        
                        return (
                          <div 
                            key={pos.id}
                            className="flex flex-col lg:flex-row lg:items-center justify-between p-4 hover:bg-white/[0.02] transition-colors"
                            data-testid={`position-row-${pos.id}`}
                          >
                            <div className="flex items-center gap-4 mb-3 lg:mb-0">
                              <div className="relative">
                                <div className={`h-10 w-10 rounded-lg flex items-center justify-center ${isProfit ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
                                  {isProfit ? <TrendingUp className="h-5 w-5 text-green-400" /> : <TrendingDown className="h-5 w-5 text-red-400" />}
                                </div>
                                <div className="absolute -top-1 -right-1 h-3 w-3 bg-green-400 rounded-full border-2 border-background animate-pulse" />
                              </div>
                              <div>
                                <div className="font-mono font-bold text-base flex items-center gap-2">
                                  {pos.pair}
                                  <Badge variant="outline" className={`text-[10px] px-1.5 py-0 font-mono ${strategyInfo.isCandles ? 'border-cyan-500/50 text-cyan-400' : 'border-primary/50 text-primary'}`}>
                                    {strategyInfo.isCandles ? <CandlestickChart className="h-2.5 w-2.5 mr-0.5" /> : <Activity className="h-2.5 w-2.5 mr-0.5" />}
                                    {strategyInfo.strategyName}/{strategyInfo.tfLabel}
                                  </Badge>
                                  {pos.entryMode && (
                                    <Badge variant="outline" className="text-[10px] px-1.5 py-0 font-mono border-orange-500/50 text-orange-400">
                                      <Layers className="h-2.5 w-2.5 mr-0.5" />
                                      {pos.entryMode}
                                    </Badge>
                                  )}
                                </div>
                                <div className="text-xs text-muted-foreground font-mono flex items-center gap-1.5">
                                  <Clock className="h-3 w-3" />
                                  {formatDate(pos.openedAt)}
                                  <span className="text-[10px] opacity-60">| Lote: {pos.lotId?.substring(0, 8) || 'N/A'}</span>
                                  {botConfig?.positionMode === 'SMART_GUARD' && (
                                    <Badge variant="secondary" className="text-[9px] px-1 py-0 ml-1" title="Slots usados / m√°ximo">
                                      {getLotsCountByPair(pos.pair).count}/{getLotsCountByPair(pos.pair).max}
                                    </Badge>
                                  )}
                                </div>
                              </div>
                            </div>
                            
                            <div className="flex items-center gap-4">
                              <div className="grid grid-cols-3 sm:grid-cols-6 gap-3 lg:gap-4 flex-1">
                                <div>
                                  <div className="font-mono text-[10px] text-muted-foreground uppercase">Cantidad</div>
                                  <div className="font-mono font-medium text-sm">{parseFloat(pos.amount).toFixed(6)}</div>
                                </div>
                                <div>
                                  <div className="font-mono text-[10px] text-muted-foreground uppercase">Precio Entrada</div>
                                  <div className="font-mono font-medium text-sm">${formatPrice(pos.entryPrice)}</div>
                                </div>
                                <div>
                                  <div className="font-mono text-[10px] text-muted-foreground uppercase" title="Valor de entrada en USD">Valor Entrada</div>
                                  <div className="font-mono font-medium text-sm text-blue-400">${parseFloat(pos.entryValueUsd).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                </div>
                                <div>
                                  <div className="font-mono text-[10px] text-muted-foreground uppercase">Precio Actual</div>
                                  <div className="font-mono font-medium text-sm">${formatPrice(pos.currentPrice)}</div>
                                </div>
                                <div>
                                  <div className="font-mono text-[10px] text-muted-foreground uppercase" title="Valor actual en USD">Valor Actual</div>
                                  <div className="font-mono font-medium text-sm text-cyan-400">${parseFloat(pos.currentValueUsd).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                </div>
                                <div>
                                  <div className="font-mono text-[10px] text-muted-foreground uppercase">P&L</div>
                                  <div className={`font-mono font-bold text-sm flex items-center gap-1 ${isProfit ? 'text-green-400' : 'text-red-400'}`}>
                                    {isProfit ? '+' : '-'}${Math.abs(pnlUsd).toFixed(2)}
                                    <span className="text-xs opacity-75">({pnlPct >= 0 ? '+' : ''}{pnlPct.toFixed(2)}%)</span>
                                  </div>
                                </div>
                              </div>
                              <div className="flex gap-2 shrink-0">
                                <Button
                                  variant="destructive"
                                  size="sm"
                                  onClick={() => handleClosePosition(pos.pair, pos.lotId, pos.amount)}
                                  disabled={closingKey === getPositionKey(pos.pair, pos.lotId)}
                                  data-testid={`button-close-position-${pos.lotId || pos.id}`}
                                >
                                  {closingKey === getPositionKey(pos.pair, pos.lotId) ? (
                                    <Loader2 className="h-4 w-4 animate-spin" />
                                  ) : (
                                    <X className="h-4 w-4" />
                                  )}
                                  <span className="hidden sm:inline ml-1">Cerrar</span>
                                </Button>
                                {pos.lotId && dustPositions.has(pos.lotId) && (
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => handleDeleteOrphan(pos.lotId!, pos.pair, pos.amount)}
                                    disabled={deletingOrphanKey === pos.lotId}
                                    className="text-orange-400 border-orange-400/50 hover:bg-orange-400/10"
                                    data-testid={`button-delete-orphan-${pos.lotId}`}
                                    title="Eliminar registro interno sin enviar orden a Kraken"
                                  >
                                    {deletingOrphanKey === pos.lotId ? (
                                      <Loader2 className="h-4 w-4 animate-spin" />
                                    ) : (
                                      <Trash2 className="h-4 w-4" />
                                    )}
                                    <span className="hidden lg:inline ml-1">Hu√©rfana</span>
                                  </Button>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="text-center py-16">
                      <div className="h-16 w-16 mx-auto bg-muted/20 rounded-full flex items-center justify-center mb-4">
                        <Target className="h-8 w-8 text-muted-foreground/50" />
                      </div>
                      <p className="font-mono text-muted-foreground text-sm">NO HAY POSICIONES ABIERTAS</p>
                      <p className="text-xs text-muted-foreground mt-1">Las posiciones aparecer√°n cuando el bot compre activos</p>
                    </div>
                  )}
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="history" className="mt-0">
              <Card className="bg-card/40 border-border/50 backdrop-blur-sm">
                <CardHeader className="py-3 px-4 border-b border-border/30">
                  <div className="flex items-center justify-between">
                    <CardTitle className="text-sm font-mono text-muted-foreground flex items-center gap-2">
                      <Activity className="h-4 w-4 text-cyan-400" />
                      HISTORIAL DE OPERACIONES
                    </CardTitle>
                    <span className="text-xs font-mono text-muted-foreground">
                      {closedData?.total || 0} operaciones
                    </span>
                  </div>
                </CardHeader>
                <CardContent className="p-0">
                  {loadingClosed ? (
                    <div className="flex items-center justify-center py-16">
                      <div className="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cyan-400"></div>
                    </div>
                  ) : closedData && closedData.trades.length > 0 ? (
                    <>
                      <div className="overflow-x-auto">
                        <table className="w-full min-w-[900px]">
                          <thead>
                            <tr className="border-b border-border/30 text-left">
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal">Tipo</th>
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal">Par</th>
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal">Fecha</th>
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right">Cantidad</th>
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right">Precio</th>
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right" title="Valor total de la operaci√≥n en USD">Total USD</th>
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right">P&L</th>
                              <th className="py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-center">Estado</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-border/20">
                            {closedData.trades.map((trade) => {
                              const pnlUsd = trade.realizedPnlUsd ? parseFloat(trade.realizedPnlUsd) : null;
                              const pnlPct = trade.realizedPnlPct ? parseFloat(trade.realizedPnlPct) : null;
                              const isProfit = pnlUsd !== null && pnlUsd >= 0;
                              
                              return (
                                <tr 
                                  key={trade.id}
                                  className="hover:bg-white/[0.02] transition-colors"
                                  data-testid={`closed-trade-row-${trade.id}`}
                                >
                                  <td className="py-3 px-3">
                                    <div className={`inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs font-mono font-bold ${trade.type === 'buy' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`}>
                                      {trade.type === 'buy' ? <ArrowUpRight className="h-3 w-3" /> : <ArrowDownRight className="h-3 w-3" />}
                                      {trade.type === 'buy' ? 'BUY' : 'SELL'}
                                    </div>
                                  </td>
                                  <td className="py-3 px-3">
                                    <span className="font-mono font-medium text-sm">{trade.pair}</span>
                                  </td>
                                  <td className="py-3 px-3">
                                    <span className="font-mono text-xs text-muted-foreground">{formatDate(trade.executedAt || trade.createdAt)}</span>
                                  </td>
                                  <td className="py-3 px-3 text-right">
                                    <span className="font-mono text-sm">{parseFloat(trade.amount).toFixed(6)}</span>
                                  </td>
                                  <td className="py-3 px-3 text-right">
                                    <span className="font-mono text-sm">${formatPrice(trade.price)}</span>
                                  </td>
                                  <td className="py-3 px-3 text-right">
                                    <span className="font-mono text-sm font-medium text-cyan-400" title="Cantidad √ó Precio">
                                      ${parseFloat(trade.totalUsd).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                    </span>
                                  </td>
                                  <td className="py-3 px-3 text-right">
                                    {pnlUsd !== null ? (
                                      <span className={`font-mono font-bold text-sm ${isProfit ? 'text-green-400' : 'text-red-400'}`}>
                                        {isProfit ? '+' : ''}${pnlUsd.toFixed(2)}
                                        <span className="text-xs opacity-75 ml-1">
                                          ({pnlPct !== null ? (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(1) : '0'}%)
                                        </span>
                                      </span>
                                    ) : (
                                      <span className="font-mono text-sm text-muted-foreground">-</span>
                                    )}
                                  </td>
                                  <td className="py-3 px-3 text-center">
                                    <Badge 
                                      variant="outline"
                                      className={`font-mono text-[10px] ${
                                        trade.status === 'filled' 
                                          ? 'border-green-500/50 text-green-400 bg-green-500/10' 
                                          : trade.status === 'pending' 
                                            ? 'border-yellow-500/50 text-yellow-400 bg-yellow-500/10' 
                                            : 'border-red-500/50 text-red-400 bg-red-500/10'
                                      }`}
                                    >
                                      {trade.status === 'filled' ? 'OK' : trade.status.toUpperCase()}
                                    </Badge>
                                  </td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>

                      {totalPages > 1 && (
                        <div className="flex items-center justify-between p-4 border-t border-border/30">
                          <span className="text-xs font-mono text-muted-foreground">
                            {offset + 1}-{Math.min(offset + limit, closedData.total)} de {closedData.total}
                          </span>
                          <div className="flex items-center gap-2">
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={handlePrevPage}
                              disabled={offset === 0}
                              className="h-7 px-2 font-mono text-xs border-border/50"
                              data-testid="button-prev-page"
                            >
                              <ChevronLeft className="h-3.5 w-3.5" />
                            </Button>
                            <span className="text-xs font-mono text-muted-foreground px-2">
                              {currentPage}/{totalPages}
                            </span>
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={handleNextPage}
                              disabled={offset + limit >= closedData.total}
                              className="h-7 px-2 font-mono text-xs border-border/50"
                              data-testid="button-next-page"
                            >
                              <ChevronRight className="h-3.5 w-3.5" />
                            </Button>
                          </div>
                        </div>
                      )}
                    </>
                  ) : (
                    <div className="text-center py-16">
                      <div className="h-16 w-16 mx-auto bg-muted/20 rounded-full flex items-center justify-center mb-4">
                        <Clock className="h-8 w-8 text-muted-foreground/50" />
                      </div>
                      <p className="font-mono text-muted-foreground text-sm">NO HAY OPERACIONES</p>
                      <p className="text-xs text-muted-foreground mt-1">Las operaciones aparecer√°n cuando el bot venda activos</p>
                    </div>
                  )}
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>
        </main>
      </div>

      {/* Dialog de confirmaci√≥n para eliminar posici√≥n hu√©rfana */}
      <AlertDialog open={orphanDialogOpen} onOpenChange={setOrphanDialogOpen}>
        <AlertDialogContent className="bg-card border-border">
          <AlertDialogHeader>
            <AlertDialogTitle className="flex items-center gap-2 text-orange-400">
              <AlertTriangle className="h-5 w-5" />
              Eliminar Posici√≥n Hu√©rfana
            </AlertDialogTitle>
            <AlertDialogDescription className="space-y-3">
              <p>
                Esta acci√≥n <strong>solo elimina el registro interno</strong> del bot (base de datos).
                <strong> NO env√≠a ninguna orden a Kraken.</strong>
              </p>
              {orphanToDelete && (
                <div className="bg-muted/30 rounded-md p-3 font-mono text-sm">
                  <div><span className="text-muted-foreground">Par:</span> {orphanToDelete.pair}</div>
                  <div><span className="text-muted-foreground">Lote:</span> {orphanToDelete.lotId.substring(0, 12)}...</div>
                  <div><span className="text-muted-foreground">Cantidad:</span> {parseFloat(orphanToDelete.amount).toFixed(8)}</div>
                </div>
              )}
              <p className="text-orange-400 text-sm">
                √ösalo cuando el balance real en Kraken sea menor al m√≠nimo (posici√≥n DUST) 
                o cuando ya vendiste manualmente fuera del bot.
              </p>
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={confirmDeleteOrphan}
              className="bg-orange-500 hover:bg-orange-600"
              disabled={deleteOrphanMutation.isPending}
            >
              {deleteOrphanMutation.isPending ? (
                <Loader2 className="h-4 w-4 animate-spin mr-2" />
              ) : (
                <Trash2 className="h-4 w-4 mr-2" />
              )}
              Eliminar de BD
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}


===== FILE: ./client/src/pages/Strategies.tsx =====
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Nav } from "@/components/dashboard/Nav";
import { Ticker } from "@/components/dashboard/Ticker";
import generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import { Slider } from "@/components/ui/slider";
import { Activity, TrendingUp, TrendingDown, Zap, Shield, Target, RefreshCw, AlertTriangle, CircleDollarSign, PieChart, Wallet, Clock, CandlestickChart } from "lucide-react";
import { toast } from "sonner";

interface BotConfig {
  id: number;
  isActive: boolean;
  strategy: string;
  signalTimeframe: string;
  riskLevel: string;
  activePairs: string[];
  stopLossPercent: string;
  takeProfitPercent: string;
  trailingStopEnabled: boolean;
  trailingStopPercent: string;
  maxPairExposurePct: string;
  maxTotalExposurePct: string;
  riskPerTradePct: string;
}

const STRATEGIES = [
  { id: "momentum", name: "Momentum", description: "Sigue tendencias fuertes del mercado", icon: TrendingUp },
  { id: "mean_reversion", name: "Reversi√≥n a la Media", description: "Opera cuando el precio se aleja de promedios", icon: RefreshCw },
  { id: "scalping", name: "Scalping", description: "Operaciones r√°pidas con peque√±as ganancias", icon: Zap },
  { id: "grid", name: "Grid Trading", description: "√ìrdenes escalonadas en rangos de precio", icon: Target },
];

const SIGNAL_TIMEFRAMES = [
  { id: "cycle", name: "Ciclos (30s)", description: "Eval√∫a cada ciclo del bot (~30 segundos)" },
  { id: "5m", name: "Velas 5 min", description: "Eval√∫a solo al cierre de velas de 5 minutos" },
  { id: "15m", name: "Velas 15 min", description: "Eval√∫a solo al cierre de velas de 15 minutos" },
  { id: "1h", name: "Velas 1 hora", description: "Eval√∫a solo al cierre de velas de 1 hora" },
];

const RISK_LEVELS = [
  { id: "low", name: "Bajo", description: "Posiciones peque√±as, stops ajustados", color: "text-green-500" },
  { id: "medium", name: "Medio", description: "Balance entre riesgo y rendimiento", color: "text-yellow-500" },
  { id: "high", name: "Alto", description: "Posiciones grandes, mayor volatilidad", color: "text-red-500" },
];

const AVAILABLE_PAIRS = ["BTC/USD", "ETH/USD", "SOL/USD", "ETH/BTC", "XRP/USD", "TON/USD"];

export default function Strategies() {
  const queryClient = useQueryClient();

  const { data: config, isLoading } = useQuery<BotConfig>({
    queryKey: ["botConfig"],
    queryFn: async () => {
      const res = await fetch("/api/config");
      if (!res.ok) throw new Error("Failed to fetch config");
      return res.json();
    },
  });

  const updateMutation = useMutation({
    mutationFn: async (updates: Partial<BotConfig>) => {
      const res = await fetch("/api/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates),
      });
      if (!res.ok) throw new Error("Failed to update config");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["botConfig"] });
      toast.success("Configuraci√≥n actualizada");
    },
    onError: () => {
      toast.error("Error al actualizar configuraci√≥n");
    },
  });

  const togglePair = (pair: string) => {
    const currentPairs = config?.activePairs || [];
    const newPairs = currentPairs.includes(pair)
      ? currentPairs.filter(p => p !== pair)
      : [...currentPairs, pair];
    updateMutation.mutate({ activePairs: newPairs });
  };

  return (
    <div className="min-h-screen bg-background flex flex-col relative overflow-hidden">
      <div 
        className="fixed inset-0 z-0 opacity-20 pointer-events-none" 
        style={{ 
          backgroundImage: `url(${generatedImage})`, 
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          mixBlendMode: 'overlay'
        }} 
      />
      
      <div className="relative z-10 flex flex-col min-h-screen">
        <Nav />
        <Ticker />
        
        <main className="flex-1 p-4 md:p-6 max-w-6xl mx-auto w-full space-y-4 md:space-y-6">
          <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl md:text-3xl font-bold font-sans tracking-tight">Estrategias de Trading</h1>
              <p className="text-sm md:text-base text-muted-foreground mt-1">Configura el comportamiento del bot aut√≥nomo.</p>
            </div>
            <div className="flex items-center gap-3 md:gap-4">
              <span className="text-xs md:text-sm text-muted-foreground">Bot Activo</span>
              <Switch
                checked={config?.isActive || false}
                onCheckedChange={(checked) => updateMutation.mutate({ isActive: checked })}
                data-testid="switch-bot-active"
              />
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <CardTitle className="flex items-center gap-2 text-base md:text-lg">
                  <Activity className="h-4 w-4 md:h-5 md:w-5 text-primary" />
                  Estrategia Activa
                </CardTitle>
                <CardDescription>Selecciona el algoritmo de trading</CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                {STRATEGIES.map((strategy) => (
                  <div
                    key={strategy.id}
                    onClick={() => updateMutation.mutate({ strategy: strategy.id })}
                    className={`p-4 rounded-lg border cursor-pointer transition-all ${
                      config?.strategy === strategy.id
                        ? "border-primary bg-primary/10"
                        : "border-border/50 hover:border-border"
                    }`}
                    data-testid={`strategy-${strategy.id}`}
                  >
                    <div className="flex items-center gap-3">
                      <div className={`p-2 rounded-lg ${config?.strategy === strategy.id ? "bg-primary/20" : "bg-muted"}`}>
                        <strategy.icon className={`h-5 w-5 ${config?.strategy === strategy.id ? "text-primary" : "text-muted-foreground"}`} />
                      </div>
                      <div className="flex-1">
                        <div className="font-medium">{strategy.name}</div>
                        <div className="text-sm text-muted-foreground">{strategy.description}</div>
                      </div>
                      {config?.strategy === strategy.id && (
                        <Badge variant="default" className="font-mono">ACTIVO</Badge>
                      )}
                    </div>
                  </div>
                ))}
              </CardContent>
            </Card>

            {config?.strategy === "momentum" && (
              <Card className="glass-panel border-border/50 border-cyan-500/30">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2 text-base md:text-lg">
                    <CandlestickChart className="h-4 w-4 md:h-5 md:w-5 text-cyan-500" />
                    Modo de Se√±al (Momentum)
                  </CardTitle>
                  <CardDescription>Define cu√°ndo el bot eval√∫a se√±ales de trading</CardDescription>
                </CardHeader>
                <CardContent className="space-y-3">
                  {SIGNAL_TIMEFRAMES.map((tf) => (
                    <div
                      key={tf.id}
                      onClick={() => updateMutation.mutate({ signalTimeframe: tf.id } as any)}
                      className={`p-3 rounded-lg border cursor-pointer transition-all ${
                        config?.signalTimeframe === tf.id
                          ? "border-cyan-500 bg-cyan-500/10"
                          : "border-border/50 hover:border-border"
                      }`}
                      data-testid={`timeframe-${tf.id}`}
                    >
                      <div className="flex items-center gap-3">
                        <div className={`p-2 rounded-lg ${config?.signalTimeframe === tf.id ? "bg-cyan-500/20" : "bg-muted"}`}>
                          {tf.id === "cycle" ? (
                            <Clock className={`h-4 w-4 ${config?.signalTimeframe === tf.id ? "text-cyan-500" : "text-muted-foreground"}`} />
                          ) : (
                            <CandlestickChart className={`h-4 w-4 ${config?.signalTimeframe === tf.id ? "text-cyan-500" : "text-muted-foreground"}`} />
                          )}
                        </div>
                        <div className="flex-1">
                          <div className="font-medium text-sm">{tf.name}</div>
                          <div className="text-xs text-muted-foreground">{tf.description}</div>
                        </div>
                        {config?.signalTimeframe === tf.id && (
                          <Badge variant="outline" className="font-mono text-cyan-500 border-cyan-500/50">ACTIVO</Badge>
                        )}
                      </div>
                    </div>
                  ))}
                  <div className="bg-cyan-500/10 rounded-lg p-3 mt-3 border border-cyan-500/20">
                    <p className="text-xs text-muted-foreground">
                      <strong className="text-cyan-500">Velas:</strong> Usa an√°lisis OHLC (EMA, RSI, MACD, patrones de velas) y solo opera al cierre de cada vela.
                      <br /><strong className="text-cyan-500">Ciclos:</strong> Eval√∫a precios en tiempo real cada 30 segundos.
                    </p>
                  </div>
                </CardContent>
              </Card>
            )}

            <div className="space-y-6">
              <Card className="glass-panel border-border/50">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Shield className="h-5 w-5 text-primary" />
                    Nivel de Riesgo
                  </CardTitle>
                  <CardDescription>Define el tama√±o de posiciones</CardDescription>
                </CardHeader>
                <CardContent>
                  <Select
                    value={config?.riskLevel || "medium"}
                    onValueChange={(value) => updateMutation.mutate({ riskLevel: value })}
                  >
                    <SelectTrigger data-testid="select-risk-level">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {RISK_LEVELS.map((level) => (
                        <SelectItem key={level.id} value={level.id}>
                          <div className="flex items-center gap-2">
                            <span className={level.color}>{level.name}</span>
                            <span className="text-muted-foreground text-xs">- {level.description}</span>
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </CardContent>
              </Card>

              <Card className="glass-panel border-border/50">
                <CardHeader>
                  <CardTitle className="flex items-center gap-2">
                    <Target className="h-5 w-5 text-primary" />
                    Pares de Trading
                  </CardTitle>
                  <CardDescription>Activa/desactiva pares para operar</CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="flex flex-wrap gap-2">
                    {AVAILABLE_PAIRS.map((pair) => {
                      const isActive = config?.activePairs?.includes(pair);
                      return (
                        <Button
                          key={pair}
                          variant={isActive ? "default" : "outline"}
                          size="sm"
                          onClick={() => togglePair(pair)}
                          className="font-mono"
                          data-testid={`pair-toggle-${pair.replace("/", "-")}`}
                        >
                          {pair}
                        </Button>
                      );
                    })}
                  </div>
                </CardContent>
              </Card>

              <Card className="glass-panel border-border/50 border-yellow-500/30">
                <CardContent className="pt-6">
                  <div className="flex items-start gap-3">
                    <div className="p-2 bg-yellow-500/20 rounded-lg">
                      <Zap className="h-5 w-5 text-yellow-500" />
                    </div>
                    <div>
                      <h4 className="font-medium text-yellow-500">Modo REAL Activado</h4>
                      <p className="text-sm text-muted-foreground mt-1">
                        Todas las operaciones se ejecutan con dinero real en Kraken. 
                        No hay modo simulaci√≥n.
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>

          <Card className="glass-panel border-border/50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <AlertTriangle className="h-5 w-5 text-primary" />
                Control de Riesgo Autom√°tico
              </CardTitle>
              <CardDescription>Configura stop-loss, take-profit y trailing stop para proteger tu capital</CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div className="space-y-3 md:space-y-4">
                  <div className="flex items-center justify-between">
                    <Label className="flex items-center gap-2 text-sm">
                      <div className="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-red-500" />
                      Stop-Loss
                    </Label>
                    <span className="font-mono text-lg text-red-500">-{parseFloat(config?.stopLossPercent || "5").toFixed(1)}%</span>
                  </div>
                  <Slider
                    value={[parseFloat(config?.stopLossPercent || "5")]}
                    onValueChange={(value) => updateMutation.mutate({ stopLossPercent: value[0].toString() } as any)}
                    min={1}
                    max={20}
                    step={0.5}
                    className="[&>span]:bg-red-500"
                    data-testid="slider-stop-loss"
                  />
                  <p className="text-xs text-muted-foreground">Vende autom√°ticamente si el precio baja este porcentaje desde tu entrada.</p>
                </div>

                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <Label className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-green-500" />
                      Take-Profit
                    </Label>
                    <span className="font-mono text-lg text-green-500">+{parseFloat(config?.takeProfitPercent || "7").toFixed(1)}%</span>
                  </div>
                  <Slider
                    value={[parseFloat(config?.takeProfitPercent || "7")]}
                    onValueChange={(value) => updateMutation.mutate({ takeProfitPercent: value[0].toString() } as any)}
                    min={1}
                    max={30}
                    step={0.5}
                    className="[&>span]:bg-green-500"
                    data-testid="slider-take-profit"
                  />
                  <p className="text-xs text-muted-foreground">Vende autom√°ticamente cuando alcanzas este porcentaje de ganancia.</p>
                </div>
              </div>

              <div className="border-t border-border/50 pt-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <Label className="flex items-center gap-2">
                      <CircleDollarSign className="h-4 w-4 text-cyan-500" />
                      Trailing Stop
                    </Label>
                    <p className="text-xs text-muted-foreground mt-1">Stop-loss que sube con el precio para asegurar ganancias</p>
                  </div>
                  <Switch
                    checked={config?.trailingStopEnabled || false}
                    onCheckedChange={(checked) => updateMutation.mutate({ trailingStopEnabled: checked } as any)}
                    data-testid="switch-trailing-stop"
                  />
                </div>

                {config?.trailingStopEnabled && (
                  <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                    <div className="flex items-center justify-between">
                      <Label>Distancia del Trailing</Label>
                      <span className="font-mono text-lg text-cyan-500">{parseFloat(config?.trailingStopPercent || "2").toFixed(1)}%</span>
                    </div>
                    <Slider
                      value={[parseFloat(config?.trailingStopPercent || "2")]}
                      onValueChange={(value) => updateMutation.mutate({ trailingStopPercent: value[0].toString() } as any)}
                      min={0.5}
                      max={10}
                      step={0.5}
                      className="[&>span]:bg-cyan-500"
                      data-testid="slider-trailing-stop"
                    />
                    <p className="text-xs text-muted-foreground">
                      Si el precio sube y luego cae este porcentaje desde el m√°ximo, se vende autom√°ticamente (solo si est√°s en ganancia).
                    </p>
                  </div>
                )}
              </div>

              <div className="bg-muted/30 rounded-lg p-4 mt-4">
                <h4 className="font-medium text-sm mb-2">Ejemplo con configuraci√≥n actual:</h4>
                <p className="text-xs text-muted-foreground">
                  Si compras BTC a $100,000:
                  <br />‚Ä¢ <span className="text-red-500">Stop-Loss:</span> Se vende si baja a ${(100000 * (1 - parseFloat(config?.stopLossPercent || "5") / 100)).toLocaleString()}
                  <br />‚Ä¢ <span className="text-green-500">Take-Profit:</span> Se vende si sube a ${(100000 * (1 + parseFloat(config?.takeProfitPercent || "7") / 100)).toLocaleString()}
                  {config?.trailingStopEnabled && (
                    <>
                      <br />‚Ä¢ <span className="text-cyan-500">Trailing Stop:</span> Si sube a $105,000 y luego cae {config?.trailingStopPercent}%, se vende a ${(105000 * (1 - parseFloat(config?.trailingStopPercent || "2") / 100)).toLocaleString()}
                    </>
                  )}
                </p>
              </div>
            </CardContent>
          </Card>

          <Card className="glass-panel border-border/50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Wallet className="h-5 w-5 text-primary" />
                Tama√±o de Trade
              </CardTitle>
              <CardDescription>Define qu√© porcentaje del balance se usa en cada operaci√≥n</CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="space-y-3 md:space-y-4">
                <div className="flex items-center justify-between">
                  <Label className="flex items-center gap-2 text-sm">
                    <div className="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-blue-500" />
                    Riesgo por Trade
                  </Label>
                  <span className="font-mono text-lg text-blue-500">{parseFloat(config?.riskPerTradePct || "15").toFixed(0)}%</span>
                </div>
                <Slider
                  value={[parseFloat(config?.riskPerTradePct || "15")]}
                  onValueChange={(value) => updateMutation.mutate({ riskPerTradePct: value[0].toString() } as any)}
                  min={5}
                  max={100}
                  step={5}
                  className="[&>span]:bg-blue-500"
                  data-testid="slider-risk-per-trade"
                />
                <p className="text-xs text-muted-foreground">Porcentaje del balance USD que se usar√° en cada operaci√≥n de compra.</p>
              </div>

              <div className="bg-muted/30 rounded-lg p-4 mt-4">
                <h4 className="font-medium text-sm mb-2">Ejemplo con balance de $100:</h4>
                <p className="text-xs text-muted-foreground">
                  ‚Ä¢ <span className="text-blue-500">Tama√±o del trade:</span> ${parseFloat(config?.riskPerTradePct || "15")} por operaci√≥n
                  <br />‚Ä¢ Si el m√≠nimo de Kraken es mayor, se ajustar√° autom√°ticamente.
                  <br />‚Ä¢ Los l√≠mites de exposici√≥n se verifican antes de ejecutar.
                </p>
              </div>
            </CardContent>
          </Card>

          <Card className="glass-panel border-border/50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <PieChart className="h-5 w-5 text-primary" />
                Control de Exposici√≥n
              </CardTitle>
              <CardDescription>Limita cu√°nto capital puede estar comprometido en posiciones abiertas</CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                <div className="space-y-3 md:space-y-4">
                  <div className="flex items-center justify-between">
                    <Label className="flex items-center gap-2 text-sm">
                      <div className="w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-orange-500" />
                      M√°x. Exposici√≥n por Par
                    </Label>
                    <span className="font-mono text-lg text-orange-500">{parseFloat(config?.maxPairExposurePct || "25").toFixed(0)}%</span>
                  </div>
                  <Slider
                    value={[parseFloat(config?.maxPairExposurePct || "25")]}
                    onValueChange={(value) => updateMutation.mutate({ maxPairExposurePct: value[0].toString() } as any)}
                    min={5}
                    max={100}
                    step={5}
                    className="[&>span]:bg-orange-500"
                    data-testid="slider-max-pair-exposure"
                  />
                  <p className="text-xs text-muted-foreground">M√°ximo % del balance que puede estar en un solo par (ej: solo BTC/USD).</p>
                </div>

                <div className="space-y-4">
                  <div className="flex items-center justify-between">
                    <Label className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-purple-500" />
                      M√°x. Exposici√≥n Total
                    </Label>
                    <span className="font-mono text-lg text-purple-500">{parseFloat(config?.maxTotalExposurePct || "60").toFixed(0)}%</span>
                  </div>
                  <Slider
                    value={[parseFloat(config?.maxTotalExposurePct || "60")]}
                    onValueChange={(value) => updateMutation.mutate({ maxTotalExposurePct: value[0].toString() } as any)}
                    min={10}
                    max={100}
                    step={5}
                    className="[&>span]:bg-purple-500"
                    data-testid="slider-max-total-exposure"
                  />
                  <p className="text-xs text-muted-foreground">M√°ximo % del balance que puede estar en todas las posiciones abiertas.</p>
                </div>
              </div>

              <div className="bg-muted/30 rounded-lg p-4 mt-4">
                <h4 className="font-medium text-sm mb-2">Ejemplo con balance de $100:</h4>
                <p className="text-xs text-muted-foreground">
                  ‚Ä¢ <span className="text-orange-500">Por par:</span> M√°ximo ${parseFloat(config?.maxPairExposurePct || "25")} en cada par individual
                  <br />‚Ä¢ <span className="text-purple-500">Total:</span> M√°ximo ${parseFloat(config?.maxTotalExposurePct || "60")} en todas las posiciones combinadas
                  <br />‚Ä¢ Si se alcanza alg√∫n l√≠mite, el bot NO abrir√° nuevas posiciones y te notificar√°.
                </p>
              </div>
            </CardContent>
          </Card>
        </main>
      </div>
    </div>
  );
}


===== FILE: ./client/src/pages/Settings.tsx =====
import { useState, useEffect } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Nav } from "@/components/dashboard/Nav";
import { EnvironmentBadge } from "@/components/dashboard/EnvironmentBadge";
import generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { HardDrive, Bot, Server, Cog, AlertTriangle, Clock, Brain, Loader2, Layers, Eye, EyeOff, Check, Monitor, Shield, ChevronRight, Trash2, Plus, X } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import { Link } from "wouter";
import { toast } from "sonner";

interface AiStatus {
  phase: "red" | "yellow" | "green";
  phaseLabel: string;
  completeSamples: number;
  minSamplesForTrain: number;
  minSamplesForActivate: number;
  canTrain: boolean;
  canActivate: boolean;
  filterEnabled: boolean;
  shadowEnabled: boolean;
  modelLoaded: boolean;
  lastTrainTs: string | null;
  threshold: number;
  metrics: {
    accuracy?: number;
    precision?: number;
    recall?: number;
    f1?: number;
  } | null;
}

interface AiDiagnostic {
  operationsCount: number;
  trainingTradesTotal: number;
  closedTradesCount: number;
  labeledTradesCount: number;
  openTradesCount: number;
  openLotsCount: number;
  openTradesDescription: string;
  openLotsDescription: string;
  lastBackfillRun: string | null;
  lastBackfillError: string | null;
  lastTrainRun: string | null;
  lastTrainError: string | null;
  modelVersion: string | null;
  discardReasonsDataset: Record<string, number>;
  lastBackfillDiscardReasons: Record<string, number>;
  winRate: number | null;
  avgPnlNet: number | null;
  avgHoldTimeMinutes: number | null;
}

interface BotConfig {
  id: number;
  isActive: boolean;
  strategy: string;
  riskLevel: string;
  activePairs: string[];
  stopLossPercent: string;
  takeProfitPercent: string;
  trailingStopEnabled: boolean;
  trailingStopPercent: string;
  nonceErrorAlertsEnabled: boolean;
  tradingHoursEnabled: boolean;
  tradingHoursStart: string;
  tradingHoursEnd: string;
  positionMode: string;
  // SMART_GUARD fields
  sgMinEntryUsd: string;
  sgAllowUnderMin: boolean;
  sgBeAtPct: string;
  sgFeeCushionPct: string;
  sgFeeCushionAuto: boolean;
  sgTrailStartPct: string;
  sgTrailDistancePct: string;
  sgTrailStepPct: string;
  sgTpFixedEnabled: boolean;
  sgTpFixedPct: string;
  sgScaleOutEnabled: boolean;
  sgScaleOutPct: string;
  sgMinPartUsd: string;
  sgScaleOutThreshold: string;
  sgMaxOpenLotsPerPair: number;
  sgPairOverrides: Record<string, unknown> | null;
}

export default function Settings() {
  const queryClient = useQueryClient();
  
  const [wsAdminToken, setWsAdminToken] = useState("");
  const [terminalToken, setTerminalToken] = useState("");
  const [showWsToken, setShowWsToken] = useState(false);
  const [showTerminalToken, setShowTerminalToken] = useState(false);
  const [wsTokenSaved, setWsTokenSaved] = useState(false);
  const [terminalTokenSaved, setTerminalTokenSaved] = useState(false);

  useEffect(() => {
    const savedWsToken = localStorage.getItem("WS_ADMIN_TOKEN") || "";
    const savedTerminalToken = localStorage.getItem("TERMINAL_TOKEN") || "";
    setWsAdminToken(savedWsToken);
    setTerminalToken(savedTerminalToken);
    setWsTokenSaved(!!savedWsToken);
    setTerminalTokenSaved(!!savedTerminalToken);
  }, []);

  const handleSaveTokens = () => {
    if (wsAdminToken) {
      localStorage.setItem("WS_ADMIN_TOKEN", wsAdminToken);
      setWsTokenSaved(true);
    } else {
      localStorage.removeItem("WS_ADMIN_TOKEN");
      setWsTokenSaved(false);
    }
    if (terminalToken) {
      localStorage.setItem("TERMINAL_TOKEN", terminalToken);
      setTerminalTokenSaved(true);
    } else {
      localStorage.removeItem("TERMINAL_TOKEN");
      setTerminalTokenSaved(false);
    }
    toast.success("Tokens guardados. Recarga la p√°gina para aplicar cambios.");
  };

  const { data: config } = useQuery<BotConfig>({
    queryKey: ["botConfig"],
    queryFn: async () => {
      const res = await fetch("/api/config");
      if (!res.ok) throw new Error("Failed to fetch config");
      return res.json();
    },
  });

  const { data: aiStatus, isLoading: aiLoading } = useQuery<AiStatus>({
    queryKey: ["aiStatus"],
    queryFn: async () => {
      const res = await fetch("/api/ai/status");
      if (!res.ok) throw new Error("Failed to fetch AI status");
      return res.json();
    },
    refetchInterval: 30000,
  });

  const { data: aiDiagnostic } = useQuery<AiDiagnostic>({
    queryKey: ["aiDiagnostic"],
    queryFn: async () => {
      const res = await fetch("/api/ai/diagnostic");
      if (!res.ok) throw new Error("Failed to fetch AI diagnostic");
      return res.json();
    },
    refetchInterval: 60000,
  });

  const backfillMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/ai/backfill", { method: "POST" });
      if (!res.ok) throw new Error("Failed to backfill");
      return res.json();
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["aiStatus"] });
      queryClient.invalidateQueries({ queryKey: ["aiDiagnostic"] });
      if (data.success) {
        toast.success(data.message || "Backfill completado");
      } else {
        toast.error(data.message || "Error en backfill");
      }
    },
    onError: () => {
      toast.error("Error al ejecutar backfill");
    },
  });

  const updateMutation = useMutation({
    mutationFn: async (updates: Partial<BotConfig>) => {
      const res = await fetch("/api/config", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates),
      });
      if (!res.ok) throw new Error("Failed to update config");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["botConfig"] });
      toast.success("Configuraci√≥n actualizada");
    },
    onError: () => {
      toast.error("Error al actualizar configuraci√≥n");
    },
  });

  const trainMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/ai/retrain", { method: "POST" });
      if (!res.ok) throw new Error("Failed to train");
      return res.json();
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ["aiStatus"] });
      if (data.success) {
        toast.success(data.message || "Entrenamiento completado");
      } else {
        toast.error(data.message || "Error en entrenamiento");
      }
    },
    onError: () => {
      toast.error("Error al entrenar modelo");
    },
  });

  const toggleAiMutation = useMutation({
    mutationFn: async (payload: { filterEnabled?: boolean; shadowEnabled?: boolean }) => {
      const res = await fetch("/api/ai/toggle", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Failed to toggle");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["aiStatus"] });
      toast.success("Configuraci√≥n IA actualizada");
    },
    onError: () => {
      toast.error("Error al actualizar configuraci√≥n IA");
    },
  });

  return (
    <div className="min-h-screen bg-background flex flex-col relative overflow-hidden">
      <div 
        className="fixed inset-0 z-0 opacity-20 pointer-events-none" 
        style={{ 
          backgroundImage: `url(${generatedImage})`, 
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          mixBlendMode: 'overlay'
        }} 
      />
      
      <div className="relative z-10 flex flex-col min-h-screen">
        <Nav />
        
        <main className="flex-1 p-4 md:p-6 max-w-4xl mx-auto w-full space-y-6 md:space-y-8">
          <EnvironmentBadge />
          
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-xl md:text-3xl font-bold font-sans tracking-tight flex items-center gap-2 md:gap-3">
                <Cog className="h-6 w-6 md:h-8 md:w-8 text-primary" />
                Ajustes del Sistema
              </h1>
              <p className="text-sm md:text-base text-muted-foreground mt-1">Configuraci√≥n del bot, IA y despliegue.</p>
            </div>
          </div>

          <div className="grid gap-6">
            {/* Quick Link to Integrations */}
            <Card className="glass-panel border-primary/30 bg-primary/5">
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Server className="h-5 w-5 text-primary" />
                    <div>
                      <p className="font-medium">APIs y Credenciales</p>
                      <p className="text-sm text-muted-foreground">Configura Kraken, Telegram y otras integraciones</p>
                    </div>
                  </div>
                  <Link href="/integrations">
                    <Button variant="outline" data-testid="link-integrations">
                      Ir a Integraciones
                    </Button>
                  </Link>
                </div>
              </CardContent>
            </Card>

            {/* Monitor Tokens */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-cyan-500/20 rounded-lg">
                    <Monitor className="h-6 w-6 text-cyan-400" />
                  </div>
                  <div>
                    <CardTitle>Tokens de Monitor</CardTitle>
                    <CardDescription>Tokens de autenticaci√≥n para WebSocket (deben coincidir con los del servidor).</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid gap-3">
                  <div className="grid gap-2">
                    <Label htmlFor="ws-admin-token">WS_ADMIN_TOKEN (Eventos)</Label>
                    <div className="flex gap-2">
                      <div className="relative flex-1">
                        <Input
                          id="ws-admin-token"
                          type={showWsToken ? "text" : "password"}
                          value={wsAdminToken}
                          onChange={(e) => setWsAdminToken(e.target.value)}
                          placeholder="Token para /ws/events"
                          className="font-mono pr-10"
                          data-testid="input-ws-admin-token"
                        />
                        <button
                          type="button"
                          onClick={() => setShowWsToken(!showWsToken)}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground"
                        >
                          {showWsToken ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </button>
                      </div>
                      {wsTokenSaved && (
                        <Check className="h-5 w-5 text-green-500 self-center" data-testid="check-ws-token" />
                      )}
                    </div>
                    <p className="text-xs text-muted-foreground">Opcional en desarrollo, requerido en producci√≥n.</p>
                  </div>
                  
                  <div className="grid gap-2">
                    <Label htmlFor="terminal-token">TERMINAL_TOKEN (Terminal)</Label>
                    <div className="flex gap-2">
                      <div className="relative flex-1">
                        <Input
                          id="terminal-token"
                          type={showTerminalToken ? "text" : "password"}
                          value={terminalToken}
                          onChange={(e) => setTerminalToken(e.target.value)}
                          placeholder="Token para /ws/logs"
                          className="font-mono pr-10"
                          data-testid="input-terminal-token"
                        />
                        <button
                          type="button"
                          onClick={() => setShowTerminalToken(!showTerminalToken)}
                          className="absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground"
                        >
                          {showTerminalToken ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </button>
                      </div>
                      {terminalTokenSaved && (
                        <Check className="h-5 w-5 text-green-500 self-center" data-testid="check-terminal-token" />
                      )}
                    </div>
                    <p className="text-xs text-muted-foreground">Obligatorio para ver logs del servidor.</p>
                  </div>
                </div>
                
                <Button onClick={handleSaveTokens} className="w-full" data-testid="button-save-tokens">
                  Guardar Tokens
                </Button>
                
                <p className="text-xs text-muted-foreground text-center">
                  Los tokens se guardan en tu navegador. Recarga la p√°gina despu√©s de guardar para aplicar cambios.
                </p>
              </CardContent>
            </Card>

            {/* Notifications Settings */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-yellow-500/20 rounded-lg">
                    <AlertTriangle className="h-6 w-6 text-yellow-400" />
                  </div>
                  <div>
                    <CardTitle>Alertas y Notificaciones</CardTitle>
                    <CardDescription>Configura las alertas de Telegram del bot.</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between p-4 border border-border rounded-lg bg-card/30">
                  <div className="space-y-0.5">
                    <Label>Alertas de Error de Nonce</Label>
                    <p className="text-sm text-muted-foreground">
                      Env√≠a alerta por Telegram si hay errores persistentes de nonce con Kraken (m√°x. 1 cada 30 min)
                    </p>
                  </div>
                  <Switch 
                    checked={config?.nonceErrorAlertsEnabled ?? true}
                    onCheckedChange={(checked) => updateMutation.mutate({ nonceErrorAlertsEnabled: checked })}
                    data-testid="switch-nonce-alerts"
                  />
                </div>
              </CardContent>
            </Card>

            {/* Trading Hours Settings */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-blue-500/20 rounded-lg">
                    <Clock className="h-6 w-6 text-blue-400" />
                  </div>
                  <div>
                    <CardTitle>Horario de Trading</CardTitle>
                    <CardDescription>Limita las operaciones a horas de mayor liquidez (UTC).</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between p-4 border border-border rounded-lg bg-card/30">
                  <div className="space-y-0.5">
                    <Label>Activar Filtro de Horario</Label>
                    <p className="text-sm text-muted-foreground">
                      Solo opera dentro del horario configurado (evita baja liquidez nocturna)
                    </p>
                  </div>
                  <Switch 
                    checked={config?.tradingHoursEnabled ?? true}
                    onCheckedChange={(checked) => updateMutation.mutate({ tradingHoursEnabled: checked })}
                    data-testid="switch-trading-hours"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label className="text-sm">Hora de Inicio (UTC)</Label>
                    <Input 
                      type="number"
                      min="0"
                      max="23"
                      defaultValue={config?.tradingHoursStart ?? "8"}
                      key={`start-${config?.tradingHoursStart}`}
                      onBlur={(e) => {
                        const val = parseInt(e.target.value);
                        if (!isNaN(val) && val >= 0 && val <= 23) {
                          updateMutation.mutate({ tradingHoursStart: val.toString() });
                        }
                      }}
                      className="font-mono bg-background/50"
                      data-testid="input-trading-hours-start"
                    />
                  </div>
                  <div className="grid gap-2">
                    <Label className="text-sm">Hora de Fin (UTC)</Label>
                    <Input 
                      type="number"
                      min="0"
                      max="23"
                      defaultValue={config?.tradingHoursEnd ?? "22"}
                      key={`end-${config?.tradingHoursEnd}`}
                      onBlur={(e) => {
                        const val = parseInt(e.target.value);
                        if (!isNaN(val) && val >= 0 && val <= 23) {
                          updateMutation.mutate({ tradingHoursEnd: val.toString() });
                        }
                      }}
                      className="font-mono bg-background/50"
                      data-testid="input-trading-hours-end"
                    />
                  </div>
                </div>
                <p className="text-xs text-muted-foreground">
                  Horario actual: {config?.tradingHoursStart ?? "8"}:00 - {config?.tradingHoursEnd ?? "22"}:00 UTC
                </p>
              </CardContent>
            </Card>

            {/* Position Mode Settings */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-purple-500/20 rounded-lg">
                    <Layers className="h-6 w-6 text-purple-400" />
                  </div>
                  <div>
                    <CardTitle>Modo de Posici√≥n</CardTitle>
                    <CardDescription>Controla c√≥mo se acumulan posiciones por cada par.</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="p-4 border border-border rounded-lg bg-card/30">
                  <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div className="space-y-1">
                      <Label>Modo de Acumulaci√≥n</Label>
                      <p className="text-sm text-muted-foreground">
                        SINGLE: Una sola posici√≥n por par (bloquea nuevas compras si ya hay posici√≥n abierta).
                        <br />
                        DCA: Permite m√∫ltiples compras del mismo par (Dollar Cost Averaging).
                      </p>
                    </div>
                    <Select 
                      value={config?.positionMode ?? "SINGLE"}
                      onValueChange={(value) => updateMutation.mutate({ positionMode: value })}
                    >
                      <SelectTrigger className="w-[160px] font-mono bg-background/50" data-testid="select-position-mode">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="SINGLE">SINGLE</SelectItem>
                        <SelectItem value="DCA">DCA</SelectItem>
                        <SelectItem value="SMART_GUARD">SMART_GUARD</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <div className={`p-3 rounded-lg text-sm ${
                  config?.positionMode === "DCA" 
                    ? "bg-yellow-500/10 border border-yellow-500/30 text-yellow-400" 
                    : config?.positionMode === "SMART_GUARD"
                    ? "bg-blue-500/10 border border-blue-500/30 text-blue-400"
                    : "bg-green-500/10 border border-green-500/30 text-green-400"
                }`}>
                  {config?.positionMode === "DCA" ? (
                    <>
                      <strong>Modo DCA activo:</strong> El bot puede realizar m√∫ltiples compras del mismo par para promediar el precio de entrada.
                    </>
                  ) : config?.positionMode === "SMART_GUARD" ? (
                    <>
                      <strong>Modo SMART_GUARD activo:</strong> Una posici√≥n por par con protecci√≥n inteligente: break-even autom√°tico, stop din√°mico (trailing) y salida escalonada opcional.
                    </>
                  ) : (
                    <>
                      <strong>Modo SINGLE activo:</strong> El bot bloquear√° nuevas compras de un par si ya existe una posici√≥n abierta.
                    </>
                  )}
                </div>
                
                {config?.positionMode === "SMART_GUARD" && (
                  <div className="space-y-4 p-4 border border-blue-500/30 rounded-lg bg-blue-500/5" data-testid="panel-smart-guard-config">
                    <h4 className="font-medium text-blue-400 flex items-center gap-2" data-testid="text-smart-guard-title">
                      <Shield className="h-4 w-4" />
                      Configuraci√≥n SMART_GUARD
                    </h4>
                    
                    <p className="text-xs text-muted-foreground bg-muted/30 p-2 rounded border border-border/50" data-testid="text-sg-global-limits-note">
                      Los l√≠mites globales de Riesgo por Trade y Exposici√≥n est√°n en "Tama√±o de Trade" y "Control de Exposici√≥n" (p√°gina Estrategias).
                    </p>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="space-y-2">
                        <Label className="text-sm">M√≠nimo por operaci√≥n (USD)</Label>
                        <Input
                          type="number"
                          value={config.sgMinEntryUsd}
                          onChange={(e) => updateMutation.mutate({ sgMinEntryUsd: e.target.value })}
                          className="font-mono bg-background/50"
                          data-testid="input-sg-min-entry"
                        />
                        <p className="text-xs text-muted-foreground" data-testid="text-sg-min-entry-desc">No entrar si el monto disponible es menor a este valor.</p>
                        <div className="flex items-center justify-between mt-2">
                          <Label className="text-xs text-muted-foreground">Permitir entradas menores</Label>
                          <Switch
                            checked={config.sgAllowUnderMin}
                            onCheckedChange={(checked) => updateMutation.mutate({ sgAllowUnderMin: checked })}
                            data-testid="switch-sg-allow-under-min"
                          />
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        <Label className="text-sm">M√°ximo lotes por par</Label>
                        <Input
                          type="number"
                          min={1}
                          max={10}
                          value={config.sgMaxOpenLotsPerPair || 1}
                          onChange={(e) => updateMutation.mutate({ sgMaxOpenLotsPerPair: parseInt(e.target.value) || 1 })}
                          className="font-mono bg-background/50"
                          data-testid="input-sg-max-lots"
                        />
                        <p className="text-xs text-muted-foreground" data-testid="text-sg-max-lots-desc">N√∫mero m√°ximo de posiciones abiertas por par (1 = una entrada, 2+ = permitir DCA en SMART_GUARD).</p>
                      </div>
                      
                      <div className="space-y-2">
                        <Label className="text-sm">Proteger ganancias a partir de (%)</Label>
                        <Input
                          type="number"
                          step="0.1"
                          value={config.sgBeAtPct}
                          onChange={(e) => updateMutation.mutate({ sgBeAtPct: e.target.value })}
                          className="font-mono bg-background/50"
                          data-testid="input-sg-be-at"
                        />
                        <p className="text-xs text-muted-foreground" data-testid="text-sg-be-at-desc">Mover stop a break-even cuando la ganancia alcance este %.</p>
                      </div>
                      
                      <div className="space-y-2">
                        <Label className="text-sm">Colch√≥n de comisiones (%)</Label>
                        <Input
                          type="number"
                          step="0.05"
                          value={config.sgFeeCushionPct}
                          onChange={(e) => updateMutation.mutate({ sgFeeCushionPct: e.target.value })}
                          className="font-mono bg-background/50"
                          disabled={config.sgFeeCushionAuto}
                          data-testid="input-sg-fee-cushion"
                        />
                        <p className="text-xs text-muted-foreground" data-testid="text-sg-fee-cushion-desc">Margen sobre precio de entrada para cubrir fees (~0.45%).</p>
                        <div className="flex items-center justify-between mt-2">
                          <Label className="text-xs text-muted-foreground">Calcular autom√°ticamente</Label>
                          <Switch
                            checked={config.sgFeeCushionAuto}
                            onCheckedChange={(checked) => updateMutation.mutate({ sgFeeCushionAuto: checked })}
                            data-testid="switch-sg-fee-cushion-auto"
                          />
                        </div>
                      </div>
                      
                      <div className="space-y-2">
                        <Label className="text-sm">Stop din√°mico: empieza a partir de (%)</Label>
                        <Input
                          type="number"
                          step="0.1"
                          value={config.sgTrailStartPct}
                          onChange={(e) => updateMutation.mutate({ sgTrailStartPct: e.target.value })}
                          className="font-mono bg-background/50"
                          data-testid="input-sg-trail-start"
                        />
                        <p className="text-xs text-muted-foreground" data-testid="text-sg-trail-start-desc">El trailing stop se activa cuando la ganancia alcanza este %.</p>
                      </div>
                      
                      <div className="space-y-2">
                        <Label className="text-sm">Stop din√°mico: distancia (%)</Label>
                        <Input
                          type="number"
                          step="0.1"
                          value={config.sgTrailDistancePct}
                          onChange={(e) => updateMutation.mutate({ sgTrailDistancePct: e.target.value })}
                          className="font-mono bg-background/50"
                          data-testid="input-sg-trail-distance"
                        />
                        <p className="text-xs text-muted-foreground" data-testid="text-sg-trail-distance-desc">Distancia del stop respecto al precio m√°ximo alcanzado.</p>
                      </div>
                      
                      <div className="space-y-2">
                        <Label className="text-sm">Stop din√°mico: paso m√≠nimo (%)</Label>
                        <Input
                          type="number"
                          step="0.05"
                          value={config.sgTrailStepPct}
                          onChange={(e) => updateMutation.mutate({ sgTrailStepPct: e.target.value })}
                          className="font-mono bg-background/50"
                          data-testid="input-sg-trail-step"
                        />
                        <p className="text-xs text-muted-foreground" data-testid="text-sg-trail-step-desc">El stop sube en escalones de al menos este % para evitar spam.</p>
                      </div>
                    </div>
                    
                    <div className="border-t border-border/50 pt-4 space-y-4">
                      <div className="flex items-center justify-between">
                        <div className="space-y-1">
                          <Label>Salida por objetivo fijo (opcional)</Label>
                          <p className="text-xs text-muted-foreground" data-testid="text-sg-tp-fixed-desc">Cerrar toda la posici√≥n al alcanzar un % de ganancia fijo.</p>
                        </div>
                        <Switch
                          checked={config.sgTpFixedEnabled}
                          onCheckedChange={(checked) => updateMutation.mutate({ sgTpFixedEnabled: checked })}
                          data-testid="switch-sg-tp-fixed"
                        />
                      </div>
                      
                      {config.sgTpFixedEnabled && (
                        <div className="space-y-2">
                          <Label className="text-sm">Take-Profit fijo (%)</Label>
                          <Input
                            type="number"
                            step="0.5"
                            value={config.sgTpFixedPct}
                            onChange={(e) => updateMutation.mutate({ sgTpFixedPct: e.target.value })}
                            className="font-mono bg-background/50"
                            data-testid="input-sg-tp-fixed"
                          />
                        </div>
                      )}
                    </div>
                    
                    <div className="border-t border-border/50 pt-4 space-y-4">
                      <div className="flex items-center justify-between">
                        <div className="space-y-1">
                          <Label>Salida en 2 pasos (solo si es excepcional)</Label>
                          <p className="text-xs text-muted-foreground" data-testid="text-sg-scale-out-desc">Vender una parte cuando la se√±al es muy fuerte, el resto con trailing.</p>
                        </div>
                        <Switch
                          checked={config.sgScaleOutEnabled}
                          onCheckedChange={(checked) => updateMutation.mutate({ sgScaleOutEnabled: checked })}
                          data-testid="switch-sg-scale-out"
                        />
                      </div>
                      
                      {config.sgScaleOutEnabled && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="space-y-2">
                            <Label className="text-sm">Porcentaje a vender (%)</Label>
                            <Input
                              type="number"
                              step="5"
                              value={config.sgScaleOutPct}
                              onChange={(e) => updateMutation.mutate({ sgScaleOutPct: e.target.value })}
                              className="font-mono bg-background/50"
                              data-testid="input-sg-scale-out-pct"
                            />
                          </div>
                          <div className="space-y-2">
                            <Label className="text-sm">M√≠nimo parte (USD)</Label>
                            <Input
                              type="number"
                              value={config.sgMinPartUsd}
                              onChange={(e) => updateMutation.mutate({ sgMinPartUsd: e.target.value })}
                              className="font-mono bg-background/50"
                              data-testid="input-sg-min-part"
                            />
                          </div>
                          <div className="space-y-2">
                            <Label className="text-sm">Confianza m√≠nima (%)</Label>
                            <Input
                              type="number"
                              value={config.sgScaleOutThreshold}
                              onChange={(e) => updateMutation.mutate({ sgScaleOutThreshold: e.target.value })}
                              className="font-mono bg-background/50"
                              data-testid="input-sg-scale-threshold"
                            />
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <PairOverridesSection 
                      overrides={config.sgPairOverrides as Record<string, Record<string, unknown>> | null}
                      onUpdate={(newOverrides) => updateMutation.mutate({ sgPairOverrides: newOverrides })}
                      activePairs={config.activePairs}
                    />
                  </div>
                )}
              </CardContent>
            </Card>

            {/* AI Integration */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-primary/20 rounded-lg">
                    <Brain className="h-6 w-6 text-primary" />
                  </div>
                  <div>
                    <CardTitle>Motor de Inteligencia Artificial</CardTitle>
                    <CardDescription>Filtro predictivo basado en Machine Learning.</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                {aiLoading ? (
                  <div className="flex items-center justify-center py-8">
                    <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
                  </div>
                ) : aiStatus ? (
                  <>
                    <div className="space-y-2">
                      <div className="flex items-center justify-between">
                        <Label className="text-sm">Trades Cerrados Etiquetados</Label>
                        <span className="text-sm font-mono">
                          {aiStatus.completeSamples} / {aiStatus.minSamplesForActivate} trades
                        </span>
                      </div>
                      <Progress 
                        value={(aiStatus.completeSamples / aiStatus.minSamplesForActivate) * 100} 
                        className="h-2"
                      />
                      <p className="text-xs text-muted-foreground">
                        {aiStatus.completeSamples < 300 
                          ? `Necesitas ${300 - aiStatus.completeSamples} trades cerrados m√°s para entrenar`
                          : "Listo para entrenar y activar el filtro AI"}
                      </p>
                    </div>
                    
                    {aiDiagnostic && (
                      <div className="p-3 border border-border rounded-lg bg-card/30 space-y-2">
                        <div className="flex items-center justify-between">
                          <Label className="text-xs text-muted-foreground">Diagn√≥stico de Dataset</Label>
                          {aiDiagnostic.modelVersion && (
                            <span className="text-xs font-mono text-primary">{aiDiagnostic.modelVersion}</span>
                          )}
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">Operaciones:</span>
                            <span className="ml-1 font-mono">{aiDiagnostic.operationsCount}</span>
                          </div>
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">Cerrados:</span>
                            <span className="ml-1 font-mono">{aiDiagnostic.closedTradesCount}</span>
                          </div>
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">Etiquetados:</span>
                            <span className="ml-1 font-mono">{aiDiagnostic.labeledTradesCount}</span>
                          </div>
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">Win Rate:</span>
                            <span className="ml-1 font-mono">{aiDiagnostic.winRate ? `${aiDiagnostic.winRate.toFixed(1)}%` : '-'}</span>
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">√öltimo Backfill:</span>
                            <span className="ml-1 font-mono">
                              {aiDiagnostic.lastBackfillRun 
                                ? new Date(aiDiagnostic.lastBackfillRun).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' })
                                : 'Nunca'}
                            </span>
                          </div>
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">√öltimo Entrenamiento:</span>
                            <span className="ml-1 font-mono">
                              {aiDiagnostic.lastTrainRun 
                                ? new Date(aiDiagnostic.lastTrainRun).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' })
                                : 'Nunca'}
                            </span>
                          </div>
                        </div>
                        {aiDiagnostic.lastBackfillError && (
                          <div className="text-xs text-red-500 p-2 bg-red-500/10 rounded">
                            Error Backfill: {aiDiagnostic.lastBackfillError}
                          </div>
                        )}
                        {aiDiagnostic.lastTrainError && (
                          <div className="text-xs text-red-500 p-2 bg-red-500/10 rounded">
                            Error Entrenamiento: {aiDiagnostic.lastTrainError}
                          </div>
                        )}
                        {Object.keys(aiDiagnostic.discardReasonsDataset || {}).length > 0 && (
                          <div className="space-y-2 p-3 bg-yellow-500/10 rounded-lg border border-yellow-500/20">
                            <div className="flex items-center gap-2 text-yellow-500 text-xs font-medium">
                              <span>‚ö†Ô∏è Trades Excluidos del Entrenamiento</span>
                            </div>
                            <div className="grid grid-cols-1 gap-1.5 text-xs">
                              {Object.entries(aiDiagnostic.discardReasonsDataset || {}).map(([k, v]) => {
                                const discardInfo: Record<string, { label: string; desc: string }> = {
                                  'sin_fecha_ejecucion': { 
                                    label: 'Sin fecha', 
                                    desc: 'El trade no tiene timestamp de ejecuci√≥n' 
                                  },
                                  'datos_invalidos': { 
                                    label: 'Datos inv√°lidos', 
                                    desc: 'Precio o cantidad <= 0' 
                                  },
                                  'venta_sin_compra_previa': { 
                                    label: 'Venta hu√©rfana', 
                                    desc: 'SELL sin BUY correspondiente (inventario pre-bot)' 
                                  },
                                  'venta_excede_lotes': { 
                                    label: 'Venta excede stock', 
                                    desc: 'La cantidad vendida supera los lotes abiertos' 
                                  },
                                  'comisiones_anormales': { 
                                    label: 'Comisiones raras', 
                                    desc: 'Fees fuera del rango 0.1%-2.5%' 
                                  },
                                  'pnl_atipico': { 
                                    label: 'PnL extremo', 
                                    desc: 'Ganancia/p√©rdida > 100% (outlier estad√≠stico)' 
                                  },
                                  'hold_excesivo': { 
                                    label: 'Hold muy largo', 
                                    desc: 'Posici√≥n mantenida > 30 d√≠as' 
                                  },
                                  'timestamps_invalidos': { 
                                    label: 'Fechas err√≥neas', 
                                    desc: 'Exit timestamp antes de entry timestamp' 
                                  },
                                };
                                const info = discardInfo[k] || { label: k, desc: 'Sin descripci√≥n disponible' };
                                return (
                                  <div key={k} className="flex items-center justify-between p-1.5 bg-background/50 rounded" title={info.desc}>
                                    <span className="text-muted-foreground">{info.label}</span>
                                    <span className="font-mono text-yellow-500">{v as number}</span>
                                  </div>
                                );
                              })}
                            </div>
                            <div className="text-[10px] text-muted-foreground mt-1">
                              üí° Estos trades se excluyen para evitar sesgos en el modelo ML
                            </div>
                          </div>
                        )}
                        <Button 
                          size="sm" 
                          variant="outline"
                          className="w-full"
                          disabled={backfillMutation.isPending}
                          onClick={() => backfillMutation.mutate()}
                          data-testid="button-backfill"
                        >
                          {backfillMutation.isPending ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Procesando...</>
                          ) : "Ejecutar Backfill (Regenerar Dataset)"}
                        </Button>
                      </div>
                    )}
                    
                    <div className="p-4 border border-border rounded-lg bg-card/30">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <span className={`h-3 w-3 rounded-full ${
                            aiStatus.phase === "green" ? "bg-green-500" : 
                            aiStatus.phase === "yellow" ? "bg-yellow-500" : "bg-red-500"
                          } ${aiStatus.phase !== "red" ? "animate-pulse" : ""}`}></span>
                          <span className="font-mono text-sm">{aiStatus.phaseLabel}</span>
                        </div>
                        <Button 
                          size="sm" 
                          variant="secondary"
                          disabled={!aiStatus.canTrain || trainMutation.isPending}
                          onClick={() => trainMutation.mutate()}
                          data-testid="button-train-ai"
                        >
                          {trainMutation.isPending ? (
                            <><Loader2 className="mr-2 h-4 w-4 animate-spin" /> Entrenando...</>
                          ) : "Entrenar Modelo"}
                        </Button>
                      </div>
                      {aiStatus.metrics && (
                        <div className="mt-3 grid grid-cols-2 gap-2 text-xs">
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">Accuracy:</span>
                            <span className="ml-2 font-mono">{((aiStatus.metrics.accuracy ?? 0) * 100).toFixed(1)}%</span>
                          </div>
                          <div className="p-2 bg-background/50 rounded">
                            <span className="text-muted-foreground">Precision:</span>
                            <span className="ml-2 font-mono">{((aiStatus.metrics.precision ?? 0) * 100).toFixed(1)}%</span>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <div className="space-y-3">
                      <div className="flex items-center justify-between p-3 border border-border rounded-lg bg-card/30">
                        <div className="space-y-0.5">
                          <Label>Shadow Mode</Label>
                          <p className="text-xs text-muted-foreground">Registra predicciones sin bloquear trades</p>
                        </div>
                        <Switch 
                          checked={aiStatus.shadowEnabled}
                          onCheckedChange={(checked) => toggleAiMutation.mutate({ shadowEnabled: checked })}
                          data-testid="switch-ai-shadow"
                        />
                      </div>
                      <div className="flex items-center justify-between p-3 border border-border rounded-lg bg-card/30">
                        <div className="space-y-0.5">
                          <Label>Filtro Activo</Label>
                          <p className="text-xs text-muted-foreground">Bloquea trades con baja probabilidad de √©xito</p>
                        </div>
                        <Switch 
                          checked={aiStatus.filterEnabled}
                          disabled={!aiStatus.canActivate}
                          onCheckedChange={(checked) => toggleAiMutation.mutate({ filterEnabled: checked })}
                          data-testid="switch-ai-filter"
                        />
                      </div>
                    </div>
                  </>
                ) : (
                  <p className="text-sm text-muted-foreground">Error cargando estado de IA</p>
                )}
              </CardContent>
            </Card>

            {/* NAS Deployment */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-orange-500/20 rounded-lg">
                    <HardDrive className="h-6 w-6 text-orange-400" />
                  </div>
                  <div>
                    <CardTitle>Despliegue QNAP NAS</CardTitle>
                    <CardDescription>Configuraci√≥n para Container Station y Docker.</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div className="grid gap-2">
                    <Label className="text-sm">Direcci√≥n IP del NAS</Label>
                    <Input placeholder="192.168.1.104" defaultValue="192.168.1.104" className="font-mono bg-background/50" />
                  </div>
                  <div className="grid gap-2">
                    <Label>Puerto</Label>
                    <Input placeholder="3000" defaultValue="3000" className="font-mono bg-background/50" />
                  </div>
                </div>
                <div className="flex items-center justify-between p-4 border border-border rounded-lg bg-card/30">
                  <div className="space-y-0.5">
                    <Label>Auto-Reinicio en Fallo</Label>
                    <p className="text-sm text-muted-foreground">Pol√≠tica de reinicio de Docker (--restart unless-stopped)</p>
                  </div>
                  <Switch defaultChecked />
                </div>
                <div className="flex items-center justify-between p-4 border border-border rounded-lg bg-card/30">
                  <div className="space-y-0.5">
                    <Label>Auto-Actualizaci√≥n</Label>
                    <p className="text-sm text-muted-foreground">Actualiza autom√°ticamente desde Git cada hora</p>
                  </div>
                  <Switch defaultChecked />
                </div>
                <Button 
                  className="w-full bg-orange-600 hover:bg-orange-700 text-white" 
                  onClick={() => {
                    const link = document.createElement('a');
                    link.href = '/docker-compose.yml';
                    link.download = 'docker-compose.yml';
                    link.click();
                  }}
                  data-testid="button-download-docker"
                >
                  <Server className="mr-2 h-4 w-4" /> Descargar docker-compose.yml
                </Button>
              </CardContent>
            </Card>

            {/* System Info */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-cyan-500/20 rounded-lg">
                    <Cog className="h-6 w-6 text-cyan-400" />
                  </div>
                  <div>
                    <CardTitle>Informaci√≥n del Sistema</CardTitle>
                    <CardDescription>Versi√≥n y estado del bot.</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-2 gap-3 md:gap-4 text-xs md:text-sm">
                  <div className="p-2 md:p-3 border border-border rounded-lg bg-card/30">
                    <p className="text-muted-foreground">Versi√≥n</p>
                    <p className="font-mono font-medium">1.0.0</p>
                  </div>
                  <div className="p-2 md:p-3 border border-border rounded-lg bg-card/30">
                    <p className="text-muted-foreground">Entorno</p>
                    <p className="font-mono font-medium">Producci√≥n</p>
                  </div>
                  <div className="p-2 md:p-3 border border-border rounded-lg bg-card/30">
                    <p className="text-muted-foreground">Base de datos</p>
                    <p className="font-mono font-medium text-green-500">Conectada</p>
                  </div>
                  <div className="p-2 md:p-3 border border-border rounded-lg bg-card/30">
                    <p className="text-muted-foreground">√öltima actualizaci√≥n</p>
                    <p className="font-mono font-medium">{new Date().toLocaleDateString("es-ES")}</p>
                  </div>
                </div>
              </CardContent>
            </Card>

          </div>
        </main>
      </div>
    </div>
  );
}

interface PairOverridesSectionProps {
  overrides: Record<string, Record<string, unknown>> | null;
  onUpdate: (newOverrides: Record<string, Record<string, unknown>> | null) => void;
  activePairs: string[];
}

function PairOverridesSection({ overrides, onUpdate, activePairs }: PairOverridesSectionProps) {
  const [expandedPair, setExpandedPair] = useState<string | null>(null);
  const [newPair, setNewPair] = useState<string>("");
  
  const currentOverrides = overrides || {};
  const pairsWithOverrides = Object.keys(currentOverrides);
  const availablePairs = activePairs.filter(p => !pairsWithOverrides.includes(p));

  const handleAddPair = () => {
    if (!newPair || pairsWithOverrides.includes(newPair)) return;
    onUpdate({
      ...currentOverrides,
      [newPair]: {}
    });
    setExpandedPair(newPair);
    setNewPair("");
  };

  const handleRemovePair = (pair: string) => {
    const updated = { ...currentOverrides };
    delete updated[pair];
    onUpdate(Object.keys(updated).length > 0 ? updated : null);
    if (expandedPair === pair) setExpandedPair(null);
  };

  const handleUpdatePairValue = (pair: string, key: string, value: string | boolean) => {
    const updated = {
      ...currentOverrides,
      [pair]: {
        ...currentOverrides[pair],
        [key]: value
      }
    };
    onUpdate(updated);
  };

  const handleRemovePairValue = (pair: string, key: string) => {
    const pairData = { ...currentOverrides[pair] };
    delete pairData[key];
    const updated = {
      ...currentOverrides,
      [pair]: pairData
    };
    if (Object.keys(pairData).length === 0) {
      delete updated[pair];
    }
    onUpdate(Object.keys(updated).length > 0 ? updated : null);
  };

  return (
    <div className="border-t border-blue-500/30 pt-4 mt-4">
      <div className="flex items-center justify-between mb-3">
        <h5 className="text-sm font-medium text-blue-300" data-testid="text-pair-overrides-title">
          Ajustes por Par
        </h5>
        <span className="text-xs text-muted-foreground">
          {pairsWithOverrides.length} par(es) configurado(s)
        </span>
      </div>
      
      <p className="text-xs text-muted-foreground mb-3">
        Configura par√°metros espec√≠ficos para cada par. Los valores aqu√≠ sobreescriben la configuraci√≥n global.
      </p>

      {pairsWithOverrides.length > 0 && (
        <div className="space-y-2 mb-3">
          {pairsWithOverrides.map((pair) => (
            <div key={pair} className="border border-border rounded-lg bg-background/30">
              <div 
                className="flex items-center justify-between p-2 cursor-pointer hover:bg-muted/20"
                onClick={() => setExpandedPair(expandedPair === pair ? null : pair)}
              >
                <div className="flex items-center gap-2">
                  <ChevronRight className={cn("h-4 w-4 transition-transform", expandedPair === pair && "rotate-90")} />
                  <span className="font-mono text-sm">{pair}</span>
                  <Badge variant="secondary" className="text-xs">
                    {Object.keys(currentOverrides[pair]).length} override(s)
                  </Badge>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  className="h-6 w-6 p-0 text-red-400 hover:text-red-300"
                  onClick={(e) => {
                    e.stopPropagation();
                    handleRemovePair(pair);
                  }}
                  data-testid={`btn-remove-override-${pair.replace("/", "-")}`}
                >
                  <Trash2 className="h-3 w-3" />
                </Button>
              </div>
              
              {expandedPair === pair && (
                <div className="p-3 border-t border-border space-y-3">
                  <PairOverrideFields
                    pairData={currentOverrides[pair]}
                    onUpdateValue={(key, value) => handleUpdatePairValue(pair, key, value)}
                    onRemoveValue={(key) => handleRemovePairValue(pair, key)}
                  />
                </div>
              )}
            </div>
          ))}
        </div>
      )}

      {availablePairs.length > 0 && (
        <div className="flex gap-2">
          <Select value={newPair} onValueChange={setNewPair}>
            <SelectTrigger className="w-[180px] bg-background/50" data-testid="select-new-pair">
              <SelectValue placeholder="Seleccionar par..." />
            </SelectTrigger>
            <SelectContent>
              {availablePairs.map((pair) => (
                <SelectItem key={pair} value={pair}>{pair}</SelectItem>
              ))}
            </SelectContent>
          </Select>
          <Button 
            variant="outline" 
            size="sm" 
            onClick={handleAddPair}
            disabled={!newPair}
            data-testid="btn-add-pair-override"
          >
            <Plus className="h-4 w-4 mr-1" />
            Agregar
          </Button>
        </div>
      )}
    </div>
  );
}

interface PairOverrideFieldsProps {
  pairData: Record<string, unknown>;
  onUpdateValue: (key: string, value: string | boolean) => void;
  onRemoveValue: (key: string) => void;
}

const OVERRIDE_FIELDS = [
  { key: "sgMinEntryUsd", label: "M√≠nimo entrada (USD)", type: "number" },
  { key: "sgAllowUnderMin", label: "Permitir bajo m√≠nimo", type: "boolean" },
  { key: "sgBeAtPct", label: "Break-Even (%)", type: "number" },
  { key: "sgFeeCushionPct", label: "Colch√≥n comisiones (%)", type: "number" },
  { key: "sgTrailStartPct", label: "Trail inicio (%)", type: "number" },
  { key: "sgTrailDistancePct", label: "Trail distancia (%)", type: "number" },
  { key: "sgTrailStepPct", label: "Trail paso (%)", type: "number" },
  { key: "sgTpFixedEnabled", label: "TP fijo habilitado", type: "boolean" },
  { key: "sgTpFixedPct", label: "TP fijo (%)", type: "number" },
  { key: "sgScaleOutEnabled", label: "Scale-Out habilitado", type: "boolean" },
  { key: "sgScaleOutPct", label: "Scale-Out (%)", type: "number" },
  { key: "sgScaleOutThreshold", label: "Scale-Out confianza (%)", type: "number" },
  { key: "sgMinPartUsd", label: "M√≠nimo parte (USD)", type: "number" },
];

function PairOverrideFields({ pairData, onUpdateValue, onRemoveValue }: PairOverrideFieldsProps) {
  const activeKeys = Object.keys(pairData);
  const availableFields = OVERRIDE_FIELDS.filter(f => !activeKeys.includes(f.key));
  const [newFieldKey, setNewFieldKey] = useState<string>("");

  const handleAddField = () => {
    if (!newFieldKey) return;
    const field = OVERRIDE_FIELDS.find(f => f.key === newFieldKey);
    if (field) {
      onUpdateValue(newFieldKey, field.type === "boolean" ? false : "");
      setNewFieldKey("");
    }
  };

  return (
    <div className="space-y-2">
      {activeKeys.map((key) => {
        const field = OVERRIDE_FIELDS.find(f => f.key === key);
        if (!field) return null;
        
        return (
          <div key={key} className="flex items-center gap-2">
            <Label className="text-xs w-32 flex-shrink-0">{field.label}</Label>
            {field.type === "boolean" ? (
              <Switch
                checked={!!pairData[key]}
                onCheckedChange={(val) => onUpdateValue(key, val)}
                data-testid={`switch-override-${key}`}
              />
            ) : (
              <Input
                type="number"
                value={String(pairData[key] || "")}
                onChange={(e) => onUpdateValue(key, e.target.value)}
                className="h-7 text-xs font-mono flex-1"
                data-testid={`input-override-${key}`}
              />
            )}
            <Button
              variant="ghost"
              size="sm"
              className="h-6 w-6 p-0 text-muted-foreground hover:text-red-400"
              onClick={() => onRemoveValue(key)}
            >
              <X className="h-3 w-3" />
            </Button>
          </div>
        );
      })}
      
      {availableFields.length > 0 && (
        <div className="flex gap-2 pt-2 border-t border-border/50">
          <Select value={newFieldKey} onValueChange={setNewFieldKey}>
            <SelectTrigger className="w-[200px] h-7 text-xs" data-testid="select-new-field">
              <SelectValue placeholder="Agregar campo..." />
            </SelectTrigger>
            <SelectContent>
              {availableFields.map((f) => (
                <SelectItem key={f.key} value={f.key}>{f.label}</SelectItem>
              ))}
            </SelectContent>
          </Select>
          <Button 
            variant="outline" 
            size="sm" 
            className="h-7 text-xs"
            onClick={handleAddField}
            disabled={!newFieldKey}
          >
            <Plus className="h-3 w-3" />
          </Button>
        </div>
      )}
    </div>
  );
}


===== FILE: ./client/src/pages/Dashboard.tsx =====
import { useQuery } from "@tanstack/react-query";
import { Nav } from "@/components/dashboard/Nav";
import { Ticker } from "@/components/dashboard/Ticker";
import { AssetCard } from "@/components/dashboard/AssetCard";
import { TradeLog } from "@/components/dashboard/TradeLog";
import { ChartWidget } from "@/components/dashboard/ChartWidget";
import { BotControl } from "@/components/dashboard/BotControl";
import { EventsPanel } from "@/components/dashboard/EventsPanel";
import { EnvironmentBadge } from "@/components/dashboard/EnvironmentBadge";
import { AlertCircle } from "lucide-react";
import { Link } from "wouter";
import generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';

interface DashboardData {
  krakenConnected: boolean;
  telegramConnected: boolean;
  botActive: boolean;
  strategy: string;
  activePairs: string[];
  balances: Record<string, string>;
  prices: Record<string, { price: string; change: string }>;
  recentTrades: any[];
}

export default function Dashboard() {
  const { data, isLoading, error } = useQuery<DashboardData>({
    queryKey: ["dashboard"],
    queryFn: async () => {
      const res = await fetch("/api/dashboard");
      if (!res.ok) throw new Error("Failed to fetch dashboard");
      return res.json();
    },
    refetchInterval: 30000,
  });

  const formatBalance = (symbol: string) => {
    if (!data?.balances) return { balance: "0", value: "$0.00", change: 0 };
    
    const symbolMap: Record<string, string> = {
      "BTC": "XXBT", "ETH": "XETH", "SOL": "SOL", "XRP": "XXRP", "TON": "TON", "USD": "ZUSD"
    };
    const pairMap: Record<string, string> = {
      "BTC": "XXBTZUSD", "ETH": "XETHZUSD", "SOL": "SOLUSD", "XRP": "XXRPZUSD", "TON": "TONUSD"
    };
    
    const krakenSymbol = symbolMap[symbol] || "ZUSD";
    const balance = parseFloat(data.balances[krakenSymbol] || "0");
    
    const pricePair = pairMap[symbol];
    const priceData = pricePair ? data.prices[pricePair] : null;
    const price = parseFloat(priceData?.price || "0");
    const change = parseFloat(priceData?.change || "0");
    
    const value = symbol === "USD" ? balance : balance * price;
    
    return {
      balance: balance.toFixed(symbol === "USD" ? 2 : 4),
      value: `$${value.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
      change: symbol === "USD" ? 0 : change,
    };
  };

  const getTotalBalance = () => {
    if (!data?.balances || !data?.prices) return "$0.00";
    
    let total = parseFloat(data.balances["ZUSD"] || "0");
    
    const assets = [
      { symbol: "XXBT", pair: "XXBTZUSD" },
      { symbol: "XETH", pair: "XETHZUSD" },
      { symbol: "SOL", pair: "SOLUSD" },
      { symbol: "XXRP", pair: "XXRPZUSD" },
      { symbol: "TON", pair: "TONUSD" },
    ];
    
    for (const asset of assets) {
      const balance = parseFloat(data.balances[asset.symbol] || "0");
      const price = parseFloat(data.prices[asset.pair]?.price || "0");
      total += balance * price;
    }
    
    return `$${total.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  };

  const usdData = formatBalance("USD");
  
  const cryptoAssets = [
    { symbol: "BTC", name: "Bitcoin", ...formatBalance("BTC") },
    { symbol: "ETH", name: "Ethereum", ...formatBalance("ETH") },
    { symbol: "SOL", name: "Solana", ...formatBalance("SOL") },
    { symbol: "XRP", name: "Ripple", ...formatBalance("XRP") },
    { symbol: "TON", name: "Toncoin", ...formatBalance("TON") },
  ].sort((a, b) => {
    const valueA = parseFloat(a.value.replace(/[$,]/g, "")) || 0;
    const valueB = parseFloat(b.value.replace(/[$,]/g, "")) || 0;
    return valueB - valueA;
  });

  return (
    <div className="min-h-screen bg-background flex flex-col relative overflow-hidden">
      <div 
        className="fixed inset-0 z-0 opacity-20 pointer-events-none" 
        style={{ 
          backgroundImage: `url(${generatedImage})`, 
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          mixBlendMode: 'overlay'
        }} 
      />
      
      <div className="relative z-10 flex flex-col min-h-screen">
        <Nav />
        <Ticker />
        
        <div className="mx-4 md:mx-6 mt-4">
          <EnvironmentBadge />
        </div>
        
        {!data?.krakenConnected && !isLoading && (
          <div className="mx-4 md:mx-6 mt-4 p-3 md:p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3">
            <AlertCircle className="h-5 w-5 text-yellow-500 shrink-0" />
            <div className="flex-1">
              <p className="text-sm font-medium text-yellow-500">Kraken no conectado</p>
              <p className="text-xs text-muted-foreground">Configura tus claves API en Ajustes para ver datos reales.</p>
            </div>
            <Link href="/settings" className="text-sm text-primary hover:underline whitespace-nowrap" data-testid="link-goto-settings">
              Ir a Ajustes
            </Link>
          </div>
        )}
        
        <main className="flex-1 p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 max-w-[1600px] mx-auto w-full">
          
          <div className="col-span-1 lg:col-span-12 grid grid-cols-2 min-[500px]:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
            <AssetCard 
              symbol="USD" 
              name="Balance Total" 
              balance={usdData.balance} 
              value={data?.krakenConnected ? getTotalBalance() : "--"} 
              change={0} 
            />
            {cryptoAssets.map((asset) => (
              <AssetCard 
                key={asset.symbol}
                symbol={asset.symbol} 
                name={asset.name} 
                balance={data?.krakenConnected ? asset.balance : "--"} 
                value={data?.krakenConnected ? asset.value : "--"} 
                change={asset.change} 
              />
            ))}
          </div>

          <div className="col-span-1 lg:col-span-9 h-[280px] sm:h-[350px] md:h-[400px] lg:h-[500px]">
            <ChartWidget />
          </div>
          <div className="col-span-1 lg:col-span-3 space-y-3 md:space-y-4 lg:space-y-6">
            <BotControl />
            <div className="glass-panel p-3 md:p-4 rounded-lg border border-border/50">
               <h3 className="text-xs font-mono text-muted-foreground mb-3">PARES ACTIVOS</h3>
               <div className="flex flex-wrap gap-2">
                 {(data?.activePairs || ["BTC/USD", "ETH/USD", "SOL/USD"]).map(pair => (
                   <span key={pair} className="px-2 py-1 bg-primary/10 text-primary border border-primary/20 rounded text-xs font-mono">
                     {pair}
                   </span>
                 ))}
               </div>
            </div>
          </div>

          <div className="col-span-1 lg:col-span-6">
            <TradeLog />
          </div>
          
          <div className="col-span-1 lg:col-span-6">
            <EventsPanel />
          </div>

        </main>
      </div>
    </div>
  );
}


===== FILE: ./client/src/pages/Monitor.tsx =====
import { useState, useRef, useEffect, useMemo } from "react";
import { Nav } from "@/components/dashboard/Nav";
import { useEventsFeed } from "@/context/EventsWebSocketContext";
import { BotEvent } from "@/hooks/useEventsWebSocket";
import { useTerminalWebSocket } from "@/hooks/useTerminalWebSocket";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { 
  Wifi, WifiOff, RefreshCw, Trash2, Pause, Play, 
  Download, Copy, Search, X, ChevronDown, ChevronRight,
  AlertCircle, AlertTriangle, Info, Terminal, Activity,
  Eye, TrendingUp, TrendingDown, Minus
} from "lucide-react";
import { useQuery } from "@tanstack/react-query";
import { cn } from "@/lib/utils";

const LEVEL_COLORS: Record<string, string> = {
  INFO: "bg-blue-500/20 text-blue-400 border-blue-500/30",
  WARN: "bg-yellow-500/20 text-yellow-400 border-yellow-500/30",
  ERROR: "bg-red-500/20 text-red-400 border-red-500/30",
};

const LEVEL_ICONS: Record<string, React.ReactNode> = {
  INFO: <Info className="h-3 w-3" />,
  WARN: <AlertTriangle className="h-3 w-3" />,
  ERROR: <AlertCircle className="h-3 w-3" />,
};

const DEFAULT_EVENT_TYPES = [
  "TRADE_EXECUTED", "TRADE_BLOCKED", "TRADE_FAILED", "TRADE_ADJUSTED", "TRADE_REJECTED_LOW_PROFIT", "TRADE_SKIPPED",
  "STOP_LOSS_HIT", "TAKE_PROFIT_HIT", "TRAILING_STOP_HIT",
  "BOT_STARTED", "BOT_STOPPED", "BOT_PAUSED", "BOT_RESUMED",
  "ENGINE_TICK", "MARKET_SCAN_SUMMARY",
  "DAILY_LIMIT_HIT", "DAILY_LIMIT_RESET", "PAIR_COOLDOWN",
  "KRAKEN_ERROR", "KRAKEN_CONNECTED", "TELEGRAM_ERROR", "TELEGRAM_CONNECTED", "NONCE_ERROR",
  "POSITION_OPENED", "POSITION_CLOSED", "ORPHAN_POSITION_CLEANED",
  "SIGNAL_GENERATED", "BALANCE_CHECK", "SYSTEM_ERROR",
];

const DEFAULT_PAIRS = ["BTC/USD", "ETH/USD", "SOL/USD", "XRP/USD", "TON/USD"];

export default function Monitor() {
  const [activeTab, setActiveTab] = useState("events");
  
  return (
    <div className="min-h-screen bg-background">
      <Nav />
      <div className="p-4 md:p-6 max-w-[1800px] mx-auto">
        <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
          <div className="flex items-center gap-4 mb-4">
            <h1 className="text-xl font-bold">Monitor</h1>
            <TabsList>
              <TabsTrigger value="events" className="gap-1" data-testid="tab-events">
                <Activity className="h-4 w-4" />
                Eventos
              </TabsTrigger>
              <TabsTrigger value="terminal" className="gap-1" data-testid="tab-terminal">
                <Terminal className="h-4 w-4" />
                Terminal
              </TabsTrigger>
              <TabsTrigger value="diagnostic" className="gap-1" data-testid="tab-diagnostic">
                <Eye className="h-4 w-4" />
                Diagn√≥stico
              </TabsTrigger>
            </TabsList>
          </div>
          
          <TabsContent value="events" className="mt-0">
            <EventsTab />
          </TabsContent>
          
          <TabsContent value="terminal" className="mt-0">
            <TerminalTab />
          </TabsContent>
          
          <TabsContent value="diagnostic" className="mt-0">
            <DiagnosticTab />
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
}

function EventsTab() {
  const { events, status, error, connect, disconnect, clearEvents, isConnected } = useEventsFeed();
  
  const [autoScroll, setAutoScroll] = useState(true);
  const [selectedEvent, setSelectedEvent] = useState<BotEvent | null>(null);
  const [searchText, setSearchText] = useState("");
  const [levelFilter, setLevelFilter] = useState<string[]>(["INFO", "WARN", "ERROR"]);
  const [typeFilter, setTypeFilter] = useState<string[]>([]);
  const [pairFilter, setPairFilter] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(false);
  const [lastMessageTime, setLastMessageTime] = useState<Date | null>(null);
  
  const scrollRef = useRef<HTMLDivElement>(null);
  const prevEventsLengthRef = useRef(events.length);

  useEffect(() => {
    if (events.length > 0) {
      const latestEvent = events[0];
      if (latestEvent?.timestamp) {
        setLastMessageTime(new Date(latestEvent.timestamp));
      }
    }
  }, [events]);

  useEffect(() => {
    if (autoScroll && events.length > prevEventsLengthRef.current && scrollRef.current) {
      scrollRef.current.scrollTop = 0;
    }
    prevEventsLengthRef.current = events.length;
  }, [events.length, autoScroll]);

  const filteredEvents = useMemo(() => {
    return events.filter((event) => {
      if (levelFilter.length > 0 && !levelFilter.includes(event.level)) return false;
      if (typeFilter.length > 0 && !typeFilter.includes(event.type)) return false;
      if (pairFilter.length > 0) {
        const eventPair = event.meta?.pair;
        if (!eventPair || !pairFilter.includes(eventPair)) return false;
      }
      if (searchText) {
        const searchLower = searchText.toLowerCase();
        const messageMatch = event.message.toLowerCase().includes(searchLower);
        const typeMatch = event.type.toLowerCase().includes(searchLower);
        const metaMatch = event.meta ? JSON.stringify(event.meta).toLowerCase().includes(searchLower) : false;
        if (!messageMatch && !typeMatch && !metaMatch) return false;
      }
      return true;
    });
  }, [events, levelFilter, typeFilter, pairFilter, searchText]);

  const stats = useMemo(() => {
    const last24h = events.filter(e => {
      const eventTime = new Date(e.timestamp).getTime();
      const now = Date.now();
      return now - eventTime < 24 * 60 * 60 * 1000;
    });
    return {
      total: events.length,
      errors: last24h.filter(e => e.level === "ERROR").length,
      warnings: last24h.filter(e => e.level === "WARN").length,
      trades: last24h.filter(e => e.type === "TRADE_EXECUTED").length,
    };
  }, [events]);

  const availableEventTypes = useMemo(() => {
    const fromEvents = events.map(e => e.type);
    const combined = new Set([...DEFAULT_EVENT_TYPES, ...fromEvents]);
    return Array.from(combined).sort();
  }, [events]);

  const availablePairs = useMemo(() => {
    const fromEvents = events.map(e => e.meta?.pair).filter((p): p is string => Boolean(p));
    const combined = new Set([...DEFAULT_PAIRS, ...fromEvents]);
    return Array.from(combined).sort();
  }, [events]);

  const handleCopyEvent = (event: BotEvent) => {
    navigator.clipboard.writeText(JSON.stringify(event, null, 2));
  };

  const handleCopyAll = () => {
    navigator.clipboard.writeText(JSON.stringify(filteredEvents, null, 2));
  };

  const handleDownload = () => {
    const blob = new Blob([JSON.stringify(filteredEvents, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `krakenbot-logs-${new Date().toISOString().split("T")[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const toggleLevel = (level: string) => {
    setLevelFilter(prev => 
      prev.includes(level) ? prev.filter(l => l !== level) : [...prev, level]
    );
  };

  const formatTimestamp = (ts: string) => {
    const date = new Date(ts);
    return date.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  };

  const formatDate = (ts: string) => {
    const date = new Date(ts);
    return date.toLocaleDateString("es-ES", { day: "2-digit", month: "2-digit" });
  };

  return (
    <div className="flex flex-col lg:flex-row gap-4">
      <div className="flex-1 space-y-4">
        <div className="flex flex-wrap items-center gap-2 justify-between">
          <div className="flex items-center gap-2">
            <Badge 
              variant="outline" 
              className={cn(
                "gap-1",
                isConnected ? "border-green-500 text-green-400" : 
                status === "reconnecting" ? "border-yellow-500 text-yellow-400" :
                "border-red-500 text-red-400"
              )}
              data-testid="badge-ws-status"
            >
              {isConnected ? <Wifi className="h-3 w-3" /> : 
               status === "reconnecting" ? <RefreshCw className="h-3 w-3 animate-spin" /> :
               <WifiOff className="h-3 w-3" />}
              {status === "connected" ? "Conectado" : 
               status === "reconnecting" ? "Reconectando..." : 
               status === "connecting" ? "Conectando..." : "Desconectado"}
            </Badge>
          </div>
          
          <div className="flex items-center gap-2">
            <div className="text-xs text-muted-foreground hidden sm:flex gap-3">
              <span>Eventos: {stats.total}</span>
              <span className="text-red-400">Errores 24h: {stats.errors}</span>
              <span className="text-yellow-400">Avisos 24h: {stats.warnings}</span>
              <span className="text-green-400">Trades 24h: {stats.trades}</span>
              {lastMessageTime && (
                <span className="text-cyan-400" data-testid="last-message-time">
                  √öltimo: {lastMessageTime.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit", second: "2-digit" })}
                </span>
              )}
            </div>
          </div>
        </div>

        <Card className="border-border/50">
          <CardHeader className="py-3 px-4">
            <div className="flex flex-wrap items-center gap-2 justify-between">
              <div className="flex items-center gap-2">
                <div className="relative">
                  <Search className="absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                  <Input
                    placeholder="Buscar..."
                    value={searchText}
                    onChange={(e) => setSearchText(e.target.value)}
                    className="pl-8 h-8 w-40 sm:w-60"
                    data-testid="input-search"
                  />
                  {searchText && (
                    <button 
                      onClick={() => setSearchText("")}
                      className="absolute right-2 top-1/2 -translate-y-1/2"
                    >
                      <X className="h-3 w-3 text-muted-foreground hover:text-foreground" />
                    </button>
                  )}
                </div>
                
                <div className="flex gap-1">
                  {["INFO", "WARN", "ERROR"].map(level => (
                    <Button
                      key={level}
                      variant="outline"
                      size="sm"
                      className={cn(
                        "h-8 px-2 text-xs",
                        levelFilter.includes(level) ? LEVEL_COLORS[level] : "opacity-40"
                      )}
                      onClick={() => toggleLevel(level)}
                      data-testid={`button-filter-${level.toLowerCase()}`}
                    >
                      {LEVEL_ICONS[level]}
                      <span className="hidden sm:inline ml-1">{level}</span>
                    </Button>
                  ))}
                </div>

                <Button
                  variant="ghost"
                  size="sm"
                  className="h-8 text-xs"
                  onClick={() => setShowFilters(!showFilters)}
                >
                  Filtros
                  {showFilters ? <ChevronDown className="ml-1 h-3 w-3" /> : <ChevronRight className="ml-1 h-3 w-3" />}
                </Button>
              </div>

              <div className="flex items-center gap-1">
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8"
                  onClick={() => setAutoScroll(!autoScroll)}
                  title={autoScroll ? "Pausar auto-scroll" : "Reanudar auto-scroll"}
                  data-testid="button-autoscroll"
                >
                  {autoScroll ? <Pause className="h-4 w-4" /> : <Play className="h-4 w-4" />}
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8"
                  onClick={clearEvents}
                  title="Limpiar"
                  data-testid="button-clear"
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8"
                  onClick={handleCopyAll}
                  title="Copiar todo"
                  data-testid="button-copy-all"
                >
                  <Copy className="h-4 w-4" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  className="h-8 w-8"
                  onClick={handleDownload}
                  title="Descargar"
                  data-testid="button-download"
                >
                  <Download className="h-4 w-4" />
                </Button>
                {!isConnected && (
                  <Button
                    variant="outline"
                    size="sm"
                    className="h-8"
                    onClick={connect}
                    data-testid="button-reconnect"
                  >
                    Reconectar
                  </Button>
                )}
              </div>
            </div>

            {showFilters && (
              <div className="mt-3 pt-3 border-t border-border/50 space-y-2">
                <div className="flex flex-wrap gap-1" data-testid="filter-type-container">
                  <span className="text-xs text-muted-foreground mr-2">Tipo:</span>
                  {availableEventTypes.map((type: string) => (
                    <Badge
                      key={type}
                      variant="outline"
                      className={cn(
                        "cursor-pointer text-xs",
                        typeFilter.includes(type) ? "bg-primary/20" : "opacity-50"
                      )}
                      onClick={() => setTypeFilter(prev => 
                        prev.includes(type) ? prev.filter(t => t !== type) : [...prev, type]
                      )}
                      data-testid={`filter-type-${type}`}
                    >
                      {type.replace(/_/g, " ")}
                    </Badge>
                  ))}
                  {typeFilter.length > 0 && (
                    <Button variant="ghost" size="sm" className="h-5 text-xs" onClick={() => setTypeFilter([])} data-testid="button-clear-type-filter">
                      Limpiar
                    </Button>
                  )}
                </div>
                <div className="flex flex-wrap gap-1" data-testid="filter-pair-container">
                  <span className="text-xs text-muted-foreground mr-2">Par:</span>
                  {availablePairs.map((pair: string) => (
                    <Badge
                      key={pair}
                      variant="outline"
                      className={cn(
                        "cursor-pointer text-xs",
                        pairFilter.includes(pair) ? "bg-primary/20" : "opacity-50"
                      )}
                      onClick={() => setPairFilter(prev => 
                        prev.includes(pair) ? prev.filter(p => p !== pair) : [...prev, pair]
                      )}
                      data-testid={`filter-pair-${pair.replace("/", "-")}`}
                    >
                      {pair}
                    </Badge>
                  ))}
                  {pairFilter.length > 0 && (
                    <Button variant="ghost" size="sm" className="h-5 text-xs" onClick={() => setPairFilter([])} data-testid="button-clear-pair-filter">
                      Limpiar
                    </Button>
                  )}
                </div>
              </div>
            )}
          </CardHeader>
          
          <CardContent className="p-0">
            <ScrollArea className="h-[calc(100vh-320px)]" ref={scrollRef}>
              <div className="font-mono text-xs divide-y divide-border/30">
                {filteredEvents.length === 0 ? (
                  <div className="p-8 text-center text-muted-foreground">
                    {events.length === 0 ? "Esperando eventos..." : "No hay eventos que coincidan con los filtros"}
                  </div>
                ) : (
                  filteredEvents.map((event, idx) => (
                    <div
                      key={event.id || `${event.timestamp}-${idx}`}
                      className={cn(
                        "px-3 py-2 hover:bg-muted/30 cursor-pointer transition-colors",
                        selectedEvent?.id === event.id && "bg-muted/50"
                      )}
                      onClick={() => setSelectedEvent(event)}
                      data-testid={`event-row-${event.id || idx}`}
                    >
                      <div className="flex items-start gap-2">
                        <span className="text-muted-foreground whitespace-nowrap">
                          {formatDate(event.timestamp)} {formatTimestamp(event.timestamp)}
                        </span>
                        <Badge 
                          variant="outline" 
                          className={cn("text-[10px] px-1.5 py-0", LEVEL_COLORS[event.level])}
                        >
                          {event.level}
                        </Badge>
                        <Badge variant="outline" className="text-[10px] px-1.5 py-0 bg-muted/50">
                          {event.type.replace(/_/g, " ")}
                        </Badge>
                        {event.meta?.pair && (
                          <Badge variant="outline" className="text-[10px] px-1.5 py-0">
                            {event.meta.pair}
                          </Badge>
                        )}
                        <span className="text-foreground truncate flex-1">
                          {event.message}
                        </span>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </ScrollArea>
          </CardContent>
        </Card>
      </div>

      <div className="w-full lg:w-80 xl:w-96" data-testid="event-detail-panel">
        <Card className="border-border/50 sticky top-20">
          <CardHeader className="py-3 px-4">
            <CardTitle className="text-sm">Detalle del evento</CardTitle>
          </CardHeader>
          <CardContent className="p-4 pt-0">
            {selectedEvent ? (
              <div className="space-y-3 text-xs" data-testid="event-detail-content">
                <div className="flex justify-between items-start">
                  <Badge className={cn(LEVEL_COLORS[selectedEvent.level])} data-testid="detail-level-badge">
                    {selectedEvent.level}
                  </Badge>
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-6 text-xs"
                    onClick={() => handleCopyEvent(selectedEvent)}
                    data-testid="button-copy-event"
                  >
                    <Copy className="h-3 w-3 mr-1" />
                    Copiar
                  </Button>
                </div>
                
                <div>
                  <span className="text-muted-foreground">Timestamp:</span>
                  <p className="font-mono" data-testid="detail-timestamp">{new Date(selectedEvent.timestamp).toLocaleString("es-ES")}</p>
                </div>
                
                <div>
                  <span className="text-muted-foreground">Tipo:</span>
                  <p className="font-mono" data-testid="detail-type">{selectedEvent.type}</p>
                </div>
                
                <div>
                  <span className="text-muted-foreground">Mensaje:</span>
                  <p className="break-words" data-testid="detail-message">{selectedEvent.message}</p>
                </div>
                
                {selectedEvent.meta && (
                  <div>
                    <span className="text-muted-foreground">Meta:</span>
                    <pre className="mt-1 p-2 bg-muted/50 rounded text-[10px] overflow-x-auto max-h-60" data-testid="detail-meta">
                      {JSON.stringify(selectedEvent.meta, null, 2)}
                    </pre>
                  </div>
                )}
              </div>
            ) : (
              <p className="text-muted-foreground text-sm" data-testid="detail-empty-message">
                Selecciona un evento para ver los detalles
              </p>
            )}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

function TerminalTab() {
  const {
    lines,
    status,
    error,
    sources,
    activeSource,
    dockerEnabled,
    lineCount,
    lastLineTime,
    connect,
    startSource,
    stopSource,
    clearLines,
    isConnected,
  } = useTerminalWebSocket({ autoConnect: true });
  
  const [autoScroll, setAutoScroll] = useState(true);
  const [isPaused, setIsPaused] = useState(false);
  const scrollRef = useRef<HTMLDivElement>(null);
  const prevLinesLengthRef = useRef(lines.length);

  useEffect(() => {
    if (autoScroll && !isPaused && lines.length > prevLinesLengthRef.current && scrollRef.current) {
      const scrollArea = scrollRef.current.querySelector('[data-radix-scroll-area-viewport]');
      if (scrollArea) {
        scrollArea.scrollTop = scrollArea.scrollHeight;
      }
    }
    prevLinesLengthRef.current = lines.length;
  }, [lines.length, autoScroll, isPaused]);

  const displayLines = isPaused ? lines.slice(0, prevLinesLengthRef.current) : lines;

  return (
    <div className="space-y-4">
      <div className="flex flex-wrap items-center gap-2 justify-between">
        <div className="flex items-center gap-2">
          <Badge 
            variant="outline" 
            className={cn(
              "gap-1",
              isConnected ? "border-green-500 text-green-400" : 
              status === "reconnecting" ? "border-yellow-500 text-yellow-400" :
              "border-red-500 text-red-400"
            )}
            data-testid="terminal-ws-status"
          >
            {isConnected ? <Wifi className="h-3 w-3" /> : 
             status === "reconnecting" ? <RefreshCw className="h-3 w-3 animate-spin" /> :
             <WifiOff className="h-3 w-3" />}
            {status === "connected" ? "Conectado" : 
             status === "reconnecting" ? "Reconectando..." : 
             status === "connecting" ? "Conectando..." : "Desconectado"}
          </Badge>
          
          {isConnected && (
            <Select
              value={activeSource || ""}
              onValueChange={(value) => {
                if (value) startSource(value);
              }}
            >
              <SelectTrigger className="w-[200px] h-8" data-testid="terminal-source-select">
                <SelectValue placeholder="Seleccionar fuente..." />
              </SelectTrigger>
              <SelectContent>
                {sources.length === 0 ? (
                  <SelectItem value="__empty__" disabled>
                    {dockerEnabled ? "Sin fuentes" : "Docker deshabilitado"}
                  </SelectItem>
                ) : (
                  sources.map((source) => (
                    <SelectItem key={source.id} value={source.id} data-testid={`source-${source.id}`}>
                      {source.name}
                    </SelectItem>
                  ))
                )}
              </SelectContent>
            </Select>
          )}
          
          {activeSource && (
            <Button
              variant="outline"
              size="sm"
              className="h-8"
              onClick={stopSource}
              data-testid="button-stop-source"
            >
              Detener
            </Button>
          )}
        </div>
        
        <div className="flex items-center gap-2">
          <div className="text-xs text-muted-foreground hidden sm:flex gap-3">
            <span>L√≠neas: {lineCount}</span>
            {lastLineTime && (
              <span className="text-cyan-400" data-testid="terminal-last-line-time">
                √öltimo: {lastLineTime.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit", second: "2-digit" })}
              </span>
            )}
          </div>
          
          <div className="flex items-center gap-1">
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8"
              onClick={() => {
                setIsPaused(!isPaused);
                if (isPaused) {
                  prevLinesLengthRef.current = lines.length;
                }
              }}
              title={isPaused ? "Reanudar" : "Pausar"}
              data-testid="button-terminal-pause"
            >
              {isPaused ? <Play className="h-4 w-4" /> : <Pause className="h-4 w-4" />}
            </Button>
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8"
              onClick={clearLines}
              title="Limpiar"
              data-testid="button-terminal-clear"
            >
              <Trash2 className="h-4 w-4" />
            </Button>
            {!isConnected && (
              <Button
                variant="outline"
                size="sm"
                className="h-8"
                onClick={connect}
                data-testid="button-terminal-reconnect"
              >
                Reconectar
              </Button>
            )}
          </div>
        </div>
      </div>

      {error && (
        <div className="bg-red-500/10 border border-red-500/30 text-red-400 rounded p-3 text-sm" data-testid="terminal-error">
          {error}
        </div>
      )}

      <Card className="border-border/50 bg-black/80">
        <CardContent className="p-0">
          <ScrollArea className="h-[calc(100vh-280px)]" ref={scrollRef}>
            <div className="font-mono text-xs p-3 text-green-400 whitespace-pre-wrap">
              {!isConnected ? (
                <div className="text-muted-foreground">
                  {status === "connecting" ? "Conectando al servidor..." : "Desconectado. Haz clic en 'Reconectar'."}
                </div>
              ) : !activeSource ? (
                <div className="text-muted-foreground">
                  Selecciona una fuente de logs para comenzar...
                  {!dockerEnabled && (
                    <div className="mt-2 text-yellow-400">
                      Docker deshabilitado. Configura ENABLE_DOCKER_LOGS_STREAM=true en el servidor para habilitar logs de Docker.
                    </div>
                  )}
                </div>
              ) : displayLines.length === 0 ? (
                <div className="text-muted-foreground">
                  Esperando l√≠neas de log...
                </div>
              ) : (
                displayLines.map((logLine) => (
                  <div 
                    key={logLine.id} 
                    className={cn(
                      "py-0.5",
                      logLine.isError && "text-red-400"
                    )}
                    data-testid={`log-line-${logLine.id}`}
                  >
                    {logLine.line}
                  </div>
                ))
              )}
            </div>
          </ScrollArea>
        </CardContent>
      </Card>
      
      {isPaused && (
        <div className="text-center text-yellow-400 text-sm" data-testid="terminal-paused-indicator">
          Pausado - Nuevas l√≠neas no se muestran
        </div>
      )}
    </div>
  );
}

interface DiagnosticPair {
  pair: string;
  signal: string;
  razon: string;
  cooldownSec?: number;
  exposureAvailable: number | { maxPairAvailable: number; maxTotalAvailable: number; maxAllowed: number };
  hasPosition: boolean;
  positionUsd?: number;
}

interface DiagnosticData {
  pairs: DiagnosticPair[];
  positionMode: string;
  usdBalance: number;
  totalOpenPositions: number;
  lastScanAt: string | null;
}

function DiagnosticTab() {
  const { data, isLoading, isFetching, error, refetch } = useQuery<DiagnosticData>({
    queryKey: ["/api/scan/diagnostic"],
    refetchInterval: 10000,
    staleTime: 0,
  });

  const getSignalBadge = (signal: string) => {
    switch (signal) {
      case "BUY":
        return (
          <Badge className="bg-green-500/20 text-green-400 border-green-500/30 gap-1">
            <TrendingUp className="h-3 w-3" />
            COMPRA
          </Badge>
        );
      case "SELL":
        return (
          <Badge className="bg-red-500/20 text-red-400 border-red-500/30 gap-1">
            <TrendingDown className="h-3 w-3" />
            VENTA
          </Badge>
        );
      default:
        return (
          <Badge className="bg-muted text-muted-foreground border-muted-foreground/30 gap-1">
            <Minus className="h-3 w-3" />
            SIN SE√ëAL
          </Badge>
        );
    }
  };

  const formatTime = (isoString: string | null) => {
    if (!isoString) return "Nunca";
    const date = new Date(isoString);
    return date.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  };

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader className="flex flex-row items-center justify-between pb-2">
          <CardTitle className="text-lg">Diagn√≥stico de Escaneo</CardTitle>
          <div className="flex items-center gap-2">
            {data && (
              <span className="text-xs text-muted-foreground">
                √öltimo scan: {formatTime(data.lastScanAt)}
              </span>
            )}
            <Button 
              variant="outline" 
              size="sm" 
              onClick={() => refetch()}
              disabled={isFetching}
              data-testid="btn-refresh-diagnostic"
            >
              <RefreshCw className={cn("h-4 w-4", isFetching && "animate-spin")} />
              Actualizar
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          {error ? (
            <div className="text-red-400 text-sm" data-testid="diagnostic-error">
              Error al cargar diagn√≥stico: {(error as Error).message}
            </div>
          ) : !data ? (
            <div className="text-muted-foreground text-sm">Cargando...</div>
          ) : (
            <>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div className="bg-muted/30 rounded-lg p-3">
                  <div className="text-xs text-muted-foreground">Modo</div>
                  <div className="text-lg font-semibold" data-testid="diagnostic-mode">{data.positionMode}</div>
                </div>
                <div className="bg-muted/30 rounded-lg p-3">
                  <div className="text-xs text-muted-foreground">Balance USD</div>
                  <div className="text-lg font-semibold" data-testid="diagnostic-balance">${data.usdBalance.toFixed(2)}</div>
                </div>
                <div className="bg-muted/30 rounded-lg p-3">
                  <div className="text-xs text-muted-foreground">Posiciones Abiertas</div>
                  <div className="text-lg font-semibold" data-testid="diagnostic-positions">{data.totalOpenPositions}</div>
                </div>
                <div className="bg-muted/30 rounded-lg p-3">
                  <div className="text-xs text-muted-foreground">Pares Escaneados</div>
                  <div className="text-lg font-semibold" data-testid="diagnostic-pairs-count">{data.pairs.length}</div>
                </div>
              </div>

              {data.pairs.length === 0 ? (
                <div className="text-muted-foreground text-sm text-center py-8" data-testid="diagnostic-no-data">
                  No hay datos de escaneo. Activa el bot para comenzar a escanear pares.
                </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-sm" data-testid="diagnostic-table">
                    <thead>
                      <tr className="border-b border-muted">
                        <th className="text-left py-2 px-3 font-medium">Par</th>
                        <th className="text-left py-2 px-3 font-medium">Se√±al</th>
                        <th className="text-left py-2 px-3 font-medium">Raz√≥n</th>
                        <th className="text-right py-2 px-3 font-medium">Cooldown</th>
                        <th className="text-right py-2 px-3 font-medium">Disponible</th>
                        <th className="text-center py-2 px-3 font-medium">Posici√≥n</th>
                      </tr>
                    </thead>
                    <tbody>
                      {data.pairs.map((p) => (
                        <tr 
                          key={p.pair} 
                          className="border-b border-muted/50 hover:bg-muted/20"
                          data-testid={`diagnostic-row-${p.pair.replace("/", "-")}`}
                        >
                          <td className="py-2 px-3 font-mono">{p.pair}</td>
                          <td className="py-2 px-3">{getSignalBadge(p.signal)}</td>
                          <td className="py-2 px-3 text-muted-foreground">{p.razon}</td>
                          <td className="py-2 px-3 text-right font-mono text-muted-foreground">
                            {p.cooldownSec && p.cooldownSec > 0 ? `${p.cooldownSec}s` : "-"}
                          </td>
                          <td className="py-2 px-3 text-right font-mono">
                            ${typeof p.exposureAvailable === 'object' 
                              ? (p.exposureAvailable?.maxAllowed?.toFixed(2) || "0.00")
                              : (p.exposureAvailable?.toFixed(2) || "0.00")}
                          </td>
                          <td className="py-2 px-3 text-center">
                            {p.hasPosition ? (
                              <Badge variant="secondary" className="bg-blue-500/20 text-blue-400">
                                ${p.positionUsd?.toFixed(0) || "?"}
                              </Badge>
                            ) : (
                              <span className="text-muted-foreground">-</span>
                            )}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </>
          )}
        </CardContent>
      </Card>
    </div>
  );
}


===== FILE: ./client/src/pages/Guide.tsx =====
import { Nav } from "@/components/dashboard/Nav";
import generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { 
  BookOpen, 
  Zap, 
  Settings, 
  AlertTriangle, 
  CheckCircle2, 
  TrendingUp, 
  TrendingDown,
  Activity,
  Target,
  RefreshCw,
  Shield,
  DollarSign,
  Clock,
  BarChart3,
  Plug,
  HelpCircle,
  ListChecks,
  Lightbulb,
  XCircle,
  WifiOff,
  Key,
  Percent,
  CandlestickChart,
  Bell,
  Database
} from "lucide-react";

export default function Guide() {
  return (
    <div className="min-h-screen bg-background flex flex-col relative overflow-hidden">
      <div 
        className="fixed inset-0 z-0 opacity-20 pointer-events-none" 
        style={{ 
          backgroundImage: `url(${generatedImage})`, 
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          mixBlendMode: 'overlay'
        }} 
      />
      
      <div className="relative z-10 flex flex-col min-h-screen">
        <Nav />
        
        <main className="flex-1 p-4 md:p-6 max-w-5xl mx-auto w-full space-y-6 md:space-y-8">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-primary/20 rounded-lg">
              <BookOpen className="h-6 w-6 md:h-8 md:w-8 text-primary" />
            </div>
            <div>
              <h1 className="text-xl md:text-3xl font-bold font-sans tracking-tight">Gu√≠a del Bot</h1>
              <p className="text-sm md:text-base text-muted-foreground">Manual completo de uso y configuraci√≥n</p>
            </div>
          </div>

          <div className="grid gap-6">
            
            {/* Secci√≥n 1: ¬øQu√© hace este bot? */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-cyan-500/20 rounded-lg">
                    <Zap className="h-6 w-6 text-cyan-400" />
                  </div>
                  <div>
                    <CardTitle className="text-lg md:text-xl">1. ¬øQu√© hace este bot?</CardTitle>
                    <CardDescription>Resumen general del funcionamiento</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <p className="text-sm md:text-base text-muted-foreground leading-relaxed">
                  KrakenBot.AI es un bot de trading autom√°tico que opera en el exchange Kraken. 
                  Analiza el mercado 24/7 usando indicadores t√©cnicos avanzados y ejecuta operaciones 
                  de compra/venta de forma aut√≥noma seg√∫n la estrategia configurada.
                </p>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 border border-border rounded-lg bg-card/30">
                    <h4 className="font-semibold mb-2 flex items-center gap-2">
                      <Activity className="h-4 w-4 text-primary" />
                      Estrategias incluidas
                    </h4>
                    <ul className="text-sm text-muted-foreground space-y-1">
                      <li className="flex items-center gap-2">
                        <TrendingUp className="h-3 w-3 text-green-500" />
                        <strong>Momentum:</strong> Sigue tendencias fuertes
                      </li>
                      <li className="flex items-center gap-2">
                        <RefreshCw className="h-3 w-3 text-blue-500" />
                        <strong>Reversi√≥n a la media:</strong> Opera en extremos
                      </li>
                      <li className="flex items-center gap-2">
                        <Zap className="h-3 w-3 text-yellow-500" />
                        <strong>Scalping:</strong> Operaciones r√°pidas
                      </li>
                      <li className="flex items-center gap-2">
                        <Target className="h-3 w-3 text-purple-500" />
                        <strong>Grid:</strong> √ìrdenes escalonadas
                      </li>
                    </ul>
                  </div>
                  
                  <div className="p-4 border border-border rounded-lg bg-card/30">
                    <h4 className="font-semibold mb-2 flex items-center gap-2">
                      <DollarSign className="h-4 w-4 text-primary" />
                      Pares soportados
                    </h4>
                    <div className="flex flex-wrap gap-2">
                      <Badge variant="outline">BTC/USD</Badge>
                      <Badge variant="outline">ETH/USD</Badge>
                      <Badge variant="outline">SOL/USD</Badge>
                      <Badge variant="outline">XRP/USD</Badge>
                      <Badge variant="outline">TON/USD</Badge>
                      <Badge variant="outline">ETH/BTC</Badge>
                    </div>
                  </div>
                </div>

                <div className="p-4 border border-primary/30 rounded-lg bg-primary/5">
                  <h4 className="font-semibold mb-2 flex items-center gap-2">
                    <BarChart3 className="h-4 w-4 text-primary" />
                    Indicadores t√©cnicos utilizados
                  </h4>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                    <span className="text-muted-foreground">‚Ä¢ MACD</span>
                    <span className="text-muted-foreground">‚Ä¢ RSI</span>
                    <span className="text-muted-foreground">‚Ä¢ Bollinger Bands</span>
                    <span className="text-muted-foreground">‚Ä¢ EMAs (9, 21, 50)</span>
                    <span className="text-muted-foreground">‚Ä¢ Volumen</span>
                    <span className="text-muted-foreground">‚Ä¢ ATR</span>
                    <span className="text-muted-foreground">‚Ä¢ Multi-timeframe</span>
                    <span className="text-muted-foreground">‚Ä¢ An√°lisis de tendencia</span>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Secci√≥n 2: Pasos para usar el bot */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-green-500/20 rounded-lg">
                    <ListChecks className="h-6 w-6 text-green-400" />
                  </div>
                  <div>
                    <CardTitle className="text-lg md:text-xl">2. Pasos para usar el bot</CardTitle>
                    <CardDescription>Flujo b√°sico de configuraci√≥n</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {[
                    { step: 1, title: "Configurar API de Kraken", desc: "Ve a Integraciones y a√±ade tu API Key y Secret de Kraken. Aseg√∫rate de que la API tenga permisos de trading.", icon: Key },
                    { step: 2, title: "Configurar Telegram (opcional)", desc: "A√±ade el token de tu bot de Telegram y tu Chat ID para recibir notificaciones de operaciones.", icon: Plug },
                    { step: 3, title: "Elegir estrategia", desc: "En la p√°gina Estrategias, selecciona el algoritmo que mejor se adapte a tu estilo (momentum, scalping, etc.).", icon: Activity },
                    { step: 4, title: "Ajustar par√°metros de riesgo", desc: "Configura el nivel de riesgo, Stop Loss y Take Profit seg√∫n tu tolerancia.", icon: Shield },
                    { step: 5, title: "Activar el bot", desc: "Activa el switch 'Bot Activo' y el bot comenzar√° a analizar el mercado y operar autom√°ticamente.", icon: Zap },
                  ].map((item) => (
                    <div key={item.step} className="flex gap-4 p-4 border border-border rounded-lg bg-card/30">
                      <div className="flex-shrink-0 h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center font-bold text-primary">
                        {item.step}
                      </div>
                      <div className="flex-1">
                        <h4 className="font-semibold flex items-center gap-2">
                          <item.icon className="h-4 w-4 text-primary" />
                          {item.title}
                        </h4>
                        <p className="text-sm text-muted-foreground mt-1">{item.desc}</p>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>

            {/* Secci√≥n 3: Par√°metros y definiciones */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-purple-500/20 rounded-lg">
                    <Settings className="h-6 w-6 text-purple-400" />
                  </div>
                  <div>
                    <CardTitle className="text-lg md:text-xl">3. Par√°metros y definiciones</CardTitle>
                    <CardDescription>Explicaci√≥n detallada de cada configuraci√≥n</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent>
                <Accordion type="single" collapsible className="w-full">
                  
                  <AccordionItem value="strategy">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Activity className="h-4 w-4 text-primary" />
                        Estrategia de Trading
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> El algoritmo que el bot usa para decidir cu√°ndo comprar o vender.</p>
                      <div className="space-y-2">
                        <div className="p-3 bg-card/50 rounded border border-border">
                          <p className="font-medium text-green-400">Momentum</p>
                          <p className="text-muted-foreground">Sigue tendencias fuertes. Compra cuando el precio sube con fuerza, vende cuando baja. Ideal para mercados con tendencia clara.</p>
                        </div>
                        <div className="p-3 bg-card/50 rounded border border-border">
                          <p className="font-medium text-blue-400">Reversi√≥n a la Media</p>
                          <p className="text-muted-foreground">Opera cuando el precio se aleja mucho de su promedio. Compra en ca√≠das extremas, vende en subidas extremas.</p>
                        </div>
                        <div className="p-3 bg-card/50 rounded border border-border">
                          <p className="font-medium text-yellow-400">Scalping</p>
                          <p className="text-muted-foreground">Muchas operaciones peque√±as y r√°pidas. Busca peque√±os beneficios frecuentes. Requiere m√°s comisiones.</p>
                        </div>
                        <div className="p-3 bg-card/50 rounded border border-border">
                          <p className="font-medium text-purple-400">Grid Trading</p>
                          <p className="text-muted-foreground">Coloca √≥rdenes de compra y venta en niveles de precio fijos. Funciona bien en mercados laterales.</p>
                        </div>
                      </div>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="signalmode">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <CandlestickChart className="h-4 w-4 text-cyan-500" />
                        Modo de Se√±al (Solo Momentum)
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> Define cu√°ndo y c√≥mo el bot eval√∫a las se√±ales de trading cuando usas la estrategia Momentum.</p>
                      <div className="space-y-2">
                        <div className="p-3 bg-card/50 rounded border border-border">
                          <p className="font-medium text-primary">Ciclos (30 segundos)</p>
                          <p className="text-muted-foreground">Eval√∫a precios en tiempo real cada ciclo del bot (~30s). Usa indicadores sobre datos de ticks. M√°s reactivo pero puede generar m√°s se√±ales falsas. <strong>Ideal para:</strong> Trading activo, mercados muy vol√°tiles.</p>
                        </div>
                        <div className="p-3 bg-cyan-500/10 rounded border border-cyan-500/30">
                          <p className="font-medium text-cyan-400">Velas 5 minutos</p>
                          <p className="text-muted-foreground">Solo eval√∫a al cierre de cada vela de 5 min. Usa an√°lisis OHLC completo: EMA, RSI, MACD, patrones de velas (Engulfing), volumen relativo. <strong>Ideal para:</strong> Balance entre rapidez y confirmaci√≥n.</p>
                        </div>
                        <div className="p-3 bg-cyan-500/10 rounded border border-cyan-500/30">
                          <p className="font-medium text-cyan-400">Velas 15 minutos</p>
                          <p className="text-muted-foreground">Eval√∫a cada 15 minutos al cierre de vela. Menos ruido del mercado, se√±ales m√°s confirmadas. <strong>Ideal para:</strong> Swing trading, menos operaciones pero m√°s seguras.</p>
                        </div>
                        <div className="p-3 bg-cyan-500/10 rounded border border-cyan-500/30">
                          <p className="font-medium text-cyan-400">Velas 1 hora</p>
                          <p className="text-muted-foreground">Evaluaci√≥n cada hora. M√≠nimas se√±ales falsas, solo opera en tendencias claras y confirmadas. <strong>Ideal para:</strong> Posiciones largas, m√≠nima intervenci√≥n.</p>
                        </div>
                      </div>
                      <div className="p-3 bg-primary/10 rounded border border-primary/30">
                        <p className="text-xs"><strong>Nota:</strong> En modo Velas, el bot usa an√°lisis OHLC avanzado incluyendo patrones de velas japonesas (Engulfing alcista/bajista), Bandas de Bollinger, y an√°lisis de volumen relativo que no est√°n disponibles en modo Ciclos.</p>
                      </div>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="risk">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Shield className="h-4 w-4 text-primary" />
                        Nivel de Riesgo
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> Controla el tama√±o de las posiciones y la agresividad del bot.</p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <div className="p-3 bg-green-500/10 rounded border border-green-500/30">
                          <p className="font-medium text-green-400">Bajo</p>
                          <p className="text-muted-foreground text-xs">Posiciones peque√±as, stops ajustados. Menor ganancia pero menor riesgo.</p>
                        </div>
                        <div className="p-3 bg-yellow-500/10 rounded border border-yellow-500/30">
                          <p className="font-medium text-yellow-400">Medio</p>
                          <p className="text-muted-foreground text-xs">Balance entre riesgo y rendimiento. Recomendado para la mayor√≠a.</p>
                        </div>
                        <div className="p-3 bg-red-500/10 rounded border border-red-500/30">
                          <p className="font-medium text-red-400">Alto</p>
                          <p className="text-muted-foreground text-xs">Posiciones grandes, m√°s volatilidad. Mayor ganancia potencial pero m√°s riesgo.</p>
                        </div>
                      </div>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="stoploss">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <TrendingDown className="h-4 w-4 text-red-500" />
                        Stop Loss (%)
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> Porcentaje m√°ximo de p√©rdida que el bot tolerar√° antes de cerrar una posici√≥n autom√°ticamente.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p><strong>Valores recomendados:</strong> Entre 2% y 5%</p>
                        <p className="text-muted-foreground mt-1">
                          <strong>Muy bajo (1%):</strong> Se cerrar√°n posiciones muy r√°pido, posibles p√©rdidas por volatilidad normal.<br/>
                          <strong>Muy alto (10%+):</strong> P√©rdidas grandes si el mercado va en contra.
                        </p>
                      </div>
                      <p className="text-muted-foreground">
                        <strong>Ejemplo:</strong> Si compras BTC a $100,000 con Stop Loss 3%, la posici√≥n se cerrar√° autom√°ticamente si BTC baja a $97,000.
                      </p>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="takeprofit">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <TrendingUp className="h-4 w-4 text-green-500" />
                        Take Profit (%)
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> Porcentaje de ganancia objetivo. Cuando se alcanza, el bot cierra la posici√≥n asegurando beneficios.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p><strong>Valores recomendados:</strong> Entre 3% y 10%</p>
                        <p className="text-muted-foreground mt-1">
                          <strong>Muy bajo (1%):</strong> Ganancias peque√±as, las comisiones pueden comerlas.<br/>
                          <strong>Muy alto (20%+):</strong> Dif√≠cil de alcanzar, el precio puede revertir antes.
                        </p>
                      </div>
                      <p className="text-muted-foreground">
                        <strong>Ejemplo:</strong> Si compras ETH a $3,000 con Take Profit 5%, la posici√≥n se cerrar√° autom√°ticamente cuando ETH llegue a $3,150.
                      </p>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="trailing">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Percent className="h-4 w-4 text-primary" />
                        Trailing Stop
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> Un stop loss din√°mico que sigue al precio cuando este sube, asegurando ganancias progresivamente.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p><strong>C√≥mo funciona:</strong></p>
                        <p className="text-muted-foreground mt-1">
                          Si activas Trailing Stop al 2% y el precio sube un 5%, el stop se mueve autom√°ticamente para asegurar al menos un 3% de ganancia.
                        </p>
                      </div>
                      <p className="text-muted-foreground">
                        <strong>Recomendaci√≥n:</strong> Act√≠valo si quieres capturar tendencias largas sin preocuparte por el Take Profit fijo.
                      </p>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="pairs">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <DollarSign className="h-4 w-4 text-primary" />
                        Pares Activos
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> Las criptomonedas que el bot analizar√° y operar√°.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p className="text-muted-foreground">
                          <strong>Pocos pares (1-2):</strong> El bot se concentra en esos mercados, operaciones m√°s frecuentes por par.<br/>
                          <strong>Muchos pares (5+):</strong> M√°s oportunidades pero el capital se divide, operaciones m√°s peque√±as.
                        </p>
                      </div>
                      <p className="text-muted-foreground">
                        <strong>Recomendaci√≥n para saldos peque√±os:</strong> Activa solo 1-2 pares con mejor liquidez (BTC/USD, ETH/USD).
                      </p>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="timeframes">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Clock className="h-4 w-4 text-primary" />
                        Multi-Timeframe
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> El bot analiza m√∫ltiples marcos temporales para confirmar se√±ales.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p className="text-muted-foreground">
                          <strong>5 minutos:</strong> Se√±ales de entrada r√°pidas<br/>
                          <strong>1 hora:</strong> Tendencia a corto plazo<br/>
                          <strong>4 horas:</strong> Tendencia general del mercado
                        </p>
                      </div>
                      <p className="text-muted-foreground">
                        El bot no operar√° contra la tendencia principal. Si los 3 timeframes coinciden en direcci√≥n, a√±ade +15% de confianza a la se√±al.
                      </p>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="indicators">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <BarChart3 className="h-4 w-4 text-primary" />
                        Indicadores T√©cnicos por Estrategia
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© son?</strong> F√≥rmulas matem√°ticas que analizan el precio y volumen para predecir movimientos.</p>
                      <div className="space-y-2">
                        <div className="p-3 bg-green-500/10 rounded border border-green-500/30">
                          <p className="font-medium text-green-400">Momentum usa:</p>
                          <ul className="text-muted-foreground text-xs mt-1 space-y-1">
                            <li>‚Ä¢ <strong>EMAs (9, 21, 50):</strong> Medias m√≥viles exponenciales para detectar tendencia</li>
                            <li>‚Ä¢ <strong>MACD:</strong> Se√±al=12, L√≠nea=26, Histograma para momentum</li>
                            <li>‚Ä¢ <strong>RSI (14):</strong> Fuerza relativa, se√±ales cuando &gt;70 o &lt;30</li>
                          </ul>
                        </div>
                        <div className="p-3 bg-blue-500/10 rounded border border-blue-500/30">
                          <p className="font-medium text-blue-400">Reversi√≥n a la Media usa:</p>
                          <ul className="text-muted-foreground text-xs mt-1 space-y-1">
                            <li>‚Ä¢ <strong>Bollinger Bands (20, 2):</strong> Detecta extremos de precio</li>
                            <li>‚Ä¢ <strong>RSI (14):</strong> Sobreventa &lt;30 = compra, sobrecompra &gt;70 = venta</li>
                            <li>‚Ä¢ <strong>EMA 50:</strong> Referencia de precio promedio</li>
                          </ul>
                        </div>
                        <div className="p-3 bg-yellow-500/10 rounded border border-yellow-500/30">
                          <p className="font-medium text-yellow-400">Scalping usa:</p>
                          <ul className="text-muted-foreground text-xs mt-1 space-y-1">
                            <li>‚Ä¢ <strong>EMAs r√°pidas (9, 21):</strong> Cruces para entradas r√°pidas</li>
                            <li>‚Ä¢ <strong>Volumen:</strong> Confirma fuerza del movimiento</li>
                            <li>‚Ä¢ <strong>ATR:</strong> Volatilidad para ajustar stops din√°micos</li>
                          </ul>
                        </div>
                        <div className="p-3 bg-purple-500/10 rounded border border-purple-500/30">
                          <p className="font-medium text-purple-400">Grid Trading usa:</p>
                          <ul className="text-muted-foreground text-xs mt-1 space-y-1">
                            <li>‚Ä¢ <strong>ATR:</strong> Calcula separaci√≥n entre niveles del grid</li>
                            <li>‚Ä¢ <strong>Soporte/Resistencia:</strong> Define l√≠mites del grid</li>
                            <li>‚Ä¢ <strong>Volumen:</strong> Valida zonas de acumulaci√≥n</li>
                          </ul>
                        </div>
                      </div>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="position-size">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Target className="h-4 w-4 text-primary" />
                        Tama√±o de Posici√≥n y Riesgo Diario
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> La cantidad de capital que el bot arriesga en cada operaci√≥n y el l√≠mite diario.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p><strong>C√°lculo autom√°tico por operaci√≥n:</strong></p>
                        <p className="text-muted-foreground mt-1">
                          El bot calcula el tama√±o bas√°ndose en:<br/>
                          ‚Ä¢ Tu saldo disponible<br/>
                          ‚Ä¢ El nivel de riesgo seleccionado (bajo/medio/alto)<br/>
                          ‚Ä¢ El Stop Loss configurado<br/>
                          ‚Ä¢ Los m√≠nimos de orden de Kraken
                        </p>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <div className="p-2 bg-green-500/10 rounded text-xs">
                          <p className="font-medium text-green-400">Riesgo Bajo</p>
                          <p className="text-muted-foreground">~1-2% por operaci√≥n</p>
                          <p className="text-muted-foreground">~5% m√°x. diario</p>
                        </div>
                        <div className="p-2 bg-yellow-500/10 rounded text-xs">
                          <p className="font-medium text-yellow-400">Riesgo Medio</p>
                          <p className="text-muted-foreground">~3-5% por operaci√≥n</p>
                          <p className="text-muted-foreground">~10% m√°x. diario</p>
                        </div>
                        <div className="p-2 bg-red-500/10 rounded text-xs">
                          <p className="font-medium text-red-400">Riesgo Alto</p>
                          <p className="text-muted-foreground">~5-10% por operaci√≥n</p>
                          <p className="text-muted-foreground">~20% m√°x. diario</p>
                        </div>
                      </div>
                      <div className="p-3 bg-yellow-500/10 rounded border border-yellow-500/30">
                        <p className="font-medium text-yellow-400">L√≠mite de p√©rdida diaria</p>
                        <p className="text-muted-foreground text-xs mt-1">
                          El bot controla las p√©rdidas acumuladas del d√≠a. Si alcanzas el l√≠mite diario, 
                          el bot pausa las operaciones hasta el d√≠a siguiente para proteger tu capital.
                          Monitorea tu historial de operaciones para verificar el rendimiento diario.
                        </p>
                      </div>
                      <p className="text-muted-foreground">
                        <strong>Ejemplo:</strong> Con $100 de saldo y riesgo medio, cada operaci√≥n usar√° ~$3-5 y el bot parar√° si pierdes m√°s de $10 en un d√≠a.
                      </p>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="position-tracking">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Database className="h-4 w-4 text-primary" />
                        Seguimiento de Posiciones
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> Cada posici√≥n abierta guarda informaci√≥n sobre c√≥mo fue creada.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p className="font-medium mb-2">Estrategia "Grandfather"</p>
                        <p className="text-muted-foreground">
                          Cuando el bot abre una posici√≥n, guarda:<br/>
                          ‚Ä¢ <strong>Estrategia usada:</strong> Momentum, Scalping, etc.<br/>
                          ‚Ä¢ <strong>Timeframe de se√±al:</strong> Ciclos, 5m, 15m, 1h<br/>
                          ‚Ä¢ <strong>Confianza de la se√±al:</strong> Porcentaje de certeza<br/>
                          ‚Ä¢ <strong>Raz√≥n:</strong> Indicadores que activaron la compra
                        </p>
                      </div>
                      <div className="p-3 bg-cyan-500/10 rounded border border-cyan-500/30">
                        <p className="font-medium text-cyan-400 mb-1">¬øPor qu√© es √∫til?</p>
                        <p className="text-muted-foreground text-xs">
                          ‚Ä¢ Puedes ver en la tabla de posiciones qu√© estrategia abri√≥ cada trade<br/>
                          ‚Ä¢ Al ampliar una posici√≥n existente, se mantiene la estrategia original<br/>
                          ‚Ä¢ Ayuda a analizar qu√© configuraci√≥n funciona mejor para ti
                        </p>
                      </div>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="telegram">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Bell className="h-4 w-4 text-primary" />
                        Notificaciones Telegram
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> El bot env√≠a alertas a Telegram cuando ocurren eventos importantes.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p className="font-medium mb-2">Informaci√≥n en cada notificaci√≥n</p>
                        <p className="text-muted-foreground">
                          ‚Ä¢ <strong>Tipo:</strong> COMPRA o VENTA<br/>
                          ‚Ä¢ <strong>Par y cantidad:</strong> Qu√© crypto y cu√°nto<br/>
                          ‚Ä¢ <strong>Precio:</strong> A qu√© precio se ejecut√≥<br/>
                          ‚Ä¢ <strong>Estrategia:</strong> Momentum (Velas 5m), etc.<br/>
                          ‚Ä¢ <strong>Confianza:</strong> Porcentaje de certeza de la se√±al<br/>
                          ‚Ä¢ <strong>Raz√≥n:</strong> Indicadores que activaron la operaci√≥n
                        </p>
                      </div>
                      <div className="p-3 bg-green-500/10 rounded border border-green-500/30">
                        <p className="font-medium text-green-400 mb-1">Tipos de alertas</p>
                        <p className="text-muted-foreground text-xs">
                          ‚Ä¢ üü¢ Compra ejecutada<br/>
                          ‚Ä¢ üî¥ Venta ejecutada<br/>
                          ‚Ä¢ üõë Stop-Loss activado<br/>
                          ‚Ä¢ üéØ Take-Profit alcanzado<br/>
                          ‚Ä¢ üìâ Trailing Stop activado<br/>
                          ‚Ä¢ ‚ö†Ô∏è Errores o l√≠mites alcanzados
                        </p>
                      </div>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="filters">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Activity className="h-4 w-4 text-primary" />
                        Filtros de Volatilidad y Volumen
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© son?</strong> Condiciones adicionales que deben cumplirse antes de abrir una operaci√≥n.</p>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p className="font-medium mb-2">Filtro de Volatilidad (ATR)</p>
                        <p className="text-muted-foreground">
                          El bot mide la volatilidad usando ATR (Average True Range). Si la volatilidad es muy baja, 
                          no opera porque los movimientos no cubrir√≠an las comisiones. Si es muy alta, reduce el tama√±o de posici√≥n.
                        </p>
                      </div>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p className="font-medium mb-2">Filtro de Volumen</p>
                        <p className="text-muted-foreground">
                          Compara el volumen actual con el promedio de las √∫ltimas 20 velas. Solo opera cuando el volumen 
                          es al menos 50% del promedio, evitando entrar en mercados "muertos" donde el precio puede manipularse f√°cilmente.
                        </p>
                      </div>
                      <p className="text-muted-foreground">
                        <strong>Beneficio:</strong> Estos filtros reducen operaciones en condiciones desfavorables, mejorando la tasa de acierto.
                      </p>
                    </AccordionContent>
                  </AccordionItem>

                  <AccordionItem value="mode">
                    <AccordionTrigger className="text-left">
                      <div className="flex items-center gap-2">
                        <Zap className="h-4 w-4 text-primary" />
                        Modo de Operaci√≥n
                      </div>
                    </AccordionTrigger>
                    <AccordionContent className="space-y-3 text-sm">
                      <p><strong>¬øQu√© es?</strong> El bot est√° configurado para operar exclusivamente en modo REAL.</p>
                      <div className="p-3 bg-yellow-500/10 rounded border border-yellow-500/30">
                        <p className="font-medium text-yellow-400">‚ö†Ô∏è Importante</p>
                        <p className="text-muted-foreground mt-1">
                          Este bot ejecuta operaciones reales con dinero real en Kraken. No incluye modo paper/demo.
                          Cada operaci√≥n afectar√° tu saldo real.
                        </p>
                      </div>
                      <div className="p-3 bg-card/50 rounded border border-border">
                        <p className="font-medium mb-2">Recomendaciones para empezar:</p>
                        <ul className="text-muted-foreground space-y-1">
                          <li>‚Ä¢ Empieza con el m√≠nimo capital posible ($10-50)</li>
                          <li>‚Ä¢ Usa nivel de riesgo BAJO al principio</li>
                          <li>‚Ä¢ Activa solo 1-2 pares para observar</li>
                          <li>‚Ä¢ Revisa el historial de operaciones diariamente</li>
                          <li>‚Ä¢ Aumenta capital solo cuando entiendas el comportamiento</li>
                        </ul>
                      </div>
                    </AccordionContent>
                  </AccordionItem>

                </Accordion>
              </CardContent>
            </Card>

            {/* Secci√≥n 4: Estados del bot y errores */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-orange-500/20 rounded-lg">
                    <AlertTriangle className="h-6 w-6 text-orange-400" />
                  </div>
                  <div>
                    <CardTitle className="text-lg md:text-xl">4. Estados del bot y errores t√≠picos</CardTitle>
                    <CardDescription>Significado de cada estado y c√≥mo solucionar problemas</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                
                <h4 className="font-semibold flex items-center gap-2">
                  <CheckCircle2 className="h-4 w-4 text-green-500" />
                  Estados normales
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="p-3 border border-green-500/30 rounded-lg bg-green-500/5">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="h-2 w-2 rounded-full bg-green-500"></span>
                      <span className="font-medium">Bot Activo</span>
                    </div>
                    <p className="text-xs text-muted-foreground">El bot est√° analizando el mercado y puede ejecutar operaciones.</p>
                  </div>
                  <div className="p-3 border border-yellow-500/30 rounded-lg bg-yellow-500/5">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="h-2 w-2 rounded-full bg-yellow-500"></span>
                      <span className="font-medium">Bot Pausado</span>
                    </div>
                    <p className="text-xs text-muted-foreground">El bot no est√° operando. Act√≠valo manualmente para que empiece.</p>
                  </div>
                  <div className="p-3 border border-green-500/30 rounded-lg bg-green-500/5">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="h-2 w-2 rounded-full bg-green-500"></span>
                      <span className="font-medium">Kraken Conectado</span>
                    </div>
                    <p className="text-xs text-muted-foreground">La API de Kraken est√° configurada correctamente y funcionando.</p>
                  </div>
                  <div className="p-3 border border-green-500/30 rounded-lg bg-green-500/5">
                    <div className="flex items-center gap-2 mb-1">
                      <span className="h-2 w-2 rounded-full bg-green-500"></span>
                      <span className="font-medium">Telegram Conectado</span>
                    </div>
                    <p className="text-xs text-muted-foreground">Las notificaciones de Telegram est√°n activas.</p>
                  </div>
                </div>

                <h4 className="font-semibold flex items-center gap-2 mt-6">
                  <XCircle className="h-4 w-4 text-red-500" />
                  Errores comunes y soluciones
                </h4>
                <div className="space-y-3">
                  <div className="p-4 border border-red-500/30 rounded-lg bg-red-500/5">
                    <div className="flex items-center gap-2 mb-2">
                      <AlertTriangle className="h-4 w-4 text-red-500" />
                      <span className="font-medium">Error de Nonce (Invalid nonce)</span>
                    </div>
                    <p className="text-sm text-muted-foreground mb-2">
                      Kraken rechaza la petici√≥n porque el identificador √∫nico de la llamada es inv√°lido.
                    </p>
                    <div className="text-xs p-2 bg-card/50 rounded">
                      <strong>Causas posibles:</strong><br/>
                      ‚Ä¢ Hay otra instancia del bot usando la misma API Key<br/>
                      ‚Ä¢ Reinicio muy r√°pido del bot<br/>
                      <strong>Soluci√≥n:</strong> Verifica que no tengas el bot corriendo en dos sitios (Replit + NAS). El bot reintenta autom√°ticamente 3 veces.
                    </div>
                  </div>
                  
                  <div className="p-4 border border-red-500/30 rounded-lg bg-red-500/5">
                    <div className="flex items-center gap-2 mb-2">
                      <WifiOff className="h-4 w-4 text-red-500" />
                      <span className="font-medium">Kraken Desconectado</span>
                    </div>
                    <p className="text-sm text-muted-foreground mb-2">
                      El bot no puede comunicarse con Kraken.
                    </p>
                    <div className="text-xs p-2 bg-card/50 rounded">
                      <strong>Causas posibles:</strong><br/>
                      ‚Ä¢ API Key o Secret incorrectos<br/>
                      ‚Ä¢ La API no tiene permisos de trading<br/>
                      ‚Ä¢ Kraken est√° en mantenimiento<br/>
                      <strong>Soluci√≥n:</strong> Ve a Integraciones y verifica tus credenciales. Regenera la API Key si es necesario.
                    </div>
                  </div>

                  <div className="p-4 border border-yellow-500/30 rounded-lg bg-yellow-500/5">
                    <div className="flex items-center gap-2 mb-2">
                      <DollarSign className="h-4 w-4 text-yellow-500" />
                      <span className="font-medium">Saldo insuficiente (Insufficient funds)</span>
                    </div>
                    <p className="text-sm text-muted-foreground mb-2">
                      No hay suficiente saldo para ejecutar la operaci√≥n.
                    </p>
                    <div className="text-xs p-2 bg-card/50 rounded">
                      <strong>Causas posibles:</strong><br/>
                      ‚Ä¢ El saldo disponible es menor que el m√≠nimo de orden de Kraken<br/>
                      ‚Ä¢ El saldo est√° bloqueado en √≥rdenes abiertas<br/>
                      ‚Ä¢ Se alcanz√≥ el l√≠mite de p√©rdida diaria<br/>
                      <strong>Soluci√≥n:</strong> Deposita m√°s fondos en Kraken, cancela √≥rdenes pendientes, o espera al d√≠a siguiente si alcanzaste el l√≠mite diario.
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Secci√≥n 5: Buenas pr√°cticas */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-primary/20 rounded-lg">
                    <Lightbulb className="h-6 w-6 text-primary" />
                  </div>
                  <div>
                    <CardTitle className="text-lg md:text-xl">5. Buenas pr√°cticas y consejos</CardTitle>
                    <CardDescription>Recomendaciones para operar de forma segura</CardDescription>
                  </div>
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                
                <div className="p-4 border border-primary/30 rounded-lg bg-primary/5">
                  <h4 className="font-semibold mb-3 flex items-center gap-2">
                    <CheckCircle2 className="h-4 w-4 text-primary" />
                    Checklist antes de activar el bot
                  </h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <label className="flex items-center gap-2 text-muted-foreground">
                      <input type="checkbox" className="rounded" disabled /> API de Kraken configurada y verificada
                    </label>
                    <label className="flex items-center gap-2 text-muted-foreground">
                      <input type="checkbox" className="rounded" disabled /> Telegram configurado (opcional)
                    </label>
                    <label className="flex items-center gap-2 text-muted-foreground">
                      <input type="checkbox" className="rounded" disabled /> Saldo suficiente en la cuenta
                    </label>
                    <label className="flex items-center gap-2 text-muted-foreground">
                      <input type="checkbox" className="rounded" disabled /> Estrategia y pares seleccionados
                    </label>
                    <label className="flex items-center gap-2 text-muted-foreground">
                      <input type="checkbox" className="rounded" disabled /> Stop Loss y Take Profit configurados
                    </label>
                    <label className="flex items-center gap-2 text-muted-foreground">
                      <input type="checkbox" className="rounded" disabled /> Nivel de riesgo adecuado a tu capital
                    </label>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 border border-green-500/30 rounded-lg bg-green-500/5">
                    <h4 className="font-semibold mb-2 text-green-400">‚úÖ Hacer</h4>
                    <ul className="text-sm text-muted-foreground space-y-1">
                      <li>‚Ä¢ Empezar con posiciones peque√±as</li>
                      <li>‚Ä¢ Revisar el dashboard y balance diariamente</li>
                      <li>‚Ä¢ Configurar alertas de Telegram</li>
                      <li>‚Ä¢ Usar Stop Loss siempre</li>
                      <li>‚Ä¢ Monitorear p√©rdidas/ganancias diarias en Historial</li>
                      <li>‚Ä¢ Verificar saldo antes de activar el bot</li>
                    </ul>
                  </div>
                  <div className="p-4 border border-red-500/30 rounded-lg bg-red-500/5">
                    <h4 className="font-semibold mb-2 text-red-400">‚ùå Evitar</h4>
                    <ul className="text-sm text-muted-foreground space-y-1">
                      <li>‚Ä¢ Invertir todo tu capital</li>
                      <li>‚Ä¢ Desactivar el Stop Loss</li>
                      <li>‚Ä¢ Usar riesgo alto sin experiencia</li>
                      <li>‚Ä¢ Ignorar las alertas del bot</li>
                      <li>‚Ä¢ Ejecutar m√∫ltiples instancias</li>
                      <li>‚Ä¢ Operar sin revisar el rendimiento semanal</li>
                    </ul>
                  </div>
                </div>

                <div className="p-4 border border-yellow-500/30 rounded-lg bg-yellow-500/5">
                  <h4 className="font-semibold mb-2 flex items-center gap-2">
                    <AlertTriangle className="h-4 w-4 text-yellow-500" />
                    Advertencia importante
                  </h4>
                  <p className="text-sm text-muted-foreground">
                    El trading de criptomonedas conlleva riesgos significativos. Nunca inviertas dinero que no puedas permitirte perder. 
                    Este bot es una herramienta automatizada, pero no garantiza beneficios. Supervisa regularmente su funcionamiento 
                    y ajusta la configuraci√≥n seg√∫n las condiciones del mercado.
                  </p>
                </div>

                <div className="p-4 border border-border rounded-lg bg-card/30">
                  <h4 className="font-semibold mb-2 flex items-center gap-2">
                    <HelpCircle className="h-4 w-4 text-primary" />
                    ¬øQu√© revisar en el Dashboard?
                  </h4>
                  <ul className="text-sm text-muted-foreground space-y-1">
                    <li>‚Ä¢ <strong>Balances:</strong> Verifica que tu saldo es correcto</li>
                    <li>‚Ä¢ <strong>Estado del bot:</strong> Confirma que est√° activo y conectado</li>
                    <li>‚Ä¢ <strong>√öltimas operaciones:</strong> Revisa que las operaciones se ejecutan correctamente</li>
                    <li>‚Ä¢ <strong>Precios:</strong> Comprueba que los precios se actualizan en tiempo real</li>
                  </ul>
                </div>

              </CardContent>
            </Card>

          </div>
        </main>
      </div>
    </div>
  );
}


===== FILE: ./client/src/pages/Wallet.tsx =====
import { useQuery } from "@tanstack/react-query";
import { Nav } from "@/components/dashboard/Nav";
import { Ticker } from "@/components/dashboard/Ticker";
import generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Wallet as WalletIcon, TrendingUp, TrendingDown, PieChart, RefreshCw } from "lucide-react";
import { Button } from "@/components/ui/button";

interface DashboardData {
  krakenConnected: boolean;
  balances: Record<string, string>;
  prices: Record<string, { price: string; change: string }>;
}

const ASSET_INFO: Record<string, { name: string; color: string }> = {
  "XXBT": { name: "Bitcoin", color: "bg-orange-500" },
  "XETH": { name: "Ethereum", color: "bg-blue-500" },
  "SOL": { name: "Solana", color: "bg-purple-500" },
  "ZUSD": { name: "USD", color: "bg-green-500" },
  "XXRP": { name: "XRP", color: "bg-gray-500" },
  "TON": { name: "Toncoin", color: "bg-cyan-500" },
  "USDC": { name: "USD Coin", color: "bg-blue-400" },
};

const PRICE_PAIRS: Record<string, string> = {
  "XXBT": "XXBTZUSD",
  "XETH": "XETHZUSD",
  "SOL": "SOLUSD",
  "XXRP": "XXRPZUSD",
  "TON": "TONUSD",
};

export default function Wallet() {
  const { data, isLoading, refetch, isFetching } = useQuery<DashboardData>({
    queryKey: ["dashboard"],
    queryFn: async () => {
      const res = await fetch("/api/dashboard");
      if (!res.ok) throw new Error("Failed to fetch dashboard");
      return res.json();
    },
    refetchInterval: 30000,
  });

  const calculatePortfolio = () => {
    if (!data?.balances || !data?.prices) return { assets: [], total: 0 };

    const assets: { symbol: string; name: string; balance: number; value: number; color: string; change: number }[] = [];
    let total = 0;

    for (const [symbol, balanceStr] of Object.entries(data.balances)) {
      const balance = parseFloat(balanceStr);
      if (balance <= 0) continue;

      let value = balance;
      let change = 0;

      if (symbol === "ZUSD" || symbol === "USDC") {
        value = balance;
      } else {
        const pricePair = PRICE_PAIRS[symbol];
        if (pricePair && data.prices[pricePair]) {
          const price = parseFloat(data.prices[pricePair].price);
          value = balance * price;
          change = parseFloat(data.prices[pricePair].change);
        }
      }

      if (value > 0.001) {
        assets.push({
          symbol,
          name: ASSET_INFO[symbol]?.name || symbol,
          balance,
          value,
          color: ASSET_INFO[symbol]?.color || "bg-gray-500",
          change,
        });
        total += value;
      }
    }

    return { assets: assets.sort((a, b) => b.value - a.value), total };
  };

  const { assets, total } = calculatePortfolio();

  return (
    <div className="min-h-screen bg-background flex flex-col relative overflow-hidden">
      <div 
        className="fixed inset-0 z-0 opacity-20 pointer-events-none" 
        style={{ 
          backgroundImage: `url(${generatedImage})`, 
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          mixBlendMode: 'overlay'
        }} 
      />
      
      <div className="relative z-10 flex flex-col min-h-screen">
        <Nav />
        <Ticker />
        
        <main className="flex-1 p-6 max-w-6xl mx-auto w-full space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold font-sans tracking-tight">Mi Cartera</h1>
              <p className="text-muted-foreground mt-1">Desglose completo de tus activos en Kraken.</p>
            </div>
            <Button 
              variant="outline" 
              onClick={() => refetch()}
              disabled={isFetching}
              data-testid="button-refresh-wallet"
            >
              <RefreshCw className={`h-4 w-4 mr-2 ${isFetching ? 'animate-spin' : ''}`} />
              Actualizar
            </Button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card className="glass-panel border-border/50 md:col-span-2">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <WalletIcon className="h-5 w-5 text-primary" />
                  Balance Total
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-4xl font-bold font-mono tracking-tight text-primary">
                  ${total.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </div>
                <p className="text-sm text-muted-foreground mt-2">
                  {assets.length} activos en tu cartera
                </p>
              </CardContent>
            </Card>

            <Card className="glass-panel border-border/50">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <PieChart className="h-5 w-5 text-primary" />
                  Distribuci√≥n
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {assets.slice(0, 4).map((asset) => {
                    const percentage = total > 0 ? (asset.value / total) * 100 : 0;
                    return (
                      <div key={asset.symbol} className="space-y-1">
                        <div className="flex justify-between text-sm">
                          <span className="font-mono">{asset.name}</span>
                          <span className="text-muted-foreground">{percentage.toFixed(1)}%</span>
                        </div>
                        <Progress value={percentage} className="h-2" />
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          </div>

          <Card className="glass-panel border-border/50">
            <CardHeader>
              <CardTitle>Detalle de Activos</CardTitle>
            </CardHeader>
            <CardContent>
              {isLoading ? (
                <div className="flex items-center justify-center py-12">
                  <RefreshCw className="h-8 w-8 animate-spin text-primary" />
                </div>
              ) : !data?.krakenConnected ? (
                <div className="text-center py-12 text-muted-foreground">
                  <WalletIcon className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p>Conecta Kraken en Ajustes para ver tu cartera.</p>
                </div>
              ) : assets.length === 0 ? (
                <div className="text-center py-12 text-muted-foreground">
                  <WalletIcon className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p>No tienes activos en tu cuenta de Kraken.</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {assets.map((asset) => {
                    const percentage = total > 0 ? (asset.value / total) * 100 : 0;
                    return (
                      <div
                        key={asset.symbol}
                        className="flex items-center justify-between p-4 bg-card/50 rounded-lg border border-border/30 hover:border-border/50 transition-colors"
                        data-testid={`asset-row-${asset.symbol}`}
                      >
                        <div className="flex items-center gap-4">
                          <div className={`w-10 h-10 rounded-full ${asset.color} flex items-center justify-center text-white font-bold text-sm`}>
                            {asset.symbol.substring(0, 2)}
                          </div>
                          <div>
                            <div className="font-medium">{asset.name}</div>
                            <div className="text-sm text-muted-foreground font-mono">
                              {asset.balance.toFixed(8)} {asset.symbol}
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex items-center gap-6">
                          <div className="text-right">
                            <div className="font-mono font-medium">
                              ${asset.value.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </div>
                            <div className="text-sm text-muted-foreground">
                              {percentage.toFixed(1)}% del total
                            </div>
                          </div>
                          {asset.change !== 0 && (
                            <div className={`flex items-center gap-1 ${asset.change >= 0 ? "text-green-500" : "text-red-500"}`}>
                              {asset.change >= 0 ? (
                                <TrendingUp className="h-4 w-4" />
                              ) : (
                                <TrendingDown className="h-4 w-4" />
                              )}
                              <span className="font-mono text-sm">
                                {asset.change >= 0 ? "+" : ""}{asset.change.toFixed(2)}%
                              </span>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </CardContent>
          </Card>
        </main>
      </div>
    </div>
  );
}


===== FILE: ./client/src/pages/Integrations.tsx =====
import { useState, useEffect } from "react";
import { Nav } from "@/components/dashboard/Nav";
import generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Textarea } from "@/components/ui/textarea";
import { MessageSquare, Server, Check, Send, Plus, Trash2, Users, Plug, Eye, EyeOff } from "lucide-react";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { toast } from "sonner";

interface TelegramChat {
  id: number;
  name: string;
  chatId: string;
  alertTrades: boolean;
  alertErrors: boolean;
  alertSystem: boolean;
  alertBalance: boolean;
  isActive: boolean;
}

export default function Integrations() {
  const queryClient = useQueryClient();
  const [krakenApiKey, setKrakenApiKey] = useState("");
  const [krakenSecret, setKrakenSecret] = useState("");
  const [krakenConnected, setKrakenConnected] = useState(false);
  const [showKrakenKey, setShowKrakenKey] = useState(false);
  const [showKrakenSecret, setShowKrakenSecret] = useState(false);
  
  const [telegramToken, setTelegramToken] = useState("");
  const [telegramChatId, setTelegramChatId] = useState("");
  const [telegramConnected, setTelegramConnected] = useState(false);
  const [showTelegramToken, setShowTelegramToken] = useState(false);
  const [customMessage, setCustomMessage] = useState("");

  const [newChatName, setNewChatName] = useState("");
  const [newChatId, setNewChatId] = useState("");
  const [newAlertTrades, setNewAlertTrades] = useState(true);
  const [newAlertErrors, setNewAlertErrors] = useState(true);
  const [newAlertSystem, setNewAlertSystem] = useState(true);
  const [newAlertBalance, setNewAlertBalance] = useState(false);

  const { data: apiConfig } = useQuery({
    queryKey: ["apiConfig"],
    queryFn: async () => {
      const res = await fetch("/api/config/api");
      if (!res.ok) throw new Error("Failed to fetch config");
      return res.json();
    },
  });

  const { data: telegramChats = [] } = useQuery<TelegramChat[]>({
    queryKey: ["telegramChats"],
    queryFn: async () => {
      const res = await fetch("/api/telegram/chats");
      if (!res.ok) throw new Error("Failed to fetch chats");
      return res.json();
    },
  });

  useEffect(() => {
    if (apiConfig) {
      setKrakenConnected(apiConfig.krakenConnected);
      setTelegramConnected(apiConfig.telegramConnected);
    }
  }, [apiConfig]);

  const krakenMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/config/kraken", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ apiKey: krakenApiKey, apiSecret: krakenSecret }),
      });
      if (!res.ok) throw new Error("Failed to connect");
      return res.json();
    },
    onSuccess: () => {
      setKrakenConnected(true);
      toast.success("Kraken conectado correctamente");
    },
    onError: () => {
      toast.error("Error al conectar con Kraken");
    },
  });

  const telegramMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/config/telegram", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: telegramToken, chatId: telegramChatId }),
      });
      if (!res.ok) throw new Error("Failed to connect");
      return res.json();
    },
    onSuccess: () => {
      setTelegramConnected(true);
      toast.success("Telegram conectado correctamente");
    },
    onError: () => {
      toast.error("Error al conectar con Telegram");
    },
  });

  const sendMessageMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/telegram/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: customMessage }),
      });
      if (!res.ok) throw new Error("Failed to send");
      return res.json();
    },
    onSuccess: () => {
      toast.success("Mensaje enviado a Telegram");
      setCustomMessage("");
    },
    onError: () => {
      toast.error("Error al enviar mensaje");
    },
  });

  const createChatMutation = useMutation({
    mutationFn: async () => {
      const res = await fetch("/api/telegram/chats", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: newChatName,
          chatId: newChatId,
          alertTrades: newAlertTrades,
          alertErrors: newAlertErrors,
          alertSystem: newAlertSystem,
          alertBalance: newAlertBalance,
        }),
      });
      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || "Failed to create chat");
      }
      return res.json();
    },
    onSuccess: () => {
      toast.success("Chat a√±adido correctamente");
      setNewChatName("");
      setNewChatId("");
      setNewAlertTrades(true);
      setNewAlertErrors(true);
      setNewAlertSystem(true);
      setNewAlertBalance(false);
      queryClient.invalidateQueries({ queryKey: ["telegramChats"] });
    },
    onError: (error: Error) => {
      toast.error(error.message);
    },
  });

  const deleteChatMutation = useMutation({
    mutationFn: async (id: number) => {
      const res = await fetch(`/api/telegram/chats/${id}`, {
        method: "DELETE",
      });
      if (!res.ok) throw new Error("Failed to delete");
      return res.json();
    },
    onSuccess: () => {
      toast.success("Chat eliminado");
      queryClient.invalidateQueries({ queryKey: ["telegramChats"] });
    },
    onError: () => {
      toast.error("Error al eliminar chat");
    },
  });

  const updateChatMutation = useMutation({
    mutationFn: async ({ id, ...data }: { id: number } & Partial<TelegramChat>) => {
      const res = await fetch(`/api/telegram/chats/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error("Failed to update");
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ["telegramChats"] });
    },
    onError: () => {
      toast.error("Error al actualizar chat");
    },
  });

  return (
    <div className="min-h-screen bg-background flex flex-col relative overflow-hidden">
      <div 
        className="fixed inset-0 z-0 opacity-20 pointer-events-none" 
        style={{ 
          backgroundImage: `url(${generatedImage})`, 
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          mixBlendMode: 'overlay'
        }} 
      />
      
      <div className="relative z-10 flex flex-col min-h-screen">
        <Nav />
        
        <main className="flex-1 p-6 max-w-4xl mx-auto w-full space-y-8">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold font-sans tracking-tight flex items-center gap-3">
                <Plug className="h-8 w-8 text-primary" />
                Integraciones
              </h1>
              <p className="text-muted-foreground mt-1">Gestiona todas las conexiones y credenciales de APIs.</p>
            </div>
          </div>

          <div className="grid gap-6">
            {/* Kraken API */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-orange-500/20 rounded-lg">
                    <Server className="h-6 w-6 text-orange-400" />
                  </div>
                  <div className="flex-1">
                    <CardTitle>Kraken Exchange</CardTitle>
                    <CardDescription>Conecta tu cuenta de Kraken para trading real.</CardDescription>
                  </div>
                  {krakenConnected ? (
                    <div className="flex items-center gap-2 text-green-500">
                      <Check className="h-5 w-5" />
                      <span className="text-sm font-mono">CONECTADO</span>
                    </div>
                  ) : (
                    <span className="text-sm font-mono text-yellow-500">DESCONECTADO</span>
                  )}
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid gap-2">
                  <Label>API Key</Label>
                  <div className="relative">
                    <Input 
                      type={showKrakenKey ? "text" : "password"}
                      placeholder="Tu Kraken API Key" 
                      className="font-mono bg-background/50 pr-10"
                      value={krakenApiKey}
                      onChange={(e) => setKrakenApiKey(e.target.value)}
                      data-testid="input-kraken-api-key"
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      className="absolute right-0 top-0 h-full"
                      onClick={() => setShowKrakenKey(!showKrakenKey)}
                    >
                      {showKrakenKey ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                  </div>
                </div>
                <div className="grid gap-2">
                  <Label>API Secret</Label>
                  <div className="relative">
                    <Input 
                      type={showKrakenSecret ? "text" : "password"}
                      placeholder="Tu Kraken API Secret" 
                      className="font-mono bg-background/50 pr-10"
                      value={krakenSecret}
                      onChange={(e) => setKrakenSecret(e.target.value)}
                      data-testid="input-kraken-secret"
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      className="absolute right-0 top-0 h-full"
                      onClick={() => setShowKrakenSecret(!showKrakenSecret)}
                    >
                      {showKrakenSecret ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                  </div>
                </div>
                <Button 
                  className="w-full bg-orange-600 hover:bg-orange-700" 
                  onClick={() => krakenMutation.mutate()}
                  disabled={!krakenApiKey || !krakenSecret || krakenMutation.isPending}
                  data-testid="button-connect-kraken"
                >
                  {krakenMutation.isPending ? "Conectando..." : krakenConnected ? "Reconectar" : "Conectar a Kraken"}
                </Button>
                <p className="text-xs text-muted-foreground">
                  Obt√©n tus credenciales en <a href="https://www.kraken.com/u/security/api" target="_blank" rel="noopener" className="text-primary hover:underline">kraken.com/u/security/api</a>
                </p>
              </CardContent>
            </Card>

            {/* Telegram Bot */}
            <Card className="glass-panel border-border/50">
              <CardHeader>
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-blue-500/20 rounded-lg">
                    <MessageSquare className="h-6 w-6 text-blue-400" />
                  </div>
                  <div className="flex-1">
                    <CardTitle>Telegram Bot</CardTitle>
                    <CardDescription>Recibe alertas y controla el bot desde Telegram.</CardDescription>
                  </div>
                  {telegramConnected ? (
                    <div className="flex items-center gap-2 text-green-500">
                      <Check className="h-5 w-5" />
                      <span className="text-sm font-mono">CONECTADO</span>
                    </div>
                  ) : (
                    <span className="text-sm font-mono text-yellow-500">DESCONECTADO</span>
                  )}
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid gap-2">
                  <Label>Bot Token (de @BotFather)</Label>
                  <div className="relative">
                    <Input 
                      type={showTelegramToken ? "text" : "password"}
                      placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" 
                      className="font-mono bg-background/50 pr-10"
                      value={telegramToken}
                      onChange={(e) => setTelegramToken(e.target.value)}
                      data-testid="input-telegram-token"
                    />
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      className="absolute right-0 top-0 h-full"
                      onClick={() => setShowTelegramToken(!showTelegramToken)}
                    >
                      {showTelegramToken ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                    </Button>
                  </div>
                </div>
                <div className="grid gap-2">
                  <Label>Chat ID principal</Label>
                  <Input 
                    placeholder="-1001234567890" 
                    className="font-mono bg-background/50"
                    value={telegramChatId}
                    onChange={(e) => setTelegramChatId(e.target.value)}
                    data-testid="input-telegram-chatid"
                  />
                </div>
                <Button 
                  className="w-full"
                  onClick={() => telegramMutation.mutate()}
                  disabled={!telegramToken || !telegramChatId || telegramMutation.isPending}
                  data-testid="button-connect-telegram"
                >
                  {telegramMutation.isPending ? "Probando..." : telegramConnected ? "Reconectar" : "Conectar Telegram"}
                </Button>
                
                {telegramConnected && (
                  <div className="pt-4 border-t border-border/50 space-y-3">
                    <Label>Enviar mensaje de prueba</Label>
                    <Textarea
                      placeholder="Escribe un mensaje para enviar a Telegram..."
                      className="bg-background/50 min-h-[80px]"
                      value={customMessage}
                      onChange={(e) => setCustomMessage(e.target.value)}
                      data-testid="input-custom-message"
                    />
                    <Button 
                      variant="outline"
                      className="w-full"
                      onClick={() => sendMessageMutation.mutate()}
                      disabled={!customMessage.trim() || sendMessageMutation.isPending}
                      data-testid="button-send-message"
                    >
                      <Send className="mr-2 h-4 w-4" />
                      {sendMessageMutation.isPending ? "Enviando..." : "Enviar Mensaje"}
                    </Button>
                    <p className="text-xs text-muted-foreground">
                      Comandos: /estado, /pausar, /reanudar, /ultimas, /ayuda
                    </p>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Multi-Chat Telegram */}
            {telegramConnected && (
              <Card className="glass-panel border-border/50">
                <CardHeader>
                  <div className="flex items-center gap-3">
                    <div className="p-2 bg-purple-500/20 rounded-lg">
                      <Users className="h-6 w-6 text-purple-400" />
                    </div>
                    <div className="flex-1">
                      <CardTitle>Multi-Chat Telegram</CardTitle>
                      <CardDescription>Env√≠a alertas a m√∫ltiples chats con configuraci√≥n individual.</CardDescription>
                    </div>
                    <span className="text-sm text-muted-foreground">{telegramChats.length} chat(s)</span>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  {telegramChats.length > 0 && (
                    <div className="space-y-3">
                      {telegramChats.map((chat) => (
                        <div key={chat.id} className="p-4 border border-border rounded-lg bg-card/30 space-y-3">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                              <span className={`h-2 w-2 rounded-full ${chat.isActive ? 'bg-green-500' : 'bg-gray-500'}`}></span>
                              <span className="font-medium">{chat.name}</span>
                              <span className="text-xs text-muted-foreground font-mono">({chat.chatId})</span>
                            </div>
                            <div className="flex items-center gap-2">
                              <Switch 
                                checked={chat.isActive}
                                onCheckedChange={(checked) => updateChatMutation.mutate({ id: chat.id, isActive: checked })}
                              />
                              <Button 
                                variant="ghost" 
                                size="icon"
                                onClick={() => deleteChatMutation.mutate(chat.id)}
                                data-testid={`button-delete-chat-${chat.id}`}
                              >
                                <Trash2 className="h-4 w-4 text-red-500" />
                              </Button>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <Button 
                              variant={chat.alertTrades ? "default" : "outline"} 
                              size="sm"
                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertTrades: !chat.alertTrades })}
                            >
                              Trades
                            </Button>
                            <Button 
                              variant={chat.alertErrors ? "default" : "outline"} 
                              size="sm"
                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertErrors: !chat.alertErrors })}
                            >
                              Errores
                            </Button>
                            <Button 
                              variant={chat.alertSystem ? "default" : "outline"} 
                              size="sm"
                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertSystem: !chat.alertSystem })}
                            >
                              Sistema
                            </Button>
                            <Button 
                              variant={chat.alertBalance ? "default" : "outline"} 
                              size="sm"
                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertBalance: !chat.alertBalance })}
                            >
                              Balance
                            </Button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  <div className="pt-4 border-t border-border/50 space-y-3">
                    <Label className="flex items-center gap-2">
                      <Plus className="h-4 w-4" /> A√±adir nuevo chat
                    </Label>
                    <div className="grid grid-cols-2 gap-3">
                      <div className="grid gap-2">
                        <Label className="text-xs">Nombre</Label>
                        <Input 
                          placeholder="Mi grupo" 
                          className="bg-background/50"
                          value={newChatName}
                          onChange={(e) => setNewChatName(e.target.value)}
                          data-testid="input-new-chat-name"
                        />
                      </div>
                      <div className="grid gap-2">
                        <Label className="text-xs">Chat ID</Label>
                        <Input 
                          placeholder="-1001234567890" 
                          className="font-mono bg-background/50"
                          value={newChatId}
                          onChange={(e) => setNewChatId(e.target.value)}
                          data-testid="input-new-chat-id"
                        />
                      </div>
                    </div>
                    <div className="flex flex-wrap gap-4">
                      <div className="flex items-center gap-2">
                        <Switch checked={newAlertTrades} onCheckedChange={setNewAlertTrades} />
                        <Label className="text-sm">Trades</Label>
                      </div>
                      <div className="flex items-center gap-2">
                        <Switch checked={newAlertErrors} onCheckedChange={setNewAlertErrors} />
                        <Label className="text-sm">Errores</Label>
                      </div>
                      <div className="flex items-center gap-2">
                        <Switch checked={newAlertSystem} onCheckedChange={setNewAlertSystem} />
                        <Label className="text-sm">Sistema</Label>
                      </div>
                      <div className="flex items-center gap-2">
                        <Switch checked={newAlertBalance} onCheckedChange={setNewAlertBalance} />
                        <Label className="text-sm">Balance</Label>
                      </div>
                    </div>
                    <Button 
                      className="w-full"
                      onClick={() => createChatMutation.mutate()}
                      disabled={!newChatName.trim() || !newChatId.trim() || createChatMutation.isPending}
                      data-testid="button-add-chat"
                    >
                      <Plus className="mr-2 h-4 w-4" />
                      {createChatMutation.isPending ? "A√±adiendo..." : "A√±adir Chat"}
                    </Button>
                  </div>
                </CardContent>
              </Card>
            )}

          </div>
        </main>
      </div>
    </div>
  );
}


===== FILE: ./client/src/pages/not-found.tsx =====
import { Card, CardContent } from "@/components/ui/card";
import { AlertCircle } from "lucide-react";

export default function NotFound() {
  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-gray-50">
      <Card className="w-full max-w-md mx-4">
        <CardContent className="pt-6">
          <div className="flex mb-4 gap-2">
            <AlertCircle className="h-8 w-8 text-red-500" />
            <h1 className="text-2xl font-bold text-gray-900">404 Page Not Found</h1>
          </div>

          <p className="mt-4 text-sm text-gray-600">
            Did you forget to add the page to the router?
          </p>
        </CardContent>
      </Card>
    </div>
  );
}


===== FILE: ./client/src/lib/utils.ts =====
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}


===== FILE: ./client/src/lib/queryClient.ts =====
import { QueryClient, QueryFunction } from "@tanstack/react-query";

async function throwIfResNotOk(res: Response) {
  if (!res.ok) {
    const text = (await res.text()) || res.statusText;
    throw new Error(`${res.status}: ${text}`);
  }
}

export async function apiRequest(
  method: string,
  url: string,
  data?: unknown | undefined,
): Promise<Response> {
  const res = await fetch(url, {
    method,
    headers: data ? { "Content-Type": "application/json" } : {},
    body: data ? JSON.stringify(data) : undefined,
    credentials: "include",
  });

  await throwIfResNotOk(res);
  return res;
}

type UnauthorizedBehavior = "returnNull" | "throw";
export const getQueryFn: <T>(options: {
  on401: UnauthorizedBehavior;
}) => QueryFunction<T> =
  ({ on401: unauthorizedBehavior }) =>
  async ({ queryKey }) => {
    const res = await fetch(queryKey.join("/") as string, {
      credentials: "include",
    });

    if (unauthorizedBehavior === "returnNull" && res.status === 401) {
      return null;
    }

    await throwIfResNotOk(res);
    return await res.json();
  };

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      queryFn: getQueryFn({ on401: "throw" }),
      refetchInterval: false,
      refetchOnWindowFocus: false,
      staleTime: Infinity,
      retry: false,
    },
    mutations: {
      retry: false,
    },
  },
});


===== FILE: ./client/src/components/dashboard/EnvironmentBadge.tsx =====
import { useQuery } from "@tanstack/react-query";
import { Badge } from "@/components/ui/badge";
import { Server, TestTube, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";

interface EnvironmentData {
  env: "REPLIT/DEV" | "NAS/PROD";
  instanceId: string;
  isReplit: boolean;
  isNAS: boolean;
  dryRun: boolean;
  gitCommit?: string;
}

export function EnvironmentBadge({ compact = false }: { compact?: boolean }) {
  const { data, isLoading } = useQuery<EnvironmentData>({
    queryKey: ["environment"],
    queryFn: async () => {
      const res = await fetch("/api/environment");
      if (!res.ok) throw new Error("Failed to fetch environment");
      return res.json();
    },
    staleTime: 60000,
  });

  if (isLoading || !data) return null;

  const isProduction = data.env === "NAS/PROD";
  const showDryRunWarning = data.dryRun;

  if (compact) {
    return (
      <div className="flex items-center gap-2" data-testid="environment-badge-compact">
        <Badge 
          variant="outline"
          className={cn(
            "font-mono text-xs",
            isProduction 
              ? "bg-green-500/10 text-green-500 border-green-500/30" 
              : "bg-yellow-500/10 text-yellow-500 border-yellow-500/30"
          )}
        >
          {isProduction ? <Server className="w-3 h-3 mr-1" /> : <TestTube className="w-3 h-3 mr-1" />}
          {data.env}
        </Badge>
        {showDryRunWarning && (
          <Badge 
            variant="outline"
            className="font-mono text-xs bg-orange-500/10 text-orange-500 border-orange-500/30"
          >
            <AlertTriangle className="w-3 h-3 mr-1" />
            DRY_RUN
          </Badge>
        )}
      </div>
    );
  }

  return (
    <div 
      className={cn(
        "p-3 rounded-lg border flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4",
        isProduction 
          ? "bg-green-500/5 border-green-500/20" 
          : "bg-yellow-500/5 border-yellow-500/20"
      )}
      data-testid="environment-badge"
    >
      <div className="flex items-center gap-2">
        {isProduction ? (
          <Server className={cn("w-5 h-5", isProduction ? "text-green-500" : "text-yellow-500")} />
        ) : (
          <TestTube className="w-5 h-5 text-yellow-500" />
        )}
        <div>
          <div className="flex items-center gap-2">
            <span className={cn(
              "font-mono font-bold text-sm",
              isProduction ? "text-green-500" : "text-yellow-500"
            )}>
              {data.env}
            </span>
            {showDryRunWarning && (
              <Badge 
                variant="outline"
                className="font-mono text-xs bg-orange-500/10 text-orange-500 border-orange-500/30"
              >
                DRY_RUN
              </Badge>
            )}
          </div>
          <p className="text-xs text-muted-foreground font-mono">
            ID: {data.instanceId} {data.gitCommit && <span className="opacity-60">¬∑ v{data.gitCommit}</span>}
          </p>
        </div>
      </div>
      
      {data.isReplit && (
        <p className="text-xs text-muted-foreground">
          Entorno de desarrollo - No se env√≠an √≥rdenes reales
        </p>
      )}
    </div>
  );
}


===== FILE: ./client/src/components/dashboard/EventsPanel.tsx =====
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { ScrollArea } from "@/components/ui/scroll-area";
import { 
  AlertTriangle, 
  XCircle, 
  Info,
  Wifi,
  WifiOff,
  RefreshCw,
  Trash2
} from "lucide-react";
import { useEventsFeed } from "@/context/EventsWebSocketContext";
import { BotEvent } from "@/hooks/useEventsWebSocket";
import { cn } from "@/lib/utils";

export function EventsPanel() {
  const { events: allEvents, status, clearEvents, connect, isConnected } = useEventsFeed();
  const events = allEvents.slice(0, 50);

  const getLevelIcon = (level: string) => {
    switch (level) {
      case "ERROR":
        return <XCircle className="h-4 w-4 text-red-500" />;
      case "WARN":
        return <AlertTriangle className="h-4 w-4 text-yellow-500" />;
      default:
        return <Info className="h-4 w-4 text-cyan-500" />;
    }
  };

  const getLevelBadge = (level: string) => {
    switch (level) {
      case "ERROR":
        return <Badge variant="destructive" className="text-xs">ERROR</Badge>;
      case "WARN":
        return <Badge className="bg-yellow-500/20 text-yellow-400 border-yellow-500/30 text-xs">WARN</Badge>;
      default:
        return <Badge className="bg-cyan-500/20 text-cyan-400 border-cyan-500/30 text-xs">INFO</Badge>;
    }
  };

  const getTypeBadge = (type: string) => {
    const typeColors: Record<string, string> = {
      TRADE_EXECUTED: "bg-green-500/20 text-green-400 border-green-500/30",
      TRADE_BLOCKED: "bg-orange-500/20 text-orange-400 border-orange-500/30",
      TRADE_FAILED: "bg-red-500/20 text-red-400 border-red-500/30",
      TRADE_SKIPPED: "bg-gray-500/20 text-gray-400 border-gray-500/30",
      DAILY_LIMIT_HIT: "bg-red-500/20 text-red-400 border-red-500/30",
      BOT_STARTED: "bg-green-500/20 text-green-400 border-green-500/30",
      BOT_STOPPED: "bg-gray-500/20 text-gray-400 border-gray-500/30",
      KRAKEN_ERROR: "bg-red-500/20 text-red-400 border-red-500/30",
      SIGNAL_GENERATED: "bg-blue-500/20 text-blue-400 border-blue-500/30",
      STOP_LOSS_HIT: "bg-red-500/20 text-red-400 border-red-500/30",
      TAKE_PROFIT_HIT: "bg-green-500/20 text-green-400 border-green-500/30",
      ENGINE_TICK: "bg-purple-500/20 text-purple-400 border-purple-500/30",
      MARKET_SCAN_SUMMARY: "bg-indigo-500/20 text-indigo-400 border-indigo-500/30",
    };
    
    const colorClass = typeColors[type] || "bg-primary/20 text-primary border-primary/30";
    return <Badge className={`${colorClass} text-xs`}>{type.replace(/_/g, " ")}</Badge>;
  };

  const formatTime = (timestamp: string) => {
    const date = new Date(timestamp);
    return date.toLocaleTimeString("es-ES", { 
      hour: "2-digit", 
      minute: "2-digit",
      second: "2-digit"
    });
  };

  const formatDate = (timestamp: string) => {
    const date = new Date(timestamp);
    return date.toLocaleDateString("es-ES", { 
      day: "2-digit",
      month: "2-digit"
    });
  };

  return (
    <Card className="h-full" data-testid="events-panel">
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-lg flex items-center gap-2">
            Eventos del Bot
            <Badge 
              variant="outline" 
              className={cn(
                "gap-1 text-xs",
                isConnected ? "border-green-500 text-green-400" : 
                status === "reconnecting" ? "border-yellow-500 text-yellow-400" :
                "border-red-500 text-red-400"
              )}
              data-testid="events-ws-status"
            >
              {isConnected ? <Wifi className="h-3 w-3" /> : 
               status === "reconnecting" ? <RefreshCw className="h-3 w-3 animate-spin" /> :
               <WifiOff className="h-3 w-3" />}
              {isConnected ? "Live" : status === "reconnecting" ? "..." : "Off"}
            </Badge>
          </CardTitle>
          <div className="flex items-center gap-1">
            <Button
              variant="ghost"
              size="icon"
              className="h-7 w-7"
              onClick={clearEvents}
              title="Limpiar eventos"
              data-testid="button-clear-events"
            >
              <Trash2 className="h-4 w-4" />
            </Button>
            {!isConnected && (
              <Button
                variant="ghost"
                size="icon"
                className="h-7 w-7"
                onClick={connect}
                title="Reconectar"
                data-testid="button-reconnect-events"
              >
                <RefreshCw className="h-4 w-4" />
              </Button>
            )}
          </div>
        </div>
      </CardHeader>
      <CardContent className="pt-0">
        <ScrollArea className="h-[300px]">
          <div className="space-y-2">
            {events.length === 0 ? (
              <div className="text-center text-muted-foreground py-8 text-sm">
                {isConnected ? "Esperando eventos..." : "Conectando..."}
              </div>
            ) : (
              events.slice(0, 20).map((event, idx) => (
                <div
                  key={event.id || `${event.timestamp}-${idx}`}
                  className="flex items-start gap-2 p-2 rounded-lg bg-muted/30 hover:bg-muted/50 transition-colors"
                  data-testid={`event-item-${event.id || idx}`}
                >
                  {getLevelIcon(event.level)}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 flex-wrap">
                      {getTypeBadge(event.type)}
                      {event.meta?.pair && (
                        <Badge variant="outline" className="text-xs">
                          {event.meta.pair}
                        </Badge>
                      )}
                      <span className="text-xs text-muted-foreground ml-auto whitespace-nowrap">
                        {formatDate(event.timestamp)} {formatTime(event.timestamp)}
                      </span>
                    </div>
                    <p className="text-sm text-foreground/80 mt-1 line-clamp-2">
                      {event.message}
                    </p>
                  </div>
                </div>
              ))
            )}
          </div>
        </ScrollArea>
      </CardContent>
    </Card>
  );
}


===== FILE: ./client/src/components/dashboard/Nav.tsx =====
import { useState } from "react";
import { Link, useLocation } from "wouter";
import { cn } from "@/lib/utils";
import { LayoutDashboard, Activity, Settings, Wallet, Bell, Plug, Menu, X, BookOpen, BarChart3, Monitor } from "lucide-react";
import { Button } from "@/components/ui/button";

export function Nav() {
  const [location] = useLocation();
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  const links = [
    { href: "/", label: "PANEL", icon: LayoutDashboard },
    { href: "/strategies", label: "ESTRATEGIAS", icon: Activity },
    { href: "/terminal", label: "TERMINAL", icon: BarChart3 },
    { href: "/monitor", label: "MONITOR", icon: Monitor },
    { href: "/wallet", label: "CARTERA", icon: Wallet },
    { href: "/integrations", label: "INTEGRACIONES", icon: Plug },
    { href: "/settings", label: "AJUSTES", icon: Settings },
    { href: "/guide", label: "GU√çA", icon: BookOpen },
  ];

  return (
    <>
      <nav className="h-14 md:h-16 border-b border-border bg-card/80 backdrop-blur-md sticky top-0 z-50 px-4 md:px-6 flex items-center justify-between">
        <div className="flex items-center gap-4 md:gap-8">
          <Button 
            variant="ghost" 
            size="icon" 
            className="md:hidden text-muted-foreground"
            onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
            data-testid="button-mobile-menu"
          >
            {mobileMenuOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
          </Button>
          
          <div className="flex items-center gap-2">
            <div className="h-7 w-7 md:h-8 md:w-8 bg-primary/20 rounded-md flex items-center justify-center border border-primary/50">
              <Activity className="h-4 w-4 md:h-5 md:w-5 text-primary" />
            </div>
            <span className="font-sans font-bold text-base md:text-lg tracking-tight">
              KRAKEN<span className="text-primary">BOT</span><span className="hidden sm:inline">.AI</span>
            </span>
          </div>

          <div className="hidden md:flex items-center gap-1">
            {links.map((link) => (
              <Link 
                key={link.href} 
                href={link.href}
                className={cn(
                  "px-2 lg:px-3 xl:px-4 py-2 rounded-md text-xs font-mono transition-colors flex items-center gap-1.5 lg:gap-2",
                  location === link.href 
                    ? "bg-primary/10 text-primary border border-primary/20" 
                    : "text-muted-foreground hover:text-foreground hover:bg-white/5"
                )}
              >
                <link.icon className="h-4 w-4" />
                <span className="hidden lg:inline text-xs">{link.label}</span>
              </Link>
            ))}
          </div>
        </div>

        <div className="flex items-center gap-2 md:gap-4">
          <Button variant="ghost" size="icon" className="relative text-muted-foreground hover:text-foreground h-8 w-8 md:h-10 md:w-10">
            <Bell className="h-4 w-4 md:h-5 md:w-5" />
            <span className="absolute top-1.5 right-1.5 md:top-2 md:right-2 h-2 w-2 bg-red-500 rounded-full animate-pulse" />
          </Button>
          <div className="h-7 w-7 md:h-8 md:w-8 rounded-full bg-gradient-to-tr from-primary to-purple-500 border border-white/10" />
        </div>
      </nav>
      
      {mobileMenuOpen && (
        <>
          <div 
            className="md:hidden fixed inset-0 top-14 z-30 bg-black/50"
            onClick={() => setMobileMenuOpen(false)}
            aria-hidden="true"
          />
          <div className="md:hidden fixed inset-x-0 top-14 z-40 bg-background border-b border-border max-h-[calc(100vh-3.5rem)] overflow-y-auto">
            <div className="flex flex-col p-4 gap-2">
              {links.map((link) => (
                <Link 
                  key={link.href} 
                  href={link.href}
                  onClick={() => setMobileMenuOpen(false)}
                  className={cn(
                    "px-4 py-3 rounded-lg text-sm font-mono transition-colors flex items-center gap-3",
                    location === link.href 
                      ? "bg-primary/10 text-primary border border-primary/20" 
                      : "text-muted-foreground hover:text-foreground hover:bg-white/5 border border-transparent"
                  )}
                >
                  <link.icon className="h-5 w-5" />
                  {link.label}
                </Link>
              ))}
            </div>
          </div>
        </>
      )}
    </>
  );
}


===== FILE: ./client/src/components/dashboard/ChartWidget.tsx =====
import { useQuery } from "@tanstack/react-query";
import { Area, AreaChart, CartesianGrid, ResponsiveContainer, Tooltip, XAxis, YAxis } from "recharts";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { RefreshCw, TrendingUp, TrendingDown, Target, Activity } from "lucide-react";

interface PerformanceData {
  curve: { time: string; equity: number; pnl?: number }[];
  summary: {
    startingEquity: number;
    endingEquity: number;
    totalPnlUsd: number;
    totalPnlPct: number;
    maxDrawdownPct: number;
    winRatePct: number;
    totalTrades: number;
    wins: number;
    losses: number;
  };
}

export function ChartWidget() {
  const { data, isLoading, refetch, isFetching } = useQuery<PerformanceData>({
    queryKey: ["performance"],
    queryFn: async () => {
      const res = await fetch("/api/performance");
      if (!res.ok) throw new Error("Failed to fetch performance");
      return res.json();
    },
    refetchInterval: false,
  });

  const chartData = data?.curve.map((point) => ({
    time: new Date(point.time).toLocaleDateString("es-ES", { 
      month: "short", 
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    }),
    equity: point.equity,
  })) || [];

  const summary = data?.summary;
  const isPositive = (summary?.totalPnlUsd || 0) >= 0;
  const hasTrades = (summary?.totalTrades || 0) > 0;

  return (
    <Card className="col-span-2 glass-panel border-border/50 h-full flex flex-col">
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <CardTitle className="text-sm font-medium font-mono tracking-wider text-muted-foreground">
          RENDIMIENTO DEL PORTAFOLIO
        </CardTitle>
        <Button 
          variant="ghost" 
          size="sm" 
          onClick={() => refetch()}
          disabled={isFetching}
          className="h-8 px-2"
          data-testid="btn-refresh-chart"
        >
          <RefreshCw className={`h-4 w-4 ${isFetching ? 'animate-spin' : ''}`} />
        </Button>
      </CardHeader>
      
      {summary && (
        <div className="px-6 pb-2 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div className="flex items-center gap-2 p-2 rounded-lg bg-muted/30">
            {isPositive ? (
              <TrendingUp className="h-4 w-4 text-emerald-400" />
            ) : (
              <TrendingDown className="h-4 w-4 text-red-400" />
            )}
            <div>
              <div className="text-xs text-muted-foreground">P&L Total</div>
              <div className={`font-mono font-semibold ${isPositive ? 'text-emerald-400' : 'text-red-400'}`}>
                {isPositive ? '+' : ''}{summary.totalPnlUsd.toFixed(2)} USD
              </div>
            </div>
          </div>
          <div className="flex items-center gap-2 p-2 rounded-lg bg-muted/30">
            <Target className="h-4 w-4 text-cyan-400" />
            <div>
              <div className="text-xs text-muted-foreground">Win Rate</div>
              <div className="font-mono font-semibold text-cyan-400">
                {summary.winRatePct.toFixed(1)}%
              </div>
            </div>
          </div>
          <div className="flex items-center gap-2 p-2 rounded-lg bg-muted/30">
            <Activity className="h-4 w-4 text-purple-400" />
            <div>
              <div className="text-xs text-muted-foreground">Trades</div>
              <div className="font-mono font-semibold text-purple-400">
                {summary.totalTrades} ({summary.wins}W/{summary.losses}L)
              </div>
            </div>
          </div>
          <div className="flex items-center gap-2 p-2 rounded-lg bg-muted/30">
            <TrendingDown className="h-4 w-4 text-orange-400" />
            <div>
              <div className="text-xs text-muted-foreground">Max Drawdown</div>
              <div className="font-mono font-semibold text-orange-400">
                -{summary.maxDrawdownPct.toFixed(2)}%
              </div>
            </div>
          </div>
        </div>
      )}

      <CardContent className="flex-1 min-h-[280px] w-full pt-2">
        {isLoading ? (
          <div className="h-full flex items-center justify-center text-muted-foreground">
            Cargando datos de rendimiento...
          </div>
        ) : !hasTrades ? (
          <div className="h-full flex flex-col items-center justify-center text-muted-foreground gap-3">
            <Activity className="h-12 w-12 opacity-30" />
            <div className="text-center">
              <p className="font-medium">Sin operaciones completadas</p>
              <p className="text-sm opacity-70">El gr√°fico mostrar√° la curva de equity cuando el bot ejecute trades</p>
            </div>
          </div>
        ) : (
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={chartData}>
              <defs>
                <linearGradient id="equityGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#00FF88" stopOpacity={0.4} />
                  <stop offset="50%" stopColor="#00FF88" stopOpacity={0.15} />
                  <stop offset="95%" stopColor="#00FF88" stopOpacity={0} />
                </linearGradient>
              </defs>
              <CartesianGrid 
                strokeDasharray="3 3" 
                stroke="rgba(255,255,255,0.1)" 
                vertical={false} 
              />
              <XAxis 
                dataKey="time" 
                stroke="#888888" 
                fontSize={11} 
                tickLine={false} 
                axisLine={{ stroke: 'rgba(255,255,255,0.2)' }}
                fontFamily="JetBrains Mono"
                tick={{ fill: '#aaaaaa' }}
              />
              <YAxis 
                stroke="#888888" 
                fontSize={11} 
                tickLine={false} 
                axisLine={{ stroke: 'rgba(255,255,255,0.2)' }}
                tickFormatter={(value) => `$${value.toFixed(0)}`}
                fontFamily="JetBrains Mono"
                tick={{ fill: '#aaaaaa' }}
                domain={['dataMin - 10', 'dataMax + 10']}
              />
              <Tooltip 
                contentStyle={{ 
                  backgroundColor: 'rgba(20, 20, 30, 0.95)', 
                  borderColor: '#00FF88',
                  borderWidth: 1,
                  borderRadius: '8px',
                  fontFamily: 'JetBrains Mono',
                  boxShadow: '0 4px 20px rgba(0, 255, 136, 0.2)'
                }}
                labelStyle={{ color: '#ffffff', fontWeight: 'bold' }}
                itemStyle={{ color: '#00FF88' }}
                formatter={(value: number) => [`$${value.toFixed(2)}`, 'Equity']}
              />
              <Area 
                type="monotone" 
                dataKey="equity" 
                stroke="#00FF88" 
                strokeWidth={3}
                fillOpacity={1} 
                fill="url(#equityGradient)"
                dot={false}
                activeDot={{ r: 6, fill: '#00FF88', stroke: '#ffffff', strokeWidth: 2 }}
              />
            </AreaChart>
          </ResponsiveContainer>
        )}
      </CardContent>
    </Card>
  );
}


===== FILE: ./client/src/components/dashboard/Ticker.tsx =====
import { ArrowUpRight, ArrowDownRight } from "lucide-react";
import { cn } from "@/lib/utils";
import { useQuery } from "@tanstack/react-query";

interface DashboardData {
  prices: Record<string, { price: string; change: string }>;
}

const PAIR_NAMES: Record<string, string> = {
  "XXBTZUSD": "BTC/USD",
  "XETHZUSD": "ETH/USD",
  "SOLUSD": "SOL/USD",
  "XXRPZUSD": "XRP/USD",
  "TONUSD": "TON/USD",
};

function formatPrice(price: string): string {
  const num = parseFloat(price);
  if (num >= 1000) {
    return num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }
  return num.toFixed(num < 1 ? 6 : 2);
}

export function Ticker() {
  const { data } = useQuery<DashboardData>({
    queryKey: ["/api/dashboard"],
    refetchInterval: 10000,
  });

  const pairs = data?.prices 
    ? Object.entries(data.prices).map(([key, value]) => ({
        symbol: PAIR_NAMES[key] || key,
        price: formatPrice(value.price),
        change: `${parseFloat(value.change) >= 0 ? "+" : ""}${value.change}%`,
        up: parseFloat(value.change) >= 0,
      }))
    : [
        { symbol: "BTC/USD", price: "--", change: "--%", up: true },
        { symbol: "ETH/USD", price: "--", change: "--%", up: true },
        { symbol: "SOL/USD", price: "--", change: "--%", up: true },
      ];

  return (
    <div className="w-full bg-card/50 border-b border-border overflow-hidden py-2 flex items-center whitespace-nowrap group">
      <div className="flex animate-ticker group-hover:[animation-play-state:paused] gap-12 px-4">
        {[...pairs, ...pairs, ...pairs, ...pairs].map((pair, idx) => (
          <div key={idx} className="flex items-center gap-3 font-mono text-sm">
            <span className="text-muted-foreground font-bold">{pair.symbol}</span>
            <span className="text-foreground font-medium">${pair.price}</span>
            <span className={cn("flex items-center text-xs font-medium", pair.up ? "text-green-500" : "text-red-500")}>
              {pair.up ? <ArrowUpRight className="h-3 w-3 mr-0.5" /> : <ArrowDownRight className="h-3 w-3 mr-0.5" />}
              {pair.change}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
}


===== FILE: ./client/src/components/dashboard/BotControl.tsx =====
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { TrendingUp, RefreshCw, Zap, Target, Shield, Info, Power } from "lucide-react";
import { cn } from "@/lib/utils";
import { useQuery } from "@tanstack/react-query";
import type { BotConfig } from "@shared/schema";

const STRATEGIES: Record<string, { name: string; icon: typeof TrendingUp }> = {
  momentum: { name: "Momentum", icon: TrendingUp },
  mean_reversion: { name: "Reversi√≥n a la Media", icon: RefreshCw },
  scalping: { name: "Scalping", icon: Zap },
  grid: { name: "Grid Trading", icon: Target },
};

const RISK_LEVELS: Record<string, { name: string; color: string }> = {
  low: { name: "Bajo", color: "text-green-500 bg-green-500/10 border-green-500/30" },
  medium: { name: "Medio", color: "text-yellow-500 bg-yellow-500/10 border-yellow-500/30" },
  high: { name: "Alto", color: "text-red-500 bg-red-500/10 border-red-500/30" },
};

export function BotControl() {
  const { data: config } = useQuery<BotConfig>({
    queryKey: ["botConfig"],
    queryFn: async () => {
      const res = await fetch("/api/config");
      if (!res.ok) throw new Error("Failed to fetch config");
      return res.json();
    },
  });

  const isActive = config?.isActive ?? false;
  const strategyId = config?.strategy || "momentum";
  const riskId = config?.riskLevel || "medium";
  
  const currentStrategy = STRATEGIES[strategyId] || STRATEGIES.momentum;
  const currentRisk = RISK_LEVELS[riskId] || RISK_LEVELS.medium;
  const StrategyIcon = currentStrategy.icon;

  return (
    <Card className="glass-panel border-border/50">
      <CardHeader className="pb-3 border-b border-border/50 bg-muted/10">
        <CardTitle className="text-sm font-medium font-mono flex items-center justify-between">
          <span>CONTROL DEL SISTEMA</span>
          <div className="flex items-center gap-2">
            <div className={cn("h-2 w-2 rounded-full", isActive ? "bg-green-500 animate-pulse" : "bg-red-500")} />
            <span className={cn("text-xs", isActive ? "text-green-500" : "text-red-500")}>
              {isActive ? "ACTIVO" : "INACTIVO"}
            </span>
          </div>
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4 pt-4">
        
        <div className="flex items-center justify-between p-3 rounded-lg border border-border/50 bg-background/50">
          <div className="flex items-center gap-2">
            <Power className={cn("h-4 w-4", isActive ? "text-green-500" : "text-red-500")} />
            <span className="text-sm">Estado del Bot</span>
          </div>
          <Badge 
            variant="outline" 
            className={cn("font-mono border", isActive ? "text-green-500 bg-green-500/10 border-green-500/30" : "text-red-500 bg-red-500/10 border-red-500/30")}
          >
            {isActive ? "ENCENDIDO" : "APAGADO"}
          </Badge>
        </div>

        <div className="grid gap-3">
          <Label className="text-xs font-mono text-muted-foreground">CONFIGURACI√ìN ACTIVA</Label>
          
          <div className="flex items-center justify-between p-3 rounded-lg border border-border/50 bg-background/50">
            <div className="flex items-center gap-2">
              <StrategyIcon className="h-4 w-4 text-primary" />
              <span className="text-sm">Estrategia</span>
            </div>
            <Badge variant="outline" className="font-mono">
              {currentStrategy.name.toUpperCase()}
            </Badge>
          </div>

          <div className="flex items-center justify-between p-3 rounded-lg border border-border/50 bg-background/50">
            <div className="flex items-center gap-2">
              <Shield className="h-4 w-4 text-primary" />
              <span className="text-sm">Nivel de Riesgo</span>
            </div>
            <Badge variant="outline" className={cn("font-mono border", currentRisk.color)}>
              {currentRisk.name.toUpperCase()}
            </Badge>
          </div>
        </div>
        
        <div className="bg-muted/30 border border-border/50 p-3 rounded-md flex gap-3 items-start">
          <Info className="h-4 w-4 text-muted-foreground shrink-0 mt-0.5" />
          <p className="text-[10px] text-muted-foreground leading-tight">
            Panel informativo. Para cambiar la configuraci√≥n o encender/apagar el bot, usa la pesta√±a <strong>Estrategias</strong>.
          </p>
        </div>
      </CardContent>
    </Card>
  );
}


===== FILE: ./client/src/components/dashboard/TradeLog.tsx =====
import { useQuery } from "@tanstack/react-query";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Badge } from "@/components/ui/badge";
import { RefreshCw, Clock } from "lucide-react";
import { Button } from "@/components/ui/button";

interface Trade {
  id: string;
  krakenOrderId?: string;
  pair: string;
  type: string;
  price: string;
  amount: string;
  time: string;
  status: string;
}

export function TradeLog() {
  const { data: krakenTrades, isLoading, refetch, isFetching } = useQuery<Trade[]>({
    queryKey: ["krakenTrades"],
    queryFn: async () => {
      const res = await fetch("/api/kraken/trades");
      if (!res.ok) {
        const dbRes = await fetch("/api/trades?limit=10");
        if (!dbRes.ok) return [];
        return dbRes.json();
      }
      return res.json();
    },
    refetchInterval: 60000,
  });

  const formatTime = (timeStr: string) => {
    const date = new Date(timeStr);
    return date.toLocaleTimeString("es-ES", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  };

  const formatPrice = (price: string) => {
    const num = parseFloat(price);
    return num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  const formatAmount = (amount: string, pair: string) => {
    const num = parseFloat(amount);
    const asset = pair.split("/")[0];
    return `${num.toFixed(6)} ${asset}`;
  };

  return (
    <div className="rounded-md border border-border bg-card/50">
      <div className="p-3 md:p-4 border-b border-border bg-muted/20 flex items-center justify-between gap-2">
        <h3 className="font-semibold font-mono text-xs md:text-sm tracking-wider text-primary">REGISTRO DE OPERACIONES</h3>
        <Button 
          variant="ghost" 
          size="sm" 
          onClick={() => refetch()}
          disabled={isFetching}
          className="text-muted-foreground hover:text-primary text-xs md:text-sm"
          data-testid="button-refresh-trades"
        >
          <RefreshCw className={`h-4 w-4 ${isFetching ? 'animate-spin' : ''}`} />
          <span className="hidden sm:inline ml-2">Actualizar</span>
        </Button>
      </div>
      <div className="overflow-x-auto">
        <Table>
          <TableHeader>
            <TableRow className="hover:bg-transparent border-border">
              <TableHead className="w-[80px] font-mono text-xs">ID</TableHead>
              <TableHead className="font-mono text-xs">PAR</TableHead>
              <TableHead className="font-mono text-xs">TIPO</TableHead>
              <TableHead className="font-mono text-xs text-right">PRECIO</TableHead>
              <TableHead className="font-mono text-xs text-right hidden sm:table-cell">CANTIDAD</TableHead>
              <TableHead className="font-mono text-xs text-right hidden md:table-cell">HORA</TableHead>
              <TableHead className="font-mono text-xs text-right">ESTADO</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {isLoading ? (
              <TableRow>
                <TableCell colSpan={7} className="text-center py-8">
                  <div className="flex items-center justify-center gap-2 text-muted-foreground">
                    <RefreshCw className="h-4 w-4 animate-spin" />
                    Cargando operaciones...
                  </div>
                </TableCell>
              </TableRow>
            ) : krakenTrades && krakenTrades.length > 0 ? (
              krakenTrades.slice(0, 10).map((trade) => (
                <TableRow key={trade.id || trade.krakenOrderId} className="hover:bg-muted/50 border-border font-mono text-xs" data-testid={`trade-row-${trade.id}`}>
                  <TableCell className="font-medium text-muted-foreground text-xs">{trade.id}</TableCell>
                  <TableCell className="text-foreground text-xs">{trade.pair}</TableCell>
                  <TableCell>
                    <Badge variant="outline" className={`text-xs ${trade.type === "buy" ? "text-green-500 border-green-500/50 bg-green-500/10" : "text-red-500 border-red-500/50 bg-red-500/10"}`}>
                      {trade.type === "buy" ? "COMPRA" : "VENTA"}
                    </Badge>
                  </TableCell>
                  <TableCell className="text-right text-xs">{formatPrice(trade.price)}</TableCell>
                  <TableCell className="text-right text-muted-foreground text-xs hidden sm:table-cell">{formatAmount(trade.amount, trade.pair)}</TableCell>
                  <TableCell className="text-right text-muted-foreground text-xs hidden md:table-cell">{formatTime(trade.time)}</TableCell>
                  <TableCell className="text-right text-primary text-xs">{trade.status === "filled" ? "OK" : trade.status}</TableCell>
                </TableRow>
              ))
            ) : (
              <TableRow>
                <TableCell colSpan={7} className="text-center py-8">
                  <div className="flex flex-col items-center gap-2 text-muted-foreground">
                    <Clock className="h-8 w-8 opacity-50" />
                    <p>No hay operaciones registradas</p>
                    <p className="text-xs">Las operaciones aparecer√°n aqu√≠ cuando se ejecuten trades.</p>
                  </div>
                </TableCell>
              </TableRow>
            )}
          </TableBody>
        </Table>
      </div>
    </div>
  );
}


===== FILE: ./.local/state/memory/persisted_information.md =====
# KrakenBot - Estado Actual (15 Dic 2025)

## TAREAS COMPLETADAS

### 1. Unificaci√≥n de m√©tricas de diagn√≥stico IA
- A√±adido `lastBackfillDiscardReasonsJson` a ai_config
- `getDiagnostic()` devuelve `discardReasonsDataset` y `lastBackfillDiscardReasons`
- Traducci√≥n de claves legacy ingl√©s‚Üícastellano via LEGACY_KEY_MAP
- Invariancia: qtyRemaining <= epsilon ‚Üí isClosed=true

### 2. Fix UI /settings
- Actualizado interface AiDiagnostic con nuevos campos
- Cambiado `discardReasons` ‚Üí `discardReasonsDataset || {}`

### 3. Actualizaci√≥n de replit.md
- A√±adida secci√≥n AI Filter Module completa
- Documentados discard reasons en castellano
- A√±adida secci√≥n Recent Changes (Dec 2025)

## Estado actual
- Build: OK
- APIs: OK (diagnostic, config, open-positions)
- UI: Necesita hard refresh del navegador (Ctrl+Shift+R) por JS cacheado
- Motor de trading: Funcionando normalmente

## Pendiente usuario
- Hard refresh en navegador para limpiar cache de JS viejo
- Validar en NAS: GET‚ÜíPOST backfill‚ÜíGET
- Autorizar publicaci√≥n cuando confirme que todo funciona

## Archivos clave modificados
- shared/schema.ts
- server/storage.ts  
- server/services/aiService.ts
- client/src/pages/Settings.tsx
- replit.md


===== FILE: ./client/src/components/dashboard/AssetCard.tsx =====
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { cn } from "@/lib/utils";
import { ArrowUp, ArrowDown, Wallet } from "lucide-react";

interface AssetCardProps {
  symbol: string;
  name: string;
  balance: string;
  value: string;
  change: number; // percentage
}

export function AssetCard({ symbol, name, balance, value, change }: AssetCardProps) {
  const isPositive = change >= 0;

  return (
    <Card className="glass-panel border-border/50 shadow-lg relative overflow-hidden group">
      <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity hidden sm:block">
        <Wallet className="h-16 md:h-24 w-16 md:w-24 -mr-6 md:-mr-8 -mt-6 md:-mt-8 rotate-12" />
      </div>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-1 md:pb-2 px-3 md:px-6 pt-3 md:pt-6">
        <CardTitle className="text-xs md:text-sm font-medium font-mono text-muted-foreground truncate">
          <span className="hidden sm:inline">{name}</span>
          <span className="sm:hidden">{symbol}</span>
          <span className="text-primary/50 ml-1 md:ml-2 hidden sm:inline">[{symbol}]</span>
        </CardTitle>
        {isPositive ? (
          <ArrowUp className="h-3 w-3 md:h-4 md:w-4 text-green-500 shrink-0" />
        ) : (
          <ArrowDown className="h-3 w-3 md:h-4 md:w-4 text-red-500 shrink-0" />
        )}
      </CardHeader>
      <CardContent className="px-3 md:px-6 pb-3 md:pb-6">
        <div className="text-lg md:text-2xl font-bold font-mono tracking-tighter truncate">{value}</div>
        <p className="text-[10px] md:text-xs text-muted-foreground mt-1 font-mono">
          <span className="hidden sm:inline">{balance} {symbol}</span>
          <span className={cn("sm:ml-2", isPositive ? "text-green-500" : "text-red-500")}>
            {isPositive ? "+" : ""}{change}%
          </span>
        </p>
      </CardContent>
    </Card>
  );
}


===== FILE: ./client/src/components/ui/separator.tsx =====
import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }


===== FILE: ./client/src/components/ui/form.tsx =====
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue | null>(null)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState, formState } = useFormContext()

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  if (!itemContext) {
    throw new Error("useFormField should be used within <FormItem>")
  }

  const fieldState = getFieldState(fieldContext.name, formState)

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue | null>(null)

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  )
})
FormItem.displayName = "FormItem"

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField()

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
})
FormLabel.displayName = "FormLabel"

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
})
FormControl.displayName = "FormControl"

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField()

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-[0.8rem] text-muted-foreground", className)}
      {...props}
    />
  )
})
FormDescription.displayName = "FormDescription"

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : children

  if (!body) {
    return null
  }

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-[0.8rem] font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  )
})
FormMessage.displayName = "FormMessage"

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}


===== FILE: ./client/src/components/ui/skeleton.tsx =====
import { cn } from "@/lib/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-primary/10", className)}
      {...props}
    />
  )
}

export { Skeleton }


===== FILE: ./client/src/components/ui/scroll-area.tsx =====
import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }


===== FILE: ./client/src/components/ui/tooltip.tsx =====
"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Portal>
    <TooltipPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",
        className
      )}
      {...props}
    />
  </TooltipPrimitive.Portal>
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }


===== FILE: ./client/src/components/ui/chart.tsx =====
import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

const ChartContainer = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> & {
    config: ChartConfig
    children: React.ComponentProps<
      typeof RechartsPrimitive.ResponsiveContainer
    >["children"]
  }
>(({ id, className, children, config, ...props }, ref) => {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-chart={chartId}
        ref={ref}
        className={cn(
          "flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
})
ChartContainer.displayName = "Chart"

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

const ChartTooltipContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
    React.ComponentProps<"div"> & {
      hideLabel?: boolean
      hideIndicator?: boolean
      indicator?: "line" | "dot" | "dashed"
      nameKey?: string
      labelKey?: string
    }
>(
  (
    {
      active,
      payload,
      className,
      indicator = "dot",
      hideLabel = false,
      hideIndicator = false,
      label,
      labelFormatter,
      labelClassName,
      formatter,
      color,
      nameKey,
      labelKey,
    },
    ref
  ) => {
    const { config } = useChart()

    const tooltipLabel = React.useMemo(() => {
      if (hideLabel || !payload?.length) {
        return null
      }

      const [item] = payload
      const key = `${labelKey || item?.dataKey || item?.name || "value"}`
      const itemConfig = getPayloadConfigFromPayload(config, item, key)
      const value =
        !labelKey && typeof label === "string"
          ? config[label as keyof typeof config]?.label || label
          : itemConfig?.label

      if (labelFormatter) {
        return (
          <div className={cn("font-medium", labelClassName)}>
            {labelFormatter(value, payload)}
          </div>
        )
      }

      if (!value) {
        return null
      }

      return <div className={cn("font-medium", labelClassName)}>{value}</div>
    }, [
      label,
      labelFormatter,
      payload,
      hideLabel,
      labelClassName,
      config,
      labelKey,
    ])

    if (!active || !payload?.length) {
      return null
    }

    const nestLabel = payload.length === 1 && indicator !== "dot"

    return (
      <div
        ref={ref}
        className={cn(
          "grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",
          className
        )}
      >
        {!nestLabel ? tooltipLabel : null}
        <div className="grid gap-1.5">
          {payload
            .filter((item) => item.type !== "none")
            .map((item, index) => {
              const key = `${nameKey || item.name || item.dataKey || "value"}`
              const itemConfig = getPayloadConfigFromPayload(config, item, key)
              const indicatorColor = color || item.payload.fill || item.color

              return (
                <div
                  key={item.dataKey}
                  className={cn(
                    "flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",
                    indicator === "dot" && "items-center"
                  )}
                >
                  {formatter && item?.value !== undefined && item.name ? (
                    formatter(item.value, item.name, item, index, item.payload)
                  ) : (
                    <>
                      {itemConfig?.icon ? (
                        <itemConfig.icon />
                      ) : (
                        !hideIndicator && (
                          <div
                            className={cn(
                              "shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",
                              {
                                "h-2.5 w-2.5": indicator === "dot",
                                "w-1": indicator === "line",
                                "w-0 border-[1.5px] border-dashed bg-transparent":
                                  indicator === "dashed",
                                "my-0.5": nestLabel && indicator === "dashed",
                              }
                            )}
                            style={
                              {
                                "--color-bg": indicatorColor,
                                "--color-border": indicatorColor,
                              } as React.CSSProperties
                            }
                          />
                        )
                      )}
                      <div
                        className={cn(
                          "flex flex-1 justify-between leading-none",
                          nestLabel ? "items-end" : "items-center"
                        )}
                      >
                        <div className="grid gap-1.5">
                          {nestLabel ? tooltipLabel : null}
                          <span className="text-muted-foreground">
                            {itemConfig?.label || item.name}
                          </span>
                        </div>
                        {item.value && (
                          <span className="font-mono font-medium tabular-nums text-foreground">
                            {item.value.toLocaleString()}
                          </span>
                        )}
                      </div>
                    </>
                  )}
                </div>
              )
            })}
        </div>
      </div>
    )
  }
)
ChartTooltipContent.displayName = "ChartTooltip"

const ChartLegend = RechartsPrimitive.Legend

const ChartLegendContent = React.forwardRef<
  HTMLDivElement,
  React.ComponentProps<"div"> &
    Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
      hideIcon?: boolean
      nameKey?: string
    }
>(
  (
    { className, hideIcon = false, payload, verticalAlign = "bottom", nameKey },
    ref
  ) => {
    const { config } = useChart()

    if (!payload?.length) {
      return null
    }

    return (
      <div
        ref={ref}
        className={cn(
          "flex items-center justify-center gap-4",
          verticalAlign === "top" ? "pb-3" : "pt-3",
          className
        )}
      >
        {payload
          .filter((item) => item.type !== "none")
          .map((item) => {
            const key = `${nameKey || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)

            return (
              <div
                key={item.value}
                className={cn(
                  "flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"
                )}
              >
                {itemConfig?.icon && !hideIcon ? (
                  <itemConfig.icon />
                ) : (
                  <div
                    className="h-2 w-2 shrink-0 rounded-[2px]"
                    style={{
                      backgroundColor: item.color,
                    }}
                  />
                )}
                {itemConfig?.label}
              </div>
            )
          })}
      </div>
    )
  }
)
ChartLegendContent.displayName = "ChartLegend"

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}


===== FILE: ./client/src/components/ui/radio-group.tsx =====
import * as React from "react"
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group"
import { Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const RadioGroup = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Root
      className={cn("grid gap-2", className)}
      {...props}
      ref={ref}
    />
  )
})
RadioGroup.displayName = RadioGroupPrimitive.Root.displayName

const RadioGroupItem = React.forwardRef<
  React.ElementRef<typeof RadioGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>
>(({ className, ...props }, ref) => {
  return (
    <RadioGroupPrimitive.Item
      ref={ref}
      className={cn(
        "aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator className="flex items-center justify-center">
        <Circle className="h-3.5 w-3.5 fill-primary" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
})
RadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName

export { RadioGroup, RadioGroupItem }


===== FILE: ./client/src/main.tsx =====
import { createRoot } from "react-dom/client";
import App from "./App";
import "./index.css";

createRoot(document.getElementById("root")!).render(<App />);


===== FILE: ./client/src/components/ui/card.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


===== FILE: ./client/src/components/ui/hover-card.tsx =====
import * as React from "react"
import * as HoverCardPrimitive from "@radix-ui/react-hover-card"

import { cn } from "@/lib/utils"

const HoverCard = HoverCardPrimitive.Root

const HoverCardTrigger = HoverCardPrimitive.Trigger

const HoverCardContent = React.forwardRef<
  React.ElementRef<typeof HoverCardPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <HoverCardPrimitive.Content
    ref={ref}
    align={align}
    sideOffset={sideOffset}
    className={cn(
      "z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]",
      className
    )}
    {...props}
  />
))
HoverCardContent.displayName = HoverCardPrimitive.Content.displayName

export { HoverCard, HoverCardTrigger, HoverCardContent }


===== FILE: ./client/src/components/ui/textarea.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Textarea = React.forwardRef<
  HTMLTextAreaElement,
  React.ComponentProps<"textarea">
>(({ className, ...props }, ref) => {
  return (
    <textarea
      className={cn(
        "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      ref={ref}
      {...props}
    />
  )
})
Textarea.displayName = "Textarea"

export { Textarea }


===== FILE: ./client/src/components/ui/sidebar.tsx =====
"use client"

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, VariantProps } from "class-variance-authority"
import { PanelLeftIcon } from "lucide-react"

import { useIsMobile } from "@/hooks/use-mobile"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Separator } from "@/components/ui/separator"
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet"
import { Skeleton } from "@/components/ui/skeleton"
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip"

const SIDEBAR_COOKIE_NAME = "sidebar_state"
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = "16rem"
const SIDEBAR_WIDTH_MOBILE = "18rem"
const SIDEBAR_WIDTH_ICON = "3rem"
const SIDEBAR_KEYBOARD_SHORTCUT = "b"

type SidebarContextProps = {
  state: "expanded" | "collapsed"
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContextProps | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.")
  }

  return context
}

function SidebarProvider({
  defaultOpen = true,
  open: openProp,
  onOpenChange: setOpenProp,
  className,
  style,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  defaultOpen?: boolean
  open?: boolean
  onOpenChange?: (open: boolean) => void
}) {
  const isMobile = useIsMobile()
  const [openMobile, setOpenMobile] = React.useState(false)

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen)
  const open = openProp ?? _open
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === "function" ? value(open) : value
      if (setOpenProp) {
        setOpenProp(openState)
      } else {
        _setOpen(openState)
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
    },
    [setOpenProp, open]
  )

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)
  }, [isMobile, setOpen, setOpenMobile])

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault()
        toggleSidebar()
      }
    }

    window.addEventListener("keydown", handleKeyDown)
    return () => window.removeEventListener("keydown", handleKeyDown)
  }, [toggleSidebar])

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed"

  const contextValue = React.useMemo<SidebarContextProps>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
  )

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          data-slot="sidebar-wrapper"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn(
            "group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full",
            className
          )}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  )
}

function Sidebar({
  side = "left",
  variant = "sidebar",
  collapsible = "offcanvas",
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  side?: "left" | "right"
  variant?: "sidebar" | "floating" | "inset"
  collapsible?: "offcanvas" | "icon" | "none"
}) {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

  if (collapsible === "none") {
    return (
      <div
        data-slot="sidebar"
        className={cn(
          "bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col",
          className
        )}
        {...props}
      >
        {children}
      </div>
    )
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-slot="sidebar"
          data-mobile="true"
          className="bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <SheetHeader className="sr-only">
            <SheetTitle>Sidebar</SheetTitle>
            <SheetDescription>Displays the mobile sidebar.</SheetDescription>
          </SheetHeader>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    )
  }

  return (
    <div
      className="group peer text-sidebar-foreground hidden md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}
      data-slot="sidebar"
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        data-slot="sidebar-gap"
        className={cn(
          "relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]"
            : "group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]"
        )}
      />
      <div
        data-slot="sidebar-container"
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]"
            : "group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          data-slot="sidebar-inner"
          className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
        >
          {children}
        </div>
      </div>
    </div>
  )
}

function SidebarTrigger({
  className,
  onClick,
  ...props
}: React.ComponentProps<typeof Button>) {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      data-sidebar="trigger"
      data-slot="sidebar-trigger"
      variant="ghost"
      size="icon"
      className={cn("h-7 w-7", className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeftIcon />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
}

function SidebarRail({ className, ...props }: React.ComponentProps<"button">) {
  const { toggleSidebar } = useSidebar()

  // Note: Tailwind v3.4 doesn't support "in-" selectors. So the rail won't work perfectly.
  return (
    <button
      data-sidebar="rail"
      data-slot="sidebar-rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex",
        "in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className
      )}
      {...props}
    />
  )
}

function SidebarInset({ className, ...props }: React.ComponentProps<"main">) {
  return (
    <main
      data-slot="sidebar-inset"
      className={cn(
        "bg-background relative flex w-full flex-1 flex-col",
        "md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2",
        className
      )}
      {...props}
    />
  )
}

function SidebarInput({
  className,
  ...props
}: React.ComponentProps<typeof Input>) {
  return (
    <Input
      data-slot="sidebar-input"
      data-sidebar="input"
      className={cn("bg-background h-8 w-full shadow-none", className)}
      {...props}
    />
  )
}

function SidebarHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-header"
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
}

function SidebarFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-footer"
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  )
}

function SidebarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="sidebar-separator"
      data-sidebar="separator"
      className={cn("bg-sidebar-border mx-2 w-auto", className)}
      {...props}
    />
  )
}

function SidebarContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-content"
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group"
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  )
}

function SidebarGroupLabel({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"div"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      data-slot="sidebar-group-label"
      data-sidebar="group-label"
      className={cn(
        "text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className
      )}
      {...props}
    />
  )
}

function SidebarGroupAction({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="sidebar-group-action"
      data-sidebar="group-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarGroupContent({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group-content"
      data-sidebar="group-content"
      className={cn("w-full text-sm", className)}
      {...props}
    />
  )
}

function SidebarMenu({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu"
      data-sidebar="menu"
      className={cn("flex w-full min-w-0 flex-col gap-1", className)}
      {...props}
    />
  )
}

function SidebarMenuItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-item"
      data-sidebar="menu-item"
      className={cn("group/menu-item relative", className)}
      {...props}
    />
  )
}

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:p-0!",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function SidebarMenuButton({
  asChild = false,
  isActive = false,
  variant = "default",
  size = "default",
  tooltip,
  className,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean
  isActive?: boolean
  tooltip?: string | React.ComponentProps<typeof TooltipContent>
} & VariantProps<typeof sidebarMenuButtonVariants>) {
  const Comp = asChild ? Slot : "button"
  const { isMobile, state } = useSidebar()

  const button = (
    <Comp
      data-slot="sidebar-menu-button"
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  )

  if (!tooltip) {
    return button
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    }
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== "collapsed" || isMobile}
        {...tooltip}
      />
    </Tooltip>
  )
}

function SidebarMenuAction({
  className,
  asChild = false,
  showOnHover = false,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean
  showOnHover?: boolean
}) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="sidebar-menu-action"
      data-sidebar="menu-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0",
        className
      )}
      {...props}
    />
  )
}

function SidebarMenuBadge({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-menu-badge"
      data-sidebar="menu-badge"
      className={cn(
        "text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none",
        "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarMenuSkeleton({
  className,
  showIcon = false,
  ...props
}: React.ComponentProps<"div"> & {
  showIcon?: boolean
}) {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      data-slot="sidebar-menu-skeleton"
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-[var(--skeleton-width)] flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  )
}

function SidebarMenuSub({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu-sub"
      data-sidebar="menu-sub"
      className={cn(
        "border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

function SidebarMenuSubItem({
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-sub-item"
      data-sidebar="menu-sub-item"
      className={cn("group/menu-sub-item relative", className)}
      {...props}
    />
  )
}

function SidebarMenuSubButton({
  asChild = false,
  size = "md",
  isActive = false,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean
  size?: "sm" | "md"
  isActive?: boolean
}) {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      data-slot="sidebar-menu-sub-button"
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className
      )}
      {...props}
    />
  )
}

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}


===== FILE: ./client/src/components/ui/collapsible.tsx =====
"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }


===== FILE: ./client/src/components/ui/tabs.tsx =====
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }


===== FILE: ./client/src/components/ui/toast.tsx =====
import * as React from "react"
import * as ToastPrimitives from "@radix-ui/react-toast"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      "fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",
      className
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  "group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",
  {
    variants: {
      variant: {
        default: "border bg-background text-foreground",
        destructive:
          "destructive group border-destructive bg-destructive text-destructive-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      "inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive",
      className
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      "absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",
      className
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn("text-sm font-semibold", className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn("text-sm opacity-90", className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}


===== FILE: ./client/src/components/ui/button.tsx =====
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0" +
" hover-elevate active-elevate-2",
  {
    variants: {
      variant: {
        default:
           // @replit: no hover, and add primary border
           "bg-primary text-primary-foreground border border-primary-border",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm border-destructive-border",
        outline:
          // @replit Shows the background color of whatever card / sidebar / accent background it is inside of.
          // Inherits the current text color. Uses shadow-xs. no shadow on active
          // No hover state
          " border [border-color:var(--button-outline)] shadow-xs active:shadow-none ",
        secondary:
          // @replit border, no hover, no shadow, secondary border.
          "border bg-secondary text-secondary-foreground border border-secondary-border ",
        // @replit no hover, transparent border
        ghost: "border border-transparent",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        // @replit changed sizes
        default: "min-h-9 px-4 py-2",
        sm: "min-h-8 rounded-md px-3 text-xs",
        lg: "min-h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }


===== FILE: ./client/src/components/ui/alert-dialog.tsx =====
import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}


===== FILE: ./client/src/components/ui/input-otp.tsx =====
import * as React from "react"
import { OTPInput, OTPInputContext } from "input-otp"
import { Minus } from "lucide-react"

import { cn } from "@/lib/utils"

const InputOTP = React.forwardRef<
  React.ElementRef<typeof OTPInput>,
  React.ComponentPropsWithoutRef<typeof OTPInput>
>(({ className, containerClassName, ...props }, ref) => (
  <OTPInput
    ref={ref}
    containerClassName={cn(
      "flex items-center gap-2 has-[:disabled]:opacity-50",
      containerClassName
    )}
    className={cn("disabled:cursor-not-allowed", className)}
    {...props}
  />
))
InputOTP.displayName = "InputOTP"

const InputOTPGroup = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("flex items-center", className)} {...props} />
))
InputOTPGroup.displayName = "InputOTPGroup"

const InputOTPSlot = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div"> & { index: number }
>(({ index, className, ...props }, ref) => {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]

  return (
    <div
      ref={ref}
      className={cn(
        "relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md",
        isActive && "z-10 ring-1 ring-ring",
        className
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="h-4 w-px animate-caret-blink bg-foreground duration-1000" />
        </div>
      )}
    </div>
  )
})
InputOTPSlot.displayName = "InputOTPSlot"

const InputOTPSeparator = React.forwardRef<
  React.ElementRef<"div">,
  React.ComponentPropsWithoutRef<"div">
>(({ ...props }, ref) => (
  <div ref={ref} role="separator" {...props}>
    <Minus />
  </div>
))
InputOTPSeparator.displayName = "InputOTPSeparator"

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }


===== FILE: ./client/src/components/ui/dropdown-menu.tsx =====
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}


===== FILE: ./client/src/components/ui/accordion.tsx =====
import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDown className="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))
AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }


===== FILE: ./client/src/components/ui/command.tsx =====
"use client"

import * as React from "react"
import { type DialogProps } from "@radix-ui/react-dialog"
import { Command as CommandPrimitive } from "cmdk"
import { Search } from "lucide-react"

import { cn } from "@/lib/utils"
import { Dialog, DialogContent } from "@/components/ui/dialog"

const Command = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
  <CommandPrimitive
    ref={ref}
    className={cn(
      "flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",
      className
    )}
    {...props}
  />
))
Command.displayName = CommandPrimitive.displayName

const CommandDialog = ({ children, ...props }: DialogProps) => {
  return (
    <Dialog {...props}>
      <DialogContent className="overflow-hidden p-0">
        <Command className="[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

const CommandInput = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Input>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
  <div className="flex items-center border-b px-3" cmdk-input-wrapper="">
    <Search className="mr-2 h-4 w-4 shrink-0 opacity-50" />
    <CommandPrimitive.Input
      ref={ref}
      className={cn(
        "flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    />
  </div>
))

CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.List
    ref={ref}
    className={cn("max-h-[300px] overflow-y-auto overflow-x-hidden", className)}
    {...props}
  />
))

CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Empty>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
  <CommandPrimitive.Empty
    ref={ref}
    className="py-6 text-center text-sm"
    {...props}
  />
))

CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Group>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Group
    ref={ref}
    className={cn(
      "overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
      className
    )}
    {...props}
  />
))

CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 h-px bg-border", className)}
    {...props}
  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
  React.ElementRef<typeof CommandPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
  <CommandPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      className
    )}
    {...props}
  />
))

CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}


===== FILE: ./client/src/components/ui/slider.tsx =====
import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20">
      <SliderPrimitive.Range className="absolute h-full bg-primary" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }


===== FILE: ./client/src/components/ui/field.tsx =====
"use client"

import { useMemo } from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"
import { Separator } from "@/components/ui/separator"

function FieldSet({ className, ...props }: React.ComponentProps<"fieldset">) {
  return (
    <fieldset
      data-slot="field-set"
      className={cn(
        "flex flex-col gap-6",
        "has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3",
        className
      )}
      {...props}
    />
  )
}

function FieldLegend({
  className,
  variant = "legend",
  ...props
}: React.ComponentProps<"legend"> & { variant?: "legend" | "label" }) {
  return (
    <legend
      data-slot="field-legend"
      data-variant={variant}
      className={cn(
        "mb-3 font-medium",
        "data-[variant=legend]:text-base",
        "data-[variant=label]:text-sm",
        className
      )}
      {...props}
    />
  )
}

function FieldGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-group"
      className={cn(
        "group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4",
        className
      )}
      {...props}
    />
  )
}

const fieldVariants = cva(
  "group/field data-[invalid=true]:text-destructive flex w-full gap-3",
  {
    variants: {
      orientation: {
        vertical: ["flex-col [&>*]:w-full [&>.sr-only]:w-auto"],
        horizontal: [
          "flex-row items-center",
          "[&>[data-slot=field-label]]:flex-auto",
          "has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px has-[>[data-slot=field-content]]:items-start",
        ],
        responsive: [
          "@md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto flex-col [&>*]:w-full [&>.sr-only]:w-auto",
          "@md/field-group:[&>[data-slot=field-label]]:flex-auto",
          "@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px",
        ],
      },
    },
    defaultVariants: {
      orientation: "vertical",
    },
  }
)

function Field({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof fieldVariants>) {
  return (
    <div
      role="group"
      data-slot="field"
      data-orientation={orientation}
      className={cn(fieldVariants({ orientation }), className)}
      {...props}
    />
  )
}

function FieldContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-content"
      className={cn(
        "group/field-content flex flex-1 flex-col gap-1.5 leading-snug",
        className
      )}
      {...props}
    />
  )
}

function FieldLabel({
  className,
  ...props
}: React.ComponentProps<typeof Label>) {
  return (
    <Label
      data-slot="field-label"
      className={cn(
        "group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50",
        "has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>[data-slot=field]]:p-4",
        "has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10",
        className
      )}
      {...props}
    />
  )
}

function FieldTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-label"
      className={cn(
        "flex w-fit items-center gap-2 text-sm font-medium leading-snug group-data-[disabled=true]/field:opacity-50",
        className
      )}
      {...props}
    />
  )
}

function FieldDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="field-description"
      className={cn(
        "text-muted-foreground text-sm font-normal leading-normal group-has-[[data-orientation=horizontal]]/field:text-balance",
        "nth-last-2:-mt-1 last:mt-0 [[data-variant=legend]+&]:-mt-1.5",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  )
}

function FieldSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"div"> & {
  children?: React.ReactNode
}) {
  return (
    <div
      data-slot="field-separator"
      data-content={!!children}
      className={cn(
        "relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2",
        className
      )}
      {...props}
    >
      <Separator className="absolute inset-0 top-1/2" />
      {children && (
        <span
          className="bg-background text-muted-foreground relative mx-auto block w-fit px-2"
          data-slot="field-separator-content"
        >
          {children}
        </span>
      )}
    </div>
  )
}

function FieldError({
  className,
  children,
  errors,
  ...props
}: React.ComponentProps<"div"> & {
  errors?: Array<{ message?: string } | undefined>
}) {
  const content = useMemo(() => {
    if (children) {
      return children
    }

    if (!errors) {
      return null
    }

    if (errors?.length === 1 && errors[0]?.message) {
      return errors[0].message
    }

    return (
      <ul className="ml-4 flex list-disc flex-col gap-1">
        {errors.map(
          (error, index) =>
            error?.message && <li key={index}>{error.message}</li>
        )}
      </ul>
    )
  }, [children, errors])

  if (!content) {
    return null
  }

  return (
    <div
      role="alert"
      data-slot="field-error"
      className={cn("text-destructive text-sm font-normal", className)}
      {...props}
    >
      {content}
    </div>
  )
}

export {
  Field,
  FieldLabel,
  FieldDescription,
  FieldError,
  FieldGroup,
  FieldLegend,
  FieldSeparator,
  FieldSet,
  FieldContent,
  FieldTitle,
}


===== FILE: ./client/src/components/ui/resizable.tsx =====
"use client"

import { GripVertical } from "lucide-react"
import * as ResizablePrimitive from "react-resizable-panels"

import { cn } from "@/lib/utils"

const ResizablePanelGroup = ({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (
  <ResizablePrimitive.PanelGroup
    className={cn(
      "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
      className
    )}
    {...props}
  />
)

const ResizablePanel = ResizablePrimitive.Panel

const ResizableHandle = ({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) => (
  <ResizablePrimitive.PanelResizeHandle
    className={cn(
      "relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
      className
    )}
    {...props}
  >
    {withHandle && (
      <div className="z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border">
        <GripVertical className="h-2.5 w-2.5" />
      </div>
    )}
  </ResizablePrimitive.PanelResizeHandle>
)

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }


===== FILE: ./client/src/components/ui/drawer.tsx =====
import * as React from "react"
import { Drawer as DrawerPrimitive } from "vaul"

import { cn } from "@/lib/utils"

const Drawer = ({
  shouldScaleBackground = true,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
  <DrawerPrimitive.Root
    shouldScaleBackground={shouldScaleBackground}
    {...props}
  />
)
Drawer.displayName = "Drawer"

const DrawerTrigger = DrawerPrimitive.Trigger

const DrawerPortal = DrawerPrimitive.Portal

const DrawerClose = DrawerPrimitive.Close

const DrawerOverlay = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay
    ref={ref}
    className={cn("fixed inset-0 z-50 bg-black/80", className)}
    {...props}
  />
))
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName

const DrawerContent = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className
      )}
      {...props}
    >
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
))
DrawerContent.displayName = "DrawerContent"

const DrawerHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
    {...props}
  />
)
DrawerHeader.displayName = "DrawerHeader"

const DrawerFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("mt-auto flex flex-col gap-2 p-4", className)}
    {...props}
  />
)
DrawerFooter.displayName = "DrawerFooter"

const DrawerTitle = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DrawerTitle.displayName = DrawerPrimitive.Title.displayName

const DrawerDescription = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DrawerDescription.displayName = DrawerPrimitive.Description.displayName

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}


===== FILE: ./client/src/components/ui/pagination.tsx =====
import * as React from "react"
import { ChevronLeft, ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"
import { ButtonProps, buttonVariants } from "@/components/ui/button"

const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props}
  />
)
Pagination.displayName = "Pagination"

const PaginationContent = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    className={cn("flex flex-row items-center gap-1", className)}
    {...props}
  />
))
PaginationContent.displayName = "PaginationContent"

const PaginationItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
))
PaginationItem.displayName = "PaginationItem"

type PaginationLinkProps = {
  isActive?: boolean
} & Pick<ButtonProps, "size"> &
  React.ComponentProps<"a">

const PaginationLink = ({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? "outline" : "ghost",
        size,
      }),
      className
    )}
    {...props}
  />
)
PaginationLink.displayName = "PaginationLink"

const PaginationPrevious = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to previous page"
    size="default"
    className={cn("gap-1 pl-2.5", className)}
    {...props}
  >
    <ChevronLeft className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
)
PaginationPrevious.displayName = "PaginationPrevious"

const PaginationNext = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to next page"
    size="default"
    className={cn("gap-1 pr-2.5", className)}
    {...props}
  >
    <span>Next</span>
    <ChevronRight className="h-4 w-4" />
  </PaginationLink>
)
PaginationNext.displayName = "PaginationNext"

const PaginationEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    aria-hidden
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
)
PaginationEllipsis.displayName = "PaginationEllipsis"

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
}


===== FILE: ./client/src/components/ui/alert.tsx =====
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


===== FILE: ./client/src/components/ui/toggle.tsx =====
import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }


===== FILE: ./client/src/components/ui/table.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn(
      "p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
      className
    )}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}


===== FILE: ./client/src/components/ui/calendar.tsx =====
"use client"

import * as React from "react"
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from "lucide-react"
import { DayButton, DayPicker, getDefaultClassNames } from "react-day-picker"

import { cn } from "@/lib/utils"
import { Button, buttonVariants } from "@/components/ui/button"

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = "label",
  buttonVariant = "ghost",
  formatters,
  components,
  ...props
}: React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: React.ComponentProps<typeof Button>["variant"]
}) {
  const defaultClassNames = getDefaultClassNames()

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        "bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent",
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: (date) =>
          date.toLocaleString("default", { month: "short" }),
        ...formatters,
      }}
      classNames={{
        root: cn("w-fit", defaultClassNames.root),
        months: cn(
          "relative flex flex-col gap-4 md:flex-row",
          defaultClassNames.months
        ),
        month: cn("flex w-full flex-col gap-4", defaultClassNames.month),
        nav: cn(
          "absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1",
          defaultClassNames.nav
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          "h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50",
          defaultClassNames.button_previous
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          "h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50",
          defaultClassNames.button_next
        ),
        month_caption: cn(
          "flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]",
          defaultClassNames.month_caption
        ),
        dropdowns: cn(
          "flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium",
          defaultClassNames.dropdowns
        ),
        dropdown_root: cn(
          "has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border",
          defaultClassNames.dropdown_root
        ),
        dropdown: cn(
          "bg-popover absolute inset-0 opacity-0",
          defaultClassNames.dropdown
        ),
        caption_label: cn(
          "select-none font-medium",
          captionLayout === "label"
            ? "text-sm"
            : "[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5",
          defaultClassNames.caption_label
        ),
        table: "w-full border-collapse",
        weekdays: cn("flex", defaultClassNames.weekdays),
        weekday: cn(
          "text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal",
          defaultClassNames.weekday
        ),
        week: cn("mt-2 flex w-full", defaultClassNames.week),
        week_number_header: cn(
          "w-[--cell-size] select-none",
          defaultClassNames.week_number_header
        ),
        week_number: cn(
          "text-muted-foreground select-none text-[0.8rem]",
          defaultClassNames.week_number
        ),
        day: cn(
          "group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md",
          defaultClassNames.day
        ),
        range_start: cn(
          "bg-accent rounded-l-md",
          defaultClassNames.range_start
        ),
        range_middle: cn("rounded-none", defaultClassNames.range_middle),
        range_end: cn("bg-accent rounded-r-md", defaultClassNames.range_end),
        today: cn(
          "bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none",
          defaultClassNames.today
        ),
        outside: cn(
          "text-muted-foreground aria-selected:text-muted-foreground",
          defaultClassNames.outside
        ),
        disabled: cn(
          "text-muted-foreground opacity-50",
          defaultClassNames.disabled
        ),
        hidden: cn("invisible", defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        Root: ({ className, rootRef, ...props }) => {
          return (
            <div
              data-slot="calendar"
              ref={rootRef}
              className={cn(className)}
              {...props}
            />
          )
        },
        Chevron: ({ className, orientation, ...props }) => {
          if (orientation === "left") {
            return (
              <ChevronLeftIcon className={cn("size-4", className)} {...props} />
            )
          }

          if (orientation === "right") {
            return (
              <ChevronRightIcon
                className={cn("size-4", className)}
                {...props}
              />
            )
          }

          return (
            <ChevronDownIcon className={cn("size-4", className)} {...props} />
          )
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }) => {
          return (
            <td {...props}>
              <div className="flex size-[--cell-size] items-center justify-center text-center">
                {children}
              </div>
            </td>
          )
        },
        ...components,
      }}
      {...props}
    />
  )
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: React.ComponentProps<typeof DayButton>) {
  const defaultClassNames = getDefaultClassNames()

  const ref = React.useRef<HTMLButtonElement>(null)
  React.useEffect(() => {
    if (modifiers.focused) ref.current?.focus()
  }, [modifiers.focused])

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        "data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70",
        defaultClassNames.day,
        className
      )}
      {...props}
    />
  )
}

export { Calendar, CalendarDayButton }


===== FILE: ./client/src/components/ui/input.tsx =====
import * as React from "react"

import { cn } from "@/lib/utils"

const Input = React.forwardRef<HTMLInputElement, React.ComponentProps<"input">>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }


===== FILE: ./client/src/components/ui/sonner.tsx =====
"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner } from "sonner"

type ToasterProps = React.ComponentProps<typeof Sonner>

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton:
            "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton:
            "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  )
}

export { Toaster }


===== FILE: ./client/src/components/ui/switch.tsx =====
import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


===== FILE: ./client/src/components/ui/toaster.tsx =====
import { useToast } from "@/hooks/use-toast"
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from "@/components/ui/toast"

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}


===== FILE: ./client/src/components/ui/select.tsx =====
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown, ChevronUp } from "lucide-react"

import { cn } from "@/lib/utils"

const Select = SelectPrimitive.Root

const SelectGroup = SelectPrimitive.Group

const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectScrollUpButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollUpButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronUp className="h-4 w-4" />
  </SelectPrimitive.ScrollUpButton>
))
SelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName

const SelectScrollDownButton = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.ScrollDownButton
    ref={ref}
    className={cn(
      "flex cursor-default items-center justify-center py-1",
      className
    )}
    {...props}
  >
    <ChevronDown className="h-4 w-4" />
  </SelectPrimitive.ScrollDownButton>
))
SelectScrollDownButton.displayName =
  SelectPrimitive.ScrollDownButton.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectScrollUpButton />
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
      <SelectScrollDownButton />
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
  SelectScrollUpButton,
  SelectScrollDownButton,
}


===== FILE: ./client/src/components/ui/context-menu.tsx =====
import * as React from "react"
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

const ContextMenu = ContextMenuPrimitive.Root

const ContextMenuTrigger = ContextMenuPrimitive.Trigger

const ContextMenuGroup = ContextMenuPrimitive.Group

const ContextMenuPortal = ContextMenuPrimitive.Portal

const ContextMenuSub = ContextMenuPrimitive.Sub

const ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup

const ContextMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <ContextMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </ContextMenuPrimitive.SubTrigger>
))
ContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName

const ContextMenuSubContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]",
      className
    )}
    {...props}
  />
))
ContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName

const ContextMenuContent = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Portal>
    <ContextMenuPrimitive.Content
      ref={ref}
      className={cn(
        "z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]",
        className
      )}
      {...props}
    />
  </ContextMenuPrimitive.Portal>
))
ContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName

const ContextMenuItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName

const ContextMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <ContextMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.CheckboxItem>
))
ContextMenuCheckboxItem.displayName =
  ContextMenuPrimitive.CheckboxItem.displayName

const ContextMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <ContextMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <ContextMenuPrimitive.ItemIndicator>
        <Circle className="h-4 w-4 fill-current" />
      </ContextMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </ContextMenuPrimitive.RadioItem>
))
ContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName

const ContextMenuLabel = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <ContextMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold text-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
ContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName

const ContextMenuSeparator = React.forwardRef<
  React.ElementRef<typeof ContextMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <ContextMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-border", className)}
    {...props}
  />
))
ContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName

const ContextMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
ContextMenuShortcut.displayName = "ContextMenuShortcut"

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
}


===== FILE: ./client/src/components/ui/item.tsx =====
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Separator } from "@/components/ui/separator"

function ItemGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      role="list"
      data-slot="item-group"
      className={cn("group/item-group flex flex-col", className)}
      {...props}
    />
  )
}

function ItemSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="item-separator"
      orientation="horizontal"
      className={cn("my-0", className)}
      {...props}
    />
  )
}

const itemVariants = cva(
  "group/item [a]:hover:bg-accent/50 focus-visible:border-ring focus-visible:ring-ring/50 [a]:transition-colors flex flex-wrap items-center rounded-md border border-transparent text-sm outline-none transition-colors duration-100 focus-visible:ring-[3px]",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline: "border-border",
        muted: "bg-muted/50",
      },
      size: {
        default: "gap-4 p-4 ",
        sm: "gap-2.5 px-4 py-3",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Item({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"div"> &
  VariantProps<typeof itemVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div"
  return (
    <Comp
      data-slot="item"
      data-variant={variant}
      data-size={size}
      className={cn(itemVariants({ variant, size, className }))}
      {...props}
    />
  )
}

const itemMediaVariants = cva(
  "flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:translate-y-0.5 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        icon: "bg-muted size-8 rounded-sm border [&_svg:not([class*='size-'])]:size-4",
        image:
          "size-10 overflow-hidden rounded-sm [&_img]:size-full [&_img]:object-cover",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function ItemMedia({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof itemMediaVariants>) {
  return (
    <div
      data-slot="item-media"
      data-variant={variant}
      className={cn(itemMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function ItemContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-content"
      className={cn(
        "flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none",
        className
      )}
      {...props}
    />
  )
}

function ItemTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-title"
      className={cn(
        "flex w-fit items-center gap-2 text-sm font-medium leading-snug",
        className
      )}
      {...props}
    />
  )
}

function ItemDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="item-description"
      className={cn(
        "text-muted-foreground line-clamp-2 text-balance text-sm font-normal leading-normal",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  )
}

function ItemActions({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-actions"
      className={cn("flex items-center gap-2", className)}
      {...props}
    />
  )
}

function ItemHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-header"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  )
}

function ItemFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-footer"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  )
}

export {
  Item,
  ItemMedia,
  ItemContent,
  ItemActions,
  ItemGroup,
  ItemSeparator,
  ItemTitle,
  ItemDescription,
  ItemHeader,
  ItemFooter,
}


===== FILE: ./client/src/components/ui/dialog.tsx =====
import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Dialog = DialogPrimitive.Root

const DialogTrigger = DialogPrimitive.Trigger

const DialogPortal = DialogPrimitive.Portal

const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogPortal,
  DialogOverlay,
  DialogTrigger,
  DialogClose,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
}


===== FILE: ./client/src/components/ui/menubar.tsx =====
import * as React from "react"
import * as MenubarPrimitive from "@radix-ui/react-menubar"
import { Check, ChevronRight, Circle } from "lucide-react"

import { cn } from "@/lib/utils"

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu {...props} />
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group {...props} />
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal {...props} />
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return <MenubarPrimitive.RadioGroup {...props} />
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />
}

const Menubar = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Root
    ref={ref}
    className={cn(
      "flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm",
      className
    )}
    {...props}
  />
))
Menubar.displayName = MenubarPrimitive.Root.displayName

const MenubarTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      className
    )}
    {...props}
  />
))
MenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName

const MenubarSubTrigger = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <MenubarPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </MenubarPrimitive.SubTrigger>
))
MenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName

const MenubarSubContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]",
      className
    )}
    {...props}
  />
))
MenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName

const MenubarContent = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>
>(
  (
    { className, align = "start", alignOffset = -4, sideOffset = 8, ...props },
    ref
  ) => (
    <MenubarPrimitive.Portal>
      <MenubarPrimitive.Content
        ref={ref}
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]",
          className
        )}
        {...props}
      />
    </MenubarPrimitive.Portal>
  )
)
MenubarContent.displayName = MenubarPrimitive.Content.displayName

const MenubarItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarItem.displayName = MenubarPrimitive.Item.displayName

const MenubarCheckboxItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <MenubarPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.CheckboxItem>
))
MenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName

const MenubarRadioItem = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <MenubarPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <MenubarPrimitive.ItemIndicator>
        <Circle className="h-4 w-4 fill-current" />
      </MenubarPrimitive.ItemIndicator>
    </span>
    {children}
  </MenubarPrimitive.RadioItem>
))
MenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName

const MenubarLabel = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <MenubarPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
MenubarLabel.displayName = MenubarPrimitive.Label.displayName

const MenubarSeparator = React.forwardRef<
  React.ElementRef<typeof MenubarPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <MenubarPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
MenubarSeparator.displayName = MenubarPrimitive.Separator.displayName

const MenubarShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn(
        "ml-auto text-xs tracking-widest text-muted-foreground",
        className
      )}
      {...props}
    />
  )
}
MenubarShortcut.displayname = "MenubarShortcut"

export {
  Menubar,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarItem,
  MenubarSeparator,
  MenubarLabel,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarPortal,
  MenubarSubContent,
  MenubarSubTrigger,
  MenubarGroup,
  MenubarSub,
  MenubarShortcut,
}


===== FILE: ./client/src/components/ui/label.tsx =====
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }


===== FILE: ./client/src/components/ui/popover.tsx =====
import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverAnchor = PopoverPrimitive.Anchor

const PopoverContent = React.forwardRef<
  React.ElementRef<typeof PopoverPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
  <PopoverPrimitive.Portal>
    <PopoverPrimitive.Content
      ref={ref}
      align={align}
      sideOffset={sideOffset}
      className={cn(
        "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",
        className
      )}
      {...props}
    />
  </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }


===== FILE: ./client/src/components/ui/carousel.tsx =====
import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

const Carousel = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & CarouselProps
>(
  (
    {
      orientation = "horizontal",
      opts,
      setApi,
      plugins,
      className,
      children,
      ...props
    },
    ref
  ) => {
    const [carouselRef, api] = useEmblaCarousel(
      {
        ...opts,
        axis: orientation === "horizontal" ? "x" : "y",
      },
      plugins
    )
    const [canScrollPrev, setCanScrollPrev] = React.useState(false)
    const [canScrollNext, setCanScrollNext] = React.useState(false)

    const onSelect = React.useCallback((api: CarouselApi) => {
      if (!api) {
        return
      }

      setCanScrollPrev(api.canScrollPrev())
      setCanScrollNext(api.canScrollNext())
    }, [])

    const scrollPrev = React.useCallback(() => {
      api?.scrollPrev()
    }, [api])

    const scrollNext = React.useCallback(() => {
      api?.scrollNext()
    }, [api])

    const handleKeyDown = React.useCallback(
      (event: React.KeyboardEvent<HTMLDivElement>) => {
        if (event.key === "ArrowLeft") {
          event.preventDefault()
          scrollPrev()
        } else if (event.key === "ArrowRight") {
          event.preventDefault()
          scrollNext()
        }
      },
      [scrollPrev, scrollNext]
    )

    React.useEffect(() => {
      if (!api || !setApi) {
        return
      }

      setApi(api)
    }, [api, setApi])

    React.useEffect(() => {
      if (!api) {
        return
      }

      onSelect(api)
      api.on("reInit", onSelect)
      api.on("select", onSelect)

      return () => {
        api?.off("select", onSelect)
      }
    }, [api, onSelect])

    return (
      <CarouselContext.Provider
        value={{
          carouselRef,
          api: api,
          opts,
          orientation:
            orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
          scrollPrev,
          scrollNext,
          canScrollPrev,
          canScrollNext,
        }}
      >
        <div
          ref={ref}
          onKeyDownCapture={handleKeyDown}
          className={cn("relative", className)}
          role="region"
          aria-roledescription="carousel"
          {...props}
        >
          {children}
        </div>
      </CarouselContext.Provider>
    )
  }
)
Carousel.displayName = "Carousel"

const CarouselContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div ref={carouselRef} className="overflow-hidden">
      <div
        ref={ref}
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
})
CarouselContent.displayName = "CarouselContent"

const CarouselItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const { orientation } = useCarousel()

  return (
    <div
      ref={ref}
      role="group"
      aria-roledescription="slide"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
})
CarouselItem.displayName = "CarouselItem"

const CarouselPrevious = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute  h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-left-12 top-1/2 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft className="h-4 w-4" />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
})
CarouselPrevious.displayName = "CarouselPrevious"

const CarouselNext = React.forwardRef<
  HTMLButtonElement,
  React.ComponentProps<typeof Button>
>(({ className, variant = "outline", size = "icon", ...props }, ref) => {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      ref={ref}
      variant={variant}
      size={size}
      className={cn(
        "absolute h-8 w-8 rounded-full",
        orientation === "horizontal"
          ? "-right-12 top-1/2 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight className="h-4 w-4" />
      <span className="sr-only">Next slide</span>
    </Button>
  )
})
CarouselNext.displayName = "CarouselNext"

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}


===== FILE: ./client/src/components/ui/navigation-menu.tsx =====
import * as React from "react"
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu"
import { cva } from "class-variance-authority"
import { ChevronDown } from "lucide-react"

import { cn } from "@/lib/utils"

const NavigationMenu = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Root
    ref={ref}
    className={cn(
      "relative z-10 flex max-w-max flex-1 items-center justify-center",
      className
    )}
    {...props}
  >
    {children}
    <NavigationMenuViewport />
  </NavigationMenuPrimitive.Root>
))
NavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName

const NavigationMenuList = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.List
    ref={ref}
    className={cn(
      "group flex flex-1 list-none items-center justify-center space-x-1",
      className
    )}
    {...props}
  />
))
NavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName

const NavigationMenuItem = NavigationMenuPrimitive.Item

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent"
)

const NavigationMenuTrigger = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <NavigationMenuPrimitive.Trigger
    ref={ref}
    className={cn(navigationMenuTriggerStyle(), "group", className)}
    {...props}
  >
    {children}{" "}
    <ChevronDown
      className="relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180"
      aria-hidden="true"
    />
  </NavigationMenuPrimitive.Trigger>
))
NavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName

const NavigationMenuContent = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Content
    ref={ref}
    className={cn(
      "left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto ",
      className
    )}
    {...props}
  />
))
NavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName

const NavigationMenuLink = NavigationMenuPrimitive.Link

const NavigationMenuViewport = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>
>(({ className, ...props }, ref) => (
  <div className={cn("absolute left-0 top-full flex justify-center")}>
    <NavigationMenuPrimitive.Viewport
      className={cn(
        "origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]",
        className
      )}
      ref={ref}
      {...props}
    />
  </div>
))
NavigationMenuViewport.displayName =
  NavigationMenuPrimitive.Viewport.displayName

const NavigationMenuIndicator = React.forwardRef<
  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,
  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>
>(({ className, ...props }, ref) => (
  <NavigationMenuPrimitive.Indicator
    ref={ref}
    className={cn(
      "top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in",
      className
    )}
    {...props}
  >
    <div className="relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md" />
  </NavigationMenuPrimitive.Indicator>
))
NavigationMenuIndicator.displayName =
  NavigationMenuPrimitive.Indicator.displayName

export {
  navigationMenuTriggerStyle,
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
}


===== FILE: ./client/src/components/ui/breadcrumb.tsx =====
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

const Breadcrumb = React.forwardRef<
  HTMLElement,
  React.ComponentPropsWithoutRef<"nav"> & {
    separator?: React.ReactNode
  }
>(({ ...props }, ref) => <nav ref={ref} aria-label="breadcrumb" {...props} />)
Breadcrumb.displayName = "Breadcrumb"

const BreadcrumbList = React.forwardRef<
  HTMLOListElement,
  React.ComponentPropsWithoutRef<"ol">
>(({ className, ...props }, ref) => (
  <ol
    ref={ref}
    className={cn(
      "flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",
      className
    )}
    {...props}
  />
))
BreadcrumbList.displayName = "BreadcrumbList"

const BreadcrumbItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentPropsWithoutRef<"li">
>(({ className, ...props }, ref) => (
  <li
    ref={ref}
    className={cn("inline-flex items-center gap-1.5", className)}
    {...props}
  />
))
BreadcrumbItem.displayName = "BreadcrumbItem"

const BreadcrumbLink = React.forwardRef<
  HTMLAnchorElement,
  React.ComponentPropsWithoutRef<"a"> & {
    asChild?: boolean
  }
>(({ asChild, className, ...props }, ref) => {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      ref={ref}
      className={cn("transition-colors hover:text-foreground", className)}
      {...props}
    />
  )
})
BreadcrumbLink.displayName = "BreadcrumbLink"

const BreadcrumbPage = React.forwardRef<
  HTMLSpanElement,
  React.ComponentPropsWithoutRef<"span">
>(({ className, ...props }, ref) => (
  <span
    ref={ref}
    role="link"
    aria-disabled="true"
    aria-current="page"
    className={cn("font-normal text-foreground", className)}
    {...props}
  />
))
BreadcrumbPage.displayName = "BreadcrumbPage"

const BreadcrumbSeparator = ({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) => (
  <li
    role="presentation"
    aria-hidden="true"
    className={cn("[&>svg]:w-3.5 [&>svg]:h-3.5", className)}
    {...props}
  >
    {children ?? <ChevronRight />}
  </li>
)
BreadcrumbSeparator.displayName = "BreadcrumbSeparator"

const BreadcrumbEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    role="presentation"
    aria-hidden="true"
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <MoreHorizontal className="h-4 w-4" />
    <span className="sr-only">More</span>
  </span>
)
BreadcrumbEllipsis.displayName = "BreadcrumbElipssis"

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}


===== FILE: ./client/src/components/ui/aspect-ratio.tsx =====
import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio"

const AspectRatio = AspectRatioPrimitive.Root

export { AspectRatio }


===== FILE: ./client/src/components/ui/spinner.tsx =====
import { Loader2Icon } from "lucide-react"

import { cn } from "@/lib/utils"

function Spinner({ className, ...props }: React.ComponentProps<"svg">) {
  return (
    <Loader2Icon
      role="status"
      aria-label="Loading"
      className={cn("size-4 animate-spin", className)}
      {...props}
    />
  )
}

export { Spinner }


===== FILE: ./client/src/components/ui/button-group.tsx =====
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Separator } from "@/components/ui/separator"

const buttonGroupVariants = cva(
  "flex w-fit items-stretch has-[>[data-slot=button-group]]:gap-2 [&>*]:focus-visible:relative [&>*]:focus-visible:z-10 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1",
  {
    variants: {
      orientation: {
        horizontal:
          "[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none",
        vertical:
          "flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none",
      },
    },
    defaultVariants: {
      orientation: "horizontal",
    },
  }
)

function ButtonGroup({
  className,
  orientation,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof buttonGroupVariants>) {
  return (
    <div
      role="group"
      data-slot="button-group"
      data-orientation={orientation}
      className={cn(buttonGroupVariants({ orientation }), className)}
      {...props}
    />
  )
}

function ButtonGroupText({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"div"> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : "div"

  return (
    <Comp
      className={cn(
        "bg-muted shadow-xs flex items-center gap-2 rounded-md border px-4 text-sm font-medium [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none",
        className
      )}
      {...props}
    />
  )
}

function ButtonGroupSeparator({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="button-group-separator"
      orientation={orientation}
      className={cn(
        "bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto",
        className
      )}
      {...props}
    />
  )
}

export {
  ButtonGroup,
  ButtonGroupSeparator,
  ButtonGroupText,
  buttonGroupVariants,
}


===== FILE: ./client/src/components/ui/avatar.tsx =====
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }


===== FILE: ./client/src/components/ui/input-group.tsx =====
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"

function InputGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="input-group"
      role="group"
      className={cn(
        "group/input-group border-input dark:bg-input/30 shadow-xs relative flex w-full items-center rounded-md border outline-none transition-[color,box-shadow]",
        "h-9 has-[>textarea]:h-auto",

        // Variants based on alignment.
        "has-[>[data-align=inline-start]]:[&>input]:pl-2",
        "has-[>[data-align=inline-end]]:[&>input]:pr-2",
        "has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3",
        "has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3",

        // Focus state.
        "has-[[data-slot=input-group-control]:focus-visible]:ring-ring has-[[data-slot=input-group-control]:focus-visible]:ring-1",

        // Error state.
        "has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40",

        className
      )}
      {...props}
    />
  )
}

const inputGroupAddonVariants = cva(
  "text-muted-foreground flex h-auto cursor-text select-none items-center justify-center gap-2 py-1.5 text-sm font-medium group-data-[disabled=true]/input-group:opacity-50 [&>kbd]:rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-4",
  {
    variants: {
      align: {
        "inline-start":
          "order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]",
        "inline-end":
          "order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]",
        "block-start":
          "[.border-b]:pb-3 order-first w-full justify-start px-3 pt-3 group-has-[>input]/input-group:pt-2.5",
        "block-end":
          "[.border-t]:pt-3 order-last w-full justify-start px-3 pb-3 group-has-[>input]/input-group:pb-2.5",
      },
    },
    defaultVariants: {
      align: "inline-start",
    },
  }
)

function InputGroupAddon({
  className,
  align = "inline-start",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof inputGroupAddonVariants>) {
  return (
    <div
      role="group"
      data-slot="input-group-addon"
      data-align={align}
      className={cn(inputGroupAddonVariants({ align }), className)}
      onClick={(e) => {
        if ((e.target as HTMLElement).closest("button")) {
          return
        }
        e.currentTarget.parentElement?.querySelector("input")?.focus()
      }}
      {...props}
    />
  )
}

const inputGroupButtonVariants = cva(
  "flex items-center gap-2 text-sm shadow-none",
  {
    variants: {
      size: {
        xs: "h-6 gap-1 rounded-[calc(var(--radius)-5px)] px-2 has-[>svg]:px-2 [&>svg:not([class*='size-'])]:size-3.5",
        sm: "h-8 gap-1.5 rounded-md px-2.5 has-[>svg]:px-2.5",
        "icon-xs":
          "size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0",
        "icon-sm": "size-8 p-0 has-[>svg]:p-0",
      },
    },
    defaultVariants: {
      size: "xs",
    },
  }
)

function InputGroupButton({
  className,
  type = "button",
  variant = "ghost",
  size = "xs",
  ...props
}: Omit<React.ComponentProps<typeof Button>, "size"> &
  VariantProps<typeof inputGroupButtonVariants>) {
  return (
    <Button
      type={type}
      data-size={size}
      variant={variant}
      className={cn(inputGroupButtonVariants({ size }), className)}
      {...props}
    />
  )
}

function InputGroupText({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      className={cn(
        "text-muted-foreground flex items-center gap-2 text-sm [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none",
        className
      )}
      {...props}
    />
  )
}

function InputGroupInput({
  className,
  ...props
}: React.ComponentProps<"input">) {
  return (
    <Input
      data-slot="input-group-control"
      className={cn(
        "flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent",
        className
      )}
      {...props}
    />
  )
}

function InputGroupTextarea({
  className,
  ...props
}: React.ComponentProps<"textarea">) {
  return (
    <Textarea
      data-slot="input-group-control"
      className={cn(
        "flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent",
        className
      )}
      {...props}
    />
  )
}

export {
  InputGroup,
  InputGroupAddon,
  InputGroupButton,
  InputGroupText,
  InputGroupInput,
  InputGroupTextarea,
}


===== FILE: ./client/src/components/ui/empty.tsx =====
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

function Empty({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty"
      className={cn(
        "flex min-w-0 flex-1 flex-col items-center justify-center gap-6 text-balance rounded-lg border-dashed p-6 text-center md:p-12",
        className
      )}
      {...props}
    />
  )
}

function EmptyHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty-header"
      className={cn(
        "flex max-w-sm flex-col items-center gap-2 text-center",
        className
      )}
      {...props}
    />
  )
}

const emptyMediaVariants = cva(
  "mb-2 flex shrink-0 items-center justify-center [&_svg]:pointer-events-none [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        icon: "bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function EmptyMedia({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof emptyMediaVariants>) {
  return (
    <div
      data-slot="empty-icon"
      data-variant={variant}
      className={cn(emptyMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function EmptyTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty-title"
      className={cn("text-lg font-medium tracking-tight", className)}
      {...props}
    />
  )
}

function EmptyDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <div
      data-slot="empty-description"
      className={cn(
        "text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  )
}

function EmptyContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="empty-content"
      className={cn(
        "flex w-full min-w-0 max-w-sm flex-col items-center gap-4 text-balance text-sm",
        className
      )}
      {...props}
    />
  )
}

export {
  Empty,
  EmptyHeader,
  EmptyTitle,
  EmptyDescription,
  EmptyContent,
  EmptyMedia,
}


===== FILE: ./client/src/components/ui/toggle-group.tsx =====
"use client"

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }


===== FILE: ./client/src/components/ui/checkbox.tsx =====
import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("grid place-content-center text-current")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }


===== FILE: ./client/src/components/ui/sheet.tsx =====
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { X } from "lucide-react"

import { cn } from "@/lib/utils"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <X className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
      {children}
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}


===== FILE: ./client/src/components/ui/progress.tsx =====
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-2 w-full overflow-hidden rounded-full bg-primary/20",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }


===== FILE: ./client/src/components/ui/kbd.tsx =====
import { cn } from "@/lib/utils"

function Kbd({ className, ...props }: React.ComponentProps<"kbd">) {
  return (
    <kbd
      data-slot="kbd"
      className={cn(
        "bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 select-none items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium",
        "[&_svg:not([class*='size-'])]:size-3",
        "[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10",
        className
      )}
      {...props}
    />
  )
}

function KbdGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <kbd
      data-slot="kbd-group"
      className={cn("inline-flex items-center gap-1", className)}
      {...props}
    />
  )
}

export { Kbd, KbdGroup }


===== FILE: ./client/src/components/ui/badge.tsx =====
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  // @replit
  // Whitespace-nowrap: Badges should never wrap.
  "whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2" +
  " hover-elevate ",
  {
    variants: {
      variant: {
        default:
          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate
          "border-transparent bg-primary text-primary-foreground shadow-xs",
        secondary:
          // @replit no hover because we use hover-elevate
          "border-transparent bg-secondary text-secondary-foreground",
        destructive:
          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate
          "border-transparent bg-destructive text-destructive-foreground shadow-xs",
          // @replit shadow-xs" - use badge outline variable
        outline: "text-foreground border [border-color:var(--badge-outline)]",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }


===== FILE: ./.local/state/replit/agent/filesystem/filesystem_state.json =====
{"file_contents":{"client/src/components/ui/dropdown-menu.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7606,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-xl border bg-card text-card-foreground shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"font-semibold leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1828,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1598,"size_tokens":null},"server/services/telegram.ts":{"content":"import TelegramBot from \"node-telegram-bot-api\";\nimport { storage } from \"../storage\";\nimport type { TelegramChat } from \"@shared/schema\";\nimport { environment } from \"./environment\";\n\ninterface TelegramConfig {\n  token: string;\n  chatId: string;\n}\n\ntype AlertType = \"trades\" | \"errors\" | \"system\" | \"balance\" | \"status\";\n\ntype EngineController = {\n  start: () => Promise<void>;\n  stop: () => Promise<void>;\n  isActive: () => boolean;\n  getBalance?: () => Promise<Record<string, string>>;\n  getOpenPositions?: () => Map<string, { amount: number; entryPrice: number }>;\n};\n\nexport class TelegramService {\n  private bot: TelegramBot | null = null;\n  private chatId: string = \"\";\n  private engineController: EngineController | null = null;\n  private startTime: Date = new Date();\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n\n  setEngineController(controller: EngineController) {\n    this.engineController = controller;\n  }\n\n  initialize(config: TelegramConfig) {\n    if (this.bot) {\n      try {\n        this.bot.stopPolling();\n        this.bot.removeAllListeners();\n      } catch (e) {}\n    }\n    \n    // Activar polling solo en Docker (NAS) - detectamos por variable de entorno\n    const isDocker = process.env.DOCKER_ENV === 'true' || process.env.NODE_ENV === 'production';\n    const enablePolling = isDocker;\n    \n    console.log(`[telegram] Inicializando bot - Polling: ${enablePolling ? 'ACTIVADO (Docker/NAS)' : 'DESACTIVADO (Replit)'}`);\n    \n    this.bot = new TelegramBot(config.token, { polling: enablePolling });\n    this.chatId = config.chatId;\n    this.setupCommands();\n  }\n\n  private setupCommands() {\n    if (!this.bot) return;\n\n    this.bot.onText(/\\/estado/, async (msg) => {\n      await this.handleEstado(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/pausar/, async (msg) => {\n      await this.handlePausar(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/reanudar/, async (msg) => {\n      await this.handleReanudar(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/ultimas/, async (msg) => {\n      await this.handleUltimas(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/ayuda/, async (msg) => {\n      await this.handleAyuda(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/balance/, async (msg) => {\n      await this.handleBalance(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/config/, async (msg) => {\n      await this.handleConfig(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/exposicion/, async (msg) => {\n      await this.handleExposicion(msg.chat.id);\n    });\n\n    this.bot.onText(/\\/uptime/, async (msg) => {\n      await this.handleUptime(msg.chat.id);\n    });\n\n    this.bot.on(\"polling_error\", (error) => {\n      console.error(\"Telegram polling error:\", error.message);\n    });\n  }\n\n  private async handleEstado(chatId: number) {\n    try {\n      const config = await storage.getBotConfig();\n      \n      const engineActive = this.engineController?.isActive() ?? false;\n      const configActive = config?.isActive ?? false;\n      const status = engineActive ? \"‚úÖ ACTIVO (motor funcionando)\" : \n                     configActive ? \"‚ö†Ô∏è ACTIVADO (motor detenido)\" : \"‚è∏Ô∏è PAUSADO\";\n      const strategy = config?.strategy || \"momentum\";\n      const riskLevel = config?.riskLevel || \"medium\";\n      const pairs = config?.activePairs?.join(\", \") || \"BTC/USD, ETH/USD, SOL/USD\";\n\n      const chats = await storage.getActiveTelegramChats();\n      const chatsInfo = chats.length > 0 \n        ? `${chats.length} chat(s) configurados` \n        : \"Sin chats adicionales\";\n\n      const message = `\nüìä *Estado del Bot*\n\n*Estado:* ${status}\n*Estrategia:* ${strategy}\n*Nivel de riesgo:* ${riskLevel}\n*Pares activos:* ${pairs}\n*Chats Telegram:* ${chatsInfo}\n\n_Usa /ayuda para ver los comandos disponibles_\n      `.trim();\n\n      await this.bot?.sendMessage(chatId, message, { parse_mode: \"Markdown\" });\n    } catch (error: any) {\n      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo estado: ${error.message}`);\n    }\n  }\n\n  private async handlePausar(chatId: number) {\n    try {\n      await storage.updateBotConfig({ isActive: false });\n      \n      if (this.engineController) {\n        await this.engineController.stop();\n      }\n      \n      await this.bot?.sendMessage(chatId, \"‚è∏Ô∏è *Bot pausado correctamente*\\n\\nEl motor de trading se ha detenido.\\nUsa /reanudar para volver a activarlo.\", { parse_mode: \"Markdown\" });\n    } catch (error: any) {\n      await this.bot?.sendMessage(chatId, `‚ùå Error pausando bot: ${error.message}`);\n    }\n  }\n\n  private async handleReanudar(chatId: number) {\n    try {\n      await storage.updateBotConfig({ isActive: true });\n      \n      if (this.engineController) {\n        await this.engineController.start();\n      }\n      \n      await this.bot?.sendMessage(chatId, \"‚úÖ *Bot activado correctamente*\\n\\nEl motor de trading ha comenzado a analizar el mercado.\", { parse_mode: \"Markdown\" });\n    } catch (error: any) {\n      await this.bot?.sendMessage(chatId, `‚ùå Error activando bot: ${error.message}`);\n    }\n  }\n\n  private async handleUltimas(chatId: number) {\n    try {\n      const trades = await storage.getTrades(5);\n      \n      if (trades.length === 0) {\n        await this.bot?.sendMessage(chatId, \"üì≠ No hay operaciones recientes.\");\n        return;\n      }\n\n      let message = \"üìà *√öltimas operaciones:*\\n\\n\";\n      \n      for (const trade of trades) {\n        const emoji = trade.type === \"buy\" ? \"üü¢\" : \"üî¥\";\n        const tipo = trade.type === \"buy\" ? \"Compra\" : \"Venta\";\n        const fecha = trade.executedAt ? new Date(trade.executedAt).toLocaleDateString(\"es-ES\") : \"Pendiente\";\n        \n        message += `${emoji} *${tipo}* ${trade.pair}\\n`;\n        message += `   Precio: $${parseFloat(trade.price).toFixed(2)}\\n`;\n        message += `   Cantidad: ${trade.amount}\\n`;\n        message += `   Fecha: ${fecha}\\n\\n`;\n      }\n\n      await this.bot?.sendMessage(chatId, message.trim(), { parse_mode: \"Markdown\" });\n    } catch (error: any) {\n      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo operaciones: ${error.message}`);\n    }\n  }\n\n  private async handleAyuda(chatId: number) {\n    const message = `\nü§ñ *Comandos disponibles:*\n\n/estado - Ver estado del bot\n/balance - Ver balance actual\n/config - Ver configuraci√≥n de riesgo\n/exposicion - Ver exposici√≥n por par\n/uptime - Ver tiempo encendido\n/pausar - Pausar el bot\n/reanudar - Activar el bot\n/ultimas - Ver √∫ltimas operaciones\n/ayuda - Ver esta ayuda\n\n_KrakenBot.AI - Trading Aut√≥nomo_\n    `.trim();\n\n    await this.bot?.sendMessage(chatId, message, { parse_mode: \"Markdown\" });\n  }\n\n  private async handleBalance(chatId: number) {\n    try {\n      if (!this.engineController?.getBalance) {\n        await this.bot?.sendMessage(chatId, \"‚ö†Ô∏è Kraken no est√° conectado. Configura las credenciales primero.\");\n        return;\n      }\n      const balances = await this.engineController.getBalance();\n      const usd = parseFloat(balances?.ZUSD || balances?.USD || \"0\");\n      const btc = parseFloat(balances?.XXBT || balances?.XBT || \"0\");\n      const eth = parseFloat(balances?.XETH || balances?.ETH || \"0\");\n      const sol = parseFloat(balances?.SOL || \"0\");\n\n      const message = `\nüí∞ *Balance Actual*\n\n*USD:* $${usd.toFixed(2)}\n*BTC:* ${btc.toFixed(6)}\n*ETH:* ${eth.toFixed(6)}\n*SOL:* ${sol.toFixed(4)}\n\n_Actualizado: ${new Date().toLocaleString(\"es-ES\")}_\n      `.trim();\n\n      await this.bot?.sendMessage(chatId, message, { parse_mode: \"Markdown\" });\n    } catch (error: any) {\n      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo balance: ${error.message}`);\n    }\n  }\n\n  private async handleConfig(chatId: number) {\n    try {\n      const config = await storage.getBotConfig();\n      const sl = parseFloat(config?.stopLossPercent?.toString() || \"5\");\n      const tp = parseFloat(config?.takeProfitPercent?.toString() || \"7\");\n      const trailing = config?.trailingStopEnabled ? `${config.trailingStopPercent}%` : \"Desactivado\";\n      const pairExp = parseFloat(config?.maxPairExposurePct?.toString() || \"25\");\n      const totalExp = parseFloat(config?.maxTotalExposurePct?.toString() || \"60\");\n      const riskTrade = parseFloat(config?.riskPerTradePct?.toString() || \"15\");\n\n      const message = `\n‚öôÔ∏è *Configuraci√≥n de Riesgo*\n\nüõë *Stop-Loss:* ${sl}%\nüéØ *Take-Profit:* ${tp}%\nüìâ *Trailing Stop:* ${trailing}\nüíµ *Riesgo por trade:* ${riskTrade}%\nüî∏ *Exp. por par:* ${pairExp}%\nüîπ *Exp. total:* ${totalExp}%\n\n_Estrategia: ${config?.strategy || \"momentum\"}_\n      `.trim();\n\n      await this.bot?.sendMessage(chatId, message, { parse_mode: \"Markdown\" });\n    } catch (error: any) {\n      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo configuraci√≥n: ${error.message}`);\n    }\n  }\n\n  private async handleExposicion(chatId: number) {\n    try {\n      const positions = this.engineController?.getOpenPositions?.() || new Map();\n      \n      if (positions.size === 0) {\n        await this.bot?.sendMessage(chatId, \"üìä *Sin posiciones abiertas*\\n\\nNo hay exposici√≥n actual.\", { parse_mode: \"Markdown\" });\n        return;\n      }\n\n      let message = \"üìä *Exposici√≥n Actual*\\n\\n\";\n      let totalExp = 0;\n\n      positions.forEach((pos, pair) => {\n        const exposure = pos.amount * pos.entryPrice;\n        totalExp += exposure;\n        const pnl = \"N/A\";\n        message += `*${pair}:* $${exposure.toFixed(2)}\\n`;\n        message += `   Entrada: $${pos.entryPrice.toFixed(2)}\\n`;\n        message += `   Cantidad: ${pos.amount.toFixed(6)}\\n\\n`;\n      });\n\n      message += `*Total expuesto:* $${totalExp.toFixed(2)}`;\n\n      await this.bot?.sendMessage(chatId, message.trim(), { parse_mode: \"Markdown\" });\n    } catch (error: any) {\n      await this.bot?.sendMessage(chatId, `‚ùå Error obteniendo exposici√≥n: ${error.message}`);\n    }\n  }\n\n  private async handleUptime(chatId: number) {\n    const now = new Date();\n    const diff = now.getTime() - this.startTime.getTime();\n    const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\n\n    const engineActive = this.engineController?.isActive() ?? false;\n    const status = engineActive ? \"‚úÖ Motor activo\" : \"‚è∏Ô∏è Motor pausado\";\n\n    const message = `\n‚è±Ô∏è *Uptime del Bot*\n\n*Tiempo encendido:* ${days}d ${hours}h ${minutes}m\n*Estado:* ${status}\n*Iniciado:* ${this.startTime.toLocaleString(\"es-ES\")}\n\n_KrakenBot.AI_\n    `.trim();\n\n    await this.bot?.sendMessage(chatId, message, { parse_mode: \"Markdown\" });\n  }\n\n  startHeartbeat() {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n\n    const TWELVE_HOURS = 12 * 60 * 60 * 1000;\n    \n    this.heartbeatInterval = setInterval(async () => {\n      await this.sendHeartbeat();\n    }, TWELVE_HOURS);\n\n    console.log(\"[telegram] Heartbeat iniciado (cada 12h)\");\n  }\n\n  private async sendHeartbeat() {\n    try {\n      const config = await storage.getBotConfig();\n      const engineActive = this.engineController?.isActive() ?? false;\n      const status = engineActive ? \"‚úÖ Activo\" : \"‚è∏Ô∏è Pausado\";\n      \n      const now = new Date();\n      const diff = now.getTime() - this.startTime.getTime();\n      const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n\n      const trades = await storage.getTrades(5);\n      const recentOps = trades.length > 0 ? `${trades.length} recientes` : \"Sin operaciones\";\n\n      const message = `\nüíì *Heartbeat - KrakenBot*\n\n*Estado:* ${status}\n*Uptime:* ${days}d ${hours}h\n*Estrategia:* ${config?.strategy || \"momentum\"}\n*Pares:* ${config?.activePairs?.join(\", \") || \"N/A\"}\n*Ops recientes:* ${recentOps}\n\n_${now.toLocaleString(\"es-ES\")}_\n      `.trim();\n\n      const chats = await storage.getActiveTelegramChats();\n      for (const chat of chats) {\n        if (chat.alertHeartbeat) {\n          await this.sendToChat(chat.chatId, message);\n        }\n      }\n\n      if (this.chatId) {\n        await this.sendMessage(message);\n      }\n    } catch (error) {\n      console.error(\"[telegram] Error enviando heartbeat:\", error);\n    }\n  }\n\n  isInitialized(): boolean {\n    return this.bot !== null && this.chatId !== \"\";\n  }\n\n  async sendMessage(message: string, options?: { skipPrefix?: boolean }): Promise<boolean> {\n    if (!this.bot || !this.chatId) {\n      console.warn(\"Telegram not initialized, skipping notification\");\n      return false;\n    }\n\n    try {\n      const prefix = options?.skipPrefix ? \"\" : await this.getMessagePrefix();\n      const fullMessage = prefix + message;\n      await this.bot.sendMessage(this.chatId, fullMessage, { parse_mode: \"Markdown\" });\n      return true;\n    } catch (error) {\n      console.error(\"Failed to send Telegram message:\", error);\n      return false;\n    }\n  }\n\n  private async getMessagePrefix(): Promise<string> {\n    try {\n      const config = await storage.getBotConfig();\n      const dryRun = config?.dryRunMode ?? false;\n      return environment.getMessagePrefix(dryRun);\n    } catch {\n      return environment.getMessagePrefix(false);\n    }\n  }\n\n  async sendToChat(chatId: string, message: string, options?: { skipPrefix?: boolean }): Promise<boolean> {\n    if (!this.bot) {\n      console.warn(\"Telegram bot not initialized\");\n      return false;\n    }\n\n    try {\n      const prefix = options?.skipPrefix ? \"\" : await this.getMessagePrefix();\n      const fullMessage = prefix + message;\n      await this.bot.sendMessage(chatId, fullMessage, { parse_mode: \"Markdown\" });\n      return true;\n    } catch (error) {\n      console.error(`Failed to send message to chat ${chatId}:`, error);\n      return false;\n    }\n  }\n\n  async sendAlertToMultipleChats(message: string, alertType: AlertType): Promise<void> {\n    if (!this.bot) return;\n\n    const sentChatIds = new Set<string>();\n\n    try {\n      if (this.chatId) {\n        await this.sendMessage(message);\n        sentChatIds.add(this.chatId);\n      }\n\n      const chats = await storage.getActiveTelegramChats();\n      \n      for (const chat of chats) {\n        if (sentChatIds.has(chat.chatId)) continue;\n        \n        const shouldSend = this.shouldSendToChat(chat, alertType);\n        if (shouldSend) {\n          await this.sendToChat(chat.chatId, message);\n          sentChatIds.add(chat.chatId);\n        }\n      }\n    } catch (error) {\n      console.error(\"Error sending to multiple chats:\", error);\n    }\n  }\n\n  private shouldSendToChat(chat: TelegramChat, alertType: AlertType): boolean {\n    switch (alertType) {\n      case \"trades\":\n        return chat.alertTrades;\n      case \"errors\":\n        return chat.alertErrors;\n      case \"system\":\n        return chat.alertSystem;\n      case \"balance\":\n        return chat.alertBalance;\n      default:\n        return false;\n    }\n  }\n\n  async sendTradeNotification(trade: {\n    type: string;\n    pair: string;\n    price: string;\n    amount: string;\n    status: string;\n  }) {\n    const emoji = trade.type === \"buy\" || trade.type === \"COMPRA\" ? \"üü¢\" : \"üî¥\";\n    const message = `\n${emoji} *Nueva Operaci√≥n*\n\n*Tipo:* ${trade.type.toUpperCase()}\n*Par:* ${trade.pair}\n*Precio:* $${trade.price}\n*Cantidad:* ${trade.amount}\n*Estado:* ${trade.status}\n\n_KrakenBot.AI - Trading Aut√≥nomo_\n    `.trim();\n\n    await this.sendAlertToMultipleChats(message, \"trades\");\n  }\n\n  async sendAlert(title: string, description: string) {\n    const message = `\n‚ö†Ô∏è *${title}*\n\n${description}\n\n_KrakenBot.AI - Sistema de Alertas_\n    `.trim();\n\n    await this.sendAlertToMultipleChats(message, \"errors\");\n  }\n\n  async sendSystemStatus(isActive: boolean, strategy: string) {\n    const emoji = isActive ? \"‚úÖ\" : \"‚è∏Ô∏è\";\n    const status = isActive ? \"EN L√çNEA\" : \"PAUSADO\";\n    const message = `\n${emoji} *Estado del Sistema*\n\n*Status:* ${status}\n*Estrategia:* ${strategy}\n\n_KrakenBot.AI - Monitoreo_\n    `.trim();\n\n    await this.sendAlertToMultipleChats(message, \"system\");\n  }\n\n  async sendBalanceAlert(title: string, description: string) {\n    const message = `\nüí∞ *${title}*\n\n${description}\n\n_KrakenBot.AI - Balance_\n    `.trim();\n\n    await this.sendAlertToMultipleChats(message, \"balance\");\n  }\n}\n\nexport const telegramService = new TelegramService();\n","path":null,"size_bytes":16236,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverAnchor = PopoverPrimitive.Anchor\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }\n","path":null,"size_bytes":1342,"size_tokens":null},"client/src/components/ui/empty.tsx":{"content":"import { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Empty({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty\"\n      className={cn(\n        \"flex min-w-0 flex-1 flex-col items-center justify-center gap-6 text-balance rounded-lg border-dashed p-6 text-center md:p-12\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-header\"\n      className={cn(\n        \"flex max-w-sm flex-col items-center gap-2 text-center\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst emptyMediaVariants = cva(\n  \"mb-2 flex shrink-0 items-center justify-center [&_svg]:pointer-events-none [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction EmptyMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof emptyMediaVariants>) {\n  return (\n    <div\n      data-slot=\"empty-icon\"\n      data-variant={variant}\n      className={cn(emptyMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-title\"\n      className={cn(\"text-lg font-medium tracking-tight\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <div\n      data-slot=\"empty-description\"\n      className={cn(\n        \"text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-content\"\n      className={cn(\n        \"flex w-full min-w-0 max-w-sm flex-col items-center gap-4 text-balance text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Empty,\n  EmptyHeader,\n  EmptyTitle,\n  EmptyDescription,\n  EmptyContent,\n  EmptyMedia,\n}\n","path":null,"size_bytes":2396,"size_tokens":null},"client/src/components/ui/button-group.tsx":{"content":"import { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nconst buttonGroupVariants = cva(\n  \"flex w-fit items-stretch has-[>[data-slot=button-group]]:gap-2 [&>*]:focus-visible:relative [&>*]:focus-visible:z-10 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1\",\n  {\n    variants: {\n      orientation: {\n        horizontal:\n          \"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none\",\n        vertical:\n          \"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none\",\n      },\n    },\n    defaultVariants: {\n      orientation: \"horizontal\",\n    },\n  }\n)\n\nfunction ButtonGroup({\n  className,\n  orientation,\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof buttonGroupVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"button-group\"\n      data-orientation={orientation}\n      className={cn(buttonGroupVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupText({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  asChild?: boolean\n}) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      className={cn(\n        \"bg-muted shadow-xs flex items-center gap-2 rounded-md border px-4 text-sm font-medium [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupSeparator({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"button-group-separator\"\n      orientation={orientation}\n      className={cn(\n        \"bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  ButtonGroup,\n  ButtonGroupSeparator,\n  ButtonGroupText,\n  buttonGroupVariants,\n}\n","path":null,"size_bytes":2209,"size_tokens":null},"client/src/components/dashboard/BotControl.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { TrendingUp, RefreshCw, Zap, Target, Shield, Info, Power } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { BotConfig } from \"@shared/schema\";\n\nconst STRATEGIES: Record<string, { name: string; icon: typeof TrendingUp }> = {\n  momentum: { name: \"Momentum\", icon: TrendingUp },\n  mean_reversion: { name: \"Reversi√≥n a la Media\", icon: RefreshCw },\n  scalping: { name: \"Scalping\", icon: Zap },\n  grid: { name: \"Grid Trading\", icon: Target },\n};\n\nconst RISK_LEVELS: Record<string, { name: string; color: string }> = {\n  low: { name: \"Bajo\", color: \"text-green-500 bg-green-500/10 border-green-500/30\" },\n  medium: { name: \"Medio\", color: \"text-yellow-500 bg-yellow-500/10 border-yellow-500/30\" },\n  high: { name: \"Alto\", color: \"text-red-500 bg-red-500/10 border-red-500/30\" },\n};\n\nexport function BotControl() {\n  const { data: config } = useQuery<BotConfig>({\n    queryKey: [\"botConfig\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/config\");\n      if (!res.ok) throw new Error(\"Failed to fetch config\");\n      return res.json();\n    },\n  });\n\n  const isActive = config?.isActive ?? false;\n  const strategyId = config?.strategy || \"momentum\";\n  const riskId = config?.riskLevel || \"medium\";\n  \n  const currentStrategy = STRATEGIES[strategyId] || STRATEGIES.momentum;\n  const currentRisk = RISK_LEVELS[riskId] || RISK_LEVELS.medium;\n  const StrategyIcon = currentStrategy.icon;\n\n  return (\n    <Card className=\"glass-panel border-border/50\">\n      <CardHeader className=\"pb-3 border-b border-border/50 bg-muted/10\">\n        <CardTitle className=\"text-sm font-medium font-mono flex items-center justify-between\">\n          <span>CONTROL DEL SISTEMA</span>\n          <div className=\"flex items-center gap-2\">\n            <div className={cn(\"h-2 w-2 rounded-full\", isActive ? \"bg-green-500 animate-pulse\" : \"bg-red-500\")} />\n            <span className={cn(\"text-xs\", isActive ? \"text-green-500\" : \"text-red-500\")}>\n              {isActive ? \"ACTIVO\" : \"INACTIVO\"}\n            </span>\n          </div>\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4 pt-4\">\n        \n        <div className=\"flex items-center justify-between p-3 rounded-lg border border-border/50 bg-background/50\">\n          <div className=\"flex items-center gap-2\">\n            <Power className={cn(\"h-4 w-4\", isActive ? \"text-green-500\" : \"text-red-500\")} />\n            <span className=\"text-sm\">Estado del Bot</span>\n          </div>\n          <Badge \n            variant=\"outline\" \n            className={cn(\"font-mono border\", isActive ? \"text-green-500 bg-green-500/10 border-green-500/30\" : \"text-red-500 bg-red-500/10 border-red-500/30\")}\n          >\n            {isActive ? \"ENCENDIDO\" : \"APAGADO\"}\n          </Badge>\n        </div>\n\n        <div className=\"grid gap-3\">\n          <Label className=\"text-xs font-mono text-muted-foreground\">CONFIGURACI√ìN ACTIVA</Label>\n          \n          <div className=\"flex items-center justify-between p-3 rounded-lg border border-border/50 bg-background/50\">\n            <div className=\"flex items-center gap-2\">\n              <StrategyIcon className=\"h-4 w-4 text-primary\" />\n              <span className=\"text-sm\">Estrategia</span>\n            </div>\n            <Badge variant=\"outline\" className=\"font-mono\">\n              {currentStrategy.name.toUpperCase()}\n            </Badge>\n          </div>\n\n          <div className=\"flex items-center justify-between p-3 rounded-lg border border-border/50 bg-background/50\">\n            <div className=\"flex items-center gap-2\">\n              <Shield className=\"h-4 w-4 text-primary\" />\n              <span className=\"text-sm\">Nivel de Riesgo</span>\n            </div>\n            <Badge variant=\"outline\" className={cn(\"font-mono border\", currentRisk.color)}>\n              {currentRisk.name.toUpperCase()}\n            </Badge>\n          </div>\n        </div>\n        \n        <div className=\"bg-muted/30 border border-border/50 p-3 rounded-md flex gap-3 items-start\">\n          <Info className=\"h-4 w-4 text-muted-foreground shrink-0 mt-0.5\" />\n          <p className=\"text-[10px] text-muted-foreground leading-tight\">\n            Panel informativo. Para cambiar la configuraci√≥n o encender/apagar el bot, usa la pesta√±a <strong>Estrategias</strong>.\n          </p>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":4588,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\n      \"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2859,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport {\n  ChevronDownIcon,\n  ChevronLeftIcon,\n  ChevronRightIcon,\n} from \"lucide-react\"\nimport { DayButton, DayPicker, getDefaultClassNames } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button, buttonVariants } from \"@/components/ui/button\"\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  captionLayout = \"label\",\n  buttonVariant = \"ghost\",\n  formatters,\n  components,\n  ...props\n}: React.ComponentProps<typeof DayPicker> & {\n  buttonVariant?: React.ComponentProps<typeof Button>[\"variant\"]\n}) {\n  const defaultClassNames = getDefaultClassNames()\n\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\n        \"bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent\",\n        String.raw`rtl:**:[.rdp-button\\_next>svg]:rotate-180`,\n        String.raw`rtl:**:[.rdp-button\\_previous>svg]:rotate-180`,\n        className\n      )}\n      captionLayout={captionLayout}\n      formatters={{\n        formatMonthDropdown: (date) =>\n          date.toLocaleString(\"default\", { month: \"short\" }),\n        ...formatters,\n      }}\n      classNames={{\n        root: cn(\"w-fit\", defaultClassNames.root),\n        months: cn(\n          \"relative flex flex-col gap-4 md:flex-row\",\n          defaultClassNames.months\n        ),\n        month: cn(\"flex w-full flex-col gap-4\", defaultClassNames.month),\n        nav: cn(\n          \"absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1\",\n          defaultClassNames.nav\n        ),\n        button_previous: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_previous\n        ),\n        button_next: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_next\n        ),\n        month_caption: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]\",\n          defaultClassNames.month_caption\n        ),\n        dropdowns: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium\",\n          defaultClassNames.dropdowns\n        ),\n        dropdown_root: cn(\n          \"has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border\",\n          defaultClassNames.dropdown_root\n        ),\n        dropdown: cn(\n          \"bg-popover absolute inset-0 opacity-0\",\n          defaultClassNames.dropdown\n        ),\n        caption_label: cn(\n          \"select-none font-medium\",\n          captionLayout === \"label\"\n            ? \"text-sm\"\n            : \"[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5\",\n          defaultClassNames.caption_label\n        ),\n        table: \"w-full border-collapse\",\n        weekdays: cn(\"flex\", defaultClassNames.weekdays),\n        weekday: cn(\n          \"text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal\",\n          defaultClassNames.weekday\n        ),\n        week: cn(\"mt-2 flex w-full\", defaultClassNames.week),\n        week_number_header: cn(\n          \"w-[--cell-size] select-none\",\n          defaultClassNames.week_number_header\n        ),\n        week_number: cn(\n          \"text-muted-foreground select-none text-[0.8rem]\",\n          defaultClassNames.week_number\n        ),\n        day: cn(\n          \"group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md\",\n          defaultClassNames.day\n        ),\n        range_start: cn(\n          \"bg-accent rounded-l-md\",\n          defaultClassNames.range_start\n        ),\n        range_middle: cn(\"rounded-none\", defaultClassNames.range_middle),\n        range_end: cn(\"bg-accent rounded-r-md\", defaultClassNames.range_end),\n        today: cn(\n          \"bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none\",\n          defaultClassNames.today\n        ),\n        outside: cn(\n          \"text-muted-foreground aria-selected:text-muted-foreground\",\n          defaultClassNames.outside\n        ),\n        disabled: cn(\n          \"text-muted-foreground opacity-50\",\n          defaultClassNames.disabled\n        ),\n        hidden: cn(\"invisible\", defaultClassNames.hidden),\n        ...classNames,\n      }}\n      components={{\n        Root: ({ className, rootRef, ...props }) => {\n          return (\n            <div\n              data-slot=\"calendar\"\n              ref={rootRef}\n              className={cn(className)}\n              {...props}\n            />\n          )\n        },\n        Chevron: ({ className, orientation, ...props }) => {\n          if (orientation === \"left\") {\n            return (\n              <ChevronLeftIcon className={cn(\"size-4\", className)} {...props} />\n            )\n          }\n\n          if (orientation === \"right\") {\n            return (\n              <ChevronRightIcon\n                className={cn(\"size-4\", className)}\n                {...props}\n              />\n            )\n          }\n\n          return (\n            <ChevronDownIcon className={cn(\"size-4\", className)} {...props} />\n          )\n        },\n        DayButton: CalendarDayButton,\n        WeekNumber: ({ children, ...props }) => {\n          return (\n            <td {...props}>\n              <div className=\"flex size-[--cell-size] items-center justify-center text-center\">\n                {children}\n              </div>\n            </td>\n          )\n        },\n        ...components,\n      }}\n      {...props}\n    />\n  )\n}\n\nfunction CalendarDayButton({\n  className,\n  day,\n  modifiers,\n  ...props\n}: React.ComponentProps<typeof DayButton>) {\n  const defaultClassNames = getDefaultClassNames()\n\n  const ref = React.useRef<HTMLButtonElement>(null)\n  React.useEffect(() => {\n    if (modifiers.focused) ref.current?.focus()\n  }, [modifiers.focused])\n\n  return (\n    <Button\n      ref={ref}\n      variant=\"ghost\"\n      size=\"icon\"\n      data-day={day.date.toLocaleDateString()}\n      data-selected-single={\n        modifiers.selected &&\n        !modifiers.range_start &&\n        !modifiers.range_end &&\n        !modifiers.range_middle\n      }\n      data-range-start={modifiers.range_start}\n      data-range-end={modifiers.range_end}\n      data-range-middle={modifiers.range_middle}\n      className={cn(\n        \"data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70\",\n        defaultClassNames.day,\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport { Calendar, CalendarDayButton }\n","path":null,"size_bytes":7569,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, serial, timestamp, decimal, boolean, integer, jsonb, unique } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const botConfig = pgTable(\"bot_config\", {\n  id: serial(\"id\").primaryKey(),\n  isActive: boolean(\"is_active\").notNull().default(false),\n  strategy: text(\"strategy\").notNull().default(\"momentum\"),\n  signalTimeframe: text(\"signal_timeframe\").notNull().default(\"cycle\"),\n  riskLevel: text(\"risk_level\").notNull().default(\"medium\"),\n  activePairs: text(\"active_pairs\").array().notNull().default([\"BTC/USD\", \"ETH/USD\", \"SOL/USD\"]),\n  stopLossPercent: decimal(\"stop_loss_percent\", { precision: 5, scale: 2 }).notNull().default(\"5.00\"),\n  takeProfitPercent: decimal(\"take_profit_percent\", { precision: 5, scale: 2 }).notNull().default(\"7.00\"),\n  trailingStopEnabled: boolean(\"trailing_stop_enabled\").notNull().default(false),\n  trailingStopPercent: decimal(\"trailing_stop_percent\", { precision: 5, scale: 2 }).notNull().default(\"2.00\"),\n  nonceErrorAlertsEnabled: boolean(\"nonce_error_alerts_enabled\").notNull().default(true),\n  dailyLossLimitEnabled: boolean(\"daily_loss_limit_enabled\").notNull().default(true),\n  dailyLossLimitPercent: decimal(\"daily_loss_limit_percent\", { precision: 5, scale: 2 }).notNull().default(\"10.00\"),\n  maxPairExposurePct: decimal(\"max_pair_exposure_pct\", { precision: 5, scale: 2 }).notNull().default(\"25.00\"),\n  maxTotalExposurePct: decimal(\"max_total_exposure_pct\", { precision: 5, scale: 2 }).notNull().default(\"60.00\"),\n  riskPerTradePct: decimal(\"risk_per_trade_pct\", { precision: 5, scale: 2 }).notNull().default(\"15.00\"),\n  tradingHoursEnabled: boolean(\"trading_hours_enabled\").notNull().default(true),\n  tradingHoursStart: decimal(\"trading_hours_start\", { precision: 2, scale: 0 }).notNull().default(\"8\"),\n  tradingHoursEnd: decimal(\"trading_hours_end\", { precision: 2, scale: 0 }).notNull().default(\"22\"),\n  positionMode: text(\"position_mode\").notNull().default(\"SINGLE\"),\n  // SMART_GUARD configuration\n  sgMinEntryUsd: decimal(\"sg_min_entry_usd\", { precision: 10, scale: 2 }).notNull().default(\"100.00\"),\n  sgAllowUnderMin: boolean(\"sg_allow_under_min\").notNull().default(true),\n  sgBeAtPct: decimal(\"sg_be_at_pct\", { precision: 5, scale: 2 }).notNull().default(\"1.50\"),\n  sgFeeCushionPct: decimal(\"sg_fee_cushion_pct\", { precision: 5, scale: 2 }).notNull().default(\"0.45\"),\n  sgFeeCushionAuto: boolean(\"sg_fee_cushion_auto\").notNull().default(true),\n  sgTrailStartPct: decimal(\"sg_trail_start_pct\", { precision: 5, scale: 2 }).notNull().default(\"2.00\"),\n  sgTrailDistancePct: decimal(\"sg_trail_distance_pct\", { precision: 5, scale: 2 }).notNull().default(\"1.50\"),\n  sgTrailStepPct: decimal(\"sg_trail_step_pct\", { precision: 5, scale: 2 }).notNull().default(\"0.25\"),\n  sgTpFixedEnabled: boolean(\"sg_tp_fixed_enabled\").notNull().default(false),\n  sgTpFixedPct: decimal(\"sg_tp_fixed_pct\", { precision: 5, scale: 2 }).notNull().default(\"10.00\"),\n  sgScaleOutEnabled: boolean(\"sg_scale_out_enabled\").notNull().default(false),\n  sgScaleOutPct: decimal(\"sg_scale_out_pct\", { precision: 5, scale: 2 }).notNull().default(\"35.00\"),\n  sgMinPartUsd: decimal(\"sg_min_part_usd\", { precision: 10, scale: 2 }).notNull().default(\"50.00\"),\n  sgScaleOutThreshold: decimal(\"sg_scale_out_threshold\", { precision: 5, scale: 2 }).notNull().default(\"80.00\"),\n  sgMaxOpenLotsPerPair: integer(\"sg_max_open_lots_per_pair\").notNull().default(1),\n  // SMART_GUARD pair overrides (JSON: { \"BTC/USD\": { trailDistancePct: 1.0 }, ... })\n  sgPairOverrides: jsonb(\"sg_pair_overrides\"),\n  // DRY_RUN mode: audit/verify without sending real orders to exchange\n  dryRunMode: boolean(\"dry_run_mode\").notNull().default(false),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const apiConfig = pgTable(\"api_config\", {\n  id: serial(\"id\").primaryKey(),\n  krakenApiKey: text(\"kraken_api_key\"),\n  krakenApiSecret: text(\"kraken_api_secret\"),\n  krakenConnected: boolean(\"kraken_connected\").notNull().default(false),\n  telegramToken: text(\"telegram_token\"),\n  telegramChatId: text(\"telegram_chat_id\"),\n  telegramConnected: boolean(\"telegram_connected\").notNull().default(false),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const trades = pgTable(\"trades\", {\n  id: serial(\"id\").primaryKey(),\n  tradeId: text(\"trade_id\").notNull().unique(),\n  pair: text(\"pair\").notNull(),\n  type: text(\"type\").notNull(),\n  price: decimal(\"price\", { precision: 18, scale: 8 }).notNull(),\n  amount: decimal(\"amount\", { precision: 18, scale: 8 }).notNull(),\n  status: text(\"status\").notNull().default(\"pending\"),\n  krakenOrderId: text(\"kraken_order_id\").unique(), // UNIQUE para evitar duplicados en sync\n  entryPrice: decimal(\"entry_price\", { precision: 18, scale: 8 }),\n  realizedPnlUsd: decimal(\"realized_pnl_usd\", { precision: 18, scale: 8 }),\n  realizedPnlPct: decimal(\"realized_pnl_pct\", { precision: 10, scale: 4 }),\n  executedAt: timestamp(\"executed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const notifications = pgTable(\"notifications\", {\n  id: serial(\"id\").primaryKey(),\n  type: text(\"type\").notNull(),\n  message: text(\"message\").notNull(),\n  telegramSent: boolean(\"telegram_sent\").notNull().default(false),\n  sentAt: timestamp(\"sent_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const marketData = pgTable(\"market_data\", {\n  id: serial(\"id\").primaryKey(),\n  pair: text(\"pair\").notNull(),\n  price: decimal(\"price\", { precision: 18, scale: 8 }).notNull(),\n  volume24h: decimal(\"volume_24h\", { precision: 18, scale: 2 }),\n  change24h: decimal(\"change_24h\", { precision: 10, scale: 2 }),\n  timestamp: timestamp(\"timestamp\").notNull().defaultNow(),\n});\n\nexport const telegramChats = pgTable(\"telegram_chats\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  chatId: text(\"chat_id\").notNull(),\n  alertTrades: boolean(\"alert_trades\").notNull().default(true),\n  alertErrors: boolean(\"alert_errors\").notNull().default(true),\n  alertSystem: boolean(\"alert_system\").notNull().default(true),\n  alertBalance: boolean(\"alert_balance\").notNull().default(false),\n  alertHeartbeat: boolean(\"alert_heartbeat\").notNull().default(true),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const botEvents = pgTable(\"bot_events\", {\n  id: serial(\"id\").primaryKey(),\n  timestamp: timestamp(\"timestamp\").notNull().defaultNow(),\n  level: text(\"level\").notNull(),\n  type: text(\"type\").notNull(),\n  message: text(\"message\").notNull(),\n  meta: text(\"meta\"),\n});\n\nexport const openPositions = pgTable(\"open_positions\", {\n  id: serial(\"id\").primaryKey(),\n  lotId: text(\"lot_id\").notNull().unique(), // Unique identifier for each lot (multi-lot support)\n  pair: text(\"pair\").notNull(), // Removed unique constraint for multi-lot support\n  entryPrice: decimal(\"entry_price\", { precision: 18, scale: 8 }).notNull(),\n  amount: decimal(\"amount\", { precision: 18, scale: 8 }).notNull(),\n  qtyRemaining: decimal(\"qty_remaining\", { precision: 18, scale: 8 }), // Cantidad pendiente de vender (null = amount)\n  qtyFilled: decimal(\"qty_filled\", { precision: 18, scale: 8 }).default(\"0\"), // Cantidad ya vendida\n  highestPrice: decimal(\"highest_price\", { precision: 18, scale: 8 }).notNull(),\n  tradeId: text(\"trade_id\"),\n  krakenOrderId: text(\"kraken_order_id\"),\n  entryStrategyId: text(\"entry_strategy_id\").notNull().default(\"momentum_cycle\"),\n  entrySignalTf: text(\"entry_signal_tf\").notNull().default(\"cycle\"),\n  signalConfidence: decimal(\"signal_confidence\", { precision: 5, scale: 2 }),\n  signalReason: text(\"signal_reason\"),\n  entryMode: text(\"entry_mode\"),\n  configSnapshotJson: jsonb(\"config_snapshot_json\"),\n  // SMART_GUARD dynamic state\n  sgBreakEvenActivated: boolean(\"sg_break_even_activated\").default(false),\n  sgCurrentStopPrice: decimal(\"sg_current_stop_price\", { precision: 18, scale: 8 }),\n  sgTrailingActivated: boolean(\"sg_trailing_activated\").default(false),\n  sgScaleOutDone: boolean(\"sg_scale_out_done\").default(false),\n  openedAt: timestamp(\"opened_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\n// Trade fills from Kraken (granular level for partial fills)\nexport const tradeFills = pgTable(\"trade_fills\", {\n  id: serial(\"id\").primaryKey(),\n  txid: text(\"txid\").notNull().unique(), // Kraken fill txid (UNIQUE para evitar duplicados)\n  orderId: text(\"order_id\").notNull(), // Kraken ordertxid (puede tener m√∫ltiples fills)\n  pair: text(\"pair\").notNull(),\n  type: text(\"type\").notNull(), // buy/sell\n  price: decimal(\"price\", { precision: 18, scale: 8 }).notNull(),\n  amount: decimal(\"amount\", { precision: 18, scale: 8 }).notNull(),\n  cost: decimal(\"cost\", { precision: 18, scale: 8 }).notNull(),\n  fee: decimal(\"fee\", { precision: 18, scale: 8 }).notNull(),\n  matched: boolean(\"matched\").notNull().default(false), // Flag para evitar re-procesar\n  executedAt: timestamp(\"executed_at\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\n// Lot matches for FIFO matching (audit trail)\nexport const lotMatches = pgTable(\"lot_matches\", {\n  id: serial(\"id\").primaryKey(),\n  sellFillTxid: text(\"sell_fill_txid\").notNull(), // Fill txid del SELL\n  lotId: text(\"lot_id\").notNull(), // ID del lot (open_position)\n  matchedQty: decimal(\"matched_qty\", { precision: 18, scale: 8 }).notNull(),\n  buyPrice: decimal(\"buy_price\", { precision: 18, scale: 8 }).notNull(),\n  sellPrice: decimal(\"sell_price\", { precision: 18, scale: 8 }).notNull(),\n  buyFeeAllocated: decimal(\"buy_fee_allocated\", { precision: 18, scale: 8 }).notNull(),\n  sellFeeAllocated: decimal(\"sell_fee_allocated\", { precision: 18, scale: 8 }).notNull(),\n  pnlNet: decimal(\"pnl_net\", { precision: 18, scale: 8 }).notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  sellLotUnique: unique().on(table.sellFillTxid, table.lotId), // UNIQUE(sellFillTxid, lotId) para idempotencia\n}));\n\nexport const aiTradeSamples = pgTable(\"ai_trade_samples\", {\n  id: serial(\"id\").primaryKey(),\n  tradeId: text(\"trade_id\").unique().notNull(),\n  pair: text(\"pair\").notNull(),\n  side: text(\"side\").notNull(),\n  entryTs: timestamp(\"entry_ts\").notNull(),\n  exitTs: timestamp(\"exit_ts\"),\n  entryPrice: decimal(\"entry_price\", { precision: 18, scale: 8 }).notNull(),\n  exitPrice: decimal(\"exit_price\", { precision: 18, scale: 8 }),\n  feesTotal: decimal(\"fees_total\", { precision: 18, scale: 8 }),\n  pnlGross: decimal(\"pnl_gross\", { precision: 18, scale: 8 }),\n  pnlNet: decimal(\"pnl_net\", { precision: 18, scale: 8 }),\n  labelWin: integer(\"label_win\"),\n  featuresJson: jsonb(\"features_json\").notNull(),\n  isComplete: boolean(\"is_complete\").default(false),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const aiShadowDecisions = pgTable(\"ai_shadow_decisions\", {\n  id: serial(\"id\").primaryKey(),\n  tradeId: text(\"trade_id\").notNull(),\n  ts: timestamp(\"ts\").defaultNow(),\n  score: decimal(\"score\", { precision: 5, scale: 4 }).notNull(),\n  threshold: decimal(\"threshold\", { precision: 5, scale: 4 }).notNull(),\n  wouldBlock: boolean(\"would_block\").notNull(),\n  finalPnlNet: decimal(\"final_pnl_net\", { precision: 18, scale: 8 }),\n});\n\nexport const trainingTrades = pgTable(\"training_trades\", {\n  id: serial(\"id\").primaryKey(),\n  pair: text(\"pair\").notNull(),\n  strategyId: text(\"strategy_id\"),\n  buyTxid: text(\"buy_txid\").notNull().unique(), // UNIQUE para evitar duplicados en backfill\n  sellTxid: text(\"sell_txid\"),\n  sellTxidsJson: jsonb(\"sell_txids_json\"),\n  entryPrice: decimal(\"entry_price\", { precision: 18, scale: 8 }).notNull(),\n  exitPrice: decimal(\"exit_price\", { precision: 18, scale: 8 }),\n  entryAmount: decimal(\"entry_amount\", { precision: 18, scale: 8 }).notNull(),\n  exitAmount: decimal(\"exit_amount\", { precision: 18, scale: 8 }),\n  qtyRemaining: decimal(\"qty_remaining\", { precision: 18, scale: 8 }),\n  entryFee: decimal(\"entry_fee\", { precision: 18, scale: 8 }).notNull().default(\"0\"),\n  exitFee: decimal(\"exit_fee\", { precision: 18, scale: 8 }),\n  costUsd: decimal(\"cost_usd\", { precision: 18, scale: 8 }).notNull(),\n  revenueUsd: decimal(\"revenue_usd\", { precision: 18, scale: 8 }),\n  pnlGross: decimal(\"pnl_gross\", { precision: 18, scale: 8 }),\n  pnlNet: decimal(\"pnl_net\", { precision: 18, scale: 8 }),\n  pnlPct: decimal(\"pnl_pct\", { precision: 10, scale: 4 }),\n  holdTimeMinutes: integer(\"hold_time_minutes\"),\n  labelWin: integer(\"label_win\"),\n  featuresJson: jsonb(\"features_json\"),\n  discardReason: text(\"discard_reason\"),\n  isClosed: boolean(\"is_closed\").notNull().default(false),\n  isLabeled: boolean(\"is_labeled\").notNull().default(false),\n  entryTs: timestamp(\"entry_ts\").notNull(),\n  exitTs: timestamp(\"exit_ts\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const aiConfig = pgTable(\"ai_config\", {\n  id: serial(\"id\").primaryKey(),\n  filterEnabled: boolean(\"filter_enabled\").default(false),\n  shadowEnabled: boolean(\"shadow_enabled\").default(false),\n  modelPath: text(\"model_path\"),\n  modelVersion: text(\"model_version\"),\n  lastTrainTs: timestamp(\"last_train_ts\"),\n  lastBackfillTs: timestamp(\"last_backfill_ts\"),\n  lastBackfillError: text(\"last_backfill_error\"),\n  lastBackfillDiscardReasonsJson: jsonb(\"last_backfill_discard_reasons_json\"),\n  lastTrainError: text(\"last_train_error\"),\n  nSamples: integer(\"n_samples\").default(0),\n  threshold: decimal(\"threshold\", { precision: 5, scale: 4 }).default(\"0.60\"),\n  metricsJson: jsonb(\"metrics_json\"),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertBotConfigSchema = createInsertSchema(botConfig).omit({ id: true, updatedAt: true });\nexport const insertTradeSchema = createInsertSchema(trades).omit({ id: true, createdAt: true });\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({ id: true, createdAt: true });\nexport const insertMarketDataSchema = createInsertSchema(marketData).omit({ id: true, timestamp: true });\nexport const insertApiConfigSchema = createInsertSchema(apiConfig).omit({ id: true, updatedAt: true });\nexport const insertTelegramChatSchema = createInsertSchema(telegramChats).omit({ id: true, createdAt: true });\nexport const insertBotEventSchema = createInsertSchema(botEvents).omit({ id: true, timestamp: true });\nexport const insertOpenPositionSchema = createInsertSchema(openPositions).omit({ id: true, openedAt: true, updatedAt: true });\nexport const insertAiTradeSampleSchema = createInsertSchema(aiTradeSamples).omit({ id: true, createdAt: true });\nexport const insertAiShadowDecisionSchema = createInsertSchema(aiShadowDecisions).omit({ id: true, ts: true });\nexport const insertAiConfigSchema = createInsertSchema(aiConfig).omit({ id: true, updatedAt: true });\nexport const insertTrainingTradeSchema = createInsertSchema(trainingTrades).omit({ id: true, createdAt: true });\nexport const insertTradeFillSchema = createInsertSchema(tradeFills).omit({ id: true, createdAt: true });\nexport const insertLotMatchSchema = createInsertSchema(lotMatches).omit({ id: true, createdAt: true });\n\nexport type BotConfig = typeof botConfig.$inferSelect;\nexport type Trade = typeof trades.$inferSelect;\nexport type Notification = typeof notifications.$inferSelect;\nexport type MarketData = typeof marketData.$inferSelect;\nexport type ApiConfig = typeof apiConfig.$inferSelect;\nexport type TelegramChat = typeof telegramChats.$inferSelect;\nexport type BotEvent = typeof botEvents.$inferSelect;\nexport type OpenPosition = typeof openPositions.$inferSelect;\nexport type TradeFill = typeof tradeFills.$inferSelect;\nexport type LotMatch = typeof lotMatches.$inferSelect;\nexport type AiTradeSample = typeof aiTradeSamples.$inferSelect;\nexport type AiShadowDecision = typeof aiShadowDecisions.$inferSelect;\nexport type AiConfig = typeof aiConfig.$inferSelect;\nexport type TrainingTrade = typeof trainingTrades.$inferSelect;\n\nexport type InsertBotConfig = z.infer<typeof insertBotConfigSchema>;\nexport type InsertTrade = z.infer<typeof insertTradeSchema>;\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\nexport type InsertMarketData = z.infer<typeof insertMarketDataSchema>;\nexport type InsertApiConfig = z.infer<typeof insertApiConfigSchema>;\nexport type InsertTelegramChat = z.infer<typeof insertTelegramChatSchema>;\nexport type InsertBotEvent = z.infer<typeof insertBotEventSchema>;\nexport type InsertOpenPosition = z.infer<typeof insertOpenPositionSchema>;\nexport type InsertTradeFill = z.infer<typeof insertTradeFillSchema>;\nexport type InsertLotMatch = z.infer<typeof insertLotMatchSchema>;\nexport type InsertAiTradeSample = z.infer<typeof insertAiTradeSampleSchema>;\nexport type InsertAiShadowDecision = z.infer<typeof insertAiShadowDecisionSchema>;\nexport type InsertAiConfig = z.infer<typeof insertAiConfigSchema>;\nexport type InsertTrainingTrade = z.infer<typeof insertTrainingTradeSchema>;\n","path":null,"size_bytes":16974,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1037,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":768,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1877,"size_tokens":null},"vite-plugin-meta-images.ts":{"content":"import type { Plugin } from 'vite';\nimport fs from 'fs';\nimport path from 'path';\n\n/**\n * Vite plugin that updates og:image and twitter:image meta tags\n * to point to the app's opengraph image with the correct Replit domain.\n */\nexport function metaImagesPlugin(): Plugin {\n  return {\n    name: 'vite-plugin-meta-images',\n    transformIndexHtml(html) {\n      const baseUrl = getDeploymentUrl();\n      if (!baseUrl) {\n        log('[meta-images] no Replit deployment domain found, skipping meta tag updates');\n        return html;\n      }\n\n      // Check if opengraph image exists in public directory\n      const publicDir = path.resolve(process.cwd(), 'client', 'public');\n      const opengraphPngPath = path.join(publicDir, 'opengraph.png');\n      const opengraphJpgPath = path.join(publicDir, 'opengraph.jpg');\n      const opengraphJpegPath = path.join(publicDir, 'opengraph.jpeg');\n\n      let imageExt: string | null = null;\n      if (fs.existsSync(opengraphPngPath)) {\n        imageExt = 'png';\n      } else if (fs.existsSync(opengraphJpgPath)) {\n        imageExt = 'jpg';\n      } else if (fs.existsSync(opengraphJpegPath)) {\n        imageExt = 'jpeg';\n      }\n\n      if (!imageExt) {\n        log('[meta-images] OpenGraph image not found, skipping meta tag updates');\n        return html;\n      }\n\n      const imageUrl = `${baseUrl}/opengraph.${imageExt}`;\n\n      log('[meta-images] updating meta image tags to:', imageUrl);\n\n      html = html.replace(\n        /<meta\\s+property=\"og:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta property=\"og:image\" content=\"${imageUrl}\" />`\n      );\n\n      html = html.replace(\n        /<meta\\s+name=\"twitter:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta name=\"twitter:image\" content=\"${imageUrl}\" />`\n      );\n\n      return html;\n    },\n  };\n}\n\nfunction getDeploymentUrl(): string | null {\n  if (process.env.REPLIT_INTERNAL_APP_DOMAIN) {\n    const url = `https://${process.env.REPLIT_INTERNAL_APP_DOMAIN}`;\n    log('[meta-images] using internal app domain:', url);\n    return url;\n  }\n\n  if (process.env.REPLIT_DEV_DOMAIN) {\n    const url = `https://${process.env.REPLIT_DEV_DOMAIN}`;\n    log('[meta-images] using dev domain:', url);\n    return url;\n  }\n\n  return null;\n}\n\nfunction log(...args: any[]): void {\n  if (process.env.NODE_ENV === 'production') {\n    console.log(...args);\n  }\n}\n","path":null,"size_bytes":2333,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4887,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"grid place-content-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1031,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"import * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogTrigger,\n  DialogClose,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3835,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-9 px-2 min-w-9\",\n        sm: \"h-8 px-1.5 min-w-8\",\n        lg: \"h-10 px-2.5 min-w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1486,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/pages/Dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Nav } from \"@/components/dashboard/Nav\";\nimport { Ticker } from \"@/components/dashboard/Ticker\";\nimport { AssetCard } from \"@/components/dashboard/AssetCard\";\nimport { TradeLog } from \"@/components/dashboard/TradeLog\";\nimport { ChartWidget } from \"@/components/dashboard/ChartWidget\";\nimport { BotControl } from \"@/components/dashboard/BotControl\";\nimport { EventsPanel } from \"@/components/dashboard/EventsPanel\";\nimport { EnvironmentBadge } from \"@/components/dashboard/EnvironmentBadge\";\nimport { AlertCircle } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';\n\ninterface DashboardData {\n  krakenConnected: boolean;\n  telegramConnected: boolean;\n  botActive: boolean;\n  strategy: string;\n  activePairs: string[];\n  balances: Record<string, string>;\n  prices: Record<string, { price: string; change: string }>;\n  recentTrades: any[];\n}\n\nexport default function Dashboard() {\n  const { data, isLoading, error } = useQuery<DashboardData>({\n    queryKey: [\"dashboard\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/dashboard\");\n      if (!res.ok) throw new Error(\"Failed to fetch dashboard\");\n      return res.json();\n    },\n    refetchInterval: 30000,\n  });\n\n  const formatBalance = (symbol: string) => {\n    if (!data?.balances) return { balance: \"0\", value: \"$0.00\", change: 0 };\n    \n    const symbolMap: Record<string, string> = {\n      \"BTC\": \"XXBT\", \"ETH\": \"XETH\", \"SOL\": \"SOL\", \"XRP\": \"XXRP\", \"TON\": \"TON\", \"USD\": \"ZUSD\"\n    };\n    const pairMap: Record<string, string> = {\n      \"BTC\": \"XXBTZUSD\", \"ETH\": \"XETHZUSD\", \"SOL\": \"SOLUSD\", \"XRP\": \"XXRPZUSD\", \"TON\": \"TONUSD\"\n    };\n    \n    const krakenSymbol = symbolMap[symbol] || \"ZUSD\";\n    const balance = parseFloat(data.balances[krakenSymbol] || \"0\");\n    \n    const pricePair = pairMap[symbol];\n    const priceData = pricePair ? data.prices[pricePair] : null;\n    const price = parseFloat(priceData?.price || \"0\");\n    const change = parseFloat(priceData?.change || \"0\");\n    \n    const value = symbol === \"USD\" ? balance : balance * price;\n    \n    return {\n      balance: balance.toFixed(symbol === \"USD\" ? 2 : 4),\n      value: `$${value.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,\n      change: symbol === \"USD\" ? 0 : change,\n    };\n  };\n\n  const getTotalBalance = () => {\n    if (!data?.balances || !data?.prices) return \"$0.00\";\n    \n    let total = parseFloat(data.balances[\"ZUSD\"] || \"0\");\n    \n    const assets = [\n      { symbol: \"XXBT\", pair: \"XXBTZUSD\" },\n      { symbol: \"XETH\", pair: \"XETHZUSD\" },\n      { symbol: \"SOL\", pair: \"SOLUSD\" },\n      { symbol: \"XXRP\", pair: \"XXRPZUSD\" },\n      { symbol: \"TON\", pair: \"TONUSD\" },\n    ];\n    \n    for (const asset of assets) {\n      const balance = parseFloat(data.balances[asset.symbol] || \"0\");\n      const price = parseFloat(data.prices[asset.pair]?.price || \"0\");\n      total += balance * price;\n    }\n    \n    return `$${total.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;\n  };\n\n  const usdData = formatBalance(\"USD\");\n  \n  const cryptoAssets = [\n    { symbol: \"BTC\", name: \"Bitcoin\", ...formatBalance(\"BTC\") },\n    { symbol: \"ETH\", name: \"Ethereum\", ...formatBalance(\"ETH\") },\n    { symbol: \"SOL\", name: \"Solana\", ...formatBalance(\"SOL\") },\n    { symbol: \"XRP\", name: \"Ripple\", ...formatBalance(\"XRP\") },\n    { symbol: \"TON\", name: \"Toncoin\", ...formatBalance(\"TON\") },\n  ].sort((a, b) => {\n    const valueA = parseFloat(a.value.replace(/[$,]/g, \"\")) || 0;\n    const valueB = parseFloat(b.value.replace(/[$,]/g, \"\")) || 0;\n    return valueB - valueA;\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col relative overflow-hidden\">\n      <div \n        className=\"fixed inset-0 z-0 opacity-20 pointer-events-none\" \n        style={{ \n          backgroundImage: `url(${generatedImage})`, \n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          mixBlendMode: 'overlay'\n        }} \n      />\n      \n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        <Nav />\n        <Ticker />\n        \n        <div className=\"mx-4 md:mx-6 mt-4\">\n          <EnvironmentBadge />\n        </div>\n        \n        {!data?.krakenConnected && !isLoading && (\n          <div className=\"mx-4 md:mx-6 mt-4 p-3 md:p-4 bg-yellow-500/10 border border-yellow-500/30 rounded-lg flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-3\">\n            <AlertCircle className=\"h-5 w-5 text-yellow-500 shrink-0\" />\n            <div className=\"flex-1\">\n              <p className=\"text-sm font-medium text-yellow-500\">Kraken no conectado</p>\n              <p className=\"text-xs text-muted-foreground\">Configura tus claves API en Ajustes para ver datos reales.</p>\n            </div>\n            <Link href=\"/settings\" className=\"text-sm text-primary hover:underline whitespace-nowrap\" data-testid=\"link-goto-settings\">\n              Ir a Ajustes\n            </Link>\n          </div>\n        )}\n        \n        <main className=\"flex-1 p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6 max-w-[1600px] mx-auto w-full\">\n          \n          <div className=\"col-span-1 lg:col-span-12 grid grid-cols-2 min-[500px]:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4\">\n            <AssetCard \n              symbol=\"USD\" \n              name=\"Balance Total\" \n              balance={usdData.balance} \n              value={data?.krakenConnected ? getTotalBalance() : \"--\"} \n              change={0} \n            />\n            {cryptoAssets.map((asset) => (\n              <AssetCard \n                key={asset.symbol}\n                symbol={asset.symbol} \n                name={asset.name} \n                balance={data?.krakenConnected ? asset.balance : \"--\"} \n                value={data?.krakenConnected ? asset.value : \"--\"} \n                change={asset.change} \n              />\n            ))}\n          </div>\n\n          <div className=\"col-span-1 lg:col-span-9 h-[280px] sm:h-[350px] md:h-[400px] lg:h-[500px]\">\n            <ChartWidget />\n          </div>\n          <div className=\"col-span-1 lg:col-span-3 space-y-3 md:space-y-4 lg:space-y-6\">\n            <BotControl />\n            <div className=\"glass-panel p-3 md:p-4 rounded-lg border border-border/50\">\n               <h3 className=\"text-xs font-mono text-muted-foreground mb-3\">PARES ACTIVOS</h3>\n               <div className=\"flex flex-wrap gap-2\">\n                 {(data?.activePairs || [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\"]).map(pair => (\n                   <span key={pair} className=\"px-2 py-1 bg-primary/10 text-primary border border-primary/20 rounded text-xs font-mono\">\n                     {pair}\n                   </span>\n                 ))}\n               </div>\n            </div>\n          </div>\n\n          <div className=\"col-span-1 lg:col-span-6\">\n            <TradeLog />\n          </div>\n          \n          <div className=\"col-span-1 lg:col-span-6\">\n            <EventsPanel />\n          </div>\n\n        </main>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7140,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { krakenService } from \"./services/kraken\";\nimport { telegramService } from \"./services/telegram\";\nimport { TradingEngine } from \"./services/tradingEngine\";\nimport { botLogger } from \"./services/botLogger\";\nimport { aiService } from \"./services/aiService\";\nimport { eventsWs } from \"./services/eventsWebSocket\";\nimport { terminalWsServer } from \"./services/terminalWebSocket\";\nimport { environment } from \"./services/environment\";\nimport { z } from \"zod\";\n\nlet tradingEngine: TradingEngine | null = null;\n\nexport function initializeWebSockets(httpServer: Server): void {\n  eventsWs.initialize(httpServer);\n  terminalWsServer.initialize(httpServer);\n  \n  httpServer.on(\"upgrade\", (req, socket, head) => {\n    const pathname = new URL(req.url || \"\", `http://${req.headers.host}`).pathname;\n    \n    if (pathname === \"/ws/events\") {\n      eventsWs.handleUpgrade(req, socket, head);\n    } else if (pathname === \"/ws/logs\") {\n      terminalWsServer.handleUpgrade(req, socket, head);\n    } else {\n      socket.destroy();\n    }\n  });\n}\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express\n): Promise<Server> {\n  \n  // Health check endpoint - MUST be registered before any other routes\n  // Returns JSON for monitoring/load balancers (not index.html)\n  // Returns 503 on errors so monitors can detect failures\n  app.get(\"/api/health\", async (req, res) => {\n    try {\n      const schemaStatus = await storage.checkSchemaHealth();\n      if (!schemaStatus.healthy) {\n        // Schema issues - return 503 so monitors detect the problem\n        return res.status(503).json({\n          status: \"unhealthy\",\n          timestamp: new Date().toISOString(),\n          schema: schemaStatus,\n          uptime: process.uptime(),\n          message: \"Schema migration required. Missing columns: \" + schemaStatus.missingColumns.join(\", \"),\n        });\n      }\n      res.json({\n        status: \"ok\",\n        timestamp: new Date().toISOString(),\n        schema: schemaStatus,\n        uptime: process.uptime(),\n      });\n    } catch (error) {\n      // Return 503 on errors so monitors can detect failures\n      res.status(503).json({\n        status: \"error\",\n        timestamp: new Date().toISOString(),\n        error: error instanceof Error ? error.message : \"Unknown error\",\n      });\n    }\n  });\n\n  // Load saved API credentials on startup\n  try {\n    const apiConfig = await storage.getApiConfig();\n    if (apiConfig) {\n      if (apiConfig.krakenApiKey && apiConfig.krakenApiSecret && apiConfig.krakenConnected) {\n        krakenService.initialize({\n          apiKey: apiConfig.krakenApiKey,\n          apiSecret: apiConfig.krakenApiSecret,\n        });\n        console.log(\"[startup] Kraken API credentials loaded from database\");\n      }\n      if (apiConfig.telegramToken && apiConfig.telegramChatId && apiConfig.telegramConnected) {\n        telegramService.initialize({\n          token: apiConfig.telegramToken,\n          chatId: apiConfig.telegramChatId,\n        });\n        console.log(\"[startup] Telegram credentials loaded from database\");\n      }\n    }\n    \n    // Initialize trading engine\n    tradingEngine = new TradingEngine(krakenService, telegramService);\n    \n    // Set engine controller for Telegram commands\n    telegramService.setEngineController({\n      start: async () => { await tradingEngine?.start(); },\n      stop: async () => { await tradingEngine?.stop(); },\n      isActive: () => tradingEngine?.isActive() ?? false,\n      getBalance: async () => krakenService.isInitialized() ? await krakenService.getBalance() as Record<string, string> : {},\n      getOpenPositions: () => tradingEngine?.getOpenPositions() ?? new Map(),\n    });\n    \n    // Start heartbeat for Telegram notifications\n    telegramService.startHeartbeat();\n    \n    // Auto-start if bot was active\n    const botConfig = await storage.getBotConfig();\n    if (botConfig?.isActive && krakenService.isInitialized()) {\n      console.log(\"[startup] Starting trading engine...\");\n      tradingEngine.start();\n    }\n  } catch (error) {\n    console.error(\"[startup] Error loading API credentials:\", error);\n  }\n\n  app.get(\"/api/config\", async (req, res) => {\n    try {\n      const config = await storage.getBotConfig();\n      res.json(config);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get config\" });\n    }\n  });\n\n  app.post(\"/api/config\", async (req, res) => {\n    try {\n      const body = { ...req.body };\n      \n      // Validar y clampar porcentajes a rango 0-100\n      const pctFields = [\"riskPerTradePct\", \"maxPairExposurePct\", \"maxTotalExposurePct\"];\n      for (const field of pctFields) {\n        if (body[field] !== undefined) {\n          const val = parseFloat(body[field]);\n          if (isNaN(val)) {\n            return res.status(400).json({ error: `${field} debe ser un n√∫mero v√°lido` });\n          }\n          if (val < 0 || val > 100) {\n            return res.status(400).json({ error: `${field} debe estar entre 0 y 100 (valor recibido: ${val})` });\n          }\n          body[field] = val.toFixed(2);\n        }\n      }\n      \n      const updated = await storage.updateBotConfig(body);\n      \n      if (req.body.isActive !== undefined && tradingEngine) {\n        if (req.body.isActive) {\n          await tradingEngine.start();\n        } else {\n          await tradingEngine.stop();\n        }\n      }\n      \n      res.json(updated);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update config\" });\n    }\n  });\n\n  app.get(\"/api/config/api\", async (req, res) => {\n    try {\n      const config = await storage.getApiConfig();\n      res.json({\n        krakenConnected: config?.krakenConnected || false,\n        telegramConnected: config?.telegramConnected || false,\n        hasKrakenKeys: !!(config?.krakenApiKey && config?.krakenApiSecret),\n        hasTelegramKeys: !!(config?.telegramToken && config?.telegramChatId),\n      });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get API config\" });\n    }\n  });\n\n  app.get(\"/api/trading/status\", async (req, res) => {\n    try {\n      res.json({\n        engineRunning: tradingEngine?.isActive() || false,\n        krakenConnected: krakenService.isInitialized(),\n        telegramConnected: telegramService.isInitialized(),\n      });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get trading status\" });\n    }\n  });\n\n  // === DIAGN√ìSTICO DEL SCAN ===\n  app.get(\"/api/scan/diagnostic\", async (req, res) => {\n    try {\n      if (!tradingEngine) {\n        return res.status(503).json({ error: \"Motor de trading no inicializado\" });\n      }\n      const diagnostic = await tradingEngine.getScanDiagnostic();\n      res.json(diagnostic);\n    } catch (error: any) {\n      console.error(\"[scan/diagnostic] Error:\", error.message);\n      res.status(500).json({ error: \"Error obteniendo diagn√≥stico del scan\" });\n    }\n  });\n\n  app.post(\"/api/config/kraken\", async (req, res) => {\n    try {\n      const { apiKey, apiSecret } = req.body;\n      \n      if (!apiKey || !apiSecret) {\n        return res.status(400).json({ error: \"API key and secret required\" });\n      }\n\n      krakenService.initialize({ apiKey, apiSecret });\n      \n      const balance = await krakenService.getBalance();\n      \n      await storage.updateApiConfig({\n        krakenApiKey: apiKey,\n        krakenApiSecret: apiSecret,\n        krakenConnected: true,\n      });\n      \n      res.json({ success: true, message: \"Kraken connected successfully\", balance });\n    } catch (error) {\n      await storage.updateApiConfig({ krakenConnected: false });\n      res.status(500).json({ error: \"Failed to connect to Kraken\" });\n    }\n  });\n\n  app.post(\"/api/config/telegram\", async (req, res) => {\n    try {\n      const { token, chatId } = req.body;\n      \n      if (!token || !chatId) {\n        return res.status(400).json({ error: \"Token and chat ID required\" });\n      }\n\n      telegramService.initialize({ token, chatId });\n      \n      const sent = await telegramService.sendMessage(\"‚úÖ Telegram conectado correctamente!\");\n      \n      if (!sent) {\n        return res.status(500).json({ error: \"Failed to send test message\" });\n      }\n      \n      await storage.updateApiConfig({\n        telegramToken: token,\n        telegramChatId: chatId,\n        telegramConnected: true,\n      });\n      \n      res.json({ success: true, message: \"Telegram connected successfully\" });\n    } catch (error) {\n      await storage.updateApiConfig({ telegramConnected: false });\n      res.status(500).json({ error: \"Failed to connect to Telegram\" });\n    }\n  });\n\n  // === SMART_GUARD Per-Pair Overrides ===\n  const SG_OVERRIDE_SCHEMA = z.object({\n    sgMinEntryUsd: z.number().min(0).max(100000).optional(),\n    sgAllowUnderMin: z.boolean().optional(),\n    sgBeAtPct: z.number().min(0).max(100).optional(),\n    sgFeeCushionPct: z.number().min(0).max(10).optional(),\n    sgFeeCushionAuto: z.boolean().optional(),\n    sgTrailStartPct: z.number().min(0).max(100).optional(),\n    sgTrailDistancePct: z.number().min(0).max(50).optional(),\n    sgTrailStepPct: z.number().min(0).max(10).optional(),\n    sgTpFixedEnabled: z.boolean().optional(),\n    sgTpFixedPct: z.number().min(0).max(500).optional(),\n    sgScaleOutEnabled: z.boolean().optional(),\n    sgScaleOutPct: z.number().min(0).max(100).optional(),\n    sgMinPartUsd: z.number().min(0).max(10000).optional(),\n    sgScaleOutThreshold: z.number().min(0).max(100).optional(),\n  });\n\n  const TRADEABLE_PAIRS = [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\", \"XRP/USD\", \"TON/USD\"];\n\n  app.get(\"/api/config/sg-overrides\", async (req, res) => {\n    try {\n      const config = await storage.getBotConfig();\n      const overrides = (config?.sgPairOverrides as Record<string, unknown>) || {};\n      res.json({\n        pairs: TRADEABLE_PAIRS,\n        overrides,\n        global: {\n          sgMinEntryUsd: config?.sgMinEntryUsd,\n          sgAllowUnderMin: config?.sgAllowUnderMin,\n          sgBeAtPct: config?.sgBeAtPct,\n          sgFeeCushionPct: config?.sgFeeCushionPct,\n          sgFeeCushionAuto: config?.sgFeeCushionAuto,\n          sgTrailStartPct: config?.sgTrailStartPct,\n          sgTrailDistancePct: config?.sgTrailDistancePct,\n          sgTrailStepPct: config?.sgTrailStepPct,\n          sgTpFixedEnabled: config?.sgTpFixedEnabled,\n          sgTpFixedPct: config?.sgTpFixedPct,\n          sgScaleOutEnabled: config?.sgScaleOutEnabled,\n          sgScaleOutPct: config?.sgScaleOutPct,\n          sgMinPartUsd: config?.sgMinPartUsd,\n          sgScaleOutThreshold: config?.sgScaleOutThreshold,\n        },\n      });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get SG overrides\" });\n    }\n  });\n\n  app.put(\"/api/config/sg-overrides/:pair\", async (req, res) => {\n    try {\n      // Normalize pair: accept both BTC-USD and BTC/USD in URL\n      const pairRaw = decodeURIComponent(req.params.pair).replace(/-/g, \"/\");\n      if (!TRADEABLE_PAIRS.includes(pairRaw)) {\n        return res.status(400).json({ error: `Par inv√°lido: ${pairRaw}` });\n      }\n\n      // Coerce string values to numbers where expected\n      const body = { ...req.body };\n      for (const key of Object.keys(body)) {\n        if (typeof body[key] === \"string\" && ![\"sgAllowUnderMin\", \"sgFeeCushionAuto\", \"sgTpFixedEnabled\", \"sgScaleOutEnabled\"].includes(key)) {\n          const num = parseFloat(body[key]);\n          if (!isNaN(num)) body[key] = num;\n        }\n      }\n\n      const parsed = SG_OVERRIDE_SCHEMA.safeParse(body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"Datos inv√°lidos\", details: parsed.error.flatten() });\n      }\n\n      const config = await storage.getBotConfig();\n      const currentOverrides = (config?.sgPairOverrides as Record<string, unknown>) || {};\n      const existingPair = (currentOverrides[pairRaw] as Record<string, unknown>) || {};\n      \n      // Merge with existing override for this pair\n      const newPairOverride = { ...existingPair, ...parsed.data };\n      const newOverrides = { ...currentOverrides, [pairRaw]: newPairOverride };\n\n      await storage.updateBotConfig({ sgPairOverrides: newOverrides });\n\n      // Log the change\n      const envInfo = environment.getInfo();\n      await botLogger.info(\"CONFIG_OVERRIDE_UPDATED\", `Override actualizado para ${pairRaw}`, {\n        pair: pairRaw,\n        changedKeys: Object.keys(parsed.data),\n        env: envInfo.env,\n        instanceId: envInfo.instanceId,\n      });\n\n      res.json({ success: true, pair: pairRaw, override: newPairOverride });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update SG override\" });\n    }\n  });\n\n  app.delete(\"/api/config/sg-overrides/:pair\", async (req, res) => {\n    try {\n      // Normalize pair: accept both BTC-USD and BTC/USD in URL\n      const pairRaw = decodeURIComponent(req.params.pair).replace(/-/g, \"/\");\n      if (!TRADEABLE_PAIRS.includes(pairRaw)) {\n        return res.status(400).json({ error: `Par inv√°lido: ${pairRaw}` });\n      }\n\n      const config = await storage.getBotConfig();\n      const currentOverrides = (config?.sgPairOverrides as Record<string, unknown>) || {};\n      \n      if (!(pairRaw in currentOverrides)) {\n        return res.status(404).json({ error: `No hay override para ${pairRaw}` });\n      }\n\n      const { [pairRaw]: removed, ...newOverrides } = currentOverrides;\n      await storage.updateBotConfig({ sgPairOverrides: newOverrides });\n\n      // Log the change\n      const envInfo = environment.getInfo();\n      await botLogger.info(\"CONFIG_OVERRIDE_UPDATED\", `Override eliminado para ${pairRaw}`, {\n        pair: pairRaw,\n        changedKeys: [\"DELETED\"],\n        env: envInfo.env,\n        instanceId: envInfo.instanceId,\n      });\n\n      res.json({ success: true, pair: pairRaw, message: \"Override eliminado\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete SG override\" });\n    }\n  });\n\n  app.post(\"/api/telegram/send\", async (req, res) => {\n    try {\n      const { message } = req.body;\n      \n      if (!message) {\n        return res.status(400).json({ error: \"Mensaje requerido\" });\n      }\n\n      if (!telegramService.isInitialized()) {\n        return res.status(400).json({ error: \"Telegram no est√° configurado\" });\n      }\n\n      const sent = await telegramService.sendMessage(message);\n      \n      if (!sent) {\n        return res.status(500).json({ error: \"Error enviando mensaje\" });\n      }\n      \n      res.json({ success: true, message: \"Mensaje enviado\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Error enviando mensaje a Telegram\" });\n    }\n  });\n\n  app.get(\"/api/telegram/chats\", async (req, res) => {\n    try {\n      const chats = await storage.getTelegramChats();\n      res.json(chats);\n    } catch (error) {\n      res.status(500).json({ error: \"Error obteniendo chats\" });\n    }\n  });\n\n  app.post(\"/api/telegram/chats\", async (req, res) => {\n    try {\n      const { name, chatId, alertTrades, alertErrors, alertSystem, alertBalance } = req.body;\n      \n      if (!name || !chatId) {\n        return res.status(400).json({ error: \"Nombre y Chat ID son requeridos\" });\n      }\n\n      if (!telegramService.isInitialized()) {\n        return res.status(400).json({ error: \"Telegram no est√° configurado. Configura primero el token principal.\" });\n      }\n\n      const existingChats = await storage.getTelegramChats();\n      const duplicate = existingChats.find(c => c.chatId === chatId);\n      if (duplicate) {\n        return res.status(400).json({ error: \"Este Chat ID ya est√° configurado.\" });\n      }\n\n      const testSent = await telegramService.sendToChat(chatId, \"‚úÖ Chat configurado correctamente en KrakenBot!\");\n      if (!testSent) {\n        return res.status(400).json({ error: \"No se pudo enviar mensaje al chat. Verifica el Chat ID.\" });\n      }\n\n      const chat = await storage.createTelegramChat({\n        name,\n        chatId,\n        alertTrades: alertTrades ?? true,\n        alertErrors: alertErrors ?? true,\n        alertSystem: alertSystem ?? true,\n        alertBalance: alertBalance ?? false,\n        isActive: true,\n      });\n      \n      res.json(chat);\n    } catch (error) {\n      res.status(500).json({ error: \"Error creando chat\" });\n    }\n  });\n\n  app.put(\"/api/telegram/chats/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { name, chatId, alertTrades, alertErrors, alertSystem, alertBalance, isActive } = req.body;\n      \n      const chat = await storage.updateTelegramChat(id, {\n        name,\n        chatId,\n        alertTrades,\n        alertErrors,\n        alertSystem,\n        alertBalance,\n        isActive,\n      });\n      \n      res.json(chat);\n    } catch (error) {\n      res.status(500).json({ error: \"Error actualizando chat\" });\n    }\n  });\n\n  app.delete(\"/api/telegram/chats/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteTelegramChat(id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Error eliminando chat\" });\n    }\n  });\n\n  app.get(\"/api/dashboard\", async (req, res) => {\n    try {\n      const apiConfig = await storage.getApiConfig();\n      const botConfig = await storage.getBotConfig();\n      const trades = await storage.getTrades(10);\n      \n      let balances: Record<string, string> = {};\n      let prices: Record<string, { price: string; change: string }> = {};\n      \n      if (krakenService.isInitialized()) {\n        try {\n          balances = await krakenService.getBalance() as Record<string, string>;\n          \n          const pairs = [\"XXBTZUSD\", \"XETHZUSD\", \"SOLUSD\", \"XXRPZUSD\", \"TONUSD\"];\n          for (const pair of pairs) {\n            try {\n              const ticker = await krakenService.getTicker(pair);\n              const tickerData: any = Object.values(ticker)[0];\n              if (tickerData) {\n                const currentPrice = parseFloat(tickerData.c?.[0] || \"0\");\n                const openPrice = parseFloat(tickerData.o || \"0\");\n                const change = openPrice > 0 ? ((currentPrice - openPrice) / openPrice * 100).toFixed(2) : \"0\";\n                prices[pair] = { price: tickerData.c?.[0] || \"0\", change };\n              }\n            } catch (e) {}\n          }\n        } catch (e) {}\n      }\n      \n      res.json({\n        krakenConnected: apiConfig?.krakenConnected || false,\n        telegramConnected: apiConfig?.telegramConnected || false,\n        botActive: botConfig?.isActive || false,\n        strategy: botConfig?.strategy || \"momentum\",\n        activePairs: botConfig?.activePairs || [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\"],\n        balances,\n        prices,\n        recentTrades: trades,\n      });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get dashboard data\" });\n    }\n  });\n\n  app.get(\"/api/trades\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const trades = await storage.getTrades(limit);\n      res.json(trades);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get trades\" });\n    }\n  });\n\n  app.get(\"/api/open-positions\", async (req, res) => {\n    try {\n      const positions = await storage.getOpenPositions();\n      \n      const positionsWithPnl = await Promise.all(positions.map(async (pos) => {\n        let currentPrice = 0;\n        let unrealizedPnlUsd = 0;\n        let unrealizedPnlPct = 0;\n        \n        if (krakenService.isInitialized()) {\n          try {\n            const krakenPair = krakenService.formatPair(pos.pair);\n            const ticker = await krakenService.getTicker(krakenPair);\n            const tickerData: any = Object.values(ticker)[0];\n            if (tickerData?.c?.[0]) {\n              currentPrice = parseFloat(tickerData.c[0]);\n              const entryPrice = parseFloat(pos.entryPrice);\n              const amount = parseFloat(pos.amount);\n              unrealizedPnlUsd = (currentPrice - entryPrice) * amount;\n              unrealizedPnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;\n            }\n          } catch (e) {}\n        }\n        \n        const amount = parseFloat(pos.amount);\n        const entryPrice = parseFloat(pos.entryPrice);\n        const entryValueUsd = entryPrice * amount;\n        const currentValueUsd = currentPrice * amount;\n        \n        return {\n          ...pos,\n          currentPrice: currentPrice.toString(),\n          unrealizedPnlUsd: unrealizedPnlUsd.toFixed(2),\n          unrealizedPnlPct: unrealizedPnlPct.toFixed(2),\n          entryValueUsd: entryValueUsd.toFixed(2),\n          currentValueUsd: currentValueUsd.toFixed(2),\n        };\n      }));\n      \n      res.json(positionsWithPnl);\n    } catch (error) {\n      console.error(\"[api/open-positions] Error:\", error);\n      res.status(500).json({ error: \"Failed to get open positions\" });\n    }\n  });\n\n  // === CIERRE MANUAL DE POSICI√ìN ===\n  app.post(\"/api/positions/:pair/close\", async (req, res) => {\n    try {\n      const pair = req.params.pair.replace(\"-\", \"/\"); // Convert BTC-USD back to BTC/USD\n      const { reason, lotId } = req.body; // Optional lotId for multi-lot support\n      \n      const correlationId = `MANUAL-CLOSE-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;\n      \n      // Verificar que la posici√≥n existe\n      const positions = await storage.getOpenPositions();\n      let position;\n      if (lotId) {\n        // Specific lot requested\n        position = positions.find(p => p.lotId === lotId);\n      } else {\n        // Close first position for the pair\n        position = positions.find(p => p.pair === pair);\n      }\n      \n      if (!position) {\n        await botLogger.warn(\"MANUAL_CLOSE_FAILED\", `Intento de cierre manual fallido - posici√≥n no encontrada`, {\n          pair,\n          lotId: lotId || \"not_specified\",\n          correlationId,\n          reason: reason || \"Usuario solicit√≥ cierre manual\",\n        });\n        \n        return res.status(404).json({\n          success: false,\n          error: \"POSITION_NOT_FOUND\",\n          message: `No se encontr√≥ posici√≥n abierta para ${pair}`,\n        });\n      }\n      \n      // Obtener precio actual (con fallback para DRY_RUN)\n      let currentPrice: number;\n      const botConfig = await storage.getBotConfig();\n      const isDryRun = botConfig?.dryRunMode || environment.isReplit;\n      \n      if (krakenService.isInitialized()) {\n        try {\n          const krakenPair = krakenService.formatPair(pair);\n          const ticker = await krakenService.getTicker(krakenPair);\n          const tickerData: any = Object.values(ticker)[0];\n          \n          if (tickerData?.c?.[0]) {\n            currentPrice = parseFloat(tickerData.c[0]);\n          } else {\n            throw new Error(\"No ticker data\");\n          }\n        } catch (e) {\n          if (!isDryRun) {\n            return res.status(500).json({\n              success: false,\n              error: \"PRICE_UNAVAILABLE\",\n              message: \"No se pudo obtener el precio actual\",\n            });\n          }\n          // En DRY_RUN, usar precio de entrada como fallback\n          currentPrice = parseFloat(position.entryPrice);\n        }\n      } else {\n        if (!isDryRun) {\n          return res.status(503).json({\n            success: false,\n            error: \"KRAKEN_NOT_INITIALIZED\",\n            message: \"Kraken API no est√° conectada\",\n          });\n        }\n        // En DRY_RUN, usar precio de entrada como fallback (simulaci√≥n)\n        currentPrice = parseFloat(position.entryPrice);\n      }\n      const amount = parseFloat(position.amount);\n      const entryPrice = parseFloat(position.entryPrice);\n      const pnlUsd = (currentPrice - entryPrice) * amount;\n      const pnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;\n      \n      const positionLotId = position.lotId;\n      \n      // Log el intento de cierre manual\n      await botLogger.info(\"MANUAL_CLOSE_INITIATED\", `Cierre manual iniciado por usuario`, {\n        correlationId,\n        pair,\n        lotId: positionLotId,\n        amount,\n        entryPrice,\n        currentPrice,\n        estimatedPnlUsd: pnlUsd.toFixed(2),\n        estimatedPnlPct: pnlPct.toFixed(2),\n        reason: reason || \"Usuario solicit√≥ cierre manual\",\n      });\n      \n      // Ejecutar la venta a trav√©s del trading engine\n      if (!tradingEngine) {\n        return res.status(503).json({\n          success: false,\n          error: \"ENGINE_NOT_RUNNING\",\n          message: \"Motor de trading no est√° activo\",\n        });\n      }\n      \n      const closeResult = await tradingEngine.forceClosePosition(pair, currentPrice, correlationId, reason || \"Cierre manual por usuario\", positionLotId);\n      \n      if (closeResult.success) {\n        await botLogger.info(\"MANUAL_CLOSE_SUCCESS\", `Posici√≥n cerrada manualmente`, {\n          correlationId,\n          pair,\n          lotId: closeResult.lotId || positionLotId,\n          amount,\n          exitPrice: currentPrice,\n          realizedPnlUsd: closeResult.pnlUsd?.toFixed(2),\n          realizedPnlPct: closeResult.pnlPct?.toFixed(2),\n          krakenOrderId: closeResult.orderId,\n          dryRun: closeResult.dryRun,\n        });\n        \n        res.json({\n          success: true,\n          correlationId,\n          pair,\n          lotId: closeResult.lotId || positionLotId,\n          amount,\n          exitPrice: currentPrice,\n          realizedPnlUsd: closeResult.pnlUsd?.toFixed(2),\n          realizedPnlPct: closeResult.pnlPct?.toFixed(2),\n          orderId: closeResult.orderId,\n          message: closeResult.dryRun \n            ? `[DRY_RUN] Cierre simulado de ${pair}`\n            : `Posici√≥n ${pair} cerrada exitosamente`,\n        });\n      } else {\n        // Caso DUST: devolver 200 con flag isDust para que UI ofrezca \"Eliminar hu√©rfana\"\n        if (closeResult.isDust) {\n          await botLogger.warn(\"MANUAL_CLOSE_DUST\", `Posici√≥n DUST detectada - no se puede cerrar`, {\n            correlationId,\n            pair,\n            lotId: positionLotId,\n            error: closeResult.error,\n          });\n          \n          return res.json({\n            success: false,\n            correlationId,\n            error: \"DUST_POSITION\",\n            isDust: true,\n            lotId: positionLotId,\n            message: closeResult.error || \"Balance real menor al m√≠nimo de Kraken\",\n          });\n        }\n        \n        await botLogger.error(\"MANUAL_CLOSE_FAILED\", `Error al cerrar posici√≥n manualmente`, {\n          correlationId,\n          pair,\n          lotId: positionLotId,\n          error: closeResult.error,\n        });\n        \n        res.status(500).json({\n          success: false,\n          correlationId,\n          error: \"CLOSE_FAILED\",\n          message: closeResult.error || \"Error al cerrar la posici√≥n\",\n        });\n      }\n      \n    } catch (error: any) {\n      const pair = req.params.pair?.replace(\"-\", \"/\") || \"UNKNOWN\";\n      const { lotId } = req.body || {};\n      const botConfigErr = await storage.getBotConfig();\n      const isDryRunErr = botConfigErr?.dryRunMode || environment.isReplit;\n      \n      console.error(\"[api/positions/close] FULL ERROR:\", {\n        message: error.message,\n        stack: error.stack,\n        pair,\n        lotId: lotId || \"not_specified\",\n        isDryRun: isDryRunErr,\n        timestamp: new Date().toISOString(),\n      });\n      \n      await botLogger.error(\"MANUAL_CLOSE_EXCEPTION\", `Excepci√≥n no controlada en cierre manual`, {\n        pair,\n        lotId: lotId || \"not_specified\",\n        isDryRun: isDryRunErr,\n        errorMessage: error.message,\n        errorStack: error.stack,\n      });\n      \n      res.status(500).json({\n        success: false,\n        error: \"INTERNAL_ERROR\",\n        message: `Error al procesar cierre: ${error.message}`,\n        stack: process.env.NODE_ENV === \"development\" ? error.stack : undefined,\n      });\n    }\n  });\n\n  // === ELIMINAR POSICI√ìN HU√âRFANA (DUST) ===\n  // Solo elimina el registro interno de DB/memoria, NO env√≠a orden a Kraken\n  app.delete(\"/api/positions/:lotId/orphan\", async (req, res) => {\n    try {\n      const lotId = req.params.lotId;\n      const { reason } = req.body || {};\n      \n      // Verificar que la posici√≥n existe en DB\n      const dbPosition = await storage.getOpenPositionByLotId(lotId);\n      if (!dbPosition) {\n        return res.status(404).json({\n          success: false,\n          error: \"POSITION_NOT_FOUND\",\n          message: `No se encontr√≥ posici√≥n con lotId: ${lotId}`,\n        });\n      }\n      \n      const pair = dbPosition.pair;\n      \n      // Eliminar de DB\n      await storage.deleteOpenPositionByLotId(lotId);\n      \n      // Eliminar de memoria del trading engine\n      if (tradingEngine) {\n        const positions = tradingEngine.getOpenPositions();\n        positions.delete(lotId);\n      }\n      \n      await botLogger.info(\"ORPHAN_POSITION_DELETED\", `Posici√≥n hu√©rfana eliminada manualmente`, {\n        pair,\n        lotId,\n        amount: dbPosition.amount,\n        entryPrice: dbPosition.entryPrice,\n        reason: reason || \"orphan_dust_cleanup\",\n        env: environment.isReplit ? \"REPLIT\" : \"NAS\",\n      });\n      \n      // Notificar por Telegram\n      if (telegramService?.isInitialized()) {\n        await telegramService.sendMessage(`\nüóëÔ∏è *Posici√≥n Hu√©rfana Eliminada*\n\n*Par:* ${pair}\n*Lot:* \\`${lotId.substring(0, 8)}...\\`\n*Cantidad:* ${dbPosition.amount}\n\n_Eliminada manualmente desde dashboard (sin orden a Kraken)_\n        `.trim());\n      }\n      \n      res.json({\n        success: true,\n        lotId,\n        pair,\n        deleted: true,\n        message: `Posici√≥n hu√©rfana eliminada de BD`,\n      });\n      \n    } catch (error: any) {\n      console.error(\"[api/positions/orphan] Error:\", error.message);\n      res.status(500).json({\n        success: false,\n        error: \"INTERNAL_ERROR\",\n        message: error.message,\n      });\n    }\n  });\n\n  // === RECONCILIAR POSICIONES CON KRAKEN ===\n  // Compara balances reales con posiciones en BD y elimina hu√©rfanas\n  app.post(\"/api/positions/reconcile\", async (req, res) => {\n    try {\n      if (!krakenService) {\n        return res.status(503).json({ \n          success: false, \n          error: \"Kraken service not initialized\" \n        });\n      }\n\n      // Obtener todas las posiciones abiertas de BD\n      const openPositions = await storage.getOpenPositions();\n      if (openPositions.length === 0) {\n        return res.json({\n          success: true,\n          message: \"No hay posiciones abiertas en BD\",\n          reconciled: 0,\n          orphans: [],\n        });\n      }\n\n      // Obtener balances reales de Kraken\n      const balances = await krakenService.getBalance() as Record<string, string>;\n      \n      // M√≠nimos de orden por par (hardcoded ya que getAssetPairs es para todos los pares)\n      const orderMinMap: Record<string, number> = {\n        \"BTC/USD\": 0.0001,\n        \"ETH/USD\": 0.004,\n        \"SOL/USD\": 0.2,\n        \"XRP/USD\": 10,\n        \"TON/USD\": 10,\n      };\n      \n      // Obtener m√≠nimos de orden por par\n      const orphanPositions: Array<{ lotId: string; pair: string; amount: string; reason: string }> = [];\n      const validPositions: Array<{ lotId: string; pair: string; amount: string }> = [];\n      \n      for (const pos of openPositions) {\n        const assetMap: Record<string, string> = {\n          \"BTC/USD\": \"XXBT\",\n          \"ETH/USD\": \"XETH\",\n          \"SOL/USD\": \"SOL\",\n          \"XRP/USD\": \"XXRP\",\n          \"TON/USD\": \"TON\",\n        };\n        const assetKey = assetMap[pos.pair];\n        if (!assetKey) {\n          // Par desconocido, marcar como hu√©rfana\n          orphanPositions.push({\n            lotId: pos.lotId,\n            pair: pos.pair,\n            amount: pos.amount,\n            reason: \"Par no reconocido\",\n          });\n          continue;\n        }\n\n        const realBalance = parseFloat(balances[assetKey] || \"0\");\n        const positionAmount = parseFloat(pos.amount);\n        \n        // Obtener m√≠nimo de orden para este par\n        const orderMin = orderMinMap[pos.pair] || 0.0001;\n        \n        // Si el balance real es menor al m√≠nimo de orden, es hu√©rfana\n        if (realBalance < orderMin) {\n          orphanPositions.push({\n            lotId: pos.lotId,\n            pair: pos.pair,\n            amount: pos.amount,\n            reason: `Balance real (${realBalance.toFixed(8)}) < m√≠nimo (${orderMin})`,\n          });\n        } else {\n          validPositions.push({\n            lotId: pos.lotId,\n            pair: pos.pair,\n            amount: pos.amount,\n          });\n        }\n      }\n\n      // Auto-limpiar hu√©rfanas si se solicita\n      const autoClean = req.body?.autoClean === true;\n      let cleaned = 0;\n      \n      if (autoClean && orphanPositions.length > 0) {\n        for (const orphan of orphanPositions) {\n          try {\n            await storage.deleteOpenPositionByLotId(orphan.lotId);\n            if (tradingEngine) {\n              tradingEngine.getOpenPositions().delete(orphan.lotId);\n            }\n            cleaned++;\n          } catch (err) {\n            console.error(`Error limpiando hu√©rfana ${orphan.lotId}:`, err);\n          }\n        }\n        \n        await botLogger.info(\"ORPHAN_POSITION_DELETED\", `Reconciliaci√≥n completada`, {\n          total: openPositions.length,\n          orphans: orphanPositions.length,\n          cleaned,\n          valid: validPositions.length,\n        });\n        \n        if (telegramService?.isInitialized()) {\n          await telegramService.sendMessage(`\nüîÑ *Reconciliaci√≥n Completada*\n\n*Total posiciones:* ${openPositions.length}\n*Hu√©rfanas eliminadas:* ${cleaned}\n*V√°lidas:* ${validPositions.length}\n          `.trim());\n        }\n      }\n\n      res.json({\n        success: true,\n        total: openPositions.length,\n        orphans: orphanPositions,\n        valid: validPositions,\n        cleaned,\n        message: autoClean \n          ? `Reconciliaci√≥n completada: ${cleaned} hu√©rfanas eliminadas`\n          : `Encontradas ${orphanPositions.length} posiciones hu√©rfanas`,\n      });\n      \n    } catch (error: any) {\n      console.error(\"[api/positions/reconcile] Error:\", error.message);\n      res.status(500).json({\n        success: false,\n        error: \"INTERNAL_ERROR\",\n        message: error.message,\n      });\n    }\n  });\n\n  app.get(\"/api/trades/closed\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 10;\n      const offset = parseInt(req.query.offset as string) || 0;\n      const pair = req.query.pair as string | undefined;\n      const result = (req.query.result as 'winner' | 'loser' | 'all') || 'all';\n      const type = (req.query.type as 'all' | 'buy' | 'sell') || 'all';\n      \n      const { trades, total } = await storage.getClosedTrades({ limit, offset, pair, result, type });\n      \n      res.json({\n        trades: trades.map(t => {\n          const price = parseFloat(t.price);\n          const amount = parseFloat(t.amount);\n          const totalUsd = price * amount;\n          const entryValueUsd = t.entryPrice ? parseFloat(t.entryPrice) * amount : null;\n          \n          return {\n            ...t,\n            totalUsd: totalUsd.toFixed(2),\n            entryValueUsd: entryValueUsd?.toFixed(2) || null,\n            realizedPnlUsd: t.realizedPnlUsd ? parseFloat(t.realizedPnlUsd).toFixed(2) : null,\n            realizedPnlPct: t.realizedPnlPct ? parseFloat(t.realizedPnlPct).toFixed(2) : null,\n          };\n        }),\n        total,\n        limit,\n        offset,\n      });\n    } catch (error) {\n      console.error(\"[api/trades/closed] Error:\", error);\n      res.status(500).json({ error: \"Failed to get closed trades\" });\n    }\n  });\n\n  app.get(\"/api/performance\", async (req, res) => {\n    try {\n      const trades = await storage.getTrades(500);\n      \n      const STARTING_EQUITY = 1000;\n      \n      const sortedTrades = [...trades].sort((a, b) => {\n        const dateA = a.executedAt ? new Date(a.executedAt).getTime() : new Date(a.createdAt).getTime();\n        const dateB = b.executedAt ? new Date(b.executedAt).getTime() : new Date(b.createdAt).getTime();\n        return dateA - dateB;\n      });\n\n      const pairPrices: Record<string, { lastBuyPrice: number; lastBuyAmount: number }> = {};\n      let currentEquity = STARTING_EQUITY;\n      let totalPnl = 0;\n      let wins = 0;\n      let losses = 0;\n      let maxEquity = STARTING_EQUITY;\n      let maxDrawdown = 0;\n\n      const firstTradeTime = sortedTrades.length > 0 \n        ? new Date(sortedTrades[0].executedAt || sortedTrades[0].createdAt).toISOString()\n        : new Date().toISOString();\n      \n      const curve: { time: string; equity: number; pnl?: number }[] = [\n        { time: firstTradeTime, equity: STARTING_EQUITY }\n      ];\n\n      for (const trade of sortedTrades) {\n        const pair = trade.pair;\n        const price = parseFloat(trade.price);\n        const amount = parseFloat(trade.amount);\n        const time = trade.executedAt ? new Date(trade.executedAt).toISOString() : new Date(trade.createdAt).toISOString();\n\n        if (trade.type === \"buy\") {\n          pairPrices[pair] = { lastBuyPrice: price, lastBuyAmount: amount };\n        } else if (trade.type === \"sell\") {\n          const lastBuy = pairPrices[pair];\n          if (lastBuy && lastBuy.lastBuyPrice > 0) {\n            const pnl = (price - lastBuy.lastBuyPrice) * Math.min(amount, lastBuy.lastBuyAmount);\n            totalPnl += pnl;\n            currentEquity += pnl;\n\n            if (pnl > 0) wins++;\n            else if (pnl < 0) losses++;\n\n            curve.push({ time, equity: currentEquity, pnl });\n\n            if (currentEquity > maxEquity) maxEquity = currentEquity;\n            const drawdown = ((maxEquity - currentEquity) / maxEquity) * 100;\n            if (drawdown > maxDrawdown) maxDrawdown = drawdown;\n\n            delete pairPrices[pair];\n          }\n        }\n      }\n\n      const totalTrades = wins + losses;\n      const winRatePct = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;\n      const totalPnlPct = (totalPnl / STARTING_EQUITY) * 100;\n\n      res.json({\n        curve,\n        summary: {\n          startingEquity: STARTING_EQUITY,\n          endingEquity: currentEquity,\n          totalPnlUsd: totalPnl,\n          totalPnlPct,\n          maxDrawdownPct: maxDrawdown,\n          winRatePct,\n          totalTrades,\n          wins,\n          losses\n        }\n      });\n    } catch (error) {\n      console.error(\"Error calculating performance:\", error);\n      res.status(500).json({ error: \"Failed to calculate performance\" });\n    }\n  });\n\n  app.get(\"/api/market/:pair\", async (req, res) => {\n    try {\n      const { pair } = req.params;\n      const ticker = await krakenService.getTicker(pair);\n      \n      const tickerData: any = Object.values(ticker)[0] || {};\n      const data = await storage.saveMarketData({\n        pair,\n        price: tickerData.c?.[0] || \"0\",\n        volume24h: tickerData.v?.[1] || \"0\",\n        change24h: \"0\",\n      });\n      \n      res.json(data);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get market data\" });\n    }\n  });\n\n  app.get(\"/api/balance\", async (req, res) => {\n    try {\n      if (!krakenService.isInitialized()) {\n        return res.status(400).json({ error: \"Kraken not configured\" });\n      }\n      \n      const balance = await krakenService.getBalance();\n      res.json(balance);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get balance\" });\n    }\n  });\n\n  app.post(\"/api/trade\", async (req, res) => {\n    try {\n      if (!krakenService.isInitialized()) {\n        return res.status(400).json({ error: \"Kraken not configured\" });\n      }\n\n      const { pair, type, ordertype, volume, price } = req.body;\n      \n      const tradeId = `T-${Date.now()}`;\n      \n      const trade = await storage.createTrade({\n        tradeId,\n        pair,\n        type,\n        price: price || \"0\",\n        amount: volume,\n        status: \"pending\",\n      });\n\n      const order = await krakenService.placeOrder({\n        pair,\n        type,\n        ordertype,\n        volume,\n        price,\n      });\n\n      await storage.updateTradeStatus(tradeId, \"filled\", (order as any).txid?.[0]);\n      \n      await telegramService.sendTradeNotification({\n        type,\n        pair,\n        price: price || \"market\",\n        amount: volume,\n        status: \"filled\",\n      });\n\n      res.json({ success: true, trade, order });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to place trade\" });\n    }\n  });\n\n  app.get(\"/api/notifications\", async (req, res) => {\n    try {\n      const notifications = await storage.getUnsentNotifications();\n      res.json(notifications);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to get notifications\" });\n    }\n  });\n\n  app.post(\"/api/trades/sync\", async (req, res) => {\n    try {\n      if (!krakenService.isInitialized()) {\n        return res.status(400).json({ error: \"Kraken not configured\" });\n      }\n\n      // Obtener todo el historial de trades con paginaci√≥n\n      const tradesHistory = await krakenService.getTradesHistory({ fetchAll: true });\n      const krakenTrades = tradesHistory.trades || {};\n      \n      let synced = 0;\n      let skipped = 0;\n      const errors: string[] = [];\n      \n      // Agrupar trades por par para c√°lculo de P&L\n      const tradesByPair: Record<string, { buys: any[]; sells: any[] }> = {};\n      \n      for (const [txid, trade] of Object.entries(krakenTrades)) {\n        const t = trade as any;\n        const pair = krakenService.formatPairReverse(t.pair);\n        \n        if (!tradesByPair[pair]) {\n          tradesByPair[pair] = { buys: [], sells: [] };\n        }\n        \n        const tradeData = {\n          txid,\n          pair,\n          type: t.type,\n          price: parseFloat(t.price),\n          amount: parseFloat(t.vol),\n          cost: parseFloat(t.cost),\n          fee: parseFloat(t.fee),\n          time: new Date(t.time * 1000),\n        };\n        \n        if (t.type === 'buy') {\n          tradesByPair[pair].buys.push(tradeData);\n        } else {\n          tradesByPair[pair].sells.push(tradeData);\n        }\n        \n        try {\n          // === FIX DUPLICADOS: Verificar tanto fill ID como order ID ===\n          // El bot guarda con ORDER ID (de placeOrder), sync recibe FILL ID (de tradesHistory)\n          // ordertxid es el ID de la orden que gener√≥ este fill\n          const ordertxid = t.ordertxid;\n          \n          // Primero verificar si ya existe por ORDER ID (lo que guard√≥ el bot)\n          if (ordertxid) {\n            const existingByOrderId = await storage.getTradeByKrakenOrderId(ordertxid);\n            if (existingByOrderId) {\n              skipped++;\n              continue; // Ya existe, saltar\n            }\n          }\n          \n          // Luego verificar por FILL ID (para idempotencia del sync)\n          const result = await storage.upsertTradeByKrakenId({\n            tradeId: `KRAKEN-${txid}`,\n            pair,\n            type: t.type,\n            price: t.price,\n            amount: t.vol,\n            status: \"filled\",\n            krakenOrderId: txid,\n            executedAt: new Date(t.time * 1000),\n          });\n          \n          if (result.inserted) {\n            synced++;\n          } else {\n            skipped++;\n          }\n        } catch (e: any) {\n          errors.push(`${txid}: ${e.message}`);\n        }\n      }\n      \n      // Calcular P&L para SELLs emparej√°ndolos con BUYs (FIFO)\n      let pnlCalculated = 0;\n      for (const [pair, trades] of Object.entries(tradesByPair)) {\n        // Ordenar por tiempo\n        trades.buys.sort((a, b) => a.time.getTime() - b.time.getTime());\n        trades.sells.sort((a, b) => a.time.getTime() - b.time.getTime());\n        \n        let buyIndex = 0;\n        let buyRemaining = trades.buys[0]?.amount || 0;\n        \n        for (const sell of trades.sells) {\n          let sellRemaining = sell.amount;\n          let totalCost = 0;\n          let totalAmount = 0;\n          let totalBuyFees = 0; // Accumulated buy-side fees for matched portion\n          \n          // Emparejar con BUYs (FIFO)\n          while (sellRemaining > 0 && buyIndex < trades.buys.length) {\n            const buy = trades.buys[buyIndex];\n            const matchAmount = Math.min(buyRemaining, sellRemaining);\n            \n            // Pro-rate buy fee based on matched portion\n            const buyFeeForMatch = (matchAmount / buy.amount) * buy.fee;\n            \n            totalCost += matchAmount * buy.price;\n            totalAmount += matchAmount;\n            totalBuyFees += buyFeeForMatch;\n            \n            sellRemaining -= matchAmount;\n            buyRemaining -= matchAmount;\n            \n            if (buyRemaining <= 0.00000001) {\n              buyIndex++;\n              buyRemaining = trades.buys[buyIndex]?.amount || 0;\n            }\n          }\n          \n          // Only calculate P&L for matched portion\n          if (totalAmount > 0) {\n            const avgEntryPrice = totalCost / totalAmount;\n            // Use totalAmount (matched) not sell.amount for revenue calculation\n            const revenue = totalAmount * sell.price;\n            const cost = totalCost;\n            // Include both buy and sell fees in net P&L\n            const totalFees = totalBuyFees + sell.fee;\n            const pnlGross = revenue - cost;\n            const pnlNet = pnlGross - totalFees;\n            const pnlPct = cost > 0 ? (pnlGross / cost) * 100 : 0;\n            \n            // Actualizar el trade SELL con P&L\n            const existingSell = await storage.getTradeByKrakenOrderId(sell.txid);\n            if (existingSell && (!existingSell.realizedPnlUsd || existingSell.realizedPnlUsd === null)) {\n              await storage.updateTradePnl(\n                existingSell.id,\n                avgEntryPrice.toFixed(8),\n                pnlNet.toFixed(8),  // Use net P&L (after all fees)\n                pnlPct.toFixed(4)\n              );\n              pnlCalculated++;\n            }\n          }\n        }\n      }\n\n      // Nota: El cierre autom√°tico de posiciones abiertas requiere tracking de volumen\n      // acumulado (parciales) y se manejar√° via endpoints separados o manualmente.\n      // El sync solo registra trades y calcula P&L.\n\n      res.json({ \n        success: true, \n        synced, \n        skipped,\n        pnlCalculated,\n        total: Object.keys(krakenTrades).length,\n        errors: errors.length > 0 ? errors.slice(0, 10) : undefined,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to sync trades\" });\n    }\n  });\n\n  // Endpoint para limpiar duplicados existentes\n  app.post(\"/api/trades/cleanup-duplicates\", async (req, res) => {\n    try {\n      const duplicates = await storage.getDuplicateTradesByKrakenId();\n      \n      if (duplicates.length === 0) {\n        return res.json({ success: true, message: \"No hay duplicados\", deleted: 0 });\n      }\n      \n      const deleted = await storage.deleteDuplicateTrades();\n      \n      res.json({ \n        success: true, \n        duplicatesFound: duplicates.length,\n        deleted,\n        details: duplicates.slice(0, 20),\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to cleanup duplicates\" });\n    }\n  });\n\n  // Endpoint para ver duplicados sin eliminar\n  app.get(\"/api/trades/duplicates\", async (req, res) => {\n    try {\n      const duplicates = await storage.getDuplicateTradesByKrakenId();\n      res.json({ \n        count: duplicates.length,\n        duplicates: duplicates.slice(0, 50),\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to get duplicates\" });\n    }\n  });\n\n  // FIFO Matcher endpoints\n  app.post(\"/api/fifo/init-lots\", async (req, res) => {\n    try {\n      const { fifoMatcher } = await import(\"./services/fifoMatcher\");\n      const initialized = await fifoMatcher.initializeLots();\n      res.json({ success: true, lotsInitialized: initialized });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to initialize lots\" });\n    }\n  });\n\n  app.post(\"/api/fifo/process-sells\", async (req, res) => {\n    try {\n      const { fifoMatcher } = await import(\"./services/fifoMatcher\");\n      const result = await fifoMatcher.processAllUnmatchedSells();\n      res.json({ success: true, ...result });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to process sells\" });\n    }\n  });\n\n  app.post(\"/api/fifo/ingest-fill\", async (req, res) => {\n    try {\n      const { txid, orderId, pair, type, price, amount, cost, fee, executedAt } = req.body;\n      \n      if (!txid || !pair || !type || !price || !amount) {\n        return res.status(400).json({ error: \"Missing required fields: txid, pair, type, price, amount\" });\n      }\n\n      const fillResult = await storage.upsertTradeFill({\n        txid,\n        orderId: orderId || txid,\n        pair,\n        type: type.toLowerCase(),\n        price: price.toString(),\n        amount: amount.toString(),\n        cost: (cost || parseFloat(price) * parseFloat(amount)).toString(),\n        fee: (fee || 0).toString(),\n        matched: false,\n        executedAt: new Date(executedAt || Date.now()),\n      });\n\n      if (!fillResult.inserted) {\n        return res.json({ success: true, message: \"Fill already exists\", fill: fillResult.fill });\n      }\n\n      if (type.toUpperCase() === \"SELL\") {\n        const { fifoMatcher } = await import(\"./services/fifoMatcher\");\n        const matchResult = await fifoMatcher.processSellFill(fillResult.fill!);\n        return res.json({ success: true, fill: fillResult.fill, matchResult });\n      }\n\n      res.json({ success: true, fill: fillResult.fill });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to ingest fill\" });\n    }\n  });\n\n  app.get(\"/api/fifo/open-lots\", async (req, res) => {\n    try {\n      const lots = await storage.getOpenPositionsWithQtyRemaining();\n      res.json({\n        count: lots.length,\n        lots: lots.map(l => ({\n          lotId: l.lotId,\n          pair: l.pair,\n          entryPrice: l.entryPrice,\n          amount: l.amount,\n          qtyRemaining: l.qtyRemaining || l.amount,\n          qtyFilled: l.qtyFilled || \"0\",\n          openedAt: l.openedAt,\n        })),\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to get open lots\" });\n    }\n  });\n\n  app.get(\"/api/kraken/trades\", async (req, res) => {\n    try {\n      if (!krakenService.isInitialized()) {\n        const localTrades = await storage.getTrades(50);\n        return res.json(localTrades.map(t => ({\n          id: t.tradeId,\n          krakenOrderId: t.krakenOrderId,\n          pair: t.pair,\n          type: t.type,\n          price: t.price,\n          amount: t.amount,\n          time: t.executedAt?.toISOString() || t.createdAt.toISOString(),\n          status: t.status,\n        })));\n      }\n\n      const tradesHistory = await krakenService.getTradesHistory();\n      const trades = tradesHistory.trades || {};\n      \n      const formattedTrades = Object.entries(trades).map(([txid, trade]) => {\n        const t = trade as any;\n        return {\n          id: txid.substring(0, 10),\n          krakenOrderId: txid,\n          pair: krakenService.formatPairReverse(t.pair),\n          type: t.type,\n          price: t.price,\n          amount: t.vol,\n          cost: t.cost,\n          fee: t.fee,\n          time: new Date(t.time * 1000).toISOString(),\n          status: \"filled\",\n        };\n      }).sort((a, b) => new Date(b.time).getTime() - new Date(a.time).getTime());\n\n      res.json(formattedTrades);\n    } catch (error: any) {\n      console.error(\"[api/kraken/trades] Error:\", error.message);\n      const localTrades = await storage.getTrades(50);\n      res.json(localTrades.map(t => ({\n        id: t.tradeId,\n        krakenOrderId: t.krakenOrderId,\n        pair: t.pair,\n        type: t.type,\n        price: t.price,\n        amount: t.amount,\n        time: t.executedAt?.toISOString() || t.createdAt.toISOString(),\n        status: t.status,\n      })));\n    }\n  });\n\n  app.get(\"/api/events\", async (req, res) => {\n    try {\n      const limit = Math.min(parseInt(req.query.limit as string) || 50, 200);\n      const level = req.query.level as string;\n      \n      const events = await botLogger.getDbEvents(limit);\n      \n      const filtered = level \n        ? events.filter(e => e.level === level.toUpperCase())\n        : events;\n      \n      res.json(filtered.map(e => {\n        const meta = e.meta ? JSON.parse(e.meta) : null;\n        return {\n          id: e.id,\n          timestamp: e.timestamp,\n          level: e.level,\n          type: e.type,\n          message: e.message,\n          meta,\n          env: meta?.env || null,\n          instanceId: meta?.instanceId || null,\n        };\n      }));\n    } catch (error: any) {\n      console.error(\"[api/events] Error:\", error.message);\n      res.status(500).json({ error: \"Failed to fetch events\" });\n    }\n  });\n\n  app.get(\"/api/ai/status\", async (req, res) => {\n    try {\n      const status = await aiService.getStatus();\n      res.json(status);\n    } catch (error: any) {\n      console.error(\"[api/ai/status] Error:\", error.message);\n      res.status(500).json({ errorCode: \"STATUS_ERROR\", message: \"Error al obtener el estado de la IA\" });\n    }\n  });\n\n  app.get(\"/api/ai/diagnostic\", async (req, res) => {\n    try {\n      const diagnostic = await aiService.getDiagnostic();\n      const config = await storage.getBotConfig();\n      const dryRun = environment.isReplit || (config?.dryRunMode ?? false);\n      res.json({\n        ...diagnostic,\n        env: environment.envTag,\n        instanceId: environment.instanceId,\n        dryRun,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/environment\", async (req, res) => {\n    try {\n      const config = await storage.getBotConfig();\n      const dryRun = environment.isReplit || (config?.dryRunMode ?? false);\n      \n      // Obtener git commit hash\n      let gitCommit = \"unknown\";\n      try {\n        const { execSync } = await import(\"child_process\");\n        gitCommit = execSync(\"git rev-parse --short HEAD\", { encoding: \"utf-8\" }).trim();\n      } catch {\n        // Git no disponible, usar archivo de versi√≥n si existe\n        try {\n          const fs = await import(\"fs\");\n          if (fs.existsSync(\"VERSION\")) {\n            gitCommit = fs.readFileSync(\"VERSION\", \"utf-8\").trim();\n          }\n        } catch {}\n      }\n      \n      res.json({\n        env: environment.envTag,\n        instanceId: environment.instanceId,\n        isReplit: environment.isReplit,\n        isNAS: environment.isNAS,\n        dryRun,\n        gitCommit,\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.post(\"/api/ai/backfill\", async (req, res) => {\n    try {\n      const result = await aiService.runBackfill();\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ success: false, error: error.message });\n    }\n  });\n\n  // Endpoint para limpiar duplicados en training_trades\n  app.post(\"/api/ai/cleanup-duplicates\", async (req, res) => {\n    try {\n      const duplicates = await storage.getDuplicateTrainingTradesByBuyTxid();\n      \n      if (duplicates.length === 0) {\n        return res.json({ success: true, message: \"No hay duplicados en training_trades\", deleted: 0 });\n      }\n      \n      const deleted = await storage.deleteDuplicateTrainingTrades();\n      \n      res.json({ \n        success: true, \n        duplicatesFound: duplicates.length,\n        deleted,\n        details: duplicates.slice(0, 20),\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to cleanup training trades duplicates\" });\n    }\n  });\n\n  // Endpoint para ver duplicados en training_trades sin eliminar\n  app.get(\"/api/ai/duplicates\", async (req, res) => {\n    try {\n      const duplicates = await storage.getDuplicateTrainingTradesByBuyTxid();\n      res.json({ \n        count: duplicates.length,\n        duplicates: duplicates.slice(0, 50),\n      });\n    } catch (error: any) {\n      res.status(500).json({ error: error.message || \"Failed to get training trades duplicates\" });\n    }\n  });\n\n  app.get(\"/api/ai/samples\", async (req, res) => {\n    try {\n      const complete = req.query.complete === \"true\" ? true : req.query.complete === \"false\" ? false : undefined;\n      const limit = parseInt(req.query.limit as string) || 100;\n      const samples = await storage.getAiSamples({ complete, limit });\n      const count = await storage.getAiSamplesCount(complete);\n      res.json({ samples, total: count });\n    } catch (error: any) {\n      console.error(\"[api/ai/samples] Error:\", error.message);\n      res.status(500).json({ errorCode: \"SAMPLES_ERROR\", message: \"Error al obtener las muestras de IA\" });\n    }\n  });\n\n  app.post(\"/api/ai/retrain\", async (req, res) => {\n    try {\n      const result = await aiService.runTraining();\n      if (!result.success && result.errorCode === \"INSUFFICIENT_DATA\") {\n        res.status(409).json({\n          errorCode: result.errorCode,\n          message: result.message,\n          required: result.required,\n          current: result.current\n        });\n      } else if (!result.success) {\n        res.status(500).json({\n          errorCode: result.errorCode || \"TRAINING_ERROR\",\n          message: result.message\n        });\n      } else {\n        res.json({ success: true, message: result.message, metrics: result.metrics });\n      }\n    } catch (error: any) {\n      console.error(\"[api/ai/retrain] Error:\", error.message);\n      res.status(500).json({ errorCode: \"TRAINING_ERROR\", message: \"Error interno al reentrenar el modelo\" });\n    }\n  });\n\n  app.post(\"/api/ai/train\", async (req, res) => {\n    try {\n      const result = await aiService.runTraining();\n      if (!result.success && result.errorCode === \"INSUFFICIENT_DATA\") {\n        res.status(409).json({\n          errorCode: result.errorCode,\n          message: result.message,\n          required: result.required,\n          current: result.current\n        });\n      } else if (!result.success) {\n        res.status(500).json({\n          errorCode: result.errorCode || \"TRAINING_ERROR\",\n          message: result.message\n        });\n      } else {\n        res.json({ success: true, message: result.message, metrics: result.metrics });\n      }\n    } catch (error: any) {\n      console.error(\"[api/ai/train] Error:\", error.message);\n      res.status(500).json({ errorCode: \"TRAINING_ERROR\", message: `Error interno al entrenar el modelo: ${error.message}` });\n    }\n  });\n\n  app.get(\"/api/ai/shadow/report\", async (req, res) => {\n    try {\n      const report = await storage.getAiShadowReport();\n      res.json(report);\n    } catch (error: any) {\n      console.error(\"[api/ai/shadow/report] Error:\", error.message);\n      res.status(500).json({ errorCode: \"SHADOW_REPORT_ERROR\", message: \"Error al obtener el informe de shadow\" });\n    }\n  });\n\n  app.post(\"/api/ai/toggle\", async (req, res) => {\n    try {\n      const { filterEnabled, shadowEnabled, threshold } = req.body;\n      \n      if (filterEnabled !== undefined) {\n        await aiService.toggleFilter(filterEnabled);\n      }\n      if (shadowEnabled !== undefined) {\n        await aiService.toggleShadow(shadowEnabled);\n      }\n      if (threshold !== undefined) {\n        await aiService.setThreshold(parseFloat(threshold));\n      }\n      \n      const status = await aiService.getStatus();\n      res.json({ success: true, status });\n    } catch (error: any) {\n      console.error(\"[api/ai/toggle] Error:\", error.message);\n      res.status(500).json({ errorCode: \"TOGGLE_ERROR\", message: \"Error al cambiar la configuraci√≥n de IA\" });\n    }\n  });\n\n  // ============================================================\n  // TEST ENDPOINT: Simular se√±al BUY para validar SMART_GUARD\n  // Solo disponible en REPLIT/DEV o cuando dryRun=true\n  // ============================================================\n  app.post(\"/api/test/signal\", async (req, res) => {\n    try {\n      const envInfo = environment.getInfo();\n      const botConfig = await storage.getBotConfig();\n      const dryRun = botConfig?.dryRunMode ?? true;\n      \n      // SEGURIDAD: Solo permitir en REPLIT/DEV o dryRun=true\n      if (envInfo.isNAS && !dryRun) {\n        return res.status(403).json({\n          error: \"FORBIDDEN\",\n          message: \"Este endpoint solo est√° disponible en entorno de desarrollo (REPLIT/DEV) o con dryRun activado\",\n          env: envInfo.env,\n          dryRun,\n        });\n      }\n      \n      // Validar body\n      const testSignalSchema = z.object({\n        pair: z.string().min(1),\n        signal: z.enum([\"BUY\"]),\n        price: z.number().positive().optional(),\n        forceOrderUsd: z.number().positive().optional(),\n        forceHasPosition: z.boolean().optional(),\n        forceOpenLots: z.number().int().min(0).optional(),\n      });\n      \n      const parsed = testSignalSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({\n          error: \"VALIDATION_ERROR\",\n          message: \"Par√°metros inv√°lidos\",\n          details: parsed.error.issues,\n        });\n      }\n      \n      const { pair, signal, price, forceOrderUsd, forceHasPosition, forceOpenLots } = parsed.data;\n      const correlationId = `TEST-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\n      \n      // Obtener datos del mercado si no se proporciona precio\n      let currentPrice = price;\n      if (!currentPrice) {\n        try {\n          const ticker = await krakenService.getTicker(pair);\n          currentPrice = parseFloat(ticker?.c?.[0] || \"0\");\n        } catch {\n          currentPrice = 100; // Fallback para test\n        }\n      }\n      \n      // Obtener configuraci√≥n SMART_GUARD\n      const positionMode = botConfig?.positionMode || \"SINGLE\";\n      const sgMinEntryUsd = parseFloat(botConfig?.sgMinEntryUsd?.toString() || \"100\");\n      const sgAllowUnderMin = botConfig?.sgAllowUnderMin ?? true;\n      const sgMaxOpenLotsPerPair = 1; // Por defecto 1, se implementar√° en paso 3\n      const SG_ABSOLUTE_MIN_USD = 20;\n      \n      // Obtener balance USD\n      let usdBalance = 0;\n      try {\n        const balances = await krakenService.getBalance() as Record<string, string>;\n        usdBalance = parseFloat(balances?.ZUSD || balances?.USD || \"0\");\n      } catch {\n        usdBalance = 100; // Fallback para test\n      }\n      \n      // Simular orderUsdFinal\n      const orderUsdFinal = forceOrderUsd ?? Math.min(usdBalance * 0.95, sgMinEntryUsd);\n      \n      // Simular si hay posici√≥n abierta\n      const hasPosition = forceHasPosition ?? (tradingEngine?.getOpenPositions().has(pair) ?? false);\n      const openLots = forceOpenLots ?? (hasPosition ? 1 : 0);\n      \n      // Construir meta base\n      const baseMeta = {\n        correlationId,\n        pair,\n        signal,\n        env: envInfo.env,\n        instanceId: envInfo.instanceId,\n        testMode: true,\n        positionMode,\n        usdDisponible: usdBalance,\n        orderUsdProposed: sgMinEntryUsd,\n        orderUsdFinal,\n        sgMinEntryUsd,\n        sgAllowUnderMin,\n        sgMaxOpenLotsPerPair,\n        absoluteMinOrderUsd: SG_ABSOLUTE_MIN_USD,\n        hasPosition,\n        openLots,\n        currentPrice,\n      };\n      \n      let result: { decision: string; reason: string; message: string };\n      \n      // === VALIDACI√ìN 1: Posici√≥n abierta en SMART_GUARD/SINGLE ===\n      if ((positionMode === \"SINGLE\" || positionMode === \"SMART_GUARD\") && hasPosition && openLots >= sgMaxOpenLotsPerPair) {\n        const reason = positionMode === \"SMART_GUARD\" \n          ? (openLots >= sgMaxOpenLotsPerPair ? \"SMART_GUARD_MAX_LOTS_REACHED\" : \"SMART_GUARD_POSITION_EXISTS\")\n          : \"SINGLE_MODE_POSITION_EXISTS\";\n        \n        await botLogger.info(\"TRADE_SKIPPED\", `[TEST] Se√±al BUY bloqueada - ${reason}`, {\n          ...baseMeta,\n          reason,\n          existingLots: openLots,\n        });\n        \n        result = {\n          decision: \"TRADE_SKIPPED\",\n          reason,\n          message: reason === \"SMART_GUARD_MAX_LOTS_REACHED\"\n            ? `M√°ximo de lotes abiertos alcanzado (${openLots}/${sgMaxOpenLotsPerPair})`\n            : \"Ya hay posici√≥n abierta en este par\",\n        };\n      }\n      // === VALIDACI√ìN 2: M√≠nimo absoluto exchange (MIN_ORDER_ABSOLUTE) - Prioridad m√°s alta ===\n      else if (orderUsdFinal < SG_ABSOLUTE_MIN_USD) {\n        const reason = \"MIN_ORDER_ABSOLUTE\";\n        \n        await botLogger.info(\"TRADE_SKIPPED\", `[TEST] Se√±al BUY bloqueada - m√≠nimo absoluto exchange`, {\n          ...baseMeta,\n          reason,\n        });\n        \n        result = {\n          decision: \"TRADE_SKIPPED\",\n          reason,\n          message: `M√≠nimo absoluto exchange no alcanzado: $${orderUsdFinal.toFixed(2)} < $${SG_ABSOLUTE_MIN_USD}`,\n        };\n      }\n      // === VALIDACI√ìN 3: M√≠nimo por orden (MIN_ORDER_USD) ===\n      else if (positionMode === \"SMART_GUARD\" && !sgAllowUnderMin && orderUsdFinal < sgMinEntryUsd) {\n        const reason = \"MIN_ORDER_USD\";\n        \n        await botLogger.info(\"TRADE_SKIPPED\", `[TEST] Se√±al BUY bloqueada - m√≠nimo por orden no alcanzado`, {\n          ...baseMeta,\n          reason,\n        });\n        \n        result = {\n          decision: \"TRADE_SKIPPED\",\n          reason,\n          message: `M√≠nimo por orden no alcanzado: $${orderUsdFinal.toFixed(2)} < $${sgMinEntryUsd.toFixed(2)} (allowUnderMin=OFF)`,\n        };\n      }\n      // === CASO POSITIVO: Trade permitido (simulado) ===\n      else {\n        const reason = \"TEST_TRADE_ALLOWED\";\n        \n        await botLogger.info(\"TEST_TRADE_SIMULATED\", `[TEST] Se√±al BUY pasar√≠a todas las validaciones`, {\n          ...baseMeta,\n          reason,\n        });\n        \n        result = {\n          decision: \"TEST_TRADE_SIMULATED\",\n          reason,\n          message: `Trade de $${orderUsdFinal.toFixed(2)} pasar√≠a todas las validaciones en ${positionMode}`,\n        };\n      }\n      \n      res.json({\n        success: true,\n        correlationId,\n        ...result,\n        meta: baseMeta,\n      });\n      \n    } catch (error: any) {\n      console.error(\"[api/test/signal] Error:\", error.message);\n      res.status(500).json({\n        error: \"TEST_SIGNAL_ERROR\",\n        message: `Error al procesar se√±al de prueba: ${error.message}`,\n      });\n    }\n  });\n\n  // ============================================================\n  // TEST ENDPOINT: Simular eventos SMART_GUARD para testing\n  // Solo disponible en REPLIT/DEV o cuando dryRun=true\n  // ============================================================\n  app.post(\"/api/test/sg-event\", async (req, res) => {\n    try {\n      const envInfo = environment.getInfo();\n      const botConfig = await storage.getBotConfig();\n      const dryRun = botConfig?.dryRunMode ?? true;\n      \n      // SEGURIDAD: Solo permitir en REPLIT/DEV o dryRun=true\n      if (envInfo.isNAS && !dryRun) {\n        return res.status(403).json({\n          error: \"FORBIDDEN\",\n          message: \"Este endpoint solo est√° disponible en entorno de desarrollo (REPLIT/DEV) o con dryRun activado\",\n        });\n      }\n      \n      const testEventSchema = z.object({\n        event: z.enum([\"SG_BREAK_EVEN_ACTIVATED\", \"SG_TRAILING_ACTIVATED\", \"SG_TRAILING_STOP_UPDATED\", \"SG_SCALE_OUT_EXECUTED\"]),\n        pair: z.string().default(\"BTC/USD\"),\n        lotId: z.string().optional(),\n        entryPrice: z.number().positive().default(100000),\n        currentPrice: z.number().positive().optional(),\n        profitPct: z.number().default(2.5),\n        stopPrice: z.number().positive().optional(),\n        scaleOutQty: z.number().positive().optional(),\n        scaleOutUsd: z.number().positive().optional(),\n      });\n      \n      const parsed = testEventSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"VALIDATION_ERROR\", details: parsed.error.issues });\n      }\n      \n      const { event, pair, entryPrice, profitPct } = parsed.data;\n      const lotId = parsed.data.lotId || `TEST-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;\n      const currentPrice = parsed.data.currentPrice || entryPrice * (1 + profitPct / 100);\n      const stopPrice = parsed.data.stopPrice || currentPrice * 0.98;\n      \n      const baseMeta = {\n        pair,\n        lotId,\n        entryPrice,\n        currentPrice,\n        profitPct: profitPct.toFixed(2) + \"%\",\n        env: envInfo.env,\n        instanceId: envInfo.instanceId,\n        testMode: true,\n      };\n      \n      let message = \"\";\n      let telegramMsg = \"\";\n      const prefix = environment.getMessagePrefix(true); // Test events are always DRY_RUN\n      \n      switch (event) {\n        case \"SG_BREAK_EVEN_ACTIVATED\":\n          message = `SMART_GUARD Break-Even activado en ${pair}`;\n          telegramMsg = `${prefix}‚öñÔ∏è *Break-Even Activado*\\n` +\n            `Par: ${pair}\\n` +\n            `Lote: \\`${lotId}\\`\\n` +\n            `Entrada: $${entryPrice.toFixed(2)}\\n` +\n            `Precio actual: $${currentPrice.toFixed(2)}\\n` +\n            `Profit: +${profitPct.toFixed(2)}%\\n` +\n            `Stop movido a: $${stopPrice.toFixed(2)}`;\n          await botLogger.info(event, message, { ...baseMeta, stopPrice });\n          await telegramService.sendAlertToMultipleChats(telegramMsg, \"status\");\n          break;\n          \n        case \"SG_TRAILING_ACTIVATED\":\n          message = `SMART_GUARD Trailing Stop activado en ${pair}`;\n          telegramMsg = `${prefix}üéØ *Trailing Stop Activado*\\n` +\n            `Par: ${pair}\\n` +\n            `Lote: \\`${lotId}\\`\\n` +\n            `Entrada: $${entryPrice.toFixed(2)}\\n` +\n            `Precio actual: $${currentPrice.toFixed(2)}\\n` +\n            `Profit: +${profitPct.toFixed(2)}%\\n` +\n            `Stop din√°mico: $${stopPrice.toFixed(2)}`;\n          await botLogger.info(event, message, { ...baseMeta, stopPrice });\n          await telegramService.sendAlertToMultipleChats(telegramMsg, \"status\");\n          break;\n          \n        case \"SG_TRAILING_STOP_UPDATED\":\n          const oldStop = stopPrice * 0.99;\n          message = `SMART_GUARD Trailing Stop actualizado en ${pair}`;\n          telegramMsg = `${prefix}üìà *Trailing Stop Actualizado*\\n` +\n            `Par: ${pair}\\n` +\n            `Lote: \\`${lotId}\\`\\n` +\n            `Stop: $${oldStop.toFixed(2)} ‚Üí $${stopPrice.toFixed(2)}\\n` +\n            `Profit actual: +${profitPct.toFixed(2)}%`;\n          await botLogger.info(event, message, { ...baseMeta, stopPrice, oldStop });\n          await telegramService.sendAlertToMultipleChats(telegramMsg, \"status\");\n          break;\n          \n        case \"SG_SCALE_OUT_EXECUTED\":\n          const scaleOutQty = parsed.data.scaleOutQty || 0.001;\n          const scaleOutUsd = parsed.data.scaleOutUsd || scaleOutQty * currentPrice;\n          message = `SMART_GUARD Scale-Out ejecutado en ${pair}`;\n          telegramMsg = `${prefix}üìä *Scale-Out Ejecutado*\\n` +\n            `Par: ${pair}\\n` +\n            `Lote: \\`${lotId}\\`\\n` +\n            `Vendido: ${scaleOutQty} ($${scaleOutUsd.toFixed(2)})\\n` +\n            `Profit: +${profitPct.toFixed(2)}%`;\n          await botLogger.info(event, message, { ...baseMeta, scaleOutQty, scaleOutUsd });\n          await telegramService.sendAlertToMultipleChats(telegramMsg, \"status\");\n          break;\n      }\n      \n      res.json({\n        success: true,\n        event,\n        message,\n        meta: baseMeta,\n        telegramSent: true,\n      });\n      \n    } catch (error: any) {\n      console.error(\"[api/test/sg-event] Error:\", error.message);\n      res.status(500).json({ error: \"TEST_SG_EVENT_ERROR\", message: error.message });\n    }\n  });\n\n  // ============================================================\n  // TEST ENDPOINT: Probar multi-lot (crear posiciones de prueba)\n  // ============================================================\n  app.post(\"/api/test/create-position\", async (req, res) => {\n    try {\n      const envInfo = environment.getInfo();\n      const botConfig = await storage.getBotConfig();\n      const dryRun = botConfig?.dryRunMode ?? true;\n      \n      if (envInfo.isNAS && !dryRun) {\n        return res.status(403).json({ error: \"FORBIDDEN\" });\n      }\n      \n      const schema = z.object({\n        pair: z.string().default(\"BTC/USD\"),\n        amount: z.number().positive().default(0.001),\n        entryPrice: z.number().positive().default(100000),\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"VALIDATION_ERROR\", details: parsed.error.issues });\n      }\n      \n      const { pair, amount, entryPrice } = parsed.data;\n      const lotId = `TEST-${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;\n      \n      // Add to trading engine's open positions\n      if (tradingEngine) {\n        const position = {\n          pair,\n          amount,\n          entryPrice,\n          timestamp: new Date().toISOString(),\n          lotId,\n          strategy: \"test\",\n          signalConfidence: 80,\n          // SMART_GUARD flags\n          sgBreakEvenActivated: false,\n          sgTrailingActivated: false,\n          sgCurrentStopPrice: null,\n          sgScaleOutDone: false,\n          configSnapshotJson: botConfig ? JSON.stringify({\n            sgMinEntryUsd: botConfig.sgMinEntryUsd,\n            sgBeAtPct: botConfig.sgBeAtPct,\n            sgTrailStartPct: botConfig.sgTrailStartPct,\n            sgTrailDistancePct: botConfig.sgTrailDistancePct,\n          }) : null,\n        };\n        \n        tradingEngine.getOpenPositions().set(lotId, position);\n        \n        // Count lots for this pair\n        const allPositions = tradingEngine.getOpenPositions();\n        let pairLots = 0;\n        Array.from(allPositions.values()).forEach((pos: any) => {\n          if (pos.pair === pair) pairLots++;\n        });\n        \n        await botLogger.info(\"TEST_POSITION_CREATED\", `Posici√≥n de prueba creada: ${pair} x${amount}`, {\n          pair, lotId, amount, entryPrice, pairLots, env: envInfo.env,\n        });\n        \n        res.json({\n          success: true,\n          lotId,\n          position,\n          pairLotsCount: pairLots,\n        });\n      } else {\n        res.status(500).json({ error: \"ENGINE_NOT_READY\" });\n      }\n      \n    } catch (error: any) {\n      res.status(500).json({ error: \"CREATE_POSITION_ERROR\", message: error.message });\n    }\n  });\n\n  // ============================================================\n  // TEST ENDPOINT: Eliminar posici√≥n de prueba\n  // ============================================================\n  app.delete(\"/api/test/position/:lotId\", async (req, res) => {\n    try {\n      const envInfo = environment.getInfo();\n      const botConfig = await storage.getBotConfig();\n      const dryRun = botConfig?.dryRunMode ?? true;\n      \n      if (envInfo.isNAS && !dryRun) {\n        return res.status(403).json({ error: \"FORBIDDEN\" });\n      }\n      \n      const { lotId } = req.params;\n      \n      if (tradingEngine) {\n        const deleted = tradingEngine.getOpenPositions().delete(lotId);\n        res.json({ success: true, deleted, lotId });\n      } else {\n        res.status(500).json({ error: \"ENGINE_NOT_READY\" });\n      }\n      \n    } catch (error: any) {\n      res.status(500).json({ error: \"DELETE_POSITION_ERROR\", message: error.message });\n    }\n  });\n\n  // ============================================================\n  // TEST ENDPOINT: Simular sizing SMART_GUARD v2\n  // Para validar la l√≥gica: 469‚Üí200, 250‚Üí200, 150‚Üí150, 25‚Üí25, 19‚Üíblock\n  // ============================================================\n  app.post(\"/api/test/sg-sizing\", async (req, res) => {\n    try {\n      const envInfo = environment.getInfo();\n      const botConfig = await storage.getBotConfig();\n      const dryRun = botConfig?.dryRunMode ?? true;\n      \n      if (envInfo.isNAS && !dryRun) {\n        return res.status(403).json({ error: \"FORBIDDEN\" });\n      }\n      \n      const schema = z.object({\n        availableUsd: z.number().min(0),\n        sgMinEntryUsd: z.number().positive().default(200),\n        minOrderExchangeUsd: z.number().positive().default(10), // m√≠nimo del exchange en USD\n        feeCushionPct: z.number().min(0).default(0),\n      });\n      \n      const parsed = schema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({ error: \"VALIDATION_ERROR\", details: parsed.error.issues });\n      }\n      \n      const { availableUsd, sgMinEntryUsd, minOrderExchangeUsd, feeCushionPct } = parsed.data;\n      \n      // Constantes\n      const SG_ABSOLUTE_MIN_USD = 20;\n      \n      // SMART_GUARD v2: sin buffer de slippage para sizing exacto\n      const usdDisponible = availableUsd;\n      \n      // floorUsd = max(minOrderExchangeUsd, MIN_ORDER_ABSOLUTE_USD)\n      const floorUsd = Math.max(SG_ABSOLUTE_MIN_USD, minOrderExchangeUsd);\n      \n      // Fee cushion\n      const cushionAmount = availableUsd * (feeCushionPct / 100);\n      const availableAfterCushion = usdDisponible - cushionAmount;\n      \n      // === SMART_GUARD v2 SIZING LOGIC ===\n      let orderUsd: number;\n      let reasonCode: string;\n      let blocked = false;\n      \n      if (availableAfterCushion >= sgMinEntryUsd) {\n        // Caso A: Saldo suficiente ‚Üí usar sgMinEntryUsd EXACTO\n        orderUsd = sgMinEntryUsd;\n        reasonCode = \"SMART_GUARD_ENTRY_USING_CONFIG_MIN\";\n        \n      } else if (availableAfterCushion >= floorUsd) {\n        // Caso B: Fallback autom√°tico ‚Üí usar saldo disponible\n        orderUsd = availableAfterCushion;\n        reasonCode = \"SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE\";\n        \n      } else if (usdDisponible >= floorUsd && availableAfterCushion < floorUsd) {\n        // Caso C: Fee cushion lo baja de floorUsd ‚Üí BLOCKED\n        orderUsd = availableAfterCushion;\n        reasonCode = \"SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION\";\n        blocked = true;\n        \n      } else {\n        // Caso D: Saldo < floorUsd ‚Üí BLOCKED\n        orderUsd = usdDisponible;\n        reasonCode = \"SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN\";\n        blocked = true;\n      }\n      \n      res.json({\n        success: true,\n        blocked,\n        reasonCode,\n        orderUsd: parseFloat(orderUsd.toFixed(2)),\n        details: {\n          input: {\n            availableUsd,\n            sgMinEntryUsd,\n            minOrderExchangeUsd,\n            feeCushionPct,\n          },\n          calculated: {\n            usdDisponible: parseFloat(usdDisponible.toFixed(2)),\n            floorUsd,\n            cushionAmount: parseFloat(cushionAmount.toFixed(2)),\n            availableAfterCushion: parseFloat(availableAfterCushion.toFixed(2)),\n          },\n          thresholds: {\n            SG_ABSOLUTE_MIN_USD,\n            minOrderExchangeUsd,\n            floorUsd,\n          },\n        },\n      });\n      \n    } catch (error: any) {\n      res.status(500).json({ error: \"SG_SIZING_TEST_ERROR\", message: error.message });\n    }\n  });\n\n  return httpServer;\n}\n","path":null,"size_bytes":79188,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type BotConfig, \n  type Trade, \n  type Notification, \n  type MarketData,\n  type ApiConfig,\n  type TelegramChat,\n  type OpenPosition,\n  type AiTradeSample,\n  type AiShadowDecision,\n  type AiConfig,\n  type TrainingTrade,\n  type InsertBotConfig,\n  type InsertTrade,\n  type InsertNotification,\n  type InsertMarketData,\n  type InsertApiConfig,\n  type InsertTelegramChat,\n  type InsertOpenPosition,\n  type InsertAiTradeSample,\n  type InsertAiShadowDecision,\n  type InsertAiConfig,\n  type InsertTrainingTrade,\n  type TradeFill,\n  type LotMatch,\n  type InsertTradeFill,\n  type InsertLotMatch,\n  botConfig as botConfigTable,\n  trades as tradesTable,\n  notifications as notificationsTable,\n  marketData as marketDataTable,\n  apiConfig as apiConfigTable,\n  telegramChats as telegramChatsTable,\n  openPositions as openPositionsTable,\n  tradeFills as tradeFillsTable,\n  lotMatches as lotMatchesTable,\n  aiTradeSamples as aiTradeSamplesTable,\n  aiShadowDecisions as aiShadowDecisionsTable,\n  aiConfig as aiConfigTable,\n  trainingTrades as trainingTradesTable\n} from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq, desc, and, gt, lt, sql, isNull } from \"drizzle-orm\";\n\nexport interface IStorage {\n  getBotConfig(): Promise<BotConfig | undefined>;\n  updateBotConfig(config: Partial<InsertBotConfig>): Promise<BotConfig>;\n  \n  getApiConfig(): Promise<ApiConfig | undefined>;\n  updateApiConfig(config: Partial<InsertApiConfig>): Promise<ApiConfig>;\n  \n  createTrade(trade: InsertTrade): Promise<Trade>;\n  getTrades(limit?: number): Promise<Trade[]>;\n  getClosedTrades(options: { limit?: number; offset?: number; pair?: string; result?: 'winner' | 'loser' | 'all'; type?: 'all' | 'buy' | 'sell' }): Promise<{ trades: Trade[]; total: number }>;\n  updateTradeStatus(tradeId: string, status: string, krakenOrderId?: string): Promise<void>;\n  getTradeByKrakenOrderId(krakenOrderId: string): Promise<Trade | undefined>;\n  getTradeByLotId(lotId: string): Promise<Trade | undefined>;\n  getSellMatchingBuy(pair: string, buyLotId: string): Promise<Trade | undefined>;\n  upsertTradeByKrakenId(trade: InsertTrade): Promise<{ inserted: boolean; trade?: Trade }>;\n  getDuplicateTradesByKrakenId(): Promise<{ krakenOrderId: string; count: number; ids: number[] }[]>;\n  deleteDuplicateTrades(): Promise<number>;\n  updateTradePnl(id: number, entryPrice: string, realizedPnlUsd: string, realizedPnlPct: string): Promise<void>;\n  getUnmatchedBuys(pair: string): Promise<Trade[]>;\n  \n  createNotification(notification: InsertNotification): Promise<Notification>;\n  getUnsentNotifications(): Promise<Notification[]>;\n  markNotificationSent(id: number): Promise<void>;\n  \n  saveMarketData(data: InsertMarketData): Promise<MarketData>;\n  getLatestMarketData(pair: string): Promise<MarketData | undefined>;\n  \n  getTelegramChats(): Promise<TelegramChat[]>;\n  getActiveTelegramChats(): Promise<TelegramChat[]>;\n  createTelegramChat(chat: InsertTelegramChat): Promise<TelegramChat>;\n  updateTelegramChat(id: number, chat: Partial<InsertTelegramChat>): Promise<TelegramChat>;\n  deleteTelegramChat(id: number): Promise<void>;\n  \n  getOpenPositions(): Promise<OpenPosition[]>;\n  getOpenPosition(pair: string): Promise<OpenPosition | undefined>;\n  getOpenPositionByLotId(lotId: string): Promise<OpenPosition | undefined>;\n  getOpenPositionsByPair(pair: string): Promise<OpenPosition[]>;\n  saveOpenPosition(position: InsertOpenPosition): Promise<OpenPosition>;\n  saveOpenPositionByLotId(position: InsertOpenPosition): Promise<OpenPosition>;\n  updateOpenPosition(pair: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined>;\n  updateOpenPositionByLotId(lotId: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined>;\n  updateOpenPositionLotId(id: number, lotId: string): Promise<void>;\n  deleteOpenPosition(pair: string): Promise<void>;\n  deleteOpenPositionByLotId(lotId: string): Promise<void>;\n  getOpenPositionsWithQtyRemaining(): Promise<OpenPosition[]>;\n  updateOpenPositionQty(lotId: string, qtyRemaining: string, qtyFilled: string): Promise<void>;\n  initializeQtyRemainingForAll(): Promise<number>;\n  \n  // Trade fills\n  upsertTradeFill(fill: InsertTradeFill): Promise<{ inserted: boolean; fill?: TradeFill }>;\n  getTradeFillByTxid(txid: string): Promise<TradeFill | undefined>;\n  getUnmatchedSellFills(pair: string): Promise<TradeFill[]>;\n  markFillAsMatched(txid: string): Promise<void>;\n  \n  // Lot matches (FIFO matcher audit trail)\n  createLotMatch(match: InsertLotMatch): Promise<LotMatch>;\n  getLotMatchesByLotId(lotId: string): Promise<LotMatch[]>;\n  getLotMatchBySellFillAndLot(sellFillTxid: string, lotId: string): Promise<LotMatch | undefined>;\n  \n  saveAiSample(sample: InsertAiTradeSample): Promise<AiTradeSample>;\n  updateAiSample(sampleId: number, updates: Partial<InsertAiTradeSample>): Promise<AiTradeSample | undefined>;\n  getAiSamples(options?: { complete?: boolean; limit?: number }): Promise<AiTradeSample[]>;\n  getAiSamplesCount(complete?: boolean): Promise<number>;\n  \n  saveAiShadowDecision(decision: InsertAiShadowDecision): Promise<AiShadowDecision>;\n  updateAiShadowFinalPnl(tradeId: string, pnl: string): Promise<void>;\n  getAiShadowReport(): Promise<{ total: number; blocked: number; blockedLosers: number; passedLosers: number }>;\n  \n  getAiConfig(): Promise<AiConfig | undefined>;\n  updateAiConfig(config: Partial<InsertAiConfig>): Promise<AiConfig>;\n  \n  saveTrainingTrade(trade: InsertTrainingTrade): Promise<TrainingTrade>;\n  updateTrainingTrade(id: number, updates: Partial<InsertTrainingTrade>): Promise<TrainingTrade | undefined>;\n  getTrainingTradeByBuyTxid(buyTxid: string): Promise<TrainingTrade | undefined>;\n  getTrainingTrades(options?: { closed?: boolean; labeled?: boolean; limit?: number }): Promise<TrainingTrade[]>;\n  getDuplicateTrainingTradesByBuyTxid(): Promise<{ buyTxid: string; count: number; ids: number[] }[]>;\n  deleteDuplicateTrainingTrades(): Promise<number>;\n  getTrainingTradesCount(options?: { closed?: boolean; labeled?: boolean; hasOpenLots?: boolean }): Promise<number>;\n  getDiscardReasonsDataset(): Promise<Record<string, number>>;\n  getAllTradesForBackfill(): Promise<Trade[]>;\n  runTrainingTradesBackfill(): Promise<{ created: number; closed: number; labeled: number; discardReasons: Record<string, number> }>;\n  \n  // Schema health check and auto-migration\n  checkSchemaHealth(): Promise<{ healthy: boolean; missingColumns: string[]; migrationRan: boolean }>;\n  runSchemaMigration(): Promise<{ success: boolean; columnsAdded: string[]; error?: string }>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  private schemaMigrationAttempted = false;\n  \n  async getBotConfig(): Promise<BotConfig | undefined> {\n    try {\n      const configs = await db.select().from(botConfigTable).limit(1);\n      if (configs.length === 0) {\n        const [newConfig] = await db.insert(botConfigTable).values({}).returning();\n        return newConfig;\n      }\n      return configs[0];\n    } catch (error) {\n      // If schema is outdated, try auto-migration ONCE then retry\n      if (!this.schemaMigrationAttempted && error instanceof Error && error.message.includes('does not exist')) {\n        console.log('[storage] Schema issue detected, attempting auto-migration...');\n        this.schemaMigrationAttempted = true;\n        const migrationResult = await this.runSchemaMigration();\n        if (migrationResult.success) {\n          console.log('[storage] Auto-migration successful, retrying getBotConfig...');\n          return this.getBotConfig();\n        }\n        // Migration failed - propagate error\n        console.error('[storage] Auto-migration failed:', migrationResult.error);\n      }\n      // No fallback - surface the error so operators know to fix schema\n      throw error;\n    }\n  }\n\n  async updateBotConfig(config: Partial<InsertBotConfig>): Promise<BotConfig> {\n    const existing = await this.getBotConfig();\n    if (!existing) {\n      const [newConfig] = await db.insert(botConfigTable).values(config as InsertBotConfig).returning();\n      return newConfig;\n    }\n    const [updated] = await db.update(botConfigTable)\n      .set({ ...config, updatedAt: new Date() })\n      .where(eq(botConfigTable.id, existing.id))\n      .returning();\n    return updated;\n  }\n\n  async getApiConfig(): Promise<ApiConfig | undefined> {\n    const configs = await db.select().from(apiConfigTable).limit(1);\n    if (configs.length === 0) {\n      const [newConfig] = await db.insert(apiConfigTable).values({}).returning();\n      return newConfig;\n    }\n    return configs[0];\n  }\n\n  async updateApiConfig(config: Partial<InsertApiConfig>): Promise<ApiConfig> {\n    const existing = await this.getApiConfig();\n    if (!existing) {\n      const [newConfig] = await db.insert(apiConfigTable).values(config as InsertApiConfig).returning();\n      return newConfig;\n    }\n    const [updated] = await db.update(apiConfigTable)\n      .set({ ...config, updatedAt: new Date() })\n      .where(eq(apiConfigTable.id, existing.id))\n      .returning();\n    return updated;\n  }\n\n  async createTrade(trade: InsertTrade): Promise<Trade> {\n    const [newTrade] = await db.insert(tradesTable).values(trade).returning();\n    return newTrade;\n  }\n\n  // Upsert trade - inserta solo si no existe (por krakenOrderId)\n  async upsertTradeByKrakenId(trade: InsertTrade): Promise<{ inserted: boolean; trade?: Trade }> {\n    if (!trade.krakenOrderId) {\n      const [newTrade] = await db.insert(tradesTable).values(trade).returning();\n      return { inserted: true, trade: newTrade };\n    }\n    \n    // Verificar si existe\n    const existing = await this.getTradeByKrakenOrderId(trade.krakenOrderId);\n    if (existing) {\n      return { inserted: false, trade: existing };\n    }\n    \n    try {\n      const [newTrade] = await db.insert(tradesTable).values(trade).returning();\n      return { inserted: true, trade: newTrade };\n    } catch (e: any) {\n      // Handle unique constraint violation gracefully\n      if (e.code === '23505') {\n        return { inserted: false };\n      }\n      throw e;\n    }\n  }\n\n  // Obtener duplicados por krakenOrderId para limpieza\n  async getDuplicateTradesByKrakenId(): Promise<{ krakenOrderId: string; count: number; ids: number[] }[]> {\n    const result = await db.execute(sql`\n      SELECT kraken_order_id, COUNT(*) as count, ARRAY_AGG(id ORDER BY id) as ids\n      FROM trades\n      WHERE kraken_order_id IS NOT NULL\n      GROUP BY kraken_order_id\n      HAVING COUNT(*) > 1\n    `);\n    return (result.rows as any[]).map(row => ({\n      krakenOrderId: row.kraken_order_id,\n      count: parseInt(row.count),\n      ids: row.ids,\n    }));\n  }\n\n  // Eliminar duplicados manteniendo el m√°s antiguo (menor id)\n  async deleteDuplicateTrades(): Promise<number> {\n    const duplicates = await this.getDuplicateTradesByKrakenId();\n    let deleted = 0;\n    \n    for (const dup of duplicates) {\n      // Mantener el primer id (m√°s antiguo), eliminar el resto\n      const idsToDelete = dup.ids.slice(1);\n      for (const id of idsToDelete) {\n        await db.delete(tradesTable).where(eq(tradesTable.id, id));\n        deleted++;\n      }\n    }\n    \n    return deleted;\n  }\n\n  // Actualizar P&L de un trade\n  async updateTradePnl(id: number, entryPrice: string, realizedPnlUsd: string, realizedPnlPct: string): Promise<void> {\n    await db.update(tradesTable)\n      .set({ entryPrice, realizedPnlUsd, realizedPnlPct })\n      .where(eq(tradesTable.id, id));\n  }\n\n  // Obtener trades BUY sin emparejar para un par (para calcular P&L)\n  async getUnmatchedBuys(pair: string): Promise<Trade[]> {\n    return await db.select().from(tradesTable)\n      .where(and(\n        eq(tradesTable.pair, pair),\n        eq(tradesTable.type, 'buy'),\n        eq(tradesTable.status, 'filled')\n      ))\n      .orderBy(tradesTable.executedAt);\n  }\n\n  async getTrades(limit: number = 50): Promise<Trade[]> {\n    return await db.select().from(tradesTable).orderBy(desc(tradesTable.createdAt)).limit(limit);\n  }\n\n  async getClosedTrades(options: { limit?: number; offset?: number; pair?: string; result?: 'winner' | 'loser' | 'all'; type?: 'all' | 'buy' | 'sell' }): Promise<{ trades: Trade[]; total: number }> {\n    const { limit = 10, offset = 0, pair, result = 'all', type = 'all' } = options;\n    \n    const conditions: any[] = [];\n    \n    if (type !== 'all') {\n      conditions.push(eq(tradesTable.type, type));\n    }\n    \n    if (pair) {\n      conditions.push(eq(tradesTable.pair, pair));\n    }\n    \n    if (result === 'winner') {\n      conditions.push(gt(tradesTable.realizedPnlUsd, '0'));\n    } else if (result === 'loser') {\n      conditions.push(lt(tradesTable.realizedPnlUsd, '0'));\n    }\n    \n    const whereClause = conditions.length > 0 ? (conditions.length === 1 ? conditions[0] : and(...conditions)) : undefined;\n    \n    const tradesQuery = db.select().from(tradesTable)\n      .orderBy(desc(tradesTable.executedAt))\n      .limit(limit)\n      .offset(offset);\n    \n    const countQuery = db.select({ count: sql<number>`count(*)` }).from(tradesTable);\n    \n    const trades = whereClause ? await tradesQuery.where(whereClause) : await tradesQuery;\n    const countResult = whereClause ? await countQuery.where(whereClause) : await countQuery;\n    \n    return { trades, total: Number(countResult[0]?.count || 0) };\n  }\n\n  async updateTradeStatus(tradeId: string, status: string, krakenOrderId?: string): Promise<void> {\n    await db.update(tradesTable)\n      .set({ status, krakenOrderId, executedAt: new Date() })\n      .where(eq(tradesTable.tradeId, tradeId));\n  }\n\n  async getTradeByKrakenOrderId(krakenOrderId: string): Promise<Trade | undefined> {\n    const trades = await db.select().from(tradesTable)\n      .where(eq(tradesTable.krakenOrderId, krakenOrderId))\n      .limit(1);\n    return trades[0];\n  }\n\n  async getTradeByLotId(lotId: string): Promise<Trade | undefined> {\n    // lotId typically equals krakenOrderId for synced trades\n    const trades = await db.select().from(tradesTable)\n      .where(eq(tradesTable.krakenOrderId, lotId))\n      .limit(1);\n    return trades[0];\n  }\n\n  async getSellMatchingBuy(pair: string, buyLotId: string): Promise<Trade | undefined> {\n    // Find the BUY trade first to get its timestamp (case-insensitive)\n    const buyTrade = await db.select().from(tradesTable)\n      .where(and(\n        eq(tradesTable.krakenOrderId, buyLotId),\n        sql`UPPER(${tradesTable.type}) = 'BUY'`\n      ))\n      .limit(1);\n    \n    if (!buyTrade[0]) return undefined;\n    \n    // Find any SELL for the same pair that happened after this BUY (case-insensitive)\n    const sellTrades = await db.select().from(tradesTable)\n      .where(and(\n        eq(tradesTable.pair, pair),\n        sql`UPPER(${tradesTable.type}) = 'SELL'`,\n        gt(tradesTable.executedAt, buyTrade[0].executedAt!)\n      ))\n      .orderBy(tradesTable.executedAt)\n      .limit(1);\n    \n    return sellTrades[0];\n  }\n\n  async createNotification(notification: InsertNotification): Promise<Notification> {\n    const [newNotification] = await db.insert(notificationsTable).values(notification).returning();\n    return newNotification;\n  }\n\n  async getUnsentNotifications(): Promise<Notification[]> {\n    return await db.select().from(notificationsTable)\n      .where(eq(notificationsTable.telegramSent, false))\n      .orderBy(desc(notificationsTable.createdAt));\n  }\n\n  async markNotificationSent(id: number): Promise<void> {\n    await db.update(notificationsTable)\n      .set({ telegramSent: true, sentAt: new Date() })\n      .where(eq(notificationsTable.id, id));\n  }\n\n  async saveMarketData(data: InsertMarketData): Promise<MarketData> {\n    const [newData] = await db.insert(marketDataTable).values(data).returning();\n    return newData;\n  }\n\n  async getLatestMarketData(pair: string): Promise<MarketData | undefined> {\n    const data = await db.select().from(marketDataTable)\n      .where(eq(marketDataTable.pair, pair))\n      .orderBy(desc(marketDataTable.timestamp))\n      .limit(1);\n    return data[0];\n  }\n\n  async getTelegramChats(): Promise<TelegramChat[]> {\n    return await db.select().from(telegramChatsTable).orderBy(desc(telegramChatsTable.createdAt));\n  }\n\n  async getActiveTelegramChats(): Promise<TelegramChat[]> {\n    return await db.select().from(telegramChatsTable)\n      .where(eq(telegramChatsTable.isActive, true))\n      .orderBy(desc(telegramChatsTable.createdAt));\n  }\n\n  async createTelegramChat(chat: InsertTelegramChat): Promise<TelegramChat> {\n    const [newChat] = await db.insert(telegramChatsTable).values(chat).returning();\n    return newChat;\n  }\n\n  async updateTelegramChat(id: number, chat: Partial<InsertTelegramChat>): Promise<TelegramChat> {\n    const [updated] = await db.update(telegramChatsTable)\n      .set(chat)\n      .where(eq(telegramChatsTable.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteTelegramChat(id: number): Promise<void> {\n    await db.delete(telegramChatsTable).where(eq(telegramChatsTable.id, id));\n  }\n\n  async getOpenPositions(): Promise<OpenPosition[]> {\n    return await db.select().from(openPositionsTable);\n  }\n\n  async getOpenPosition(pair: string): Promise<OpenPosition | undefined> {\n    const positions = await db.select().from(openPositionsTable)\n      .where(eq(openPositionsTable.pair, pair))\n      .limit(1);\n    return positions[0];\n  }\n\n  async getOpenPositionByLotId(lotId: string): Promise<OpenPosition | undefined> {\n    const positions = await db.select().from(openPositionsTable)\n      .where(eq(openPositionsTable.lotId, lotId))\n      .limit(1);\n    return positions[0];\n  }\n\n  async getOpenPositionsByPair(pair: string): Promise<OpenPosition[]> {\n    return await db.select().from(openPositionsTable)\n      .where(eq(openPositionsTable.pair, pair));\n  }\n\n  async saveOpenPosition(position: InsertOpenPosition): Promise<OpenPosition> {\n    const existing = await this.getOpenPosition(position.pair);\n    if (existing) {\n      const [updated] = await db.update(openPositionsTable)\n        .set({ ...position, updatedAt: new Date() })\n        .where(eq(openPositionsTable.pair, position.pair))\n        .returning();\n      return updated;\n    }\n    const [newPosition] = await db.insert(openPositionsTable).values(position).returning();\n    return newPosition;\n  }\n\n  async saveOpenPositionByLotId(position: InsertOpenPosition): Promise<OpenPosition> {\n    if (!position.lotId) {\n      throw new Error(\"lotId is required for saveOpenPositionByLotId\");\n    }\n    const existing = await this.getOpenPositionByLotId(position.lotId);\n    if (existing) {\n      const [updated] = await db.update(openPositionsTable)\n        .set({ ...position, updatedAt: new Date() })\n        .where(eq(openPositionsTable.lotId, position.lotId))\n        .returning();\n      return updated;\n    }\n    const [newPosition] = await db.insert(openPositionsTable).values(position).returning();\n    return newPosition;\n  }\n\n  async updateOpenPosition(pair: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined> {\n    const [updated] = await db.update(openPositionsTable)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(openPositionsTable.pair, pair))\n      .returning();\n    return updated;\n  }\n\n  async updateOpenPositionByLotId(lotId: string, updates: Partial<InsertOpenPosition>): Promise<OpenPosition | undefined> {\n    const [updated] = await db.update(openPositionsTable)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(openPositionsTable.lotId, lotId))\n      .returning();\n    return updated;\n  }\n\n  async updateOpenPositionLotId(id: number, lotId: string): Promise<void> {\n    await db.update(openPositionsTable)\n      .set({ lotId, updatedAt: new Date() })\n      .where(eq(openPositionsTable.id, id));\n  }\n\n  async deleteOpenPosition(pair: string): Promise<void> {\n    await db.delete(openPositionsTable).where(eq(openPositionsTable.pair, pair));\n  }\n\n  async deleteOpenPositionByLotId(lotId: string): Promise<void> {\n    await db.delete(openPositionsTable).where(eq(openPositionsTable.lotId, lotId));\n  }\n\n  async getOpenPositionsWithQtyRemaining(): Promise<OpenPosition[]> {\n    // Returns only positions with qtyRemaining > 0 (or null which means not yet initialized)\n    return await db.select().from(openPositionsTable)\n      .where(sql`${openPositionsTable.qtyRemaining} > 0 OR ${openPositionsTable.qtyRemaining} IS NULL`)\n      .orderBy(openPositionsTable.openedAt);\n  }\n\n  async updateOpenPositionQty(lotId: string, qtyRemaining: string, qtyFilled: string): Promise<void> {\n    await db.update(openPositionsTable)\n      .set({ qtyRemaining, qtyFilled, updatedAt: new Date() })\n      .where(eq(openPositionsTable.lotId, lotId));\n  }\n\n  async initializeQtyRemainingForAll(): Promise<number> {\n    // Initialize qtyRemaining = amount for all positions where qtyRemaining is null\n    const result = await db.execute(sql`\n      UPDATE open_positions \n      SET qty_remaining = amount, qty_filled = '0'\n      WHERE qty_remaining IS NULL\n    `);\n    return Number(result.rowCount || 0);\n  }\n\n  // Trade fills\n  async upsertTradeFill(fill: InsertTradeFill): Promise<{ inserted: boolean; fill?: TradeFill }> {\n    const existing = await this.getTradeFillByTxid(fill.txid);\n    if (existing) {\n      return { inserted: false, fill: existing };\n    }\n    try {\n      const [newFill] = await db.insert(tradeFillsTable).values(fill).returning();\n      return { inserted: true, fill: newFill };\n    } catch (error: any) {\n      if (error.code === '23505') { // Unique violation\n        const existingFill = await this.getTradeFillByTxid(fill.txid);\n        return { inserted: false, fill: existingFill };\n      }\n      throw error;\n    }\n  }\n\n  async getTradeFillByTxid(txid: string): Promise<TradeFill | undefined> {\n    const fills = await db.select().from(tradeFillsTable)\n      .where(eq(tradeFillsTable.txid, txid))\n      .limit(1);\n    return fills[0];\n  }\n\n  async getUnmatchedSellFills(pair: string): Promise<TradeFill[]> {\n    return await db.select().from(tradeFillsTable)\n      .where(and(\n        eq(tradeFillsTable.pair, pair),\n        sql`UPPER(${tradeFillsTable.type}) = 'SELL'`,\n        eq(tradeFillsTable.matched, false)\n      ))\n      .orderBy(tradeFillsTable.executedAt);\n  }\n\n  async markFillAsMatched(txid: string): Promise<void> {\n    await db.update(tradeFillsTable)\n      .set({ matched: true })\n      .where(eq(tradeFillsTable.txid, txid));\n  }\n\n  // Lot matches\n  async createLotMatch(match: InsertLotMatch): Promise<LotMatch> {\n    try {\n      const [newMatch] = await db.insert(lotMatchesTable).values(match).returning();\n      return newMatch;\n    } catch (error: any) {\n      if (error.code === '23505') { // Unique violation - already exists\n        const existing = await this.getLotMatchBySellFillAndLot(match.sellFillTxid, match.lotId);\n        if (existing) return existing;\n      }\n      throw error;\n    }\n  }\n\n  async getLotMatchesByLotId(lotId: string): Promise<LotMatch[]> {\n    return await db.select().from(lotMatchesTable)\n      .where(eq(lotMatchesTable.lotId, lotId))\n      .orderBy(lotMatchesTable.createdAt);\n  }\n\n  async getLotMatchBySellFillAndLot(sellFillTxid: string, lotId: string): Promise<LotMatch | undefined> {\n    const matches = await db.select().from(lotMatchesTable)\n      .where(and(\n        eq(lotMatchesTable.sellFillTxid, sellFillTxid),\n        eq(lotMatchesTable.lotId, lotId)\n      ))\n      .limit(1);\n    return matches[0];\n  }\n\n  async saveAiSample(sample: InsertAiTradeSample): Promise<AiTradeSample> {\n    const [newSample] = await db.insert(aiTradeSamplesTable).values(sample).returning();\n    return newSample;\n  }\n\n  async updateAiSample(sampleId: number, updates: Partial<InsertAiTradeSample>): Promise<AiTradeSample | undefined> {\n    const [updated] = await db.update(aiTradeSamplesTable)\n      .set(updates)\n      .where(eq(aiTradeSamplesTable.id, sampleId))\n      .returning();\n    return updated;\n  }\n\n  async getAiSamples(options?: { complete?: boolean; limit?: number }): Promise<AiTradeSample[]> {\n    const { complete, limit = 1000 } = options || {};\n    if (complete !== undefined) {\n      return await db.select().from(aiTradeSamplesTable)\n        .where(eq(aiTradeSamplesTable.isComplete, complete))\n        .orderBy(desc(aiTradeSamplesTable.createdAt))\n        .limit(limit);\n    }\n    return await db.select().from(aiTradeSamplesTable)\n      .orderBy(desc(aiTradeSamplesTable.createdAt))\n      .limit(limit);\n  }\n\n  async getAiSamplesCount(complete?: boolean): Promise<number> {\n    if (complete !== undefined) {\n      const result = await db.select({ count: sql<number>`count(*)` })\n        .from(aiTradeSamplesTable)\n        .where(eq(aiTradeSamplesTable.isComplete, complete));\n      return Number(result[0]?.count || 0);\n    }\n    const result = await db.select({ count: sql<number>`count(*)` }).from(aiTradeSamplesTable);\n    return Number(result[0]?.count || 0);\n  }\n\n  async saveAiShadowDecision(decision: InsertAiShadowDecision): Promise<AiShadowDecision> {\n    const [newDecision] = await db.insert(aiShadowDecisionsTable).values(decision).returning();\n    return newDecision;\n  }\n\n  async updateAiShadowFinalPnl(tradeId: string, pnl: string): Promise<void> {\n    await db.update(aiShadowDecisionsTable)\n      .set({ finalPnlNet: pnl })\n      .where(eq(aiShadowDecisionsTable.tradeId, tradeId));\n  }\n\n  async getAiShadowReport(): Promise<{ total: number; blocked: number; blockedLosers: number; passedLosers: number }> {\n    const allDecisions = await db.select().from(aiShadowDecisionsTable)\n      .where(sql`${aiShadowDecisionsTable.finalPnlNet} IS NOT NULL`);\n    \n    const total = allDecisions.length;\n    const blocked = allDecisions.filter(d => d.wouldBlock).length;\n    const blockedLosers = allDecisions.filter(d => d.wouldBlock && parseFloat(d.finalPnlNet || '0') < 0).length;\n    const passedLosers = allDecisions.filter(d => !d.wouldBlock && parseFloat(d.finalPnlNet || '0') < 0).length;\n    \n    return { total, blocked, blockedLosers, passedLosers };\n  }\n\n  async getAiConfig(): Promise<AiConfig | undefined> {\n    const configs = await db.select().from(aiConfigTable).limit(1);\n    if (configs.length === 0) {\n      const [newConfig] = await db.insert(aiConfigTable).values({}).returning();\n      return newConfig;\n    }\n    return configs[0];\n  }\n\n  async updateAiConfig(config: Partial<InsertAiConfig>): Promise<AiConfig> {\n    const existing = await this.getAiConfig();\n    if (!existing) {\n      const [newConfig] = await db.insert(aiConfigTable).values(config as InsertAiConfig).returning();\n      return newConfig;\n    }\n    const [updated] = await db.update(aiConfigTable)\n      .set({ ...config, updatedAt: new Date() })\n      .where(eq(aiConfigTable.id, existing.id))\n      .returning();\n    return updated;\n  }\n\n  async saveTrainingTrade(trade: InsertTrainingTrade): Promise<TrainingTrade> {\n    const [newTrade] = await db.insert(trainingTradesTable).values(trade).returning();\n    return newTrade;\n  }\n\n  async updateTrainingTrade(id: number, updates: Partial<InsertTrainingTrade>): Promise<TrainingTrade | undefined> {\n    const [updated] = await db.update(trainingTradesTable)\n      .set(updates)\n      .where(eq(trainingTradesTable.id, id))\n      .returning();\n    return updated;\n  }\n\n  async getTrainingTradeByBuyTxid(buyTxid: string): Promise<TrainingTrade | undefined> {\n    const trades = await db.select().from(trainingTradesTable)\n      .where(eq(trainingTradesTable.buyTxid, buyTxid))\n      .limit(1);\n    return trades[0];\n  }\n\n  // Obtener duplicados por buyTxid para limpieza de training_trades\n  async getDuplicateTrainingTradesByBuyTxid(): Promise<{ buyTxid: string; count: number; ids: number[] }[]> {\n    const result = await db.execute(sql`\n      SELECT buy_txid, COUNT(*) as count, ARRAY_AGG(id ORDER BY id) as ids\n      FROM training_trades\n      GROUP BY buy_txid\n      HAVING COUNT(*) > 1\n    `);\n    return (result.rows as any[]).map(row => ({\n      buyTxid: row.buy_txid,\n      count: parseInt(row.count),\n      ids: row.ids,\n    }));\n  }\n\n  // Eliminar duplicados en training_trades manteniendo el m√°s antiguo\n  async deleteDuplicateTrainingTrades(): Promise<number> {\n    const duplicates = await this.getDuplicateTrainingTradesByBuyTxid();\n    let deleted = 0;\n    \n    for (const dup of duplicates) {\n      const idsToDelete = dup.ids.slice(1);\n      for (const id of idsToDelete) {\n        await db.delete(trainingTradesTable).where(eq(trainingTradesTable.id, id));\n        deleted++;\n      }\n    }\n    \n    return deleted;\n  }\n\n  async getTrainingTrades(options?: { closed?: boolean; labeled?: boolean; limit?: number }): Promise<TrainingTrade[]> {\n    const { closed, labeled, limit = 1000 } = options || {};\n    const conditions: any[] = [];\n    \n    if (closed !== undefined) {\n      conditions.push(eq(trainingTradesTable.isClosed, closed));\n    }\n    if (labeled !== undefined) {\n      conditions.push(eq(trainingTradesTable.isLabeled, labeled));\n    }\n    \n    const whereClause = conditions.length > 0 \n      ? (conditions.length === 1 ? conditions[0] : and(...conditions)) \n      : undefined;\n    \n    const query = db.select().from(trainingTradesTable)\n      .orderBy(desc(trainingTradesTable.entryTs))\n      .limit(limit);\n    \n    return whereClause ? await query.where(whereClause) : await query;\n  }\n\n  async getTrainingTradesCount(options?: { closed?: boolean; labeled?: boolean; hasOpenLots?: boolean }): Promise<number> {\n    const { closed, labeled, hasOpenLots } = options || {};\n    const conditions: any[] = [];\n    \n    if (closed !== undefined) {\n      conditions.push(eq(trainingTradesTable.isClosed, closed));\n    }\n    if (labeled !== undefined) {\n      conditions.push(eq(trainingTradesTable.isLabeled, labeled));\n    }\n    if (hasOpenLots === true) {\n      conditions.push(sql`${trainingTradesTable.qtyRemaining} > 0`);\n    }\n    \n    const whereClause = conditions.length > 0 \n      ? (conditions.length === 1 ? conditions[0] : and(...conditions)) \n      : undefined;\n    \n    const query = db.select({ count: sql<number>`count(*)` }).from(trainingTradesTable);\n    const result = whereClause ? await query.where(whereClause) : await query;\n    return Number(result[0]?.count || 0);\n  }\n\n  async getDiscardReasonsDataset(): Promise<Record<string, number>> {\n    const result = await db.select({\n      discardReason: trainingTradesTable.discardReason,\n      count: sql<number>`count(*)`,\n    })\n    .from(trainingTradesTable)\n    .where(sql`${trainingTradesTable.discardReason} IS NOT NULL`)\n    .groupBy(trainingTradesTable.discardReason);\n    \n    const reasons: Record<string, number> = {};\n    for (const row of result) {\n      if (row.discardReason) {\n        reasons[row.discardReason] = Number(row.count);\n      }\n    }\n    return reasons;\n  }\n\n  async getAllTradesForBackfill(): Promise<Trade[]> {\n    return await db.select().from(tradesTable)\n      .where(eq(tradesTable.status, 'filled'))\n      .orderBy(tradesTable.executedAt);\n  }\n\n  async runTrainingTradesBackfill(): Promise<{ created: number; closed: number; labeled: number; discardReasons: Record<string, number> }> {\n    const allTrades = await this.getAllTradesForBackfill();\n    const discardReasons: Record<string, number> = {};\n    let created = 0;\n    let closed = 0;\n    let labeled = 0;\n    \n    const KRAKEN_FEE_RATE = 0.004;\n    const PNL_OUTLIER_THRESHOLD = 100; // Increased from 50% - crypto is volatile\n    const MAX_HOLD_TIME_DAYS = 30;\n    const MIN_FEE_PCT = 0.1; // Lowered from 0.5% - discount tiers exist\n    const MAX_FEE_PCT = 2.5; // Raised from 2.0% - allow for spread costs\n    const QTY_EPSILON = 0.00000001;\n    \n    const tradesByPair: Record<string, Trade[]> = {};\n    for (const trade of allTrades) {\n      if (!tradesByPair[trade.pair]) tradesByPair[trade.pair] = [];\n      tradesByPair[trade.pair].push(trade);\n    }\n    \n    for (const pair of Object.keys(tradesByPair)) {\n      // Ordenaci√≥n estable FIFO: timestamp + id (tie-breaker determinista)\n      const pairTrades = tradesByPair[pair].sort((a, b) => {\n        const timeA = a.executedAt ? new Date(a.executedAt).getTime() : 0;\n        const timeB = b.executedAt ? new Date(b.executedAt).getTime() : 0;\n        if (timeA !== timeB) return timeA - timeB;\n        // Tie-breaker: ID de base de datos (determinista)\n        return a.id - b.id;\n      });\n      \n      interface OpenLot {\n        dbId: number | null;\n        buyTxid: string;\n        entryPrice: number;\n        entryAmount: number;\n        qtyRemaining: number;\n        entryTs: Date;\n        costUsd: number;\n        entryFee: number;\n        sellTxids: string[];\n        totalRevenue: number;\n        totalExitFee: number;\n        lastSellTs: Date | null;\n        lastSellPrice: number;\n      }\n      \n      const openLots: OpenLot[] = [];\n      \n      for (const trade of pairTrades) {\n        const tradeTime = trade.executedAt ? new Date(trade.executedAt) : null;\n        const tradeAmount = parseFloat(trade.amount || '0');\n        const tradePrice = parseFloat(trade.price || '0');\n        const tradeTxid = trade.krakenOrderId || trade.tradeId;\n        \n        if (!tradeTime) {\n          discardReasons['sin_fecha_ejecucion'] = (discardReasons['sin_fecha_ejecucion'] || 0) + 1;\n          continue;\n        }\n        \n        if (tradeAmount <= 0 || tradePrice <= 0) {\n          discardReasons['datos_invalidos'] = (discardReasons['datos_invalidos'] || 0) + 1;\n          continue;\n        }\n        \n        if (trade.type === 'buy') {\n          const existing = await this.getTrainingTradeByBuyTxid(tradeTxid);\n          if (existing) {\n            const qtyRem = parseFloat(existing.qtyRemaining || existing.entryAmount || '0');\n            \n            // Si ya est√° cerrado y etiquetado/descartado, es inmutable - no reprocesar\n            if (existing.isClosed && qtyRem <= QTY_EPSILON) {\n              // Trade ya procesado completamente - skip sin modificar\n              continue;\n            }\n            \n            // Solo a√±adir a openLots si tiene cantidad restante para procesar\n            if (qtyRem > QTY_EPSILON) {\n              openLots.push({\n                dbId: existing.id,\n                buyTxid: tradeTxid,\n                entryPrice: parseFloat(existing.entryPrice),\n                entryAmount: parseFloat(existing.entryAmount),\n                qtyRemaining: qtyRem,\n                entryTs: new Date(existing.entryTs),\n                costUsd: parseFloat(existing.costUsd),\n                entryFee: parseFloat(existing.entryFee || '0'),\n                sellTxids: (existing.sellTxidsJson as string[]) || [],\n                totalRevenue: parseFloat(existing.revenueUsd || '0'),\n                totalExitFee: parseFloat(existing.exitFee || '0'),\n                lastSellTs: existing.exitTs ? new Date(existing.exitTs) : null,\n                lastSellPrice: parseFloat(existing.exitPrice || '0'),\n              });\n            }\n            continue;\n          }\n          \n          const buyCost = tradeAmount * tradePrice;\n          const entryFee = buyCost * KRAKEN_FEE_RATE;\n          \n          const trainingTrade: InsertTrainingTrade = {\n            pair,\n            buyTxid: tradeTxid,\n            entryPrice: trade.price,\n            entryAmount: trade.amount,\n            qtyRemaining: trade.amount,\n            costUsd: buyCost.toFixed(8),\n            entryFee: entryFee.toFixed(8),\n            entryTs: tradeTime,\n            sellTxidsJson: [],\n            isClosed: false,\n            isLabeled: false,\n          };\n          \n          const saved = await this.saveTrainingTrade(trainingTrade);\n          created++;\n          \n          openLots.push({\n            dbId: saved.id,\n            buyTxid: tradeTxid,\n            entryPrice: tradePrice,\n            entryAmount: tradeAmount,\n            qtyRemaining: tradeAmount,\n            entryTs: tradeTime,\n            costUsd: buyCost,\n            entryFee,\n            sellTxids: [],\n            totalRevenue: 0,\n            totalExitFee: 0,\n            lastSellTs: null,\n            lastSellPrice: 0,\n          });\n          \n        } else if (trade.type === 'sell') {\n          let remainingToSell = tradeAmount;\n          const sellPrice = tradePrice;\n          const sellTime = tradeTime;\n          \n          if (openLots.length === 0) {\n            discardReasons['venta_sin_compra_previa'] = (discardReasons['venta_sin_compra_previa'] || 0) + 1;\n            continue;\n          }\n          \n          while (remainingToSell > QTY_EPSILON && openLots.length > 0) {\n            const lot = openLots[0];\n            const consumeQty = Math.min(remainingToSell, lot.qtyRemaining);\n            const proportion = consumeQty / lot.entryAmount;\n            const sellRevenue = consumeQty * sellPrice;\n            const sellFee = sellRevenue * KRAKEN_FEE_RATE;\n            \n            lot.qtyRemaining -= consumeQty;\n            remainingToSell -= consumeQty;\n            lot.sellTxids.push(tradeTxid);\n            lot.totalRevenue += sellRevenue;\n            lot.totalExitFee += sellFee;\n            lot.lastSellTs = sellTime;\n            lot.lastSellPrice = sellPrice;\n            \n            if (lot.qtyRemaining <= QTY_EPSILON) {\n              const pnlGross = lot.totalRevenue - lot.costUsd;\n              const pnlNet = pnlGross - lot.entryFee - lot.totalExitFee;\n              const pnlPct = (pnlNet / lot.costUsd) * 100;\n              const holdTimeMinutes = Math.round((lot.lastSellTs!.getTime() - lot.entryTs.getTime()) / 60000);\n              \n              let discardReason: string | null = null;\n              \n              const totalFeePct = ((lot.entryFee + lot.totalExitFee) / lot.costUsd) * 100;\n              if (totalFeePct > MAX_FEE_PCT || totalFeePct < MIN_FEE_PCT) {\n                discardReason = 'comisiones_anormales';\n              } else if (Math.abs(pnlPct) > PNL_OUTLIER_THRESHOLD) {\n                discardReason = 'pnl_atipico';\n              } else if (holdTimeMinutes / (60 * 24) > MAX_HOLD_TIME_DAYS) {\n                discardReason = 'hold_excesivo';\n              } else if (holdTimeMinutes < 0) {\n                discardReason = 'timestamps_invalidos';\n              }\n              \n              if (discardReason) {\n                discardReasons[discardReason] = (discardReasons[discardReason] || 0) + 1;\n              }\n              \n              const avgExitPrice = lot.totalRevenue / lot.entryAmount;\n              \n              await this.updateTrainingTrade(lot.dbId!, {\n                sellTxid: lot.sellTxids[lot.sellTxids.length - 1],\n                sellTxidsJson: lot.sellTxids,\n                exitPrice: avgExitPrice.toFixed(8),\n                exitAmount: lot.entryAmount.toFixed(8),\n                qtyRemaining: '0',\n                revenueUsd: lot.totalRevenue.toFixed(8),\n                exitFee: lot.totalExitFee.toFixed(8),\n                pnlGross: pnlGross.toFixed(8),\n                pnlNet: pnlNet.toFixed(8),\n                pnlPct: pnlPct.toFixed(4),\n                holdTimeMinutes,\n                labelWin: discardReason ? undefined : (pnlNet > 0 ? 1 : 0),\n                exitTs: lot.lastSellTs!,\n                isClosed: true,\n                isLabeled: discardReason ? false : true,\n                discardReason: discardReason || undefined,\n              });\n              \n              closed++;\n              if (!discardReason) labeled++;\n              \n              openLots.shift();\n            } else {\n              await this.updateTrainingTrade(lot.dbId!, {\n                qtyRemaining: lot.qtyRemaining.toFixed(8),\n                sellTxidsJson: lot.sellTxids,\n              });\n            }\n          }\n          \n          if (remainingToSell > QTY_EPSILON) {\n            discardReasons['venta_excede_lotes'] = (discardReasons['venta_excede_lotes'] || 0) + 1;\n          }\n        }\n      }\n      \n      for (const lot of openLots) {\n        if (lot.qtyRemaining > QTY_EPSILON && lot.qtyRemaining < lot.entryAmount) {\n          await this.updateTrainingTrade(lot.dbId!, {\n            qtyRemaining: lot.qtyRemaining.toFixed(8),\n            sellTxidsJson: lot.sellTxids,\n          });\n        }\n      }\n    }\n    \n    // Invariance check: if qtyRemaining <= epsilon then normalize to 0 and ensure isClosed=true\n    const allTrainingTrades = await db.select().from(trainingTradesTable);\n    for (const trade of allTrainingTrades) {\n      const qty = parseFloat(trade.qtyRemaining || trade.entryAmount || '0');\n      if (qty <= QTY_EPSILON && qty > 0) {\n        // Normalize tiny residuals to exactly 0\n        await this.updateTrainingTrade(trade.id, { qtyRemaining: '0', isClosed: true });\n      } else if (qty <= QTY_EPSILON && !trade.isClosed) {\n        // qty is already 0 but isClosed is false - fix invariance\n        await this.updateTrainingTrade(trade.id, { isClosed: true });\n      }\n    }\n    \n    return { created, closed, labeled, discardReasons };\n  }\n\n  async checkSchemaHealth(): Promise<{ healthy: boolean; missingColumns: string[]; migrationRan: boolean }> {\n    const missingColumns: string[] = [];\n    \n    // Check required columns in bot_config table\n    const requiredBotConfigColumns = [\n      { column: 'sg_max_open_lots_per_pair', table: 'bot_config' },\n      { column: 'sg_pair_overrides', table: 'bot_config' },\n      { column: 'dry_run_mode', table: 'bot_config' },\n      { column: 'sg_min_entry_usd', table: 'bot_config' },\n      { column: 'sg_allow_under_min', table: 'bot_config' },\n      { column: 'sg_be_at_pct', table: 'bot_config' },\n      { column: 'sg_trail_start_pct', table: 'bot_config' },\n      { column: 'sg_trail_distance_pct', table: 'bot_config' },\n      { column: 'sg_trail_step_pct', table: 'bot_config' },\n      { column: 'sg_tp_fixed_enabled', table: 'bot_config' },\n      { column: 'sg_tp_fixed_pct', table: 'bot_config' },\n      { column: 'sg_scale_out_enabled', table: 'bot_config' },\n      { column: 'sg_scale_out_pct', table: 'bot_config' },\n      { column: 'sg_min_part_usd', table: 'bot_config' },\n      { column: 'sg_scale_out_threshold', table: 'bot_config' },\n      { column: 'sg_fee_cushion_pct', table: 'bot_config' },\n      { column: 'sg_fee_cushion_auto', table: 'bot_config' },\n    ];\n    \n    const requiredOpenPositionsColumns = [\n      { column: 'lot_id', table: 'open_positions' },\n      { column: 'sg_break_even_activated', table: 'open_positions' },\n      { column: 'sg_trailing_activated', table: 'open_positions' },\n      { column: 'sg_current_stop_price', table: 'open_positions' },\n      { column: 'sg_scale_out_done', table: 'open_positions' },\n      { column: 'config_snapshot_json', table: 'open_positions' },\n    ];\n    \n    const allRequiredColumns = [...requiredBotConfigColumns, ...requiredOpenPositionsColumns];\n    \n    // Health check ONLY reports status - does NOT auto-migrate\n    // Migration should be run by script/migrate.ts (Docker startup) or manually\n    // This ensures the migration flow has a single source of truth\n    for (const { column, table } of allRequiredColumns) {\n      const result = await db.execute(sql`\n        SELECT column_name FROM information_schema.columns \n        WHERE table_name = ${table} AND column_name = ${column}\n      `);\n      if (result.rows.length === 0) {\n        missingColumns.push(`${table}.${column}`);\n      }\n    }\n    \n    if (missingColumns.length > 0) {\n      console.warn(`[schema] Health check: missing columns detected: ${missingColumns.join(', ')}`);\n      console.warn('[schema] Run \"npx tsx script/migrate.ts\" to fix schema issues');\n    }\n    \n    return { healthy: missingColumns.length === 0, missingColumns, migrationRan: false };\n  }\n\n  async runSchemaMigration(): Promise<{ success: boolean; columnsAdded: string[]; error?: string }> {\n    const columnsAdded: string[] = [];\n    \n    try {\n      // Define all migrations with safe ADD COLUMN IF NOT EXISTS\n      const migrations = [\n        // bot_config columns\n        { table: 'bot_config', column: 'sg_max_open_lots_per_pair', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_max_open_lots_per_pair INTEGER DEFAULT 1' },\n        { table: 'bot_config', column: 'sg_pair_overrides', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_pair_overrides JSONB' },\n        { table: 'bot_config', column: 'dry_run_mode', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS dry_run_mode BOOLEAN DEFAULT false' },\n        { table: 'bot_config', column: 'sg_min_entry_usd', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_entry_usd DECIMAL(10,2) DEFAULT 100.00' },\n        { table: 'bot_config', column: 'sg_allow_under_min', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_allow_under_min BOOLEAN DEFAULT true' },\n        { table: 'bot_config', column: 'sg_be_at_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_be_at_pct DECIMAL(5,2) DEFAULT 1.50' },\n        { table: 'bot_config', column: 'sg_trail_start_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_start_pct DECIMAL(5,2) DEFAULT 2.00' },\n        { table: 'bot_config', column: 'sg_trail_distance_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_distance_pct DECIMAL(5,2) DEFAULT 1.50' },\n        { table: 'bot_config', column: 'sg_trail_step_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_step_pct DECIMAL(5,2) DEFAULT 0.25' },\n        { table: 'bot_config', column: 'sg_tp_fixed_enabled', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_enabled BOOLEAN DEFAULT false' },\n        { table: 'bot_config', column: 'sg_tp_fixed_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_pct DECIMAL(5,2) DEFAULT 10.00' },\n        { table: 'bot_config', column: 'sg_scale_out_enabled', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_enabled BOOLEAN DEFAULT false' },\n        { table: 'bot_config', column: 'sg_scale_out_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_pct DECIMAL(5,2) DEFAULT 35.00' },\n        { table: 'bot_config', column: 'sg_min_part_usd', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_part_usd DECIMAL(10,2) DEFAULT 50.00' },\n        { table: 'bot_config', column: 'sg_scale_out_threshold', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_threshold DECIMAL(5,2) DEFAULT 80.00' },\n        { table: 'bot_config', column: 'sg_fee_cushion_pct', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_pct DECIMAL(5,2) DEFAULT 0.45' },\n        { table: 'bot_config', column: 'sg_fee_cushion_auto', sql: 'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_auto BOOLEAN DEFAULT true' },\n        \n        // open_positions columns\n        { table: 'open_positions', column: 'lot_id', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS lot_id TEXT' },\n        { table: 'open_positions', column: 'sg_break_even_activated', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_break_even_activated BOOLEAN DEFAULT false' },\n        { table: 'open_positions', column: 'sg_trailing_activated', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_trailing_activated BOOLEAN DEFAULT false' },\n        { table: 'open_positions', column: 'sg_current_stop_price', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_current_stop_price DECIMAL(18,8)' },\n        { table: 'open_positions', column: 'sg_scale_out_done', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_scale_out_done BOOLEAN DEFAULT false' },\n        { table: 'open_positions', column: 'config_snapshot_json', sql: 'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS config_snapshot_json JSONB' },\n      ];\n      \n      for (const migration of migrations) {\n        try {\n          await db.execute(sql.raw(migration.sql));\n          columnsAdded.push(`${migration.table}.${migration.column}`);\n        } catch (e) {\n          // Column may already exist, continue\n        }\n      }\n      \n      // Backfill lot_id for existing positions without it\n      try {\n        await db.execute(sql`\n          UPDATE open_positions \n          SET lot_id = 'LEGACY-' || id::text || '-' || SUBSTRING(MD5(pair || opened_at::text) FROM 1 FOR 6)\n          WHERE lot_id IS NULL\n        `);\n        \n        // Add unique constraint if not exists (safe: only if all lot_ids are unique)\n        const duplicates = await db.execute(sql`\n          SELECT lot_id, COUNT(*) FROM open_positions WHERE lot_id IS NOT NULL GROUP BY lot_id HAVING COUNT(*) > 1\n        `);\n        if (duplicates.rows.length === 0) {\n          try {\n            await db.execute(sql`\n              ALTER TABLE open_positions ADD CONSTRAINT open_positions_lot_id_unique UNIQUE (lot_id)\n            `);\n          } catch (e) {\n            // Constraint may already exist\n          }\n        }\n      } catch (e) {\n        console.log('[schema] lot_id backfill note:', e);\n      }\n      \n      console.log(`[schema] Migration completed. Columns added: ${columnsAdded.join(', ') || 'none (all exist)'}`);\n      return { success: true, columnsAdded };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      console.error('[schema] Migration failed:', errorMessage);\n      return { success: false, columnsAdded, error: errorMessage };\n    }\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":49308,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/input-group.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nfunction InputGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"input-group\"\n      role=\"group\"\n      className={cn(\n        \"group/input-group border-input dark:bg-input/30 shadow-xs relative flex w-full items-center rounded-md border outline-none transition-[color,box-shadow]\",\n        \"h-9 has-[>textarea]:h-auto\",\n\n        // Variants based on alignment.\n        \"has-[>[data-align=inline-start]]:[&>input]:pl-2\",\n        \"has-[>[data-align=inline-end]]:[&>input]:pr-2\",\n        \"has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3\",\n        \"has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3\",\n\n        // Focus state.\n        \"has-[[data-slot=input-group-control]:focus-visible]:ring-ring has-[[data-slot=input-group-control]:focus-visible]:ring-1\",\n\n        // Error state.\n        \"has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40\",\n\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupAddonVariants = cva(\n  \"text-muted-foreground flex h-auto cursor-text select-none items-center justify-center gap-2 py-1.5 text-sm font-medium group-data-[disabled=true]/input-group:opacity-50 [&>kbd]:rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-4\",\n  {\n    variants: {\n      align: {\n        \"inline-start\":\n          \"order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]\",\n        \"inline-end\":\n          \"order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]\",\n        \"block-start\":\n          \"[.border-b]:pb-3 order-first w-full justify-start px-3 pt-3 group-has-[>input]/input-group:pt-2.5\",\n        \"block-end\":\n          \"[.border-t]:pt-3 order-last w-full justify-start px-3 pb-3 group-has-[>input]/input-group:pb-2.5\",\n      },\n    },\n    defaultVariants: {\n      align: \"inline-start\",\n    },\n  }\n)\n\nfunction InputGroupAddon({\n  className,\n  align = \"inline-start\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof inputGroupAddonVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"input-group-addon\"\n      data-align={align}\n      className={cn(inputGroupAddonVariants({ align }), className)}\n      onClick={(e) => {\n        if ((e.target as HTMLElement).closest(\"button\")) {\n          return\n        }\n        e.currentTarget.parentElement?.querySelector(\"input\")?.focus()\n      }}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupButtonVariants = cva(\n  \"flex items-center gap-2 text-sm shadow-none\",\n  {\n    variants: {\n      size: {\n        xs: \"h-6 gap-1 rounded-[calc(var(--radius)-5px)] px-2 has-[>svg]:px-2 [&>svg:not([class*='size-'])]:size-3.5\",\n        sm: \"h-8 gap-1.5 rounded-md px-2.5 has-[>svg]:px-2.5\",\n        \"icon-xs\":\n          \"size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0\",\n        \"icon-sm\": \"size-8 p-0 has-[>svg]:p-0\",\n      },\n    },\n    defaultVariants: {\n      size: \"xs\",\n    },\n  }\n)\n\nfunction InputGroupButton({\n  className,\n  type = \"button\",\n  variant = \"ghost\",\n  size = \"xs\",\n  ...props\n}: Omit<React.ComponentProps<typeof Button>, \"size\"> &\n  VariantProps<typeof inputGroupButtonVariants>) {\n  return (\n    <Button\n      type={type}\n      data-size={size}\n      variant={variant}\n      className={cn(inputGroupButtonVariants({ size }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupText({ className, ...props }: React.ComponentProps<\"span\">) {\n  return (\n    <span\n      className={cn(\n        \"text-muted-foreground flex items-center gap-2 text-sm [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupInput({\n  className,\n  ...props\n}: React.ComponentProps<\"input\">) {\n  return (\n    <Input\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupTextarea({\n  className,\n  ...props\n}: React.ComponentProps<\"textarea\">) {\n  return (\n    <Textarea\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  InputGroup,\n  InputGroupAddon,\n  InputGroupButton,\n  InputGroupText,\n  InputGroupInput,\n  InputGroupTextarea,\n}\n","path":null,"size_bytes":4971,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-primary/10\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":266,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"import * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1237,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes, initializeWebSockets } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\n\nconst app = express();\nconst httpServer = createServer(app);\n\ninitializeWebSockets(httpServer);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n    },\n  );\n})();\n","path":null,"size_bytes":2617,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // @replit\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \",\n  {\n    variants: {\n      variant: {\n        default:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary:\n          // @replit no hover because we use hover-elevate\n          \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n          // @replit shadow-xs\" - use badge outline variable\n        outline: \"text-foreground border [border-color:var(--badge-outline)]\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1522,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7406,"size_tokens":null},"client/src/components/ui/spinner.tsx":{"content":"import { Loader2Icon } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Spinner({ className, ...props }: React.ComponentProps<\"svg\">) {\n  return (\n    <Loader2Icon\n      role=\"status\"\n      aria-label=\"Loading\"\n      className={cn(\"size-4 animate-spin\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Spinner }\n","path":null,"size_bytes":331,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":2001,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/node-postgres\";\nimport pg from \"pg\";\nimport * as schema from \"@shared/schema\";\n\nconst { Pool } = pg;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL environment variable is not set\");\n}\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n});\n\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":362,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-3.5 w-3.5 fill-primary\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1410,"size_tokens":null},"client/src/components/dashboard/Nav.tsx":{"content":"import { useState } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { LayoutDashboard, Activity, Settings, Wallet, Bell, Plug, Menu, X, BookOpen, BarChart3, Monitor } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\nexport function Nav() {\n  const [location] = useLocation();\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n\n  const links = [\n    { href: \"/\", label: \"PANEL\", icon: LayoutDashboard },\n    { href: \"/strategies\", label: \"ESTRATEGIAS\", icon: Activity },\n    { href: \"/terminal\", label: \"TERMINAL\", icon: BarChart3 },\n    { href: \"/monitor\", label: \"MONITOR\", icon: Monitor },\n    { href: \"/wallet\", label: \"CARTERA\", icon: Wallet },\n    { href: \"/integrations\", label: \"INTEGRACIONES\", icon: Plug },\n    { href: \"/settings\", label: \"AJUSTES\", icon: Settings },\n    { href: \"/guide\", label: \"GU√çA\", icon: BookOpen },\n  ];\n\n  return (\n    <>\n      <nav className=\"h-14 md:h-16 border-b border-border bg-card/80 backdrop-blur-md sticky top-0 z-50 px-4 md:px-6 flex items-center justify-between\">\n        <div className=\"flex items-center gap-4 md:gap-8\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\" \n            className=\"md:hidden text-muted-foreground\"\n            onClick={() => setMobileMenuOpen(!mobileMenuOpen)}\n            data-testid=\"button-mobile-menu\"\n          >\n            {mobileMenuOpen ? <X className=\"h-5 w-5\" /> : <Menu className=\"h-5 w-5\" />}\n          </Button>\n          \n          <div className=\"flex items-center gap-2\">\n            <div className=\"h-7 w-7 md:h-8 md:w-8 bg-primary/20 rounded-md flex items-center justify-center border border-primary/50\">\n              <Activity className=\"h-4 w-4 md:h-5 md:w-5 text-primary\" />\n            </div>\n            <span className=\"font-sans font-bold text-base md:text-lg tracking-tight\">\n              KRAKEN<span className=\"text-primary\">BOT</span><span className=\"hidden sm:inline\">.AI</span>\n            </span>\n          </div>\n\n          <div className=\"hidden md:flex items-center gap-1\">\n            {links.map((link) => (\n              <Link \n                key={link.href} \n                href={link.href}\n                className={cn(\n                  \"px-2 lg:px-3 xl:px-4 py-2 rounded-md text-xs font-mono transition-colors flex items-center gap-1.5 lg:gap-2\",\n                  location === link.href \n                    ? \"bg-primary/10 text-primary border border-primary/20\" \n                    : \"text-muted-foreground hover:text-foreground hover:bg-white/5\"\n                )}\n              >\n                <link.icon className=\"h-4 w-4\" />\n                <span className=\"hidden lg:inline text-xs\">{link.label}</span>\n              </Link>\n            ))}\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-2 md:gap-4\">\n          <Button variant=\"ghost\" size=\"icon\" className=\"relative text-muted-foreground hover:text-foreground h-8 w-8 md:h-10 md:w-10\">\n            <Bell className=\"h-4 w-4 md:h-5 md:w-5\" />\n            <span className=\"absolute top-1.5 right-1.5 md:top-2 md:right-2 h-2 w-2 bg-red-500 rounded-full animate-pulse\" />\n          </Button>\n          <div className=\"h-7 w-7 md:h-8 md:w-8 rounded-full bg-gradient-to-tr from-primary to-purple-500 border border-white/10\" />\n        </div>\n      </nav>\n      \n      {mobileMenuOpen && (\n        <>\n          <div \n            className=\"md:hidden fixed inset-0 top-14 z-30 bg-black/50\"\n            onClick={() => setMobileMenuOpen(false)}\n            aria-hidden=\"true\"\n          />\n          <div className=\"md:hidden fixed inset-x-0 top-14 z-40 bg-background border-b border-border max-h-[calc(100vh-3.5rem)] overflow-y-auto\">\n            <div className=\"flex flex-col p-4 gap-2\">\n              {links.map((link) => (\n                <Link \n                  key={link.href} \n                  href={link.href}\n                  onClick={() => setMobileMenuOpen(false)}\n                  className={cn(\n                    \"px-4 py-3 rounded-lg text-sm font-mono transition-colors flex items-center gap-3\",\n                    location === link.href \n                      ? \"bg-primary/10 text-primary border border-primary/20\" \n                      : \"text-muted-foreground hover:text-foreground hover:bg-white/5 border border-transparent\"\n                  )}\n                >\n                  <link.icon className=\"h-5 w-5\" />\n                  {link.label}\n                </Link>\n              ))}\n            </div>\n          </div>\n        </>\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":4603,"size_tokens":null},"client/src/components/dashboard/Ticker.tsx":{"content":"import { ArrowUpRight, ArrowDownRight } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useQuery } from \"@tanstack/react-query\";\n\ninterface DashboardData {\n  prices: Record<string, { price: string; change: string }>;\n}\n\nconst PAIR_NAMES: Record<string, string> = {\n  \"XXBTZUSD\": \"BTC/USD\",\n  \"XETHZUSD\": \"ETH/USD\",\n  \"SOLUSD\": \"SOL/USD\",\n  \"XXRPZUSD\": \"XRP/USD\",\n  \"TONUSD\": \"TON/USD\",\n};\n\nfunction formatPrice(price: string): string {\n  const num = parseFloat(price);\n  if (num >= 1000) {\n    return num.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n  }\n  return num.toFixed(num < 1 ? 6 : 2);\n}\n\nexport function Ticker() {\n  const { data } = useQuery<DashboardData>({\n    queryKey: [\"/api/dashboard\"],\n    refetchInterval: 10000,\n  });\n\n  const pairs = data?.prices \n    ? Object.entries(data.prices).map(([key, value]) => ({\n        symbol: PAIR_NAMES[key] || key,\n        price: formatPrice(value.price),\n        change: `${parseFloat(value.change) >= 0 ? \"+\" : \"\"}${value.change}%`,\n        up: parseFloat(value.change) >= 0,\n      }))\n    : [\n        { symbol: \"BTC/USD\", price: \"--\", change: \"--%\", up: true },\n        { symbol: \"ETH/USD\", price: \"--\", change: \"--%\", up: true },\n        { symbol: \"SOL/USD\", price: \"--\", change: \"--%\", up: true },\n      ];\n\n  return (\n    <div className=\"w-full bg-card/50 border-b border-border overflow-hidden py-2 flex items-center whitespace-nowrap group\">\n      <div className=\"flex animate-ticker group-hover:[animation-play-state:paused] gap-12 px-4\">\n        {[...pairs, ...pairs, ...pairs, ...pairs].map((pair, idx) => (\n          <div key={idx} className=\"flex items-center gap-3 font-mono text-sm\">\n            <span className=\"text-muted-foreground font-bold\">{pair.symbol}</span>\n            <span className=\"text-foreground font-medium\">${pair.price}</span>\n            <span className={cn(\"flex items-center text-xs font-medium\", pair.up ? \"text-green-500\" : \"text-red-500\")}>\n              {pair.up ? <ArrowUpRight className=\"h-3 w-3 mr-0.5\" /> : <ArrowDownRight className=\"h-3 w-3 mr-0.5\" />}\n              {pair.change}\n            </span>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2210,"size_tokens":null},"client/src/components/dashboard/ChartWidget.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Area, AreaChart, CartesianGrid, ResponsiveContainer, Tooltip, XAxis, YAxis } from \"recharts\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { RefreshCw, TrendingUp, TrendingDown, Target, Activity } from \"lucide-react\";\n\ninterface PerformanceData {\n  curve: { time: string; equity: number; pnl?: number }[];\n  summary: {\n    startingEquity: number;\n    endingEquity: number;\n    totalPnlUsd: number;\n    totalPnlPct: number;\n    maxDrawdownPct: number;\n    winRatePct: number;\n    totalTrades: number;\n    wins: number;\n    losses: number;\n  };\n}\n\nexport function ChartWidget() {\n  const { data, isLoading, refetch, isFetching } = useQuery<PerformanceData>({\n    queryKey: [\"performance\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/performance\");\n      if (!res.ok) throw new Error(\"Failed to fetch performance\");\n      return res.json();\n    },\n    refetchInterval: false,\n  });\n\n  const chartData = data?.curve.map((point) => ({\n    time: new Date(point.time).toLocaleDateString(\"es-ES\", { \n      month: \"short\", \n      day: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\"\n    }),\n    equity: point.equity,\n  })) || [];\n\n  const summary = data?.summary;\n  const isPositive = (summary?.totalPnlUsd || 0) >= 0;\n  const hasTrades = (summary?.totalTrades || 0) > 0;\n\n  return (\n    <Card className=\"col-span-2 glass-panel border-border/50 h-full flex flex-col\">\n      <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n        <CardTitle className=\"text-sm font-medium font-mono tracking-wider text-muted-foreground\">\n          RENDIMIENTO DEL PORTAFOLIO\n        </CardTitle>\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          onClick={() => refetch()}\n          disabled={isFetching}\n          className=\"h-8 px-2\"\n          data-testid=\"btn-refresh-chart\"\n        >\n          <RefreshCw className={`h-4 w-4 ${isFetching ? 'animate-spin' : ''}`} />\n        </Button>\n      </CardHeader>\n      \n      {summary && (\n        <div className=\"px-6 pb-2 grid grid-cols-2 md:grid-cols-4 gap-3\">\n          <div className=\"flex items-center gap-2 p-2 rounded-lg bg-muted/30\">\n            {isPositive ? (\n              <TrendingUp className=\"h-4 w-4 text-emerald-400\" />\n            ) : (\n              <TrendingDown className=\"h-4 w-4 text-red-400\" />\n            )}\n            <div>\n              <div className=\"text-xs text-muted-foreground\">P&L Total</div>\n              <div className={`font-mono font-semibold ${isPositive ? 'text-emerald-400' : 'text-red-400'}`}>\n                {isPositive ? '+' : ''}{summary.totalPnlUsd.toFixed(2)} USD\n              </div>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2 p-2 rounded-lg bg-muted/30\">\n            <Target className=\"h-4 w-4 text-cyan-400\" />\n            <div>\n              <div className=\"text-xs text-muted-foreground\">Win Rate</div>\n              <div className=\"font-mono font-semibold text-cyan-400\">\n                {summary.winRatePct.toFixed(1)}%\n              </div>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2 p-2 rounded-lg bg-muted/30\">\n            <Activity className=\"h-4 w-4 text-purple-400\" />\n            <div>\n              <div className=\"text-xs text-muted-foreground\">Trades</div>\n              <div className=\"font-mono font-semibold text-purple-400\">\n                {summary.totalTrades} ({summary.wins}W/{summary.losses}L)\n              </div>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-2 p-2 rounded-lg bg-muted/30\">\n            <TrendingDown className=\"h-4 w-4 text-orange-400\" />\n            <div>\n              <div className=\"text-xs text-muted-foreground\">Max Drawdown</div>\n              <div className=\"font-mono font-semibold text-orange-400\">\n                -{summary.maxDrawdownPct.toFixed(2)}%\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <CardContent className=\"flex-1 min-h-[280px] w-full pt-2\">\n        {isLoading ? (\n          <div className=\"h-full flex items-center justify-center text-muted-foreground\">\n            Cargando datos de rendimiento...\n          </div>\n        ) : !hasTrades ? (\n          <div className=\"h-full flex flex-col items-center justify-center text-muted-foreground gap-3\">\n            <Activity className=\"h-12 w-12 opacity-30\" />\n            <div className=\"text-center\">\n              <p className=\"font-medium\">Sin operaciones completadas</p>\n              <p className=\"text-sm opacity-70\">El gr√°fico mostrar√° la curva de equity cuando el bot ejecute trades</p>\n            </div>\n          </div>\n        ) : (\n          <ResponsiveContainer width=\"100%\" height=\"100%\">\n            <AreaChart data={chartData}>\n              <defs>\n                <linearGradient id=\"equityGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                  <stop offset=\"5%\" stopColor=\"#00FF88\" stopOpacity={0.4} />\n                  <stop offset=\"50%\" stopColor=\"#00FF88\" stopOpacity={0.15} />\n                  <stop offset=\"95%\" stopColor=\"#00FF88\" stopOpacity={0} />\n                </linearGradient>\n              </defs>\n              <CartesianGrid \n                strokeDasharray=\"3 3\" \n                stroke=\"rgba(255,255,255,0.1)\" \n                vertical={false} \n              />\n              <XAxis \n                dataKey=\"time\" \n                stroke=\"#888888\" \n                fontSize={11} \n                tickLine={false} \n                axisLine={{ stroke: 'rgba(255,255,255,0.2)' }}\n                fontFamily=\"JetBrains Mono\"\n                tick={{ fill: '#aaaaaa' }}\n              />\n              <YAxis \n                stroke=\"#888888\" \n                fontSize={11} \n                tickLine={false} \n                axisLine={{ stroke: 'rgba(255,255,255,0.2)' }}\n                tickFormatter={(value) => `$${value.toFixed(0)}`}\n                fontFamily=\"JetBrains Mono\"\n                tick={{ fill: '#aaaaaa' }}\n                domain={['dataMin - 10', 'dataMax + 10']}\n              />\n              <Tooltip \n                contentStyle={{ \n                  backgroundColor: 'rgba(20, 20, 30, 0.95)', \n                  borderColor: '#00FF88',\n                  borderWidth: 1,\n                  borderRadius: '8px',\n                  fontFamily: 'JetBrains Mono',\n                  boxShadow: '0 4px 20px rgba(0, 255, 136, 0.2)'\n                }}\n                labelStyle={{ color: '#ffffff', fontWeight: 'bold' }}\n                itemStyle={{ color: '#00FF88' }}\n                formatter={(value: number) => [`$${value.toFixed(2)}`, 'Equity']}\n              />\n              <Area \n                type=\"monotone\" \n                dataKey=\"equity\" \n                stroke=\"#00FF88\" \n                strokeWidth={3}\n                fillOpacity={1} \n                fill=\"url(#equityGradient)\"\n                dot={false}\n                activeDot={{ r: 6, fill: '#00FF88', stroke: '#ffffff', strokeWidth: 2 }}\n              />\n            </AreaChart>\n          </ResponsiveContainer>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":7277,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n\" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n           // @replit: no hover, and add primary border\n           \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm border-destructive-border\",\n        outline:\n          // @replit Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color. Uses shadow-xs. no shadow on active\n          // No hover state\n          \" border [border-color:var(--button-outline)] shadow-xs active:shadow-none \",\n        secondary:\n          // @replit border, no hover, no shadow, secondary border.\n          \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // @replit no hover, transparent border\n        ghost: \"border border-transparent\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        // @replit changed sizes\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2356,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"import * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3007,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-primary/20\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":792,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":724,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"import * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload\n            .filter((item) => item.type !== \"none\")\n            .map((item, index) => {\n              const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n              const itemConfig = getPayloadConfigFromPayload(config, item, key)\n              const indicatorColor = color || item.payload.fill || item.color\n\n              return (\n                <div\n                  key={item.dataKey}\n                  className={cn(\n                    \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                    indicator === \"dot\" && \"items-center\"\n                  )}\n                >\n                  {formatter && item?.value !== undefined && item.name ? (\n                    formatter(item.value, item.name, item, index, item.payload)\n                  ) : (\n                    <>\n                      {itemConfig?.icon ? (\n                        <itemConfig.icon />\n                      ) : (\n                        !hideIndicator && (\n                          <div\n                            className={cn(\n                              \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                              {\n                                \"h-2.5 w-2.5\": indicator === \"dot\",\n                                \"w-1\": indicator === \"line\",\n                                \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                  indicator === \"dashed\",\n                                \"my-0.5\": nestLabel && indicator === \"dashed\",\n                              }\n                            )}\n                            style={\n                              {\n                                \"--color-bg\": indicatorColor,\n                                \"--color-border\": indicatorColor,\n                              } as React.CSSProperties\n                            }\n                          />\n                        )\n                      )}\n                      <div\n                        className={cn(\n                          \"flex flex-1 justify-between leading-none\",\n                          nestLabel ? \"items-end\" : \"items-center\"\n                        )}\n                      >\n                        <div className=\"grid gap-1.5\">\n                          {nestLabel ? tooltipLabel : null}\n                          <span className=\"text-muted-foreground\">\n                            {itemConfig?.label || item.name}\n                          </span>\n                        </div>\n                        {item.value && (\n                          <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                            {item.value.toLocaleString()}\n                          </span>\n                        )}\n                      </div>\n                    </>\n                  )}\n                </div>\n              )\n            })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload\n          .filter((item) => item.type !== \"none\")\n          .map((item) => {\n            const key = `${nameKey || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n            return (\n              <div\n                key={item.value}\n                className={cn(\n                  \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n                )}\n              >\n                {itemConfig?.icon && !hideIcon ? (\n                  <itemConfig.icon />\n                ) : (\n                  <div\n                    className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                    style={{\n                      backgroundColor: item.color,\n                    }}\n                  />\n                )}\n                {itemConfig?.label}\n              </div>\n            )\n          })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10763,"size_tokens":null},"client/src/components/ui/kbd.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Kbd({ className, ...props }: React.ComponentProps<\"kbd\">) {\n  return (\n    <kbd\n      data-slot=\"kbd\"\n      className={cn(\n        \"bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 select-none items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium\",\n        \"[&_svg:not([class*='size-'])]:size-3\",\n        \"[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction KbdGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <kbd\n      data-slot=\"kbd-group\"\n      className={cn(\"inline-flex items-center gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Kbd, KbdGroup }\n","path":null,"size_bytes":862,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Portal>\n    <TooltipPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </TooltipPrimitive.Portal>\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1267,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"import * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8608,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4419,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":649,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { EventsWebSocketProvider } from \"@/context/EventsWebSocketContext\";\nimport Dashboard from \"@/pages/Dashboard\";\nimport Settings from \"@/pages/Settings\";\nimport Terminal from \"@/pages/Terminal\";\nimport Strategies from \"@/pages/Strategies\";\nimport Wallet from \"@/pages/Wallet\";\nimport Integrations from \"@/pages/Integrations\";\nimport Guide from \"@/pages/Guide\";\nimport Monitor from \"@/pages/Monitor\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/settings\" component={Settings} />\n      <Route path=\"/terminal\" component={Terminal} />\n      <Route path=\"/strategies\" component={Strategies} />\n      <Route path=\"/wallet\" component={Wallet} />\n      <Route path=\"/integrations\" component={Integrations} />\n      <Route path=\"/guide\" component={Guide} />\n      <Route path=\"/monitor\" component={Monitor} />\n      \n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <EventsWebSocketProvider>\n          <Toaster />\n          <Router />\n        </EventsWebSocketProvider>\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":1535,"size_tokens":null},"client/src/components/ui/sonner.tsx":{"content":"\"use client\"\n\nimport { useTheme } from \"next-themes\"\nimport { Toaster as Sonner } from \"sonner\"\n\ntype ToasterProps = React.ComponentProps<typeof Sonner>\n\nconst Toaster = ({ ...props }: ToasterProps) => {\n  const { theme = \"system\" } = useTheme()\n\n  return (\n    <Sonner\n      theme={theme as ToasterProps[\"theme\"]}\n      className=\"toaster group\"\n      toastOptions={{\n        classNames: {\n          toast:\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\n          description: \"group-[.toast]:text-muted-foreground\",\n          actionButton:\n            \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\n          cancelButton:\n            \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\n        },\n      }}\n      {...props}\n    />\n  )\n}\n\nexport { Toaster }\n","path":null,"size_bytes":894,"size_tokens":null},"client/src/components/dashboard/AssetCard.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { cn } from \"@/lib/utils\";\nimport { ArrowUp, ArrowDown, Wallet } from \"lucide-react\";\n\ninterface AssetCardProps {\n  symbol: string;\n  name: string;\n  balance: string;\n  value: string;\n  change: number; // percentage\n}\n\nexport function AssetCard({ symbol, name, balance, value, change }: AssetCardProps) {\n  const isPositive = change >= 0;\n\n  return (\n    <Card className=\"glass-panel border-border/50 shadow-lg relative overflow-hidden group\">\n      <div className=\"absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity hidden sm:block\">\n        <Wallet className=\"h-16 md:h-24 w-16 md:w-24 -mr-6 md:-mr-8 -mt-6 md:-mt-8 rotate-12\" />\n      </div>\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-1 md:pb-2 px-3 md:px-6 pt-3 md:pt-6\">\n        <CardTitle className=\"text-xs md:text-sm font-medium font-mono text-muted-foreground truncate\">\n          <span className=\"hidden sm:inline\">{name}</span>\n          <span className=\"sm:hidden\">{symbol}</span>\n          <span className=\"text-primary/50 ml-1 md:ml-2 hidden sm:inline\">[{symbol}]</span>\n        </CardTitle>\n        {isPositive ? (\n          <ArrowUp className=\"h-3 w-3 md:h-4 md:w-4 text-green-500 shrink-0\" />\n        ) : (\n          <ArrowDown className=\"h-3 w-3 md:h-4 md:w-4 text-red-500 shrink-0\" />\n        )}\n      </CardHeader>\n      <CardContent className=\"px-3 md:px-6 pb-3 md:pb-6\">\n        <div className=\"text-lg md:text-2xl font-bold font-mono tracking-tighter truncate\">{value}</div>\n        <p className=\"text-[10px] md:text-xs text-muted-foreground mt-1 font-mono\">\n          <span className=\"hidden sm:inline\">{balance} {symbol}</span>\n          <span className={cn(\"sm:ml-2\", isPositive ? \"text-green-500\" : \"text-red-500\")}>\n            {isPositive ? \"+\" : \"\"}{change}%\n          </span>\n        </p>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":1969,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"server/services/kraken.ts":{"content":"import * as KrakenAPI from \"node-kraken-api\";\nimport { telegramService } from \"./telegram\";\nimport { storage } from \"../storage\";\n\nconst { Kraken } = KrakenAPI as any;\n\ninterface KrakenConfig {\n  apiKey: string;\n  apiSecret: string;\n}\n\nexport interface PairMetadata {\n  lotDecimals: number;\n  orderMin: number;\n  pairDecimals: number;\n  stepSize: number;\n}\n\nconst NONCE_ALERT_INTERVAL_MS = 30 * 60 * 1000;\nconst MAX_RETRIES = 3;\nconst RETRY_DELAYS = [500, 1000, 2000];\nconst METADATA_REFRESH_INTERVAL_MS = 6 * 60 * 60 * 1000; // 6 hours\n\nexport class KrakenService {\n  private client: any | null = null;\n  private publicClient: any;\n  private lastNonceAlertTime: number = 0;\n  private lastNonce: number = 0;\n  private pairMetadataCache: Map<string, PairMetadata> = new Map();\n  private metadataLastRefresh: number = 0;\n  private metadataRefreshTimer: NodeJS.Timeout | null = null;\n\n  constructor() {\n    this.publicClient = new Kraken();\n  }\n\n  async loadPairMetadata(pairs: string[]): Promise<void> {\n    try {\n      console.log(`[kraken] Loading pair metadata for: ${pairs.join(\", \")}`);\n      const response = await this.publicClient.assetPairs();\n      \n      for (const pair of pairs) {\n        const krakenPair = this.formatPair(pair);\n        const pairData = response[krakenPair];\n        \n        if (pairData) {\n          const lotDecimals = pairData.lot_decimals || 8;\n          const orderMin = parseFloat(pairData.ordermin) || 0.01;\n          const pairDecimals = pairData.pair_decimals || 5;\n          const stepSize = Math.pow(10, -lotDecimals);\n          \n          this.pairMetadataCache.set(pair, {\n            lotDecimals,\n            orderMin,\n            pairDecimals,\n            stepSize,\n          });\n          \n          console.log(`[kraken] ${pair}: lotDecimals=${lotDecimals}, orderMin=${orderMin}, stepSize=${stepSize}`);\n        } else {\n          console.warn(`[kraken] No metadata found for ${pair} (${krakenPair})`);\n        }\n      }\n      \n      this.metadataLastRefresh = Date.now();\n      console.log(`[kraken] Pair metadata loaded successfully for ${this.pairMetadataCache.size} pairs`);\n    } catch (error: any) {\n      console.error(`[kraken] Failed to load pair metadata: ${error.message}`);\n      if (this.pairMetadataCache.size === 0) {\n        console.error(`[kraken] CRITICAL: No pair metadata available - trades will be skipped`);\n      }\n    }\n  }\n\n  startMetadataRefresh(pairs: string[]): void {\n    if (this.metadataRefreshTimer) {\n      clearInterval(this.metadataRefreshTimer);\n    }\n    \n    this.metadataRefreshTimer = setInterval(async () => {\n      console.log(`[kraken] Refreshing pair metadata...`);\n      await this.loadPairMetadata(pairs);\n    }, METADATA_REFRESH_INTERVAL_MS);\n    \n    console.log(`[kraken] Metadata refresh scheduled every ${METADATA_REFRESH_INTERVAL_MS / 3600000}h`);\n  }\n\n  getPairMetadata(pair: string): PairMetadata | null {\n    return this.pairMetadataCache.get(pair) || null;\n  }\n\n  getStepSize(pair: string): number | null {\n    const metadata = this.pairMetadataCache.get(pair);\n    return metadata ? metadata.stepSize : null;\n  }\n\n  getOrderMin(pair: string): number | null {\n    const metadata = this.pairMetadataCache.get(pair);\n    return metadata ? metadata.orderMin : null;\n  }\n\n  hasMetadata(pair: string): boolean {\n    return this.pairMetadataCache.has(pair);\n  }\n\n  initialize(config: KrakenConfig) {\n    this.client = new Kraken({\n      key: config.apiKey,\n      secret: config.apiSecret,\n      gennonce: () => this.generateNonce(),\n    });\n  }\n\n  private generateNonce(): number {\n    let nonce = Date.now() * 1000 + Math.floor(Math.random() * 1000);\n    if (nonce <= this.lastNonce) {\n      nonce = this.lastNonce + 1;\n    }\n    this.lastNonce = nonce;\n    return nonce;\n  }\n\n  isInitialized(): boolean {\n    return this.client !== null;\n  }\n\n  private async executeWithNonceRetry<T>(\n    endpoint: string,\n    operation: () => Promise<T>\n  ): Promise<T> {\n    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {\n      try {\n        if (attempt > 1) {\n          await new Promise(resolve => setTimeout(resolve, RETRY_DELAYS[attempt - 2]));\n        }\n        return await operation();\n      } catch (error: any) {\n        const isNonceError = error.message?.includes(\"EAPI:Invalid nonce\") || \n                            error.message?.includes(\"Invalid nonce\");\n        \n        if (isNonceError) {\n          console.log(`[kraken] Nonce error on '${endpoint}', retrying (${attempt}/${MAX_RETRIES})...`);\n          \n          if (attempt === MAX_RETRIES) {\n            console.error(`[kraken] CRITICAL: Persistent nonce error on '${endpoint}' after ${attempt}/${MAX_RETRIES} attempts`);\n            await this.sendNonceAlert(endpoint);\n            throw new Error(`Persistent nonce error on '${endpoint}' - possible duplicate instance running`);\n          }\n          continue;\n        }\n        throw error;\n      }\n    }\n    throw new Error(`Failed after ${MAX_RETRIES} retries on '${endpoint}'`);\n  }\n\n  private async sendNonceAlert(endpoint: string): Promise<void> {\n    const now = Date.now();\n    \n    if (now - this.lastNonceAlertTime < NONCE_ALERT_INTERVAL_MS) {\n      console.log(`[kraken] Skipping Telegram nonce alert (rate limited, last sent ${Math.round((now - this.lastNonceAlertTime) / 1000)}s ago)`);\n      return;\n    }\n\n    try {\n      const config = await storage.getBotConfig();\n      if (config && config.nonceErrorAlertsEnabled === false) {\n        console.log(`[kraken] Nonce error alerts disabled in config, skipping Telegram notification`);\n        return;\n      }\n\n      await telegramService.sendAlert(\n        \"Error de Nonce con Kraken\",\n        `Error persistente de nonce en '${endpoint}' despu√©s de 3 intentos.\\n\\n` +\n        `‚ö†Ô∏è Verifica que no haya otra instancia del bot usando la misma API key de Kraken.\\n\\n` +\n        `_Este mensaje se enviar√° m√°ximo cada 30 minutos mientras persista el problema._`\n      );\n      this.lastNonceAlertTime = now;\n      console.log(`[kraken] Nonce alert sent to Telegram`);\n    } catch (alertError) {\n      console.error(`[kraken] Failed to send nonce alert to Telegram:`, alertError);\n    }\n  }\n\n  async getBalance() {\n    if (!this.client) throw new Error(\"Kraken client not initialized\");\n    return await this.executeWithNonceRetry(\"getBalance\", () => this.client.balance());\n  }\n\n  async getTicker(pair: string) {\n    const krakenPair = this.formatPair(pair);\n    const response = await this.publicClient.ticker({ pair: krakenPair });\n    return response;\n  }\n\n  async getAssetPairs() {\n    return await this.publicClient.assetPairs();\n  }\n\n  async placeOrder(params: {\n    pair: string;\n    type: \"buy\" | \"sell\";\n    ordertype: string;\n    price?: string;\n    volume: string;\n  }) {\n    if (!this.client) throw new Error(\"Kraken client not initialized\");\n    \n    const krakenPair = this.formatPair(params.pair);\n    const orderParams: any = {\n      pair: krakenPair,\n      type: params.type,\n      ordertype: params.ordertype,\n      volume: params.volume,\n    };\n\n    if (params.price) {\n      orderParams.price = params.price;\n    }\n\n    return await this.executeWithNonceRetry(\"addOrder\", () => this.client.addOrder(orderParams));\n  }\n\n  async cancelOrder(txid: string) {\n    if (!this.client) throw new Error(\"Kraken client not initialized\");\n    return await this.executeWithNonceRetry(\"cancelOrder\", () => this.client.cancelOrder({ txid }));\n  }\n\n  async getOpenOrders() {\n    if (!this.client) throw new Error(\"Kraken client not initialized\");\n    return await this.executeWithNonceRetry(\"openOrders\", () => this.client.openOrders());\n  }\n\n  async getClosedOrders(limit: number = 50) {\n    if (!this.client) throw new Error(\"Kraken client not initialized\");\n    return await this.executeWithNonceRetry(\"closedOrders\", () => this.client.closedOrders({ ofs: 0 }));\n  }\n\n  async getTradesHistory(options?: { start?: number; end?: number; fetchAll?: boolean }): Promise<any> {\n    if (!this.client) throw new Error(\"Kraken client not initialized\");\n    \n    const params: any = { type: \"all\" };\n    if (options?.start) params.start = options.start;\n    if (options?.end) params.end = options.end;\n    \n    // Si no se pide todo el historial, devolver solo la primera p√°gina\n    if (!options?.fetchAll) {\n      return await this.executeWithNonceRetry(\"tradesHistory\", () => this.client.tradesHistory(params));\n    }\n    \n    // Fetch all trades with pagination\n    const allTrades: Record<string, any> = {};\n    let offset = 0;\n    let totalCount = 0;\n    const RATE_LIMIT_DELAY = 2000; // 2 segundos entre llamadas\n    \n    console.log(\"[kraken] Fetching all trades history with pagination...\");\n    \n    while (true) {\n      const paginatedParams = { ...params, ofs: offset };\n      \n      const response: any = await this.executeWithNonceRetry(\"tradesHistory\", () => \n        this.client.tradesHistory(paginatedParams)\n      );\n      \n      const trades = response.trades || {};\n      const count = response.count || 0;\n      \n      if (offset === 0) {\n        totalCount = count;\n        console.log(`[kraken] Total trades in Kraken: ${totalCount}`);\n      }\n      \n      const tradeIds = Object.keys(trades);\n      if (tradeIds.length === 0) {\n        console.log(`[kraken] No more trades at offset ${offset}`);\n        break;\n      }\n      \n      // Merge trades\n      for (const [id, trade] of Object.entries(trades)) {\n        allTrades[id] = trade;\n      }\n      \n      console.log(`[kraken] Fetched ${tradeIds.length} trades at offset ${offset}, total collected: ${Object.keys(allTrades).length}`);\n      \n      offset += 50;\n      \n      if (offset >= totalCount) {\n        console.log(`[kraken] Reached end of trades history`);\n        break;\n      }\n      \n      // Rate limiting - esperar entre llamadas\n      await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY));\n    }\n    \n    console.log(`[kraken] Finished fetching ${Object.keys(allTrades).length} total trades`);\n    \n    return { trades: allTrades, count: Object.keys(allTrades).length };\n  }\n\n  async getOHLC(pair: string, interval: number = 5): Promise<{\n    time: number;\n    open: number;\n    high: number;\n    low: number;\n    close: number;\n    volume: number;\n  }[]> {\n    const krakenPair = this.formatPair(pair);\n    const response = await this.publicClient.ohlc({ pair: krakenPair, interval });\n    \n    const pairData = Object.values(response).find(Array.isArray) as any[];\n    if (!pairData) return [];\n    \n    return pairData.map((candle: any[]) => ({\n      time: candle[0],\n      open: parseFloat(candle[1]),\n      high: parseFloat(candle[2]),\n      low: parseFloat(candle[3]),\n      close: parseFloat(candle[4]),\n      volume: parseFloat(candle[6]),\n    }));\n  }\n\n  formatPairReverse(krakenPair: string): string {\n    const pairMap: Record<string, string> = {\n      \"XXBTZUSD\": \"BTC/USD\",\n      \"XETHZUSD\": \"ETH/USD\",\n      \"SOLUSD\": \"SOL/USD\",\n      \"XXRPZUSD\": \"XRP/USD\",\n      \"XRPUSD\": \"XRP/USD\",\n      \"TONUSD\": \"TON/USD\",\n      \"XXBTZXETH\": \"BTC/ETH\",\n      \"XETHXXBT\": \"ETH/BTC\",\n      \"ETHXBT\": \"ETH/BTC\",\n      \"SOLETH\": \"SOL/ETH\",\n    };\n    return pairMap[krakenPair] || krakenPair;\n  }\n\n  formatPair(pair: string): string {\n    const pairMap: Record<string, string> = {\n      \"BTC/USD\": \"XXBTZUSD\",\n      \"ETH/USD\": \"XETHZUSD\",\n      \"SOL/USD\": \"SOLUSD\",\n      \"XRP/USD\": \"XXRPZUSD\",\n      \"TON/USD\": \"TONUSD\",\n      \"ETH/BTC\": \"XETHXXBT\",\n      \"BTC/ETH\": \"XXBTZXETH\",\n      \"SOL/ETH\": \"SOLETH\",\n    };\n    return pairMap[pair] || pair;\n  }\n}\n\nexport const krakenService = new KrakenService();\n","path":null,"size_bytes":11600,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5124,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1148,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue | null>(null)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  if (!itemContext) {\n    throw new Error(\"useFormField should be used within <FormItem>\")\n  }\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue | null>(null)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-[0.8rem] text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-[0.8rem] font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4175,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"node-kraken-api\",\n  \"node-telegram-bot-api\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1465,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n      {children}\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4280,"size_tokens":null},"client/src/pages/Settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Nav } from \"@/components/dashboard/Nav\";\nimport { EnvironmentBadge } from \"@/components/dashboard/EnvironmentBadge\";\nimport generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { HardDrive, Bot, Server, Cog, AlertTriangle, Clock, Brain, Loader2, Layers, Eye, EyeOff, Check, Monitor, Shield, ChevronRight, Trash2, Plus, X } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport { Link } from \"wouter\";\nimport { toast } from \"sonner\";\n\ninterface AiStatus {\n  phase: \"red\" | \"yellow\" | \"green\";\n  phaseLabel: string;\n  completeSamples: number;\n  minSamplesForTrain: number;\n  minSamplesForActivate: number;\n  canTrain: boolean;\n  canActivate: boolean;\n  filterEnabled: boolean;\n  shadowEnabled: boolean;\n  modelLoaded: boolean;\n  lastTrainTs: string | null;\n  threshold: number;\n  metrics: {\n    accuracy?: number;\n    precision?: number;\n    recall?: number;\n    f1?: number;\n  } | null;\n}\n\ninterface AiDiagnostic {\n  operationsCount: number;\n  trainingTradesTotal: number;\n  closedTradesCount: number;\n  labeledTradesCount: number;\n  openTradesCount: number;\n  openLotsCount: number;\n  openTradesDescription: string;\n  openLotsDescription: string;\n  lastBackfillRun: string | null;\n  lastBackfillError: string | null;\n  lastTrainRun: string | null;\n  lastTrainError: string | null;\n  modelVersion: string | null;\n  discardReasonsDataset: Record<string, number>;\n  lastBackfillDiscardReasons: Record<string, number>;\n  winRate: number | null;\n  avgPnlNet: number | null;\n  avgHoldTimeMinutes: number | null;\n}\n\ninterface BotConfig {\n  id: number;\n  isActive: boolean;\n  strategy: string;\n  riskLevel: string;\n  activePairs: string[];\n  stopLossPercent: string;\n  takeProfitPercent: string;\n  trailingStopEnabled: boolean;\n  trailingStopPercent: string;\n  nonceErrorAlertsEnabled: boolean;\n  tradingHoursEnabled: boolean;\n  tradingHoursStart: string;\n  tradingHoursEnd: string;\n  positionMode: string;\n  // SMART_GUARD fields\n  sgMinEntryUsd: string;\n  sgAllowUnderMin: boolean;\n  sgBeAtPct: string;\n  sgFeeCushionPct: string;\n  sgFeeCushionAuto: boolean;\n  sgTrailStartPct: string;\n  sgTrailDistancePct: string;\n  sgTrailStepPct: string;\n  sgTpFixedEnabled: boolean;\n  sgTpFixedPct: string;\n  sgScaleOutEnabled: boolean;\n  sgScaleOutPct: string;\n  sgMinPartUsd: string;\n  sgScaleOutThreshold: string;\n  sgMaxOpenLotsPerPair: number;\n  sgPairOverrides: Record<string, unknown> | null;\n}\n\nexport default function Settings() {\n  const queryClient = useQueryClient();\n  \n  const [wsAdminToken, setWsAdminToken] = useState(\"\");\n  const [terminalToken, setTerminalToken] = useState(\"\");\n  const [showWsToken, setShowWsToken] = useState(false);\n  const [showTerminalToken, setShowTerminalToken] = useState(false);\n  const [wsTokenSaved, setWsTokenSaved] = useState(false);\n  const [terminalTokenSaved, setTerminalTokenSaved] = useState(false);\n\n  useEffect(() => {\n    const savedWsToken = localStorage.getItem(\"WS_ADMIN_TOKEN\") || \"\";\n    const savedTerminalToken = localStorage.getItem(\"TERMINAL_TOKEN\") || \"\";\n    setWsAdminToken(savedWsToken);\n    setTerminalToken(savedTerminalToken);\n    setWsTokenSaved(!!savedWsToken);\n    setTerminalTokenSaved(!!savedTerminalToken);\n  }, []);\n\n  const handleSaveTokens = () => {\n    if (wsAdminToken) {\n      localStorage.setItem(\"WS_ADMIN_TOKEN\", wsAdminToken);\n      setWsTokenSaved(true);\n    } else {\n      localStorage.removeItem(\"WS_ADMIN_TOKEN\");\n      setWsTokenSaved(false);\n    }\n    if (terminalToken) {\n      localStorage.setItem(\"TERMINAL_TOKEN\", terminalToken);\n      setTerminalTokenSaved(true);\n    } else {\n      localStorage.removeItem(\"TERMINAL_TOKEN\");\n      setTerminalTokenSaved(false);\n    }\n    toast.success(\"Tokens guardados. Recarga la p√°gina para aplicar cambios.\");\n  };\n\n  const { data: config } = useQuery<BotConfig>({\n    queryKey: [\"botConfig\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/config\");\n      if (!res.ok) throw new Error(\"Failed to fetch config\");\n      return res.json();\n    },\n  });\n\n  const { data: aiStatus, isLoading: aiLoading } = useQuery<AiStatus>({\n    queryKey: [\"aiStatus\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/ai/status\");\n      if (!res.ok) throw new Error(\"Failed to fetch AI status\");\n      return res.json();\n    },\n    refetchInterval: 30000,\n  });\n\n  const { data: aiDiagnostic } = useQuery<AiDiagnostic>({\n    queryKey: [\"aiDiagnostic\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/ai/diagnostic\");\n      if (!res.ok) throw new Error(\"Failed to fetch AI diagnostic\");\n      return res.json();\n    },\n    refetchInterval: 60000,\n  });\n\n  const backfillMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/ai/backfill\", { method: \"POST\" });\n      if (!res.ok) throw new Error(\"Failed to backfill\");\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"aiStatus\"] });\n      queryClient.invalidateQueries({ queryKey: [\"aiDiagnostic\"] });\n      if (data.success) {\n        toast.success(data.message || \"Backfill completado\");\n      } else {\n        toast.error(data.message || \"Error en backfill\");\n      }\n    },\n    onError: () => {\n      toast.error(\"Error al ejecutar backfill\");\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (updates: Partial<BotConfig>) => {\n      const res = await fetch(\"/api/config\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update config\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"botConfig\"] });\n      toast.success(\"Configuraci√≥n actualizada\");\n    },\n    onError: () => {\n      toast.error(\"Error al actualizar configuraci√≥n\");\n    },\n  });\n\n  const trainMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/ai/retrain\", { method: \"POST\" });\n      if (!res.ok) throw new Error(\"Failed to train\");\n      return res.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"aiStatus\"] });\n      if (data.success) {\n        toast.success(data.message || \"Entrenamiento completado\");\n      } else {\n        toast.error(data.message || \"Error en entrenamiento\");\n      }\n    },\n    onError: () => {\n      toast.error(\"Error al entrenar modelo\");\n    },\n  });\n\n  const toggleAiMutation = useMutation({\n    mutationFn: async (payload: { filterEnabled?: boolean; shadowEnabled?: boolean }) => {\n      const res = await fetch(\"/api/ai/toggle\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      if (!res.ok) throw new Error(\"Failed to toggle\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"aiStatus\"] });\n      toast.success(\"Configuraci√≥n IA actualizada\");\n    },\n    onError: () => {\n      toast.error(\"Error al actualizar configuraci√≥n IA\");\n    },\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col relative overflow-hidden\">\n      <div \n        className=\"fixed inset-0 z-0 opacity-20 pointer-events-none\" \n        style={{ \n          backgroundImage: `url(${generatedImage})`, \n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          mixBlendMode: 'overlay'\n        }} \n      />\n      \n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        <Nav />\n        \n        <main className=\"flex-1 p-4 md:p-6 max-w-4xl mx-auto w-full space-y-6 md:space-y-8\">\n          <EnvironmentBadge />\n          \n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-xl md:text-3xl font-bold font-sans tracking-tight flex items-center gap-2 md:gap-3\">\n                <Cog className=\"h-6 w-6 md:h-8 md:w-8 text-primary\" />\n                Ajustes del Sistema\n              </h1>\n              <p className=\"text-sm md:text-base text-muted-foreground mt-1\">Configuraci√≥n del bot, IA y despliegue.</p>\n            </div>\n          </div>\n\n          <div className=\"grid gap-6\">\n            {/* Quick Link to Integrations */}\n            <Card className=\"glass-panel border-primary/30 bg-primary/5\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-3\">\n                    <Server className=\"h-5 w-5 text-primary\" />\n                    <div>\n                      <p className=\"font-medium\">APIs y Credenciales</p>\n                      <p className=\"text-sm text-muted-foreground\">Configura Kraken, Telegram y otras integraciones</p>\n                    </div>\n                  </div>\n                  <Link href=\"/integrations\">\n                    <Button variant=\"outline\" data-testid=\"link-integrations\">\n                      Ir a Integraciones\n                    </Button>\n                  </Link>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Monitor Tokens */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-cyan-500/20 rounded-lg\">\n                    <Monitor className=\"h-6 w-6 text-cyan-400\" />\n                  </div>\n                  <div>\n                    <CardTitle>Tokens de Monitor</CardTitle>\n                    <CardDescription>Tokens de autenticaci√≥n para WebSocket (deben coincidir con los del servidor).</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid gap-3\">\n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"ws-admin-token\">WS_ADMIN_TOKEN (Eventos)</Label>\n                    <div className=\"flex gap-2\">\n                      <div className=\"relative flex-1\">\n                        <Input\n                          id=\"ws-admin-token\"\n                          type={showWsToken ? \"text\" : \"password\"}\n                          value={wsAdminToken}\n                          onChange={(e) => setWsAdminToken(e.target.value)}\n                          placeholder=\"Token para /ws/events\"\n                          className=\"font-mono pr-10\"\n                          data-testid=\"input-ws-admin-token\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowWsToken(!showWsToken)}\n                          className=\"absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                        >\n                          {showWsToken ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                        </button>\n                      </div>\n                      {wsTokenSaved && (\n                        <Check className=\"h-5 w-5 text-green-500 self-center\" data-testid=\"check-ws-token\" />\n                      )}\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">Opcional en desarrollo, requerido en producci√≥n.</p>\n                  </div>\n                  \n                  <div className=\"grid gap-2\">\n                    <Label htmlFor=\"terminal-token\">TERMINAL_TOKEN (Terminal)</Label>\n                    <div className=\"flex gap-2\">\n                      <div className=\"relative flex-1\">\n                        <Input\n                          id=\"terminal-token\"\n                          type={showTerminalToken ? \"text\" : \"password\"}\n                          value={terminalToken}\n                          onChange={(e) => setTerminalToken(e.target.value)}\n                          placeholder=\"Token para /ws/logs\"\n                          className=\"font-mono pr-10\"\n                          data-testid=\"input-terminal-token\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowTerminalToken(!showTerminalToken)}\n                          className=\"absolute right-2 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                        >\n                          {showTerminalToken ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                        </button>\n                      </div>\n                      {terminalTokenSaved && (\n                        <Check className=\"h-5 w-5 text-green-500 self-center\" data-testid=\"check-terminal-token\" />\n                      )}\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">Obligatorio para ver logs del servidor.</p>\n                  </div>\n                </div>\n                \n                <Button onClick={handleSaveTokens} className=\"w-full\" data-testid=\"button-save-tokens\">\n                  Guardar Tokens\n                </Button>\n                \n                <p className=\"text-xs text-muted-foreground text-center\">\n                  Los tokens se guardan en tu navegador. Recarga la p√°gina despu√©s de guardar para aplicar cambios.\n                </p>\n              </CardContent>\n            </Card>\n\n            {/* Notifications Settings */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-yellow-500/20 rounded-lg\">\n                    <AlertTriangle className=\"h-6 w-6 text-yellow-400\" />\n                  </div>\n                  <div>\n                    <CardTitle>Alertas y Notificaciones</CardTitle>\n                    <CardDescription>Configura las alertas de Telegram del bot.</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex items-center justify-between p-4 border border-border rounded-lg bg-card/30\">\n                  <div className=\"space-y-0.5\">\n                    <Label>Alertas de Error de Nonce</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Env√≠a alerta por Telegram si hay errores persistentes de nonce con Kraken (m√°x. 1 cada 30 min)\n                    </p>\n                  </div>\n                  <Switch \n                    checked={config?.nonceErrorAlertsEnabled ?? true}\n                    onCheckedChange={(checked) => updateMutation.mutate({ nonceErrorAlertsEnabled: checked })}\n                    data-testid=\"switch-nonce-alerts\"\n                  />\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Trading Hours Settings */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-blue-500/20 rounded-lg\">\n                    <Clock className=\"h-6 w-6 text-blue-400\" />\n                  </div>\n                  <div>\n                    <CardTitle>Horario de Trading</CardTitle>\n                    <CardDescription>Limita las operaciones a horas de mayor liquidez (UTC).</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex items-center justify-between p-4 border border-border rounded-lg bg-card/30\">\n                  <div className=\"space-y-0.5\">\n                    <Label>Activar Filtro de Horario</Label>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Solo opera dentro del horario configurado (evita baja liquidez nocturna)\n                    </p>\n                  </div>\n                  <Switch \n                    checked={config?.tradingHoursEnabled ?? true}\n                    onCheckedChange={(checked) => updateMutation.mutate({ tradingHoursEnabled: checked })}\n                    data-testid=\"switch-trading-hours\"\n                  />\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"grid gap-2\">\n                    <Label className=\"text-sm\">Hora de Inicio (UTC)</Label>\n                    <Input \n                      type=\"number\"\n                      min=\"0\"\n                      max=\"23\"\n                      defaultValue={config?.tradingHoursStart ?? \"8\"}\n                      key={`start-${config?.tradingHoursStart}`}\n                      onBlur={(e) => {\n                        const val = parseInt(e.target.value);\n                        if (!isNaN(val) && val >= 0 && val <= 23) {\n                          updateMutation.mutate({ tradingHoursStart: val.toString() });\n                        }\n                      }}\n                      className=\"font-mono bg-background/50\"\n                      data-testid=\"input-trading-hours-start\"\n                    />\n                  </div>\n                  <div className=\"grid gap-2\">\n                    <Label className=\"text-sm\">Hora de Fin (UTC)</Label>\n                    <Input \n                      type=\"number\"\n                      min=\"0\"\n                      max=\"23\"\n                      defaultValue={config?.tradingHoursEnd ?? \"22\"}\n                      key={`end-${config?.tradingHoursEnd}`}\n                      onBlur={(e) => {\n                        const val = parseInt(e.target.value);\n                        if (!isNaN(val) && val >= 0 && val <= 23) {\n                          updateMutation.mutate({ tradingHoursEnd: val.toString() });\n                        }\n                      }}\n                      className=\"font-mono bg-background/50\"\n                      data-testid=\"input-trading-hours-end\"\n                    />\n                  </div>\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  Horario actual: {config?.tradingHoursStart ?? \"8\"}:00 - {config?.tradingHoursEnd ?? \"22\"}:00 UTC\n                </p>\n              </CardContent>\n            </Card>\n\n            {/* Position Mode Settings */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-purple-500/20 rounded-lg\">\n                    <Layers className=\"h-6 w-6 text-purple-400\" />\n                  </div>\n                  <div>\n                    <CardTitle>Modo de Posici√≥n</CardTitle>\n                    <CardDescription>Controla c√≥mo se acumulan posiciones por cada par.</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"p-4 border border-border rounded-lg bg-card/30\">\n                  <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n                    <div className=\"space-y-1\">\n                      <Label>Modo de Acumulaci√≥n</Label>\n                      <p className=\"text-sm text-muted-foreground\">\n                        SINGLE: Una sola posici√≥n por par (bloquea nuevas compras si ya hay posici√≥n abierta).\n                        <br />\n                        DCA: Permite m√∫ltiples compras del mismo par (Dollar Cost Averaging).\n                      </p>\n                    </div>\n                    <Select \n                      value={config?.positionMode ?? \"SINGLE\"}\n                      onValueChange={(value) => updateMutation.mutate({ positionMode: value })}\n                    >\n                      <SelectTrigger className=\"w-[160px] font-mono bg-background/50\" data-testid=\"select-position-mode\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"SINGLE\">SINGLE</SelectItem>\n                        <SelectItem value=\"DCA\">DCA</SelectItem>\n                        <SelectItem value=\"SMART_GUARD\">SMART_GUARD</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n                <div className={`p-3 rounded-lg text-sm ${\n                  config?.positionMode === \"DCA\" \n                    ? \"bg-yellow-500/10 border border-yellow-500/30 text-yellow-400\" \n                    : config?.positionMode === \"SMART_GUARD\"\n                    ? \"bg-blue-500/10 border border-blue-500/30 text-blue-400\"\n                    : \"bg-green-500/10 border border-green-500/30 text-green-400\"\n                }`}>\n                  {config?.positionMode === \"DCA\" ? (\n                    <>\n                      <strong>Modo DCA activo:</strong> El bot puede realizar m√∫ltiples compras del mismo par para promediar el precio de entrada.\n                    </>\n                  ) : config?.positionMode === \"SMART_GUARD\" ? (\n                    <>\n                      <strong>Modo SMART_GUARD activo:</strong> Una posici√≥n por par con protecci√≥n inteligente: break-even autom√°tico, stop din√°mico (trailing) y salida escalonada opcional.\n                    </>\n                  ) : (\n                    <>\n                      <strong>Modo SINGLE activo:</strong> El bot bloquear√° nuevas compras de un par si ya existe una posici√≥n abierta.\n                    </>\n                  )}\n                </div>\n                \n                {config?.positionMode === \"SMART_GUARD\" && (\n                  <div className=\"space-y-4 p-4 border border-blue-500/30 rounded-lg bg-blue-500/5\" data-testid=\"panel-smart-guard-config\">\n                    <h4 className=\"font-medium text-blue-400 flex items-center gap-2\" data-testid=\"text-smart-guard-title\">\n                      <Shield className=\"h-4 w-4\" />\n                      Configuraci√≥n SMART_GUARD\n                    </h4>\n                    \n                    <p className=\"text-xs text-muted-foreground bg-muted/30 p-2 rounded border border-border/50\" data-testid=\"text-sg-global-limits-note\">\n                      Los l√≠mites globales de Riesgo por Trade y Exposici√≥n est√°n en \"Tama√±o de Trade\" y \"Control de Exposici√≥n\" (p√°gina Estrategias).\n                    </p>\n                    \n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <div className=\"space-y-2\">\n                        <Label className=\"text-sm\">M√≠nimo por operaci√≥n (USD)</Label>\n                        <Input\n                          type=\"number\"\n                          value={config.sgMinEntryUsd}\n                          onChange={(e) => updateMutation.mutate({ sgMinEntryUsd: e.target.value })}\n                          className=\"font-mono bg-background/50\"\n                          data-testid=\"input-sg-min-entry\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-min-entry-desc\">No entrar si el monto disponible es menor a este valor.</p>\n                        <div className=\"flex items-center justify-between mt-2\">\n                          <Label className=\"text-xs text-muted-foreground\">Permitir entradas menores</Label>\n                          <Switch\n                            checked={config.sgAllowUnderMin}\n                            onCheckedChange={(checked) => updateMutation.mutate({ sgAllowUnderMin: checked })}\n                            data-testid=\"switch-sg-allow-under-min\"\n                          />\n                        </div>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label className=\"text-sm\">M√°ximo lotes por par</Label>\n                        <Input\n                          type=\"number\"\n                          min={1}\n                          max={10}\n                          value={config.sgMaxOpenLotsPerPair || 1}\n                          onChange={(e) => updateMutation.mutate({ sgMaxOpenLotsPerPair: parseInt(e.target.value) || 1 })}\n                          className=\"font-mono bg-background/50\"\n                          data-testid=\"input-sg-max-lots\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-max-lots-desc\">N√∫mero m√°ximo de posiciones abiertas por par (1 = una entrada, 2+ = permitir DCA en SMART_GUARD).</p>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label className=\"text-sm\">Proteger ganancias a partir de (%)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"0.1\"\n                          value={config.sgBeAtPct}\n                          onChange={(e) => updateMutation.mutate({ sgBeAtPct: e.target.value })}\n                          className=\"font-mono bg-background/50\"\n                          data-testid=\"input-sg-be-at\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-be-at-desc\">Mover stop a break-even cuando la ganancia alcance este %.</p>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label className=\"text-sm\">Colch√≥n de comisiones (%)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"0.05\"\n                          value={config.sgFeeCushionPct}\n                          onChange={(e) => updateMutation.mutate({ sgFeeCushionPct: e.target.value })}\n                          className=\"font-mono bg-background/50\"\n                          disabled={config.sgFeeCushionAuto}\n                          data-testid=\"input-sg-fee-cushion\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-fee-cushion-desc\">Margen sobre precio de entrada para cubrir fees (~0.45%).</p>\n                        <div className=\"flex items-center justify-between mt-2\">\n                          <Label className=\"text-xs text-muted-foreground\">Calcular autom√°ticamente</Label>\n                          <Switch\n                            checked={config.sgFeeCushionAuto}\n                            onCheckedChange={(checked) => updateMutation.mutate({ sgFeeCushionAuto: checked })}\n                            data-testid=\"switch-sg-fee-cushion-auto\"\n                          />\n                        </div>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label className=\"text-sm\">Stop din√°mico: empieza a partir de (%)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"0.1\"\n                          value={config.sgTrailStartPct}\n                          onChange={(e) => updateMutation.mutate({ sgTrailStartPct: e.target.value })}\n                          className=\"font-mono bg-background/50\"\n                          data-testid=\"input-sg-trail-start\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-trail-start-desc\">El trailing stop se activa cuando la ganancia alcanza este %.</p>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label className=\"text-sm\">Stop din√°mico: distancia (%)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"0.1\"\n                          value={config.sgTrailDistancePct}\n                          onChange={(e) => updateMutation.mutate({ sgTrailDistancePct: e.target.value })}\n                          className=\"font-mono bg-background/50\"\n                          data-testid=\"input-sg-trail-distance\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-trail-distance-desc\">Distancia del stop respecto al precio m√°ximo alcanzado.</p>\n                      </div>\n                      \n                      <div className=\"space-y-2\">\n                        <Label className=\"text-sm\">Stop din√°mico: paso m√≠nimo (%)</Label>\n                        <Input\n                          type=\"number\"\n                          step=\"0.05\"\n                          value={config.sgTrailStepPct}\n                          onChange={(e) => updateMutation.mutate({ sgTrailStepPct: e.target.value })}\n                          className=\"font-mono bg-background/50\"\n                          data-testid=\"input-sg-trail-step\"\n                        />\n                        <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-trail-step-desc\">El stop sube en escalones de al menos este % para evitar spam.</p>\n                      </div>\n                    </div>\n                    \n                    <div className=\"border-t border-border/50 pt-4 space-y-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"space-y-1\">\n                          <Label>Salida por objetivo fijo (opcional)</Label>\n                          <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-tp-fixed-desc\">Cerrar toda la posici√≥n al alcanzar un % de ganancia fijo.</p>\n                        </div>\n                        <Switch\n                          checked={config.sgTpFixedEnabled}\n                          onCheckedChange={(checked) => updateMutation.mutate({ sgTpFixedEnabled: checked })}\n                          data-testid=\"switch-sg-tp-fixed\"\n                        />\n                      </div>\n                      \n                      {config.sgTpFixedEnabled && (\n                        <div className=\"space-y-2\">\n                          <Label className=\"text-sm\">Take-Profit fijo (%)</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.5\"\n                            value={config.sgTpFixedPct}\n                            onChange={(e) => updateMutation.mutate({ sgTpFixedPct: e.target.value })}\n                            className=\"font-mono bg-background/50\"\n                            data-testid=\"input-sg-tp-fixed\"\n                          />\n                        </div>\n                      )}\n                    </div>\n                    \n                    <div className=\"border-t border-border/50 pt-4 space-y-4\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"space-y-1\">\n                          <Label>Salida en 2 pasos (solo si es excepcional)</Label>\n                          <p className=\"text-xs text-muted-foreground\" data-testid=\"text-sg-scale-out-desc\">Vender una parte cuando la se√±al es muy fuerte, el resto con trailing.</p>\n                        </div>\n                        <Switch\n                          checked={config.sgScaleOutEnabled}\n                          onCheckedChange={(checked) => updateMutation.mutate({ sgScaleOutEnabled: checked })}\n                          data-testid=\"switch-sg-scale-out\"\n                        />\n                      </div>\n                      \n                      {config.sgScaleOutEnabled && (\n                        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                          <div className=\"space-y-2\">\n                            <Label className=\"text-sm\">Porcentaje a vender (%)</Label>\n                            <Input\n                              type=\"number\"\n                              step=\"5\"\n                              value={config.sgScaleOutPct}\n                              onChange={(e) => updateMutation.mutate({ sgScaleOutPct: e.target.value })}\n                              className=\"font-mono bg-background/50\"\n                              data-testid=\"input-sg-scale-out-pct\"\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label className=\"text-sm\">M√≠nimo parte (USD)</Label>\n                            <Input\n                              type=\"number\"\n                              value={config.sgMinPartUsd}\n                              onChange={(e) => updateMutation.mutate({ sgMinPartUsd: e.target.value })}\n                              className=\"font-mono bg-background/50\"\n                              data-testid=\"input-sg-min-part\"\n                            />\n                          </div>\n                          <div className=\"space-y-2\">\n                            <Label className=\"text-sm\">Confianza m√≠nima (%)</Label>\n                            <Input\n                              type=\"number\"\n                              value={config.sgScaleOutThreshold}\n                              onChange={(e) => updateMutation.mutate({ sgScaleOutThreshold: e.target.value })}\n                              className=\"font-mono bg-background/50\"\n                              data-testid=\"input-sg-scale-threshold\"\n                            />\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                    \n                    <PairOverridesSection \n                      overrides={config.sgPairOverrides as Record<string, Record<string, unknown>> | null}\n                      onUpdate={(newOverrides) => updateMutation.mutate({ sgPairOverrides: newOverrides })}\n                      activePairs={config.activePairs}\n                    />\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* AI Integration */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-primary/20 rounded-lg\">\n                    <Brain className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <div>\n                    <CardTitle>Motor de Inteligencia Artificial</CardTitle>\n                    <CardDescription>Filtro predictivo basado en Machine Learning.</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {aiLoading ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : aiStatus ? (\n                  <>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <Label className=\"text-sm\">Trades Cerrados Etiquetados</Label>\n                        <span className=\"text-sm font-mono\">\n                          {aiStatus.completeSamples} / {aiStatus.minSamplesForActivate} trades\n                        </span>\n                      </div>\n                      <Progress \n                        value={(aiStatus.completeSamples / aiStatus.minSamplesForActivate) * 100} \n                        className=\"h-2\"\n                      />\n                      <p className=\"text-xs text-muted-foreground\">\n                        {aiStatus.completeSamples < 300 \n                          ? `Necesitas ${300 - aiStatus.completeSamples} trades cerrados m√°s para entrenar`\n                          : \"Listo para entrenar y activar el filtro AI\"}\n                      </p>\n                    </div>\n                    \n                    {aiDiagnostic && (\n                      <div className=\"p-3 border border-border rounded-lg bg-card/30 space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <Label className=\"text-xs text-muted-foreground\">Diagn√≥stico de Dataset</Label>\n                          {aiDiagnostic.modelVersion && (\n                            <span className=\"text-xs font-mono text-primary\">{aiDiagnostic.modelVersion}</span>\n                          )}\n                        </div>\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs\">\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">Operaciones:</span>\n                            <span className=\"ml-1 font-mono\">{aiDiagnostic.operationsCount}</span>\n                          </div>\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">Cerrados:</span>\n                            <span className=\"ml-1 font-mono\">{aiDiagnostic.closedTradesCount}</span>\n                          </div>\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">Etiquetados:</span>\n                            <span className=\"ml-1 font-mono\">{aiDiagnostic.labeledTradesCount}</span>\n                          </div>\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">Win Rate:</span>\n                            <span className=\"ml-1 font-mono\">{aiDiagnostic.winRate ? `${aiDiagnostic.winRate.toFixed(1)}%` : '-'}</span>\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">√öltimo Backfill:</span>\n                            <span className=\"ml-1 font-mono\">\n                              {aiDiagnostic.lastBackfillRun \n                                ? new Date(aiDiagnostic.lastBackfillRun).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' })\n                                : 'Nunca'}\n                            </span>\n                          </div>\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">√öltimo Entrenamiento:</span>\n                            <span className=\"ml-1 font-mono\">\n                              {aiDiagnostic.lastTrainRun \n                                ? new Date(aiDiagnostic.lastTrainRun).toLocaleString('es-ES', { dateStyle: 'short', timeStyle: 'short' })\n                                : 'Nunca'}\n                            </span>\n                          </div>\n                        </div>\n                        {aiDiagnostic.lastBackfillError && (\n                          <div className=\"text-xs text-red-500 p-2 bg-red-500/10 rounded\">\n                            Error Backfill: {aiDiagnostic.lastBackfillError}\n                          </div>\n                        )}\n                        {aiDiagnostic.lastTrainError && (\n                          <div className=\"text-xs text-red-500 p-2 bg-red-500/10 rounded\">\n                            Error Entrenamiento: {aiDiagnostic.lastTrainError}\n                          </div>\n                        )}\n                        {Object.keys(aiDiagnostic.discardReasonsDataset || {}).length > 0 && (\n                          <div className=\"space-y-2 p-3 bg-yellow-500/10 rounded-lg border border-yellow-500/20\">\n                            <div className=\"flex items-center gap-2 text-yellow-500 text-xs font-medium\">\n                              <span>‚ö†Ô∏è Trades Excluidos del Entrenamiento</span>\n                            </div>\n                            <div className=\"grid grid-cols-1 gap-1.5 text-xs\">\n                              {Object.entries(aiDiagnostic.discardReasonsDataset || {}).map(([k, v]) => {\n                                const discardInfo: Record<string, { label: string; desc: string }> = {\n                                  'sin_fecha_ejecucion': { \n                                    label: 'Sin fecha', \n                                    desc: 'El trade no tiene timestamp de ejecuci√≥n' \n                                  },\n                                  'datos_invalidos': { \n                                    label: 'Datos inv√°lidos', \n                                    desc: 'Precio o cantidad <= 0' \n                                  },\n                                  'venta_sin_compra_previa': { \n                                    label: 'Venta hu√©rfana', \n                                    desc: 'SELL sin BUY correspondiente (inventario pre-bot)' \n                                  },\n                                  'venta_excede_lotes': { \n                                    label: 'Venta excede stock', \n                                    desc: 'La cantidad vendida supera los lotes abiertos' \n                                  },\n                                  'comisiones_anormales': { \n                                    label: 'Comisiones raras', \n                                    desc: 'Fees fuera del rango 0.1%-2.5%' \n                                  },\n                                  'pnl_atipico': { \n                                    label: 'PnL extremo', \n                                    desc: 'Ganancia/p√©rdida > 100% (outlier estad√≠stico)' \n                                  },\n                                  'hold_excesivo': { \n                                    label: 'Hold muy largo', \n                                    desc: 'Posici√≥n mantenida > 30 d√≠as' \n                                  },\n                                  'timestamps_invalidos': { \n                                    label: 'Fechas err√≥neas', \n                                    desc: 'Exit timestamp antes de entry timestamp' \n                                  },\n                                };\n                                const info = discardInfo[k] || { label: k, desc: 'Sin descripci√≥n disponible' };\n                                return (\n                                  <div key={k} className=\"flex items-center justify-between p-1.5 bg-background/50 rounded\" title={info.desc}>\n                                    <span className=\"text-muted-foreground\">{info.label}</span>\n                                    <span className=\"font-mono text-yellow-500\">{v as number}</span>\n                                  </div>\n                                );\n                              })}\n                            </div>\n                            <div className=\"text-[10px] text-muted-foreground mt-1\">\n                              üí° Estos trades se excluyen para evitar sesgos en el modelo ML\n                            </div>\n                          </div>\n                        )}\n                        <Button \n                          size=\"sm\" \n                          variant=\"outline\"\n                          className=\"w-full\"\n                          disabled={backfillMutation.isPending}\n                          onClick={() => backfillMutation.mutate()}\n                          data-testid=\"button-backfill\"\n                        >\n                          {backfillMutation.isPending ? (\n                            <><Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> Procesando...</>\n                          ) : \"Ejecutar Backfill (Regenerar Dataset)\"}\n                        </Button>\n                      </div>\n                    )}\n                    \n                    <div className=\"p-4 border border-border rounded-lg bg-card/30\">\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className={`h-3 w-3 rounded-full ${\n                            aiStatus.phase === \"green\" ? \"bg-green-500\" : \n                            aiStatus.phase === \"yellow\" ? \"bg-yellow-500\" : \"bg-red-500\"\n                          } ${aiStatus.phase !== \"red\" ? \"animate-pulse\" : \"\"}`}></span>\n                          <span className=\"font-mono text-sm\">{aiStatus.phaseLabel}</span>\n                        </div>\n                        <Button \n                          size=\"sm\" \n                          variant=\"secondary\"\n                          disabled={!aiStatus.canTrain || trainMutation.isPending}\n                          onClick={() => trainMutation.mutate()}\n                          data-testid=\"button-train-ai\"\n                        >\n                          {trainMutation.isPending ? (\n                            <><Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> Entrenando...</>\n                          ) : \"Entrenar Modelo\"}\n                        </Button>\n                      </div>\n                      {aiStatus.metrics && (\n                        <div className=\"mt-3 grid grid-cols-2 gap-2 text-xs\">\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">Accuracy:</span>\n                            <span className=\"ml-2 font-mono\">{((aiStatus.metrics.accuracy ?? 0) * 100).toFixed(1)}%</span>\n                          </div>\n                          <div className=\"p-2 bg-background/50 rounded\">\n                            <span className=\"text-muted-foreground\">Precision:</span>\n                            <span className=\"ml-2 font-mono\">{((aiStatus.metrics.precision ?? 0) * 100).toFixed(1)}%</span>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                    \n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center justify-between p-3 border border-border rounded-lg bg-card/30\">\n                        <div className=\"space-y-0.5\">\n                          <Label>Shadow Mode</Label>\n                          <p className=\"text-xs text-muted-foreground\">Registra predicciones sin bloquear trades</p>\n                        </div>\n                        <Switch \n                          checked={aiStatus.shadowEnabled}\n                          onCheckedChange={(checked) => toggleAiMutation.mutate({ shadowEnabled: checked })}\n                          data-testid=\"switch-ai-shadow\"\n                        />\n                      </div>\n                      <div className=\"flex items-center justify-between p-3 border border-border rounded-lg bg-card/30\">\n                        <div className=\"space-y-0.5\">\n                          <Label>Filtro Activo</Label>\n                          <p className=\"text-xs text-muted-foreground\">Bloquea trades con baja probabilidad de √©xito</p>\n                        </div>\n                        <Switch \n                          checked={aiStatus.filterEnabled}\n                          disabled={!aiStatus.canActivate}\n                          onCheckedChange={(checked) => toggleAiMutation.mutate({ filterEnabled: checked })}\n                          data-testid=\"switch-ai-filter\"\n                        />\n                      </div>\n                    </div>\n                  </>\n                ) : (\n                  <p className=\"text-sm text-muted-foreground\">Error cargando estado de IA</p>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* NAS Deployment */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-orange-500/20 rounded-lg\">\n                    <HardDrive className=\"h-6 w-6 text-orange-400\" />\n                  </div>\n                  <div>\n                    <CardTitle>Despliegue QNAP NAS</CardTitle>\n                    <CardDescription>Configuraci√≥n para Container Station y Docker.</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                  <div className=\"grid gap-2\">\n                    <Label className=\"text-sm\">Direcci√≥n IP del NAS</Label>\n                    <Input placeholder=\"192.168.1.104\" defaultValue=\"192.168.1.104\" className=\"font-mono bg-background/50\" />\n                  </div>\n                  <div className=\"grid gap-2\">\n                    <Label>Puerto</Label>\n                    <Input placeholder=\"3000\" defaultValue=\"3000\" className=\"font-mono bg-background/50\" />\n                  </div>\n                </div>\n                <div className=\"flex items-center justify-between p-4 border border-border rounded-lg bg-card/30\">\n                  <div className=\"space-y-0.5\">\n                    <Label>Auto-Reinicio en Fallo</Label>\n                    <p className=\"text-sm text-muted-foreground\">Pol√≠tica de reinicio de Docker (--restart unless-stopped)</p>\n                  </div>\n                  <Switch defaultChecked />\n                </div>\n                <div className=\"flex items-center justify-between p-4 border border-border rounded-lg bg-card/30\">\n                  <div className=\"space-y-0.5\">\n                    <Label>Auto-Actualizaci√≥n</Label>\n                    <p className=\"text-sm text-muted-foreground\">Actualiza autom√°ticamente desde Git cada hora</p>\n                  </div>\n                  <Switch defaultChecked />\n                </div>\n                <Button \n                  className=\"w-full bg-orange-600 hover:bg-orange-700 text-white\" \n                  onClick={() => {\n                    const link = document.createElement('a');\n                    link.href = '/docker-compose.yml';\n                    link.download = 'docker-compose.yml';\n                    link.click();\n                  }}\n                  data-testid=\"button-download-docker\"\n                >\n                  <Server className=\"mr-2 h-4 w-4\" /> Descargar docker-compose.yml\n                </Button>\n              </CardContent>\n            </Card>\n\n            {/* System Info */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-cyan-500/20 rounded-lg\">\n                    <Cog className=\"h-6 w-6 text-cyan-400\" />\n                  </div>\n                  <div>\n                    <CardTitle>Informaci√≥n del Sistema</CardTitle>\n                    <CardDescription>Versi√≥n y estado del bot.</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 gap-3 md:gap-4 text-xs md:text-sm\">\n                  <div className=\"p-2 md:p-3 border border-border rounded-lg bg-card/30\">\n                    <p className=\"text-muted-foreground\">Versi√≥n</p>\n                    <p className=\"font-mono font-medium\">1.0.0</p>\n                  </div>\n                  <div className=\"p-2 md:p-3 border border-border rounded-lg bg-card/30\">\n                    <p className=\"text-muted-foreground\">Entorno</p>\n                    <p className=\"font-mono font-medium\">Producci√≥n</p>\n                  </div>\n                  <div className=\"p-2 md:p-3 border border-border rounded-lg bg-card/30\">\n                    <p className=\"text-muted-foreground\">Base de datos</p>\n                    <p className=\"font-mono font-medium text-green-500\">Conectada</p>\n                  </div>\n                  <div className=\"p-2 md:p-3 border border-border rounded-lg bg-card/30\">\n                    <p className=\"text-muted-foreground\">√öltima actualizaci√≥n</p>\n                    <p className=\"font-mono font-medium\">{new Date().toLocaleDateString(\"es-ES\")}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n          </div>\n        </main>\n      </div>\n    </div>\n  );\n}\n\ninterface PairOverridesSectionProps {\n  overrides: Record<string, Record<string, unknown>> | null;\n  onUpdate: (newOverrides: Record<string, Record<string, unknown>> | null) => void;\n  activePairs: string[];\n}\n\nfunction PairOverridesSection({ overrides, onUpdate, activePairs }: PairOverridesSectionProps) {\n  const [expandedPair, setExpandedPair] = useState<string | null>(null);\n  const [newPair, setNewPair] = useState<string>(\"\");\n  \n  const currentOverrides = overrides || {};\n  const pairsWithOverrides = Object.keys(currentOverrides);\n  const availablePairs = activePairs.filter(p => !pairsWithOverrides.includes(p));\n\n  const handleAddPair = () => {\n    if (!newPair || pairsWithOverrides.includes(newPair)) return;\n    onUpdate({\n      ...currentOverrides,\n      [newPair]: {}\n    });\n    setExpandedPair(newPair);\n    setNewPair(\"\");\n  };\n\n  const handleRemovePair = (pair: string) => {\n    const updated = { ...currentOverrides };\n    delete updated[pair];\n    onUpdate(Object.keys(updated).length > 0 ? updated : null);\n    if (expandedPair === pair) setExpandedPair(null);\n  };\n\n  const handleUpdatePairValue = (pair: string, key: string, value: string | boolean) => {\n    const updated = {\n      ...currentOverrides,\n      [pair]: {\n        ...currentOverrides[pair],\n        [key]: value\n      }\n    };\n    onUpdate(updated);\n  };\n\n  const handleRemovePairValue = (pair: string, key: string) => {\n    const pairData = { ...currentOverrides[pair] };\n    delete pairData[key];\n    const updated = {\n      ...currentOverrides,\n      [pair]: pairData\n    };\n    if (Object.keys(pairData).length === 0) {\n      delete updated[pair];\n    }\n    onUpdate(Object.keys(updated).length > 0 ? updated : null);\n  };\n\n  return (\n    <div className=\"border-t border-blue-500/30 pt-4 mt-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <h5 className=\"text-sm font-medium text-blue-300\" data-testid=\"text-pair-overrides-title\">\n          Ajustes por Par\n        </h5>\n        <span className=\"text-xs text-muted-foreground\">\n          {pairsWithOverrides.length} par(es) configurado(s)\n        </span>\n      </div>\n      \n      <p className=\"text-xs text-muted-foreground mb-3\">\n        Configura par√°metros espec√≠ficos para cada par. Los valores aqu√≠ sobreescriben la configuraci√≥n global.\n      </p>\n\n      {pairsWithOverrides.length > 0 && (\n        <div className=\"space-y-2 mb-3\">\n          {pairsWithOverrides.map((pair) => (\n            <div key={pair} className=\"border border-border rounded-lg bg-background/30\">\n              <div \n                className=\"flex items-center justify-between p-2 cursor-pointer hover:bg-muted/20\"\n                onClick={() => setExpandedPair(expandedPair === pair ? null : pair)}\n              >\n                <div className=\"flex items-center gap-2\">\n                  <ChevronRight className={cn(\"h-4 w-4 transition-transform\", expandedPair === pair && \"rotate-90\")} />\n                  <span className=\"font-mono text-sm\">{pair}</span>\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {Object.keys(currentOverrides[pair]).length} override(s)\n                  </Badge>\n                </div>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-6 w-6 p-0 text-red-400 hover:text-red-300\"\n                  onClick={(e) => {\n                    e.stopPropagation();\n                    handleRemovePair(pair);\n                  }}\n                  data-testid={`btn-remove-override-${pair.replace(\"/\", \"-\")}`}\n                >\n                  <Trash2 className=\"h-3 w-3\" />\n                </Button>\n              </div>\n              \n              {expandedPair === pair && (\n                <div className=\"p-3 border-t border-border space-y-3\">\n                  <PairOverrideFields\n                    pairData={currentOverrides[pair]}\n                    onUpdateValue={(key, value) => handleUpdatePairValue(pair, key, value)}\n                    onRemoveValue={(key) => handleRemovePairValue(pair, key)}\n                  />\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      )}\n\n      {availablePairs.length > 0 && (\n        <div className=\"flex gap-2\">\n          <Select value={newPair} onValueChange={setNewPair}>\n            <SelectTrigger className=\"w-[180px] bg-background/50\" data-testid=\"select-new-pair\">\n              <SelectValue placeholder=\"Seleccionar par...\" />\n            </SelectTrigger>\n            <SelectContent>\n              {availablePairs.map((pair) => (\n                <SelectItem key={pair} value={pair}>{pair}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            onClick={handleAddPair}\n            disabled={!newPair}\n            data-testid=\"btn-add-pair-override\"\n          >\n            <Plus className=\"h-4 w-4 mr-1\" />\n            Agregar\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface PairOverrideFieldsProps {\n  pairData: Record<string, unknown>;\n  onUpdateValue: (key: string, value: string | boolean) => void;\n  onRemoveValue: (key: string) => void;\n}\n\nconst OVERRIDE_FIELDS = [\n  { key: \"sgMinEntryUsd\", label: \"M√≠nimo entrada (USD)\", type: \"number\" },\n  { key: \"sgAllowUnderMin\", label: \"Permitir bajo m√≠nimo\", type: \"boolean\" },\n  { key: \"sgBeAtPct\", label: \"Break-Even (%)\", type: \"number\" },\n  { key: \"sgFeeCushionPct\", label: \"Colch√≥n comisiones (%)\", type: \"number\" },\n  { key: \"sgTrailStartPct\", label: \"Trail inicio (%)\", type: \"number\" },\n  { key: \"sgTrailDistancePct\", label: \"Trail distancia (%)\", type: \"number\" },\n  { key: \"sgTrailStepPct\", label: \"Trail paso (%)\", type: \"number\" },\n  { key: \"sgTpFixedEnabled\", label: \"TP fijo habilitado\", type: \"boolean\" },\n  { key: \"sgTpFixedPct\", label: \"TP fijo (%)\", type: \"number\" },\n  { key: \"sgScaleOutEnabled\", label: \"Scale-Out habilitado\", type: \"boolean\" },\n  { key: \"sgScaleOutPct\", label: \"Scale-Out (%)\", type: \"number\" },\n  { key: \"sgScaleOutThreshold\", label: \"Scale-Out confianza (%)\", type: \"number\" },\n  { key: \"sgMinPartUsd\", label: \"M√≠nimo parte (USD)\", type: \"number\" },\n];\n\nfunction PairOverrideFields({ pairData, onUpdateValue, onRemoveValue }: PairOverrideFieldsProps) {\n  const activeKeys = Object.keys(pairData);\n  const availableFields = OVERRIDE_FIELDS.filter(f => !activeKeys.includes(f.key));\n  const [newFieldKey, setNewFieldKey] = useState<string>(\"\");\n\n  const handleAddField = () => {\n    if (!newFieldKey) return;\n    const field = OVERRIDE_FIELDS.find(f => f.key === newFieldKey);\n    if (field) {\n      onUpdateValue(newFieldKey, field.type === \"boolean\" ? false : \"\");\n      setNewFieldKey(\"\");\n    }\n  };\n\n  return (\n    <div className=\"space-y-2\">\n      {activeKeys.map((key) => {\n        const field = OVERRIDE_FIELDS.find(f => f.key === key);\n        if (!field) return null;\n        \n        return (\n          <div key={key} className=\"flex items-center gap-2\">\n            <Label className=\"text-xs w-32 flex-shrink-0\">{field.label}</Label>\n            {field.type === \"boolean\" ? (\n              <Switch\n                checked={!!pairData[key]}\n                onCheckedChange={(val) => onUpdateValue(key, val)}\n                data-testid={`switch-override-${key}`}\n              />\n            ) : (\n              <Input\n                type=\"number\"\n                value={String(pairData[key] || \"\")}\n                onChange={(e) => onUpdateValue(key, e.target.value)}\n                className=\"h-7 text-xs font-mono flex-1\"\n                data-testid={`input-override-${key}`}\n              />\n            )}\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"h-6 w-6 p-0 text-muted-foreground hover:text-red-400\"\n              onClick={() => onRemoveValue(key)}\n            >\n              <X className=\"h-3 w-3\" />\n            </Button>\n          </div>\n        );\n      })}\n      \n      {availableFields.length > 0 && (\n        <div className=\"flex gap-2 pt-2 border-t border-border/50\">\n          <Select value={newFieldKey} onValueChange={setNewFieldKey}>\n            <SelectTrigger className=\"w-[200px] h-7 text-xs\" data-testid=\"select-new-field\">\n              <SelectValue placeholder=\"Agregar campo...\" />\n            </SelectTrigger>\n            <SelectContent>\n              {availableFields.map((f) => (\n                <SelectItem key={f.key} value={f.key}>{f.label}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          <Button \n            variant=\"outline\" \n            size=\"sm\" \n            className=\"h-7 text-xs\"\n            onClick={handleAddField}\n            disabled={!newFieldKey}\n          >\n            <Plus className=\"h-3 w-3\" />\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":62139,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute right-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5745,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Minus } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-1 ring-ring\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Minus />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2143,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationLink,\n  PaginationItem,\n  PaginationPrevious,\n  PaginationNext,\n  PaginationEllipsis,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/item.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction ItemGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      role=\"list\"\n      data-slot=\"item-group\"\n      className={cn(\"group/item-group flex flex-col\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"item-separator\"\n      orientation=\"horizontal\"\n      className={cn(\"my-0\", className)}\n      {...props}\n    />\n  )\n}\n\nconst itemVariants = cva(\n  \"group/item [a]:hover:bg-accent/50 focus-visible:border-ring focus-visible:ring-ring/50 [a]:transition-colors flex flex-wrap items-center rounded-md border border-transparent text-sm outline-none transition-colors duration-100 focus-visible:ring-[3px]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline: \"border-border\",\n        muted: \"bg-muted/50\",\n      },\n      size: {\n        default: \"gap-4 p-4 \",\n        sm: \"gap-2.5 px-4 py-3\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction Item({\n  className,\n  variant = \"default\",\n  size = \"default\",\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> &\n  VariantProps<typeof itemVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n  return (\n    <Comp\n      data-slot=\"item\"\n      data-variant={variant}\n      data-size={size}\n      className={cn(itemVariants({ variant, size, className }))}\n      {...props}\n    />\n  )\n}\n\nconst itemMediaVariants = cva(\n  \"flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:translate-y-0.5 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted size-8 rounded-sm border [&_svg:not([class*='size-'])]:size-4\",\n        image:\n          \"size-10 overflow-hidden rounded-sm [&_img]:size-full [&_img]:object-cover\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction ItemMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof itemMediaVariants>) {\n  return (\n    <div\n      data-slot=\"item-media\"\n      data-variant={variant}\n      className={cn(itemMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction ItemContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-content\"\n      className={cn(\n        \"flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-title\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"item-description\"\n      className={cn(\n        \"text-muted-foreground line-clamp-2 text-balance text-sm font-normal leading-normal\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemActions({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-actions\"\n      className={cn(\"flex items-center gap-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-header\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-footer\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Item,\n  ItemMedia,\n  ItemContent,\n  ItemActions,\n  ItemGroup,\n  ItemSeparator,\n  ItemTitle,\n  ItemDescription,\n  ItemHeader,\n  ItemFooter,\n}\n","path":null,"size_bytes":4494,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/dashboard/TradeLog.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RefreshCw, Clock } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface Trade {\n  id: string;\n  krakenOrderId?: string;\n  pair: string;\n  type: string;\n  price: string;\n  amount: string;\n  time: string;\n  status: string;\n}\n\nexport function TradeLog() {\n  const { data: krakenTrades, isLoading, refetch, isFetching } = useQuery<Trade[]>({\n    queryKey: [\"krakenTrades\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/kraken/trades\");\n      if (!res.ok) {\n        const dbRes = await fetch(\"/api/trades?limit=10\");\n        if (!dbRes.ok) return [];\n        return dbRes.json();\n      }\n      return res.json();\n    },\n    refetchInterval: 60000,\n  });\n\n  const formatTime = (timeStr: string) => {\n    const date = new Date(timeStr);\n    return date.toLocaleTimeString(\"es-ES\", {\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      second: \"2-digit\",\n    });\n  };\n\n  const formatPrice = (price: string) => {\n    const num = parseFloat(price);\n    return num.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n  };\n\n  const formatAmount = (amount: string, pair: string) => {\n    const num = parseFloat(amount);\n    const asset = pair.split(\"/\")[0];\n    return `${num.toFixed(6)} ${asset}`;\n  };\n\n  return (\n    <div className=\"rounded-md border border-border bg-card/50\">\n      <div className=\"p-3 md:p-4 border-b border-border bg-muted/20 flex items-center justify-between gap-2\">\n        <h3 className=\"font-semibold font-mono text-xs md:text-sm tracking-wider text-primary\">REGISTRO DE OPERACIONES</h3>\n        <Button \n          variant=\"ghost\" \n          size=\"sm\" \n          onClick={() => refetch()}\n          disabled={isFetching}\n          className=\"text-muted-foreground hover:text-primary text-xs md:text-sm\"\n          data-testid=\"button-refresh-trades\"\n        >\n          <RefreshCw className={`h-4 w-4 ${isFetching ? 'animate-spin' : ''}`} />\n          <span className=\"hidden sm:inline ml-2\">Actualizar</span>\n        </Button>\n      </div>\n      <div className=\"overflow-x-auto\">\n        <Table>\n          <TableHeader>\n            <TableRow className=\"hover:bg-transparent border-border\">\n              <TableHead className=\"w-[80px] font-mono text-xs\">ID</TableHead>\n              <TableHead className=\"font-mono text-xs\">PAR</TableHead>\n              <TableHead className=\"font-mono text-xs\">TIPO</TableHead>\n              <TableHead className=\"font-mono text-xs text-right\">PRECIO</TableHead>\n              <TableHead className=\"font-mono text-xs text-right hidden sm:table-cell\">CANTIDAD</TableHead>\n              <TableHead className=\"font-mono text-xs text-right hidden md:table-cell\">HORA</TableHead>\n              <TableHead className=\"font-mono text-xs text-right\">ESTADO</TableHead>\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {isLoading ? (\n              <TableRow>\n                <TableCell colSpan={7} className=\"text-center py-8\">\n                  <div className=\"flex items-center justify-center gap-2 text-muted-foreground\">\n                    <RefreshCw className=\"h-4 w-4 animate-spin\" />\n                    Cargando operaciones...\n                  </div>\n                </TableCell>\n              </TableRow>\n            ) : krakenTrades && krakenTrades.length > 0 ? (\n              krakenTrades.slice(0, 10).map((trade) => (\n                <TableRow key={trade.id || trade.krakenOrderId} className=\"hover:bg-muted/50 border-border font-mono text-xs\" data-testid={`trade-row-${trade.id}`}>\n                  <TableCell className=\"font-medium text-muted-foreground text-xs\">{trade.id}</TableCell>\n                  <TableCell className=\"text-foreground text-xs\">{trade.pair}</TableCell>\n                  <TableCell>\n                    <Badge variant=\"outline\" className={`text-xs ${trade.type === \"buy\" ? \"text-green-500 border-green-500/50 bg-green-500/10\" : \"text-red-500 border-red-500/50 bg-red-500/10\"}`}>\n                      {trade.type === \"buy\" ? \"COMPRA\" : \"VENTA\"}\n                    </Badge>\n                  </TableCell>\n                  <TableCell className=\"text-right text-xs\">{formatPrice(trade.price)}</TableCell>\n                  <TableCell className=\"text-right text-muted-foreground text-xs hidden sm:table-cell\">{formatAmount(trade.amount, trade.pair)}</TableCell>\n                  <TableCell className=\"text-right text-muted-foreground text-xs hidden md:table-cell\">{formatTime(trade.time)}</TableCell>\n                  <TableCell className=\"text-right text-primary text-xs\">{trade.status === \"filled\" ? \"OK\" : trade.status}</TableCell>\n                </TableRow>\n              ))\n            ) : (\n              <TableRow>\n                <TableCell colSpan={7} className=\"text-center py-8\">\n                  <div className=\"flex flex-col items-center gap-2 text-muted-foreground\">\n                    <Clock className=\"h-8 w-8 opacity-50\" />\n                    <p>No hay operaciones registradas</p>\n                    <p className=\"text-xs\">Las operaciones aparecer√°n aqu√≠ cuando se ejecuten trades.</p>\n                  </div>\n                </TableCell>\n              </TableRow>\n            )}\n          </TableBody>\n        </Table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5488,"size_tokens":null},"GUIA_INSTALACION.md":{"content":"# ü§ñ GU√çA COMPLETA: KrakenBot en tu QNAP NAS\n\n**Bot de Trading Aut√≥nomo para Kraken Exchange**\n\nEsta gu√≠a te lleva paso a paso desde cero hasta tener el bot funcionando.\n\n---\n\n# üìã ANTES DE EMPEZAR\n\n## Lo que vas a necesitar:\n\n| Cosa | Para qu√© |\n|------|----------|\n| NAS QNAP | Donde correr√° el bot 24/7 |\n| Cuenta Kraken | Para hacer trading |\n| Cuenta Telegram | Para recibir notificaciones |\n| 30 minutos | Tiempo aproximado de instalaci√≥n |\n\n---\n\n# PASO 1: PREPARAR TU NAS\n\n## 1.1 Instalar Container Station\n\n1. Abre la interfaz web de tu NAS: `http://TU_IP_NAS:8080`\n2. Inicia sesi√≥n con tu usuario administrador\n3. Abre el **App Center** (icono de bolsa de compras)\n4. Busca: `Container Station`\n5. Haz clic en **Instalar**\n6. Espera 5-10 minutos a que termine\n\n## 1.2 Crear la carpeta del proyecto\n\n1. Abre **File Station** en tu NAS\n2. Navega a: `Container`\n3. Crea una nueva carpeta llamada: `krakenbot`\n4. Ruta final: `/share/Container/krakenbot/`\n\n---\n\n# PASO 2: DESCARGAR Y COPIAR EL PROYECTO\n\n## 2.1 Descargar el proyecto\n\n1. En Replit, haz clic en los **tres puntos (‚ãÆ)** arriba del explorador de archivos\n2. Selecciona **\"Download as zip\"**\n3. Guarda el archivo ZIP en tu ordenador\n\n## 2.2 Copiar al NAS\n\n1. Descomprime el ZIP en tu ordenador\n2. Abre **File Station** en tu NAS\n3. Navega a: `/share/Container/krakenbot/`\n4. Arrastra y suelta TODOS los archivos dentro\n\n### Estructura final:\n```\n/share/Container/krakenbot/\n‚îú‚îÄ‚îÄ üìÅ client/\n‚îú‚îÄ‚îÄ üìÅ server/\n‚îú‚îÄ‚îÄ üìÅ shared/\n‚îú‚îÄ‚îÄ üìÑ docker-compose.yml\n‚îú‚îÄ‚îÄ üìÑ Dockerfile\n‚îú‚îÄ‚îÄ üìÑ package.json\n‚îî‚îÄ‚îÄ üìÑ ... (resto de archivos)\n```\n\n---\n\n# PASO 3: OBTENER API KEYS DE KRAKEN\n\n## 3.1 Crear cuenta en Kraken (si no tienes)\n\n1. Ve a: **https://www.kraken.com**\n2. Haz clic en **Crear cuenta**\n3. Completa el registro\n4. **Importante:** Verifica tu identidad (KYC)\n\n## 3.2 Generar las API Keys\n\n1. Inicia sesi√≥n en Kraken\n2. Haz clic en tu nombre (arriba a la derecha)\n3. Ve a: **Seguridad** ‚Üí **API**\n4. Haz clic en **Crear clave API**\n\n## 3.3 Configurar permisos\n\nMarca SOLO estas opciones:\n- ‚úÖ Query Funds\n- ‚úÖ Query Open Orders & Trades\n- ‚úÖ Query Closed Orders & Trades\n- ‚úÖ Create & Modify Orders\n\n**‚ö†Ô∏è NUNCA marques:**\n- ‚ùå Withdraw Funds (Retirar fondos)\n\n## 3.4 Guardar las claves\n\nHaz clic en **Generar clave** y copia:\n\n| Dato | Ejemplo | Gu√°rdalo en un lugar seguro |\n|------|---------|----------------------------|\n| API Key | `xAbCdEfGhIjK...` | ‚úÖ |\n| Private Key (Secret) | `aBcDeFgHiJkL...` | ‚úÖ |\n\n**‚ö†Ô∏è El Secret solo se muestra UNA VEZ. Si lo pierdes, crea una nueva API Key.**\n\n---\n\n# PASO 4: CREAR BOT DE TELEGRAM\n\n## 4.1 Crear el Bot\n\n1. Abre **Telegram** en tu m√≥vil o PC\n2. Busca: `@BotFather`\n3. Escribe: `/newbot`\n4. Nombre del bot: `KrakenBot Alertas`\n5. Username: `MiKrakenBot_bot` (debe terminar en `bot`)\n6. **Copia el Token** que te da:\n   ```\n   7123456789:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw\n   ```\n\n## 4.2 Obtener tu Chat ID\n\n1. En Telegram, busca: `@userinfobot`\n2. Env√≠ale cualquier mensaje\n3. **Copia el n√∫mero de \"Id\"**: `123456789`\n\n## 4.3 Resumen de datos de Telegram\n\n| Dato | Ejemplo |\n|------|---------|\n| Bot Token | `7123456789:AAHdqTcvCH1vGWJxfSeofSAs0K5PALDsaw` |\n| Chat ID | `123456789` |\n\n---\n\n# PASO 5: CONFIGURAR LA CONTRASE√ëA\n\n## 5.1 Editar docker-compose.yml\n\n1. En File Station, navega a: `/share/Container/krakenbot/`\n2. Haz clic derecho en `docker-compose.yml`\n3. Selecciona **Abrir con editor de texto**\n4. Busca estas dos l√≠neas:\n   ```yaml\n   POSTGRES_PASSWORD: TuPasswordSegura123!\n   ```\n   y\n   ```yaml\n   DATABASE_URL: postgres://krakenbot:TuPasswordSegura123!@postgres:5432/krakenbot\n   ```\n5. Cambia `TuPasswordSegura123!` por tu propia contrase√±a **en ambas l√≠neas**\n6. Guarda el archivo\n\n---\n\n# PASO 6: INICIAR EL BOT\n\n## Opci√≥n A: Desde Container Station (Recomendado)\n\n1. Abre **Container Station** en tu NAS\n2. Ve a **Aplicaciones** (o \"Applications\")\n3. Haz clic en **Crear** (o \"Create\")\n4. Nombre: `krakenbot`\n5. En \"Ruta YAML\" selecciona: `/share/Container/krakenbot/docker-compose.yml`\n6. Haz clic en **Crear**\n7. Espera 3-5 minutos mientras se instala todo\n\n## Opci√≥n B: Desde terminal/SSH\n\n### En Windows:\n1. Abre **PowerShell**\n2. Escribe:\n   ```\n   ssh admin@192.168.1.XXX\n   ```\n   (cambia XXX por la IP de tu NAS)\n3. Introduce tu contrase√±a del NAS\n4. Ejecuta:\n   ```bash\n   cd /share/Container/krakenbot\n   docker-compose up -d\n   ```\n\n### En Mac/Linux:\n1. Abre **Terminal**\n2. Escribe:\n   ```bash\n   ssh admin@192.168.1.XXX\n   cd /share/Container/krakenbot\n   docker-compose up -d\n   ```\n\n## Ver el progreso de instalaci√≥n:\n```bash\ndocker-compose logs -f app\n```\n\nVer√°s algo como:\n```\nüöÄ Instalando dependencias...\nüî® Compilando aplicacion...\nüì¶ Sincronizando base de datos...\n‚úÖ Iniciando KrakenBot...\n```\n\n---\n\n# PASO 7: CONFIGURAR EL BOT DESDE LA WEB\n\n## 7.1 Acceder al Panel de Control\n\n1. Abre tu navegador\n2. Ve a: `http://TU_IP_NAS:3000`\n   - Ejemplo: `http://192.168.1.100:3000`\n3. Ver√°s el dashboard del bot\n\n## 7.2 Ir a Ajustes\n\n1. En el men√∫ superior, haz clic en **AJUSTES**\n\n## 7.3 Conectar Kraken\n\n1. En la secci√≥n **\"API de Kraken\"**:\n   - **API Key:** Pega tu API Key de Kraken\n   - **API Secret:** Pega tu Private Key/Secret\n2. Haz clic en **Conectar a Kraken**\n3. Debe aparecer: ‚úÖ **CONECTADO**\n\n## 7.4 Conectar Telegram\n\n1. En la secci√≥n **\"Notificaciones Telegram\"**:\n   - **Bot Token:** Pega el token que te dio BotFather\n   - **Chat ID:** Pega tu n√∫mero de ID\n2. Haz clic en **Probar Conexi√≥n**\n3. **Revisa Telegram** - deber√≠as recibir un mensaje de prueba\n\n---\n\n# PASO 8: ACTIVAR EL BOT\n\n1. Haz clic en **PANEL** en el men√∫ superior\n2. En **\"CONTROL DEL SISTEMA\"**:\n   - Elige una **Estrategia** (empieza con MOMENTUM_ALPHA_V2)\n   - Elige **Nivel de Riesgo** (empieza con BAJO)\n3. Haz clic en el bot√≥n **INICIAR**\n4. El indicador cambiar√° a üü¢ **EN L√çNEA**\n5. Recibir√°s una notificaci√≥n en Telegram\n\n---\n\n# ‚úÖ ¬°LISTO!\n\nTu bot de trading est√° funcionando en tu NAS 24/7.\n\n---\n\n# üìñ COMANDOS √öTILES\n\nConecta por SSH a tu NAS y usa estos comandos:\n\n| Acci√≥n | Comando |\n|--------|---------|\n| Ver logs en tiempo real | `docker-compose logs -f app` |\n| Reiniciar el bot | `docker-compose restart app` |\n| Parar el bot | `docker-compose down` |\n| Iniciar el bot | `docker-compose up -d` |\n| Ver estado | `docker-compose ps` |\n\n---\n\n# ‚ùì SOLUCI√ìN DE PROBLEMAS\n\n## \"No puedo acceder a http://IP:3000\"\n- Verifica que la IP es correcta\n- Espera 5 minutos (la primera instalaci√≥n tarda)\n- Revisa los logs: `docker-compose logs -f app`\n\n## \"Error al conectar con Kraken\"\n- Revisa que copiaste bien la API Key y el Secret\n- Verifica que la API Key tiene los permisos correctos\n- Aseg√∫rate que tu cuenta Kraken est√° verificada\n\n## \"No recibo notificaciones en Telegram\"\n- Env√≠a un mensaje a tu bot primero (cualquier cosa)\n- Verifica que el Chat ID es correcto\n- Comprueba que el Token es correcto\n\n## \"El contenedor no arranca\"\n- Revisa los logs: `docker-compose logs app`\n- Verifica que la contrase√±a es igual en las dos l√≠neas del docker-compose.yml\n- Aseg√∫rate que hay espacio en disco\n\n---\n\n# üîí SEGURIDAD\n\n1. **NUNCA** compartas tus API Keys\n2. **NUNCA** actives permisos de retiro en Kraken\n3. Usa contrase√±as seguras\n4. El bot solo tiene acceso a tu red local\n5. Empieza con cantidades peque√±as\n\n---\n\n# üìä RESUMEN DE DATOS\n\nGuarda esta tabla en un lugar seguro:\n\n| Dato | Valor | D√≥nde se usa |\n|------|-------|--------------|\n| IP del NAS | `192.168.1.___` | Acceder al panel |\n| URL del Panel | `http://IP:3000` | Navegador |\n| Kraken API Key | `____________` | Ajustes ‚Üí Kraken |\n| Kraken Secret | `____________` | Ajustes ‚Üí Kraken |\n| Telegram Token | `____________` | Ajustes ‚Üí Telegram |\n| Telegram Chat ID | `____________` | Ajustes ‚Üí Telegram |\n| Password BD | `____________` | docker-compose.yml |\n\n---\n\n# ‚ö†Ô∏è ADVERTENCIA LEGAL\n\n- Este bot opera con **dinero real**\n- Los mercados de criptomonedas son **muy vol√°tiles**\n- **Nunca inviertas** m√°s de lo que puedas perder\n- El bot es una herramienta, **no garantiza ganancias**\n- T√∫ eres el √∫nico responsable de tus operaciones\n\n---\n\n**¬°Buena suerte con tu trading!** üöÄ\n","path":null,"size_bytes":8243,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport tailwindcss from \"@tailwindcss/vite\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\nimport { metaImagesPlugin } from \"./vite-plugin-meta-images\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    tailwindcss(),\n    metaImagesPlugin(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  css: {\n    postcss: {\n      plugins: [],\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    host: \"0.0.0.0\",\n    allowedHosts: true,\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1330,"size_tokens":null},"client/src/index.css":{"content":"@import \"tailwindcss\";\n@import \"tw-animate-css\";\n\n@custom-variant dark (&:is(.dark *));\n\n@theme inline {\n  --radius-sm: 2px;\n  --radius-md: 4px;\n  --radius-lg: 6px;\n  --radius-xl: 8px;\n\n  /* Dark Future Palette */\n  --color-background: hsl(222 47% 6%); /* Deep almost black blue */\n  --color-foreground: hsl(210 40% 98%);\n\n  --color-card: hsl(222 47% 10%);\n  --color-card-foreground: hsl(210 40% 98%);\n\n  --color-popover: hsl(222 47% 10%);\n  --color-popover-foreground: hsl(210 40% 98%);\n\n  --color-primary: hsl(180 100% 50%); /* Cyan Neon */\n  --color-primary-foreground: hsl(222 47% 11%);\n\n  --color-secondary: hsl(217 33% 17%);\n  --color-secondary-foreground: hsl(210 40% 98%);\n\n  --color-muted: hsl(217 33% 17%);\n  --color-muted-foreground: hsl(215 20% 65%);\n\n  --color-accent: hsl(180 100% 50%);\n  --color-accent-foreground: hsl(222 47% 11%);\n\n  --color-destructive: hsl(0 84% 60%); /* Red Neon */\n  --color-destructive-foreground: hsl(210 40% 98%);\n\n  --color-border: hsl(217 33% 20%);\n  --color-input: hsl(217 33% 20%);\n  --color-ring: hsl(180 100% 50%);\n\n  --color-chart-1: hsl(180 100% 50%); /* Cyan */\n  --color-chart-2: hsl(280 100% 70%); /* Purple */\n  --color-chart-3: hsl(120 100% 50%); /* Green */\n  --color-chart-4: hsl(60 100% 50%);  /* Yellow */\n  --color-chart-5: hsl(0 100% 65%);   /* Red */\n\n  --color-sidebar: hsl(222 47% 8%);\n  --color-sidebar-foreground: hsl(210 40% 98%);\n  --color-sidebar-primary: hsl(180 100% 50%);\n  --color-sidebar-primary-foreground: hsl(222 47% 11%);\n  --color-sidebar-accent: hsl(217 33% 15%);\n  --color-sidebar-accent-foreground: hsl(210 40% 98%);\n  --color-sidebar-border: hsl(217 33% 20%);\n  --color-sidebar-ring: hsl(180 100% 50%);\n\n  --font-sans: 'Space Grotesk', sans-serif;\n  --font-mono: 'JetBrains Mono', monospace;\n  \n  --radius: 0.25rem;\n\n  --animate-infinite-scroll: infinite-scroll 25s linear infinite;\n\n  @keyframes infinite-scroll {\n    from { transform: translateX(0); }\n    to { transform: translateX(-100%); }\n  }\n\n  @keyframes ticker-scroll {\n    from { transform: translateX(0); }\n    to { transform: translateX(-50%); }\n  }\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    background-image: \n      radial-gradient(circle at 50% 0%, hsl(222 47% 15% / 0.5), transparent 70%),\n      linear-gradient(to bottom, transparent, hsl(222 47% 6%));\n  }\n}\n\n/* Custom Scrollbar for that terminal feel */\n::-webkit-scrollbar {\n  width: 8px;\n  height: 8px;\n}\n::-webkit-scrollbar-track {\n  background: hsl(222 47% 8%);\n}\n::-webkit-scrollbar-thumb {\n  background: hsl(217 33% 30%);\n  border-radius: 4px;\n}\n::-webkit-scrollbar-thumb:hover {\n  background: hsl(180 100% 50% / 0.5);\n}\n\n.glow-text {\n  text-shadow: 0 0 10px hsl(180 100% 50% / 0.5);\n}\n\n.glass-panel {\n  background: hsl(222 47% 10% / 0.7);\n  backdrop-filter: blur(12px);\n  border: 1px solid hsl(217 33% 25%);\n}\n\n.animate-ticker {\n  animation: ticker-scroll 60s linear infinite;\n}\n","path":null,"size_bytes":2974,"size_tokens":null},"client/src/components/ui/field.tsx":{"content":"\"use client\"\n\nimport { useMemo } from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction FieldSet({ className, ...props }: React.ComponentProps<\"fieldset\">) {\n  return (\n    <fieldset\n      data-slot=\"field-set\"\n      className={cn(\n        \"flex flex-col gap-6\",\n        \"has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLegend({\n  className,\n  variant = \"legend\",\n  ...props\n}: React.ComponentProps<\"legend\"> & { variant?: \"legend\" | \"label\" }) {\n  return (\n    <legend\n      data-slot=\"field-legend\"\n      data-variant={variant}\n      className={cn(\n        \"mb-3 font-medium\",\n        \"data-[variant=legend]:text-base\",\n        \"data-[variant=label]:text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-group\"\n      className={cn(\n        \"group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst fieldVariants = cva(\n  \"group/field data-[invalid=true]:text-destructive flex w-full gap-3\",\n  {\n    variants: {\n      orientation: {\n        vertical: [\"flex-col [&>*]:w-full [&>.sr-only]:w-auto\"],\n        horizontal: [\n          \"flex-row items-center\",\n          \"[&>[data-slot=field-label]]:flex-auto\",\n          \"has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px has-[>[data-slot=field-content]]:items-start\",\n        ],\n        responsive: [\n          \"@md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto flex-col [&>*]:w-full [&>.sr-only]:w-auto\",\n          \"@md/field-group:[&>[data-slot=field-label]]:flex-auto\",\n          \"@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px\",\n        ],\n      },\n    },\n    defaultVariants: {\n      orientation: \"vertical\",\n    },\n  }\n)\n\nfunction Field({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof fieldVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"field\"\n      data-orientation={orientation}\n      className={cn(fieldVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction FieldContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-content\"\n      className={cn(\n        \"group/field-content flex flex-1 flex-col gap-1.5 leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLabel({\n  className,\n  ...props\n}: React.ComponentProps<typeof Label>) {\n  return (\n    <Label\n      data-slot=\"field-label\"\n      className={cn(\n        \"group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50\",\n        \"has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>[data-slot=field]]:p-4\",\n        \"has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-label\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug group-data-[disabled=true]/field:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"field-description\"\n      className={cn(\n        \"text-muted-foreground text-sm font-normal leading-normal group-has-[[data-orientation=horizontal]]/field:text-balance\",\n        \"nth-last-2:-mt-1 last:mt-0 [[data-variant=legend]+&]:-mt-1.5\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldSeparator({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  children?: React.ReactNode\n}) {\n  return (\n    <div\n      data-slot=\"field-separator\"\n      data-content={!!children}\n      className={cn(\n        \"relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2\",\n        className\n      )}\n      {...props}\n    >\n      <Separator className=\"absolute inset-0 top-1/2\" />\n      {children && (\n        <span\n          className=\"bg-background text-muted-foreground relative mx-auto block w-fit px-2\"\n          data-slot=\"field-separator-content\"\n        >\n          {children}\n        </span>\n      )}\n    </div>\n  )\n}\n\nfunction FieldError({\n  className,\n  children,\n  errors,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  errors?: Array<{ message?: string } | undefined>\n}) {\n  const content = useMemo(() => {\n    if (children) {\n      return children\n    }\n\n    if (!errors) {\n      return null\n    }\n\n    if (errors?.length === 1 && errors[0]?.message) {\n      return errors[0].message\n    }\n\n    return (\n      <ul className=\"ml-4 flex list-disc flex-col gap-1\">\n        {errors.map(\n          (error, index) =>\n            error?.message && <li key={index}>{error.message}</li>\n        )}\n      </ul>\n    )\n  }, [children, errors])\n\n  if (!content) {\n    return null\n  }\n\n  return (\n    <div\n      role=\"alert\"\n      data-slot=\"field-error\"\n      className={cn(\"text-destructive text-sm font-normal\", className)}\n      {...props}\n    >\n      {content}\n    </div>\n  )\n}\n\nexport {\n  Field,\n  FieldLabel,\n  FieldDescription,\n  FieldError,\n  FieldGroup,\n  FieldLegend,\n  FieldSeparator,\n  FieldSet,\n  FieldContent,\n  FieldTitle,\n}\n","path":null,"size_bytes":6044,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"scripts/update-nas.sh":{"content":"#!/bin/bash\n\n# Script de actualizaci√≥n para KrakenBot en QNAP NAS\n# Uso: ./update-nas.sh\n\nset -e\n\n# Configuraci√≥n - Ajusta seg√∫n tu entorno\nNAS_PATH=\"/share/ZFS37_DATA/share/Container/krakenbot\"\nCONTAINER_NAME=\"krakenbot\"\nBACKUP_DIR=\"/share/ZFS37_DATA/share/Container/krakenbot_backups\"\n\necho \"================================================\"\necho \"  KRAKENBOT - Script de Actualizaci√≥n para NAS\"\necho \"================================================\"\necho \"\"\n\n# Crear directorio de backups si no existe\nmkdir -p \"$BACKUP_DIR\"\n\n# Backup de la versi√≥n actual\nBACKUP_NAME=\"krakenbot_backup_$(date +%Y%m%d_%H%M%S)\"\necho \"[1/5] Creando backup de la versi√≥n actual...\"\nif [ -d \"$NAS_PATH\" ]; then\n    cp -r \"$NAS_PATH\" \"$BACKUP_DIR/$BACKUP_NAME\"\n    echo \"      Backup guardado en: $BACKUP_DIR/$BACKUP_NAME\"\nelse\n    echo \"      No se encontr√≥ instalaci√≥n previa, saltando backup...\"\nfi\n\n# Detener el contenedor actual\necho \"\"\necho \"[2/5] Deteniendo contenedor actual...\"\ndocker stop \"$CONTAINER_NAME\" 2>/dev/null || echo \"      Contenedor no estaba corriendo\"\n\n# Actualizar archivos (asume que los nuevos archivos est√°n en el directorio actual)\necho \"\"\necho \"[3/5] Actualizando archivos...\"\n# Preservar el .env y la base de datos\nif [ -f \"$NAS_PATH/.env\" ]; then\n    cp \"$NAS_PATH/.env\" /tmp/krakenbot_env_backup\nfi\n\n# Copiar nuevos archivos (ajusta la ruta origen seg√∫n necesites)\n# rsync -av --exclude='.env' --exclude='node_modules' --exclude='.git' ./ \"$NAS_PATH/\"\n\necho \"      Archivos actualizados\"\n\n# Restaurar .env\nif [ -f \"/tmp/krakenbot_env_backup\" ]; then\n    cp /tmp/krakenbot_env_backup \"$NAS_PATH/.env\"\n    echo \"      Archivo .env restaurado\"\nfi\n\n# Reconstruir imagen Docker\necho \"\"\necho \"[4/5] Reconstruyendo imagen Docker...\"\ncd \"$NAS_PATH\"\ndocker-compose build --no-cache\n\n# Reiniciar contenedor\necho \"\"\necho \"[5/5] Iniciando contenedor actualizado...\"\ndocker-compose up -d\n\necho \"\"\necho \"================================================\"\necho \"  ¬°Actualizaci√≥n completada!\"\necho \"================================================\"\necho \"\"\necho \"  El bot est√° disponible en: http://192.168.1.104:3000\"\necho \"\"\necho \"  Para ver los logs:\"\necho \"    docker logs -f $CONTAINER_NAME\"\necho \"\"\necho \"  En caso de problemas, restaurar backup:\"\necho \"    docker-compose down\"\necho \"    rm -rf $NAS_PATH/*\"\necho \"    cp -r $BACKUP_DIR/$BACKUP_NAME/* $NAS_PATH/\"\necho \"    docker-compose up -d\"\necho \"\"\n","path":null,"size_bytes":2421,"size_tokens":null},"client/src/pages/Wallet.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Nav } from \"@/components/dashboard/Nav\";\nimport { Ticker } from \"@/components/dashboard/Ticker\";\nimport generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Wallet as WalletIcon, TrendingUp, TrendingDown, PieChart, RefreshCw } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface DashboardData {\n  krakenConnected: boolean;\n  balances: Record<string, string>;\n  prices: Record<string, { price: string; change: string }>;\n}\n\nconst ASSET_INFO: Record<string, { name: string; color: string }> = {\n  \"XXBT\": { name: \"Bitcoin\", color: \"bg-orange-500\" },\n  \"XETH\": { name: \"Ethereum\", color: \"bg-blue-500\" },\n  \"SOL\": { name: \"Solana\", color: \"bg-purple-500\" },\n  \"ZUSD\": { name: \"USD\", color: \"bg-green-500\" },\n  \"XXRP\": { name: \"XRP\", color: \"bg-gray-500\" },\n  \"TON\": { name: \"Toncoin\", color: \"bg-cyan-500\" },\n  \"USDC\": { name: \"USD Coin\", color: \"bg-blue-400\" },\n};\n\nconst PRICE_PAIRS: Record<string, string> = {\n  \"XXBT\": \"XXBTZUSD\",\n  \"XETH\": \"XETHZUSD\",\n  \"SOL\": \"SOLUSD\",\n  \"XXRP\": \"XXRPZUSD\",\n  \"TON\": \"TONUSD\",\n};\n\nexport default function Wallet() {\n  const { data, isLoading, refetch, isFetching } = useQuery<DashboardData>({\n    queryKey: [\"dashboard\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/dashboard\");\n      if (!res.ok) throw new Error(\"Failed to fetch dashboard\");\n      return res.json();\n    },\n    refetchInterval: 30000,\n  });\n\n  const calculatePortfolio = () => {\n    if (!data?.balances || !data?.prices) return { assets: [], total: 0 };\n\n    const assets: { symbol: string; name: string; balance: number; value: number; color: string; change: number }[] = [];\n    let total = 0;\n\n    for (const [symbol, balanceStr] of Object.entries(data.balances)) {\n      const balance = parseFloat(balanceStr);\n      if (balance <= 0) continue;\n\n      let value = balance;\n      let change = 0;\n\n      if (symbol === \"ZUSD\" || symbol === \"USDC\") {\n        value = balance;\n      } else {\n        const pricePair = PRICE_PAIRS[symbol];\n        if (pricePair && data.prices[pricePair]) {\n          const price = parseFloat(data.prices[pricePair].price);\n          value = balance * price;\n          change = parseFloat(data.prices[pricePair].change);\n        }\n      }\n\n      if (value > 0.001) {\n        assets.push({\n          symbol,\n          name: ASSET_INFO[symbol]?.name || symbol,\n          balance,\n          value,\n          color: ASSET_INFO[symbol]?.color || \"bg-gray-500\",\n          change,\n        });\n        total += value;\n      }\n    }\n\n    return { assets: assets.sort((a, b) => b.value - a.value), total };\n  };\n\n  const { assets, total } = calculatePortfolio();\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col relative overflow-hidden\">\n      <div \n        className=\"fixed inset-0 z-0 opacity-20 pointer-events-none\" \n        style={{ \n          backgroundImage: `url(${generatedImage})`, \n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          mixBlendMode: 'overlay'\n        }} \n      />\n      \n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        <Nav />\n        <Ticker />\n        \n        <main className=\"flex-1 p-6 max-w-6xl mx-auto w-full space-y-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold font-sans tracking-tight\">Mi Cartera</h1>\n              <p className=\"text-muted-foreground mt-1\">Desglose completo de tus activos en Kraken.</p>\n            </div>\n            <Button \n              variant=\"outline\" \n              onClick={() => refetch()}\n              disabled={isFetching}\n              data-testid=\"button-refresh-wallet\"\n            >\n              <RefreshCw className={`h-4 w-4 mr-2 ${isFetching ? 'animate-spin' : ''}`} />\n              Actualizar\n            </Button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n            <Card className=\"glass-panel border-border/50 md:col-span-2\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <WalletIcon className=\"h-5 w-5 text-primary\" />\n                  Balance Total\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"text-4xl font-bold font-mono tracking-tight text-primary\">\n                  ${total.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                </div>\n                <p className=\"text-sm text-muted-foreground mt-2\">\n                  {assets.length} activos en tu cartera\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <PieChart className=\"h-5 w-5 text-primary\" />\n                  Distribuci√≥n\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3\">\n                  {assets.slice(0, 4).map((asset) => {\n                    const percentage = total > 0 ? (asset.value / total) * 100 : 0;\n                    return (\n                      <div key={asset.symbol} className=\"space-y-1\">\n                        <div className=\"flex justify-between text-sm\">\n                          <span className=\"font-mono\">{asset.name}</span>\n                          <span className=\"text-muted-foreground\">{percentage.toFixed(1)}%</span>\n                        </div>\n                        <Progress value={percentage} className=\"h-2\" />\n                      </div>\n                    );\n                  })}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Card className=\"glass-panel border-border/50\">\n            <CardHeader>\n              <CardTitle>Detalle de Activos</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"flex items-center justify-center py-12\">\n                  <RefreshCw className=\"h-8 w-8 animate-spin text-primary\" />\n                </div>\n              ) : !data?.krakenConnected ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <WalletIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>Conecta Kraken en Ajustes para ver tu cartera.</p>\n                </div>\n              ) : assets.length === 0 ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <WalletIcon className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No tienes activos en tu cuenta de Kraken.</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {assets.map((asset) => {\n                    const percentage = total > 0 ? (asset.value / total) * 100 : 0;\n                    return (\n                      <div\n                        key={asset.symbol}\n                        className=\"flex items-center justify-between p-4 bg-card/50 rounded-lg border border-border/30 hover:border-border/50 transition-colors\"\n                        data-testid={`asset-row-${asset.symbol}`}\n                      >\n                        <div className=\"flex items-center gap-4\">\n                          <div className={`w-10 h-10 rounded-full ${asset.color} flex items-center justify-center text-white font-bold text-sm`}>\n                            {asset.symbol.substring(0, 2)}\n                          </div>\n                          <div>\n                            <div className=\"font-medium\">{asset.name}</div>\n                            <div className=\"text-sm text-muted-foreground font-mono\">\n                              {asset.balance.toFixed(8)} {asset.symbol}\n                            </div>\n                          </div>\n                        </div>\n                        \n                        <div className=\"flex items-center gap-6\">\n                          <div className=\"text-right\">\n                            <div className=\"font-mono font-medium\">\n                              ${asset.value.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </div>\n                            <div className=\"text-sm text-muted-foreground\">\n                              {percentage.toFixed(1)}% del total\n                            </div>\n                          </div>\n                          {asset.change !== 0 && (\n                            <div className={`flex items-center gap-1 ${asset.change >= 0 ? \"text-green-500\" : \"text-red-500\"}`}>\n                              {asset.change >= 0 ? (\n                                <TrendingUp className=\"h-4 w-4\" />\n                              ) : (\n                                <TrendingDown className=\"h-4 w-4\" />\n                              )}\n                              <span className=\"font-mono text-sm\">\n                                {asset.change >= 0 ? \"+\" : \"\"}{asset.change.toFixed(2)}%\n                              </span>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </main>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9739,"size_tokens":null},"client/src/pages/Strategies.tsx":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Nav } from \"@/components/dashboard/Nav\";\nimport { Ticker } from \"@/components/dashboard/Ticker\";\nimport generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Activity, TrendingUp, TrendingDown, Zap, Shield, Target, RefreshCw, AlertTriangle, CircleDollarSign, PieChart, Wallet, Clock, CandlestickChart } from \"lucide-react\";\nimport { toast } from \"sonner\";\n\ninterface BotConfig {\n  id: number;\n  isActive: boolean;\n  strategy: string;\n  signalTimeframe: string;\n  riskLevel: string;\n  activePairs: string[];\n  stopLossPercent: string;\n  takeProfitPercent: string;\n  trailingStopEnabled: boolean;\n  trailingStopPercent: string;\n  maxPairExposurePct: string;\n  maxTotalExposurePct: string;\n  riskPerTradePct: string;\n}\n\nconst STRATEGIES = [\n  { id: \"momentum\", name: \"Momentum\", description: \"Sigue tendencias fuertes del mercado\", icon: TrendingUp },\n  { id: \"mean_reversion\", name: \"Reversi√≥n a la Media\", description: \"Opera cuando el precio se aleja de promedios\", icon: RefreshCw },\n  { id: \"scalping\", name: \"Scalping\", description: \"Operaciones r√°pidas con peque√±as ganancias\", icon: Zap },\n  { id: \"grid\", name: \"Grid Trading\", description: \"√ìrdenes escalonadas en rangos de precio\", icon: Target },\n];\n\nconst SIGNAL_TIMEFRAMES = [\n  { id: \"cycle\", name: \"Ciclos (30s)\", description: \"Eval√∫a cada ciclo del bot (~30 segundos)\" },\n  { id: \"5m\", name: \"Velas 5 min\", description: \"Eval√∫a solo al cierre de velas de 5 minutos\" },\n  { id: \"15m\", name: \"Velas 15 min\", description: \"Eval√∫a solo al cierre de velas de 15 minutos\" },\n  { id: \"1h\", name: \"Velas 1 hora\", description: \"Eval√∫a solo al cierre de velas de 1 hora\" },\n];\n\nconst RISK_LEVELS = [\n  { id: \"low\", name: \"Bajo\", description: \"Posiciones peque√±as, stops ajustados\", color: \"text-green-500\" },\n  { id: \"medium\", name: \"Medio\", description: \"Balance entre riesgo y rendimiento\", color: \"text-yellow-500\" },\n  { id: \"high\", name: \"Alto\", description: \"Posiciones grandes, mayor volatilidad\", color: \"text-red-500\" },\n];\n\nconst AVAILABLE_PAIRS = [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\", \"ETH/BTC\", \"XRP/USD\", \"TON/USD\"];\n\nexport default function Strategies() {\n  const queryClient = useQueryClient();\n\n  const { data: config, isLoading } = useQuery<BotConfig>({\n    queryKey: [\"botConfig\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/config\");\n      if (!res.ok) throw new Error(\"Failed to fetch config\");\n      return res.json();\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async (updates: Partial<BotConfig>) => {\n      const res = await fetch(\"/api/config\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update config\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"botConfig\"] });\n      toast.success(\"Configuraci√≥n actualizada\");\n    },\n    onError: () => {\n      toast.error(\"Error al actualizar configuraci√≥n\");\n    },\n  });\n\n  const togglePair = (pair: string) => {\n    const currentPairs = config?.activePairs || [];\n    const newPairs = currentPairs.includes(pair)\n      ? currentPairs.filter(p => p !== pair)\n      : [...currentPairs, pair];\n    updateMutation.mutate({ activePairs: newPairs });\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col relative overflow-hidden\">\n      <div \n        className=\"fixed inset-0 z-0 opacity-20 pointer-events-none\" \n        style={{ \n          backgroundImage: `url(${generatedImage})`, \n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          mixBlendMode: 'overlay'\n        }} \n      />\n      \n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        <Nav />\n        <Ticker />\n        \n        <main className=\"flex-1 p-4 md:p-6 max-w-6xl mx-auto w-full space-y-4 md:space-y-6\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n            <div>\n              <h1 className=\"text-2xl md:text-3xl font-bold font-sans tracking-tight\">Estrategias de Trading</h1>\n              <p className=\"text-sm md:text-base text-muted-foreground mt-1\">Configura el comportamiento del bot aut√≥nomo.</p>\n            </div>\n            <div className=\"flex items-center gap-3 md:gap-4\">\n              <span className=\"text-xs md:text-sm text-muted-foreground\">Bot Activo</span>\n              <Switch\n                checked={config?.isActive || false}\n                onCheckedChange={(checked) => updateMutation.mutate({ isActive: checked })}\n                data-testid=\"switch-bot-active\"\n              />\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6\">\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2 text-base md:text-lg\">\n                  <Activity className=\"h-4 w-4 md:h-5 md:w-5 text-primary\" />\n                  Estrategia Activa\n                </CardTitle>\n                <CardDescription>Selecciona el algoritmo de trading</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {STRATEGIES.map((strategy) => (\n                  <div\n                    key={strategy.id}\n                    onClick={() => updateMutation.mutate({ strategy: strategy.id })}\n                    className={`p-4 rounded-lg border cursor-pointer transition-all ${\n                      config?.strategy === strategy.id\n                        ? \"border-primary bg-primary/10\"\n                        : \"border-border/50 hover:border-border\"\n                    }`}\n                    data-testid={`strategy-${strategy.id}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <div className={`p-2 rounded-lg ${config?.strategy === strategy.id ? \"bg-primary/20\" : \"bg-muted\"}`}>\n                        <strategy.icon className={`h-5 w-5 ${config?.strategy === strategy.id ? \"text-primary\" : \"text-muted-foreground\"}`} />\n                      </div>\n                      <div className=\"flex-1\">\n                        <div className=\"font-medium\">{strategy.name}</div>\n                        <div className=\"text-sm text-muted-foreground\">{strategy.description}</div>\n                      </div>\n                      {config?.strategy === strategy.id && (\n                        <Badge variant=\"default\" className=\"font-mono\">ACTIVO</Badge>\n                      )}\n                    </div>\n                  </div>\n                ))}\n              </CardContent>\n            </Card>\n\n            {config?.strategy === \"momentum\" && (\n              <Card className=\"glass-panel border-border/50 border-cyan-500/30\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2 text-base md:text-lg\">\n                    <CandlestickChart className=\"h-4 w-4 md:h-5 md:w-5 text-cyan-500\" />\n                    Modo de Se√±al (Momentum)\n                  </CardTitle>\n                  <CardDescription>Define cu√°ndo el bot eval√∫a se√±ales de trading</CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {SIGNAL_TIMEFRAMES.map((tf) => (\n                    <div\n                      key={tf.id}\n                      onClick={() => updateMutation.mutate({ signalTimeframe: tf.id } as any)}\n                      className={`p-3 rounded-lg border cursor-pointer transition-all ${\n                        config?.signalTimeframe === tf.id\n                          ? \"border-cyan-500 bg-cyan-500/10\"\n                          : \"border-border/50 hover:border-border\"\n                      }`}\n                      data-testid={`timeframe-${tf.id}`}\n                    >\n                      <div className=\"flex items-center gap-3\">\n                        <div className={`p-2 rounded-lg ${config?.signalTimeframe === tf.id ? \"bg-cyan-500/20\" : \"bg-muted\"}`}>\n                          {tf.id === \"cycle\" ? (\n                            <Clock className={`h-4 w-4 ${config?.signalTimeframe === tf.id ? \"text-cyan-500\" : \"text-muted-foreground\"}`} />\n                          ) : (\n                            <CandlestickChart className={`h-4 w-4 ${config?.signalTimeframe === tf.id ? \"text-cyan-500\" : \"text-muted-foreground\"}`} />\n                          )}\n                        </div>\n                        <div className=\"flex-1\">\n                          <div className=\"font-medium text-sm\">{tf.name}</div>\n                          <div className=\"text-xs text-muted-foreground\">{tf.description}</div>\n                        </div>\n                        {config?.signalTimeframe === tf.id && (\n                          <Badge variant=\"outline\" className=\"font-mono text-cyan-500 border-cyan-500/50\">ACTIVO</Badge>\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                  <div className=\"bg-cyan-500/10 rounded-lg p-3 mt-3 border border-cyan-500/20\">\n                    <p className=\"text-xs text-muted-foreground\">\n                      <strong className=\"text-cyan-500\">Velas:</strong> Usa an√°lisis OHLC (EMA, RSI, MACD, patrones de velas) y solo opera al cierre de cada vela.\n                      <br /><strong className=\"text-cyan-500\">Ciclos:</strong> Eval√∫a precios en tiempo real cada 30 segundos.\n                    </p>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            <div className=\"space-y-6\">\n              <Card className=\"glass-panel border-border/50\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Shield className=\"h-5 w-5 text-primary\" />\n                    Nivel de Riesgo\n                  </CardTitle>\n                  <CardDescription>Define el tama√±o de posiciones</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <Select\n                    value={config?.riskLevel || \"medium\"}\n                    onValueChange={(value) => updateMutation.mutate({ riskLevel: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-risk-level\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {RISK_LEVELS.map((level) => (\n                        <SelectItem key={level.id} value={level.id}>\n                          <div className=\"flex items-center gap-2\">\n                            <span className={level.color}>{level.name}</span>\n                            <span className=\"text-muted-foreground text-xs\">- {level.description}</span>\n                          </div>\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </CardContent>\n              </Card>\n\n              <Card className=\"glass-panel border-border/50\">\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Target className=\"h-5 w-5 text-primary\" />\n                    Pares de Trading\n                  </CardTitle>\n                  <CardDescription>Activa/desactiva pares para operar</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {AVAILABLE_PAIRS.map((pair) => {\n                      const isActive = config?.activePairs?.includes(pair);\n                      return (\n                        <Button\n                          key={pair}\n                          variant={isActive ? \"default\" : \"outline\"}\n                          size=\"sm\"\n                          onClick={() => togglePair(pair)}\n                          className=\"font-mono\"\n                          data-testid={`pair-toggle-${pair.replace(\"/\", \"-\")}`}\n                        >\n                          {pair}\n                        </Button>\n                      );\n                    })}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <Card className=\"glass-panel border-border/50 border-yellow-500/30\">\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"p-2 bg-yellow-500/20 rounded-lg\">\n                      <Zap className=\"h-5 w-5 text-yellow-500\" />\n                    </div>\n                    <div>\n                      <h4 className=\"font-medium text-yellow-500\">Modo REAL Activado</h4>\n                      <p className=\"text-sm text-muted-foreground mt-1\">\n                        Todas las operaciones se ejecutan con dinero real en Kraken. \n                        No hay modo simulaci√≥n.\n                      </p>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n\n          <Card className=\"glass-panel border-border/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-primary\" />\n                Control de Riesgo Autom√°tico\n              </CardTitle>\n              <CardDescription>Configura stop-loss, take-profit y trailing stop para proteger tu capital</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6\">\n                <div className=\"space-y-3 md:space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label className=\"flex items-center gap-2 text-sm\">\n                      <div className=\"w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-red-500\" />\n                      Stop-Loss\n                    </Label>\n                    <span className=\"font-mono text-lg text-red-500\">-{parseFloat(config?.stopLossPercent || \"5\").toFixed(1)}%</span>\n                  </div>\n                  <Slider\n                    value={[parseFloat(config?.stopLossPercent || \"5\")]}\n                    onValueChange={(value) => updateMutation.mutate({ stopLossPercent: value[0].toString() } as any)}\n                    min={1}\n                    max={20}\n                    step={0.5}\n                    className=\"[&>span]:bg-red-500\"\n                    data-testid=\"slider-stop-loss\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Vende autom√°ticamente si el precio baja este porcentaje desde tu entrada.</p>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded-full bg-green-500\" />\n                      Take-Profit\n                    </Label>\n                    <span className=\"font-mono text-lg text-green-500\">+{parseFloat(config?.takeProfitPercent || \"7\").toFixed(1)}%</span>\n                  </div>\n                  <Slider\n                    value={[parseFloat(config?.takeProfitPercent || \"7\")]}\n                    onValueChange={(value) => updateMutation.mutate({ takeProfitPercent: value[0].toString() } as any)}\n                    min={1}\n                    max={30}\n                    step={0.5}\n                    className=\"[&>span]:bg-green-500\"\n                    data-testid=\"slider-take-profit\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Vende autom√°ticamente cuando alcanzas este porcentaje de ganancia.</p>\n                </div>\n              </div>\n\n              <div className=\"border-t border-border/50 pt-6\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <div>\n                    <Label className=\"flex items-center gap-2\">\n                      <CircleDollarSign className=\"h-4 w-4 text-cyan-500\" />\n                      Trailing Stop\n                    </Label>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Stop-loss que sube con el precio para asegurar ganancias</p>\n                  </div>\n                  <Switch\n                    checked={config?.trailingStopEnabled || false}\n                    onCheckedChange={(checked) => updateMutation.mutate({ trailingStopEnabled: checked } as any)}\n                    data-testid=\"switch-trailing-stop\"\n                  />\n                </div>\n\n                {config?.trailingStopEnabled && (\n                  <div className=\"space-y-4 animate-in fade-in slide-in-from-top-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <Label>Distancia del Trailing</Label>\n                      <span className=\"font-mono text-lg text-cyan-500\">{parseFloat(config?.trailingStopPercent || \"2\").toFixed(1)}%</span>\n                    </div>\n                    <Slider\n                      value={[parseFloat(config?.trailingStopPercent || \"2\")]}\n                      onValueChange={(value) => updateMutation.mutate({ trailingStopPercent: value[0].toString() } as any)}\n                      min={0.5}\n                      max={10}\n                      step={0.5}\n                      className=\"[&>span]:bg-cyan-500\"\n                      data-testid=\"slider-trailing-stop\"\n                    />\n                    <p className=\"text-xs text-muted-foreground\">\n                      Si el precio sube y luego cae este porcentaje desde el m√°ximo, se vende autom√°ticamente (solo si est√°s en ganancia).\n                    </p>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"bg-muted/30 rounded-lg p-4 mt-4\">\n                <h4 className=\"font-medium text-sm mb-2\">Ejemplo con configuraci√≥n actual:</h4>\n                <p className=\"text-xs text-muted-foreground\">\n                  Si compras BTC a $100,000:\n                  <br />‚Ä¢ <span className=\"text-red-500\">Stop-Loss:</span> Se vende si baja a ${(100000 * (1 - parseFloat(config?.stopLossPercent || \"5\") / 100)).toLocaleString()}\n                  <br />‚Ä¢ <span className=\"text-green-500\">Take-Profit:</span> Se vende si sube a ${(100000 * (1 + parseFloat(config?.takeProfitPercent || \"7\") / 100)).toLocaleString()}\n                  {config?.trailingStopEnabled && (\n                    <>\n                      <br />‚Ä¢ <span className=\"text-cyan-500\">Trailing Stop:</span> Si sube a $105,000 y luego cae {config?.trailingStopPercent}%, se vende a ${(105000 * (1 - parseFloat(config?.trailingStopPercent || \"2\") / 100)).toLocaleString()}\n                    </>\n                  )}\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"glass-panel border-border/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Wallet className=\"h-5 w-5 text-primary\" />\n                Tama√±o de Trade\n              </CardTitle>\n              <CardDescription>Define qu√© porcentaje del balance se usa en cada operaci√≥n</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"space-y-3 md:space-y-4\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"flex items-center gap-2 text-sm\">\n                    <div className=\"w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-blue-500\" />\n                    Riesgo por Trade\n                  </Label>\n                  <span className=\"font-mono text-lg text-blue-500\">{parseFloat(config?.riskPerTradePct || \"15\").toFixed(0)}%</span>\n                </div>\n                <Slider\n                  value={[parseFloat(config?.riskPerTradePct || \"15\")]}\n                  onValueChange={(value) => updateMutation.mutate({ riskPerTradePct: value[0].toString() } as any)}\n                  min={5}\n                  max={100}\n                  step={5}\n                  className=\"[&>span]:bg-blue-500\"\n                  data-testid=\"slider-risk-per-trade\"\n                />\n                <p className=\"text-xs text-muted-foreground\">Porcentaje del balance USD que se usar√° en cada operaci√≥n de compra.</p>\n              </div>\n\n              <div className=\"bg-muted/30 rounded-lg p-4 mt-4\">\n                <h4 className=\"font-medium text-sm mb-2\">Ejemplo con balance de $100:</h4>\n                <p className=\"text-xs text-muted-foreground\">\n                  ‚Ä¢ <span className=\"text-blue-500\">Tama√±o del trade:</span> ${parseFloat(config?.riskPerTradePct || \"15\")} por operaci√≥n\n                  <br />‚Ä¢ Si el m√≠nimo de Kraken es mayor, se ajustar√° autom√°ticamente.\n                  <br />‚Ä¢ Los l√≠mites de exposici√≥n se verifican antes de ejecutar.\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"glass-panel border-border/50\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <PieChart className=\"h-5 w-5 text-primary\" />\n                Control de Exposici√≥n\n              </CardTitle>\n              <CardDescription>Limita cu√°nto capital puede estar comprometido en posiciones abiertas</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6\">\n                <div className=\"space-y-3 md:space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label className=\"flex items-center gap-2 text-sm\">\n                      <div className=\"w-2.5 h-2.5 md:w-3 md:h-3 rounded-full bg-orange-500\" />\n                      M√°x. Exposici√≥n por Par\n                    </Label>\n                    <span className=\"font-mono text-lg text-orange-500\">{parseFloat(config?.maxPairExposurePct || \"25\").toFixed(0)}%</span>\n                  </div>\n                  <Slider\n                    value={[parseFloat(config?.maxPairExposurePct || \"25\")]}\n                    onValueChange={(value) => updateMutation.mutate({ maxPairExposurePct: value[0].toString() } as any)}\n                    min={5}\n                    max={100}\n                    step={5}\n                    className=\"[&>span]:bg-orange-500\"\n                    data-testid=\"slider-max-pair-exposure\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">M√°ximo % del balance que puede estar en un solo par (ej: solo BTC/USD).</p>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded-full bg-purple-500\" />\n                      M√°x. Exposici√≥n Total\n                    </Label>\n                    <span className=\"font-mono text-lg text-purple-500\">{parseFloat(config?.maxTotalExposurePct || \"60\").toFixed(0)}%</span>\n                  </div>\n                  <Slider\n                    value={[parseFloat(config?.maxTotalExposurePct || \"60\")]}\n                    onValueChange={(value) => updateMutation.mutate({ maxTotalExposurePct: value[0].toString() } as any)}\n                    min={10}\n                    max={100}\n                    step={5}\n                    className=\"[&>span]:bg-purple-500\"\n                    data-testid=\"slider-max-total-exposure\"\n                  />\n                  <p className=\"text-xs text-muted-foreground\">M√°ximo % del balance que puede estar en todas las posiciones abiertas.</p>\n                </div>\n              </div>\n\n              <div className=\"bg-muted/30 rounded-lg p-4 mt-4\">\n                <h4 className=\"font-medium text-sm mb-2\">Ejemplo con balance de $100:</h4>\n                <p className=\"text-xs text-muted-foreground\">\n                  ‚Ä¢ <span className=\"text-orange-500\">Por par:</span> M√°ximo ${parseFloat(config?.maxPairExposurePct || \"25\")} en cada par individual\n                  <br />‚Ä¢ <span className=\"text-purple-500\">Total:</span> M√°ximo ${parseFloat(config?.maxTotalExposurePct || \"60\")} en todas las posiciones combinadas\n                  <br />‚Ä¢ Si se alcanza alg√∫n l√≠mite, el bot NO abrir√° nuevas posiciones y te notificar√°.\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </main>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":25386,"size_tokens":null},"scripts/deploy-to-nas.md":{"content":"# Gu√≠a de Despliegue a QNAP NAS\n\n## M√©todo 1: Actualizaci√≥n R√°pida (Recomendado)\n\n### Paso 1: Descargar el proyecto actualizado\n\nEn Replit, descarga el proyecto como ZIP:\n1. Haz clic en los tres puntos (...) en la barra lateral\n2. Selecciona \"Download as zip\"\n\n### Paso 2: Subir al NAS\n\n1. Abre File Station en tu QNAP\n2. Navega a: `/share/ZFS37_DATA/share/Container/krakenbot`\n3. Crea una carpeta de backup: `krakenbot_backup_FECHA`\n4. Copia los archivos actuales a la carpeta de backup\n5. Extrae el ZIP descargado y reemplaza los archivos (excepto `.env`)\n\n### Paso 3: Reconstruir y reiniciar\n\nConecta por SSH a tu NAS y ejecuta:\n\n```bash\ncd /share/ZFS37_DATA/share/Container/krakenbot\n\n# Detener el contenedor actual\ndocker-compose down\n\n# Reconstruir la imagen con los nuevos cambios\ndocker-compose build --no-cache\n\n# Iniciar de nuevo\ndocker-compose up -d\n\n# Ver logs para confirmar que funciona\ndocker logs -f krakenbot\n```\n\n---\n\n## M√©todo 2: Git (Automatizado)\n\nSi configuraste Git en el NAS:\n\n```bash\ncd /share/ZFS37_DATA/share/Container/krakenbot\n\n# Guardar cambios locales\ngit stash\n\n# Obtener actualizaciones\ngit pull origin main\n\n# Restaurar cambios locales\ngit stash pop\n\n# Reconstruir y reiniciar\ndocker-compose down\ndocker-compose build --no-cache\ndocker-compose up -d\n```\n\n---\n\n## M√©todo 3: Script Autom√°tico\n\n1. Copia el archivo `scripts/update-nas.sh` a tu NAS\n2. Dale permisos de ejecuci√≥n: `chmod +x update-nas.sh`\n3. Ejecuta: `./update-nas.sh`\n\n---\n\n## Archivos que NO debes sobreescribir\n\n- `.env` - Contiene la configuraci√≥n de base de datos\n- `data/` - Si tienes datos persistentes fuera de PostgreSQL\n\n## Verificaci√≥n post-actualizaci√≥n\n\n1. Abre http://192.168.1.104:3000\n2. Verifica que Kraken est√° conectado (indicador verde)\n3. Verifica que Telegram est√° conectado (indicador verde)\n4. Revisa que las pesta√±as PANEL, ESTRATEGIAS, HISTORIAL, CARTERA y AJUSTES funcionan\n\n## Soluci√≥n de problemas\n\n### El contenedor no inicia\n```bash\ndocker logs krakenbot\n```\n\n### Error de base de datos\n```bash\ndocker-compose down\ndocker volume rm krakenbot_postgres_data\ndocker-compose up -d\n```\n(Nota: Esto borrar√° todos los datos de la base de datos)\n\n### Restaurar backup\n```bash\ndocker-compose down\ncp -r /share/ZFS37_DATA/share/Container/krakenbot_backups/BACKUP_NAME/* .\ndocker-compose up -d\n```\n","path":null,"size_bytes":2330,"size_tokens":null},"replit.md":{"content":"# KrakenBot - Autonomous Trading Bot\n\n## Overview\nKrakenBot is an autonomous cryptocurrency trading bot for the Kraken exchange. It features a web-based dashboard for monitoring, portfolio management (BTC, ETH, SOL, USD), and real-time Telegram notifications. Designed for 24/7 operation, it can be deployed on Replit or self-hosted via Docker. Its core purpose is to automate trading decisions based on predefined strategies and robust risk management, aiming to capitalize on market movements while protecting capital.\n\n## User Preferences\n- Preferred communication style: Simple, everyday language.\n- **Entornos**: NAS es la fuente de verdad (producci√≥n y dataset IA). Replit solo para desarrollo y pruebas.\n- **Sincronizaci√≥n**: No implementar export/import ni DB remota entre NAS y Replit.\n\n## System Architecture\n\n### Frontend\n- **Framework**: React with TypeScript.\n- **Styling**: Tailwind CSS, utilizing shadcn/ui components (New York style).\n- **State Management**: TanStack React Query for server-side state.\n- **Build**: Vite.\n- **Real-time Events**: WebSocket-based event streaming and terminal logs to the Monitor page.\n\n### Backend\n- **Framework**: Express.js with TypeScript.\n- **Runtime**: Node.js.\n- **API**: RESTful endpoints (`/api/*`).\n- **Services**: KrakenService for exchange interaction, TelegramService for notifications, AiService for ML filter.\n\n### Data Storage\n- **Database**: PostgreSQL with Drizzle ORM.\n- **Schema**: Defined in `shared/schema.ts`.\n- **Key Tables**: `bot_config`, `api_config`, `trades`, `notifications`, `open_positions`, `training_trades`, `ai_config`.\n\n### Trading Engine\n- **Core Loop**: Executes every 10-30 seconds for balance checks, resets, stop-loss/take-profit, and strategy analysis.\n- **Strategies**: Momentum, Mean Reversion, Scalping, Grid Trading.\n- **Multi-Timeframe Analysis (MTF)**: Analyzes 5-min, 1-hour, and 4-hour trends.\n- **Trade Execution**: Market orders, database logging, position updates, Telegram notifications.\n- **Position Modes**: SINGLE (one position per pair), DCA (multiple entries), and SMART_GUARD (intelligent capital protection).\n\n### Risk Management\n- **Filters**: Commission profitability, exposure control (per pair, total, per trade), bid-ask spread, trading hours.\n- **Dynamic Adjustments**: Dynamic position sizing based on signal confidence.\n- **Loss Control**: Stop-Loss/Take-Profit, Trailing Stop, Daily Loss Limit, Cooldown System.\n- **Kraken Compliance**: Adherence to Kraken minimum trade volumes and real balance verification.\n- **Position Persistence**: Open positions are stored in the database.\n- **Configuration Snapshot**: New positions store a snapshot of trading parameters at entry.\n\n### SMART_GUARD Mode\n- **Purpose**: Intelligent capital protection with strict entry validation.\n- **Sizing v2 (Auto Fallback)**:\n  - `sgMinEntryUsd` es un \"objetivo preferido\", no un bloqueo.\n  - Si `availableUsd >= sgMinEntryUsd` ‚Üí orden = `sgMinEntryUsd` exacto (no m√°s).\n  - Si `availableUsd < sgMinEntryUsd` ‚Üí orden = saldo disponible (fallback autom√°tico).\n  - `floorUsd = max(minOrderExchangeUsd, $20)` ‚Üí m√≠nimo absoluto (hard block).\n  - Si `availableUsd < floorUsd` ‚Üí trade bloqueado.\n  - **Fee Cushion**: Si `sgFeeCushionPct` o `sgFeeCushionAuto` activo, resta reserva para fees antes de sizing.\n  - **sgAllowUnderMin DEPRECATED**: Ya no afecta el comportamiento (siempre fallback autom√°tico).\n- **Reason Codes**:\n  - `SMART_GUARD_ENTRY_USING_CONFIG_MIN`: Saldo suficiente, usa sgMinEntryUsd.\n  - `SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE`: Saldo insuficiente, usa saldo disponible.\n  - `SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN`: Saldo < floorUsd (hard block).\n  - `SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION`: Fee cushion reduce saldo por debajo de floorUsd.\n- **Break-Even Protection**: Moves stop-loss to entry price + fees when profit reaches sgBeAtPct.\n- **Trailing Stop**: Activates at sgTrailStartPct profit, follows at sgTrailDistancePct, updates at sgTrailStepPct steps.\n- **Fixed Take-Profit**: Optional sgTpFixedPct for guaranteed profit capture.\n- **Scale-Out**: Optional partial profit taking at sgScaleOutPct before fixed TP.\n- **Per-Pair Overrides**: sgPairOverrides allows customizing parameters per trading pair via API and UI.\n- **Diagnostic Endpoint**: GET /api/scan/diagnostic provides scan results with Spanish reasons.\n- **Test Endpoint**: POST /api/test/sg-sizing para simular sizing v2 (solo en dev/dryRun).\n- **Telegram Alerts**: Notifications for key events (Break-Even activation, Trailing Stop activation/updates, Scale-Out execution) with 5-min throttle on trailing updates.\n- **Override API**: GET/PUT/DELETE /api/config/sg-overrides/:pair for managing per-pair parameters.\n- **Event Types**: SG_BREAK_EVEN_ACTIVATED, SG_TRAILING_ACTIVATED, SG_TRAILING_STOP_UPDATED, SG_SCALE_OUT_EXECUTED, CONFIG_OVERRIDE_UPDATED.\n\n### Environment Safety\n- **DRY_RUN Mode**: Prevents real orders from being sent to exchange.\n- **Auto-Detection**: Replit environment (REPLIT_DEPLOYMENT, REPL_ID) forces DRY_RUN automatically.\n- **NAS Control**: On NAS, dryRunMode can be toggled via bot_config.\n- **Simulation**: In DRY_RUN, executeTrade() logs events and sends \"[DRY_RUN] Trade Simulado\" Telegram messages without touching Kraken.\n- **Production Safety**: NAS is the source of truth for production trading; Replit is development/testing only.\n\n### FIFO Position Matching\n- **Purpose**: Automatic position closing with partial fills tracking to eliminate \"phantom positions.\"\n- **Tables**:\n  - `trade_fills`: Individual fills with UNIQUE(txid), matched flag for idempotency.\n  - `lot_matches`: FIFO matching audit trail with UNIQUE(sellFillTxid, lotId).\n  - `open_positions.qtyRemaining/qtyFilled`: Track partial consumption of buy lots.\n- **FIFO Logic**:\n  - Sell fills match against oldest buy lots first (ORDER BY openedAt ASC).\n  - Uses SELECT FOR UPDATE within transaction to prevent concurrent double-consumption.\n  - Pro-rates buy/sell fees based on matched quantity for accurate P&L.\n- **Orphan Handling**: \n  - Fills only marked `matched=true` when fully processed (sellRemaining ‚âà 0).\n  - Orphan fills (no matching lots) remain unmatched for future retry.\n- **API Endpoints**:\n  - `POST /api/fifo/init-lots`: Initialize qtyRemaining = amount for existing lots.\n  - `POST /api/fifo/process-sells`: Process all unmatched sell fills.\n  - `POST /api/fifo/ingest-fill`: Ingest a new fill and trigger FIFO matching.\n  - `GET /api/fifo/open-lots`: Get lots with qtyRemaining > 0.\n- **Auto-Integration**: After each real sell execution in `executeTrade()`, the trading engine automatically:\n  1. Creates a TradeFill record with txid, pair, price, amount, and estimated fee\n  2. Triggers `fifoMatcher.processSellFill()` to match against open buy lots\n  3. Logs matching results (lots closed, P&L, orphan qty)\n  4. Only runs for real trades (DRY_RUN mode is safely bypassed with triple guard)\n- **Transaction Safety**: All operations (lot select, match insert, qty update, fill mark) run within same tx handle.\n\n### AI Filter Module\n- **Purpose**: Machine learning filter to approve/reject trade signals based on historical performance.\n- **Phases**: Red (data collection), Yellow (ready to train), Green (filter active).\n- **Training Data**: `training_trades` table stores BUY/SELL pairs with PnL labels. Backfill reconstructs data.\n- **Discard Reasons**: Excludes invalid or anomalous trades from training data.\n- **Diagnostic Metrics**: Provides aggregated counts of discard reasons and open trades/lots.\n\n### Telegram Integration\n- **Functionality**: Sends notifications for bot status, trade executions, risk management triggers, and errors.\n- **Commands (Docker/NAS)**: Supports commands like `/estado`, `/pausar`, `/reanudar`.\n- **Modes**: Polling for Docker/NAS deployments (commands), disabled for Replit (notifications only).\n- **Features**: Rate limiting to prevent spam and multi-chat support.\n\n## External Dependencies\n\n- **Kraken Exchange API**:\n    - **Package**: `node-kraken-api`.\n    - **Purpose**: Trading operations (execute, fetch balances, market data).\n    - **Configuration**: API key/secret stored in `api_config` table.\n\n- **Telegram Bot API**:\n    - **Package**: `node-telegram-bot-api`.\n    - **Purpose**: Send notifications and receive commands.\n    - **Configuration**: Bot token and chat ID stored in `api_config` table.\n\n- **PostgreSQL Database**:\n    - **ORM**: Drizzle ORM.\n    - **Connection**: Via `DATABASE_URL` environment variable.\n    - **Driver**: `pg`.","path":null,"size_bytes":8519,"size_tokens":null},"server/services/tradingEngine.ts":{"content":"import { KrakenService } from \"./kraken\";\nimport { TelegramService } from \"./telegram\";\nimport { botLogger } from \"./botLogger\";\nimport { storage } from \"../storage\";\nimport { log } from \"../index\";\nimport { aiService, AiFeatures } from \"./aiService\";\nimport { environment } from \"./environment\";\nimport { fifoMatcher } from \"./fifoMatcher\";\n\ninterface PriceData {\n  price: number;\n  timestamp: number;\n  high: number;\n  low: number;\n  volume: number;\n}\n\ninterface TradeSignal {\n  action: \"buy\" | \"sell\" | \"hold\";\n  pair: string;\n  confidence: number;\n  reason: string;\n}\n\ninterface RiskConfig {\n  maxTradeUSD: number;\n}\n\nconst RISK_LEVELS: Record<string, RiskConfig> = {\n  low: {\n    maxTradeUSD: 20,\n  },\n  medium: {\n    maxTradeUSD: 50,\n  },\n  high: {\n    maxTradeUSD: 100,\n  },\n};\n\nconst DUST_THRESHOLD_USD = 5; // Minimum USD value to attempt selling\n\nconst SMALL_ACCOUNT_FACTOR = 0.95;\n\n// Kraken fee structure (taker fees for market orders)\nconst KRAKEN_FEE_PCT = 0.26; // 0.26% per trade\nconst ROUND_TRIP_FEE_PCT = KRAKEN_FEE_PCT * 2; // ~0.52% for buy + sell\nconst MIN_PROFIT_MULTIPLIER = 2; // Take-profit debe ser al menos 2x las fees\n\n// Defensive improvements\nconst MAX_SPREAD_PCT = 0.5; // No comprar si spread > 0.5%\nconst TRADING_HOURS_START = 8; // UTC - inicio de horario de trading\nconst TRADING_HOURS_END = 22; // UTC - fin de horario de trading\nconst POST_STOPLOSS_COOLDOWN_MS = 30 * 60 * 1000; // 30 min cooldown tras stop-loss\nconst CONFIDENCE_SIZING_THRESHOLDS = {\n  high: { min: 0.8, factor: 1.0 },    // 100% del monto\n  medium: { min: 0.7, factor: 0.75 }, // 75% del monto\n  low: { min: 0.6, factor: 0.5 },     // 50% del monto\n};\n\n// SMART_GUARD: umbral absoluto m√≠nimo para evitar comisiones absurdas\nconst SG_ABSOLUTE_MIN_USD = 20;\n\n// === VALIDACI√ìN CENTRALIZADA DE M√çNIMOS (fuente √∫nica de verdad) ===\n// Reason codes para SMART_GUARD sizing\ntype SmartGuardReasonCode = \n  | \"SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN\"   // saldo < floorUsd (hard block)\n  | \"SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION\"    // availableAfterCushion < floorUsd\n  | \"SMART_GUARD_ENTRY_USING_CONFIG_MIN\"       // saldo >= sgMinEntryUsd, usando sgMinEntryUsd\n  | \"SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE\"; // saldo < sgMinEntryUsd, usando saldo disponible\n\ninterface MinimumValidationParams {\n  positionMode: string;\n  orderUsdFinal: number;\n  orderUsdProposed: number;\n  usdDisponible: number;\n  exposureAvailable: number;\n  pair: string;\n  sgMinEntryUsd?: number;\n  sgAllowUnderMin?: boolean; // DEPRECATED - se ignora (siempre auto fallback)\n  dryRun?: boolean;\n  env?: string;\n  floorUsd?: number;\n  availableAfterCushion?: number;\n}\n\ninterface MinimumValidationResult {\n  valid: boolean;\n  skipReason?: SmartGuardReasonCode | \"MIN_ORDER_ABSOLUTE\" | \"MIN_ORDER_USD\";\n  reasonCode?: SmartGuardReasonCode;\n  message?: string;\n  meta?: Record<string, any>;\n}\n\nfunction validateMinimumsOrSkip(params: MinimumValidationParams): MinimumValidationResult {\n  const {\n    positionMode,\n    orderUsdFinal,\n    orderUsdProposed,\n    usdDisponible,\n    exposureAvailable,\n    pair,\n    sgMinEntryUsd = 100,\n    sgAllowUnderMin = true, // DEPRECATED - ignorado\n    dryRun = false,\n    env = \"UNKNOWN\",\n    floorUsd,\n    availableAfterCushion,\n  } = params;\n\n  const effectiveFloor = floorUsd ?? SG_ABSOLUTE_MIN_USD;\n\n  const meta = {\n    pair,\n    usdDisponible,\n    orderUsdProposed,\n    orderUsdFinal,\n    sgMinEntryUsd,\n    sgAllowUnderMin_DEPRECATED: sgAllowUnderMin,\n    exposureAvailable,\n    env,\n    dryRun,\n    absoluteMinUsd: SG_ABSOLUTE_MIN_USD,\n    floorUsd: effectiveFloor,\n    availableAfterCushion,\n  };\n\n  // REGLA 1: Hard block - si orderUsdFinal < floorUsd (exchange min + absoluto)\n  if (orderUsdFinal < effectiveFloor) {\n    return {\n      valid: false,\n      skipReason: \"SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN\",\n      reasonCode: \"SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN\",\n      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < floorUsd $${effectiveFloor.toFixed(2)} (m√≠n exchange + absoluto)`,\n      meta,\n    };\n  }\n\n  // REGLA 2: Hard block - si availableAfterCushion < floorUsd (fee cushion applied)\n  if (availableAfterCushion !== undefined && availableAfterCushion < effectiveFloor) {\n    return {\n      valid: false,\n      skipReason: \"SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION\",\n      reasonCode: \"SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION\",\n      message: `Trade bloqueado: availableAfterCushion $${availableAfterCushion.toFixed(2)} < floorUsd $${effectiveFloor.toFixed(2)}`,\n      meta,\n    };\n  }\n\n  // Fallback para modos no-SMART_GUARD\n  if (orderUsdFinal < SG_ABSOLUTE_MIN_USD) {\n    return {\n      valid: false,\n      skipReason: \"MIN_ORDER_ABSOLUTE\",\n      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < m√≠nimo absoluto $${SG_ABSOLUTE_MIN_USD}`,\n      meta,\n    };\n  }\n\n  return { valid: true };\n}\n\ninterface ConfigSnapshot {\n  stopLossPercent: number;\n  takeProfitPercent: number;\n  trailingStopEnabled: boolean;\n  trailingStopPercent: number;\n  positionMode: string;\n  // SMART_GUARD specific fields (only populated when positionMode === \"SMART_GUARD\")\n  sgMinEntryUsd?: number;\n  sgAllowUnderMin?: boolean;\n  sgBeAtPct?: number;\n  sgFeeCushionPct?: number;\n  sgFeeCushionAuto?: boolean;\n  sgTrailStartPct?: number;\n  sgTrailDistancePct?: number;\n  sgTrailStepPct?: number;\n  sgTpFixedEnabled?: boolean;\n  sgTpFixedPct?: number;\n  sgScaleOutEnabled?: boolean;\n  sgScaleOutPct?: number;\n  sgMinPartUsd?: number;\n  sgScaleOutThreshold?: number;\n}\n\ninterface OpenPosition {\n  lotId: string; // Unique identifier for this lot (multi-lot support)\n  pair: string; // Pair for this position\n  amount: number;\n  entryPrice: number;\n  highestPrice: number;\n  openedAt: number;\n  entryStrategyId: string;\n  entrySignalTf: string;\n  signalConfidence?: number;\n  signalReason?: string;\n  aiSampleId?: number;\n  entryMode?: string;\n  configSnapshot?: ConfigSnapshot;\n  // SMART_GUARD dynamic state\n  sgBreakEvenActivated?: boolean;\n  sgCurrentStopPrice?: number;\n  sgTrailingActivated?: boolean;\n  sgScaleOutDone?: boolean;\n}\n\nfunction generateLotId(pair: string): string {\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 8);\n  return `LOT-${pair.replace(\"/\", \"\")}-${timestamp}-${random}`;\n}\n\ninterface CandleTrackingState {\n  lastEvaluatedCandleTs: number;\n  lastEvaluatedPair: string;\n}\n\ninterface OHLCCandle {\n  time: number;\n  open: number;\n  high: number;\n  low: number;\n  close: number;\n  volume: number;\n}\n\ninterface MultiTimeframeData {\n  tf5m: OHLCCandle[];\n  tf1h: OHLCCandle[];\n  tf4h: OHLCCandle[];\n  lastUpdate: number;\n}\n\ninterface TrendAnalysis {\n  shortTerm: \"bullish\" | \"bearish\" | \"neutral\";\n  mediumTerm: \"bullish\" | \"bearish\" | \"neutral\";\n  longTerm: \"bullish\" | \"bearish\" | \"neutral\";\n  alignment: number;\n  confidence: number;\n  summary: string;\n}\n\nexport class TradingEngine {\n  private krakenService: KrakenService;\n  private telegramService: TelegramService;\n  private isRunning: boolean = false;\n  private intervalId: NodeJS.Timeout | null = null;\n  private priceHistory: Map<string, PriceData[]> = new Map();\n  private lastTradeTime: Map<string, number> = new Map();\n  private openPositions: Map<string, OpenPosition> = new Map(); // Key is lotId for multi-lot support\n  private currentUsdBalance: number = 0;\n  private mtfCache: Map<string, MultiTimeframeData> = new Map();\n  private readonly PRICE_HISTORY_LENGTH = 50;\n  private readonly MIN_TRADE_INTERVAL_MS = 60000;\n  private readonly MTF_CACHE_TTL = 300000;\n  \n  private dailyPnL: number = 0;\n  private dailyStartBalance: number = 0;\n  private lastDayReset: string = \"\";\n  private isDailyLimitReached: boolean = false;\n  \n  private pairCooldowns: Map<string, number> = new Map();\n  private lastExposureAlert: Map<string, number> = new Map();\n  private stopLossCooldowns: Map<string, number> = new Map();\n  private spreadFilterEnabled: boolean = true;\n  private readonly COOLDOWN_DURATION_MS = 15 * 60 * 1000;\n  private readonly EXPOSURE_ALERT_INTERVAL_MS = 30 * 60 * 1000;\n  \n  // Tracking para Momentum (Velas) - √∫ltima vela evaluada por par+timeframe\n  private lastEvaluatedCandle: Map<string, number> = new Map();\n  \n  // Fallback minimums (only used if Kraken API fails)\n  private readonly FALLBACK_MINIMUMS: Record<string, number> = {\n    \"BTC/USD\": 0.0001,\n    \"ETH/USD\": 0.01,\n    \"SOL/USD\": 0.02,\n    \"XRP/USD\": 1.65,\n    \"TON/USD\": 1,\n    \"ETH/BTC\": 0.01,\n  };\n\n  private normalizeVolume(pair: string, volume: number): number {\n    const stepSize = this.krakenService.getStepSize(pair);\n    if (stepSize === null) {\n      log(`[WARNING] No step size for ${pair}, using 8 decimal fallback`, \"trading\");\n      const fallbackDecimals = 8;\n      return Math.floor(volume * Math.pow(10, fallbackDecimals)) / Math.pow(10, fallbackDecimals);\n    }\n    const decimals = Math.abs(Math.log10(stepSize));\n    return Math.floor(volume * Math.pow(10, decimals)) / Math.pow(10, decimals);\n  }\n\n  private getOrderMin(pair: string): number {\n    const orderMin = this.krakenService.getOrderMin(pair);\n    if (orderMin === null) {\n      log(`[WARNING] No orderMin for ${pair}, using fallback`, \"trading\");\n      return this.FALLBACK_MINIMUMS[pair] || 0.01;\n    }\n    return orderMin;\n  }\n\n  private hasPairMetadata(pair: string): boolean {\n    return this.krakenService.hasMetadata(pair);\n  }\n  \n  // Timeframe en segundos para calcular cierre de vela\n  private readonly TIMEFRAME_SECONDS: Record<string, number> = {\n    \"5m\": 5 * 60,\n    \"15m\": 15 * 60,\n    \"1h\": 60 * 60,\n  };\n\n  // Engine tick tracking (heartbeat cada 60s)\n  private tickIntervalId: NodeJS.Timeout | null = null;\n  private lastTickTime: number = 0;\n  private lastScanTime: number = 0;\n  private readonly TICK_INTERVAL_MS = 60 * 1000; // 60 seconds\n  private lastScanResults: Map<string, { signal: string; reason: string; cooldownSec?: number; exposureAvailable?: number }> = new Map();\n  \n  // SMART_GUARD alert throttle: key = \"lotId:eventType\", value = timestamp\n  private sgAlertThrottle: Map<string, number> = new Map();\n  private readonly SG_TRAIL_UPDATE_THROTTLE_MS = 5 * 60 * 1000; // 5 minutes between trailing stop updates\n  \n  // DRY_RUN mode: audit without sending real orders\n  private dryRunMode: boolean = false;\n  private readonly isReplitEnvironment: boolean = !!process.env.REPLIT_DEPLOYMENT || !!process.env.REPL_ID;\n\n  constructor(krakenService: KrakenService, telegramService: TelegramService) {\n    this.krakenService = krakenService;\n    this.telegramService = telegramService;\n    \n    // Auto-enable dry run on Replit to prevent accidental real trades\n    if (this.isReplitEnvironment) {\n      this.dryRunMode = true;\n      log(\"[SAFETY] Entorno Replit detectado - DRY_RUN activado autom√°ticamente\", \"trading\");\n    }\n  }\n\n  // === MULTI-LOT HELPERS ===\n  private getPositionsByPair(pair: string): OpenPosition[] {\n    const positions: OpenPosition[] = [];\n    this.openPositions.forEach((position) => {\n      if (position.pair === pair) {\n        positions.push(position);\n      }\n    });\n    return positions;\n  }\n\n  private getFirstPositionByPair(pair: string): OpenPosition | undefined {\n    for (const position of this.openPositions.values()) {\n      if (position.pair === pair) {\n        return position;\n      }\n    }\n    return undefined;\n  }\n\n  private countLotsForPair(pair: string): number {\n    let count = 0;\n    this.openPositions.forEach((position) => {\n      if (position.pair === pair) {\n        count++;\n      }\n    });\n    return count;\n  }\n\n  // === SMART_GUARD ALERT HELPERS ===\n  private shouldSendSgAlert(lotId: string, eventType: string, throttleMs?: number): boolean {\n    const key = `${lotId}:${eventType}`;\n    const lastAlert = this.sgAlertThrottle.get(key);\n    const now = Date.now();\n    const cooldown = throttleMs ?? 0;\n    \n    if (lastAlert && now - lastAlert < cooldown) {\n      return false;\n    }\n    this.sgAlertThrottle.set(key, now);\n    return true;\n  }\n\n  private async sendSgEventAlert(\n    eventType: \"SG_BREAK_EVEN_ACTIVATED\" | \"SG_TRAILING_ACTIVATED\" | \"SG_TRAILING_STOP_UPDATED\" | \"SG_SCALE_OUT_EXECUTED\",\n    position: OpenPosition,\n    currentPrice: number,\n    extra: { stopPrice?: number; profitPct: number; reason: string }\n  ) {\n    const { lotId, pair, entryPrice } = position;\n    const shortLotId = lotId.substring(0, 12);\n    const envPrefix = environment.getMessagePrefix(this.dryRunMode);\n    const envInfo = environment.getInfo();\n\n    // Emit event for /api/events\n    await botLogger.info(eventType, `${eventType} en ${pair}`, {\n      pair,\n      lotId,\n      entryPrice,\n      currentPrice,\n      stopPrice: extra.stopPrice,\n      profitPct: extra.profitPct,\n      env: envInfo.env,\n      instanceId: envInfo.instanceId,\n      reason: extra.reason,\n    });\n\n    // Send Telegram notification\n    if (this.telegramService.isInitialized()) {\n      let emoji = \"\";\n      let title = \"\";\n      \n      switch (eventType) {\n        case \"SG_BREAK_EVEN_ACTIVATED\":\n          emoji = \"‚öñÔ∏è\";\n          title = \"Break-Even Activado\";\n          break;\n        case \"SG_TRAILING_ACTIVATED\":\n          emoji = \"üìà\";\n          title = \"Trailing Stop Activado\";\n          break;\n        case \"SG_TRAILING_STOP_UPDATED\":\n          emoji = \"üîº\";\n          title = \"Stop Actualizado\";\n          break;\n        case \"SG_SCALE_OUT_EXECUTED\":\n          emoji = \"üìä\";\n          title = \"Scale-Out Ejecutado\";\n          break;\n      }\n\n      const message = `\n${emoji} *${envPrefix}${title}*\n\n*Par:* ${pair}\n*Lote:* \\`${shortLotId}\\`\n*Entry:* $${entryPrice.toFixed(2)}\n*Actual:* $${currentPrice.toFixed(2)}\n*Profit:* ${extra.profitPct >= 0 ? '+' : ''}${extra.profitPct.toFixed(2)}%\n${extra.stopPrice ? `*Nuevo Stop:* $${extra.stopPrice.toFixed(4)}` : ''}\n\n_${extra.reason}_\n      `.trim();\n\n      await this.telegramService.sendAlertToMultipleChats(message, \"status\");\n    }\n  }\n\n  private getUniquePairs(): string[] {\n    const pairs = new Set<string>();\n    this.openPositions.forEach((position) => {\n      pairs.add(position.pair);\n    });\n    return Array.from(pairs);\n  }\n\n  private calculatePairExposure(pair: string): number {\n    let total = 0;\n    this.openPositions.forEach((position) => {\n      if (position.pair === pair) {\n        total += position.amount * position.entryPrice;\n      }\n    });\n    return total;\n  }\n\n  private calculateTotalExposure(): number {\n    let total = 0;\n    this.openPositions.forEach((position) => {\n      total += position.amount * position.entryPrice;\n    });\n    return total;\n  }\n\n  private getAvailableExposure(pair: string, config: any, freshUsdBalance?: number): { \n    maxPairAvailable: number; \n    maxTotalAvailable: number; \n    maxAllowed: number;\n  } {\n    const maxPairExposurePct = parseFloat(config.maxPairExposurePct?.toString() || \"25\");\n    const maxTotalExposurePct = parseFloat(config.maxTotalExposurePct?.toString() || \"60\");\n\n    const currentPairExposure = this.calculatePairExposure(pair);\n    const currentTotalExposure = this.calculateTotalExposure();\n\n    const usdBalance = freshUsdBalance ?? this.currentUsdBalance;\n    const maxPairExposureUsd = usdBalance * (maxPairExposurePct / 100);\n    const maxTotalExposureUsd = usdBalance * (maxTotalExposurePct / 100);\n\n    const maxPairAvailable = Math.max(0, maxPairExposureUsd - currentPairExposure);\n    const maxTotalAvailable = Math.max(0, maxTotalExposureUsd - currentTotalExposure);\n    \n    return {\n      maxPairAvailable,\n      maxTotalAvailable,\n      maxAllowed: Math.min(maxPairAvailable, maxTotalAvailable)\n    };\n  }\n\n  // === SMART_GUARD: Obtener par√°metros con overrides por par ===\n  private getSmartGuardParams(pair: string, config: any): {\n    sgMinEntryUsd: number;\n    sgAllowUnderMin: boolean;\n    sgBeAtPct: number;\n    sgFeeCushionPct: number;\n    sgFeeCushionAuto: boolean;\n    sgTrailStartPct: number;\n    sgTrailDistancePct: number;\n    sgTrailStepPct: number;\n    sgTpFixedEnabled: boolean;\n    sgTpFixedPct: number;\n    sgScaleOutEnabled: boolean;\n    sgScaleOutPct: number;\n    sgMinPartUsd: number;\n    sgScaleOutThreshold: number;\n  } {\n    // Valores base de config global\n    const base = {\n      sgMinEntryUsd: parseFloat(config?.sgMinEntryUsd?.toString() || \"100\"),\n      sgAllowUnderMin: config?.sgAllowUnderMin ?? true,\n      sgBeAtPct: parseFloat(config?.sgBeAtPct?.toString() || \"1.5\"),\n      sgFeeCushionPct: parseFloat(config?.sgFeeCushionPct?.toString() || \"0.45\"),\n      sgFeeCushionAuto: config?.sgFeeCushionAuto ?? true,\n      sgTrailStartPct: parseFloat(config?.sgTrailStartPct?.toString() || \"2\"),\n      sgTrailDistancePct: parseFloat(config?.sgTrailDistancePct?.toString() || \"1.5\"),\n      sgTrailStepPct: parseFloat(config?.sgTrailStepPct?.toString() || \"0.25\"),\n      sgTpFixedEnabled: config?.sgTpFixedEnabled ?? false,\n      sgTpFixedPct: parseFloat(config?.sgTpFixedPct?.toString() || \"10\"),\n      sgScaleOutEnabled: config?.sgScaleOutEnabled ?? false,\n      sgScaleOutPct: parseFloat(config?.sgScaleOutPct?.toString() || \"35\"),\n      sgMinPartUsd: parseFloat(config?.sgMinPartUsd?.toString() || \"50\"),\n      sgScaleOutThreshold: parseFloat(config?.sgScaleOutThreshold?.toString() || \"80\"),\n    };\n\n    // Aplicar overrides por par si existen\n    const overrides = config?.sgPairOverrides?.[pair];\n    if (overrides) {\n      const merged = { ...base };\n      // Floats\n      if (overrides.sgMinEntryUsd !== undefined) merged.sgMinEntryUsd = parseFloat(overrides.sgMinEntryUsd.toString());\n      if (overrides.sgBeAtPct !== undefined) merged.sgBeAtPct = parseFloat(overrides.sgBeAtPct.toString());\n      if (overrides.sgFeeCushionPct !== undefined) merged.sgFeeCushionPct = parseFloat(overrides.sgFeeCushionPct.toString());\n      if (overrides.sgTrailStartPct !== undefined) merged.sgTrailStartPct = parseFloat(overrides.sgTrailStartPct.toString());\n      if (overrides.sgTrailDistancePct !== undefined) merged.sgTrailDistancePct = parseFloat(overrides.sgTrailDistancePct.toString());\n      if (overrides.sgTrailStepPct !== undefined) merged.sgTrailStepPct = parseFloat(overrides.sgTrailStepPct.toString());\n      if (overrides.sgTpFixedPct !== undefined) merged.sgTpFixedPct = parseFloat(overrides.sgTpFixedPct.toString());\n      if (overrides.sgMinPartUsd !== undefined) merged.sgMinPartUsd = parseFloat(overrides.sgMinPartUsd.toString());\n      if (overrides.sgScaleOutPct !== undefined) merged.sgScaleOutPct = parseFloat(overrides.sgScaleOutPct.toString());\n      if (overrides.sgScaleOutThreshold !== undefined) merged.sgScaleOutThreshold = parseFloat(overrides.sgScaleOutThreshold.toString());\n      // Booleans\n      if (overrides.sgAllowUnderMin !== undefined) merged.sgAllowUnderMin = !!overrides.sgAllowUnderMin;\n      if (overrides.sgFeeCushionAuto !== undefined) merged.sgFeeCushionAuto = !!overrides.sgFeeCushionAuto;\n      if (overrides.sgTpFixedEnabled !== undefined) merged.sgTpFixedEnabled = !!overrides.sgTpFixedEnabled;\n      if (overrides.sgScaleOutEnabled !== undefined) merged.sgScaleOutEnabled = !!overrides.sgScaleOutEnabled;\n      return merged;\n    }\n\n    return base;\n  }\n\n  private isPairInCooldown(pair: string): boolean {\n    const cooldownUntil = this.pairCooldowns.get(pair);\n    if (!cooldownUntil) return false;\n    \n    if (Date.now() >= cooldownUntil) {\n      this.pairCooldowns.delete(pair);\n      return false;\n    }\n    return true;\n  }\n\n  private setPairCooldown(pair: string): void {\n    const cooldownUntil = Date.now() + this.COOLDOWN_DURATION_MS;\n    this.pairCooldowns.set(pair, cooldownUntil);\n    log(`${pair} en cooldown por ${this.COOLDOWN_DURATION_MS / 60000} minutos`, \"trading\");\n  }\n\n  private shouldSendExposureAlert(pair: string): boolean {\n    const lastAlert = this.lastExposureAlert.get(pair) || 0;\n    if (Date.now() - lastAlert < this.EXPOSURE_ALERT_INTERVAL_MS) {\n      return false;\n    }\n    this.lastExposureAlert.set(pair, Date.now());\n    return true;\n  }\n\n  // === MEJORA 1: Filtro de Spread ===\n  private calculateSpreadPct(bid: number, ask: number): number {\n    if (bid <= 0 || ask <= 0) return 0;\n    const midPrice = (bid + ask) / 2;\n    return ((ask - bid) / midPrice) * 100;\n  }\n\n  private isSpreadAcceptable(tickerData: any): { acceptable: boolean; spreadPct: number } {\n    if (!this.spreadFilterEnabled) {\n      return { acceptable: true, spreadPct: 0 };\n    }\n    \n    const bid = parseFloat(tickerData.b?.[0] || \"0\");\n    const ask = parseFloat(tickerData.a?.[0] || \"0\");\n    const spreadPct = this.calculateSpreadPct(bid, ask);\n    \n    return {\n      acceptable: spreadPct <= MAX_SPREAD_PCT,\n      spreadPct,\n    };\n  }\n\n  // === MEJORA 2: Horarios de Trading ===\n  private isWithinTradingHours(config: any): { withinHours: boolean; hourUTC: number; start: number; end: number } {\n    const tradingHoursEnabled = config.tradingHoursEnabled ?? true;\n    const start = parseInt(config.tradingHoursStart?.toString() || \"8\");\n    const end = parseInt(config.tradingHoursEnd?.toString() || \"22\");\n    \n    if (!tradingHoursEnabled) {\n      return { withinHours: true, hourUTC: new Date().getUTCHours(), start, end };\n    }\n    \n    const now = new Date();\n    const hourUTC = now.getUTCHours();\n    \n    return { withinHours: hourUTC >= start && hourUTC < end, hourUTC, start, end };\n  }\n\n  // === MEJORA 3: Position Sizing Din√°mico ===\n  private getConfidenceSizingFactor(confidence: number): number {\n    if (confidence >= CONFIDENCE_SIZING_THRESHOLDS.high.min) {\n      return CONFIDENCE_SIZING_THRESHOLDS.high.factor;\n    } else if (confidence >= CONFIDENCE_SIZING_THRESHOLDS.medium.min) {\n      return CONFIDENCE_SIZING_THRESHOLDS.medium.factor;\n    } else if (confidence >= CONFIDENCE_SIZING_THRESHOLDS.low.min) {\n      return CONFIDENCE_SIZING_THRESHOLDS.low.factor;\n    }\n    return 0; // No trade if confidence < 0.6\n  }\n\n  // === ENGINE TICK: Heartbeat cada 60s ===\n  private async emitEngineTick(): Promise<void> {\n    if (!this.isRunning) return;\n\n    try {\n      const config = await storage.getBotConfig();\n      const now = Date.now();\n      const loopLatencyMs = this.lastScanTime > 0 ? now - this.lastScanTime : 0;\n      \n      const openPositionsPairs = Array.from(this.openPositions.keys());\n      \n      await botLogger.info(\"ENGINE_TICK\", \"Motor activo - escaneo en curso\", {\n        activePairs: config?.activePairs || [],\n        openPositionsCount: this.openPositions.size,\n        openPositionsPairs,\n        lastScanAt: this.lastScanTime > 0 ? new Date(this.lastScanTime).toISOString() : null,\n        loopLatencyMs,\n        balanceUsd: this.currentUsdBalance,\n        isDailyLimitReached: this.isDailyLimitReached,\n        dailyPnL: this.dailyPnL,\n      });\n\n      this.lastTickTime = now;\n\n      // Emitir MARKET_SCAN_SUMMARY si hay resultados\n      if (this.lastScanResults.size > 0) {\n        const scanSummary: Record<string, any> = {};\n        this.lastScanResults.forEach((result, pair) => {\n          scanSummary[pair] = result;\n        });\n\n        await botLogger.info(\"MARKET_SCAN_SUMMARY\", \"Resumen de escaneo de mercado\", {\n          pairs: scanSummary,\n          scanTime: new Date(this.lastScanTime).toISOString(),\n        });\n      }\n    } catch (error: any) {\n      log(`Error emitiendo ENGINE_TICK: ${error.message}`, \"trading\");\n    }\n  }\n\n  // Helper to get cooldown remaining seconds\n  private getCooldownRemainingSec(pair: string): number | undefined {\n    const cooldownUntil = this.pairCooldowns.get(pair);\n    if (!cooldownUntil) return undefined;\n    const remaining = Math.max(0, Math.floor((cooldownUntil - Date.now()) / 1000));\n    return remaining > 0 ? remaining : undefined;\n  }\n\n  private getStopLossCooldownRemainingSec(pair: string): number | undefined {\n    const cooldownUntil = this.stopLossCooldowns.get(pair);\n    if (!cooldownUntil) return undefined;\n    const remaining = Math.max(0, Math.floor((cooldownUntil - Date.now()) / 1000));\n    return remaining > 0 ? remaining : undefined;\n  }\n\n  // === MEJORA 4: Cooldown Post Stop-Loss ===\n  private isPairInStopLossCooldown(pair: string): boolean {\n    const cooldownUntil = this.stopLossCooldowns.get(pair);\n    if (!cooldownUntil) return false;\n    \n    if (Date.now() >= cooldownUntil) {\n      this.stopLossCooldowns.delete(pair);\n      return false;\n    }\n    return true;\n  }\n\n  private setStopLossCooldown(pair: string): void {\n    const cooldownUntil = Date.now() + POST_STOPLOSS_COOLDOWN_MS;\n    this.stopLossCooldowns.set(pair, cooldownUntil);\n    log(`${pair} en cooldown post-SL por ${POST_STOPLOSS_COOLDOWN_MS / 60000} minutos`, \"trading\");\n  }\n\n  private isProfitableAfterFees(takeProfitPct: number): { \n    isProfitable: boolean; \n    minProfitRequired: number; \n    roundTripFees: number;\n    netExpectedProfit: number;\n  } {\n    const roundTripFees = ROUND_TRIP_FEE_PCT;\n    const minProfitRequired = roundTripFees * MIN_PROFIT_MULTIPLIER;\n    const netExpectedProfit = takeProfitPct - roundTripFees;\n    \n    return {\n      isProfitable: takeProfitPct >= minProfitRequired,\n      minProfitRequired,\n      roundTripFees,\n      netExpectedProfit,\n    };\n  }\n\n  // === MOMENTUM (VELAS) - Helpers ===\n  private getTimeframeIntervalMinutes(timeframe: string): number {\n    switch (timeframe) {\n      case \"5m\": return 5;\n      case \"15m\": return 15;\n      case \"1h\": return 60;\n      default: return 5;\n    }\n  }\n\n  private async getLastClosedCandle(pair: string, timeframe: string): Promise<OHLCCandle | null> {\n    try {\n      const intervalMinutes = this.getTimeframeIntervalMinutes(timeframe);\n      const candles = await this.krakenService.getOHLC(pair, intervalMinutes);\n      if (!candles || candles.length < 2) return null;\n      return candles[candles.length - 2];\n    } catch (error: any) {\n      log(`Error obteniendo vela cerrada ${pair}/${timeframe}: ${error.message}`, \"trading\");\n      return null;\n    }\n  }\n\n  private isNewCandleClosed(pair: string, timeframe: string, candleTime: number): boolean {\n    const key = `${pair}:${timeframe}`;\n    const lastTs = this.lastEvaluatedCandle.get(key) || 0;\n    if (candleTime > lastTs) {\n      this.lastEvaluatedCandle.set(key, candleTime);\n      return true;\n    }\n    return false;\n  }\n\n  private async analyzeWithCandleStrategy(\n    pair: string,\n    timeframe: string,\n    candle: OHLCCandle\n  ): Promise<TradeSignal> {\n    const intervalMinutes = this.getTimeframeIntervalMinutes(timeframe);\n    const candles = await this.krakenService.getOHLC(pair, intervalMinutes);\n    if (!candles || candles.length < 20) {\n      return { action: \"hold\", pair, confidence: 0, reason: \"Datos insuficientes para an√°lisis de velas\" };\n    }\n    \n    const closedCandles = candles.slice(0, -1);\n    return this.momentumCandlesStrategy(pair, closedCandles, candle.close);\n  }\n\n  private momentumCandlesStrategy(pair: string, candles: OHLCCandle[], currentPrice: number): TradeSignal {\n    if (candles.length < 20) {\n      return { action: \"hold\", pair, confidence: 0, reason: \"Historial de velas insuficiente\" };\n    }\n    \n    const closes = candles.map(c => c.close);\n    const shortEMA = this.calculateEMA(closes.slice(-10), 10);\n    const longEMA = this.calculateEMA(closes.slice(-20), 20);\n    const rsi = this.calculateRSI(closes.slice(-14));\n    const macd = this.calculateMACD(closes);\n    const bollinger = this.calculateBollingerBands(closes);\n    \n    const lastCandle = candles[candles.length - 1];\n    const prevCandle = candles[candles.length - 2];\n    const isBullishCandle = lastCandle.close > lastCandle.open;\n    const isBearishCandle = lastCandle.close < lastCandle.open;\n    const candleBody = Math.abs(lastCandle.close - lastCandle.open);\n    const candleRange = lastCandle.high - lastCandle.low;\n    const bodyRatio = candleRange > 0 ? candleBody / candleRange : 0;\n    \n    const avgVolume = candles.slice(-10).reduce((sum, c) => sum + c.volume, 0) / 10;\n    const volumeRatio = avgVolume > 0 ? lastCandle.volume / avgVolume : 1;\n    const isHighVolume = volumeRatio > 1.5;\n    \n    let buySignals = 0;\n    let sellSignals = 0;\n    const reasons: string[] = [];\n\n    if (shortEMA > longEMA) buySignals++;\n    else if (shortEMA < longEMA) sellSignals++;\n\n    if (rsi < 30) { buySignals += 2; reasons.push(`RSI sobrevendido (${rsi.toFixed(0)})`); }\n    else if (rsi < 45) { buySignals++; }\n    else if (rsi > 70) { sellSignals += 2; reasons.push(`RSI sobrecomprado (${rsi.toFixed(0)})`); }\n    else if (rsi > 55) { sellSignals++; }\n\n    if (macd.histogram > 0 && macd.macd > macd.signal) { buySignals++; reasons.push(\"MACD alcista\"); }\n    else if (macd.histogram < 0 && macd.macd < macd.signal) { sellSignals++; reasons.push(\"MACD bajista\"); }\n\n    if (bollinger.percentB < 20) { buySignals++; reasons.push(\"Precio en Bollinger inferior\"); }\n    else if (bollinger.percentB > 80) { sellSignals++; reasons.push(\"Precio en Bollinger superior\"); }\n\n    if (isBullishCandle && bodyRatio > 0.6) {\n      buySignals++;\n      reasons.push(\"Vela alcista fuerte\");\n    } else if (isBearishCandle && bodyRatio > 0.6) {\n      sellSignals++;\n      reasons.push(\"Vela bajista fuerte\");\n    }\n\n    if (isHighVolume) {\n      if (isBullishCandle) { buySignals++; reasons.push(`Volumen alto alcista (${volumeRatio.toFixed(1)}x)`); }\n      else if (isBearishCandle) { sellSignals++; reasons.push(`Volumen alto bajista (${volumeRatio.toFixed(1)}x)`); }\n    }\n\n    if (isBullishCandle && prevCandle && prevCandle.close < prevCandle.open) {\n      if (lastCandle.close > prevCandle.open) {\n        buySignals++;\n        reasons.push(\"Engulfing alcista\");\n      }\n    }\n    if (isBearishCandle && prevCandle && prevCandle.close > prevCandle.open) {\n      if (lastCandle.close < prevCandle.open) {\n        sellSignals++;\n        reasons.push(\"Engulfing bajista\");\n      }\n    }\n\n    const confidence = Math.min(0.95, 0.5 + (Math.max(buySignals, sellSignals) * 0.07));\n    \n    if (buySignals >= 4 && buySignals > sellSignals && rsi < 70) {\n      return {\n        action: \"buy\",\n        pair,\n        confidence,\n        reason: `Momentum Velas COMPRA: ${reasons.join(\", \")} | Se√±ales: ${buySignals}/${sellSignals}`,\n      };\n    }\n    \n    if (sellSignals >= 4 && sellSignals > buySignals && rsi > 30) {\n      return {\n        action: \"sell\",\n        pair,\n        confidence,\n        reason: `Momentum Velas VENTA: ${reasons.join(\", \")} | Se√±ales: ${sellSignals}/${buySignals}`,\n      };\n    }\n\n    return { action: \"hold\", pair, confidence: 0.3, reason: `Sin se√±al clara velas (${buySignals}/${sellSignals})` };\n  }\n\n  async start() {\n    if (this.isRunning) return;\n    \n    const config = await storage.getBotConfig();\n    if (!config?.isActive) {\n      log(\"Bot no est√° activo, no se inicia el motor de trading\", \"trading\");\n      return;\n    }\n\n    if (!this.krakenService.isInitialized()) {\n      log(\"Kraken no est√° configurado, no se puede iniciar el trading\", \"trading\");\n      return;\n    }\n\n    // Load dynamic pair metadata from Kraken API (step sizes, order minimums)\n    const activePairs = config.activePairs || [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\", \"XRP/USD\"];\n    try {\n      await this.krakenService.loadPairMetadata(activePairs);\n      // Verify all active pairs have metadata\n      const missingPairs = activePairs.filter(p => !this.krakenService.hasMetadata(p));\n      if (missingPairs.length > 0) {\n        log(`[CRITICAL] Missing metadata for pairs: ${missingPairs.join(\", \")}. Using fallback values.`, \"trading\");\n      }\n      this.krakenService.startMetadataRefresh(activePairs);\n    } catch (error: any) {\n      log(`[CRITICAL] Failed to load pair metadata: ${error.message}. Trading will use fallback values.`, \"trading\");\n      // Continue with fallbacks - don't block trading entirely for API failures\n    }\n\n    if (!this.telegramService.isInitialized()) {\n      log(\"Telegram no est√° configurado, continuando sin notificaciones\", \"trading\");\n    }\n    \n    // Load dryRunMode from config (Replit always forces dry run regardless of DB setting)\n    const dbDryRun = (config as any).dryRunMode ?? false;\n    if (this.isReplitEnvironment) {\n      this.dryRunMode = true;\n      log(\"[SAFETY] Modo DRY_RUN forzado en Replit - no se enviar√°n √≥rdenes reales\", \"trading\");\n    } else {\n      this.dryRunMode = dbDryRun;\n      if (this.dryRunMode) {\n        log(\"[INFO] Modo DRY_RUN activado desde configuraci√≥n\", \"trading\");\n      }\n    }\n\n    try {\n      const balances = await this.krakenService.getBalance();\n      this.currentUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || \"0\");\n      log(`Balance inicial USD: $${this.currentUsdBalance.toFixed(2)}`, \"trading\");\n    } catch (error: any) {\n      log(`Error obteniendo balance inicial: ${error.message}`, \"trading\");\n      return;\n    }\n\n    this.isRunning = true;\n    log(\"Motor de trading iniciado\", \"trading\");\n    \n    await this.loadOpenPositionsFromDB();\n    \n    const modeLabel = this.dryRunMode ? \"DRY_RUN (simulaci√≥n)\" : \"LIVE (√≥rdenes reales)\";\n    \n    await botLogger.info(\"BOT_STARTED\", \"Motor de trading iniciado\", {\n      strategy: config.strategy,\n      riskLevel: config.riskLevel,\n      activePairs: config.activePairs,\n      balanceUsd: this.currentUsdBalance,\n      openPositions: this.openPositions.size,\n      dryRunMode: this.dryRunMode,\n      isReplitEnvironment: this.isReplitEnvironment,\n    });\n    \n    if (this.telegramService.isInitialized()) {\n      const dryRunNote = this.dryRunMode ? \"\\n‚ö†Ô∏è *Modo:* DRY\\\\_RUN (sin √≥rdenes reales)\" : \"\";\n      await this.telegramService.sendMessage(`ü§ñ *KrakenBot Iniciado*\n\nEl bot de trading aut√≥nomo est√° activo.\n*Estrategia:* ${config.strategy}\n*Nivel de riesgo:* ${config.riskLevel}\n*Pares activos:* ${config.activePairs.join(\", \")}\n*Balance USD:* $${this.currentUsdBalance.toFixed(2)}${dryRunNote}`);\n    }\n    \n    const intervalMs = this.getIntervalForStrategy(config.strategy);\n    this.intervalId = setInterval(() => this.runTradingCycle(), intervalMs);\n    \n    // Iniciar tick interval para ENGINE_TICK cada 60s\n    this.tickIntervalId = setInterval(() => this.emitEngineTick(), this.TICK_INTERVAL_MS);\n    \n    this.runTradingCycle();\n  }\n\n  async stop() {\n    if (!this.isRunning) return;\n    \n    this.isRunning = false;\n    if (this.intervalId) {\n      clearInterval(this.intervalId);\n      this.intervalId = null;\n    }\n    if (this.tickIntervalId) {\n      clearInterval(this.tickIntervalId);\n      this.tickIntervalId = null;\n    }\n    \n    log(\"Motor de trading detenido\", \"trading\");\n    \n    await botLogger.info(\"BOT_STOPPED\", \"Motor de trading detenido\");\n    \n    if (this.telegramService.isInitialized()) {\n      await this.telegramService.sendMessage(\"üõë *KrakenBot Detenido*\\n\\nEl bot de trading ha sido desactivado.\");\n    }\n  }\n\n  private getIntervalForStrategy(strategy: string): number {\n    switch (strategy) {\n      case \"scalping\": return 10000;\n      case \"grid\": return 15000;\n      case \"momentum\": return 30000;\n      case \"mean_reversion\": return 30000;\n      default: return 30000;\n    }\n  }\n\n  private async loadOpenPositionsFromDB() {\n    try {\n      const positions = await storage.getOpenPositions();\n      this.openPositions.clear();\n      \n      for (const pos of positions) {\n        const hasSnapshot = pos.configSnapshotJson && pos.entryMode;\n        const configSnapshot = hasSnapshot ? (pos.configSnapshotJson as ConfigSnapshot) : undefined;\n        \n        // Use existing lotId or generate one for legacy positions\n        const lotId = pos.lotId || generateLotId(pos.pair);\n        \n        this.openPositions.set(lotId, {\n          lotId,\n          pair: pos.pair,\n          amount: parseFloat(pos.amount),\n          entryPrice: parseFloat(pos.entryPrice),\n          highestPrice: parseFloat(pos.highestPrice),\n          openedAt: new Date(pos.openedAt).getTime(),\n          entryStrategyId: pos.entryStrategyId || \"momentum_cycle\",\n          entrySignalTf: pos.entrySignalTf || \"cycle\",\n          signalConfidence: pos.signalConfidence ? parseFloat(pos.signalConfidence) : undefined,\n          signalReason: pos.signalReason || undefined,\n          entryMode: pos.entryMode || undefined,\n          configSnapshot,\n          // SMART_GUARD state\n          sgBreakEvenActivated: pos.sgBreakEvenActivated ?? false,\n          sgCurrentStopPrice: pos.sgCurrentStopPrice ? parseFloat(pos.sgCurrentStopPrice) : undefined,\n          sgTrailingActivated: pos.sgTrailingActivated ?? false,\n          sgScaleOutDone: pos.sgScaleOutDone ?? false,\n        });\n        \n        // If position lacked lotId, update DB\n        if (!pos.lotId) {\n          await storage.updateOpenPositionLotId(pos.id, lotId);\n          log(`Migrated legacy position ${pos.pair} -> lotId: ${lotId}`, \"trading\");\n        }\n        \n        const snapshotInfo = hasSnapshot ? `[snapshot: ${pos.entryMode}]` : \"[legacy: uses current config]\";\n        log(`Posici√≥n recuperada: ${pos.pair} (${lotId}) - ${pos.amount} @ $${pos.entryPrice} (${pos.entryStrategyId}/${pos.entrySignalTf}) ${snapshotInfo}`, \"trading\");\n      }\n      \n      if (positions.length > 0) {\n        log(`${positions.length} posiciones abiertas (${this.openPositions.size} lotes) cargadas desde la base de datos`, \"trading\");\n        if (this.telegramService.isInitialized()) {\n          const escapeMarkdown = (text: string) => text.replace(/[_*[\\]()~`>#+=|{}.!-]/g, '\\\\$&');\n          const positionsList = positions.map(p => {\n            const hasSnap = p.configSnapshotJson && p.entryMode;\n            const snapLabel = hasSnap ? `üì∏${escapeMarkdown(p.entryMode || '')}` : `‚öôÔ∏èlegacy`;\n            return `‚Ä¢ ${p.pair}: ${p.amount} @ $${parseFloat(p.entryPrice).toFixed(2)} (${snapLabel})`;\n          }).join(\"\\n\");\n          await this.telegramService.sendMessage(`üìÇ *Posiciones Abiertas*\\n\\n${positionsList}`);\n        }\n      }\n    } catch (error: any) {\n      log(`Error cargando posiciones: ${error.message}`, \"trading\");\n    }\n  }\n\n  private async savePositionToDB(pair: string, position: OpenPosition) {\n    try {\n      await storage.saveOpenPositionByLotId({\n        lotId: position.lotId,\n        pair,\n        entryPrice: position.entryPrice.toString(),\n        amount: position.amount.toString(),\n        highestPrice: position.highestPrice.toString(),\n        entryStrategyId: position.entryStrategyId,\n        entrySignalTf: position.entrySignalTf,\n        signalConfidence: position.signalConfidence?.toString(),\n        signalReason: position.signalReason,\n        entryMode: position.entryMode,\n        configSnapshotJson: position.configSnapshot,\n        // SMART_GUARD state\n        sgBreakEvenActivated: position.sgBreakEvenActivated,\n        sgCurrentStopPrice: position.sgCurrentStopPrice?.toString(),\n        sgTrailingActivated: position.sgTrailingActivated,\n        sgScaleOutDone: position.sgScaleOutDone,\n      });\n    } catch (error: any) {\n      log(`Error guardando posici√≥n ${pair} (${position.lotId}): ${error.message}`, \"trading\");\n    }\n  }\n\n  private async deletePositionFromDBByLotId(lotId: string) {\n    try {\n      await storage.deleteOpenPositionByLotId(lotId);\n    } catch (error: any) {\n      log(`Error eliminando posici√≥n ${lotId}: ${error.message}`, \"trading\");\n    }\n  }\n\n  private async updatePositionHighestPriceByLotId(lotId: string, highestPrice: number) {\n    try {\n      await storage.updateOpenPositionByLotId(lotId, {\n        highestPrice: highestPrice.toString(),\n      });\n    } catch (error: any) {\n      log(`Error actualizando highestPrice ${lotId}: ${error.message}`, \"trading\");\n    }\n  }\n\n  private async runTradingCycle() {\n    try {\n      const config = await storage.getBotConfig();\n      if (!config?.isActive) {\n        await this.stop();\n        return;\n      }\n\n      // Actualizar tiempo de escaneo y limpiar resultados anteriores\n      this.lastScanTime = Date.now();\n      this.lastScanResults.clear();\n\n      const balances = await this.krakenService.getBalance();\n      this.currentUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || \"0\");\n      \n      // Reset diario del P&L\n      const today = new Date().toISOString().split(\"T\")[0];\n      if (this.lastDayReset !== today) {\n        const previousDayPnL = this.dailyPnL;\n        this.dailyPnL = 0;\n        this.dailyStartBalance = this.currentUsdBalance;\n        this.lastDayReset = today;\n        this.isDailyLimitReached = false;\n        log(`Nuevo d√≠a de trading: ${today}. Balance inicial: $${this.dailyStartBalance.toFixed(2)}`, \"trading\");\n        \n        await botLogger.info(\"DAILY_LIMIT_RESET\", `Nuevo d√≠a de trading: ${today}`, {\n          date: today,\n          previousDayPnL,\n          startBalance: this.dailyStartBalance,\n        });\n      }\n\n      // Verificar l√≠mite de p√©rdida diaria\n      const dailyLossLimitEnabled = config.dailyLossLimitEnabled ?? true;\n      const dailyLossLimitPercent = parseFloat(config.dailyLossLimitPercent?.toString() || \"10\");\n      \n      if (dailyLossLimitEnabled && this.dailyStartBalance > 0) {\n        const currentLossPercent = (this.dailyPnL / this.dailyStartBalance) * 100;\n        \n        if (currentLossPercent <= -dailyLossLimitPercent && !this.isDailyLimitReached) {\n          this.isDailyLimitReached = true;\n          log(`üõë L√çMITE DE P√âRDIDA DIARIA ALCANZADO: ${currentLossPercent.toFixed(2)}% (l√≠mite: -${dailyLossLimitPercent}%)`, \"trading\");\n          \n          await botLogger.warn(\"DAILY_LIMIT_HIT\", \"L√≠mite de p√©rdida diaria alcanzado. Bot pausado para nuevas compras.\", {\n            dailyPnL: this.dailyPnL,\n            dailyPnLPercent: currentLossPercent,\n            limitPercent: dailyLossLimitPercent,\n            startBalance: this.dailyStartBalance,\n          });\n          \n          if (this.telegramService.isInitialized()) {\n            await this.telegramService.sendAlert(\n              \"L√≠mite de P√©rdida Diaria Alcanzado\",\n              `El bot ha pausado las operaciones de COMPRA.\\n\\n` +\n              `üìä *P&L del d√≠a:* ${currentLossPercent.toFixed(2)}%\\n` +\n              `üí∞ *P√©rdida:* $${Math.abs(this.dailyPnL).toFixed(2)}\\n` +\n              `‚öôÔ∏è *L√≠mite configurado:* -${dailyLossLimitPercent}%\\n\\n` +\n              `_Las operaciones de cierre (Stop-Loss, Take-Profit) siguen activas._\\n` +\n              `_El trading normal se reanudar√° ma√±ana autom√°ticamente._`\n            );\n          }\n        }\n      }\n      \n      const riskConfig = RISK_LEVELS[config.riskLevel] || RISK_LEVELS.medium;\n\n      const stopLossPercent = parseFloat(config.stopLossPercent?.toString() || \"5\");\n      const takeProfitPercent = parseFloat(config.takeProfitPercent?.toString() || \"7\");\n      const trailingStopEnabled = config.trailingStopEnabled ?? false;\n      const trailingStopPercent = parseFloat(config.trailingStopPercent?.toString() || \"2\");\n\n      // Stop-Loss y Take-Profit siempre se verifican (incluso con l√≠mite alcanzado)\n      for (const pair of config.activePairs) {\n        await this.checkStopLossTakeProfit(pair, stopLossPercent, takeProfitPercent, trailingStopEnabled, trailingStopPercent, balances);\n      }\n\n      // No abrir nuevas posiciones si se alcanz√≥ el l√≠mite diario\n      if (this.isDailyLimitReached) {\n        return;\n      }\n\n      if (this.currentUsdBalance < 5) {\n        log(`Saldo USD insuficiente: $${this.currentUsdBalance.toFixed(2)}`, \"trading\");\n        return;\n      }\n\n      // MEJORA 2: Verificar horarios de trading\n      const tradingHoursCheck = this.isWithinTradingHours(config);\n      if (!tradingHoursCheck.withinHours) {\n        log(`Fuera de horario de trading (${tradingHoursCheck.hourUTC}h UTC). Horario: ${tradingHoursCheck.start}h-${tradingHoursCheck.end}h UTC`, \"trading\");\n        return;\n      }\n\n      const signalTimeframe = config.signalTimeframe || \"cycle\";\n      const isCandleMode = signalTimeframe !== \"cycle\" && config.strategy === \"momentum\";\n\n      for (const pair of config.activePairs) {\n        // Inicializar entrada por defecto para diagn√≥stico (se sobrescribe si hay se√±al)\n        if (!this.lastScanResults.has(pair)) {\n          this.lastScanResults.set(pair, {\n            signal: \"NONE\",\n            reason: \"Sin se√±al en este ciclo\",\n            exposureAvailable: this.getAvailableExposure(pair, config, this.currentUsdBalance),\n          });\n        }\n        \n        if (isCandleMode) {\n          const candle = await this.getLastClosedCandle(pair, signalTimeframe);\n          if (!candle) continue;\n          \n          if (this.isNewCandleClosed(pair, signalTimeframe, candle.time)) {\n            log(`Nueva vela cerrada ${pair}/${signalTimeframe} @ ${new Date(candle.time * 1000).toISOString()}`, \"trading\");\n            await this.analyzePairAndTradeWithCandles(pair, signalTimeframe, candle, riskConfig, balances);\n          }\n        } else {\n          await this.analyzePairAndTrade(pair, config.strategy, riskConfig, balances);\n        }\n      }\n    } catch (error: any) {\n      log(`Error en ciclo de trading: ${error.message}`, \"trading\");\n    }\n  }\n\n  private async checkStopLossTakeProfit(\n    pair: string,\n    stopLossPercent: number,\n    takeProfitPercent: number,\n    trailingStopEnabled: boolean,\n    trailingStopPercent: number,\n    balances: any\n  ) {\n    // Get all positions for this pair (multi-lot support)\n    const positions = this.getPositionsByPair(pair);\n    if (positions.length === 0) return;\n\n    try {\n      const krakenPair = this.formatKrakenPair(pair);\n      const ticker = await this.krakenService.getTicker(krakenPair);\n      const tickerData: any = Object.values(ticker)[0];\n      if (!tickerData) return;\n\n      const currentPrice = parseFloat(tickerData.c?.[0] || \"0\");\n\n      // Process each position for this pair independently\n      for (const position of positions) {\n        if (position.amount <= 0) continue;\n        \n        await this.checkSinglePositionSLTP(\n          pair, position, currentPrice, stopLossPercent, takeProfitPercent,\n          trailingStopEnabled, trailingStopPercent, balances\n        );\n      }\n    } catch (error: any) {\n      log(`Error verificando SL/TP para ${pair}: ${error.message}`, \"trading\");\n    }\n  }\n\n  private async checkSinglePositionSLTP(\n    pair: string,\n    position: OpenPosition,\n    currentPrice: number,\n    stopLossPercent: number,\n    takeProfitPercent: number,\n    trailingStopEnabled: boolean,\n    trailingStopPercent: number,\n    balances: any\n  ) {\n    const lotId = position.lotId;\n    const priceChange = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;\n\n    if (currentPrice > position.highestPrice) {\n      position.highestPrice = currentPrice;\n      this.openPositions.set(lotId, position);\n      await this.updatePositionHighestPriceByLotId(lotId, currentPrice);\n    }\n\n    // Check if this is a SMART_GUARD position - use dedicated logic\n    if (position.entryMode === \"SMART_GUARD\" && position.configSnapshot) {\n      await this.checkSmartGuardExit(pair, position, currentPrice, priceChange);\n      return;\n    }\n\n    // Use snapshot params if available (new positions), else use current config (legacy)\n    let effectiveSL: number;\n    let effectiveTP: number;\n    let effectiveTrailingEnabled: boolean;\n    let effectiveTrailingPct: number;\n    let paramsSource: string;\n\n    if (position.configSnapshot) {\n      effectiveSL = position.configSnapshot.stopLossPercent;\n      effectiveTP = position.configSnapshot.takeProfitPercent;\n      effectiveTrailingEnabled = position.configSnapshot.trailingStopEnabled;\n      effectiveTrailingPct = position.configSnapshot.trailingStopPercent;\n      paramsSource = `snapshot (${position.entryMode})`;\n    } else {\n      effectiveSL = stopLossPercent;\n      effectiveTP = takeProfitPercent;\n      effectiveTrailingEnabled = trailingStopEnabled;\n      effectiveTrailingPct = trailingStopPercent;\n      paramsSource = \"current config (legacy)\";\n    }\n\n    let shouldSell = false;\n    let reason = \"\";\n    let emoji = \"\";\n\n    if (priceChange <= -effectiveSL) {\n      shouldSell = true;\n      reason = `Stop-Loss activado (${priceChange.toFixed(2)}% < -${effectiveSL}%) [${paramsSource}]`;\n      emoji = \"üõë\";\n      this.setStopLossCooldown(pair);\n      await botLogger.warn(\"STOP_LOSS_HIT\", `Stop-Loss activado en ${pair}`, {\n        pair,\n        lotId,\n        entryPrice: position.entryPrice,\n        currentPrice,\n        priceChange,\n        stopLossPercent: effectiveSL,\n        paramsSource,\n        cooldownMinutes: POST_STOPLOSS_COOLDOWN_MS / 60000,\n      });\n    }\n    else if (priceChange >= effectiveTP) {\n      shouldSell = true;\n      reason = `Take-Profit activado (${priceChange.toFixed(2)}% > ${effectiveTP}%) [${paramsSource}]`;\n      emoji = \"üéØ\";\n      await botLogger.info(\"TAKE_PROFIT_HIT\", `Take-Profit alcanzado en ${pair}`, {\n        pair,\n        lotId,\n        entryPrice: position.entryPrice,\n        currentPrice,\n        priceChange,\n        takeProfitPercent: effectiveTP,\n        paramsSource,\n      });\n    }\n    else if (effectiveTrailingEnabled && position.highestPrice > position.entryPrice) {\n      const dropFromHigh = ((position.highestPrice - currentPrice) / position.highestPrice) * 100;\n      if (dropFromHigh >= effectiveTrailingPct && priceChange > 0) {\n        shouldSell = true;\n        reason = `Trailing Stop activado (cay√≥ ${dropFromHigh.toFixed(2)}% desde m√°ximo $${position.highestPrice.toFixed(2)}) [${paramsSource}]`;\n        emoji = \"üìâ\";\n        await botLogger.info(\"TRAILING_STOP_HIT\", `Trailing Stop activado en ${pair}`, {\n          pair,\n          lotId,\n          entryPrice: position.entryPrice,\n          highestPrice: position.highestPrice,\n          currentPrice,\n          dropFromHigh,\n          trailingStopPercent: effectiveTrailingPct,\n          paramsSource,\n        });\n      }\n    }\n\n    if (shouldSell) {\n      const minVolume = this.getOrderMin(pair);\n      const sellAmount = position.amount;\n\n      if (sellAmount < minVolume) {\n        log(`Cantidad a vender (${sellAmount}) menor al m√≠nimo de Kraken (${minVolume}) para ${pair} (${lotId})`, \"trading\");\n        return;\n      }\n\n      // VERIFICACI√ìN DE BALANCE REAL: Evitar \"EOrder:Insufficient funds\"\n      const freshBalances = await this.krakenService.getBalance();\n      const realAssetBalance = this.getAssetBalance(pair, freshBalances);\n      \n      // Si el balance real es menor al 99.5% del esperado (tolerancia para fees ~0.26%)\n      if (realAssetBalance < sellAmount * 0.995) {\n        log(`‚ö†Ô∏è Discrepancia de balance en ${pair} (${lotId}): Registrado ${sellAmount}, Real ${realAssetBalance}`, \"trading\");\n        \n        // Si balance real es pr√°cticamente cero (< m√≠nimo de Kraken), eliminar posici√≥n\n        if (realAssetBalance < minVolume) {\n          log(`Posici√≥n hu√©rfana eliminada en ${pair} (${lotId}): balance real (${realAssetBalance}) < m√≠nimo (${minVolume})`, \"trading\");\n          \n          // NO modificar dailyPnL: si fue vendida manualmente, el usuario ya tiene el USD\n          // Pero S√ç debemos reconciliar exposure y cooldowns\n          \n          // Refrescar balance USD para tener m√©tricas consistentes\n          this.currentUsdBalance = parseFloat(freshBalances?.ZUSD || freshBalances?.USD || \"0\");\n          \n          this.openPositions.delete(lotId);\n          await this.deletePositionFromDBByLotId(lotId);\n          \n          // Limpiar cooldowns obsoletos y establecer uno nuevo (15 min)\n          this.stopLossCooldowns.delete(pair);\n          this.lastExposureAlert.delete(pair);\n          this.setPairCooldown(pair);\n          this.lastTradeTime.set(pair, Date.now());\n          \n          if (this.telegramService.isInitialized()) {\n            await this.telegramService.sendMessage(`\nüîÑ *Posici√≥n Hu√©rfana Eliminada*\n\n*Par:* ${pair}\n*Lot:* ${lotId}\n*Registrada:* ${sellAmount.toFixed(8)}\n*Real en Kraken:* ${realAssetBalance.toFixed(8)}\n\n_La posici√≥n no existe en Kraken y fue eliminada._\n            `.trim());\n          }\n          \n          await botLogger.warn(\"ORPHAN_POSITION_CLEANED\", `Posici√≥n hu√©rfana eliminada en ${pair}`, {\n            pair,\n            lotId,\n            registeredAmount: sellAmount,\n            realBalance: realAssetBalance,\n            newUsdBalance: this.currentUsdBalance,\n          });\n          return;\n        }\n        \n        // Si hay algo de balance pero menos del registrado, ajustar posici√≥n al real\n        log(`Ajustando posici√≥n ${pair} (${lotId}) de ${sellAmount} a ${realAssetBalance}`, \"trading\");\n        position.amount = realAssetBalance;\n        this.openPositions.set(lotId, position);\n        await this.savePositionToDB(pair, position);\n        \n        // Notificar ajuste\n        if (this.telegramService.isInitialized()) {\n          await this.telegramService.sendMessage(`\nüîß *Posici√≥n Ajustada*\n\n*Par:* ${pair}\n*Lot:* ${lotId}\n*Cantidad anterior:* ${sellAmount.toFixed(8)}\n*Cantidad real:* ${realAssetBalance.toFixed(8)}\n\n_Se usar√° la cantidad real para la venta._\n          `.trim());\n        }\n        \n        // Continuar con la venta usando el balance real\n      }\n\n      log(`${emoji} ${reason} para ${pair} (${lotId})`, \"trading\");\n\n      // Usar position.amount (puede haber sido ajustado al balance real)\n      const actualSellAmount = position.amount;\n      const pnl = (currentPrice - position.entryPrice) * actualSellAmount;\n      const pnlPercent = priceChange;\n\n      const sellContext = { entryPrice: position.entryPrice, aiSampleId: position.aiSampleId };\n      const success = await this.executeTrade(pair, \"sell\", actualSellAmount.toFixed(8), currentPrice, reason, undefined, undefined, undefined, sellContext);\n      \n      if (success && this.telegramService.isInitialized()) {\n        const pnlEmoji = pnl >= 0 ? \"üí∞\" : \"üìâ\";\n        await this.telegramService.sendAlertToMultipleChats(`\n${emoji} *${reason}*\n\n*Par:* ${pair}\n*Lot:* ${lotId}\n*Precio entrada:* $${position.entryPrice.toFixed(2)}\n*Precio actual:* $${currentPrice.toFixed(2)}\n*Cantidad vendida:* ${actualSellAmount.toFixed(8)}\n\n${pnlEmoji} *P&L:* ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)\n        `.trim(), \"trades\");\n      }\n\n      if (success) {\n        this.openPositions.delete(lotId);\n        await this.deletePositionFromDBByLotId(lotId);\n        this.lastTradeTime.set(pair, Date.now());\n      }\n    }\n  }\n\n  private async checkSmartGuardExit(\n    pair: string,\n    position: OpenPosition,\n    currentPrice: number,\n    priceChange: number\n  ) {\n    const snapshot = position.configSnapshot!;\n    const paramsSource = `SMART_GUARD snapshot`;\n    \n    // Get snapshot params with defaults\n    const beAtPct = snapshot.sgBeAtPct ?? 1.5;\n    const feeCushionPct = snapshot.sgFeeCushionPct ?? 0.45;\n    const trailStartPct = snapshot.sgTrailStartPct ?? 2.0;\n    const trailDistancePct = snapshot.sgTrailDistancePct ?? 1.5;\n    const trailStepPct = snapshot.sgTrailStepPct ?? 0.25;\n    const tpFixedEnabled = snapshot.sgTpFixedEnabled ?? false;\n    const tpFixedPct = snapshot.sgTpFixedPct ?? 10;\n    const scaleOutEnabled = snapshot.sgScaleOutEnabled ?? false;\n    const scaleOutPct = snapshot.sgScaleOutPct ?? 35;\n    const minPartUsd = snapshot.sgMinPartUsd ?? 50;\n    const scaleOutThreshold = snapshot.sgScaleOutThreshold ?? 80;\n    \n    // Also use the standard SL from snapshot as ultimate protection\n    const ultimateSL = snapshot.stopLossPercent;\n    \n    let shouldSellFull = false;\n    let shouldScaleOut = false;\n    let sellReason = \"\";\n    let emoji = \"\";\n    let positionModified = false;\n    \n    // Calculate break-even price (entry + fee cushion)\n    const breakEvenPrice = position.entryPrice * (1 + feeCushionPct / 100);\n    \n    // 1. ULTIMATE STOP-LOSS - Emergency exit (always active)\n    if (priceChange <= -ultimateSL) {\n      shouldSellFull = true;\n      sellReason = `Stop-Loss emergencia SMART_GUARD (${priceChange.toFixed(2)}% < -${ultimateSL}%) [${paramsSource}]`;\n      emoji = \"üõë\";\n      this.setStopLossCooldown(pair);\n      await botLogger.warn(\"SG_EMERGENCY_STOPLOSS\", `SMART_GUARD Stop-Loss emergencia en ${pair}`, {\n        pair, entryPrice: position.entryPrice, currentPrice, priceChange, ultimateSL, paramsSource,\n      });\n    }\n    \n    // 2. FIXED TAKE-PROFIT (if enabled)\n    else if (tpFixedEnabled && priceChange >= tpFixedPct) {\n      shouldSellFull = true;\n      sellReason = `Take-Profit fijo SMART_GUARD (${priceChange.toFixed(2)}% >= ${tpFixedPct}%) [${paramsSource}]`;\n      emoji = \"üéØ\";\n      await botLogger.info(\"SG_TP_FIXED\", `SMART_GUARD TP fijo alcanzado en ${pair}`, {\n        pair, entryPrice: position.entryPrice, currentPrice, priceChange, tpFixedPct, paramsSource,\n      });\n    }\n    \n    // 3. BREAK-EVEN ACTIVATION - Move stop to breakeven when profit >= beAtPct\n    else if (!position.sgBreakEvenActivated && priceChange >= beAtPct) {\n      position.sgBreakEvenActivated = true;\n      position.sgCurrentStopPrice = breakEvenPrice;\n      positionModified = true;\n      log(`SMART_GUARD ${pair}: Break-even activado (+${priceChange.toFixed(2)}%), stop movido a $${breakEvenPrice.toFixed(4)}`, \"trading\");\n      \n      // Send alert (only once per lot, no throttle needed as flag prevents re-entry)\n      if (this.shouldSendSgAlert(position.lotId, \"SG_BREAK_EVEN_ACTIVATED\")) {\n        await this.sendSgEventAlert(\"SG_BREAK_EVEN_ACTIVATED\", position, currentPrice, {\n          stopPrice: breakEvenPrice,\n          profitPct: priceChange,\n          reason: `Profit +${beAtPct}% alcanzado, stop movido a break-even + comisiones`,\n        });\n      }\n    }\n    \n    // 4. TRAILING STOP ACTIVATION - Start trailing when profit >= trailStartPct\n    if (!position.sgTrailingActivated && priceChange >= trailStartPct) {\n      position.sgTrailingActivated = true;\n      const trailStopPrice = currentPrice * (1 - trailDistancePct / 100);\n      // Only update stop if higher than current\n      if (!position.sgCurrentStopPrice || trailStopPrice > position.sgCurrentStopPrice) {\n        position.sgCurrentStopPrice = trailStopPrice;\n      }\n      positionModified = true;\n      log(`SMART_GUARD ${pair}: Trailing activado (+${priceChange.toFixed(2)}%), stop din√°mico @ $${position.sgCurrentStopPrice!.toFixed(4)}`, \"trading\");\n      \n      // Send alert (only once per lot)\n      if (this.shouldSendSgAlert(position.lotId, \"SG_TRAILING_ACTIVATED\")) {\n        await this.sendSgEventAlert(\"SG_TRAILING_ACTIVATED\", position, currentPrice, {\n          stopPrice: position.sgCurrentStopPrice,\n          profitPct: priceChange,\n          reason: `Profit +${trailStartPct}% alcanzado, trailing stop iniciado a ${trailDistancePct}% del m√°ximo`,\n        });\n      }\n    }\n    \n    // 5. TRAILING STOP UPDATE - Ratchet up stop with step increments\n    if (position.sgTrailingActivated && position.sgCurrentStopPrice) {\n      const newTrailStop = currentPrice * (1 - trailDistancePct / 100);\n      const minStepPrice = position.sgCurrentStopPrice * (1 + trailStepPct / 100);\n      \n      // Only update if new stop is higher by at least one step\n      if (newTrailStop > minStepPrice) {\n        const oldStop = position.sgCurrentStopPrice;\n        position.sgCurrentStopPrice = newTrailStop;\n        positionModified = true;\n        log(`SMART_GUARD ${pair}: Trailing step $${oldStop.toFixed(4)} ‚Üí $${newTrailStop.toFixed(4)} (+${trailStepPct}%)`, \"trading\");\n        \n        // Send alert with throttle (max 1 per 5 min)\n        if (this.shouldSendSgAlert(position.lotId, \"SG_TRAILING_STOP_UPDATED\", this.SG_TRAIL_UPDATE_THROTTLE_MS)) {\n          await this.sendSgEventAlert(\"SG_TRAILING_STOP_UPDATED\", position, currentPrice, {\n            stopPrice: newTrailStop,\n            profitPct: priceChange,\n            reason: `Stop actualizado: $${oldStop.toFixed(2)} ‚Üí $${newTrailStop.toFixed(2)}`,\n          });\n        }\n      }\n    }\n    \n    // 6. CHECK IF STOP PRICE HIT\n    if (position.sgCurrentStopPrice && currentPrice <= position.sgCurrentStopPrice) {\n      const stopType = position.sgTrailingActivated ? \"Trailing Stop\" : \"Break-even Stop\";\n      shouldSellFull = true;\n      sellReason = `${stopType} SMART_GUARD ($${currentPrice.toFixed(2)} <= $${position.sgCurrentStopPrice.toFixed(2)}) [${paramsSource}]`;\n      emoji = position.sgTrailingActivated ? \"üìâ\" : \"‚öñÔ∏è\";\n      await botLogger.info(\"SG_STOP_HIT\", `SMART_GUARD ${stopType} activado en ${pair}`, {\n        pair, entryPrice: position.entryPrice, currentPrice, stopPrice: position.sgCurrentStopPrice,\n        stopType, paramsSource,\n      });\n    }\n    \n    // 7. SCALE-OUT (optional, only if exceptional signal)\n    if (!shouldSellFull && scaleOutEnabled && !position.sgScaleOutDone) {\n      // Only scale out if signal confidence >= threshold and part is worth selling\n      const partValue = position.amount * currentPrice * (scaleOutPct / 100);\n      if (position.signalConfidence && position.signalConfidence >= scaleOutThreshold && partValue >= minPartUsd) {\n        if (priceChange >= trailStartPct) { // Only scale out in profit\n          shouldScaleOut = true;\n          sellReason = `Scale-out SMART_GUARD (${scaleOutPct}% @ +${priceChange.toFixed(2)}%, conf=${position.signalConfidence}%) [${paramsSource}]`;\n          emoji = \"üìä\";\n          position.sgScaleOutDone = true;\n          positionModified = true;\n          \n          // Send alert (only once as sgScaleOutDone flag prevents re-entry)\n          if (this.shouldSendSgAlert(position.lotId, \"SG_SCALE_OUT_EXECUTED\")) {\n            await this.sendSgEventAlert(\"SG_SCALE_OUT_EXECUTED\", position, currentPrice, {\n              profitPct: priceChange,\n              reason: `Vendido ${scaleOutPct}% de posici√≥n ($${partValue.toFixed(2)}) a +${priceChange.toFixed(2)}%`,\n            });\n          }\n        }\n      }\n    }\n    \n    const lotId = position.lotId;\n    \n    // Save position changes\n    if (positionModified && !shouldSellFull && !shouldScaleOut) {\n      this.openPositions.set(lotId, position);\n      await this.savePositionToDB(pair, position);\n    }\n    \n    // Execute sell if needed\n    if (shouldSellFull || shouldScaleOut) {\n      const minVolume = this.getOrderMin(pair);\n      let sellAmount = shouldScaleOut \n        ? position.amount * (scaleOutPct / 100)\n        : position.amount;\n      \n      if (sellAmount < minVolume) {\n        log(`SMART_GUARD: Cantidad a vender (${sellAmount}) menor al m√≠nimo (${minVolume}) para ${pair} (${lotId})`, \"trading\");\n        return;\n      }\n      \n      // Balance verification\n      const freshBalances = await this.krakenService.getBalance();\n      const realAssetBalance = this.getAssetBalance(pair, freshBalances);\n      \n      if (realAssetBalance < sellAmount * 0.995) {\n        if (realAssetBalance < minVolume) {\n          log(`SMART_GUARD: Posici√≥n hu√©rfana en ${pair} (${lotId}), eliminando`, \"trading\");\n          this.openPositions.delete(lotId);\n          await this.deletePositionFromDBByLotId(lotId);\n          this.setPairCooldown(pair);\n          return;\n        }\n        sellAmount = realAssetBalance;\n        position.amount = realAssetBalance;\n      }\n      \n      log(`${emoji} ${sellReason} para ${pair} (${lotId})`, \"trading\");\n      \n      const pnl = (currentPrice - position.entryPrice) * sellAmount;\n      const sellContext = { entryPrice: position.entryPrice, aiSampleId: position.aiSampleId };\n      const success = await this.executeTrade(pair, \"sell\", sellAmount.toFixed(8), currentPrice, sellReason, undefined, undefined, undefined, sellContext);\n      \n      if (success && this.telegramService.isInitialized()) {\n        const pnlEmoji = pnl >= 0 ? \"üí∞\" : \"üìâ\";\n        await this.telegramService.sendAlertToMultipleChats(`\n${emoji} *${sellReason}*\n\n*Par:* ${pair}\n*Lot:* ${lotId}\n*Precio entrada:* $${position.entryPrice.toFixed(2)}\n*Precio actual:* $${currentPrice.toFixed(2)}\n*Cantidad vendida:* ${sellAmount.toFixed(8)}\n\n${pnlEmoji} *P&L:* ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%)\n        `.trim(), \"trades\");\n      }\n      \n      if (success) {\n        // Reduce position amount by what was sold\n        position.amount -= sellAmount;\n        \n        // Use epsilon comparison for floating-point safety (treat < 0.00000001 as zero)\n        const EPSILON = 1e-8;\n        const positionIsEmpty = shouldSellFull || position.amount < EPSILON;\n        \n        if (positionIsEmpty) {\n          this.openPositions.delete(lotId);\n          await this.deletePositionFromDBByLotId(lotId);\n          log(`SMART_GUARD ${pair} (${lotId}): Posici√≥n cerrada completamente`, \"trading\");\n        } else {\n          // Partial sell (scale-out) - save reduced position\n          this.openPositions.set(lotId, position);\n          await this.savePositionToDB(pair, position);\n          log(`SMART_GUARD ${pair} (${lotId}): Venta parcial, restante: ${position.amount.toFixed(8)}`, \"trading\");\n        }\n        this.lastTradeTime.set(pair, Date.now());\n      }\n    }\n  }\n\n  private async analyzePairAndTrade(\n    pair: string,\n    strategy: string,\n    riskConfig: RiskConfig,\n    balances: any\n  ) {\n    try {\n      const lastTrade = this.lastTradeTime.get(pair) || 0;\n      if (Date.now() - lastTrade < this.MIN_TRADE_INTERVAL_MS) {\n        return;\n      }\n\n      const krakenPair = this.formatKrakenPair(pair);\n      const ticker = await this.krakenService.getTicker(krakenPair);\n      const tickerData: any = Object.values(ticker)[0];\n      \n      if (!tickerData) return;\n\n      const currentPrice = parseFloat(tickerData.c?.[0] || \"0\");\n      const high24h = parseFloat(tickerData.h?.[1] || tickerData.h?.[0] || \"0\");\n      const low24h = parseFloat(tickerData.l?.[1] || tickerData.l?.[0] || \"0\");\n      const volume = parseFloat(tickerData.v?.[1] || tickerData.v?.[0] || \"0\");\n\n      this.updatePriceHistory(pair, {\n        price: currentPrice,\n        timestamp: Date.now(),\n        high: high24h,\n        low: low24h,\n        volume,\n      });\n\n      const history = this.priceHistory.get(pair) || [];\n      if (history.length < 5) return;\n\n      const signal = await this.analyzeWithStrategy(strategy, pair, history, currentPrice);\n      \n      // Registrar resultado del escaneo\n      const signalStr = signal.action === \"hold\" ? \"NONE\" : signal.action.toUpperCase();\n      const botConfigForScan = await storage.getBotConfig();\n      const exposure = this.getAvailableExposure(pair, botConfigForScan, this.currentUsdBalance);\n      this.lastScanResults.set(pair, {\n        signal: signalStr,\n        reason: signal.reason || \"Sin se√±al\",\n        cooldownSec: this.getCooldownRemainingSec(pair),\n        exposureAvailable: exposure.maxAllowed,\n      });\n      \n      if (signal.action === \"hold\" || signal.confidence < 0.6) {\n        return;\n      }\n\n      const assetBalance = this.getAssetBalance(pair, balances);\n      const existingPositions = this.getPositionsByPair(pair);\n      const existingPosition = existingPositions[0];\n\n      if (signal.action === \"buy\") {\n        if (this.isPairInCooldown(pair)) {\n          const cooldownSec = this.getCooldownRemainingSec(pair);\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - par en cooldown`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"PAIR_COOLDOWN\",\n            cooldownRemainingSec: cooldownSec,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        // MODO SINGLE o SMART_GUARD: Bloquear compras si ya hay posici√≥n abierta\n        const botConfigCheck = await storage.getBotConfig();\n        const positionMode = botConfigCheck?.positionMode || \"SINGLE\";\n        const sgMaxLotsPerPair = botConfigCheck?.sgMaxOpenLotsPerPair ?? 1;\n        \n        // En SINGLE siempre 1 slot. En SMART_GUARD respetamos sgMaxOpenLotsPerPair.\n        const maxLotsForMode = positionMode === \"SMART_GUARD\" ? sgMaxLotsPerPair : 1;\n        const currentOpenLots = this.countLotsForPair(pair);\n        \n        if ((positionMode === \"SINGLE\" || positionMode === \"SMART_GUARD\") && currentOpenLots >= maxLotsForMode) {\n          const reasonCode = positionMode === \"SMART_GUARD\" \n            ? \"SMART_GUARD_MAX_LOTS_REACHED\" \n            : \"SINGLE_MODE_POSITION_EXISTS\";\n          \n          log(`${pair}: Compra bloqueada - Modo ${positionMode}, lotes abiertos ${currentOpenLots}/${maxLotsForMode}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - m√°ximo de lotes alcanzado`, {\n            pair,\n            signal: \"BUY\",\n            reason: reasonCode,\n            currentOpenLots,\n            maxOpenLots: maxLotsForMode,\n            existingAmount: existingPosition?.amount || 0,\n            signalReason: signal.reason,\n          });\n          this.lastScanResults.set(pair, {\n            signal: \"BUY\",\n            reason: reasonCode,\n            exposureAvailable: 0,\n          });\n          return;\n        }\n\n        // MEJORA 4: Verificar cooldown post stop-loss\n        if (this.isPairInStopLossCooldown(pair)) {\n          const cooldownSec = this.getStopLossCooldownRemainingSec(pair);\n          log(`${pair}: En cooldown post stop-loss`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - cooldown post stop-loss`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"STOPLOSS_COOLDOWN\",\n            cooldownRemainingSec: cooldownSec,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        // MEJORA 1: Verificar spread antes de comprar\n        const spreadCheck = this.isSpreadAcceptable(tickerData);\n        if (!spreadCheck.acceptable) {\n          log(`${pair}: Spread demasiado alto (${spreadCheck.spreadPct.toFixed(3)}% > ${MAX_SPREAD_PCT}%)`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - spread alto`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"SPREAD_TOO_HIGH\",\n            spreadPct: spreadCheck.spreadPct,\n            maxSpreadPct: MAX_SPREAD_PCT,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        if (existingPosition && existingPosition.amount * currentPrice > riskConfig.maxTradeUSD * 2) {\n          log(`Posici√≥n existente en ${pair} ya es grande: $${(existingPosition.amount * currentPrice).toFixed(2)}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - posici√≥n existente demasiado grande`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"POSITION_TOO_LARGE\",\n            currentPositionUsd: existingPosition.amount * currentPrice,\n            maxTradeUsd: riskConfig.maxTradeUSD * 2,\n          });\n          return;\n        }\n\n        const minVolume = this.getOrderMin(pair);\n        const minRequiredUSD = minVolume * currentPrice;\n        const freshUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || \"0\");\n\n        if (freshUsdBalance < minRequiredUSD) {\n          log(`Saldo USD insuficiente para ${pair}: $${freshUsdBalance.toFixed(2)} < $${minRequiredUSD.toFixed(2)}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - fondos insuficientes`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"INSUFFICIENT_FUNDS\",\n            availableUsd: freshUsdBalance,\n            minRequiredUsd: minRequiredUSD,\n          });\n          this.setPairCooldown(pair);\n          return;\n        }\n\n        const botConfig = await storage.getBotConfig();\n        const riskPerTradePct = parseFloat(botConfig?.riskPerTradePct?.toString() || \"15\");\n        const takeProfitPct = parseFloat(botConfig?.takeProfitPercent?.toString() || \"7\");\n        \n        // === C√ÅLCULO DE TAMA√ëO DE ORDEN (tradeAmountUSD) ===\n        // SMART_GUARD v2: sgMinEntryUsd es un \"objetivo preferido\", no un bloqueo\n        // - Si saldo >= sgMinEntryUsd ‚Üí usar sgMinEntryUsd exactamente (no m√°s)\n        // - Si saldo < sgMinEntryUsd ‚Üí fallback autom√°tico a saldo disponible\n        // - floorUsd = max(exchangeMin, absoluteMin) ‚Üí hard block si saldo < floorUsd\n        let tradeAmountUSD: number;\n        let wasAdjusted = false;\n        let originalAmount: number;\n        let sgReasonCode: SmartGuardReasonCode | undefined;\n        \n        // Para SMART_GUARD: calcular orderUsdProposed por l√≥gica normal, luego validar m√≠nimos\n        const sgParams = positionMode === \"SMART_GUARD\" ? this.getSmartGuardParams(pair, botConfig) : null;\n        const sgMinEntryUsd = sgParams?.sgMinEntryUsd || 100;\n        const sgAllowUnderMin = sgParams?.sgAllowUnderMin ?? true; // DEPRECATED - se ignora\n        const sgFeeCushionPct = sgParams?.sgFeeCushionPct || 0;\n        const sgFeeCushionAuto = sgParams?.sgFeeCushionAuto ?? false;\n        \n        // Calcular fee cushion efectivo (auto = 2 * KRAKEN_FEE_PCT)\n        const effectiveCushionPct = sgFeeCushionAuto ? (KRAKEN_FEE_PCT * 2) : sgFeeCushionPct;\n        \n        // usdDisponible = saldo real disponible (sin buffer en SMART_GUARD v2 para sizing exacto)\n        const usdDisponible = freshUsdBalance;\n        \n        // === NUEVA L√ìGICA SMART_GUARD v2 ===\n        // floorUsd = max(minOrderExchangeUsd, MIN_ORDER_ABSOLUTE_USD) - HARD BLOCK\n        const floorUsd = Math.max(SG_ABSOLUTE_MIN_USD, minRequiredUSD);\n        \n        // availableAfterCushion = saldo menos reserva para fees\n        const cushionAmount = freshUsdBalance * (effectiveCushionPct / 100);\n        const availableAfterCushion = usdDisponible - cushionAmount;\n        \n        if (positionMode === \"SMART_GUARD\") {\n          // === SMART_GUARD v2 SIZING ===\n          // Regla 1: sgMinEntryUsd es \"objetivo preferido\"\n          // Regla 2: Si saldo >= sgMinEntryUsd ‚Üí usar sgMinEntryUsd EXACTO\n          // Regla 3: Si saldo < sgMinEntryUsd ‚Üí fallback a saldo disponible (si >= floorUsd)\n          // Regla 4: Si saldo < floorUsd ‚Üí BLOQUEAR\n          \n          originalAmount = sgMinEntryUsd; // El objetivo propuesto siempre es sgMinEntryUsd\n          \n          if (availableAfterCushion >= sgMinEntryUsd) {\n            // Caso A: Saldo suficiente ‚Üí usar sgMinEntryUsd EXACTO (no m√°s)\n            tradeAmountUSD = sgMinEntryUsd;\n            sgReasonCode = \"SMART_GUARD_ENTRY_USING_CONFIG_MIN\";\n            \n          } else if (availableAfterCushion >= floorUsd) {\n            // Caso B: Saldo insuficiente para config, pero >= floorUsd ‚Üí fallback autom√°tico\n            tradeAmountUSD = availableAfterCushion;\n            sgReasonCode = \"SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE\";\n            \n          } else if (usdDisponible >= floorUsd && availableAfterCushion < floorUsd) {\n            // Caso C: Fee cushion lo baja de floorUsd ‚Üí se bloquear√° en validaci√≥n\n            tradeAmountUSD = availableAfterCushion;\n            sgReasonCode = \"SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION\";\n            \n          } else {\n            // Caso D: Saldo < floorUsd ‚Üí se bloquear√° en validaci√≥n\n            tradeAmountUSD = usdDisponible;\n            sgReasonCode = \"SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN\";\n          }\n          \n          log(`SMART_GUARD ${pair}: Sizing v2 - order=$${tradeAmountUSD.toFixed(2)}, reason=${sgReasonCode}`, \"trading\");\n          log(`  ‚Üí availableUsd=$${usdDisponible.toFixed(2)}, sgMinEntryUsd=$${sgMinEntryUsd.toFixed(2)}, floorUsd=$${floorUsd.toFixed(2)} [exch=$${minRequiredUSD.toFixed(2)}, abs=$${SG_ABSOLUTE_MIN_USD}]`, \"trading\");\n          log(`  ‚Üí cushionPct=${effectiveCushionPct.toFixed(2)}%, cushionAmt=$${cushionAmount.toFixed(2)}, availableAfterCushion=$${availableAfterCushion.toFixed(2)}`, \"trading\");\n          log(`  ‚Üí sgAllowUnderMin=${sgAllowUnderMin} (DEPRECATED - ignorado, siempre fallback autom√°tico)`, \"trading\");\n          \n          // La validaci√≥n final de m√≠nimos se hace DESPU√âS con validateMinimumsOrSkip()\n        } else {\n          // Modos SINGLE/DCA: l√≥gica original con exposure limits\n          \n          // Verificar que el take-profit sea rentable despu√©s de comisiones\n          const profitCheck = this.isProfitableAfterFees(takeProfitPct);\n          if (!profitCheck.isProfitable) {\n            log(`${pair}: Trade rechazado - Take-Profit (${takeProfitPct}%) < m√≠nimo rentable (${profitCheck.minProfitRequired.toFixed(2)}%). Fees round-trip: ${profitCheck.roundTripFees.toFixed(2)}%`, \"trading\");\n            \n            await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - take-profit menor que fees`, {\n              pair,\n              signal: \"BUY\",\n              reason: \"LOW_PROFITABILITY\",\n              takeProfitPct,\n              roundTripFees: profitCheck.roundTripFees,\n              minProfitRequired: profitCheck.minProfitRequired,\n              netExpectedProfit: profitCheck.netExpectedProfit,\n            });\n            \n            return;\n          }\n          \n          tradeAmountUSD = freshUsdBalance * (riskPerTradePct / 100);\n          tradeAmountUSD = Math.min(tradeAmountUSD, riskConfig.maxTradeUSD);\n\n          // MEJORA 3: Position sizing din√°mico basado en confianza\n          const confidenceFactor = this.getConfidenceSizingFactor(signal.confidence);\n          const originalBeforeConfidence = tradeAmountUSD;\n          tradeAmountUSD = tradeAmountUSD * confidenceFactor;\n          \n          if (confidenceFactor < 1.0) {\n            log(`${pair}: Sizing ajustado por confianza (${(signal.confidence * 100).toFixed(0)}%): $${originalBeforeConfidence.toFixed(2)} -> $${tradeAmountUSD.toFixed(2)} (${(confidenceFactor * 100).toFixed(0)}%)`, \"trading\");\n          }\n\n          if (tradeAmountUSD < minRequiredUSD && freshUsdBalance >= minRequiredUSD) {\n            const smallAccountAmount = freshUsdBalance * SMALL_ACCOUNT_FACTOR;\n            tradeAmountUSD = Math.min(smallAccountAmount, riskConfig.maxTradeUSD);\n          }\n          \n          originalAmount = tradeAmountUSD;\n        }\n\n        const exposure = this.getAvailableExposure(pair, botConfig, freshUsdBalance);\n        const maxByBalance = Math.max(0, freshUsdBalance * 0.95);\n        // POL√çTICA UNIFICADA: SMART_GUARD S√ç respeta maxTotalExposurePct para evitar sobreapalancamiento\n        // Pero NO aplica maxPairExposurePct (permite concentraci√≥n en un par si hay se√±al fuerte)\n        const effectiveMaxAllowed = positionMode === \"SMART_GUARD\" \n          ? Math.min(exposure.maxTotalAvailable, maxByBalance)  // Solo limita por exposici√≥n TOTAL\n          : Math.min(exposure.maxAllowed, maxByBalance);  // SINGLE/DCA limita por par Y total\n        \n        if (effectiveMaxAllowed < minRequiredUSD) {\n          log(`${pair}: Sin exposici√≥n disponible. Disponible: $${effectiveMaxAllowed.toFixed(2)}, M√≠nimo: $${minRequiredUSD.toFixed(2)}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - sin exposici√≥n disponible`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"EXPOSURE_ZERO\",\n            exposureAvailable: effectiveMaxAllowed,\n            minRequiredUsd: minRequiredUSD,\n          });\n          this.setPairCooldown(pair);\n          \n          if (this.shouldSendExposureAlert(pair)) {\n            await botLogger.info(\"PAIR_COOLDOWN\", `${pair} en cooldown - sin exposici√≥n disponible`, {\n              pair,\n              maxAllowed: effectiveMaxAllowed,\n              minRequired: minRequiredUSD,\n              cooldownMinutes: this.COOLDOWN_DURATION_MS / 60000,\n            });\n\n            if (this.telegramService.isInitialized()) {\n              await this.telegramService.sendAlertToMultipleChats(`\n‚è∏Ô∏è *Par en Espera*\n\n*${pair}* sin exposici√≥n disponible.\n*Disponible:* $${exposure.maxAllowed.toFixed(2)}\n*M√≠nimo requerido:* $${minRequiredUSD.toFixed(2)}\n\n_Cooldown: ${this.COOLDOWN_DURATION_MS / 60000} min. Se reintentar√° autom√°ticamente._\n              `.trim(), \"system\");\n            }\n          }\n          return;\n        }\n\n        // Ajustar por l√≠mite de exposici√≥n (solo para SINGLE/DCA, SMART_GUARD ya valid√≥ arriba)\n        if (positionMode !== \"SMART_GUARD\" && tradeAmountUSD > effectiveMaxAllowed) {\n          originalAmount = tradeAmountUSD;\n          tradeAmountUSD = effectiveMaxAllowed;\n          wasAdjusted = true;\n          \n          log(`${pair}: Trade ajustado de $${originalAmount.toFixed(2)} a $${tradeAmountUSD.toFixed(2)} (l√≠mite exposici√≥n)`, \"trading\");\n          \n          await botLogger.info(\"TRADE_ADJUSTED\", `Trade ajustado por l√≠mite de exposici√≥n`, {\n            pair,\n            originalAmountUsd: originalAmount,\n            adjustedAmountUsd: tradeAmountUSD,\n            maxPairAvailable: exposure.maxPairAvailable,\n            maxTotalAvailable: exposure.maxTotalAvailable,\n            riskPerTradePct,\n          });\n        }\n\n        const tradeVolume = tradeAmountUSD / currentPrice;\n\n        if (tradeVolume < minVolume) {\n          log(`${pair}: Volumen ${tradeVolume.toFixed(8)} < m√≠nimo ${minVolume}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - volumen < m√≠nimo`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"VOLUME_BELOW_MINIMUM\",\n            calculatedVolume: tradeVolume,\n            minVolume,\n          });\n          this.setPairCooldown(pair);\n          return;\n        }\n\n        // === VALIDACI√ìN FINAL √öNICA Y CENTRALIZADA (fuente de verdad) ===\n        // Se ejecuta ANTES de executeTrade() para REAL y DRY_RUN\n        const orderUsdFinal = tradeAmountUSD;\n        const envPrefix = environment.isReplit ? \"REPLIT/DEV\" : \"NAS/PROD\";\n        const currentOpenLotsForLog = this.countLotsForPair(pair);\n        const sgMaxLotsPerPairConfig = botConfig?.sgMaxOpenLotsPerPair ?? 1;\n        const maxLotsForModeConfig = positionMode === \"SMART_GUARD\" ? sgMaxLotsPerPairConfig : 1;\n        \n        const validationResult = validateMinimumsOrSkip({\n          positionMode,\n          orderUsdFinal,\n          orderUsdProposed: originalAmount || tradeAmountUSD,\n          usdDisponible: freshUsdBalance,\n          exposureAvailable: effectiveMaxAllowed,\n          pair,\n          sgMinEntryUsd,\n          sgAllowUnderMin, // DEPRECATED - se ignora en validaci√≥n\n          dryRun: this.dryRunMode,\n          env: envPrefix,\n          floorUsd: positionMode === \"SMART_GUARD\" ? floorUsd : undefined,\n          availableAfterCushion: positionMode === \"SMART_GUARD\" ? availableAfterCushion : undefined,\n        });\n        \n        if (!validationResult.valid) {\n          // === [BUY_EVAL] LOGS v2: Valores detallados para auditor√≠a ===\n          log(`[BUY_EVAL] ${pair}: mode=${positionMode}, sgReasonCode=${sgReasonCode}`, \"trading\");\n          log(`[BUY_EVAL] ${pair}: availableUsd=$${usdDisponible.toFixed(2)}, sgMinEntryUsd=$${sgMinEntryUsd.toFixed(2)}, floorUsd=$${floorUsd.toFixed(2)}`, \"trading\");\n          log(`[BUY_EVAL] ${pair}: orderUsd=$${orderUsdFinal.toFixed(2)}, availableAfterCushion=$${availableAfterCushion.toFixed(2)}`, \"trading\");\n          log(`[BUY_EVAL] ${pair}: currentOpenLots=${currentOpenLotsForLog}/${maxLotsForModeConfig}`, \"trading\");\n          log(`[BUY_EVAL] ${pair}: DECISION skipReason=${validationResult.skipReason} msg=${validationResult.message}`, \"trading\");\n          log(`[FINAL CHECK] ${pair}: SKIP - ${validationResult.message}`, \"trading\");\n          \n          this.lastScanResults.set(pair, {\n            signal: \"BUY\",\n            reason: validationResult.skipReason!,\n            exposureAvailable: orderUsdFinal,\n          });\n          \n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY bloqueada - ${validationResult.skipReason}`, {\n            pair,\n            signal: \"BUY\",\n            reason: validationResult.skipReason,\n            sgReasonCode,\n            ...validationResult.meta,\n          });\n          \n          this.setPairCooldown(pair);\n          return;\n        }\n        \n        // Log de decisi√≥n final antes de ejecutar (con nuevo reason code)\n        if (positionMode === \"SMART_GUARD\" && sgReasonCode) {\n          log(`[FINAL CHECK] ${pair}: ALLOWED - ${sgReasonCode} orderUsd=$${orderUsdFinal.toFixed(2)}`, \"trading\");\n        }\n\n        if (wasAdjusted) {\n          log(`${pair}: Ejecutando compra AJUSTADA $${tradeAmountUSD.toFixed(2)} (original: $${originalAmount.toFixed(2)})`, \"trading\");\n        } else {\n          log(`${pair}: Ejecutando compra $${tradeAmountUSD.toFixed(2)} (${riskPerTradePct}% de $${freshUsdBalance.toFixed(2)})`, \"trading\");\n        }\n\n        const adjustmentInfo = wasAdjusted ? {\n          wasAdjusted: true,\n          originalAmountUsd: originalAmount,\n          adjustedAmountUsd: tradeAmountUSD\n        } : undefined;\n        \n        // Meta completa para trazabilidad v2\n        const executionMeta = {\n          mode: positionMode,\n          usdDisponible: freshUsdBalance,\n          orderUsdProposed: originalAmount || tradeAmountUSD,\n          orderUsdFinal,\n          sgMinEntryUsd,\n          floorUsd,\n          availableAfterCushion,\n          sgReasonCode,\n          sgAllowUnderMin_DEPRECATED: sgAllowUnderMin,\n          dryRun: this.dryRunMode,\n          env: envPrefix,\n        };\n\n        const success = await this.executeTrade(pair, \"buy\", tradeVolume.toFixed(8), currentPrice, signal.reason, adjustmentInfo, undefined, executionMeta);\n        if (success) {\n          this.lastTradeTime.set(pair, Date.now());\n        }\n\n      } else if (signal.action === \"sell\") {\n        if (assetBalance <= 0 && (!existingPosition || existingPosition.amount <= 0)) {\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al SELL ignorada - sin posici√≥n para vender`, {\n            pair,\n            signal: \"SELL\",\n            reason: \"NO_POSITION\",\n            assetBalance,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        // === FIX: Vender lote completo, no 50% ===\n        // Usar min(lot.amount, realAssetBalance) para evitar insufficient funds\n        // Si no hay lot trackeado, usar balance real del wallet\n        const lotAmount = existingPosition?.amount ?? assetBalance;\n        const realAssetBalance = assetBalance;\n        const rawSellVolume = Math.min(lotAmount, realAssetBalance);\n        \n        // Normalizar al stepSize de Kraken para evitar errores de precisi√≥n\n        const sellVolume = this.normalizeVolume(pair, rawSellVolume);\n        \n        const minVolumeSell = this.getOrderMin(pair);\n        const sellValueUsd = sellVolume * currentPrice;\n\n        // === DUST DETECTION: No intentar vender si es dust ===\n        if (sellVolume < minVolumeSell) {\n          await botLogger.info(\"TRADE_SKIPPED\", `SELL skipped - dust position (volumen < m√≠nimo)`, {\n            pair,\n            signal: \"SELL\",\n            reason: \"DUST_POSITION\",\n            lotAmount,\n            realAssetBalance,\n            sellVolume,\n            minVolume: minVolumeSell,\n            sellValueUsd,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n        \n        if (sellValueUsd < DUST_THRESHOLD_USD) {\n          await botLogger.info(\"TRADE_SKIPPED\", `SELL skipped - dust position (valor < $${DUST_THRESHOLD_USD})`, {\n            pair,\n            signal: \"SELL\",\n            reason: \"DUST_POSITION\",\n            lotAmount,\n            realAssetBalance,\n            sellVolume,\n            sellValueUsd,\n            dustThresholdUsd: DUST_THRESHOLD_USD,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        log(`${pair}: SELL signal - vendiendo ${sellVolume.toFixed(8)} (lot: ${lotAmount.toFixed(8)}, balance: ${realAssetBalance.toFixed(8)}, value: $${sellValueUsd.toFixed(2)})`, \"trading\");\n\n        const sellContext = existingPosition \n          ? { entryPrice: existingPosition.entryPrice, aiSampleId: existingPosition.aiSampleId }\n          : undefined;\n        const success = await this.executeTrade(pair, \"sell\", sellVolume.toFixed(8), currentPrice, signal.reason, undefined, undefined, undefined, sellContext);\n        if (success) {\n          this.lastTradeTime.set(pair, Date.now());\n        }\n      }\n    } catch (error: any) {\n      log(`Error analizando ${pair}: ${error.message}`, \"trading\");\n    }\n  }\n\n  private async analyzePairAndTradeWithCandles(\n    pair: string,\n    timeframe: string,\n    candle: OHLCCandle,\n    riskConfig: RiskConfig,\n    balances: any\n  ) {\n    try {\n      const lastTrade = this.lastTradeTime.get(pair) || 0;\n      if (Date.now() - lastTrade < this.MIN_TRADE_INTERVAL_MS) {\n        return;\n      }\n\n      const signal = await this.analyzeWithCandleStrategy(pair, timeframe, candle);\n      const strategyId = `momentum_candles_${timeframe}`;\n      \n      // Registrar resultado del escaneo para candles\n      const signalStr = signal.action === \"hold\" ? \"NONE\" : signal.action.toUpperCase();\n      const botConfigForScan = await storage.getBotConfig();\n      const exposureScan = this.getAvailableExposure(pair, botConfigForScan, this.currentUsdBalance);\n      this.lastScanResults.set(pair, {\n        signal: signalStr,\n        reason: signal.reason || \"Sin se√±al\",\n        cooldownSec: this.getCooldownRemainingSec(pair),\n        exposureAvailable: exposureScan.maxAllowed,\n      });\n      \n      if (signal.action === \"hold\" || signal.confidence < 0.6) {\n        return;\n      }\n\n      const krakenPair = this.formatKrakenPair(pair);\n      const ticker = await this.krakenService.getTicker(krakenPair);\n      const tickerData: any = Object.values(ticker)[0];\n      if (!tickerData) return;\n\n      const currentPrice = parseFloat(tickerData.c?.[0] || \"0\");\n      const assetBalance = this.getAssetBalance(pair, balances);\n      const existingPositions = this.getPositionsByPair(pair);\n      const existingPosition = existingPositions[0];\n\n      if (signal.action === \"buy\") {\n        if (this.isPairInCooldown(pair)) {\n          const cooldownSec = this.getCooldownRemainingSec(pair);\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - par en cooldown`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"PAIR_COOLDOWN\",\n            cooldownRemainingSec: cooldownSec,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        // MODO SINGLE o SMART_GUARD: Bloquear compras si ya hay posici√≥n abierta\n        const botConfigCheck = await storage.getBotConfig();\n        const positionMode = botConfigCheck?.positionMode || \"SINGLE\";\n        const sgMaxLotsPerPair = botConfigCheck?.sgMaxOpenLotsPerPair ?? 1;\n        \n        // En SINGLE siempre 1 slot. En SMART_GUARD respetamos sgMaxOpenLotsPerPair.\n        const maxLotsForMode = positionMode === \"SMART_GUARD\" ? sgMaxLotsPerPair : 1;\n        const currentOpenLots = this.countLotsForPair(pair);\n        \n        if ((positionMode === \"SINGLE\" || positionMode === \"SMART_GUARD\") && currentOpenLots >= maxLotsForMode) {\n          const reasonCode = positionMode === \"SMART_GUARD\" \n            ? \"SMART_GUARD_MAX_LOTS_REACHED\" \n            : \"SINGLE_MODE_POSITION_EXISTS\";\n          \n          log(`${pair}: Compra bloqueada - Modo ${positionMode}, lotes abiertos ${currentOpenLots}/${maxLotsForMode}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - m√°ximo de lotes alcanzado`, {\n            pair,\n            signal: \"BUY\",\n            reason: reasonCode,\n            currentOpenLots,\n            maxOpenLots: maxLotsForMode,\n            existingAmount: existingPosition?.amount || 0,\n            signalReason: signal.reason,\n          });\n          this.lastScanResults.set(pair, {\n            signal: \"BUY\",\n            reason: reasonCode,\n            exposureAvailable: 0,\n          });\n          return;\n        }\n\n        if (this.isPairInStopLossCooldown(pair)) {\n          const cooldownSec = this.getStopLossCooldownRemainingSec(pair);\n          log(`${pair}: En cooldown post stop-loss`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - cooldown post stop-loss`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"STOPLOSS_COOLDOWN\",\n            cooldownRemainingSec: cooldownSec,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        const spreadCheck = this.isSpreadAcceptable(tickerData);\n        if (!spreadCheck.acceptable) {\n          log(`${pair}: Spread demasiado alto (${spreadCheck.spreadPct.toFixed(3)}% > ${MAX_SPREAD_PCT}%)`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - spread alto`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"SPREAD_TOO_HIGH\",\n            spreadPct: spreadCheck.spreadPct,\n            maxSpreadPct: MAX_SPREAD_PCT,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        if (existingPosition && existingPosition.amount * currentPrice > riskConfig.maxTradeUSD * 2) {\n          log(`Posici√≥n existente en ${pair} ya es grande: $${(existingPosition.amount * currentPrice).toFixed(2)}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - posici√≥n existente demasiado grande`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"POSITION_TOO_LARGE\",\n            currentPositionUsd: existingPosition.amount * currentPrice,\n            maxTradeUsd: riskConfig.maxTradeUSD * 2,\n          });\n          return;\n        }\n\n        const minVolume = this.getOrderMin(pair);\n        const minRequiredUSD = minVolume * currentPrice;\n        const freshUsdBalance = parseFloat(balances?.ZUSD || balances?.USD || \"0\");\n\n        if (freshUsdBalance < minRequiredUSD) {\n          log(`Saldo USD insuficiente para ${pair}: $${freshUsdBalance.toFixed(2)} < $${minRequiredUSD.toFixed(2)}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - fondos insuficientes`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"INSUFFICIENT_FUNDS\",\n            availableUsd: freshUsdBalance,\n            minRequiredUsd: minRequiredUSD,\n          });\n          this.setPairCooldown(pair);\n          return;\n        }\n\n        const botConfig = await storage.getBotConfig();\n        const riskPerTradePct = parseFloat(botConfig?.riskPerTradePct?.toString() || \"15\");\n        const takeProfitPct = parseFloat(botConfig?.takeProfitPercent?.toString() || \"7\");\n        \n        // === C√ÅLCULO DE TAMA√ëO DE ORDEN (tradeAmountUSD) - UNIFICADO CON analyzePairAndTrade ===\n        let tradeAmountUSD: number;\n        let wasAdjusted = false;\n        let originalAmount: number;\n        let sgReasonCode: SmartGuardReasonCode | undefined;\n        \n        // SMART_GUARD: obtener par√°metros\n        const sgParams = positionMode === \"SMART_GUARD\" ? this.getSmartGuardParams(pair, botConfig) : null;\n        const sgMinEntryUsd = sgParams?.sgMinEntryUsd || 100;\n        const sgAllowUnderMin = sgParams?.sgAllowUnderMin ?? true;\n        const sgFeeCushionPct = sgParams?.sgFeeCushionPct || 0;\n        const sgFeeCushionAuto = sgParams?.sgFeeCushionAuto ?? false;\n        \n        const effectiveCushionPct = sgFeeCushionAuto ? (KRAKEN_FEE_PCT * 2) : sgFeeCushionPct;\n        const usdDisponible = freshUsdBalance;\n        const floorUsd = Math.max(SG_ABSOLUTE_MIN_USD, minRequiredUSD);\n        const cushionAmount = freshUsdBalance * (effectiveCushionPct / 100);\n        const availableAfterCushion = usdDisponible - cushionAmount;\n        \n        if (positionMode === \"SMART_GUARD\") {\n          // === SMART_GUARD v2 SIZING (mismo que analyzePairAndTrade) ===\n          originalAmount = sgMinEntryUsd;\n          \n          if (availableAfterCushion >= sgMinEntryUsd) {\n            tradeAmountUSD = sgMinEntryUsd;\n            sgReasonCode = \"SMART_GUARD_ENTRY_USING_CONFIG_MIN\";\n          } else if (availableAfterCushion >= floorUsd) {\n            tradeAmountUSD = availableAfterCushion;\n            sgReasonCode = \"SMART_GUARD_ENTRY_FALLBACK_TO_AVAILABLE\";\n          } else if (usdDisponible >= floorUsd && availableAfterCushion < floorUsd) {\n            tradeAmountUSD = availableAfterCushion;\n            sgReasonCode = \"SMART_GUARD_BLOCKED_AFTER_FEE_CUSHION\";\n          } else {\n            tradeAmountUSD = usdDisponible;\n            sgReasonCode = \"SMART_GUARD_BLOCKED_BELOW_EXCHANGE_MIN\";\n          }\n          \n          log(`SMART_GUARD ${pair} [${strategyId}]: Sizing v2 - order=$${tradeAmountUSD.toFixed(2)}, reason=${sgReasonCode}`, \"trading\");\n          log(`  ‚Üí availableUsd=$${usdDisponible.toFixed(2)}, sgMinEntryUsd=$${sgMinEntryUsd.toFixed(2)}, floorUsd=$${floorUsd.toFixed(2)}`, \"trading\");\n        } else {\n          // Modos SINGLE/DCA: l√≥gica original\n          const profitCheck = this.isProfitableAfterFees(takeProfitPct);\n          if (!profitCheck.isProfitable) {\n            log(`${pair}: Trade rechazado - Take-Profit (${takeProfitPct}%) < m√≠nimo rentable`, \"trading\");\n            await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - take-profit menor que fees`, {\n              pair,\n              signal: \"BUY\",\n              reason: \"LOW_PROFITABILITY\",\n              takeProfitPct,\n              roundTripFees: profitCheck.roundTripFees,\n              minProfitRequired: profitCheck.minProfitRequired,\n              strategyId,\n            });\n            return;\n          }\n          \n          tradeAmountUSD = freshUsdBalance * (riskPerTradePct / 100);\n          tradeAmountUSD = Math.min(tradeAmountUSD, riskConfig.maxTradeUSD);\n\n          const confidenceFactor = this.getConfidenceSizingFactor(signal.confidence);\n          tradeAmountUSD = tradeAmountUSD * confidenceFactor;\n\n          if (tradeAmountUSD < minRequiredUSD && freshUsdBalance >= minRequiredUSD) {\n            const smallAccountAmount = freshUsdBalance * SMALL_ACCOUNT_FACTOR;\n            tradeAmountUSD = Math.min(smallAccountAmount, riskConfig.maxTradeUSD);\n          }\n          \n          originalAmount = tradeAmountUSD;\n        }\n\n        const exposure = this.getAvailableExposure(pair, botConfig, freshUsdBalance);\n        const maxByBalance = Math.max(0, freshUsdBalance * 0.95);\n        const effectiveMaxAllowed = positionMode === \"SMART_GUARD\"\n          ? Math.min(exposure.maxTotalAvailable, maxByBalance)\n          : Math.min(exposure.maxAllowed, maxByBalance);\n        \n        if (effectiveMaxAllowed < minRequiredUSD) {\n          log(`${pair}: Sin exposici√≥n disponible`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - sin exposici√≥n disponible`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"EXPOSURE_ZERO\",\n            exposureAvailable: effectiveMaxAllowed,\n            minRequiredUsd: minRequiredUSD,\n          });\n          this.setPairCooldown(pair);\n          return;\n        }\n\n        // Ajustar por l√≠mite de exposici√≥n (solo para SINGLE/DCA)\n        if (positionMode !== \"SMART_GUARD\" && tradeAmountUSD > effectiveMaxAllowed) {\n          originalAmount = tradeAmountUSD;\n          tradeAmountUSD = effectiveMaxAllowed;\n          wasAdjusted = true;\n        }\n\n        const tradeVolume = tradeAmountUSD / currentPrice;\n\n        if (tradeVolume < minVolume) {\n          log(`${pair}: Volumen ${tradeVolume.toFixed(8)} < m√≠nimo ${minVolume}`, \"trading\");\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al BUY ignorada - volumen < m√≠nimo`, {\n            pair,\n            signal: \"BUY\",\n            reason: \"VOLUME_BELOW_MINIMUM\",\n            calculatedVolume: tradeVolume,\n            minVolume,\n            strategyId,\n          });\n          this.setPairCooldown(pair);\n          return;\n        }\n\n        const adjustmentInfo = wasAdjusted ? {\n          wasAdjusted: true,\n          originalAmountUsd: originalAmount,\n          adjustedAmountUsd: tradeAmountUSD\n        } : undefined;\n\n        const success = await this.executeTrade(\n          pair, \n          \"buy\", \n          tradeVolume.toFixed(8), \n          currentPrice, \n          `${signal.reason} [${strategyId}]`, \n          adjustmentInfo,\n          { strategyId, timeframe, confidence: signal.confidence }\n        );\n        \n        if (success) {\n          this.lastTradeTime.set(pair, Date.now());\n        }\n\n      } else if (signal.action === \"sell\") {\n        if (assetBalance <= 0 && (!existingPosition || existingPosition.amount <= 0)) {\n          await botLogger.info(\"TRADE_SKIPPED\", `Se√±al SELL ignorada - sin posici√≥n para vender`, {\n            pair,\n            signal: \"SELL\",\n            reason: \"NO_POSITION\",\n            assetBalance,\n            strategyId,\n            signalReason: signal.reason,\n          });\n          return;\n        }\n\n        // === FIX: Vender lote completo, no 50% ===\n        // Si no hay lot trackeado, usar balance real del wallet\n        const lotAmount = existingPosition?.amount ?? assetBalance;\n        const realAssetBalance = assetBalance;\n        const rawSellVolume = Math.min(lotAmount, realAssetBalance);\n        const sellVolume = this.normalizeVolume(pair, rawSellVolume);\n        \n        const minVolumeSell = this.getOrderMin(pair);\n        const sellValueUsd = sellVolume * currentPrice;\n\n        // === DUST DETECTION ===\n        if (sellVolume < minVolumeSell) {\n          await botLogger.info(\"TRADE_SKIPPED\", `SELL skipped - dust position (volumen < m√≠nimo)`, {\n            pair,\n            signal: \"SELL\",\n            reason: \"DUST_POSITION\",\n            lotAmount,\n            realAssetBalance,\n            sellVolume,\n            minVolume: minVolumeSell,\n            sellValueUsd,\n            strategyId,\n          });\n          return;\n        }\n        \n        if (sellValueUsd < DUST_THRESHOLD_USD) {\n          await botLogger.info(\"TRADE_SKIPPED\", `SELL skipped - dust position (valor < $${DUST_THRESHOLD_USD})`, {\n            pair,\n            signal: \"SELL\",\n            reason: \"DUST_POSITION\",\n            lotAmount,\n            realAssetBalance,\n            sellVolume,\n            sellValueUsd,\n            dustThresholdUsd: DUST_THRESHOLD_USD,\n            strategyId,\n          });\n          return;\n        }\n\n        log(`${pair}: SELL signal [${strategyId}] - vendiendo ${sellVolume.toFixed(8)} (value: $${sellValueUsd.toFixed(2)})`, \"trading\");\n\n        const sellContext = existingPosition \n          ? { entryPrice: existingPosition.entryPrice, aiSampleId: existingPosition.aiSampleId }\n          : undefined;\n        const success = await this.executeTrade(pair, \"sell\", sellVolume.toFixed(8), currentPrice, `${signal.reason} [${strategyId}]`, undefined, undefined, undefined, sellContext);\n        if (success) {\n          this.lastTradeTime.set(pair, Date.now());\n        }\n      }\n    } catch (error: any) {\n      log(`Error analizando ${pair} con velas: ${error.message}`, \"trading\");\n    }\n  }\n\n  private async analyzeWithStrategy(\n    strategy: string,\n    pair: string,\n    history: PriceData[],\n    currentPrice: number\n  ): Promise<TradeSignal> {\n    const mtfData = await this.getMultiTimeframeData(pair);\n    const mtfAnalysis = mtfData ? this.analyzeMultiTimeframe(mtfData) : null;\n\n    let signal: TradeSignal;\n    switch (strategy) {\n      case \"momentum\":\n        signal = this.momentumStrategy(pair, history, currentPrice);\n        break;\n      case \"mean_reversion\":\n        signal = this.meanReversionStrategy(pair, history, currentPrice);\n        break;\n      case \"scalping\":\n        signal = this.scalpingStrategy(pair, history, currentPrice);\n        break;\n      case \"grid\":\n        signal = this.gridStrategy(pair, history, currentPrice);\n        break;\n      default:\n        return { action: \"hold\", pair, confidence: 0, reason: \"Estrategia desconocida\" };\n    }\n\n    if (mtfAnalysis && signal.action !== \"hold\") {\n      const mtfBoost = this.applyMTFFilter(signal, mtfAnalysis);\n      if (mtfBoost.filtered) {\n        return { action: \"hold\", pair, confidence: 0.3, reason: `Se√±al filtrada por MTF: ${mtfBoost.reason}` };\n      }\n      signal.confidence = Math.min(0.95, signal.confidence + mtfBoost.confidenceBoost);\n      signal.reason += ` | MTF: ${mtfAnalysis.summary}`;\n    }\n\n    return signal;\n  }\n\n  private applyMTFFilter(signal: TradeSignal, mtf: TrendAnalysis): { filtered: boolean; confidenceBoost: number; reason: string } {\n    if (signal.action === \"buy\") {\n      if (mtf.longTerm === \"bearish\" && mtf.mediumTerm === \"bearish\") {\n        return { filtered: true, confidenceBoost: 0, reason: \"Tendencia 1h y 4h bajista\" };\n      }\n      if (mtf.alignment < -0.5) {\n        return { filtered: true, confidenceBoost: 0, reason: `Alineaci√≥n MTF negativa (${mtf.alignment.toFixed(2)})` };\n      }\n      if (mtf.alignment > 0.5) {\n        return { filtered: false, confidenceBoost: 0.15, reason: \"Confirmado por MTF alcista\" };\n      }\n      if (mtf.longTerm === \"bullish\") {\n        return { filtered: false, confidenceBoost: 0.1, reason: \"Tendencia 4h alcista\" };\n      }\n    }\n\n    if (signal.action === \"sell\") {\n      if (mtf.longTerm === \"bullish\" && mtf.mediumTerm === \"bullish\") {\n        return { filtered: true, confidenceBoost: 0, reason: \"Tendencia 1h y 4h alcista\" };\n      }\n      if (mtf.alignment > 0.5) {\n        return { filtered: true, confidenceBoost: 0, reason: `Alineaci√≥n MTF positiva (${mtf.alignment.toFixed(2)})` };\n      }\n      if (mtf.alignment < -0.5) {\n        return { filtered: false, confidenceBoost: 0.15, reason: \"Confirmado por MTF bajista\" };\n      }\n      if (mtf.longTerm === \"bearish\") {\n        return { filtered: false, confidenceBoost: 0.1, reason: \"Tendencia 4h bajista\" };\n      }\n    }\n\n    return { filtered: false, confidenceBoost: 0, reason: \"Sin filtro MTF aplicado\" };\n  }\n\n  private momentumStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {\n    const prices = history.map(h => h.price);\n    const shortEMA = this.calculateEMA(prices.slice(-10), 10);\n    const longEMA = this.calculateEMA(prices.slice(-20), 20);\n    const rsi = this.calculateRSI(prices.slice(-14));\n    const macd = this.calculateMACD(prices);\n    const bollinger = this.calculateBollingerBands(prices);\n    const volumeAnalysis = this.detectAbnormalVolume(history);\n    \n    const trend = (currentPrice - prices[0]) / prices[0] * 100;\n    \n    let buySignals = 0;\n    let sellSignals = 0;\n    const reasons: string[] = [];\n\n    if (shortEMA > longEMA) buySignals++;\n    else if (shortEMA < longEMA) sellSignals++;\n\n    if (rsi < 30) { buySignals += 2; reasons.push(`RSI sobrevendido (${rsi.toFixed(0)})`); }\n    else if (rsi < 45) { buySignals++; }\n    else if (rsi > 70) { sellSignals += 2; reasons.push(`RSI sobrecomprado (${rsi.toFixed(0)})`); }\n    else if (rsi > 55) { sellSignals++; }\n\n    if (macd.histogram > 0 && macd.macd > macd.signal) { buySignals++; reasons.push(\"MACD alcista\"); }\n    else if (macd.histogram < 0 && macd.macd < macd.signal) { sellSignals++; reasons.push(\"MACD bajista\"); }\n\n    if (bollinger.percentB < 20) { buySignals++; reasons.push(\"Precio cerca de Bollinger inferior\"); }\n    else if (bollinger.percentB > 80) { sellSignals++; reasons.push(\"Precio cerca de Bollinger superior\"); }\n\n    if (volumeAnalysis.isAbnormal) {\n      if (volumeAnalysis.direction === \"bullish\") { buySignals++; reasons.push(`Volumen alto alcista (${volumeAnalysis.ratio.toFixed(1)}x)`); }\n      else if (volumeAnalysis.direction === \"bearish\") { sellSignals++; reasons.push(`Volumen alto bajista (${volumeAnalysis.ratio.toFixed(1)}x)`); }\n    }\n\n    if (trend > 1) buySignals++;\n    else if (trend < -1) sellSignals++;\n\n    const confidence = Math.min(0.95, 0.5 + (Math.max(buySignals, sellSignals) * 0.08));\n    \n    if (buySignals >= 4 && buySignals > sellSignals && rsi < 70) {\n      return {\n        action: \"buy\",\n        pair,\n        confidence,\n        reason: `Momentum alcista: ${reasons.join(\", \")} | Se√±ales: ${buySignals} compra vs ${sellSignals} venta`,\n      };\n    }\n    \n    if (sellSignals >= 4 && sellSignals > buySignals && rsi > 30) {\n      return {\n        action: \"sell\",\n        pair,\n        confidence,\n        reason: `Momentum bajista: ${reasons.join(\", \")} | Se√±ales: ${sellSignals} venta vs ${buySignals} compra`,\n      };\n    }\n\n    return { action: \"hold\", pair, confidence: 0.3, reason: `Sin se√±al clara (${buySignals} compra / ${sellSignals} venta)` };\n  }\n\n  private meanReversionStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {\n    const prices = history.map(h => h.price);\n    const mean = prices.reduce((a, b) => a + b, 0) / prices.length;\n    const stdDev = Math.sqrt(prices.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / prices.length);\n    const zScore = (currentPrice - mean) / stdDev;\n    \n    const bollinger = this.calculateBollingerBands(prices);\n    const rsi = this.calculateRSI(prices.slice(-14));\n    const volumeAnalysis = this.detectAbnormalVolume(history);\n    \n    const reasons: string[] = [];\n    let confidence = 0.6;\n\n    if (zScore < -2 || bollinger.percentB < 5) {\n      confidence += 0.15;\n      reasons.push(`Extremadamente sobrevendido (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);\n      \n      if (rsi < 25) { confidence += 0.1; reasons.push(`RSI muy bajo (${rsi.toFixed(0)})`); }\n      if (volumeAnalysis.isAbnormal && volumeAnalysis.direction === \"bearish\") {\n        confidence += 0.05;\n        reasons.push(\"Volumen de capitulaci√≥n\");\n      }\n      \n      return {\n        action: \"buy\",\n        pair,\n        confidence: Math.min(0.95, confidence),\n        reason: `Mean Reversion COMPRA: ${reasons.join(\", \")}`,\n      };\n    }\n    \n    if (zScore < -1.5 || bollinger.percentB < 15) {\n      if (rsi < 35) { confidence += 0.1; reasons.push(`RSI bajo (${rsi.toFixed(0)})`); }\n      reasons.push(`Sobrevendido (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);\n      \n      return {\n        action: \"buy\",\n        pair,\n        confidence: Math.min(0.85, confidence),\n        reason: `Mean Reversion COMPRA: ${reasons.join(\", \")}`,\n      };\n    }\n    \n    if (zScore > 2 || bollinger.percentB > 95) {\n      confidence += 0.15;\n      reasons.push(`Extremadamente sobrecomprado (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);\n      \n      if (rsi > 75) { confidence += 0.1; reasons.push(`RSI muy alto (${rsi.toFixed(0)})`); }\n      if (volumeAnalysis.isAbnormal && volumeAnalysis.direction === \"bullish\") {\n        confidence += 0.05;\n        reasons.push(\"Volumen de euforia\");\n      }\n      \n      return {\n        action: \"sell\",\n        pair,\n        confidence: Math.min(0.95, confidence),\n        reason: `Mean Reversion VENTA: ${reasons.join(\", \")}`,\n      };\n    }\n    \n    if (zScore > 1.5 || bollinger.percentB > 85) {\n      if (rsi > 65) { confidence += 0.1; reasons.push(`RSI alto (${rsi.toFixed(0)})`); }\n      reasons.push(`Sobrecomprado (Z=${zScore.toFixed(2)}, %B=${bollinger.percentB.toFixed(0)})`);\n      \n      return {\n        action: \"sell\",\n        pair,\n        confidence: Math.min(0.85, confidence),\n        reason: `Mean Reversion VENTA: ${reasons.join(\", \")}`,\n      };\n    }\n\n    return { action: \"hold\", pair, confidence: 0.3, reason: `Precio en rango normal (Z=${zScore.toFixed(2)})` };\n  }\n\n  private scalpingStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {\n    if (history.length < 15) {\n      return { action: \"hold\", pair, confidence: 0, reason: \"Datos insuficientes para scalping\" };\n    }\n\n    const prices = history.map(h => h.price);\n    const recentPrices = prices.slice(-5);\n    const avgPrice = recentPrices.reduce((a, b) => a + b, 0) / recentPrices.length;\n    const priceChange = (currentPrice - avgPrice) / avgPrice * 100;\n    \n    const volatility = this.calculateVolatility(recentPrices);\n    const rsi = this.calculateRSI(prices.slice(-14));\n    const volumeAnalysis = this.detectAbnormalVolume(history);\n    const macd = this.calculateMACD(prices);\n    const atr = this.calculateATR(history, 14);\n    const atrPercent = this.calculateATRPercent(history, 14);\n    \n    const reasons: string[] = [];\n    let confidence = 0.65;\n\n    // Filtro de volatilidad m√≠nima usando ATR\n    if (atrPercent < 0.1) {\n      return { action: \"hold\", pair, confidence: 0.2, reason: `Volatilidad ATR muy baja (${atrPercent.toFixed(2)}%)` };\n    }\n\n    // Ajustar umbral de entrada basado en ATR\n    const entryThreshold = Math.max(0.2, atrPercent * 0.3);\n\n    if (priceChange < -entryThreshold && volatility > 0.15) {\n      reasons.push(`Ca√≠da r√°pida ${priceChange.toFixed(2)}%`);\n      reasons.push(`ATR: ${atrPercent.toFixed(2)}%`);\n      \n      if (volumeAnalysis.isAbnormal && volumeAnalysis.ratio > 1.5) {\n        confidence += 0.1;\n        reasons.push(`Volumen alto (${volumeAnalysis.ratio.toFixed(1)}x)`);\n      }\n      if (rsi < 40) {\n        confidence += 0.05;\n        reasons.push(`RSI bajo (${rsi.toFixed(0)})`);\n      }\n      if (macd.histogram < 0 && macd.histogram > -0.5) {\n        confidence += 0.05;\n        reasons.push(\"MACD cerca de cruce\");\n      }\n      // Bonus de confianza si ATR es alto (m√°s oportunidad de profit)\n      if (atrPercent > 0.5) {\n        confidence += 0.05;\n      }\n      \n      return {\n        action: \"buy\",\n        pair,\n        confidence: Math.min(0.9, confidence),\n        reason: `Scalping COMPRA: ${reasons.join(\", \")}`,\n      };\n    }\n    \n    if (priceChange > entryThreshold && volatility > 0.15) {\n      reasons.push(`Subida r√°pida +${priceChange.toFixed(2)}%`);\n      reasons.push(`ATR: ${atrPercent.toFixed(2)}%`);\n      \n      if (volumeAnalysis.isAbnormal && volumeAnalysis.ratio > 1.5) {\n        confidence += 0.1;\n        reasons.push(`Volumen alto (${volumeAnalysis.ratio.toFixed(1)}x)`);\n      }\n      if (rsi > 60) {\n        confidence += 0.05;\n        reasons.push(`RSI alto (${rsi.toFixed(0)})`);\n      }\n      if (atrPercent > 0.5) {\n        confidence += 0.05;\n      }\n      \n      return {\n        action: \"sell\",\n        pair,\n        confidence: Math.min(0.9, confidence),\n        reason: `Scalping VENTA: ${reasons.join(\", \")}`,\n      };\n    }\n\n    return { action: \"hold\", pair, confidence: 0.3, reason: `Sin oportunidad (cambio: ${priceChange.toFixed(2)}%, ATR: ${atrPercent.toFixed(2)}%)` };\n  }\n\n  private gridStrategy(pair: string, history: PriceData[], currentPrice: number): TradeSignal {\n    if (history.length < 15) {\n      return { action: \"hold\", pair, confidence: 0, reason: \"Datos insuficientes para grid\" };\n    }\n\n    const prices = history.map(h => h.price);\n    const high = Math.max(...prices);\n    const low = Math.min(...prices);\n    \n    // Usar ATR para determinar el espaciado del grid din√°micamente\n    const atr = this.calculateATR(history, 14);\n    const atrPercent = this.calculateATRPercent(history, 14);\n    \n    // El grid size se basa en ATR para adaptarse a la volatilidad del mercado\n    // Usamos 1.5x ATR como espaciado entre niveles del grid\n    const atrBasedGridSize = atr * 1.5;\n    const rangeBasedGridSize = (high - low) / 5;\n    \n    // Usamos el mayor de los dos para evitar niveles demasiado cercanos\n    const gridSize = Math.max(atrBasedGridSize, rangeBasedGridSize);\n    \n    if (gridSize <= 0) {\n      return { action: \"hold\", pair, confidence: 0, reason: \"Grid size inv√°lido\" };\n    }\n    \n    // Calcular niveles basados en precio medio\n    const midPrice = (high + low) / 2;\n    const distanceFromMid = currentPrice - midPrice;\n    const levelFromMid = Math.round(distanceFromMid / gridSize);\n    \n    const prevPrice = prices[prices.length - 2];\n    const prevDistanceFromMid = prevPrice - midPrice;\n    const prevLevelFromMid = Math.round(prevDistanceFromMid / gridSize);\n    \n    // Niveles de soporte/resistencia basados en ATR\n    const supportLevel = midPrice - (2 * gridSize);\n    const resistanceLevel = midPrice + (2 * gridSize);\n    \n    let confidence = 0.7;\n    \n    // Ajustar confianza basado en ATR\n    if (atrPercent > 0.5 && atrPercent < 2) {\n      confidence += 0.1; // Volatilidad ideal para grid\n    } else if (atrPercent > 2) {\n      confidence -= 0.1; // Demasiada volatilidad\n    }\n    \n    if (currentPrice <= supportLevel && levelFromMid < prevLevelFromMid) {\n      return {\n        action: \"buy\",\n        pair,\n        confidence: Math.min(0.85, confidence),\n        reason: `Grid ATR: Precio en soporte $${supportLevel.toFixed(2)} (ATR: ${atrPercent.toFixed(2)}%, nivel: ${levelFromMid})`,\n      };\n    }\n    \n    if (currentPrice >= resistanceLevel && levelFromMid > prevLevelFromMid) {\n      return {\n        action: \"sell\",\n        pair,\n        confidence: Math.min(0.85, confidence),\n        reason: `Grid ATR: Precio en resistencia $${resistanceLevel.toFixed(2)} (ATR: ${atrPercent.toFixed(2)}%, nivel: ${levelFromMid})`,\n      };\n    }\n\n    return { action: \"hold\", pair, confidence: 0.3, reason: `Grid: Nivel ${levelFromMid}, ATR: ${atrPercent.toFixed(2)}%` };\n  }\n\n  private calculateEMA(prices: number[], period: number): number {\n    if (prices.length === 0) return 0;\n    const multiplier = 2 / (period + 1);\n    let ema = prices[0];\n    for (let i = 1; i < prices.length; i++) {\n      ema = (prices[i] - ema) * multiplier + ema;\n    }\n    return ema;\n  }\n\n  private calculateRSI(prices: number[]): number {\n    if (prices.length < 2) return 50;\n    \n    let gains = 0, losses = 0;\n    for (let i = 1; i < prices.length; i++) {\n      const change = prices[i] - prices[i - 1];\n      if (change > 0) gains += change;\n      else losses -= change;\n    }\n    \n    const avgGain = gains / (prices.length - 1);\n    const avgLoss = losses / (prices.length - 1);\n    \n    if (avgLoss === 0) return 100;\n    const rs = avgGain / avgLoss;\n    return 100 - (100 / (1 + rs));\n  }\n\n  private calculateVolatility(prices: number[]): number {\n    if (prices.length < 2) return 0;\n    const mean = prices.reduce((a, b) => a + b, 0) / prices.length;\n    const variance = prices.reduce((sum, p) => sum + Math.pow(p - mean, 2), 0) / prices.length;\n    return (Math.sqrt(variance) / mean) * 100;\n  }\n\n  private calculateMACD(prices: number[]): { macd: number; signal: number; histogram: number } {\n    if (prices.length < 26) {\n      return { macd: 0, signal: 0, histogram: 0 };\n    }\n    \n    const ema12 = this.calculateEMA(prices.slice(-12), 12);\n    const ema26 = this.calculateEMA(prices.slice(-26), 26);\n    const macd = ema12 - ema26;\n    \n    const macdHistory: number[] = [];\n    for (let i = 26; i <= prices.length; i++) {\n      const e12 = this.calculateEMA(prices.slice(i - 12, i), 12);\n      const e26 = this.calculateEMA(prices.slice(i - 26, i), 26);\n      macdHistory.push(e12 - e26);\n    }\n    \n    const signal = macdHistory.length >= 9 ? this.calculateEMA(macdHistory.slice(-9), 9) : 0;\n    const histogram = macd - signal;\n    \n    return { macd, signal, histogram };\n  }\n\n  private calculateBollingerBands(prices: number[], period: number = 20, stdDevMultiplier: number = 2): { \n    upper: number; \n    middle: number; \n    lower: number; \n    percentB: number;\n  } {\n    if (prices.length < period) {\n      const avg = prices.reduce((a, b) => a + b, 0) / prices.length;\n      return { upper: avg, middle: avg, lower: avg, percentB: 50 };\n    }\n    \n    const recentPrices = prices.slice(-period);\n    const middle = recentPrices.reduce((a, b) => a + b, 0) / period;\n    const stdDev = Math.sqrt(\n      recentPrices.reduce((sum, p) => sum + Math.pow(p - middle, 2), 0) / period\n    );\n    \n    const upper = middle + (stdDevMultiplier * stdDev);\n    const lower = middle - (stdDevMultiplier * stdDev);\n    const currentPrice = prices[prices.length - 1];\n    const percentB = ((currentPrice - lower) / (upper - lower)) * 100;\n    \n    return { upper, middle, lower, percentB };\n  }\n\n  private calculateATR(history: PriceData[], period: number = 14): number {\n    if (history.length < period + 1) {\n      return 0;\n    }\n    \n    const trueRanges: number[] = [];\n    for (let i = 1; i < history.length; i++) {\n      const current = history[i];\n      const previous = history[i - 1];\n      \n      const tr1 = current.high - current.low;\n      const tr2 = Math.abs(current.high - previous.price);\n      const tr3 = Math.abs(current.low - previous.price);\n      \n      const trueRange = Math.max(tr1, tr2, tr3);\n      trueRanges.push(trueRange);\n    }\n    \n    const recentTRs = trueRanges.slice(-period);\n    const atr = recentTRs.reduce((a, b) => a + b, 0) / recentTRs.length;\n    \n    return atr;\n  }\n\n  private calculateATRPercent(history: PriceData[], period: number = 14): number {\n    const atr = this.calculateATR(history, period);\n    if (history.length === 0 || atr === 0) return 0;\n    \n    const currentPrice = history[history.length - 1].price;\n    return (atr / currentPrice) * 100;\n  }\n\n  private detectAbnormalVolume(history: PriceData[]): { isAbnormal: boolean; ratio: number; direction: string } {\n    if (history.length < 10) {\n      return { isAbnormal: false, ratio: 1, direction: \"neutral\" };\n    }\n    \n    const volumes = history.map(h => h.volume);\n    const currentVolume = volumes[volumes.length - 1];\n    const avgVolume = volumes.slice(0, -1).reduce((a, b) => a + b, 0) / (volumes.length - 1);\n    \n    if (avgVolume <= 0 || !isFinite(avgVolume) || currentVolume <= 0) {\n      return { isAbnormal: false, ratio: 1, direction: \"neutral\" };\n    }\n    \n    const ratio = currentVolume / avgVolume;\n    \n    if (!isFinite(ratio) || isNaN(ratio)) {\n      return { isAbnormal: false, ratio: 1, direction: \"neutral\" };\n    }\n    \n    const isAbnormal = ratio > 2.0 || ratio < 0.3;\n    \n    const priceChange = (history[history.length - 1].price - history[history.length - 2].price);\n    const direction = priceChange > 0 ? \"bullish\" : priceChange < 0 ? \"bearish\" : \"neutral\";\n    \n    return { isAbnormal, ratio, direction };\n  }\n\n  private updatePriceHistory(pair: string, data: PriceData) {\n    if (!this.priceHistory.has(pair)) {\n      this.priceHistory.set(pair, []);\n    }\n    const history = this.priceHistory.get(pair)!;\n    history.push(data);\n    if (history.length > this.PRICE_HISTORY_LENGTH) {\n      history.shift();\n    }\n  }\n\n  private formatKrakenPair(pair: string): string {\n    const pairMap: Record<string, string> = {\n      \"BTC/USD\": \"XXBTZUSD\",\n      \"ETH/USD\": \"XETHZUSD\",\n      \"SOL/USD\": \"SOLUSD\",\n      \"XRP/USD\": \"XXRPZUSD\",\n      \"TON/USD\": \"TONUSD\",\n      \"ETH/BTC\": \"XETHXXBT\",\n      \"BTC/ETH\": \"XXBTZXETH\",\n      \"SOL/ETH\": \"SOLETH\",\n    };\n    return pairMap[pair] || pair.replace(\"/\", \"\");\n  }\n\n  private getAssetBalance(pair: string, balances: any): number {\n    const asset = pair.split(\"/\")[0];\n    const assetMap: Record<string, string[]> = {\n      \"BTC\": [\"XXBT\", \"XBT\", \"BTC\"],\n      \"ETH\": [\"XETH\", \"ETH\"],\n      \"SOL\": [\"SOL\"],\n      \"XRP\": [\"XXRP\", \"XRP\"],\n      \"TON\": [\"TON\"],\n    };\n    \n    const keys = assetMap[asset] || [asset];\n    for (const key of keys) {\n      if (balances?.[key]) {\n        return parseFloat(balances[key]);\n      }\n    }\n    return 0;\n  }\n\n  // === HELPER: Validar cantidad de venta antes de enviar orden ===\n  // Solo para flujo SELL/cierre. NO afecta BUY ni sizing global.\n  private async validateSellAmount(\n    pair: string,\n    lotId: string,\n    requestedAmount: number\n  ): Promise<{\n    canSell: boolean;\n    sellAmountFinal: number;\n    reason: string;\n    isDust: boolean;\n    realAssetBalance: number;\n    orderMin: number;\n    stepSize: number;\n    needsPositionAdjust: boolean;\n  }> {\n    const stepSize = this.krakenService.getStepSize(pair) || 0.00000001;\n    const orderMin = this.getOrderMin(pair);\n    \n    // 1) Obtener balance real del asset base\n    let freshBalances: any;\n    try {\n      freshBalances = await this.krakenService.getBalance();\n    } catch (error: any) {\n      log(`[MANUAL_CLOSE_EVAL] ${pair} ${lotId}: ERROR getBalance - ${error.message}`, \"trading\");\n      return {\n        canSell: false,\n        sellAmountFinal: 0,\n        reason: `Error obteniendo balance de Kraken: ${error.message}`,\n        isDust: false,\n        realAssetBalance: 0,\n        orderMin,\n        stepSize,\n        needsPositionAdjust: false,\n      };\n    }\n    \n    const realAssetBalance = this.getAssetBalance(pair, freshBalances);\n    \n    // 2) Calcular sellAmount seguro = min(requested, realBalance)\n    let sellAmountRaw = Math.min(requestedAmount, realAssetBalance);\n    \n    // 3) Normalizar al stepSize (truncar, no redondear)\n    const decimals = Math.abs(Math.log10(stepSize));\n    const sellAmountFinal = Math.floor(sellAmountRaw * Math.pow(10, decimals)) / Math.pow(10, decimals);\n    \n    // 4) Caso DUST: balance real < orderMin\n    if (realAssetBalance < orderMin) {\n      const logMsg = `[MANUAL_CLOSE_EVAL] ${pair} ${lotId} | lotAmount=${requestedAmount.toFixed(8)} realBalance=${realAssetBalance.toFixed(8)} orderMin=${orderMin} stepSize=${stepSize} sellFinal=0 decision=DUST`;\n      log(logMsg, \"trading\");\n      \n      return {\n        canSell: false,\n        sellAmountFinal: 0,\n        reason: `Balance real (${realAssetBalance.toFixed(8)}) menor al m√≠nimo de Kraken (${orderMin}). Posici√≥n marcada como DUST.`,\n        isDust: true,\n        realAssetBalance,\n        orderMin,\n        stepSize,\n        needsPositionAdjust: false,\n      };\n    }\n    \n    // 5) Verificar si sellAmountFinal queda por debajo del m√≠nimo tras normalizar\n    if (sellAmountFinal < orderMin) {\n      const logMsg = `[MANUAL_CLOSE_EVAL] ${pair} ${lotId} | lotAmount=${requestedAmount.toFixed(8)} realBalance=${realAssetBalance.toFixed(8)} orderMin=${orderMin} stepSize=${stepSize} sellFinal=${sellAmountFinal.toFixed(8)} decision=BELOW_MIN_AFTER_NORMALIZE`;\n      log(logMsg, \"trading\");\n      \n      return {\n        canSell: false,\n        sellAmountFinal: 0,\n        reason: `Cantidad normalizada (${sellAmountFinal.toFixed(8)}) menor al m√≠nimo de Kraken (${orderMin}).`,\n        isDust: true,\n        realAssetBalance,\n        orderMin,\n        stepSize,\n        needsPositionAdjust: false,\n      };\n    }\n    \n    // 6) Detectar discrepancia: position.amount > realAssetBalance\n    const needsPositionAdjust = requestedAmount > realAssetBalance * 1.005; // tolerancia 0.5%\n    \n    const logMsg = `[MANUAL_CLOSE_EVAL] ${pair} ${lotId} | lotAmount=${requestedAmount.toFixed(8)} realBalance=${realAssetBalance.toFixed(8)} orderMin=${orderMin} stepSize=${stepSize} sellFinal=${sellAmountFinal.toFixed(8)} decision=CAN_SELL${needsPositionAdjust ? \" (adjusted)\" : \"\"}`;\n    log(logMsg, \"trading\");\n    \n    return {\n      canSell: true,\n      sellAmountFinal,\n      reason: needsPositionAdjust \n        ? `Cantidad ajustada de ${requestedAmount.toFixed(8)} a ${sellAmountFinal.toFixed(8)} (balance real)` \n        : \"OK\",\n      isDust: false,\n      realAssetBalance,\n      orderMin,\n      stepSize,\n      needsPositionAdjust,\n    };\n  }\n\n  private async executeTrade(\n    pair: string,\n    type: \"buy\" | \"sell\",\n    volume: string,\n    price: number,\n    reason: string,\n    adjustmentInfo?: { wasAdjusted: boolean; originalAmountUsd: number; adjustedAmountUsd: number },\n    strategyMeta?: { strategyId: string; timeframe: string; confidence: number },\n    executionMeta?: { mode: string; usdDisponible: number; orderUsdProposed: number; orderUsdFinal: number; minOrderUsd: number; allowUnderMin: boolean; dryRun: boolean },\n    sellContext?: { entryPrice: number; aiSampleId?: number } // For sells: pass entry price for correct P&L calculation\n  ): Promise<boolean> {\n    try {\n      const volumeNum = parseFloat(volume);\n      const totalUSD = volumeNum * price;\n      \n      // === DRY_RUN MODE: Simular sin enviar orden real ===\n      if (this.dryRunMode) {\n        const envPrefix = environment.isReplit ? \"[REPLIT/DEV][DRY\\\\_RUN]\" : \"[NAS/PROD][DRY\\\\_RUN]\";\n        const envPrefixLog = environment.isReplit ? \"[REPLIT/DEV][DRY_RUN]\" : \"[NAS/PROD][DRY_RUN]\";\n        \n        // === DOBLE CINTUR√ìN: Validaci√≥n redundante para DRY_RUN ===\n        // Si falla m√≠nimos, ni simula ni env√≠a mensaje de trade\n        if (type === \"buy\" && executionMeta) {\n          const positionMode = executionMeta.mode || \"SINGLE\";\n          const orderUsdFinal = totalUSD;\n          const sgMinEntryUsd = executionMeta.minOrderUsd || 100;\n          const sgAllowUnderMin = executionMeta.allowUnderMin ?? true;\n          \n          const doubleBeltValidation = validateMinimumsOrSkip({\n            positionMode,\n            orderUsdFinal,\n            orderUsdProposed: executionMeta.orderUsdProposed || orderUsdFinal,\n            usdDisponible: executionMeta.usdDisponible || 0,\n            exposureAvailable: executionMeta.orderUsdFinal || 0,\n            pair,\n            sgMinEntryUsd,\n            sgAllowUnderMin,\n            dryRun: true,\n            env: envPrefixLog,\n          });\n          \n          if (!doubleBeltValidation.valid) {\n            log(`${envPrefixLog} BLOQUEADO - ${doubleBeltValidation.message}`, \"trading\");\n            await botLogger.info(\"TRADE_SKIPPED\", `${envPrefixLog} Trade bloqueado en double-belt`, {\n              pair,\n              type,\n              reason: doubleBeltValidation.skipReason,\n              ...doubleBeltValidation.meta,\n            });\n            // NO enviar Telegram de simulaci√≥n - solo log\n            return false;\n          }\n        }\n        \n        const simTxid = `DRY-${Date.now()}`;\n        log(`${envPrefixLog} SIMULACI√ìN ${type.toUpperCase()} ${volume} ${pair} @ $${price.toFixed(2)} (Total: $${totalUSD.toFixed(2)})`, \"trading\");\n        \n        await botLogger.info(\"DRY_RUN_TRADE\", `${envPrefixLog} Trade simulado - NO enviado al exchange`, {\n          pair,\n          type,\n          volume: volumeNum,\n          price,\n          totalUsd: totalUSD,\n          simTxid,\n          reason,\n          ...(executionMeta || {}),\n        });\n        \n        // Enviar Telegram de simulaci√≥n con prefijo correcto\n        if (this.telegramService.isInitialized()) {\n          const sgInfo = executionMeta && executionMeta.mode === \"SMART_GUARD\"\n            ? `\\n*Min. Orden:* $${executionMeta.minOrderUsd?.toFixed(2) || \"N/A\"}\\n*Permitir Menor:* ${executionMeta.allowUnderMin ? \"S√ç\" : \"NO\"}`\n            : \"\";\n          \n          await this.telegramService.sendMessage(`\nüß™ *${envPrefix} Trade Simulado*\n\n*Tipo:* ${type.toUpperCase()}\n*Par:* ${pair}\n*Cantidad:* ${volume}\n*Precio:* $${price.toFixed(2)}\n*Total:* $${totalUSD.toFixed(2)}${sgInfo}\n\n_‚ö†Ô∏è Modo simulaci√≥n - NO se envi√≥ orden real_\n          `.trim());\n        }\n        \n        return true; // Simular √©xito para flujo normal\n      }\n      \n      log(`Ejecutando ${type.toUpperCase()} ${volume} ${pair} @ $${price.toFixed(2)}`, \"trading\");\n      \n      const order = await this.krakenService.placeOrder({\n        pair,\n        type,\n        ordertype: \"market\",\n        volume,\n      });\n\n      const txid = order.txid?.[0];\n      if (!txid) {\n        log(`Orden sin txid - posible fallo`, \"trading\");\n        return false;\n      }\n\n      const tradeId = `AUTO-${Date.now()}`;\n      await storage.createTrade({\n        tradeId,\n        pair,\n        type,\n        price: price.toString(),\n        amount: volume,\n        status: \"filled\",\n        krakenOrderId: txid,\n        executedAt: new Date(),\n      });\n\n      // volumeNum ya declarado arriba\n      if (type === \"buy\") {\n        this.currentUsdBalance -= volumeNum * price;\n        const existingPositions = this.getPositionsByPair(pair);\n        const existing = existingPositions[0]; // First position for DCA mode\n        let newPosition: OpenPosition;\n        \n        const entryStrategyId = strategyMeta?.strategyId || \"momentum_cycle\";\n        const entrySignalTf = strategyMeta?.timeframe || \"cycle\";\n        const signalConfidence = strategyMeta?.confidence;\n        \n        const currentConfig = await storage.getBotConfig();\n        const entryMode = currentConfig?.positionMode || \"SINGLE\";\n        \n        // In SMART_GUARD with multi-lot, always create new positions\n        const shouldCreateNewLot = entryMode === \"SMART_GUARD\" || !existing || existing.amount <= 0;\n        \n        if (!shouldCreateNewLot && existing) {\n          // DCA mode: update existing position\n          const totalAmount = existing.amount + volumeNum;\n          const avgPrice = (existing.amount * existing.entryPrice + volumeNum * price) / totalAmount;\n          newPosition = { \n            ...existing,\n            amount: totalAmount, \n            entryPrice: avgPrice,\n            highestPrice: Math.max(existing.highestPrice, price),\n          };\n          this.openPositions.set(existing.lotId, newPosition);\n          log(`DCA entry: ${pair} (${existing.lotId}) - preserved snapshot from original entry`, \"trading\");\n        } else {\n          // NEW POSITION: create snapshot of current config with unique lotId\n          const lotId = generateLotId(pair);\n          \n          const configSnapshot: ConfigSnapshot = {\n            stopLossPercent: parseFloat(currentConfig?.stopLossPercent?.toString() || \"5\"),\n            takeProfitPercent: parseFloat(currentConfig?.takeProfitPercent?.toString() || \"7\"),\n            trailingStopEnabled: currentConfig?.trailingStopEnabled ?? false,\n            trailingStopPercent: parseFloat(currentConfig?.trailingStopPercent?.toString() || \"2\"),\n            positionMode: entryMode,\n          };\n          \n          // Add SMART_GUARD specific params using getSmartGuardParams() for per-pair override support\n          if (entryMode === \"SMART_GUARD\") {\n            const sgParams = this.getSmartGuardParams(pair, currentConfig);\n            configSnapshot.sgMinEntryUsd = sgParams.sgMinEntryUsd;\n            configSnapshot.sgAllowUnderMin = sgParams.sgAllowUnderMin;\n            configSnapshot.sgBeAtPct = sgParams.sgBeAtPct;\n            configSnapshot.sgFeeCushionPct = sgParams.sgFeeCushionPct;\n            configSnapshot.sgFeeCushionAuto = sgParams.sgFeeCushionAuto;\n            configSnapshot.sgTrailStartPct = sgParams.sgTrailStartPct;\n            configSnapshot.sgTrailDistancePct = sgParams.sgTrailDistancePct;\n            configSnapshot.sgTrailStepPct = sgParams.sgTrailStepPct;\n            configSnapshot.sgTpFixedEnabled = sgParams.sgTpFixedEnabled;\n            configSnapshot.sgTpFixedPct = sgParams.sgTpFixedPct;\n            configSnapshot.sgScaleOutEnabled = sgParams.sgScaleOutEnabled;\n            configSnapshot.sgScaleOutPct = sgParams.sgScaleOutPct;\n            configSnapshot.sgMinPartUsd = sgParams.sgMinPartUsd;\n            configSnapshot.sgScaleOutThreshold = sgParams.sgScaleOutThreshold;\n          }\n          \n          newPosition = { \n            lotId,\n            pair,\n            amount: volumeNum, \n            entryPrice: price,\n            highestPrice: price,\n            openedAt: Date.now(),\n            entryStrategyId,\n            entrySignalTf,\n            signalConfidence,\n            signalReason: reason,\n            entryMode,\n            configSnapshot,\n            // SMART_GUARD initial state\n            sgBreakEvenActivated: false,\n            sgCurrentStopPrice: undefined,\n            sgTrailingActivated: false,\n            sgScaleOutDone: false,\n          };\n          this.openPositions.set(lotId, newPosition);\n          \n          const lotCount = this.countLotsForPair(pair);\n          if (entryMode === \"SMART_GUARD\") {\n            log(`NEW LOT #${lotCount}: ${pair} (${lotId}) - SMART_GUARD snapshot saved (BE=${configSnapshot.sgBeAtPct}%, trail=${configSnapshot.sgTrailDistancePct}%, TP=${configSnapshot.sgTpFixedEnabled ? configSnapshot.sgTpFixedPct + '%' : 'OFF'})`, \"trading\");\n          } else {\n            log(`NEW POSITION: ${pair} (${lotId}) - snapshot saved (SL=${configSnapshot.stopLossPercent}%, TP=${configSnapshot.takeProfitPercent}%, trailing=${configSnapshot.trailingStopEnabled}, mode=${entryMode})`, \"trading\");\n          }\n        }\n        \n        // AI Sample collection: save features for ALL buy entries (not just new positions)\n        if (!newPosition.aiSampleId) {\n          try {\n            const features = aiService.extractFeatures({\n              rsi: 50, // Will be enriched from actual indicators in future\n              confidence: signalConfidence ?? 50,\n            });\n            const sampleTradeId = `SAMPLE-${Date.now()}-${pair}`;\n            const sample = await storage.saveAiSample({\n              tradeId: sampleTradeId,\n              pair,\n              side: \"buy\",\n              entryPrice: price.toString(),\n              entryTs: new Date(),\n              featuresJson: features,\n            });\n            if (sample?.id) {\n              newPosition.aiSampleId = sample.id;\n              log(`[AI] Sample #${sample.id} guardado para ${pair}`, \"trading\");\n            }\n          } catch (aiErr: any) {\n            log(`[AI] Error guardando sample: ${aiErr.message}`, \"trading\");\n          }\n        }\n        \n        await this.savePositionToDB(pair, newPosition);\n      } else {\n        // SELL: Update balance and P&L tracking\n        // Note: Position management for sells is now handled by the callers \n        // (checkSinglePositionSLTP, checkSmartGuardExit, forceClosePosition)\n        // which have the lotId context. This block only updates balance/P&L metrics.\n        this.currentUsdBalance += volumeNum * price;\n        \n        // Calculate P&L using sellContext if provided (for correct per-lot tracking)\n        if (sellContext) {\n          const pnl = (price - sellContext.entryPrice) * volumeNum;\n          this.dailyPnL += pnl;\n          log(`P&L de operaci√≥n: $${pnl.toFixed(2)} | P&L diario acumulado: $${this.dailyPnL.toFixed(2)}`, \"trading\");\n          \n          // AI Sample update: mark sample complete with PnL result\n          if (sellContext.aiSampleId) {\n            try {\n              await storage.updateAiSample(sellContext.aiSampleId, {\n                exitPrice: price.toString(),\n                exitTs: new Date(),\n                pnlGross: pnl.toString(),\n                pnlNet: pnl.toString(),\n                labelWin: pnl > 0 ? 1 : 0,\n                isComplete: true,\n              });\n              log(`[AI] Sample #${sellContext.aiSampleId} actualizado: PnL=${pnl.toFixed(2)} (${pnl > 0 ? 'WIN' : 'LOSS'})`, \"trading\");\n            } catch (aiErr: any) {\n              log(`[AI] Error actualizando sample: ${aiErr.message}`, \"trading\");\n            }\n          }\n        } else {\n          // No sellContext provided - this is a bug, log warning\n          log(`[WARN] Sell ejecutado sin sellContext para ${pair} - P&L no registrado. Todos los sell deben proporcionar sellContext.`, \"trading\");\n        }\n        // Position deletion is handled by the caller (checkSinglePositionSLTP, checkSmartGuardExit, etc.)\n      }\n\n      const emoji = type === \"buy\" ? \"üü¢\" : \"üî¥\";\n      const totalUSDFormatted = totalUSD.toFixed(2);\n      \n      if (this.telegramService.isInitialized()) {\n        let adjustmentNote = \"\";\n        if (adjustmentInfo?.wasAdjusted) {\n          adjustmentNote = `\\nüìâ _Ajustado por exposici√≥n: $${adjustmentInfo.originalAmountUsd.toFixed(2)} ‚Üí $${adjustmentInfo.adjustedAmountUsd.toFixed(2)}_\\n`;\n        }\n        \n        const strategyLabel = strategyMeta?.strategyId ? \n          ((strategyMeta?.timeframe && strategyMeta.timeframe !== \"cycle\") ? \n            `Momentum (Velas ${strategyMeta.timeframe})` : \n            \"Momentum (Ciclos)\") : \n          \"Momentum (Ciclos)\";\n        const confidenceLabel = strategyMeta?.confidence ? ` | Confianza: ${(strategyMeta.confidence * 100).toFixed(0)}%` : \"\";\n        \n        await this.telegramService.sendMessage(`\n${emoji} *Operaci√≥n Autom√°tica Ejecutada*\n\n*Tipo:* ${type.toUpperCase()}\n*Par:* ${pair}\n*Cantidad:* ${volume}\n*Precio:* $${price.toFixed(2)}\n*Total:* $${totalUSDFormatted}\n*ID:* ${txid}\n*Estrategia:* ${strategyLabel}${confidenceLabel}\n${adjustmentNote}\n*Raz√≥n:* ${reason}\n\n_KrakenBot.AI - Trading Aut√≥nomo_\n        `.trim());\n      }\n\n      log(`Orden ejecutada: ${txid}`, \"trading\");\n      \n      await botLogger.info(\"TRADE_EXECUTED\", `Trade ${type.toUpperCase()} ejecutado en ${pair}`, {\n        pair,\n        type,\n        volume: volumeNum,\n        price,\n        totalUsd: volumeNum * price,\n        txid,\n        reason,\n        strategyId: strategyMeta?.strategyId || \"momentum_cycle\",\n        timeframe: strategyMeta?.timeframe || \"cycle\",\n        confidence: strategyMeta?.confidence,\n      });\n      \n      // FIFO Matcher: Ingest real sell fill and trigger automatic matching\n      // Only runs for real sells - DRY_RUN returns early at line ~3161\n      // Triple guard: check dryRunMode AND executionMeta.dryRun for belt-and-suspenders safety\n      const isSimulation = this.dryRunMode || (executionMeta?.dryRun ?? false);\n      if (type === \"sell\" && !isSimulation) {\n        try {\n          const fee = volumeNum * price * (KRAKEN_FEE_PCT / 100); // Use existing fee constant\n          await storage.upsertTradeFill({\n            txid,\n            pair,\n            type: \"sell\",\n            price: price.toString(),\n            amount: volume,\n            fee: fee.toFixed(8),\n            matched: false,\n          });\n          \n          const sellFill = await storage.getTradeFillByTxid(txid);\n          if (sellFill) {\n            const matchResult = await fifoMatcher.processSellFill(sellFill);\n            log(`[FIFO] Auto-matched sell ${txid}: matched=${matchResult.totalMatched.toFixed(8)}, lots_closed=${matchResult.lotsClosed}, pnl=$${matchResult.pnlNet.toFixed(2)}`, \"trading\");\n            \n            if (matchResult.lotsClosed > 0) {\n              await botLogger.info(\"FIFO_LOTS_CLOSED\", `FIFO cerr√≥ ${matchResult.lotsClosed} lotes autom√°ticamente`, {\n                pair,\n                sellTxid: txid,\n                matchedQty: matchResult.totalMatched,\n                lotsClosed: matchResult.lotsClosed,\n                pnlNet: matchResult.pnlNet,\n              });\n            }\n          }\n        } catch (fifoErr: any) {\n          log(`[FIFO] Error procesando sell ${txid}: ${fifoErr.message}`, \"trading\");\n        }\n      }\n      \n      return true;\n    } catch (error: any) {\n      log(`Error ejecutando orden: ${error.message}`, \"trading\");\n      \n      await botLogger.error(\"TRADE_FAILED\", `Error ejecutando ${type} en ${pair}`, {\n        pair,\n        type,\n        volume,\n        price,\n        error: error.message,\n      });\n      \n      if (this.telegramService.isInitialized()) {\n        await this.telegramService.sendMessage(`\n‚ö†Ô∏è *Error en Operaci√≥n*\n\n*Par:* ${pair}\n*Tipo:* ${type}\n*Error:* ${error.message}\n\n_KrakenBot.AI_\n        `.trim());\n      }\n      return false;\n    }\n  }\n\n  private async getMultiTimeframeData(pair: string): Promise<MultiTimeframeData | null> {\n    try {\n      const cached = this.mtfCache.get(pair);\n      if (cached && Date.now() - cached.lastUpdate < this.MTF_CACHE_TTL) {\n        return cached;\n      }\n\n      const [tf5m, tf1h, tf4h] = await Promise.all([\n        this.krakenService.getOHLC(pair, 5),\n        this.krakenService.getOHLC(pair, 60),\n        this.krakenService.getOHLC(pair, 240),\n      ]);\n\n      const data: MultiTimeframeData = {\n        tf5m: tf5m.slice(-50),\n        tf1h: tf1h.slice(-50),\n        tf4h: tf4h.slice(-50),\n        lastUpdate: Date.now(),\n      };\n\n      this.mtfCache.set(pair, data);\n      log(`MTF datos actualizados para ${pair}: 5m=${tf5m.length}, 1h=${tf1h.length}, 4h=${tf4h.length}`, \"trading\");\n      return data;\n    } catch (error: any) {\n      log(`Error obteniendo datos MTF para ${pair}: ${error.message}`, \"trading\");\n      return null;\n    }\n  }\n\n  private analyzeTimeframeTrend(candles: OHLCCandle[]): \"bullish\" | \"bearish\" | \"neutral\" {\n    if (candles.length < 10) return \"neutral\";\n\n    const closes = candles.map(c => c.close);\n    const ema10 = this.calculateEMA(closes.slice(-10), 10);\n    const ema20 = this.calculateEMA(closes.slice(-20), 20);\n    const currentPrice = closes[closes.length - 1];\n\n    const priceVsEma10 = (currentPrice - ema10) / ema10 * 100;\n    const ema10VsEma20 = (ema10 - ema20) / ema20 * 100;\n\n    let score = 0;\n    if (priceVsEma10 > 0.5) score += 2;\n    else if (priceVsEma10 > 0) score += 1;\n    else if (priceVsEma10 < -0.5) score -= 2;\n    else if (priceVsEma10 < 0) score -= 1;\n\n    if (ema10VsEma20 > 0.3) score += 2;\n    else if (ema10VsEma20 > 0) score += 1;\n    else if (ema10VsEma20 < -0.3) score -= 2;\n    else if (ema10VsEma20 < 0) score -= 1;\n\n    const recentCandles = candles.slice(-5);\n    const higherHighs = recentCandles.filter((c, i) => i > 0 && c.high > recentCandles[i-1].high).length;\n    const lowerLows = recentCandles.filter((c, i) => i > 0 && c.low < recentCandles[i-1].low).length;\n    \n    if (higherHighs >= 3) score += 1;\n    if (lowerLows >= 3) score -= 1;\n\n    if (score >= 3) return \"bullish\";\n    if (score <= -3) return \"bearish\";\n    return \"neutral\";\n  }\n\n  private analyzeMultiTimeframe(mtfData: MultiTimeframeData): TrendAnalysis {\n    const shortTerm = this.analyzeTimeframeTrend(mtfData.tf5m);\n    const mediumTerm = this.analyzeTimeframeTrend(mtfData.tf1h);\n    const longTerm = this.analyzeTimeframeTrend(mtfData.tf4h);\n\n    const trendValues = { bullish: 1, neutral: 0, bearish: -1 };\n    const totalScore = trendValues[shortTerm] + trendValues[mediumTerm] * 1.5 + trendValues[longTerm] * 2;\n    \n    const allAligned = (shortTerm === mediumTerm && mediumTerm === longTerm && shortTerm !== \"neutral\");\n    const twoAligned = (shortTerm === mediumTerm || mediumTerm === longTerm || shortTerm === longTerm);\n    \n    let alignment = 0;\n    let confidence = 0.5;\n    \n    if (allAligned) {\n      alignment = trendValues[shortTerm];\n      confidence = 0.9;\n    } else if (twoAligned && shortTerm !== \"neutral\") {\n      alignment = totalScore > 0 ? 0.7 : totalScore < 0 ? -0.7 : 0;\n      confidence = 0.7;\n    } else {\n      alignment = totalScore / 4.5;\n      confidence = 0.5;\n    }\n\n    let summary = \"\";\n    if (allAligned) {\n      summary = `Tendencia ${shortTerm === \"bullish\" ? \"ALCISTA\" : \"BAJISTA\"} confirmada en todos los timeframes (5m/1h/4h)`;\n    } else {\n      summary = `5m: ${shortTerm}, 1h: ${mediumTerm}, 4h: ${longTerm}`;\n    }\n\n    return { shortTerm, mediumTerm, longTerm, alignment, confidence, summary };\n  }\n\n  isActive(): boolean {\n    return this.isRunning;\n  }\n\n  // === CIERRE MANUAL DE POSICI√ìN ===\n  async forceClosePosition(\n    pair: string,\n    currentPrice: number,\n    correlationId: string,\n    reason: string,\n    lotId?: string // Optional: specify which lot to close (for multi-lot support)\n  ): Promise<{\n    success: boolean;\n    error?: string;\n    orderId?: string;\n    pnlUsd?: number;\n    pnlPct?: number;\n    dryRun?: boolean;\n    lotId?: string;\n    isDust?: boolean; // Flag para indicar que la posici√≥n es DUST y no se puede cerrar\n  }> {\n    try {\n      // Find the position to close\n      let position: OpenPosition | undefined;\n      if (lotId) {\n        position = this.openPositions.get(lotId);\n      } else {\n        // Close the first position for this pair\n        const positions = this.getPositionsByPair(pair);\n        position = positions[0];\n      }\n      \n      if (!position || position.amount <= 0) {\n        return {\n          success: false,\n          error: \"No se encontr√≥ posici√≥n abierta en memoria para este par\",\n        };\n      }\n\n      const positionLotId = position.lotId;\n      const amount = position.amount;\n      const entryPrice = position.entryPrice;\n      const pnlUsd = (currentPrice - entryPrice) * amount;\n      const pnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;\n\n      log(`[MANUAL_CLOSE] Iniciando cierre de ${pair} (${positionLotId}): ${amount.toFixed(8)} @ $${currentPrice.toFixed(2)}`, \"trading\");\n\n      // En DRY_RUN, simular el cierre\n      if (this.dryRunMode) {\n        const simTxid = `MANUAL-DRY-${Date.now()}`;\n        log(`[DRY_RUN] SIMULACI√ìN cierre manual ${pair} (${positionLotId}) - ${amount.toFixed(8)} @ $${currentPrice.toFixed(2)}`, \"trading\");\n\n        // Actualizar memoria y DB para reflejar el cierre (aunque sea simulado)\n        this.openPositions.delete(positionLotId);\n        await storage.deleteOpenPositionByLotId(positionLotId);\n\n        // Registrar el trade de cierre\n        const tradeId = `MANUAL-${Date.now()}`;\n        await storage.createTrade({\n          tradeId,\n          pair,\n          type: \"sell\",\n          price: currentPrice.toString(),\n          amount: amount.toFixed(8),\n          status: \"filled\",\n          krakenOrderId: simTxid,\n          entryPrice: entryPrice.toString(),\n          realizedPnlUsd: pnlUsd.toString(),\n          realizedPnlPct: pnlPct.toString(),\n          executedAt: new Date(),\n        });\n\n        // Notificar por Telegram\n        if (this.telegramService.isInitialized()) {\n          await this.telegramService.sendMessage(`\nüß™ *[DRY\\\\_RUN] Cierre Manual Simulado*\n\n*Par:* ${pair}\n*Cantidad:* ${amount.toFixed(8)}\n*Precio entrada:* $${entryPrice.toFixed(2)}\n*Precio salida:* $${currentPrice.toFixed(2)}\n*PnL:* ${pnlUsd >= 0 ? \"+\" : \"\"}$${pnlUsd.toFixed(2)} (${pnlPct >= 0 ? \"+\" : \"\"}${pnlPct.toFixed(2)}%)\n\n_‚ö†Ô∏è Modo simulaci√≥n - NO se envi√≥ orden real_\n          `.trim());\n        }\n\n        return {\n          success: true,\n          orderId: simTxid,\n          pnlUsd,\n          pnlPct,\n          dryRun: true,\n          lotId: positionLotId,\n        };\n      }\n\n      // === VALIDACI√ìN PRE-SELL: Verificar balance real y detectar DUST ===\n      const validation = await this.validateSellAmount(pair, positionLotId, amount);\n      \n      if (!validation.canSell) {\n        // Caso DUST: no se puede vender, devolver error con flag isDust\n        if (validation.isDust) {\n          // Enviar alerta Telegram\n          if (this.telegramService.isInitialized()) {\n            await this.telegramService.sendMessage(`\n‚ö†Ô∏è *Posici√≥n DUST Detectada*\n\n*Par:* ${pair}\n*Lot:* ${positionLotId}\n*Cantidad registrada:* ${amount.toFixed(8)}\n*Balance real:* ${validation.realAssetBalance.toFixed(8)}\n*M√≠nimo Kraken:* ${validation.orderMin}\n\n_No se puede cerrar - usar \"Eliminar hu√©rfana\" en UI_\n            `.trim());\n          }\n        }\n        \n        return {\n          success: false,\n          error: validation.reason,\n          lotId: positionLotId,\n          isDust: validation.isDust,\n        };\n      }\n      \n      // Si hubo ajuste de cantidad, actualizar posici√≥n interna\n      const sellAmountFinal = validation.sellAmountFinal;\n      if (validation.needsPositionAdjust) {\n        log(`[MANUAL_CLOSE] Ajustando posici√≥n ${pair} (${positionLotId}) de ${amount} a ${sellAmountFinal}`, \"trading\");\n        position.amount = sellAmountFinal;\n        this.openPositions.set(positionLotId, position);\n        await this.savePositionToDB(pair, position);\n      }\n      \n      // Recalcular PnL con cantidad real\n      const actualPnlUsd = (currentPrice - entryPrice) * sellAmountFinal;\n      const actualPnlPct = ((currentPrice - entryPrice) / entryPrice) * 100;\n\n      // PRODUCCI√ìN: Ejecutar orden real de venta\n      const order = await this.krakenService.placeOrder({\n        pair,\n        type: \"sell\",\n        ordertype: \"market\",\n        volume: sellAmountFinal.toFixed(8),\n      });\n\n      const txid = order.txid?.[0];\n      if (!txid) {\n        return {\n          success: false,\n          error: \"Orden enviada pero no se recibi√≥ txid de confirmaci√≥n\",\n        };\n      }\n\n      // Actualizar memoria y DB (usar lotId para multi-lot)\n      this.openPositions.delete(positionLotId);\n      await storage.deleteOpenPositionByLotId(positionLotId);\n\n      // Registrar el trade de cierre\n      const tradeId = `MANUAL-${Date.now()}`;\n      await storage.createTrade({\n        tradeId,\n        pair,\n        type: \"sell\",\n        price: currentPrice.toString(),\n        amount: sellAmountFinal.toFixed(8),\n        status: \"filled\",\n        krakenOrderId: txid,\n        entryPrice: entryPrice.toString(),\n        realizedPnlUsd: actualPnlUsd.toString(),\n        realizedPnlPct: actualPnlPct.toString(),\n        executedAt: new Date(),\n      });\n\n      // Notificar por Telegram\n      if (this.telegramService.isInitialized()) {\n        const pnlEmoji = actualPnlUsd >= 0 ? \"üü¢\" : \"üî¥\";\n        await this.telegramService.sendMessage(`\n${pnlEmoji} *Cierre Manual Ejecutado*\n\n*Par:* ${pair}\n*Cantidad:* ${sellAmountFinal.toFixed(8)}\n*Precio entrada:* $${entryPrice.toFixed(2)}\n*Precio salida:* $${currentPrice.toFixed(2)}\n*PnL:* ${actualPnlUsd >= 0 ? \"+\" : \"\"}$${actualPnlUsd.toFixed(2)} (${actualPnlPct >= 0 ? \"+\" : \"\"}${actualPnlPct.toFixed(2)}%)\n*Order ID:* \\`${txid}\\`\n\n_Cierre solicitado manualmente desde dashboard_\n        `.trim());\n      }\n\n      log(`[MANUAL_CLOSE] Cierre exitoso ${pair} (${positionLotId}) - Order: ${txid}, PnL: $${actualPnlUsd.toFixed(2)}`, \"trading\");\n\n      return {\n        success: true,\n        orderId: txid,\n        pnlUsd: actualPnlUsd,\n        pnlPct: actualPnlPct,\n        dryRun: false,\n        lotId: positionLotId,\n      };\n\n    } catch (error: any) {\n      log(`[MANUAL_CLOSE] Error al cerrar ${pair}: ${error.message}`, \"trading\");\n      return {\n        success: false,\n        error: error.message,\n      };\n    }\n  }\n\n  getOpenPositions(): Map<string, { amount: number; entryPrice: number }> {\n    return this.openPositions;\n  }\n\n  // === DIAGN√ìSTICO: Obtener resultados del scan con razones en espa√±ol ===\n  async getScanDiagnostic(): Promise<{\n    pairs: Array<{\n      pair: string;\n      signal: string;\n      razon: string;\n      cooldownSec?: number;\n      exposureAvailable?: number;\n      hasPosition: boolean;\n      positionUsd?: number;\n    }>;\n    positionMode: string;\n    usdBalance: number;\n    totalOpenPositions: number;\n    lastScanAt: string | null;\n  }> {\n    const config = await storage.getBotConfig();\n    const positionMode = config?.positionMode || \"SINGLE\";\n    \n    // Mapeo de razones a espa√±ol (seg√∫n documento SMART_GUARD)\n    const reasonTranslations: Record<string, string> = {\n      \"PAIR_COOLDOWN\": \"En enfriamiento - esperando reintentos\",\n      \"SINGLE_MODE_POSITION_EXISTS\": \"Ya hay posici√≥n abierta en este par\",\n      \"SMART_GUARD_POSITION_EXISTS\": \"Ya hay posici√≥n abierta en este par\",\n      \"SMART_GUARD_MAX_LOTS_REACHED\": \"M√°ximo de lotes abiertos alcanzado para este par\",\n      \"STOPLOSS_COOLDOWN\": \"Enfriamiento post stop-loss activo\",\n      \"SPREAD_TOO_HIGH\": \"Spread demasiado alto para operar\",\n      \"POSITION_TOO_LARGE\": \"Posici√≥n existente demasiado grande\",\n      \"INSUFFICIENT_FUNDS\": \"Fondos USD insuficientes\",\n      \"LOW_PROFITABILITY\": \"Take-profit menor que comisiones\",\n      \"EXPOSURE_ZERO\": \"Sin exposici√≥n disponible\",\n      \"VOLUME_BELOW_MINIMUM\": \"Volumen calculado < m√≠nimo Kraken\",\n      \"SG_MIN_ENTRY_NOT_MET\": \"M√≠nimo por operaci√≥n no alcanzado (tiene saldo, pero tama√±o qued√≥ por debajo)\",\n      \"SG_REDUCED_ENTRY\": \"Saldo por debajo del m√≠nimo ‚Äî entro con lo disponible\",\n      \"MIN_ORDER_ABSOLUTE\": \"Por debajo del m√≠nimo absoluto ($20) ‚Äî m√≠nimo exchange no alcanzado\",\n      \"MIN_ORDER_USD\": \"SKIP - M√≠nimo por orden no alcanzado (allowUnderMin=OFF)\",\n      \"NO_POSITION\": \"Sin posici√≥n para vender\",\n      \"AI_FILTER_REJECTED\": \"Se√±al rechazada por filtro IA\",\n      \"Sin se√±al\": \"Sin se√±al de trading activa\",\n    };\n\n    const pairs: Array<{\n      pair: string;\n      signal: string;\n      razon: string;\n      cooldownSec?: number;\n      exposureAvailable?: number;\n      hasPosition: boolean;\n      positionUsd?: number;\n    }> = [];\n\n    // Helper: buscar posiciones por par (openPositions usa lotId como clave, no pair)\n    const getPositionsForPair = (targetPair: string): OpenPosition[] => {\n      const positions: OpenPosition[] = [];\n      this.openPositions.forEach((pos) => {\n        if (pos.pair === targetPair && pos.amount > 0) {\n          positions.push(pos);\n        }\n      });\n      return positions;\n    };\n\n    // Si hay datos de escaneo, usar esos\n    if (this.lastScanResults.size > 0) {\n      this.lastScanResults.forEach((result, pair) => {\n        const pairPositions = getPositionsForPair(pair);\n        const hasPosition = pairPositions.length > 0;\n        const totalPositionUsd = pairPositions.reduce((sum, p) => sum + (p.amount * p.entryPrice), 0);\n        \n        // Traducir la raz√≥n\n        let razon = result.reason;\n        for (const [key, value] of Object.entries(reasonTranslations)) {\n          if (razon.includes(key) || razon === key) {\n            razon = value;\n            break;\n          }\n        }\n\n        // Obtener cooldown si no viene en el resultado\n        const cooldownSec = result.cooldownSec ?? this.getCooldownRemainingSec(pair);\n\n        pairs.push({\n          pair,\n          signal: result.signal,\n          razon,\n          cooldownSec: cooldownSec > 0 ? cooldownSec : undefined,\n          exposureAvailable: result.exposureAvailable,\n          hasPosition,\n          positionUsd: hasPosition ? totalPositionUsd : undefined,\n        });\n      });\n    } else {\n      // Si no hay datos de escaneo, mostrar pares activos con info b√°sica\n      const activePairs = config?.activePairs || [];\n      for (const pair of activePairs) {\n        const pairPositions = getPositionsForPair(pair);\n        const hasPosition = pairPositions.length > 0;\n        const totalPositionUsd = pairPositions.reduce((sum, p) => sum + (p.amount * p.entryPrice), 0);\n        const exposure = this.getAvailableExposure(pair, config, this.currentUsdBalance);\n        \n        // Determinar raz√≥n basada en el estado real\n        let razon = \"Bot inactivo - act√≠valo para escanear\";\n        if (this.isRunning) {\n          if (this.lastScanTime > 0) {\n            // El bot ha escaneado pero este par no tiene resultado (puede ser por filtro u otra raz√≥n)\n            razon = \"Sin se√±al activa\";\n          } else {\n            razon = \"Esperando primer escaneo...\";\n          }\n        }\n        \n        const cooldownSec = this.getCooldownRemainingSec(pair);\n        pairs.push({\n          pair,\n          signal: \"NONE\",\n          razon,\n          cooldownSec: cooldownSec > 0 ? cooldownSec : undefined,\n          exposureAvailable: exposure,\n          hasPosition,\n          positionUsd: hasPosition ? totalPositionUsd : undefined,\n        });\n      }\n    }\n\n    return {\n      pairs,\n      positionMode,\n      usdBalance: this.currentUsdBalance,\n      totalOpenPositions: this.openPositions.size,\n      lastScanAt: this.lastScanTime > 0 ? new Date(this.lastScanTime).toISOString() : null,\n    };\n  }\n}\n","path":null,"size_bytes":158185,"size_tokens":null},"client/src/pages/Integrations.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Nav } from \"@/components/dashboard/Nav\";\nimport generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { MessageSquare, Server, Check, Send, Plus, Trash2, Users, Plug, Eye, EyeOff } from \"lucide-react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { toast } from \"sonner\";\n\ninterface TelegramChat {\n  id: number;\n  name: string;\n  chatId: string;\n  alertTrades: boolean;\n  alertErrors: boolean;\n  alertSystem: boolean;\n  alertBalance: boolean;\n  isActive: boolean;\n}\n\nexport default function Integrations() {\n  const queryClient = useQueryClient();\n  const [krakenApiKey, setKrakenApiKey] = useState(\"\");\n  const [krakenSecret, setKrakenSecret] = useState(\"\");\n  const [krakenConnected, setKrakenConnected] = useState(false);\n  const [showKrakenKey, setShowKrakenKey] = useState(false);\n  const [showKrakenSecret, setShowKrakenSecret] = useState(false);\n  \n  const [telegramToken, setTelegramToken] = useState(\"\");\n  const [telegramChatId, setTelegramChatId] = useState(\"\");\n  const [telegramConnected, setTelegramConnected] = useState(false);\n  const [showTelegramToken, setShowTelegramToken] = useState(false);\n  const [customMessage, setCustomMessage] = useState(\"\");\n\n  const [newChatName, setNewChatName] = useState(\"\");\n  const [newChatId, setNewChatId] = useState(\"\");\n  const [newAlertTrades, setNewAlertTrades] = useState(true);\n  const [newAlertErrors, setNewAlertErrors] = useState(true);\n  const [newAlertSystem, setNewAlertSystem] = useState(true);\n  const [newAlertBalance, setNewAlertBalance] = useState(false);\n\n  const { data: apiConfig } = useQuery({\n    queryKey: [\"apiConfig\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/config/api\");\n      if (!res.ok) throw new Error(\"Failed to fetch config\");\n      return res.json();\n    },\n  });\n\n  const { data: telegramChats = [] } = useQuery<TelegramChat[]>({\n    queryKey: [\"telegramChats\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/telegram/chats\");\n      if (!res.ok) throw new Error(\"Failed to fetch chats\");\n      return res.json();\n    },\n  });\n\n  useEffect(() => {\n    if (apiConfig) {\n      setKrakenConnected(apiConfig.krakenConnected);\n      setTelegramConnected(apiConfig.telegramConnected);\n    }\n  }, [apiConfig]);\n\n  const krakenMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/config/kraken\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ apiKey: krakenApiKey, apiSecret: krakenSecret }),\n      });\n      if (!res.ok) throw new Error(\"Failed to connect\");\n      return res.json();\n    },\n    onSuccess: () => {\n      setKrakenConnected(true);\n      toast.success(\"Kraken conectado correctamente\");\n    },\n    onError: () => {\n      toast.error(\"Error al conectar con Kraken\");\n    },\n  });\n\n  const telegramMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/config/telegram\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ token: telegramToken, chatId: telegramChatId }),\n      });\n      if (!res.ok) throw new Error(\"Failed to connect\");\n      return res.json();\n    },\n    onSuccess: () => {\n      setTelegramConnected(true);\n      toast.success(\"Telegram conectado correctamente\");\n    },\n    onError: () => {\n      toast.error(\"Error al conectar con Telegram\");\n    },\n  });\n\n  const sendMessageMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/telegram/send\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ message: customMessage }),\n      });\n      if (!res.ok) throw new Error(\"Failed to send\");\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Mensaje enviado a Telegram\");\n      setCustomMessage(\"\");\n    },\n    onError: () => {\n      toast.error(\"Error al enviar mensaje\");\n    },\n  });\n\n  const createChatMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch(\"/api/telegram/chats\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          name: newChatName,\n          chatId: newChatId,\n          alertTrades: newAlertTrades,\n          alertErrors: newAlertErrors,\n          alertSystem: newAlertSystem,\n          alertBalance: newAlertBalance,\n        }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to create chat\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Chat a√±adido correctamente\");\n      setNewChatName(\"\");\n      setNewChatId(\"\");\n      setNewAlertTrades(true);\n      setNewAlertErrors(true);\n      setNewAlertSystem(true);\n      setNewAlertBalance(false);\n      queryClient.invalidateQueries({ queryKey: [\"telegramChats\"] });\n    },\n    onError: (error: Error) => {\n      toast.error(error.message);\n    },\n  });\n\n  const deleteChatMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await fetch(`/api/telegram/chats/${id}`, {\n        method: \"DELETE\",\n      });\n      if (!res.ok) throw new Error(\"Failed to delete\");\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Chat eliminado\");\n      queryClient.invalidateQueries({ queryKey: [\"telegramChats\"] });\n    },\n    onError: () => {\n      toast.error(\"Error al eliminar chat\");\n    },\n  });\n\n  const updateChatMutation = useMutation({\n    mutationFn: async ({ id, ...data }: { id: number } & Partial<TelegramChat>) => {\n      const res = await fetch(`/api/telegram/chats/${id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      if (!res.ok) throw new Error(\"Failed to update\");\n      return res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"telegramChats\"] });\n    },\n    onError: () => {\n      toast.error(\"Error al actualizar chat\");\n    },\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col relative overflow-hidden\">\n      <div \n        className=\"fixed inset-0 z-0 opacity-20 pointer-events-none\" \n        style={{ \n          backgroundImage: `url(${generatedImage})`, \n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          mixBlendMode: 'overlay'\n        }} \n      />\n      \n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        <Nav />\n        \n        <main className=\"flex-1 p-6 max-w-4xl mx-auto w-full space-y-8\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold font-sans tracking-tight flex items-center gap-3\">\n                <Plug className=\"h-8 w-8 text-primary\" />\n                Integraciones\n              </h1>\n              <p className=\"text-muted-foreground mt-1\">Gestiona todas las conexiones y credenciales de APIs.</p>\n            </div>\n          </div>\n\n          <div className=\"grid gap-6\">\n            {/* Kraken API */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-orange-500/20 rounded-lg\">\n                    <Server className=\"h-6 w-6 text-orange-400\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <CardTitle>Kraken Exchange</CardTitle>\n                    <CardDescription>Conecta tu cuenta de Kraken para trading real.</CardDescription>\n                  </div>\n                  {krakenConnected ? (\n                    <div className=\"flex items-center gap-2 text-green-500\">\n                      <Check className=\"h-5 w-5\" />\n                      <span className=\"text-sm font-mono\">CONECTADO</span>\n                    </div>\n                  ) : (\n                    <span className=\"text-sm font-mono text-yellow-500\">DESCONECTADO</span>\n                  )}\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid gap-2\">\n                  <Label>API Key</Label>\n                  <div className=\"relative\">\n                    <Input \n                      type={showKrakenKey ? \"text\" : \"password\"}\n                      placeholder=\"Tu Kraken API Key\" \n                      className=\"font-mono bg-background/50 pr-10\"\n                      value={krakenApiKey}\n                      onChange={(e) => setKrakenApiKey(e.target.value)}\n                      data-testid=\"input-kraken-api-key\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"absolute right-0 top-0 h-full\"\n                      onClick={() => setShowKrakenKey(!showKrakenKey)}\n                    >\n                      {showKrakenKey ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                    </Button>\n                  </div>\n                </div>\n                <div className=\"grid gap-2\">\n                  <Label>API Secret</Label>\n                  <div className=\"relative\">\n                    <Input \n                      type={showKrakenSecret ? \"text\" : \"password\"}\n                      placeholder=\"Tu Kraken API Secret\" \n                      className=\"font-mono bg-background/50 pr-10\"\n                      value={krakenSecret}\n                      onChange={(e) => setKrakenSecret(e.target.value)}\n                      data-testid=\"input-kraken-secret\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"absolute right-0 top-0 h-full\"\n                      onClick={() => setShowKrakenSecret(!showKrakenSecret)}\n                    >\n                      {showKrakenSecret ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                    </Button>\n                  </div>\n                </div>\n                <Button \n                  className=\"w-full bg-orange-600 hover:bg-orange-700\" \n                  onClick={() => krakenMutation.mutate()}\n                  disabled={!krakenApiKey || !krakenSecret || krakenMutation.isPending}\n                  data-testid=\"button-connect-kraken\"\n                >\n                  {krakenMutation.isPending ? \"Conectando...\" : krakenConnected ? \"Reconectar\" : \"Conectar a Kraken\"}\n                </Button>\n                <p className=\"text-xs text-muted-foreground\">\n                  Obt√©n tus credenciales en <a href=\"https://www.kraken.com/u/security/api\" target=\"_blank\" rel=\"noopener\" className=\"text-primary hover:underline\">kraken.com/u/security/api</a>\n                </p>\n              </CardContent>\n            </Card>\n\n            {/* Telegram Bot */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-blue-500/20 rounded-lg\">\n                    <MessageSquare className=\"h-6 w-6 text-blue-400\" />\n                  </div>\n                  <div className=\"flex-1\">\n                    <CardTitle>Telegram Bot</CardTitle>\n                    <CardDescription>Recibe alertas y controla el bot desde Telegram.</CardDescription>\n                  </div>\n                  {telegramConnected ? (\n                    <div className=\"flex items-center gap-2 text-green-500\">\n                      <Check className=\"h-5 w-5\" />\n                      <span className=\"text-sm font-mono\">CONECTADO</span>\n                    </div>\n                  ) : (\n                    <span className=\"text-sm font-mono text-yellow-500\">DESCONECTADO</span>\n                  )}\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid gap-2\">\n                  <Label>Bot Token (de @BotFather)</Label>\n                  <div className=\"relative\">\n                    <Input \n                      type={showTelegramToken ? \"text\" : \"password\"}\n                      placeholder=\"123456789:ABCdefGHIjklMNOpqrsTUVwxyz\" \n                      className=\"font-mono bg-background/50 pr-10\"\n                      value={telegramToken}\n                      onChange={(e) => setTelegramToken(e.target.value)}\n                      data-testid=\"input-telegram-token\"\n                    />\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"icon\"\n                      className=\"absolute right-0 top-0 h-full\"\n                      onClick={() => setShowTelegramToken(!showTelegramToken)}\n                    >\n                      {showTelegramToken ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                    </Button>\n                  </div>\n                </div>\n                <div className=\"grid gap-2\">\n                  <Label>Chat ID principal</Label>\n                  <Input \n                    placeholder=\"-1001234567890\" \n                    className=\"font-mono bg-background/50\"\n                    value={telegramChatId}\n                    onChange={(e) => setTelegramChatId(e.target.value)}\n                    data-testid=\"input-telegram-chatid\"\n                  />\n                </div>\n                <Button \n                  className=\"w-full\"\n                  onClick={() => telegramMutation.mutate()}\n                  disabled={!telegramToken || !telegramChatId || telegramMutation.isPending}\n                  data-testid=\"button-connect-telegram\"\n                >\n                  {telegramMutation.isPending ? \"Probando...\" : telegramConnected ? \"Reconectar\" : \"Conectar Telegram\"}\n                </Button>\n                \n                {telegramConnected && (\n                  <div className=\"pt-4 border-t border-border/50 space-y-3\">\n                    <Label>Enviar mensaje de prueba</Label>\n                    <Textarea\n                      placeholder=\"Escribe un mensaje para enviar a Telegram...\"\n                      className=\"bg-background/50 min-h-[80px]\"\n                      value={customMessage}\n                      onChange={(e) => setCustomMessage(e.target.value)}\n                      data-testid=\"input-custom-message\"\n                    />\n                    <Button \n                      variant=\"outline\"\n                      className=\"w-full\"\n                      onClick={() => sendMessageMutation.mutate()}\n                      disabled={!customMessage.trim() || sendMessageMutation.isPending}\n                      data-testid=\"button-send-message\"\n                    >\n                      <Send className=\"mr-2 h-4 w-4\" />\n                      {sendMessageMutation.isPending ? \"Enviando...\" : \"Enviar Mensaje\"}\n                    </Button>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Comandos: /estado, /pausar, /reanudar, /ultimas, /ayuda\n                    </p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Multi-Chat Telegram */}\n            {telegramConnected && (\n              <Card className=\"glass-panel border-border/50\">\n                <CardHeader>\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-purple-500/20 rounded-lg\">\n                      <Users className=\"h-6 w-6 text-purple-400\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <CardTitle>Multi-Chat Telegram</CardTitle>\n                      <CardDescription>Env√≠a alertas a m√∫ltiples chats con configuraci√≥n individual.</CardDescription>\n                    </div>\n                    <span className=\"text-sm text-muted-foreground\">{telegramChats.length} chat(s)</span>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {telegramChats.length > 0 && (\n                    <div className=\"space-y-3\">\n                      {telegramChats.map((chat) => (\n                        <div key={chat.id} className=\"p-4 border border-border rounded-lg bg-card/30 space-y-3\">\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className={`h-2 w-2 rounded-full ${chat.isActive ? 'bg-green-500' : 'bg-gray-500'}`}></span>\n                              <span className=\"font-medium\">{chat.name}</span>\n                              <span className=\"text-xs text-muted-foreground font-mono\">({chat.chatId})</span>\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Switch \n                                checked={chat.isActive}\n                                onCheckedChange={(checked) => updateChatMutation.mutate({ id: chat.id, isActive: checked })}\n                              />\n                              <Button \n                                variant=\"ghost\" \n                                size=\"icon\"\n                                onClick={() => deleteChatMutation.mutate(chat.id)}\n                                data-testid={`button-delete-chat-${chat.id}`}\n                              >\n                                <Trash2 className=\"h-4 w-4 text-red-500\" />\n                              </Button>\n                            </div>\n                          </div>\n                          <div className=\"flex flex-wrap gap-2\">\n                            <Button \n                              variant={chat.alertTrades ? \"default\" : \"outline\"} \n                              size=\"sm\"\n                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertTrades: !chat.alertTrades })}\n                            >\n                              Trades\n                            </Button>\n                            <Button \n                              variant={chat.alertErrors ? \"default\" : \"outline\"} \n                              size=\"sm\"\n                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertErrors: !chat.alertErrors })}\n                            >\n                              Errores\n                            </Button>\n                            <Button \n                              variant={chat.alertSystem ? \"default\" : \"outline\"} \n                              size=\"sm\"\n                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertSystem: !chat.alertSystem })}\n                            >\n                              Sistema\n                            </Button>\n                            <Button \n                              variant={chat.alertBalance ? \"default\" : \"outline\"} \n                              size=\"sm\"\n                              onClick={() => updateChatMutation.mutate({ id: chat.id, alertBalance: !chat.alertBalance })}\n                            >\n                              Balance\n                            </Button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  <div className=\"pt-4 border-t border-border/50 space-y-3\">\n                    <Label className=\"flex items-center gap-2\">\n                      <Plus className=\"h-4 w-4\" /> A√±adir nuevo chat\n                    </Label>\n                    <div className=\"grid grid-cols-2 gap-3\">\n                      <div className=\"grid gap-2\">\n                        <Label className=\"text-xs\">Nombre</Label>\n                        <Input \n                          placeholder=\"Mi grupo\" \n                          className=\"bg-background/50\"\n                          value={newChatName}\n                          onChange={(e) => setNewChatName(e.target.value)}\n                          data-testid=\"input-new-chat-name\"\n                        />\n                      </div>\n                      <div className=\"grid gap-2\">\n                        <Label className=\"text-xs\">Chat ID</Label>\n                        <Input \n                          placeholder=\"-1001234567890\" \n                          className=\"font-mono bg-background/50\"\n                          value={newChatId}\n                          onChange={(e) => setNewChatId(e.target.value)}\n                          data-testid=\"input-new-chat-id\"\n                        />\n                      </div>\n                    </div>\n                    <div className=\"flex flex-wrap gap-4\">\n                      <div className=\"flex items-center gap-2\">\n                        <Switch checked={newAlertTrades} onCheckedChange={setNewAlertTrades} />\n                        <Label className=\"text-sm\">Trades</Label>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Switch checked={newAlertErrors} onCheckedChange={setNewAlertErrors} />\n                        <Label className=\"text-sm\">Errores</Label>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Switch checked={newAlertSystem} onCheckedChange={setNewAlertSystem} />\n                        <Label className=\"text-sm\">Sistema</Label>\n                      </div>\n                      <div className=\"flex items-center gap-2\">\n                        <Switch checked={newAlertBalance} onCheckedChange={setNewAlertBalance} />\n                        <Label className=\"text-sm\">Balance</Label>\n                      </div>\n                    </div>\n                    <Button \n                      className=\"w-full\"\n                      onClick={() => createChatMutation.mutate()}\n                      disabled={!newChatName.trim() || !newChatId.trim() || createChatMutation.isPending}\n                      data-testid=\"button-add-chat\"\n                    >\n                      <Plus className=\"mr-2 h-4 w-4\" />\n                      {createChatMutation.isPending ? \"A√±adiendo...\" : \"A√±adir Chat\"}\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n          </div>\n        </main>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":23168,"size_tokens":null},"client/src/pages/Guide.tsx":{"content":"import { Nav } from \"@/components/dashboard/Nav\";\nimport generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { \n  BookOpen, \n  Zap, \n  Settings, \n  AlertTriangle, \n  CheckCircle2, \n  TrendingUp, \n  TrendingDown,\n  Activity,\n  Target,\n  RefreshCw,\n  Shield,\n  DollarSign,\n  Clock,\n  BarChart3,\n  Plug,\n  HelpCircle,\n  ListChecks,\n  Lightbulb,\n  XCircle,\n  WifiOff,\n  Key,\n  Percent,\n  CandlestickChart,\n  Bell,\n  Database\n} from \"lucide-react\";\n\nexport default function Guide() {\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col relative overflow-hidden\">\n      <div \n        className=\"fixed inset-0 z-0 opacity-20 pointer-events-none\" \n        style={{ \n          backgroundImage: `url(${generatedImage})`, \n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          mixBlendMode: 'overlay'\n        }} \n      />\n      \n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        <Nav />\n        \n        <main className=\"flex-1 p-4 md:p-6 max-w-5xl mx-auto w-full space-y-6 md:space-y-8\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 bg-primary/20 rounded-lg\">\n              <BookOpen className=\"h-6 w-6 md:h-8 md:w-8 text-primary\" />\n            </div>\n            <div>\n              <h1 className=\"text-xl md:text-3xl font-bold font-sans tracking-tight\">Gu√≠a del Bot</h1>\n              <p className=\"text-sm md:text-base text-muted-foreground\">Manual completo de uso y configuraci√≥n</p>\n            </div>\n          </div>\n\n          <div className=\"grid gap-6\">\n            \n            {/* Secci√≥n 1: ¬øQu√© hace este bot? */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-cyan-500/20 rounded-lg\">\n                    <Zap className=\"h-6 w-6 text-cyan-400\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-lg md:text-xl\">1. ¬øQu√© hace este bot?</CardTitle>\n                    <CardDescription>Resumen general del funcionamiento</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <p className=\"text-sm md:text-base text-muted-foreground leading-relaxed\">\n                  KrakenBot.AI es un bot de trading autom√°tico que opera en el exchange Kraken. \n                  Analiza el mercado 24/7 usando indicadores t√©cnicos avanzados y ejecuta operaciones \n                  de compra/venta de forma aut√≥noma seg√∫n la estrategia configurada.\n                </p>\n                \n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div className=\"p-4 border border-border rounded-lg bg-card/30\">\n                    <h4 className=\"font-semibold mb-2 flex items-center gap-2\">\n                      <Activity className=\"h-4 w-4 text-primary\" />\n                      Estrategias incluidas\n                    </h4>\n                    <ul className=\"text-sm text-muted-foreground space-y-1\">\n                      <li className=\"flex items-center gap-2\">\n                        <TrendingUp className=\"h-3 w-3 text-green-500\" />\n                        <strong>Momentum:</strong> Sigue tendencias fuertes\n                      </li>\n                      <li className=\"flex items-center gap-2\">\n                        <RefreshCw className=\"h-3 w-3 text-blue-500\" />\n                        <strong>Reversi√≥n a la media:</strong> Opera en extremos\n                      </li>\n                      <li className=\"flex items-center gap-2\">\n                        <Zap className=\"h-3 w-3 text-yellow-500\" />\n                        <strong>Scalping:</strong> Operaciones r√°pidas\n                      </li>\n                      <li className=\"flex items-center gap-2\">\n                        <Target className=\"h-3 w-3 text-purple-500\" />\n                        <strong>Grid:</strong> √ìrdenes escalonadas\n                      </li>\n                    </ul>\n                  </div>\n                  \n                  <div className=\"p-4 border border-border rounded-lg bg-card/30\">\n                    <h4 className=\"font-semibold mb-2 flex items-center gap-2\">\n                      <DollarSign className=\"h-4 w-4 text-primary\" />\n                      Pares soportados\n                    </h4>\n                    <div className=\"flex flex-wrap gap-2\">\n                      <Badge variant=\"outline\">BTC/USD</Badge>\n                      <Badge variant=\"outline\">ETH/USD</Badge>\n                      <Badge variant=\"outline\">SOL/USD</Badge>\n                      <Badge variant=\"outline\">XRP/USD</Badge>\n                      <Badge variant=\"outline\">TON/USD</Badge>\n                      <Badge variant=\"outline\">ETH/BTC</Badge>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"p-4 border border-primary/30 rounded-lg bg-primary/5\">\n                  <h4 className=\"font-semibold mb-2 flex items-center gap-2\">\n                    <BarChart3 className=\"h-4 w-4 text-primary\" />\n                    Indicadores t√©cnicos utilizados\n                  </h4>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2 text-sm\">\n                    <span className=\"text-muted-foreground\">‚Ä¢ MACD</span>\n                    <span className=\"text-muted-foreground\">‚Ä¢ RSI</span>\n                    <span className=\"text-muted-foreground\">‚Ä¢ Bollinger Bands</span>\n                    <span className=\"text-muted-foreground\">‚Ä¢ EMAs (9, 21, 50)</span>\n                    <span className=\"text-muted-foreground\">‚Ä¢ Volumen</span>\n                    <span className=\"text-muted-foreground\">‚Ä¢ ATR</span>\n                    <span className=\"text-muted-foreground\">‚Ä¢ Multi-timeframe</span>\n                    <span className=\"text-muted-foreground\">‚Ä¢ An√°lisis de tendencia</span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Secci√≥n 2: Pasos para usar el bot */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-green-500/20 rounded-lg\">\n                    <ListChecks className=\"h-6 w-6 text-green-400\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-lg md:text-xl\">2. Pasos para usar el bot</CardTitle>\n                    <CardDescription>Flujo b√°sico de configuraci√≥n</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-4\">\n                  {[\n                    { step: 1, title: \"Configurar API de Kraken\", desc: \"Ve a Integraciones y a√±ade tu API Key y Secret de Kraken. Aseg√∫rate de que la API tenga permisos de trading.\", icon: Key },\n                    { step: 2, title: \"Configurar Telegram (opcional)\", desc: \"A√±ade el token de tu bot de Telegram y tu Chat ID para recibir notificaciones de operaciones.\", icon: Plug },\n                    { step: 3, title: \"Elegir estrategia\", desc: \"En la p√°gina Estrategias, selecciona el algoritmo que mejor se adapte a tu estilo (momentum, scalping, etc.).\", icon: Activity },\n                    { step: 4, title: \"Ajustar par√°metros de riesgo\", desc: \"Configura el nivel de riesgo, Stop Loss y Take Profit seg√∫n tu tolerancia.\", icon: Shield },\n                    { step: 5, title: \"Activar el bot\", desc: \"Activa el switch 'Bot Activo' y el bot comenzar√° a analizar el mercado y operar autom√°ticamente.\", icon: Zap },\n                  ].map((item) => (\n                    <div key={item.step} className=\"flex gap-4 p-4 border border-border rounded-lg bg-card/30\">\n                      <div className=\"flex-shrink-0 h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center font-bold text-primary\">\n                        {item.step}\n                      </div>\n                      <div className=\"flex-1\">\n                        <h4 className=\"font-semibold flex items-center gap-2\">\n                          <item.icon className=\"h-4 w-4 text-primary\" />\n                          {item.title}\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground mt-1\">{item.desc}</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Secci√≥n 3: Par√°metros y definiciones */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-purple-500/20 rounded-lg\">\n                    <Settings className=\"h-6 w-6 text-purple-400\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-lg md:text-xl\">3. Par√°metros y definiciones</CardTitle>\n                    <CardDescription>Explicaci√≥n detallada de cada configuraci√≥n</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent>\n                <Accordion type=\"single\" collapsible className=\"w-full\">\n                  \n                  <AccordionItem value=\"strategy\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Activity className=\"h-4 w-4 text-primary\" />\n                        Estrategia de Trading\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> El algoritmo que el bot usa para decidir cu√°ndo comprar o vender.</p>\n                      <div className=\"space-y-2\">\n                        <div className=\"p-3 bg-card/50 rounded border border-border\">\n                          <p className=\"font-medium text-green-400\">Momentum</p>\n                          <p className=\"text-muted-foreground\">Sigue tendencias fuertes. Compra cuando el precio sube con fuerza, vende cuando baja. Ideal para mercados con tendencia clara.</p>\n                        </div>\n                        <div className=\"p-3 bg-card/50 rounded border border-border\">\n                          <p className=\"font-medium text-blue-400\">Reversi√≥n a la Media</p>\n                          <p className=\"text-muted-foreground\">Opera cuando el precio se aleja mucho de su promedio. Compra en ca√≠das extremas, vende en subidas extremas.</p>\n                        </div>\n                        <div className=\"p-3 bg-card/50 rounded border border-border\">\n                          <p className=\"font-medium text-yellow-400\">Scalping</p>\n                          <p className=\"text-muted-foreground\">Muchas operaciones peque√±as y r√°pidas. Busca peque√±os beneficios frecuentes. Requiere m√°s comisiones.</p>\n                        </div>\n                        <div className=\"p-3 bg-card/50 rounded border border-border\">\n                          <p className=\"font-medium text-purple-400\">Grid Trading</p>\n                          <p className=\"text-muted-foreground\">Coloca √≥rdenes de compra y venta en niveles de precio fijos. Funciona bien en mercados laterales.</p>\n                        </div>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"signalmode\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <CandlestickChart className=\"h-4 w-4 text-cyan-500\" />\n                        Modo de Se√±al (Solo Momentum)\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> Define cu√°ndo y c√≥mo el bot eval√∫a las se√±ales de trading cuando usas la estrategia Momentum.</p>\n                      <div className=\"space-y-2\">\n                        <div className=\"p-3 bg-card/50 rounded border border-border\">\n                          <p className=\"font-medium text-primary\">Ciclos (30 segundos)</p>\n                          <p className=\"text-muted-foreground\">Eval√∫a precios en tiempo real cada ciclo del bot (~30s). Usa indicadores sobre datos de ticks. M√°s reactivo pero puede generar m√°s se√±ales falsas. <strong>Ideal para:</strong> Trading activo, mercados muy vol√°tiles.</p>\n                        </div>\n                        <div className=\"p-3 bg-cyan-500/10 rounded border border-cyan-500/30\">\n                          <p className=\"font-medium text-cyan-400\">Velas 5 minutos</p>\n                          <p className=\"text-muted-foreground\">Solo eval√∫a al cierre de cada vela de 5 min. Usa an√°lisis OHLC completo: EMA, RSI, MACD, patrones de velas (Engulfing), volumen relativo. <strong>Ideal para:</strong> Balance entre rapidez y confirmaci√≥n.</p>\n                        </div>\n                        <div className=\"p-3 bg-cyan-500/10 rounded border border-cyan-500/30\">\n                          <p className=\"font-medium text-cyan-400\">Velas 15 minutos</p>\n                          <p className=\"text-muted-foreground\">Eval√∫a cada 15 minutos al cierre de vela. Menos ruido del mercado, se√±ales m√°s confirmadas. <strong>Ideal para:</strong> Swing trading, menos operaciones pero m√°s seguras.</p>\n                        </div>\n                        <div className=\"p-3 bg-cyan-500/10 rounded border border-cyan-500/30\">\n                          <p className=\"font-medium text-cyan-400\">Velas 1 hora</p>\n                          <p className=\"text-muted-foreground\">Evaluaci√≥n cada hora. M√≠nimas se√±ales falsas, solo opera en tendencias claras y confirmadas. <strong>Ideal para:</strong> Posiciones largas, m√≠nima intervenci√≥n.</p>\n                        </div>\n                      </div>\n                      <div className=\"p-3 bg-primary/10 rounded border border-primary/30\">\n                        <p className=\"text-xs\"><strong>Nota:</strong> En modo Velas, el bot usa an√°lisis OHLC avanzado incluyendo patrones de velas japonesas (Engulfing alcista/bajista), Bandas de Bollinger, y an√°lisis de volumen relativo que no est√°n disponibles en modo Ciclos.</p>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"risk\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Shield className=\"h-4 w-4 text-primary\" />\n                        Nivel de Riesgo\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> Controla el tama√±o de las posiciones y la agresividad del bot.</p>\n                      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2\">\n                        <div className=\"p-3 bg-green-500/10 rounded border border-green-500/30\">\n                          <p className=\"font-medium text-green-400\">Bajo</p>\n                          <p className=\"text-muted-foreground text-xs\">Posiciones peque√±as, stops ajustados. Menor ganancia pero menor riesgo.</p>\n                        </div>\n                        <div className=\"p-3 bg-yellow-500/10 rounded border border-yellow-500/30\">\n                          <p className=\"font-medium text-yellow-400\">Medio</p>\n                          <p className=\"text-muted-foreground text-xs\">Balance entre riesgo y rendimiento. Recomendado para la mayor√≠a.</p>\n                        </div>\n                        <div className=\"p-3 bg-red-500/10 rounded border border-red-500/30\">\n                          <p className=\"font-medium text-red-400\">Alto</p>\n                          <p className=\"text-muted-foreground text-xs\">Posiciones grandes, m√°s volatilidad. Mayor ganancia potencial pero m√°s riesgo.</p>\n                        </div>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"stoploss\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <TrendingDown className=\"h-4 w-4 text-red-500\" />\n                        Stop Loss (%)\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> Porcentaje m√°ximo de p√©rdida que el bot tolerar√° antes de cerrar una posici√≥n autom√°ticamente.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p><strong>Valores recomendados:</strong> Entre 2% y 5%</p>\n                        <p className=\"text-muted-foreground mt-1\">\n                          <strong>Muy bajo (1%):</strong> Se cerrar√°n posiciones muy r√°pido, posibles p√©rdidas por volatilidad normal.<br/>\n                          <strong>Muy alto (10%+):</strong> P√©rdidas grandes si el mercado va en contra.\n                        </p>\n                      </div>\n                      <p className=\"text-muted-foreground\">\n                        <strong>Ejemplo:</strong> Si compras BTC a $100,000 con Stop Loss 3%, la posici√≥n se cerrar√° autom√°ticamente si BTC baja a $97,000.\n                      </p>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"takeprofit\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <TrendingUp className=\"h-4 w-4 text-green-500\" />\n                        Take Profit (%)\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> Porcentaje de ganancia objetivo. Cuando se alcanza, el bot cierra la posici√≥n asegurando beneficios.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p><strong>Valores recomendados:</strong> Entre 3% y 10%</p>\n                        <p className=\"text-muted-foreground mt-1\">\n                          <strong>Muy bajo (1%):</strong> Ganancias peque√±as, las comisiones pueden comerlas.<br/>\n                          <strong>Muy alto (20%+):</strong> Dif√≠cil de alcanzar, el precio puede revertir antes.\n                        </p>\n                      </div>\n                      <p className=\"text-muted-foreground\">\n                        <strong>Ejemplo:</strong> Si compras ETH a $3,000 con Take Profit 5%, la posici√≥n se cerrar√° autom√°ticamente cuando ETH llegue a $3,150.\n                      </p>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"trailing\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Percent className=\"h-4 w-4 text-primary\" />\n                        Trailing Stop\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> Un stop loss din√°mico que sigue al precio cuando este sube, asegurando ganancias progresivamente.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p><strong>C√≥mo funciona:</strong></p>\n                        <p className=\"text-muted-foreground mt-1\">\n                          Si activas Trailing Stop al 2% y el precio sube un 5%, el stop se mueve autom√°ticamente para asegurar al menos un 3% de ganancia.\n                        </p>\n                      </div>\n                      <p className=\"text-muted-foreground\">\n                        <strong>Recomendaci√≥n:</strong> Act√≠valo si quieres capturar tendencias largas sin preocuparte por el Take Profit fijo.\n                      </p>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"pairs\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <DollarSign className=\"h-4 w-4 text-primary\" />\n                        Pares Activos\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> Las criptomonedas que el bot analizar√° y operar√°.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p className=\"text-muted-foreground\">\n                          <strong>Pocos pares (1-2):</strong> El bot se concentra en esos mercados, operaciones m√°s frecuentes por par.<br/>\n                          <strong>Muchos pares (5+):</strong> M√°s oportunidades pero el capital se divide, operaciones m√°s peque√±as.\n                        </p>\n                      </div>\n                      <p className=\"text-muted-foreground\">\n                        <strong>Recomendaci√≥n para saldos peque√±os:</strong> Activa solo 1-2 pares con mejor liquidez (BTC/USD, ETH/USD).\n                      </p>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"timeframes\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Clock className=\"h-4 w-4 text-primary\" />\n                        Multi-Timeframe\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> El bot analiza m√∫ltiples marcos temporales para confirmar se√±ales.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p className=\"text-muted-foreground\">\n                          <strong>5 minutos:</strong> Se√±ales de entrada r√°pidas<br/>\n                          <strong>1 hora:</strong> Tendencia a corto plazo<br/>\n                          <strong>4 horas:</strong> Tendencia general del mercado\n                        </p>\n                      </div>\n                      <p className=\"text-muted-foreground\">\n                        El bot no operar√° contra la tendencia principal. Si los 3 timeframes coinciden en direcci√≥n, a√±ade +15% de confianza a la se√±al.\n                      </p>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"indicators\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <BarChart3 className=\"h-4 w-4 text-primary\" />\n                        Indicadores T√©cnicos por Estrategia\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© son?</strong> F√≥rmulas matem√°ticas que analizan el precio y volumen para predecir movimientos.</p>\n                      <div className=\"space-y-2\">\n                        <div className=\"p-3 bg-green-500/10 rounded border border-green-500/30\">\n                          <p className=\"font-medium text-green-400\">Momentum usa:</p>\n                          <ul className=\"text-muted-foreground text-xs mt-1 space-y-1\">\n                            <li>‚Ä¢ <strong>EMAs (9, 21, 50):</strong> Medias m√≥viles exponenciales para detectar tendencia</li>\n                            <li>‚Ä¢ <strong>MACD:</strong> Se√±al=12, L√≠nea=26, Histograma para momentum</li>\n                            <li>‚Ä¢ <strong>RSI (14):</strong> Fuerza relativa, se√±ales cuando &gt;70 o &lt;30</li>\n                          </ul>\n                        </div>\n                        <div className=\"p-3 bg-blue-500/10 rounded border border-blue-500/30\">\n                          <p className=\"font-medium text-blue-400\">Reversi√≥n a la Media usa:</p>\n                          <ul className=\"text-muted-foreground text-xs mt-1 space-y-1\">\n                            <li>‚Ä¢ <strong>Bollinger Bands (20, 2):</strong> Detecta extremos de precio</li>\n                            <li>‚Ä¢ <strong>RSI (14):</strong> Sobreventa &lt;30 = compra, sobrecompra &gt;70 = venta</li>\n                            <li>‚Ä¢ <strong>EMA 50:</strong> Referencia de precio promedio</li>\n                          </ul>\n                        </div>\n                        <div className=\"p-3 bg-yellow-500/10 rounded border border-yellow-500/30\">\n                          <p className=\"font-medium text-yellow-400\">Scalping usa:</p>\n                          <ul className=\"text-muted-foreground text-xs mt-1 space-y-1\">\n                            <li>‚Ä¢ <strong>EMAs r√°pidas (9, 21):</strong> Cruces para entradas r√°pidas</li>\n                            <li>‚Ä¢ <strong>Volumen:</strong> Confirma fuerza del movimiento</li>\n                            <li>‚Ä¢ <strong>ATR:</strong> Volatilidad para ajustar stops din√°micos</li>\n                          </ul>\n                        </div>\n                        <div className=\"p-3 bg-purple-500/10 rounded border border-purple-500/30\">\n                          <p className=\"font-medium text-purple-400\">Grid Trading usa:</p>\n                          <ul className=\"text-muted-foreground text-xs mt-1 space-y-1\">\n                            <li>‚Ä¢ <strong>ATR:</strong> Calcula separaci√≥n entre niveles del grid</li>\n                            <li>‚Ä¢ <strong>Soporte/Resistencia:</strong> Define l√≠mites del grid</li>\n                            <li>‚Ä¢ <strong>Volumen:</strong> Valida zonas de acumulaci√≥n</li>\n                          </ul>\n                        </div>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"position-size\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Target className=\"h-4 w-4 text-primary\" />\n                        Tama√±o de Posici√≥n y Riesgo Diario\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> La cantidad de capital que el bot arriesga en cada operaci√≥n y el l√≠mite diario.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p><strong>C√°lculo autom√°tico por operaci√≥n:</strong></p>\n                        <p className=\"text-muted-foreground mt-1\">\n                          El bot calcula el tama√±o bas√°ndose en:<br/>\n                          ‚Ä¢ Tu saldo disponible<br/>\n                          ‚Ä¢ El nivel de riesgo seleccionado (bajo/medio/alto)<br/>\n                          ‚Ä¢ El Stop Loss configurado<br/>\n                          ‚Ä¢ Los m√≠nimos de orden de Kraken\n                        </p>\n                      </div>\n                      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2\">\n                        <div className=\"p-2 bg-green-500/10 rounded text-xs\">\n                          <p className=\"font-medium text-green-400\">Riesgo Bajo</p>\n                          <p className=\"text-muted-foreground\">~1-2% por operaci√≥n</p>\n                          <p className=\"text-muted-foreground\">~5% m√°x. diario</p>\n                        </div>\n                        <div className=\"p-2 bg-yellow-500/10 rounded text-xs\">\n                          <p className=\"font-medium text-yellow-400\">Riesgo Medio</p>\n                          <p className=\"text-muted-foreground\">~3-5% por operaci√≥n</p>\n                          <p className=\"text-muted-foreground\">~10% m√°x. diario</p>\n                        </div>\n                        <div className=\"p-2 bg-red-500/10 rounded text-xs\">\n                          <p className=\"font-medium text-red-400\">Riesgo Alto</p>\n                          <p className=\"text-muted-foreground\">~5-10% por operaci√≥n</p>\n                          <p className=\"text-muted-foreground\">~20% m√°x. diario</p>\n                        </div>\n                      </div>\n                      <div className=\"p-3 bg-yellow-500/10 rounded border border-yellow-500/30\">\n                        <p className=\"font-medium text-yellow-400\">L√≠mite de p√©rdida diaria</p>\n                        <p className=\"text-muted-foreground text-xs mt-1\">\n                          El bot controla las p√©rdidas acumuladas del d√≠a. Si alcanzas el l√≠mite diario, \n                          el bot pausa las operaciones hasta el d√≠a siguiente para proteger tu capital.\n                          Monitorea tu historial de operaciones para verificar el rendimiento diario.\n                        </p>\n                      </div>\n                      <p className=\"text-muted-foreground\">\n                        <strong>Ejemplo:</strong> Con $100 de saldo y riesgo medio, cada operaci√≥n usar√° ~$3-5 y el bot parar√° si pierdes m√°s de $10 en un d√≠a.\n                      </p>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"position-tracking\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Database className=\"h-4 w-4 text-primary\" />\n                        Seguimiento de Posiciones\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> Cada posici√≥n abierta guarda informaci√≥n sobre c√≥mo fue creada.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p className=\"font-medium mb-2\">Estrategia \"Grandfather\"</p>\n                        <p className=\"text-muted-foreground\">\n                          Cuando el bot abre una posici√≥n, guarda:<br/>\n                          ‚Ä¢ <strong>Estrategia usada:</strong> Momentum, Scalping, etc.<br/>\n                          ‚Ä¢ <strong>Timeframe de se√±al:</strong> Ciclos, 5m, 15m, 1h<br/>\n                          ‚Ä¢ <strong>Confianza de la se√±al:</strong> Porcentaje de certeza<br/>\n                          ‚Ä¢ <strong>Raz√≥n:</strong> Indicadores que activaron la compra\n                        </p>\n                      </div>\n                      <div className=\"p-3 bg-cyan-500/10 rounded border border-cyan-500/30\">\n                        <p className=\"font-medium text-cyan-400 mb-1\">¬øPor qu√© es √∫til?</p>\n                        <p className=\"text-muted-foreground text-xs\">\n                          ‚Ä¢ Puedes ver en la tabla de posiciones qu√© estrategia abri√≥ cada trade<br/>\n                          ‚Ä¢ Al ampliar una posici√≥n existente, se mantiene la estrategia original<br/>\n                          ‚Ä¢ Ayuda a analizar qu√© configuraci√≥n funciona mejor para ti\n                        </p>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"telegram\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Bell className=\"h-4 w-4 text-primary\" />\n                        Notificaciones Telegram\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> El bot env√≠a alertas a Telegram cuando ocurren eventos importantes.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p className=\"font-medium mb-2\">Informaci√≥n en cada notificaci√≥n</p>\n                        <p className=\"text-muted-foreground\">\n                          ‚Ä¢ <strong>Tipo:</strong> COMPRA o VENTA<br/>\n                          ‚Ä¢ <strong>Par y cantidad:</strong> Qu√© crypto y cu√°nto<br/>\n                          ‚Ä¢ <strong>Precio:</strong> A qu√© precio se ejecut√≥<br/>\n                          ‚Ä¢ <strong>Estrategia:</strong> Momentum (Velas 5m), etc.<br/>\n                          ‚Ä¢ <strong>Confianza:</strong> Porcentaje de certeza de la se√±al<br/>\n                          ‚Ä¢ <strong>Raz√≥n:</strong> Indicadores que activaron la operaci√≥n\n                        </p>\n                      </div>\n                      <div className=\"p-3 bg-green-500/10 rounded border border-green-500/30\">\n                        <p className=\"font-medium text-green-400 mb-1\">Tipos de alertas</p>\n                        <p className=\"text-muted-foreground text-xs\">\n                          ‚Ä¢ üü¢ Compra ejecutada<br/>\n                          ‚Ä¢ üî¥ Venta ejecutada<br/>\n                          ‚Ä¢ üõë Stop-Loss activado<br/>\n                          ‚Ä¢ üéØ Take-Profit alcanzado<br/>\n                          ‚Ä¢ üìâ Trailing Stop activado<br/>\n                          ‚Ä¢ ‚ö†Ô∏è Errores o l√≠mites alcanzados\n                        </p>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"filters\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Activity className=\"h-4 w-4 text-primary\" />\n                        Filtros de Volatilidad y Volumen\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© son?</strong> Condiciones adicionales que deben cumplirse antes de abrir una operaci√≥n.</p>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p className=\"font-medium mb-2\">Filtro de Volatilidad (ATR)</p>\n                        <p className=\"text-muted-foreground\">\n                          El bot mide la volatilidad usando ATR (Average True Range). Si la volatilidad es muy baja, \n                          no opera porque los movimientos no cubrir√≠an las comisiones. Si es muy alta, reduce el tama√±o de posici√≥n.\n                        </p>\n                      </div>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p className=\"font-medium mb-2\">Filtro de Volumen</p>\n                        <p className=\"text-muted-foreground\">\n                          Compara el volumen actual con el promedio de las √∫ltimas 20 velas. Solo opera cuando el volumen \n                          es al menos 50% del promedio, evitando entrar en mercados \"muertos\" donde el precio puede manipularse f√°cilmente.\n                        </p>\n                      </div>\n                      <p className=\"text-muted-foreground\">\n                        <strong>Beneficio:</strong> Estos filtros reducen operaciones en condiciones desfavorables, mejorando la tasa de acierto.\n                      </p>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                  <AccordionItem value=\"mode\">\n                    <AccordionTrigger className=\"text-left\">\n                      <div className=\"flex items-center gap-2\">\n                        <Zap className=\"h-4 w-4 text-primary\" />\n                        Modo de Operaci√≥n\n                      </div>\n                    </AccordionTrigger>\n                    <AccordionContent className=\"space-y-3 text-sm\">\n                      <p><strong>¬øQu√© es?</strong> El bot est√° configurado para operar exclusivamente en modo REAL.</p>\n                      <div className=\"p-3 bg-yellow-500/10 rounded border border-yellow-500/30\">\n                        <p className=\"font-medium text-yellow-400\">‚ö†Ô∏è Importante</p>\n                        <p className=\"text-muted-foreground mt-1\">\n                          Este bot ejecuta operaciones reales con dinero real en Kraken. No incluye modo paper/demo.\n                          Cada operaci√≥n afectar√° tu saldo real.\n                        </p>\n                      </div>\n                      <div className=\"p-3 bg-card/50 rounded border border-border\">\n                        <p className=\"font-medium mb-2\">Recomendaciones para empezar:</p>\n                        <ul className=\"text-muted-foreground space-y-1\">\n                          <li>‚Ä¢ Empieza con el m√≠nimo capital posible ($10-50)</li>\n                          <li>‚Ä¢ Usa nivel de riesgo BAJO al principio</li>\n                          <li>‚Ä¢ Activa solo 1-2 pares para observar</li>\n                          <li>‚Ä¢ Revisa el historial de operaciones diariamente</li>\n                          <li>‚Ä¢ Aumenta capital solo cuando entiendas el comportamiento</li>\n                        </ul>\n                      </div>\n                    </AccordionContent>\n                  </AccordionItem>\n\n                </Accordion>\n              </CardContent>\n            </Card>\n\n            {/* Secci√≥n 4: Estados del bot y errores */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-orange-500/20 rounded-lg\">\n                    <AlertTriangle className=\"h-6 w-6 text-orange-400\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-lg md:text-xl\">4. Estados del bot y errores t√≠picos</CardTitle>\n                    <CardDescription>Significado de cada estado y c√≥mo solucionar problemas</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                \n                <h4 className=\"font-semibold flex items-center gap-2\">\n                  <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n                  Estados normales\n                </h4>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                  <div className=\"p-3 border border-green-500/30 rounded-lg bg-green-500/5\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"h-2 w-2 rounded-full bg-green-500\"></span>\n                      <span className=\"font-medium\">Bot Activo</span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">El bot est√° analizando el mercado y puede ejecutar operaciones.</p>\n                  </div>\n                  <div className=\"p-3 border border-yellow-500/30 rounded-lg bg-yellow-500/5\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"h-2 w-2 rounded-full bg-yellow-500\"></span>\n                      <span className=\"font-medium\">Bot Pausado</span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">El bot no est√° operando. Act√≠valo manualmente para que empiece.</p>\n                  </div>\n                  <div className=\"p-3 border border-green-500/30 rounded-lg bg-green-500/5\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"h-2 w-2 rounded-full bg-green-500\"></span>\n                      <span className=\"font-medium\">Kraken Conectado</span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">La API de Kraken est√° configurada correctamente y funcionando.</p>\n                  </div>\n                  <div className=\"p-3 border border-green-500/30 rounded-lg bg-green-500/5\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"h-2 w-2 rounded-full bg-green-500\"></span>\n                      <span className=\"font-medium\">Telegram Conectado</span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground\">Las notificaciones de Telegram est√°n activas.</p>\n                  </div>\n                </div>\n\n                <h4 className=\"font-semibold flex items-center gap-2 mt-6\">\n                  <XCircle className=\"h-4 w-4 text-red-500\" />\n                  Errores comunes y soluciones\n                </h4>\n                <div className=\"space-y-3\">\n                  <div className=\"p-4 border border-red-500/30 rounded-lg bg-red-500/5\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n                      <span className=\"font-medium\">Error de Nonce (Invalid nonce)</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mb-2\">\n                      Kraken rechaza la petici√≥n porque el identificador √∫nico de la llamada es inv√°lido.\n                    </p>\n                    <div className=\"text-xs p-2 bg-card/50 rounded\">\n                      <strong>Causas posibles:</strong><br/>\n                      ‚Ä¢ Hay otra instancia del bot usando la misma API Key<br/>\n                      ‚Ä¢ Reinicio muy r√°pido del bot<br/>\n                      <strong>Soluci√≥n:</strong> Verifica que no tengas el bot corriendo en dos sitios (Replit + NAS). El bot reintenta autom√°ticamente 3 veces.\n                    </div>\n                  </div>\n                  \n                  <div className=\"p-4 border border-red-500/30 rounded-lg bg-red-500/5\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <WifiOff className=\"h-4 w-4 text-red-500\" />\n                      <span className=\"font-medium\">Kraken Desconectado</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mb-2\">\n                      El bot no puede comunicarse con Kraken.\n                    </p>\n                    <div className=\"text-xs p-2 bg-card/50 rounded\">\n                      <strong>Causas posibles:</strong><br/>\n                      ‚Ä¢ API Key o Secret incorrectos<br/>\n                      ‚Ä¢ La API no tiene permisos de trading<br/>\n                      ‚Ä¢ Kraken est√° en mantenimiento<br/>\n                      <strong>Soluci√≥n:</strong> Ve a Integraciones y verifica tus credenciales. Regenera la API Key si es necesario.\n                    </div>\n                  </div>\n\n                  <div className=\"p-4 border border-yellow-500/30 rounded-lg bg-yellow-500/5\">\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <DollarSign className=\"h-4 w-4 text-yellow-500\" />\n                      <span className=\"font-medium\">Saldo insuficiente (Insufficient funds)</span>\n                    </div>\n                    <p className=\"text-sm text-muted-foreground mb-2\">\n                      No hay suficiente saldo para ejecutar la operaci√≥n.\n                    </p>\n                    <div className=\"text-xs p-2 bg-card/50 rounded\">\n                      <strong>Causas posibles:</strong><br/>\n                      ‚Ä¢ El saldo disponible es menor que el m√≠nimo de orden de Kraken<br/>\n                      ‚Ä¢ El saldo est√° bloqueado en √≥rdenes abiertas<br/>\n                      ‚Ä¢ Se alcanz√≥ el l√≠mite de p√©rdida diaria<br/>\n                      <strong>Soluci√≥n:</strong> Deposita m√°s fondos en Kraken, cancela √≥rdenes pendientes, o espera al d√≠a siguiente si alcanzaste el l√≠mite diario.\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Secci√≥n 5: Buenas pr√°cticas */}\n            <Card className=\"glass-panel border-border/50\">\n              <CardHeader>\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"p-2 bg-primary/20 rounded-lg\">\n                    <Lightbulb className=\"h-6 w-6 text-primary\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-lg md:text-xl\">5. Buenas pr√°cticas y consejos</CardTitle>\n                    <CardDescription>Recomendaciones para operar de forma segura</CardDescription>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                \n                <div className=\"p-4 border border-primary/30 rounded-lg bg-primary/5\">\n                  <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                    <CheckCircle2 className=\"h-4 w-4 text-primary\" />\n                    Checklist antes de activar el bot\n                  </h4>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm\">\n                    <label className=\"flex items-center gap-2 text-muted-foreground\">\n                      <input type=\"checkbox\" className=\"rounded\" disabled /> API de Kraken configurada y verificada\n                    </label>\n                    <label className=\"flex items-center gap-2 text-muted-foreground\">\n                      <input type=\"checkbox\" className=\"rounded\" disabled /> Telegram configurado (opcional)\n                    </label>\n                    <label className=\"flex items-center gap-2 text-muted-foreground\">\n                      <input type=\"checkbox\" className=\"rounded\" disabled /> Saldo suficiente en la cuenta\n                    </label>\n                    <label className=\"flex items-center gap-2 text-muted-foreground\">\n                      <input type=\"checkbox\" className=\"rounded\" disabled /> Estrategia y pares seleccionados\n                    </label>\n                    <label className=\"flex items-center gap-2 text-muted-foreground\">\n                      <input type=\"checkbox\" className=\"rounded\" disabled /> Stop Loss y Take Profit configurados\n                    </label>\n                    <label className=\"flex items-center gap-2 text-muted-foreground\">\n                      <input type=\"checkbox\" className=\"rounded\" disabled /> Nivel de riesgo adecuado a tu capital\n                    </label>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div className=\"p-4 border border-green-500/30 rounded-lg bg-green-500/5\">\n                    <h4 className=\"font-semibold mb-2 text-green-400\">‚úÖ Hacer</h4>\n                    <ul className=\"text-sm text-muted-foreground space-y-1\">\n                      <li>‚Ä¢ Empezar con posiciones peque√±as</li>\n                      <li>‚Ä¢ Revisar el dashboard y balance diariamente</li>\n                      <li>‚Ä¢ Configurar alertas de Telegram</li>\n                      <li>‚Ä¢ Usar Stop Loss siempre</li>\n                      <li>‚Ä¢ Monitorear p√©rdidas/ganancias diarias en Historial</li>\n                      <li>‚Ä¢ Verificar saldo antes de activar el bot</li>\n                    </ul>\n                  </div>\n                  <div className=\"p-4 border border-red-500/30 rounded-lg bg-red-500/5\">\n                    <h4 className=\"font-semibold mb-2 text-red-400\">‚ùå Evitar</h4>\n                    <ul className=\"text-sm text-muted-foreground space-y-1\">\n                      <li>‚Ä¢ Invertir todo tu capital</li>\n                      <li>‚Ä¢ Desactivar el Stop Loss</li>\n                      <li>‚Ä¢ Usar riesgo alto sin experiencia</li>\n                      <li>‚Ä¢ Ignorar las alertas del bot</li>\n                      <li>‚Ä¢ Ejecutar m√∫ltiples instancias</li>\n                      <li>‚Ä¢ Operar sin revisar el rendimiento semanal</li>\n                    </ul>\n                  </div>\n                </div>\n\n                <div className=\"p-4 border border-yellow-500/30 rounded-lg bg-yellow-500/5\">\n                  <h4 className=\"font-semibold mb-2 flex items-center gap-2\">\n                    <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />\n                    Advertencia importante\n                  </h4>\n                  <p className=\"text-sm text-muted-foreground\">\n                    El trading de criptomonedas conlleva riesgos significativos. Nunca inviertas dinero que no puedas permitirte perder. \n                    Este bot es una herramienta automatizada, pero no garantiza beneficios. Supervisa regularmente su funcionamiento \n                    y ajusta la configuraci√≥n seg√∫n las condiciones del mercado.\n                  </p>\n                </div>\n\n                <div className=\"p-4 border border-border rounded-lg bg-card/30\">\n                  <h4 className=\"font-semibold mb-2 flex items-center gap-2\">\n                    <HelpCircle className=\"h-4 w-4 text-primary\" />\n                    ¬øQu√© revisar en el Dashboard?\n                  </h4>\n                  <ul className=\"text-sm text-muted-foreground space-y-1\">\n                    <li>‚Ä¢ <strong>Balances:</strong> Verifica que tu saldo es correcto</li>\n                    <li>‚Ä¢ <strong>Estado del bot:</strong> Confirma que est√° activo y conectado</li>\n                    <li>‚Ä¢ <strong>√öltimas operaciones:</strong> Revisa que las operaciones se ejecutan correctamente</li>\n                    <li>‚Ä¢ <strong>Precios:</strong> Comprueba que los precios se actualizan en tiempo real</li>\n                  </ul>\n                </div>\n\n              </CardContent>\n            </Card>\n\n          </div>\n        </main>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":50842,"size_tokens":null},"server/services/botLogger.ts":{"content":"import { db } from \"../db\";\nimport { botEvents } from \"@shared/schema\";\nimport type { BotEvent, InsertBotEvent } from \"@shared/schema\";\nimport { desc } from \"drizzle-orm\";\nimport { eventsWs } from \"./eventsWebSocket\";\nimport { environment } from \"./environment\";\n\nexport type LogLevel = \"INFO\" | \"WARN\" | \"ERROR\";\n\nexport type EventType = \n  | \"TRADE_EXECUTED\"\n  | \"TRADE_BLOCKED\"\n  | \"TRADE_FAILED\"\n  | \"TRADE_ADJUSTED\"\n  | \"TRADE_REJECTED_LOW_PROFIT\"\n  | \"TRADE_SKIPPED\"\n  | \"PAIR_COOLDOWN\"\n  | \"DAILY_LIMIT_HIT\"\n  | \"DAILY_LIMIT_RESET\"\n  | \"BOT_STARTED\"\n  | \"BOT_STOPPED\"\n  | \"BOT_PAUSED\"\n  | \"BOT_RESUMED\"\n  | \"ENGINE_TICK\"\n  | \"MARKET_SCAN_SUMMARY\"\n  | \"KRAKEN_ERROR\"\n  | \"KRAKEN_CONNECTED\"\n  | \"TELEGRAM_ERROR\"\n  | \"TELEGRAM_CONNECTED\"\n  | \"SIGNAL_GENERATED\"\n  | \"POSITION_OPENED\"\n  | \"POSITION_CLOSED\"\n  | \"STOP_LOSS_HIT\"\n  | \"TAKE_PROFIT_HIT\"\n  | \"TRAILING_STOP_HIT\"\n  | \"ORPHAN_POSITION_CLEANED\"\n  | \"NONCE_ERROR\"\n  | \"BALANCE_CHECK\"\n  | \"SYSTEM_ERROR\"\n  // SMART_GUARD events\n  | \"SG_EMERGENCY_STOPLOSS\"\n  | \"SG_TP_FIXED\"\n  | \"SG_BREAKEVEN_ACTIVATED\"\n  | \"SG_TRAILING_ACTIVATED\"\n  | \"SG_TRAILING_STOP_UPDATED\"\n  | \"SG_STOP_HIT\"\n  | \"SG_SCALE_OUT\"\n  | \"SG_SCALE_OUT_EXECUTED\"\n  | \"SG_BREAK_EVEN_ACTIVATED\"\n  // Config events\n  | \"CONFIG_OVERRIDE_UPDATED\"\n  // DRY_RUN mode\n  | \"DRY_RUN_TRADE\"\n  // TEST endpoint events\n  | \"TEST_TRADE_SIMULATED\"\n  | \"TEST_POSITION_CREATED\"\n  // Manual close events\n  | \"MANUAL_CLOSE_INITIATED\"\n  | \"MANUAL_CLOSE_SUCCESS\"\n  | \"MANUAL_CLOSE_FAILED\"\n  | \"MANUAL_CLOSE_EXCEPTION\"\n  | \"MANUAL_CLOSE_DUST\"\n  | \"ORPHAN_POSITION_DELETED\";\n\ninterface LogMeta {\n  [key: string]: any;\n}\n\ninterface MemoryEvent {\n  timestamp: string;\n  level: LogLevel;\n  type: EventType;\n  message: string;\n  meta?: LogMeta;\n  env: string;\n  instanceId: string;\n}\n\nconst MAX_MEMORY_EVENTS = 100;\n\nclass BotLogger {\n  private memoryEvents: MemoryEvent[] = [];\n  private persistToDb: boolean = true;\n\n  private formatConsoleLog(level: LogLevel, type: EventType, message: string): string {\n    const timestamp = new Date().toISOString();\n    const levelColor = level === \"ERROR\" ? \"\\x1b[31m\" : level === \"WARN\" ? \"\\x1b[33m\" : \"\\x1b[36m\";\n    const reset = \"\\x1b[0m\";\n    return `${levelColor}[${timestamp}] [${level}] [${type}]${reset} ${message}`;\n  }\n\n  private async log(level: LogLevel, type: EventType, message: string, meta?: LogMeta): Promise<void> {\n    const timestamp = new Date().toISOString();\n    const env = environment.envTag;\n    const instanceId = environment.instanceId;\n    \n    console.log(this.formatConsoleLog(level, type, message));\n    if (meta) {\n      console.log(\"  Meta:\", JSON.stringify(meta, null, 2));\n    }\n\n    const enrichedMeta = { ...meta, env, instanceId };\n    const event: MemoryEvent = { timestamp, level, type, message, meta: enrichedMeta, env, instanceId };\n    this.memoryEvents.unshift(event);\n    if (this.memoryEvents.length > MAX_MEMORY_EVENTS) {\n      this.memoryEvents.pop();\n    }\n\n    let insertedId: number | undefined;\n    if (this.persistToDb) {\n      try {\n        const result = await db.insert(botEvents).values({\n          level,\n          type,\n          message,\n          meta: enrichedMeta ? JSON.stringify(enrichedMeta) : null,\n        }).returning({ id: botEvents.id });\n        insertedId = result[0]?.id;\n      } catch (error) {\n        console.error(\"[BotLogger] Error persisting event to DB:\", error);\n      }\n    }\n\n    try {\n      eventsWs.broadcast({\n        id: insertedId,\n        timestamp,\n        level,\n        type,\n        message,\n        meta: enrichedMeta,\n        env,\n        instanceId,\n      });\n    } catch (error) {\n      // Silently fail if WS not initialized yet\n    }\n  }\n\n  async info(type: EventType, message: string, meta?: LogMeta): Promise<void> {\n    await this.log(\"INFO\", type, message, meta);\n  }\n\n  async warn(type: EventType, message: string, meta?: LogMeta): Promise<void> {\n    await this.log(\"WARN\", type, message, meta);\n  }\n\n  async error(type: EventType, message: string, meta?: LogMeta): Promise<void> {\n    await this.log(\"ERROR\", type, message, meta);\n  }\n\n  getMemoryEvents(limit: number = 50): MemoryEvent[] {\n    return this.memoryEvents.slice(0, limit);\n  }\n\n  async getDbEvents(limit: number = 50): Promise<BotEvent[]> {\n    try {\n      return await db.select()\n        .from(botEvents)\n        .orderBy(desc(botEvents.timestamp))\n        .limit(limit);\n    } catch (error) {\n      console.error(\"[BotLogger] Error fetching events from DB:\", error);\n      return [];\n    }\n  }\n\n  setPersistToDb(persist: boolean): void {\n    this.persistToDb = persist;\n  }\n}\n\nexport const botLogger = new BotLogger();\n","path":null,"size_bytes":4630,"size_tokens":null},"client/src/components/dashboard/EventsPanel.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { \n  AlertTriangle, \n  XCircle, \n  Info,\n  Wifi,\n  WifiOff,\n  RefreshCw,\n  Trash2\n} from \"lucide-react\";\nimport { useEventsFeed } from \"@/context/EventsWebSocketContext\";\nimport { BotEvent } from \"@/hooks/useEventsWebSocket\";\nimport { cn } from \"@/lib/utils\";\n\nexport function EventsPanel() {\n  const { events: allEvents, status, clearEvents, connect, isConnected } = useEventsFeed();\n  const events = allEvents.slice(0, 50);\n\n  const getLevelIcon = (level: string) => {\n    switch (level) {\n      case \"ERROR\":\n        return <XCircle className=\"h-4 w-4 text-red-500\" />;\n      case \"WARN\":\n        return <AlertTriangle className=\"h-4 w-4 text-yellow-500\" />;\n      default:\n        return <Info className=\"h-4 w-4 text-cyan-500\" />;\n    }\n  };\n\n  const getLevelBadge = (level: string) => {\n    switch (level) {\n      case \"ERROR\":\n        return <Badge variant=\"destructive\" className=\"text-xs\">ERROR</Badge>;\n      case \"WARN\":\n        return <Badge className=\"bg-yellow-500/20 text-yellow-400 border-yellow-500/30 text-xs\">WARN</Badge>;\n      default:\n        return <Badge className=\"bg-cyan-500/20 text-cyan-400 border-cyan-500/30 text-xs\">INFO</Badge>;\n    }\n  };\n\n  const getTypeBadge = (type: string) => {\n    const typeColors: Record<string, string> = {\n      TRADE_EXECUTED: \"bg-green-500/20 text-green-400 border-green-500/30\",\n      TRADE_BLOCKED: \"bg-orange-500/20 text-orange-400 border-orange-500/30\",\n      TRADE_FAILED: \"bg-red-500/20 text-red-400 border-red-500/30\",\n      TRADE_SKIPPED: \"bg-gray-500/20 text-gray-400 border-gray-500/30\",\n      DAILY_LIMIT_HIT: \"bg-red-500/20 text-red-400 border-red-500/30\",\n      BOT_STARTED: \"bg-green-500/20 text-green-400 border-green-500/30\",\n      BOT_STOPPED: \"bg-gray-500/20 text-gray-400 border-gray-500/30\",\n      KRAKEN_ERROR: \"bg-red-500/20 text-red-400 border-red-500/30\",\n      SIGNAL_GENERATED: \"bg-blue-500/20 text-blue-400 border-blue-500/30\",\n      STOP_LOSS_HIT: \"bg-red-500/20 text-red-400 border-red-500/30\",\n      TAKE_PROFIT_HIT: \"bg-green-500/20 text-green-400 border-green-500/30\",\n      ENGINE_TICK: \"bg-purple-500/20 text-purple-400 border-purple-500/30\",\n      MARKET_SCAN_SUMMARY: \"bg-indigo-500/20 text-indigo-400 border-indigo-500/30\",\n    };\n    \n    const colorClass = typeColors[type] || \"bg-primary/20 text-primary border-primary/30\";\n    return <Badge className={`${colorClass} text-xs`}>{type.replace(/_/g, \" \")}</Badge>;\n  };\n\n  const formatTime = (timestamp: string) => {\n    const date = new Date(timestamp);\n    return date.toLocaleTimeString(\"es-ES\", { \n      hour: \"2-digit\", \n      minute: \"2-digit\",\n      second: \"2-digit\"\n    });\n  };\n\n  const formatDate = (timestamp: string) => {\n    const date = new Date(timestamp);\n    return date.toLocaleDateString(\"es-ES\", { \n      day: \"2-digit\",\n      month: \"2-digit\"\n    });\n  };\n\n  return (\n    <Card className=\"h-full\" data-testid=\"events-panel\">\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg flex items-center gap-2\">\n            Eventos del Bot\n            <Badge \n              variant=\"outline\" \n              className={cn(\n                \"gap-1 text-xs\",\n                isConnected ? \"border-green-500 text-green-400\" : \n                status === \"reconnecting\" ? \"border-yellow-500 text-yellow-400\" :\n                \"border-red-500 text-red-400\"\n              )}\n              data-testid=\"events-ws-status\"\n            >\n              {isConnected ? <Wifi className=\"h-3 w-3\" /> : \n               status === \"reconnecting\" ? <RefreshCw className=\"h-3 w-3 animate-spin\" /> :\n               <WifiOff className=\"h-3 w-3\" />}\n              {isConnected ? \"Live\" : status === \"reconnecting\" ? \"...\" : \"Off\"}\n            </Badge>\n          </CardTitle>\n          <div className=\"flex items-center gap-1\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-7 w-7\"\n              onClick={clearEvents}\n              title=\"Limpiar eventos\"\n              data-testid=\"button-clear-events\"\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n            {!isConnected && (\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-7 w-7\"\n                onClick={connect}\n                title=\"Reconectar\"\n                data-testid=\"button-reconnect-events\"\n              >\n                <RefreshCw className=\"h-4 w-4\" />\n              </Button>\n            )}\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent className=\"pt-0\">\n        <ScrollArea className=\"h-[300px]\">\n          <div className=\"space-y-2\">\n            {events.length === 0 ? (\n              <div className=\"text-center text-muted-foreground py-8 text-sm\">\n                {isConnected ? \"Esperando eventos...\" : \"Conectando...\"}\n              </div>\n            ) : (\n              events.slice(0, 20).map((event, idx) => (\n                <div\n                  key={event.id || `${event.timestamp}-${idx}`}\n                  className=\"flex items-start gap-2 p-2 rounded-lg bg-muted/30 hover:bg-muted/50 transition-colors\"\n                  data-testid={`event-item-${event.id || idx}`}\n                >\n                  {getLevelIcon(event.level)}\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      {getTypeBadge(event.type)}\n                      {event.meta?.pair && (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {event.meta.pair}\n                        </Badge>\n                      )}\n                      <span className=\"text-xs text-muted-foreground ml-auto whitespace-nowrap\">\n                        {formatDate(event.timestamp)} {formatTime(event.timestamp)}\n                      </span>\n                    </div>\n                    <p className=\"text-sm text-foreground/80 mt-1 line-clamp-2\">\n                      {event.message}\n                    </p>\n                  </div>\n                </div>\n              ))\n            )}\n          </div>\n        </ScrollArea>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":6495,"size_tokens":null},"server/services/mlTrainer.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nAI Filter Model Trainer for KrakenBot\nUses RandomForest with walk-forward validation\n\"\"\"\n\nimport sys\nimport json\nimport os\nimport pickle\n\nMODEL_DIR = \"/tmp/models\"\nMODEL_PATH = f\"{MODEL_DIR}/ai_filter.joblib\"\nSTATUS_PATH = f\"{MODEL_DIR}/ai_status.json\"\n\ndef ensure_model_dir():\n    if not os.path.exists(MODEL_DIR):\n        os.makedirs(MODEL_DIR, exist_ok=True)\n\ndef extract_features_from_sample(sample):\n    \"\"\"Extract feature vector from a sample's featuresJson\"\"\"\n    features = sample.get(\"featuresJson\", {})\n    if isinstance(features, str):\n        features = json.loads(features)\n    \n    return [\n        float(features.get(\"rsi14\", 50)),\n        float(features.get(\"macdLine\", 0)),\n        float(features.get(\"macdSignal\", 0)),\n        float(features.get(\"macdHist\", 0)),\n        float(features.get(\"bbUpper\", 0)),\n        float(features.get(\"bbMiddle\", 0)),\n        float(features.get(\"bbLower\", 0)),\n        float(features.get(\"atr14\", 0)),\n        float(features.get(\"ema12\", 0)),\n        float(features.get(\"ema26\", 0)),\n        float(features.get(\"volume24hChange\", 0)),\n        float(features.get(\"priceChange1h\", 0)),\n        float(features.get(\"priceChange4h\", 0)),\n        float(features.get(\"priceChange24h\", 0)),\n        float(features.get(\"spreadPct\", 0)),\n        float(features.get(\"confidence\", 50)),\n    ]\n\ndef train(samples_path):\n    \"\"\"Train RandomForest model on samples\"\"\"\n    try:\n        from sklearn.ensemble import RandomForestClassifier\n        from sklearn.model_selection import TimeSeriesSplit\n        from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score\n        import numpy as np\n    except ImportError:\n        print(json.dumps({\"success\": False, \"error\": \"sklearn not installed\"}))\n        sys.exit(1)\n    \n    ensure_model_dir()\n    \n    with open(samples_path, 'r') as f:\n        samples = json.load(f)\n    \n    complete_samples = [s for s in samples if s.get(\"isComplete\") and s.get(\"labelWin\") is not None]\n    \n    if len(complete_samples) < 50:\n        print(json.dumps({\"success\": False, \"error\": f\"Not enough samples: {len(complete_samples)}\"}))\n        sys.exit(1)\n    \n    X = []\n    y = []\n    \n    for sample in complete_samples:\n        try:\n            features = extract_features_from_sample(sample)\n            label = int(sample[\"labelWin\"])\n            X.append(features)\n            y.append(label)\n        except Exception as e:\n            continue\n    \n    X = np.array(X)\n    y = np.array(y)\n    \n    tscv = TimeSeriesSplit(n_splits=min(5, len(X) // 20))\n    \n    accuracies = []\n    precisions = []\n    recalls = []\n    f1s = []\n    \n    for train_idx, test_idx in tscv.split(X):\n        X_train, X_test = X[train_idx], X[test_idx]\n        y_train, y_test = y[train_idx], y[test_idx]\n        \n        model = RandomForestClassifier(\n            n_estimators=100,\n            max_depth=10,\n            min_samples_split=5,\n            min_samples_leaf=2,\n            random_state=42,\n            class_weight='balanced'\n        )\n        \n        model.fit(X_train, y_train)\n        y_pred = model.predict(X_test)\n        \n        accuracies.append(accuracy_score(y_test, y_pred))\n        precisions.append(precision_score(y_test, y_pred, zero_division=0))\n        recalls.append(recall_score(y_test, y_pred, zero_division=0))\n        f1s.append(f1_score(y_test, y_pred, zero_division=0))\n    \n    final_model = RandomForestClassifier(\n        n_estimators=100,\n        max_depth=10,\n        min_samples_split=5,\n        min_samples_leaf=2,\n        random_state=42,\n        class_weight='balanced'\n    )\n    final_model.fit(X, y)\n    \n    with open(MODEL_PATH, 'wb') as f:\n        pickle.dump(final_model, f)\n    \n    metrics = {\n        \"accuracy\": float(np.mean(accuracies)),\n        \"precision\": float(np.mean(precisions)),\n        \"recall\": float(np.mean(recalls)),\n        \"f1\": float(np.mean(f1s)),\n        \"nSamples\": len(complete_samples),\n        \"trainedAt\": str(os.popen('date -u +\"%Y-%m-%dT%H:%M:%SZ\"').read().strip())\n    }\n    \n    with open(STATUS_PATH, 'w') as f:\n        json.dump(metrics, f, indent=2)\n    \n    print(json.dumps({\"success\": True, \"metrics\": metrics}))\n\ndef predict(features_json):\n    \"\"\"Predict approval probability for given features\"\"\"\n    ensure_model_dir()\n    \n    if not os.path.exists(MODEL_PATH):\n        print(json.dumps({\"score\": 0.5, \"error\": \"Model not found\"}))\n        return\n    \n    try:\n        with open(MODEL_PATH, 'rb') as f:\n            model = pickle.load(f)\n        \n        features = json.loads(features_json)\n        \n        X = [[\n            float(features.get(\"rsi14\", 50)),\n            float(features.get(\"macdLine\", 0)),\n            float(features.get(\"macdSignal\", 0)),\n            float(features.get(\"macdHist\", 0)),\n            float(features.get(\"bbUpper\", 0)),\n            float(features.get(\"bbMiddle\", 0)),\n            float(features.get(\"bbLower\", 0)),\n            float(features.get(\"atr14\", 0)),\n            float(features.get(\"ema12\", 0)),\n            float(features.get(\"ema26\", 0)),\n            float(features.get(\"volume24hChange\", 0)),\n            float(features.get(\"priceChange1h\", 0)),\n            float(features.get(\"priceChange4h\", 0)),\n            float(features.get(\"priceChange24h\", 0)),\n            float(features.get(\"spreadPct\", 0)),\n            float(features.get(\"confidence\", 50)),\n        ]]\n        \n        proba = model.predict_proba(X)[0]\n        score = float(proba[1]) if len(proba) > 1 else 0.5\n        \n        print(json.dumps({\"score\": score}))\n        \n    except Exception as e:\n        print(json.dumps({\"score\": 0.5, \"error\": str(e)}))\n\nif __name__ == \"__main__\":\n    if len(sys.argv) < 2:\n        print(json.dumps({\"error\": \"Usage: mlTrainer.py <train|predict> <arg>\"}))\n        sys.exit(1)\n    \n    command = sys.argv[1]\n    \n    if command == \"train\" and len(sys.argv) >= 3:\n        train(sys.argv[2])\n    elif command == \"predict\" and len(sys.argv) >= 3:\n        predict(sys.argv[2])\n    else:\n        print(json.dumps({\"error\": f\"Unknown command: {command}\"}))\n        sys.exit(1)\n","path":null,"size_bytes":6120,"size_tokens":null},"server/services/aiService.ts":{"content":"import { storage } from \"../storage\";\nimport { spawn } from \"child_process\";\nimport * as fs from \"fs\";\nimport * as path from \"path\";\n\nexport interface AiFeatures {\n  rsi14: number;\n  macdLine: number;\n  macdSignal: number;\n  macdHist: number;\n  bbUpper: number;\n  bbMiddle: number;\n  bbLower: number;\n  atr14: number;\n  ema12: number;\n  ema26: number;\n  volume24hChange: number;\n  priceChange1h: number;\n  priceChange4h: number;\n  priceChange24h: number;\n  spreadPct: number;\n  confidence: number;\n}\n\nexport interface AiPrediction {\n  approve: boolean;\n  score: number;\n  threshold: number;\n}\n\nexport interface AiStatus {\n  phase: \"red\" | \"yellow\" | \"green\";\n  phaseLabel: string;\n  completeSamples: number;\n  minSamplesForTrain: number;\n  minSamplesForActivate: number;\n  canTrain: boolean;\n  canActivate: boolean;\n  filterEnabled: boolean;\n  shadowEnabled: boolean;\n  modelLoaded: boolean;\n  lastTrainTs: Date | null;\n  threshold: number;\n  metrics: {\n    accuracy?: number;\n    precision?: number;\n    recall?: number;\n    f1?: number;\n    tradesBlocked?: number;\n    lossesAvoided?: number;\n  } | null;\n}\n\nexport interface AiDiagnostic {\n  operationsCount: number;\n  trainingTradesTotal: number;\n  closedTradesCount: number;\n  labeledTradesCount: number;\n  openTradesCount: number;\n  openLotsCount: number;\n  openTradesDescription: string;\n  openLotsDescription: string;\n  lastBackfillRun: Date | null;\n  lastBackfillError: string | null;\n  lastTrainRun: Date | null;\n  lastTrainError: string | null;\n  modelVersion: string | null;\n  discardReasonsDataset: Record<string, number>;\n  lastBackfillDiscardReasons: Record<string, number>;\n  winRate: number | null;\n  avgPnlNet: number | null;\n  avgHoldTimeMinutes: number | null;\n}\n\nconst MODEL_DIR = \"/tmp/models\";\nconst MODEL_PATH = `${MODEL_DIR}/ai_filter.joblib`;\nconst STATUS_PATH = `${MODEL_DIR}/ai_status.json`;\n\nconst MIN_SAMPLES_TRAIN = 300;\nconst MIN_SAMPLES_ACTIVATE = 300;\n\nconst LEGACY_KEY_MAP: Record<string, string> = {\n  'no_matching_sell': 'venta_sin_compra_previa',\n  'invalid_data': 'datos_invalidos',\n  'outlier_pnl': 'pnl_atipico',\n  'excessive_hold': 'hold_excesivo',\n  'abnormal_fees': 'comisiones_anormales',\n  'invalid_timestamps': 'timestamps_invalidos',\n  'sell_exceeds_lots': 'venta_excede_lotes',\n  'no_execution_date': 'sin_fecha_ejecucion',\n};\n\nfunction translateDiscardReasons(reasons: Record<string, number>): Record<string, number> {\n  const translated: Record<string, number> = {};\n  for (const [key, count] of Object.entries(reasons)) {\n    const translatedKey = LEGACY_KEY_MAP[key] || key;\n    translated[translatedKey] = (translated[translatedKey] || 0) + count;\n  }\n  return translated;\n}\n\nclass AiService {\n  private modelLoaded: boolean = false;\n  private cachedMetrics: any = null;\n\n  extractFeatures(indicators: {\n    rsi?: number;\n    macd?: { line: number; signal: number; histogram: number };\n    bollinger?: { upper: number; middle: number; lower: number };\n    atr?: number;\n    ema12?: number;\n    ema26?: number;\n    volume24hChange?: number;\n    priceChange1h?: number;\n    priceChange4h?: number;\n    priceChange24h?: number;\n    spreadPct?: number;\n    confidence?: number;\n  }): AiFeatures {\n    return {\n      rsi14: indicators.rsi ?? 50,\n      macdLine: indicators.macd?.line ?? 0,\n      macdSignal: indicators.macd?.signal ?? 0,\n      macdHist: indicators.macd?.histogram ?? 0,\n      bbUpper: indicators.bollinger?.upper ?? 0,\n      bbMiddle: indicators.bollinger?.middle ?? 0,\n      bbLower: indicators.bollinger?.lower ?? 0,\n      atr14: indicators.atr ?? 0,\n      ema12: indicators.ema12 ?? 0,\n      ema26: indicators.ema26 ?? 0,\n      volume24hChange: indicators.volume24hChange ?? 0,\n      priceChange1h: indicators.priceChange1h ?? 0,\n      priceChange4h: indicators.priceChange4h ?? 0,\n      priceChange24h: indicators.priceChange24h ?? 0,\n      spreadPct: indicators.spreadPct ?? 0,\n      confidence: indicators.confidence ?? 50,\n    };\n  }\n\n  async getStatus(): Promise<AiStatus> {\n    const aiConfig = await storage.getAiConfig();\n    const labeledCount = await storage.getTrainingTradesCount({ labeled: true });\n    \n    let phase: \"red\" | \"yellow\" | \"green\" = \"red\";\n    let phaseLabel = \"Recolectando datos\";\n    \n    if (labeledCount >= MIN_SAMPLES_ACTIVATE && aiConfig?.filterEnabled) {\n      phase = \"green\";\n      phaseLabel = \"Filtro activo\";\n    } else if (labeledCount >= MIN_SAMPLES_TRAIN) {\n      phase = \"yellow\";\n      phaseLabel = \"Listo para entrenar\";\n    }\n\n    const modelExists = fs.existsSync(MODEL_PATH);\n    \n    let metrics = null;\n    if (fs.existsSync(STATUS_PATH)) {\n      try {\n        const statusData = fs.readFileSync(STATUS_PATH, \"utf-8\");\n        metrics = JSON.parse(statusData);\n        this.cachedMetrics = metrics;\n      } catch (e) {\n        metrics = this.cachedMetrics;\n      }\n    }\n\n    return {\n      phase,\n      phaseLabel,\n      completeSamples: labeledCount,\n      minSamplesForTrain: MIN_SAMPLES_TRAIN,\n      minSamplesForActivate: MIN_SAMPLES_ACTIVATE,\n      canTrain: labeledCount >= MIN_SAMPLES_TRAIN,\n      canActivate: labeledCount >= MIN_SAMPLES_ACTIVATE && modelExists,\n      filterEnabled: aiConfig?.filterEnabled ?? false,\n      shadowEnabled: aiConfig?.shadowEnabled ?? false,\n      modelLoaded: modelExists && this.modelLoaded,\n      lastTrainTs: aiConfig?.lastTrainTs ?? null,\n      threshold: parseFloat(aiConfig?.threshold ?? \"0.60\"),\n      metrics,\n    };\n  }\n\n  async getDiagnostic(): Promise<AiDiagnostic> {\n    const aiConfig = await storage.getAiConfig();\n    const allTrades = await storage.getAllTradesForBackfill();\n    const trainingTradesTotal = await storage.getTrainingTradesCount();\n    const closedCount = await storage.getTrainingTradesCount({ closed: true });\n    const labeledCount = await storage.getTrainingTradesCount({ labeled: true });\n    const openCount = await storage.getTrainingTradesCount({ closed: false });\n    const openLotsCount = await storage.getTrainingTradesCount({ hasOpenLots: true });\n    \n    const labeledTrades = await storage.getTrainingTrades({ labeled: true });\n    \n    const rawDiscardReasonsDataset = await storage.getDiscardReasonsDataset();\n    const discardReasonsDataset = translateDiscardReasons(rawDiscardReasonsDataset);\n    \n    const rawLastBackfillDiscardReasons: Record<string, number> = \n      (aiConfig?.lastBackfillDiscardReasonsJson as Record<string, number>) || {};\n    const lastBackfillDiscardReasons = translateDiscardReasons(rawLastBackfillDiscardReasons);\n    \n    let winRate: number | null = null;\n    let avgPnlNet: number | null = null;\n    let avgHoldTimeMinutes: number | null = null;\n    \n    if (labeledTrades.length > 0) {\n      const wins = labeledTrades.filter(t => t.labelWin === 1).length;\n      winRate = (wins / labeledTrades.length) * 100;\n      \n      const pnlSum = labeledTrades.reduce((sum, t) => sum + parseFloat(t.pnlNet || '0'), 0);\n      avgPnlNet = pnlSum / labeledTrades.length;\n      \n      const holdSum = labeledTrades.reduce((sum, t) => sum + (t.holdTimeMinutes || 0), 0);\n      avgHoldTimeMinutes = holdSum / labeledTrades.length;\n    }\n    \n    return {\n      operationsCount: allTrades.length,\n      trainingTradesTotal,\n      closedTradesCount: closedCount,\n      labeledTradesCount: labeledCount,\n      openTradesCount: openCount,\n      openLotsCount,\n      openTradesDescription: \"training_trades con isClosed=false\",\n      openLotsDescription: \"training_trades con qtyRemaining > 0\",\n      lastBackfillRun: aiConfig?.lastBackfillTs ?? null,\n      lastBackfillError: aiConfig?.lastBackfillError ?? null,\n      lastTrainRun: aiConfig?.lastTrainTs ?? null,\n      lastTrainError: aiConfig?.lastTrainError ?? null,\n      modelVersion: aiConfig?.modelVersion ?? null,\n      discardReasonsDataset,\n      lastBackfillDiscardReasons,\n      winRate,\n      avgPnlNet,\n      avgHoldTimeMinutes,\n    };\n  }\n\n  async predict(features: AiFeatures): Promise<AiPrediction> {\n    const aiConfig = await storage.getAiConfig();\n    const threshold = parseFloat(aiConfig?.threshold ?? \"0.60\");\n    \n    if (!fs.existsSync(MODEL_PATH)) {\n      return { approve: true, score: 0.5, threshold };\n    }\n\n    try {\n      const featuresJson = JSON.stringify(features);\n      const result = await this.runPythonPredict(featuresJson);\n      const score = parseFloat(result.score);\n      \n      return {\n        approve: score >= threshold,\n        score,\n        threshold,\n      };\n    } catch (error) {\n      console.error(\"[AI] Prediction error:\", error);\n      return { approve: true, score: 0.5, threshold };\n    }\n  }\n\n  private runPythonPredict(featuresJson: string): Promise<{ score: string }> {\n    return new Promise((resolve, reject) => {\n      const pythonScript = path.join(process.cwd(), \"server/services/mlTrainer.py\");\n      \n      if (!fs.existsSync(pythonScript)) {\n        resolve({ score: \"0.5\" });\n        return;\n      }\n\n      const proc = spawn(\"python3\", [pythonScript, \"predict\", featuresJson], {\n        cwd: process.cwd(),\n      });\n\n      let stdout = \"\";\n      let stderr = \"\";\n\n      proc.stdout.on(\"data\", (data) => (stdout += data.toString()));\n      proc.stderr.on(\"data\", (data) => (stderr += data.toString()));\n\n      proc.on(\"close\", (code) => {\n        if (code !== 0) {\n          console.error(\"[AI] Python predict error:\", stderr);\n          resolve({ score: \"0.5\" });\n          return;\n        }\n        try {\n          const result = JSON.parse(stdout.trim());\n          resolve({ score: result.score?.toString() ?? \"0.5\" });\n        } catch (e) {\n          resolve({ score: \"0.5\" });\n        }\n      });\n\n      proc.on(\"error\", (err) => {\n        console.error(\"[AI] Python spawn error:\", err);\n        resolve({ score: \"0.5\" });\n      });\n    });\n  }\n\n  async runTraining(): Promise<{ \n    success: boolean; \n    message: string; \n    errorCode?: string;\n    required?: number;\n    current?: number;\n    metrics?: { accuracy: number; precision: number; recall: number; f1: number; trainSize: number; valSize: number } \n  }> {\n    const labeledTrades = await storage.getTrainingTrades({ labeled: true });\n    \n    if (labeledTrades.length < MIN_SAMPLES_TRAIN) {\n      return { \n        success: false, \n        errorCode: \"INSUFFICIENT_DATA\",\n        message: `Datos insuficientes para entrenar el modelo. Necesitas ${MIN_SAMPLES_TRAIN} trades cerrados etiquetados. Actualmente hay ${labeledTrades.length}.`,\n        required: MIN_SAMPLES_TRAIN,\n        current: labeledTrades.length\n      };\n    }\n\n    if (!fs.existsSync(MODEL_DIR)) {\n      fs.mkdirSync(MODEL_DIR, { recursive: true });\n    }\n\n    const sortedTrades = [...labeledTrades].sort((a, b) => {\n      const timeA = a.entryTs ? new Date(a.entryTs).getTime() : 0;\n      const timeB = b.entryTs ? new Date(b.entryTs).getTime() : 0;\n      return timeA - timeB;\n    });\n\n    const validTrades = sortedTrades.filter(trade => {\n      const entryTime = trade.entryTs ? new Date(trade.entryTs).getTime() : 0;\n      const exitTime = trade.exitTs ? new Date(trade.exitTs).getTime() : 0;\n      const entryPrice = parseFloat(trade.entryPrice || '0');\n      const exitPrice = parseFloat(trade.exitPrice || '0');\n      const amount = parseFloat(trade.entryAmount || '0');\n      \n      if (exitTime <= entryTime) return false;\n      if (entryPrice <= 0 || exitPrice <= 0) return false;\n      if (amount <= 0) return false;\n      if (trade.holdTimeMinutes !== null && trade.holdTimeMinutes < 0) return false;\n      \n      return true;\n    });\n\n    if (validTrades.length < MIN_SAMPLES_TRAIN) {\n      return { \n        success: false, \n        errorCode: \"INSUFFICIENT_DATA\",\n        message: `Datos insuficientes para entrenar el modelo. Solo hay ${validTrades.length} trades v√°lidos despu√©s de validaci√≥n. Necesitas ${MIN_SAMPLES_TRAIN}.`,\n        required: MIN_SAMPLES_TRAIN,\n        current: validTrades.length\n      };\n    }\n\n    const splitIdx = Math.floor(validTrades.length * 0.8);\n    const trainTrades = validTrades.slice(0, splitIdx);\n    const valTrades = validTrades.slice(splitIdx);\n\n    const trainingData = {\n      train: trainTrades.map(trade => ({\n        tradeId: trade.buyTxid,\n        pair: trade.pair,\n        entryPrice: trade.entryPrice,\n        exitPrice: trade.exitPrice,\n        pnlNet: trade.pnlNet,\n        pnlPct: trade.pnlPct,\n        holdTimeMinutes: trade.holdTimeMinutes,\n        labelWin: trade.labelWin,\n        featuresJson: trade.featuresJson || {},\n        entryTs: trade.entryTs,\n      })),\n      val: valTrades.map(trade => ({\n        tradeId: trade.buyTxid,\n        pair: trade.pair,\n        entryPrice: trade.entryPrice,\n        exitPrice: trade.exitPrice,\n        pnlNet: trade.pnlNet,\n        pnlPct: trade.pnlPct,\n        holdTimeMinutes: trade.holdTimeMinutes,\n        labelWin: trade.labelWin,\n        featuresJson: trade.featuresJson || {},\n        entryTs: trade.entryTs,\n      })),\n    };\n\n    const samplesPath = `${MODEL_DIR}/training_samples.json`;\n    fs.writeFileSync(samplesPath, JSON.stringify(trainingData, null, 2));\n\n    const modelVersion = `v${Date.now()}`;\n\n    return new Promise((resolve) => {\n      const pythonScript = path.join(process.cwd(), \"server/services/mlTrainer.py\");\n      \n      if (!fs.existsSync(pythonScript)) {\n        storage.updateAiConfig({ lastTrainError: \"Script de entrenamiento no encontrado\" });\n        resolve({ success: false, message: \"Script de entrenamiento no encontrado\" });\n        return;\n      }\n\n      const proc = spawn(\"python3\", [pythonScript, \"train\", samplesPath], {\n        cwd: process.cwd(),\n      });\n\n      let stdout = \"\";\n      let stderr = \"\";\n\n      proc.stdout.on(\"data\", (data) => (stdout += data.toString()));\n      proc.stderr.on(\"data\", (data) => (stderr += data.toString()));\n\n      proc.on(\"close\", async (code) => {\n        if (code !== 0) {\n          console.error(\"[AI] Training failed:\", stderr);\n          const errorMsg = stderr.slice(0, 500) || 'Unknown training error';\n          await storage.updateAiConfig({ lastTrainError: errorMsg });\n          resolve({ success: false, message: `Error en entrenamiento: ${errorMsg.slice(0, 200)}` });\n          return;\n        }\n\n        try {\n          const result = JSON.parse(stdout.trim());\n          const metrics = {\n            accuracy: result.metrics?.accuracy ?? 0,\n            precision: result.metrics?.precision ?? 0,\n            recall: result.metrics?.recall ?? 0,\n            f1: result.metrics?.f1 ?? 0,\n            trainSize: trainTrades.length,\n            valSize: valTrades.length,\n          };\n          \n          await storage.updateAiConfig({\n            lastTrainTs: new Date(),\n            lastTrainError: null,\n            nSamples: validTrades.length,\n            modelPath: MODEL_PATH,\n            modelVersion,\n            metricsJson: metrics,\n          });\n\n          this.modelLoaded = true;\n          \n          resolve({\n            success: true,\n            message: `Modelo ${modelVersion} entrenado: ${trainTrades.length} train / ${valTrades.length} val. Accuracy: ${(metrics.accuracy * 100).toFixed(1)}%`,\n            metrics,\n          });\n        } catch (e: any) {\n          await storage.updateAiConfig({\n            lastTrainTs: new Date(),\n            lastTrainError: null,\n            modelVersion,\n          });\n          resolve({ success: true, message: `Modelo ${modelVersion} entrenado (sin m√©tricas parseables)` });\n        }\n      });\n\n      proc.on(\"error\", async (err) => {\n        console.error(\"[AI] Training spawn error:\", err);\n        await storage.updateAiConfig({ lastTrainError: err.message });\n        resolve({ success: false, message: `Error: ${err.message}` });\n      });\n    });\n  }\n\n  async runBackfill(): Promise<{ success: boolean; message: string; stats: { created: number; closed: number; labeled: number; discardReasons: Record<string, number> } }> {\n    try {\n      const stats = await storage.runTrainingTradesBackfill();\n      \n      await storage.updateAiConfig({\n        lastBackfillTs: new Date(),\n        lastBackfillError: null,\n        lastBackfillDiscardReasonsJson: stats.discardReasons,\n      });\n      \n      return {\n        success: true,\n        message: `Backfill completado: ${stats.created} trades creados, ${stats.closed} cerrados, ${stats.labeled} etiquetados`,\n        stats,\n      };\n    } catch (error: any) {\n      const errorMsg = error.message || 'Unknown error';\n      await storage.updateAiConfig({\n        lastBackfillTs: new Date(),\n        lastBackfillError: errorMsg,\n      });\n      \n      return {\n        success: false,\n        message: `Error en backfill: ${errorMsg}`,\n        stats: { created: 0, closed: 0, labeled: 0, discardReasons: {} },\n      };\n    }\n  }\n\n  async toggleFilter(enabled: boolean): Promise<void> {\n    await storage.updateAiConfig({ filterEnabled: enabled });\n  }\n\n  async toggleShadow(enabled: boolean): Promise<void> {\n    await storage.updateAiConfig({ shadowEnabled: enabled });\n  }\n\n  async setThreshold(threshold: number): Promise<void> {\n    await storage.updateAiConfig({ threshold: threshold.toFixed(4) });\n  }\n}\n\nexport const aiService = new AiService();\n","path":null,"size_bytes":17120,"size_tokens":null},"client/src/pages/Terminal.tsx":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useState, useMemo } from \"react\";\nimport { Nav } from \"@/components/dashboard/Nav\";\nimport generatedImage from '@assets/generated_images/dark_digital_hex_grid_background.png';\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { \n  ArrowUpRight, \n  ArrowDownRight, \n  Clock, \n  DollarSign, \n  TrendingUp, \n  TrendingDown, \n  RefreshCw, \n  ChevronLeft, \n  ChevronRight, \n  Download, \n  Activity, \n  CandlestickChart,\n  CircleDot,\n  Zap,\n  Target,\n  BarChart3,\n  Layers,\n  Square,\n  X,\n  Loader2,\n  Trash2,\n  AlertTriangle\n} from \"lucide-react\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface OpenPosition {\n  id: number;\n  pair: string;\n  entryPrice: string;\n  amount: string;\n  highestPrice: string;\n  openedAt: string;\n  currentPrice: string;\n  unrealizedPnlUsd: string;\n  unrealizedPnlPct: string;\n  entryValueUsd: string;\n  currentValueUsd: string;\n  entryStrategyId: string;\n  entrySignalTf: string;\n  signalConfidence: string | null;\n  lotId?: string | null;\n  entryMode?: string | null;\n}\n\ninterface ClosedTrade {\n  id: number;\n  tradeId: string;\n  pair: string;\n  type: string;\n  price: string;\n  amount: string;\n  status: string;\n  entryPrice: string | null;\n  totalUsd: string;\n  entryValueUsd: string | null;\n  realizedPnlUsd: string | null;\n  realizedPnlPct: string | null;\n  executedAt: string | null;\n  createdAt: string;\n}\n\ninterface ClosedTradesResponse {\n  trades: ClosedTrade[];\n  total: number;\n  limit: number;\n  offset: number;\n}\n\nexport default function Terminal() {\n  const [limit, setLimit] = useState(10);\n  const [offset, setOffset] = useState(0);\n  const [pairFilter, setPairFilter] = useState<string>(\"all\");\n  const [resultFilter, setResultFilter] = useState<string>(\"all\");\n  const [typeFilter, setTypeFilter] = useState<string>(\"all\");\n  const [syncing, setSyncing] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"positions\");\n  const [closingKey, setClosingKey] = useState<string | null>(null);\n  const [deletingOrphanKey, setDeletingOrphanKey] = useState<string | null>(null);\n  const [orphanDialogOpen, setOrphanDialogOpen] = useState(false);\n  const [orphanToDelete, setOrphanToDelete] = useState<{ lotId: string; pair: string; amount: string } | null>(null);\n  const [dustPositions, setDustPositions] = useState<Set<string>>(new Set());\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const getPositionKey = (pair: string, lotId?: string | null) => lotId || pair;\n\n  const { data: botConfig } = useQuery<{ positionMode?: string; sgMaxOpenLotsPerPair?: number }>({\n    queryKey: [\"botConfig\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/config\");\n      if (!res.ok) throw new Error(\"Failed to fetch config\");\n      return res.json();\n    },\n    refetchInterval: 60000,\n  });\n\n  const { data: openPositions, isLoading: loadingPositions, refetch: refetchPositions, isFetching: fetchingPositions } = useQuery<OpenPosition[]>({\n    queryKey: [\"openPositions\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/open-positions\");\n      if (!res.ok) throw new Error(\"Failed to fetch open positions\");\n      return res.json();\n    },\n    refetchInterval: 30000,\n  });\n\n  const lotsCountByPair = useMemo(() => {\n    if (!openPositions) return new Map<string, { count: number; max: number }>();\n    const maxLots = botConfig?.sgMaxOpenLotsPerPair || 1;\n    const counts = new Map<string, { count: number; max: number }>();\n    for (const pos of openPositions) {\n      const current = counts.get(pos.pair);\n      counts.set(pos.pair, { count: (current?.count || 0) + 1, max: maxLots });\n    }\n    return counts;\n  }, [openPositions, botConfig?.sgMaxOpenLotsPerPair]);\n\n  const getLotsCountByPair = (pair: string) => {\n    return lotsCountByPair.get(pair) || { count: 0, max: botConfig?.sgMaxOpenLotsPerPair || 1 };\n  };\n\n  const { data: closedData, isLoading: loadingClosed, refetch: refetchClosed, isFetching: fetchingClosed } = useQuery<ClosedTradesResponse>({\n    queryKey: [\"closedTrades\", limit, offset, pairFilter, resultFilter, typeFilter],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        limit: limit.toString(),\n        offset: offset.toString(),\n        result: resultFilter,\n        type: typeFilter,\n      });\n      if (pairFilter !== \"all\") {\n        params.set(\"pair\", pairFilter);\n      }\n      const res = await fetch(`/api/trades/closed?${params}`);\n      if (!res.ok) throw new Error(\"Failed to fetch closed trades\");\n      return res.json();\n    },\n  });\n\n  const handleSyncFromKraken = async () => {\n    setSyncing(true);\n    try {\n      const res = await fetch(\"/api/trades/sync\", { method: \"POST\" });\n      const data = await res.json();\n      if (res.ok) {\n        toast({\n          title: \"Sincronizado\",\n          description: `Se importaron ${data.synced} operaciones de Kraken (${data.total} en historial)`,\n        });\n        refetchClosed();\n      } else {\n        toast({\n          title: \"Error\",\n          description: data.error || \"No se pudo sincronizar\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (e) {\n      toast({\n        title: \"Error\",\n        description: \"Error de conexi√≥n\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSyncing(false);\n    }\n  };\n\n  const closePositionMutation = useMutation({\n    mutationFn: async ({ pair, lotId, amount }: { pair: string; lotId?: string | null; amount?: string }) => {\n      const pairEncoded = pair.replace(\"/\", \"-\");\n      const body: { reason: string; lotId?: string } = { reason: \"Cierre manual desde dashboard\" };\n      if (lotId) body.lotId = lotId;\n      const res = await fetch(`/api/positions/${pairEncoded}/close`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      });\n      const data = await res.json();\n      // Check for DUST response (comes as 200 with isDust flag)\n      if (data.isDust && lotId) {\n        return { ...data, _isDust: true, _lotId: lotId, _pair: pair, _amount: amount };\n      }\n      if (!res.ok) {\n        throw new Error(data.message || \"Error al cerrar posici√≥n\");\n      }\n      return data;\n    },\n    onMutate: ({ pair, lotId }) => {\n      setClosingKey(getPositionKey(pair, lotId));\n    },\n    onSuccess: (data) => {\n      // Handle DUST position - show dialog to delete orphan\n      if (data._isDust && data._lotId) {\n        setDustPositions(prev => new Set(prev).add(data._lotId));\n        setOrphanToDelete({ lotId: data._lotId, pair: data._pair, amount: data._amount || \"?\" });\n        setOrphanDialogOpen(true);\n        toast({\n          title: \"Posici√≥n DUST\",\n          description: data.message || \"Balance real menor al m√≠nimo de Kraken\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      toast({\n        title: data.message?.includes(\"DRY_RUN\") ? \"Cierre Simulado\" : \"Posici√≥n Cerrada\",\n        description: `${data.pair}: PnL ${parseFloat(data.realizedPnlUsd) >= 0 ? '+' : ''}$${data.realizedPnlUsd} (${parseFloat(data.realizedPnlPct) >= 0 ? '+' : ''}${data.realizedPnlPct}%)`,\n      });\n      queryClient.invalidateQueries({ queryKey: [\"openPositions\"] });\n      queryClient.invalidateQueries({ queryKey: [\"closedTrades\"] });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n    onSettled: () => {\n      setClosingKey(null);\n    },\n  });\n\n  // Mutation for deleting orphan DUST positions\n  const deleteOrphanMutation = useMutation({\n    mutationFn: async ({ lotId }: { lotId: string }) => {\n      const res = await fetch(`/api/positions/${lotId}/orphan`, {\n        method: \"DELETE\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ reason: \"orphan_dust_cleanup\" }),\n      });\n      if (!res.ok) {\n        const data = await res.json();\n        throw new Error(data.message || \"Error al eliminar posici√≥n hu√©rfana\");\n      }\n      return res.json();\n    },\n    onMutate: ({ lotId }) => {\n      setDeletingOrphanKey(lotId);\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Posici√≥n Hu√©rfana Eliminada\",\n        description: `${data.pair}: Registro interno eliminado (sin orden a Kraken)`,\n      });\n      setDustPositions(prev => {\n        const next = new Set(prev);\n        next.delete(data.lotId);\n        return next;\n      });\n      queryClient.invalidateQueries({ queryKey: [\"openPositions\"] });\n      queryClient.invalidateQueries({ queryKey: [\"closedTrades\"] });\n      setOrphanDialogOpen(false);\n      setOrphanToDelete(null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n    onSettled: () => {\n      setDeletingOrphanKey(null);\n    },\n  });\n\n  // Mutation for reconciling positions with Kraken\n  const reconcileMutation = useMutation({\n    mutationFn: async ({ autoClean }: { autoClean: boolean }) => {\n      const res = await fetch(\"/api/positions/reconcile\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ autoClean }),\n      });\n      if (!res.ok) {\n        const data = await res.json();\n        throw new Error(data.message || \"Error al reconciliar\");\n      }\n      return res.json();\n    },\n    onSuccess: (data) => {\n      if (data.cleaned > 0) {\n        toast({\n          title: \"Reconciliaci√≥n Completada\",\n          description: `${data.cleaned} posiciones hu√©rfanas eliminadas`,\n        });\n        queryClient.invalidateQueries({ queryKey: [\"openPositions\"] });\n      } else if (data.orphans?.length > 0) {\n        toast({\n          title: \"Hu√©rfanas Detectadas\",\n          description: `${data.orphans.length} posiciones hu√©rfanas encontradas`,\n          variant: \"destructive\",\n        });\n      } else {\n        toast({\n          title: \"Todo OK\",\n          description: \"No hay posiciones hu√©rfanas\",\n        });\n      }\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Error\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleClosePosition = (pair: string, lotId?: string | null, amount?: string) => {\n    const displayId = lotId ? lotId.substring(0, 8) : pair;\n    if (confirm(`¬øCerrar ${lotId ? `lote ${displayId}` : `posici√≥n`} de ${pair}? Esta acci√≥n no se puede deshacer.`)) {\n      closePositionMutation.mutate({ pair, lotId, amount });\n    }\n  };\n\n  const handleDeleteOrphan = (lotId: string, pair: string, amount: string) => {\n    setOrphanToDelete({ lotId, pair, amount });\n    setOrphanDialogOpen(true);\n  };\n\n  const confirmDeleteOrphan = () => {\n    if (orphanToDelete) {\n      deleteOrphanMutation.mutate({ lotId: orphanToDelete.lotId });\n    }\n  };\n\n  const handleReconcile = () => {\n    if (confirm(\"¬øReconciliar posiciones con Kraken? Esto eliminar√° autom√°ticamente las posiciones hu√©rfanas (sin balance real).\")) {\n      reconcileMutation.mutate({ autoClean: true });\n    }\n  };\n\n  const formatDate = (dateStr: string | null) => {\n    if (!dateStr) return \"-\";\n    const date = new Date(dateStr);\n    return date.toLocaleDateString(\"es-ES\", {\n      day: \"2-digit\",\n      month: \"2-digit\",\n      year: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n    });\n  };\n\n  const formatPrice = (price: string) => {\n    const num = parseFloat(price);\n    if (num >= 1000) {\n      return num.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 2 });\n    }\n    return num.toLocaleString(\"en-US\", { minimumFractionDigits: 2, maximumFractionDigits: 6 });\n  };\n\n  const formatStrategyLabel = (strategyId: string, timeframe: string) => {\n    const strategyMap: Record<string, string> = {\n      \"momentum\": \"MOM\",\n      \"momentum_candles_5m\": \"MOM\",\n      \"momentum_candles_15m\": \"MOM\",\n      \"momentum_candles_1h\": \"MOM\",\n      \"mean_reversion\": \"REV\",\n      \"scalping\": \"SCA\",\n      \"grid\": \"GRD\",\n    };\n    const tfMap: Record<string, string> = {\n      \"cycle\": \"CYC\",\n      \"5m\": \"5M\",\n      \"15m\": \"15M\",\n      \"1h\": \"1H\",\n    };\n    const strategyName = strategyMap[strategyId] || strategyId.split('_')[0]?.substring(0, 3).toUpperCase() || \"MOM\";\n    const tfLabel = tfMap[timeframe] || timeframe.toUpperCase();\n    const isCandles = timeframe !== \"cycle\";\n    return { strategyName, tfLabel, isCandles };\n  };\n\n  const totalPages = closedData ? Math.ceil(closedData.total / limit) : 0;\n  const currentPage = Math.floor(offset / limit) + 1;\n\n  const handlePrevPage = () => {\n    if (offset > 0) {\n      setOffset(Math.max(0, offset - limit));\n    }\n  };\n\n  const handleNextPage = () => {\n    if (closedData && offset + limit < closedData.total) {\n      setOffset(offset + limit);\n    }\n  };\n\n  const handleLimitChange = (value: string) => {\n    const newLimit = value === \"all\" ? 1000 : parseInt(value);\n    setLimit(newLimit);\n    setOffset(0);\n  };\n\n  const availablePairs = [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\", \"XRP/USD\", \"TON/USD\"];\n\n  const totalUnrealizedPnl = openPositions?.reduce((sum, pos) => sum + parseFloat(pos.unrealizedPnlUsd), 0) || 0;\n  const positionsCount = openPositions?.length || 0;\n\n  return (\n    <div className=\"min-h-screen bg-background flex flex-col relative overflow-hidden\">\n      <div \n        className=\"fixed inset-0 z-0 opacity-15 pointer-events-none\" \n        style={{ \n          backgroundImage: `url(${generatedImage})`, \n          backgroundSize: 'cover',\n          backgroundPosition: 'center',\n          mixBlendMode: 'overlay'\n        }} \n      />\n      \n      <div className=\"relative z-10 flex flex-col min-h-screen\">\n        <Nav />\n        \n        <main className=\"flex-1 p-3 md:p-4 lg:p-6 max-w-7xl mx-auto w-full\">\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-10 w-10 bg-gradient-to-br from-cyan-500/20 to-blue-600/20 rounded-lg flex items-center justify-center border border-cyan-500/30\">\n                <BarChart3 className=\"h-5 w-5 text-cyan-400\" />\n              </div>\n              <div>\n                <h1 className=\"text-xl md:text-2xl font-bold font-mono tracking-tight text-foreground\">TERMINAL</h1>\n                <p className=\"text-xs text-muted-foreground font-mono\">POSICIONES Y OPERACIONES</p>\n              </div>\n            </div>\n            \n            <div className=\"flex items-center gap-3\">\n              <div \n                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border ${\n                  botConfig?.positionMode === 'DCA' \n                    ? 'bg-purple-500/10 border-purple-500/30' \n                    : 'bg-amber-500/10 border-amber-500/30'\n                }`}\n                data-testid=\"badge-position-mode\"\n              >\n                {botConfig?.positionMode === 'DCA' \n                  ? <Layers className=\"h-3 w-3 text-purple-400\" /> \n                  : <Square className=\"h-3 w-3 text-amber-400\" />\n                }\n                <span className=\"font-mono text-xs text-muted-foreground\">MODO:</span>\n                <span className={`font-mono text-sm font-bold ${\n                  botConfig?.positionMode === 'DCA' ? 'text-purple-400' : 'text-amber-400'\n                }`}>\n                  {botConfig?.positionMode || 'SINGLE'}\n                </span>\n              </div>\n              <div className=\"flex items-center gap-2 px-3 py-1.5 bg-card/50 rounded-lg border border-border/50\">\n                <CircleDot className={`h-3 w-3 ${positionsCount > 0 ? 'text-green-400 animate-pulse' : 'text-muted-foreground'}`} />\n                <span className=\"font-mono text-xs text-muted-foreground\">ACTIVAS:</span>\n                <span className=\"font-mono text-sm font-bold\">{positionsCount}</span>\n              </div>\n              <div className={`flex items-center gap-2 px-3 py-1.5 rounded-lg border ${totalUnrealizedPnl >= 0 ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'}`}>\n                {totalUnrealizedPnl >= 0 ? <TrendingUp className=\"h-3 w-3 text-green-400\" /> : <TrendingDown className=\"h-3 w-3 text-red-400\" />}\n                <span className=\"font-mono text-xs text-muted-foreground\">P&L:</span>\n                <span className={`font-mono text-sm font-bold ${totalUnrealizedPnl >= 0 ? 'text-green-400' : 'text-red-400'}`}>\n                  {totalUnrealizedPnl >= 0 ? '+' : ''}${totalUnrealizedPnl.toFixed(2)}\n                </span>\n              </div>\n            </div>\n          </div>\n\n          <Tabs value={activeTab} onValueChange={setActiveTab} className=\"space-y-4\">\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-3\">\n              <TabsList className=\"bg-card/50 border border-border/50 p-1\">\n                <TabsTrigger \n                  value=\"positions\" \n                  className=\"font-mono text-xs data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400\"\n                  data-testid=\"tab-positions\"\n                >\n                  <Target className=\"h-3.5 w-3.5 mr-1.5\" />\n                  POSICIONES\n                </TabsTrigger>\n                <TabsTrigger \n                  value=\"history\" \n                  className=\"font-mono text-xs data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400\"\n                  data-testid=\"tab-history\"\n                >\n                  <Activity className=\"h-3.5 w-3.5 mr-1.5\" />\n                  HISTORIAL\n                </TabsTrigger>\n              </TabsList>\n\n              {activeTab === \"positions\" && (\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => refetchPositions()}\n                  disabled={fetchingPositions}\n                  className=\"font-mono text-xs border-border/50 hover:border-cyan-500/50 hover:text-cyan-400\"\n                  data-testid=\"button-refresh-positions\"\n                >\n                  <RefreshCw className={`h-3.5 w-3.5 mr-1.5 ${fetchingPositions ? 'animate-spin' : ''}`} />\n                  ACTUALIZAR\n                </Button>\n              )}\n\n              {activeTab === \"history\" && (\n                <div className=\"flex flex-wrap items-center gap-2\">\n                  <Select value={typeFilter} onValueChange={setTypeFilter}>\n                    <SelectTrigger className=\"w-[90px] h-8 text-xs font-mono bg-card/50 border-border/50\" data-testid=\"select-type-filter\">\n                      <SelectValue placeholder=\"Tipo\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">TODAS</SelectItem>\n                      <SelectItem value=\"buy\">COMPRAS</SelectItem>\n                      <SelectItem value=\"sell\">VENTAS</SelectItem>\n                    </SelectContent>\n                  </Select>\n\n                  <Select value={pairFilter} onValueChange={setPairFilter}>\n                    <SelectTrigger className=\"w-[100px] h-8 text-xs font-mono bg-card/50 border-border/50\" data-testid=\"select-pair-filter\">\n                      <SelectValue placeholder=\"Par\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">TODOS</SelectItem>\n                      {availablePairs.map(pair => (\n                        <SelectItem key={pair} value={pair}>{pair}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  \n                  <Select value={resultFilter} onValueChange={setResultFilter}>\n                    <SelectTrigger className=\"w-[100px] h-8 text-xs font-mono bg-card/50 border-border/50\" data-testid=\"select-result-filter\">\n                      <SelectValue placeholder=\"Resultado\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">TODAS</SelectItem>\n                      <SelectItem value=\"winner\">GANADORAS</SelectItem>\n                      <SelectItem value=\"loser\">PERDEDORAS</SelectItem>\n                    </SelectContent>\n                  </Select>\n\n                  <Select value={limit.toString()} onValueChange={handleLimitChange}>\n                    <SelectTrigger className=\"w-[70px] h-8 text-xs font-mono bg-card/50 border-border/50\" data-testid=\"select-limit\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"10\">10</SelectItem>\n                      <SelectItem value=\"25\">25</SelectItem>\n                      <SelectItem value=\"50\">50</SelectItem>\n                      <SelectItem value=\"100\">100</SelectItem>\n                      <SelectItem value=\"all\">TODO</SelectItem>\n                    </SelectContent>\n                  </Select>\n\n                  <Button \n                    variant=\"outline\" \n                    size=\"sm\" \n                    onClick={handleSyncFromKraken}\n                    disabled={syncing}\n                    className=\"text-xs font-mono border-border/50 hover:border-cyan-500/50 hover:text-cyan-400\"\n                    data-testid=\"button-sync-kraken\"\n                  >\n                    <Download className={`h-3.5 w-3.5 mr-1 ${syncing ? 'animate-pulse' : ''}`} />\n                    SYNC\n                  </Button>\n\n                  <Button \n                    variant=\"ghost\" \n                    size=\"sm\" \n                    onClick={() => refetchClosed()}\n                    disabled={fetchingClosed}\n                    className=\"text-muted-foreground hover:text-cyan-400\"\n                    data-testid=\"button-refresh-closed\"\n                  >\n                    <RefreshCw className={`h-3.5 w-3.5 ${fetchingClosed ? 'animate-spin' : ''}`} />\n                  </Button>\n                </div>\n              )}\n            </div>\n\n            <TabsContent value=\"positions\" className=\"mt-0\">\n              <Card className=\"bg-card/40 border-border/50 backdrop-blur-sm\">\n                <CardHeader className=\"py-3 px-4 border-b border-border/30\">\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle className=\"text-sm font-mono text-muted-foreground flex items-center gap-2\">\n                      <Zap className=\"h-4 w-4 text-cyan-400\" />\n                      POSICIONES ABIERTAS\n                    </CardTitle>\n                    <div className=\"flex items-center gap-3\">\n                      <span className=\"text-xs font-mono text-muted-foreground\">\n                        {openPositions?.length || 0} activa{openPositions?.length !== 1 ? 's' : ''}\n                      </span>\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={handleReconcile}\n                        disabled={reconcileMutation.isPending}\n                        className=\"h-7 text-[10px] font-mono border-orange-500/50 text-orange-400 hover:bg-orange-500/10\"\n                        data-testid=\"button-reconcile\"\n                        title=\"Compara balances reales de Kraken y elimina posiciones hu√©rfanas\"\n                      >\n                        {reconcileMutation.isPending ? (\n                          <Loader2 className=\"h-3 w-3 animate-spin mr-1\" />\n                        ) : (\n                          <RefreshCw className=\"h-3 w-3 mr-1\" />\n                        )}\n                        RECONCILIAR\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"p-0\">\n                  {loadingPositions ? (\n                    <div className=\"flex items-center justify-center py-12\">\n                      <div className=\"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cyan-400\"></div>\n                    </div>\n                  ) : openPositions && openPositions.length > 0 ? (\n                    <div className=\"divide-y divide-border/20\">\n                      {openPositions.map((pos) => {\n                        const pnlUsd = parseFloat(pos.unrealizedPnlUsd);\n                        const pnlPct = parseFloat(pos.unrealizedPnlPct);\n                        const isProfit = pnlUsd >= 0;\n                        const strategyInfo = formatStrategyLabel(pos.entryStrategyId || \"momentum\", pos.entrySignalTf || \"cycle\");\n                        \n                        return (\n                          <div \n                            key={pos.id}\n                            className=\"flex flex-col lg:flex-row lg:items-center justify-between p-4 hover:bg-white/[0.02] transition-colors\"\n                            data-testid={`position-row-${pos.id}`}\n                          >\n                            <div className=\"flex items-center gap-4 mb-3 lg:mb-0\">\n                              <div className=\"relative\">\n                                <div className={`h-10 w-10 rounded-lg flex items-center justify-center ${isProfit ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>\n                                  {isProfit ? <TrendingUp className=\"h-5 w-5 text-green-400\" /> : <TrendingDown className=\"h-5 w-5 text-red-400\" />}\n                                </div>\n                                <div className=\"absolute -top-1 -right-1 h-3 w-3 bg-green-400 rounded-full border-2 border-background animate-pulse\" />\n                              </div>\n                              <div>\n                                <div className=\"font-mono font-bold text-base flex items-center gap-2\">\n                                  {pos.pair}\n                                  <Badge variant=\"outline\" className={`text-[10px] px-1.5 py-0 font-mono ${strategyInfo.isCandles ? 'border-cyan-500/50 text-cyan-400' : 'border-primary/50 text-primary'}`}>\n                                    {strategyInfo.isCandles ? <CandlestickChart className=\"h-2.5 w-2.5 mr-0.5\" /> : <Activity className=\"h-2.5 w-2.5 mr-0.5\" />}\n                                    {strategyInfo.strategyName}/{strategyInfo.tfLabel}\n                                  </Badge>\n                                  {pos.entryMode && (\n                                    <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0 font-mono border-orange-500/50 text-orange-400\">\n                                      <Layers className=\"h-2.5 w-2.5 mr-0.5\" />\n                                      {pos.entryMode}\n                                    </Badge>\n                                  )}\n                                </div>\n                                <div className=\"text-xs text-muted-foreground font-mono flex items-center gap-1.5\">\n                                  <Clock className=\"h-3 w-3\" />\n                                  {formatDate(pos.openedAt)}\n                                  <span className=\"text-[10px] opacity-60\">| Lote: {pos.lotId?.substring(0, 8) || 'N/A'}</span>\n                                  {botConfig?.positionMode === 'SMART_GUARD' && (\n                                    <Badge variant=\"secondary\" className=\"text-[9px] px-1 py-0 ml-1\" title=\"Slots usados / m√°ximo\">\n                                      {getLotsCountByPair(pos.pair).count}/{getLotsCountByPair(pos.pair).max}\n                                    </Badge>\n                                  )}\n                                </div>\n                              </div>\n                            </div>\n                            \n                            <div className=\"flex items-center gap-4\">\n                              <div className=\"grid grid-cols-3 sm:grid-cols-6 gap-3 lg:gap-4 flex-1\">\n                                <div>\n                                  <div className=\"font-mono text-[10px] text-muted-foreground uppercase\">Cantidad</div>\n                                  <div className=\"font-mono font-medium text-sm\">{parseFloat(pos.amount).toFixed(6)}</div>\n                                </div>\n                                <div>\n                                  <div className=\"font-mono text-[10px] text-muted-foreground uppercase\">Precio Entrada</div>\n                                  <div className=\"font-mono font-medium text-sm\">${formatPrice(pos.entryPrice)}</div>\n                                </div>\n                                <div>\n                                  <div className=\"font-mono text-[10px] text-muted-foreground uppercase\" title=\"Valor de entrada en USD\">Valor Entrada</div>\n                                  <div className=\"font-mono font-medium text-sm text-blue-400\">${parseFloat(pos.entryValueUsd).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                                </div>\n                                <div>\n                                  <div className=\"font-mono text-[10px] text-muted-foreground uppercase\">Precio Actual</div>\n                                  <div className=\"font-mono font-medium text-sm\">${formatPrice(pos.currentPrice)}</div>\n                                </div>\n                                <div>\n                                  <div className=\"font-mono text-[10px] text-muted-foreground uppercase\" title=\"Valor actual en USD\">Valor Actual</div>\n                                  <div className=\"font-mono font-medium text-sm text-cyan-400\">${parseFloat(pos.currentValueUsd).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>\n                                </div>\n                                <div>\n                                  <div className=\"font-mono text-[10px] text-muted-foreground uppercase\">P&L</div>\n                                  <div className={`font-mono font-bold text-sm flex items-center gap-1 ${isProfit ? 'text-green-400' : 'text-red-400'}`}>\n                                    {isProfit ? '+' : '-'}${Math.abs(pnlUsd).toFixed(2)}\n                                    <span className=\"text-xs opacity-75\">({pnlPct >= 0 ? '+' : ''}{pnlPct.toFixed(2)}%)</span>\n                                  </div>\n                                </div>\n                              </div>\n                              <div className=\"flex gap-2 shrink-0\">\n                                <Button\n                                  variant=\"destructive\"\n                                  size=\"sm\"\n                                  onClick={() => handleClosePosition(pos.pair, pos.lotId, pos.amount)}\n                                  disabled={closingKey === getPositionKey(pos.pair, pos.lotId)}\n                                  data-testid={`button-close-position-${pos.lotId || pos.id}`}\n                                >\n                                  {closingKey === getPositionKey(pos.pair, pos.lotId) ? (\n                                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                                  ) : (\n                                    <X className=\"h-4 w-4\" />\n                                  )}\n                                  <span className=\"hidden sm:inline ml-1\">Cerrar</span>\n                                </Button>\n                                {pos.lotId && dustPositions.has(pos.lotId) && (\n                                  <Button\n                                    variant=\"outline\"\n                                    size=\"sm\"\n                                    onClick={() => handleDeleteOrphan(pos.lotId!, pos.pair, pos.amount)}\n                                    disabled={deletingOrphanKey === pos.lotId}\n                                    className=\"text-orange-400 border-orange-400/50 hover:bg-orange-400/10\"\n                                    data-testid={`button-delete-orphan-${pos.lotId}`}\n                                    title=\"Eliminar registro interno sin enviar orden a Kraken\"\n                                  >\n                                    {deletingOrphanKey === pos.lotId ? (\n                                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                                    ) : (\n                                      <Trash2 className=\"h-4 w-4\" />\n                                    )}\n                                    <span className=\"hidden lg:inline ml-1\">Hu√©rfana</span>\n                                  </Button>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        );\n                      })}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-16\">\n                      <div className=\"h-16 w-16 mx-auto bg-muted/20 rounded-full flex items-center justify-center mb-4\">\n                        <Target className=\"h-8 w-8 text-muted-foreground/50\" />\n                      </div>\n                      <p className=\"font-mono text-muted-foreground text-sm\">NO HAY POSICIONES ABIERTAS</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">Las posiciones aparecer√°n cuando el bot compre activos</p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"history\" className=\"mt-0\">\n              <Card className=\"bg-card/40 border-border/50 backdrop-blur-sm\">\n                <CardHeader className=\"py-3 px-4 border-b border-border/30\">\n                  <div className=\"flex items-center justify-between\">\n                    <CardTitle className=\"text-sm font-mono text-muted-foreground flex items-center gap-2\">\n                      <Activity className=\"h-4 w-4 text-cyan-400\" />\n                      HISTORIAL DE OPERACIONES\n                    </CardTitle>\n                    <span className=\"text-xs font-mono text-muted-foreground\">\n                      {closedData?.total || 0} operaciones\n                    </span>\n                  </div>\n                </CardHeader>\n                <CardContent className=\"p-0\">\n                  {loadingClosed ? (\n                    <div className=\"flex items-center justify-center py-16\">\n                      <div className=\"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-cyan-400\"></div>\n                    </div>\n                  ) : closedData && closedData.trades.length > 0 ? (\n                    <>\n                      <div className=\"overflow-x-auto\">\n                        <table className=\"w-full min-w-[900px]\">\n                          <thead>\n                            <tr className=\"border-b border-border/30 text-left\">\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal\">Tipo</th>\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal\">Par</th>\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal\">Fecha</th>\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right\">Cantidad</th>\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right\">Precio</th>\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right\" title=\"Valor total de la operaci√≥n en USD\">Total USD</th>\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-right\">P&L</th>\n                              <th className=\"py-3 px-3 font-mono text-[10px] text-muted-foreground uppercase font-normal text-center\">Estado</th>\n                            </tr>\n                          </thead>\n                          <tbody className=\"divide-y divide-border/20\">\n                            {closedData.trades.map((trade) => {\n                              const pnlUsd = trade.realizedPnlUsd ? parseFloat(trade.realizedPnlUsd) : null;\n                              const pnlPct = trade.realizedPnlPct ? parseFloat(trade.realizedPnlPct) : null;\n                              const isProfit = pnlUsd !== null && pnlUsd >= 0;\n                              \n                              return (\n                                <tr \n                                  key={trade.id}\n                                  className=\"hover:bg-white/[0.02] transition-colors\"\n                                  data-testid={`closed-trade-row-${trade.id}`}\n                                >\n                                  <td className=\"py-3 px-3\">\n                                    <div className={`inline-flex items-center gap-1.5 px-2 py-1 rounded text-xs font-mono font-bold ${trade.type === 'buy' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'}`}>\n                                      {trade.type === 'buy' ? <ArrowUpRight className=\"h-3 w-3\" /> : <ArrowDownRight className=\"h-3 w-3\" />}\n                                      {trade.type === 'buy' ? 'BUY' : 'SELL'}\n                                    </div>\n                                  </td>\n                                  <td className=\"py-3 px-3\">\n                                    <span className=\"font-mono font-medium text-sm\">{trade.pair}</span>\n                                  </td>\n                                  <td className=\"py-3 px-3\">\n                                    <span className=\"font-mono text-xs text-muted-foreground\">{formatDate(trade.executedAt || trade.createdAt)}</span>\n                                  </td>\n                                  <td className=\"py-3 px-3 text-right\">\n                                    <span className=\"font-mono text-sm\">{parseFloat(trade.amount).toFixed(6)}</span>\n                                  </td>\n                                  <td className=\"py-3 px-3 text-right\">\n                                    <span className=\"font-mono text-sm\">${formatPrice(trade.price)}</span>\n                                  </td>\n                                  <td className=\"py-3 px-3 text-right\">\n                                    <span className=\"font-mono text-sm font-medium text-cyan-400\" title=\"Cantidad √ó Precio\">\n                                      ${parseFloat(trade.totalUsd).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </span>\n                                  </td>\n                                  <td className=\"py-3 px-3 text-right\">\n                                    {pnlUsd !== null ? (\n                                      <span className={`font-mono font-bold text-sm ${isProfit ? 'text-green-400' : 'text-red-400'}`}>\n                                        {isProfit ? '+' : ''}${pnlUsd.toFixed(2)}\n                                        <span className=\"text-xs opacity-75 ml-1\">\n                                          ({pnlPct !== null ? (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(1) : '0'}%)\n                                        </span>\n                                      </span>\n                                    ) : (\n                                      <span className=\"font-mono text-sm text-muted-foreground\">-</span>\n                                    )}\n                                  </td>\n                                  <td className=\"py-3 px-3 text-center\">\n                                    <Badge \n                                      variant=\"outline\"\n                                      className={`font-mono text-[10px] ${\n                                        trade.status === 'filled' \n                                          ? 'border-green-500/50 text-green-400 bg-green-500/10' \n                                          : trade.status === 'pending' \n                                            ? 'border-yellow-500/50 text-yellow-400 bg-yellow-500/10' \n                                            : 'border-red-500/50 text-red-400 bg-red-500/10'\n                                      }`}\n                                    >\n                                      {trade.status === 'filled' ? 'OK' : trade.status.toUpperCase()}\n                                    </Badge>\n                                  </td>\n                                </tr>\n                              );\n                            })}\n                          </tbody>\n                        </table>\n                      </div>\n\n                      {totalPages > 1 && (\n                        <div className=\"flex items-center justify-between p-4 border-t border-border/30\">\n                          <span className=\"text-xs font-mono text-muted-foreground\">\n                            {offset + 1}-{Math.min(offset + limit, closedData.total)} de {closedData.total}\n                          </span>\n                          <div className=\"flex items-center gap-2\">\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={handlePrevPage}\n                              disabled={offset === 0}\n                              className=\"h-7 px-2 font-mono text-xs border-border/50\"\n                              data-testid=\"button-prev-page\"\n                            >\n                              <ChevronLeft className=\"h-3.5 w-3.5\" />\n                            </Button>\n                            <span className=\"text-xs font-mono text-muted-foreground px-2\">\n                              {currentPage}/{totalPages}\n                            </span>\n                            <Button\n                              variant=\"outline\"\n                              size=\"sm\"\n                              onClick={handleNextPage}\n                              disabled={offset + limit >= closedData.total}\n                              className=\"h-7 px-2 font-mono text-xs border-border/50\"\n                              data-testid=\"button-next-page\"\n                            >\n                              <ChevronRight className=\"h-3.5 w-3.5\" />\n                            </Button>\n                          </div>\n                        </div>\n                      )}\n                    </>\n                  ) : (\n                    <div className=\"text-center py-16\">\n                      <div className=\"h-16 w-16 mx-auto bg-muted/20 rounded-full flex items-center justify-center mb-4\">\n                        <Clock className=\"h-8 w-8 text-muted-foreground/50\" />\n                      </div>\n                      <p className=\"font-mono text-muted-foreground text-sm\">NO HAY OPERACIONES</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">Las operaciones aparecer√°n cuando el bot venda activos</p>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </main>\n      </div>\n\n      {/* Dialog de confirmaci√≥n para eliminar posici√≥n hu√©rfana */}\n      <AlertDialog open={orphanDialogOpen} onOpenChange={setOrphanDialogOpen}>\n        <AlertDialogContent className=\"bg-card border-border\">\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"flex items-center gap-2 text-orange-400\">\n              <AlertTriangle className=\"h-5 w-5\" />\n              Eliminar Posici√≥n Hu√©rfana\n            </AlertDialogTitle>\n            <AlertDialogDescription className=\"space-y-3\">\n              <p>\n                Esta acci√≥n <strong>solo elimina el registro interno</strong> del bot (base de datos).\n                <strong> NO env√≠a ninguna orden a Kraken.</strong>\n              </p>\n              {orphanToDelete && (\n                <div className=\"bg-muted/30 rounded-md p-3 font-mono text-sm\">\n                  <div><span className=\"text-muted-foreground\">Par:</span> {orphanToDelete.pair}</div>\n                  <div><span className=\"text-muted-foreground\">Lote:</span> {orphanToDelete.lotId.substring(0, 12)}...</div>\n                  <div><span className=\"text-muted-foreground\">Cantidad:</span> {parseFloat(orphanToDelete.amount).toFixed(8)}</div>\n                </div>\n              )}\n              <p className=\"text-orange-400 text-sm\">\n                √ösalo cuando el balance real en Kraken sea menor al m√≠nimo (posici√≥n DUST) \n                o cuando ya vendiste manualmente fuera del bot.\n              </p>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDeleteOrphan}\n              className=\"bg-orange-500 hover:bg-orange-600\"\n              disabled={deleteOrphanMutation.isPending}\n            >\n              {deleteOrphanMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n              ) : (\n                <Trash2 className=\"h-4 w-4 mr-2\" />\n              )}\n              Eliminar de BD\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":46142,"size_tokens":null},"client/src/pages/Monitor.tsx":{"content":"import { useState, useRef, useEffect, useMemo } from \"react\";\nimport { Nav } from \"@/components/dashboard/Nav\";\nimport { useEventsFeed } from \"@/context/EventsWebSocketContext\";\nimport { BotEvent } from \"@/hooks/useEventsWebSocket\";\nimport { useTerminalWebSocket } from \"@/hooks/useTerminalWebSocket\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { \n  Wifi, WifiOff, RefreshCw, Trash2, Pause, Play, \n  Download, Copy, Search, X, ChevronDown, ChevronRight,\n  AlertCircle, AlertTriangle, Info, Terminal, Activity,\n  Eye, TrendingUp, TrendingDown, Minus\n} from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { cn } from \"@/lib/utils\";\n\nconst LEVEL_COLORS: Record<string, string> = {\n  INFO: \"bg-blue-500/20 text-blue-400 border-blue-500/30\",\n  WARN: \"bg-yellow-500/20 text-yellow-400 border-yellow-500/30\",\n  ERROR: \"bg-red-500/20 text-red-400 border-red-500/30\",\n};\n\nconst LEVEL_ICONS: Record<string, React.ReactNode> = {\n  INFO: <Info className=\"h-3 w-3\" />,\n  WARN: <AlertTriangle className=\"h-3 w-3\" />,\n  ERROR: <AlertCircle className=\"h-3 w-3\" />,\n};\n\nconst DEFAULT_EVENT_TYPES = [\n  \"TRADE_EXECUTED\", \"TRADE_BLOCKED\", \"TRADE_FAILED\", \"TRADE_ADJUSTED\", \"TRADE_REJECTED_LOW_PROFIT\", \"TRADE_SKIPPED\",\n  \"STOP_LOSS_HIT\", \"TAKE_PROFIT_HIT\", \"TRAILING_STOP_HIT\",\n  \"BOT_STARTED\", \"BOT_STOPPED\", \"BOT_PAUSED\", \"BOT_RESUMED\",\n  \"ENGINE_TICK\", \"MARKET_SCAN_SUMMARY\",\n  \"DAILY_LIMIT_HIT\", \"DAILY_LIMIT_RESET\", \"PAIR_COOLDOWN\",\n  \"KRAKEN_ERROR\", \"KRAKEN_CONNECTED\", \"TELEGRAM_ERROR\", \"TELEGRAM_CONNECTED\", \"NONCE_ERROR\",\n  \"POSITION_OPENED\", \"POSITION_CLOSED\", \"ORPHAN_POSITION_CLEANED\",\n  \"SIGNAL_GENERATED\", \"BALANCE_CHECK\", \"SYSTEM_ERROR\",\n];\n\nconst DEFAULT_PAIRS = [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\", \"XRP/USD\", \"TON/USD\"];\n\nexport default function Monitor() {\n  const [activeTab, setActiveTab] = useState(\"events\");\n  \n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Nav />\n      <div className=\"p-4 md:p-6 max-w-[1800px] mx-auto\">\n        <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\n          <div className=\"flex items-center gap-4 mb-4\">\n            <h1 className=\"text-xl font-bold\">Monitor</h1>\n            <TabsList>\n              <TabsTrigger value=\"events\" className=\"gap-1\" data-testid=\"tab-events\">\n                <Activity className=\"h-4 w-4\" />\n                Eventos\n              </TabsTrigger>\n              <TabsTrigger value=\"terminal\" className=\"gap-1\" data-testid=\"tab-terminal\">\n                <Terminal className=\"h-4 w-4\" />\n                Terminal\n              </TabsTrigger>\n              <TabsTrigger value=\"diagnostic\" className=\"gap-1\" data-testid=\"tab-diagnostic\">\n                <Eye className=\"h-4 w-4\" />\n                Diagn√≥stico\n              </TabsTrigger>\n            </TabsList>\n          </div>\n          \n          <TabsContent value=\"events\" className=\"mt-0\">\n            <EventsTab />\n          </TabsContent>\n          \n          <TabsContent value=\"terminal\" className=\"mt-0\">\n            <TerminalTab />\n          </TabsContent>\n          \n          <TabsContent value=\"diagnostic\" className=\"mt-0\">\n            <DiagnosticTab />\n          </TabsContent>\n        </Tabs>\n      </div>\n    </div>\n  );\n}\n\nfunction EventsTab() {\n  const { events, status, error, connect, disconnect, clearEvents, isConnected } = useEventsFeed();\n  \n  const [autoScroll, setAutoScroll] = useState(true);\n  const [selectedEvent, setSelectedEvent] = useState<BotEvent | null>(null);\n  const [searchText, setSearchText] = useState(\"\");\n  const [levelFilter, setLevelFilter] = useState<string[]>([\"INFO\", \"WARN\", \"ERROR\"]);\n  const [typeFilter, setTypeFilter] = useState<string[]>([]);\n  const [pairFilter, setPairFilter] = useState<string[]>([]);\n  const [showFilters, setShowFilters] = useState(false);\n  const [lastMessageTime, setLastMessageTime] = useState<Date | null>(null);\n  \n  const scrollRef = useRef<HTMLDivElement>(null);\n  const prevEventsLengthRef = useRef(events.length);\n\n  useEffect(() => {\n    if (events.length > 0) {\n      const latestEvent = events[0];\n      if (latestEvent?.timestamp) {\n        setLastMessageTime(new Date(latestEvent.timestamp));\n      }\n    }\n  }, [events]);\n\n  useEffect(() => {\n    if (autoScroll && events.length > prevEventsLengthRef.current && scrollRef.current) {\n      scrollRef.current.scrollTop = 0;\n    }\n    prevEventsLengthRef.current = events.length;\n  }, [events.length, autoScroll]);\n\n  const filteredEvents = useMemo(() => {\n    return events.filter((event) => {\n      if (levelFilter.length > 0 && !levelFilter.includes(event.level)) return false;\n      if (typeFilter.length > 0 && !typeFilter.includes(event.type)) return false;\n      if (pairFilter.length > 0) {\n        const eventPair = event.meta?.pair;\n        if (!eventPair || !pairFilter.includes(eventPair)) return false;\n      }\n      if (searchText) {\n        const searchLower = searchText.toLowerCase();\n        const messageMatch = event.message.toLowerCase().includes(searchLower);\n        const typeMatch = event.type.toLowerCase().includes(searchLower);\n        const metaMatch = event.meta ? JSON.stringify(event.meta).toLowerCase().includes(searchLower) : false;\n        if (!messageMatch && !typeMatch && !metaMatch) return false;\n      }\n      return true;\n    });\n  }, [events, levelFilter, typeFilter, pairFilter, searchText]);\n\n  const stats = useMemo(() => {\n    const last24h = events.filter(e => {\n      const eventTime = new Date(e.timestamp).getTime();\n      const now = Date.now();\n      return now - eventTime < 24 * 60 * 60 * 1000;\n    });\n    return {\n      total: events.length,\n      errors: last24h.filter(e => e.level === \"ERROR\").length,\n      warnings: last24h.filter(e => e.level === \"WARN\").length,\n      trades: last24h.filter(e => e.type === \"TRADE_EXECUTED\").length,\n    };\n  }, [events]);\n\n  const availableEventTypes = useMemo(() => {\n    const fromEvents = events.map(e => e.type);\n    const combined = new Set([...DEFAULT_EVENT_TYPES, ...fromEvents]);\n    return Array.from(combined).sort();\n  }, [events]);\n\n  const availablePairs = useMemo(() => {\n    const fromEvents = events.map(e => e.meta?.pair).filter((p): p is string => Boolean(p));\n    const combined = new Set([...DEFAULT_PAIRS, ...fromEvents]);\n    return Array.from(combined).sort();\n  }, [events]);\n\n  const handleCopyEvent = (event: BotEvent) => {\n    navigator.clipboard.writeText(JSON.stringify(event, null, 2));\n  };\n\n  const handleCopyAll = () => {\n    navigator.clipboard.writeText(JSON.stringify(filteredEvents, null, 2));\n  };\n\n  const handleDownload = () => {\n    const blob = new Blob([JSON.stringify(filteredEvents, null, 2)], { type: \"application/json\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `krakenbot-logs-${new Date().toISOString().split(\"T\")[0]}.json`;\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n\n  const toggleLevel = (level: string) => {\n    setLevelFilter(prev => \n      prev.includes(level) ? prev.filter(l => l !== level) : [...prev, level]\n    );\n  };\n\n  const formatTimestamp = (ts: string) => {\n    const date = new Date(ts);\n    return date.toLocaleTimeString(\"es-ES\", { hour: \"2-digit\", minute: \"2-digit\", second: \"2-digit\" });\n  };\n\n  const formatDate = (ts: string) => {\n    const date = new Date(ts);\n    return date.toLocaleDateString(\"es-ES\", { day: \"2-digit\", month: \"2-digit\" });\n  };\n\n  return (\n    <div className=\"flex flex-col lg:flex-row gap-4\">\n      <div className=\"flex-1 space-y-4\">\n        <div className=\"flex flex-wrap items-center gap-2 justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <Badge \n              variant=\"outline\" \n              className={cn(\n                \"gap-1\",\n                isConnected ? \"border-green-500 text-green-400\" : \n                status === \"reconnecting\" ? \"border-yellow-500 text-yellow-400\" :\n                \"border-red-500 text-red-400\"\n              )}\n              data-testid=\"badge-ws-status\"\n            >\n              {isConnected ? <Wifi className=\"h-3 w-3\" /> : \n               status === \"reconnecting\" ? <RefreshCw className=\"h-3 w-3 animate-spin\" /> :\n               <WifiOff className=\"h-3 w-3\" />}\n              {status === \"connected\" ? \"Conectado\" : \n               status === \"reconnecting\" ? \"Reconectando...\" : \n               status === \"connecting\" ? \"Conectando...\" : \"Desconectado\"}\n            </Badge>\n          </div>\n          \n          <div className=\"flex items-center gap-2\">\n            <div className=\"text-xs text-muted-foreground hidden sm:flex gap-3\">\n              <span>Eventos: {stats.total}</span>\n              <span className=\"text-red-400\">Errores 24h: {stats.errors}</span>\n              <span className=\"text-yellow-400\">Avisos 24h: {stats.warnings}</span>\n              <span className=\"text-green-400\">Trades 24h: {stats.trades}</span>\n              {lastMessageTime && (\n                <span className=\"text-cyan-400\" data-testid=\"last-message-time\">\n                  √öltimo: {lastMessageTime.toLocaleTimeString(\"es-ES\", { hour: \"2-digit\", minute: \"2-digit\", second: \"2-digit\" })}\n                </span>\n              )}\n            </div>\n          </div>\n        </div>\n\n        <Card className=\"border-border/50\">\n          <CardHeader className=\"py-3 px-4\">\n            <div className=\"flex flex-wrap items-center gap-2 justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Buscar...\"\n                    value={searchText}\n                    onChange={(e) => setSearchText(e.target.value)}\n                    className=\"pl-8 h-8 w-40 sm:w-60\"\n                    data-testid=\"input-search\"\n                  />\n                  {searchText && (\n                    <button \n                      onClick={() => setSearchText(\"\")}\n                      className=\"absolute right-2 top-1/2 -translate-y-1/2\"\n                    >\n                      <X className=\"h-3 w-3 text-muted-foreground hover:text-foreground\" />\n                    </button>\n                  )}\n                </div>\n                \n                <div className=\"flex gap-1\">\n                  {[\"INFO\", \"WARN\", \"ERROR\"].map(level => (\n                    <Button\n                      key={level}\n                      variant=\"outline\"\n                      size=\"sm\"\n                      className={cn(\n                        \"h-8 px-2 text-xs\",\n                        levelFilter.includes(level) ? LEVEL_COLORS[level] : \"opacity-40\"\n                      )}\n                      onClick={() => toggleLevel(level)}\n                      data-testid={`button-filter-${level.toLowerCase()}`}\n                    >\n                      {LEVEL_ICONS[level]}\n                      <span className=\"hidden sm:inline ml-1\">{level}</span>\n                    </Button>\n                  ))}\n                </div>\n\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  className=\"h-8 text-xs\"\n                  onClick={() => setShowFilters(!showFilters)}\n                >\n                  Filtros\n                  {showFilters ? <ChevronDown className=\"ml-1 h-3 w-3\" /> : <ChevronRight className=\"ml-1 h-3 w-3\" />}\n                </Button>\n              </div>\n\n              <div className=\"flex items-center gap-1\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-8 w-8\"\n                  onClick={() => setAutoScroll(!autoScroll)}\n                  title={autoScroll ? \"Pausar auto-scroll\" : \"Reanudar auto-scroll\"}\n                  data-testid=\"button-autoscroll\"\n                >\n                  {autoScroll ? <Pause className=\"h-4 w-4\" /> : <Play className=\"h-4 w-4\" />}\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-8 w-8\"\n                  onClick={clearEvents}\n                  title=\"Limpiar\"\n                  data-testid=\"button-clear\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-8 w-8\"\n                  onClick={handleCopyAll}\n                  title=\"Copiar todo\"\n                  data-testid=\"button-copy-all\"\n                >\n                  <Copy className=\"h-4 w-4\" />\n                </Button>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-8 w-8\"\n                  onClick={handleDownload}\n                  title=\"Descargar\"\n                  data-testid=\"button-download\"\n                >\n                  <Download className=\"h-4 w-4\" />\n                </Button>\n                {!isConnected && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"h-8\"\n                    onClick={connect}\n                    data-testid=\"button-reconnect\"\n                  >\n                    Reconectar\n                  </Button>\n                )}\n              </div>\n            </div>\n\n            {showFilters && (\n              <div className=\"mt-3 pt-3 border-t border-border/50 space-y-2\">\n                <div className=\"flex flex-wrap gap-1\" data-testid=\"filter-type-container\">\n                  <span className=\"text-xs text-muted-foreground mr-2\">Tipo:</span>\n                  {availableEventTypes.map((type: string) => (\n                    <Badge\n                      key={type}\n                      variant=\"outline\"\n                      className={cn(\n                        \"cursor-pointer text-xs\",\n                        typeFilter.includes(type) ? \"bg-primary/20\" : \"opacity-50\"\n                      )}\n                      onClick={() => setTypeFilter(prev => \n                        prev.includes(type) ? prev.filter(t => t !== type) : [...prev, type]\n                      )}\n                      data-testid={`filter-type-${type}`}\n                    >\n                      {type.replace(/_/g, \" \")}\n                    </Badge>\n                  ))}\n                  {typeFilter.length > 0 && (\n                    <Button variant=\"ghost\" size=\"sm\" className=\"h-5 text-xs\" onClick={() => setTypeFilter([])} data-testid=\"button-clear-type-filter\">\n                      Limpiar\n                    </Button>\n                  )}\n                </div>\n                <div className=\"flex flex-wrap gap-1\" data-testid=\"filter-pair-container\">\n                  <span className=\"text-xs text-muted-foreground mr-2\">Par:</span>\n                  {availablePairs.map((pair: string) => (\n                    <Badge\n                      key={pair}\n                      variant=\"outline\"\n                      className={cn(\n                        \"cursor-pointer text-xs\",\n                        pairFilter.includes(pair) ? \"bg-primary/20\" : \"opacity-50\"\n                      )}\n                      onClick={() => setPairFilter(prev => \n                        prev.includes(pair) ? prev.filter(p => p !== pair) : [...prev, pair]\n                      )}\n                      data-testid={`filter-pair-${pair.replace(\"/\", \"-\")}`}\n                    >\n                      {pair}\n                    </Badge>\n                  ))}\n                  {pairFilter.length > 0 && (\n                    <Button variant=\"ghost\" size=\"sm\" className=\"h-5 text-xs\" onClick={() => setPairFilter([])} data-testid=\"button-clear-pair-filter\">\n                      Limpiar\n                    </Button>\n                  )}\n                </div>\n              </div>\n            )}\n          </CardHeader>\n          \n          <CardContent className=\"p-0\">\n            <ScrollArea className=\"h-[calc(100vh-320px)]\" ref={scrollRef}>\n              <div className=\"font-mono text-xs divide-y divide-border/30\">\n                {filteredEvents.length === 0 ? (\n                  <div className=\"p-8 text-center text-muted-foreground\">\n                    {events.length === 0 ? \"Esperando eventos...\" : \"No hay eventos que coincidan con los filtros\"}\n                  </div>\n                ) : (\n                  filteredEvents.map((event, idx) => (\n                    <div\n                      key={event.id || `${event.timestamp}-${idx}`}\n                      className={cn(\n                        \"px-3 py-2 hover:bg-muted/30 cursor-pointer transition-colors\",\n                        selectedEvent?.id === event.id && \"bg-muted/50\"\n                      )}\n                      onClick={() => setSelectedEvent(event)}\n                      data-testid={`event-row-${event.id || idx}`}\n                    >\n                      <div className=\"flex items-start gap-2\">\n                        <span className=\"text-muted-foreground whitespace-nowrap\">\n                          {formatDate(event.timestamp)} {formatTimestamp(event.timestamp)}\n                        </span>\n                        <Badge \n                          variant=\"outline\" \n                          className={cn(\"text-[10px] px-1.5 py-0\", LEVEL_COLORS[event.level])}\n                        >\n                          {event.level}\n                        </Badge>\n                        <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0 bg-muted/50\">\n                          {event.type.replace(/_/g, \" \")}\n                        </Badge>\n                        {event.meta?.pair && (\n                          <Badge variant=\"outline\" className=\"text-[10px] px-1.5 py-0\">\n                            {event.meta.pair}\n                          </Badge>\n                        )}\n                        <span className=\"text-foreground truncate flex-1\">\n                          {event.message}\n                        </span>\n                      </div>\n                    </div>\n                  ))\n                )}\n              </div>\n            </ScrollArea>\n          </CardContent>\n        </Card>\n      </div>\n\n      <div className=\"w-full lg:w-80 xl:w-96\" data-testid=\"event-detail-panel\">\n        <Card className=\"border-border/50 sticky top-20\">\n          <CardHeader className=\"py-3 px-4\">\n            <CardTitle className=\"text-sm\">Detalle del evento</CardTitle>\n          </CardHeader>\n          <CardContent className=\"p-4 pt-0\">\n            {selectedEvent ? (\n              <div className=\"space-y-3 text-xs\" data-testid=\"event-detail-content\">\n                <div className=\"flex justify-between items-start\">\n                  <Badge className={cn(LEVEL_COLORS[selectedEvent.level])} data-testid=\"detail-level-badge\">\n                    {selectedEvent.level}\n                  </Badge>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"h-6 text-xs\"\n                    onClick={() => handleCopyEvent(selectedEvent)}\n                    data-testid=\"button-copy-event\"\n                  >\n                    <Copy className=\"h-3 w-3 mr-1\" />\n                    Copiar\n                  </Button>\n                </div>\n                \n                <div>\n                  <span className=\"text-muted-foreground\">Timestamp:</span>\n                  <p className=\"font-mono\" data-testid=\"detail-timestamp\">{new Date(selectedEvent.timestamp).toLocaleString(\"es-ES\")}</p>\n                </div>\n                \n                <div>\n                  <span className=\"text-muted-foreground\">Tipo:</span>\n                  <p className=\"font-mono\" data-testid=\"detail-type\">{selectedEvent.type}</p>\n                </div>\n                \n                <div>\n                  <span className=\"text-muted-foreground\">Mensaje:</span>\n                  <p className=\"break-words\" data-testid=\"detail-message\">{selectedEvent.message}</p>\n                </div>\n                \n                {selectedEvent.meta && (\n                  <div>\n                    <span className=\"text-muted-foreground\">Meta:</span>\n                    <pre className=\"mt-1 p-2 bg-muted/50 rounded text-[10px] overflow-x-auto max-h-60\" data-testid=\"detail-meta\">\n                      {JSON.stringify(selectedEvent.meta, null, 2)}\n                    </pre>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <p className=\"text-muted-foreground text-sm\" data-testid=\"detail-empty-message\">\n                Selecciona un evento para ver los detalles\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nfunction TerminalTab() {\n  const {\n    lines,\n    status,\n    error,\n    sources,\n    activeSource,\n    dockerEnabled,\n    lineCount,\n    lastLineTime,\n    connect,\n    startSource,\n    stopSource,\n    clearLines,\n    isConnected,\n  } = useTerminalWebSocket({ autoConnect: true });\n  \n  const [autoScroll, setAutoScroll] = useState(true);\n  const [isPaused, setIsPaused] = useState(false);\n  const scrollRef = useRef<HTMLDivElement>(null);\n  const prevLinesLengthRef = useRef(lines.length);\n\n  useEffect(() => {\n    if (autoScroll && !isPaused && lines.length > prevLinesLengthRef.current && scrollRef.current) {\n      const scrollArea = scrollRef.current.querySelector('[data-radix-scroll-area-viewport]');\n      if (scrollArea) {\n        scrollArea.scrollTop = scrollArea.scrollHeight;\n      }\n    }\n    prevLinesLengthRef.current = lines.length;\n  }, [lines.length, autoScroll, isPaused]);\n\n  const displayLines = isPaused ? lines.slice(0, prevLinesLengthRef.current) : lines;\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex flex-wrap items-center gap-2 justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Badge \n            variant=\"outline\" \n            className={cn(\n              \"gap-1\",\n              isConnected ? \"border-green-500 text-green-400\" : \n              status === \"reconnecting\" ? \"border-yellow-500 text-yellow-400\" :\n              \"border-red-500 text-red-400\"\n            )}\n            data-testid=\"terminal-ws-status\"\n          >\n            {isConnected ? <Wifi className=\"h-3 w-3\" /> : \n             status === \"reconnecting\" ? <RefreshCw className=\"h-3 w-3 animate-spin\" /> :\n             <WifiOff className=\"h-3 w-3\" />}\n            {status === \"connected\" ? \"Conectado\" : \n             status === \"reconnecting\" ? \"Reconectando...\" : \n             status === \"connecting\" ? \"Conectando...\" : \"Desconectado\"}\n          </Badge>\n          \n          {isConnected && (\n            <Select\n              value={activeSource || \"\"}\n              onValueChange={(value) => {\n                if (value) startSource(value);\n              }}\n            >\n              <SelectTrigger className=\"w-[200px] h-8\" data-testid=\"terminal-source-select\">\n                <SelectValue placeholder=\"Seleccionar fuente...\" />\n              </SelectTrigger>\n              <SelectContent>\n                {sources.length === 0 ? (\n                  <SelectItem value=\"__empty__\" disabled>\n                    {dockerEnabled ? \"Sin fuentes\" : \"Docker deshabilitado\"}\n                  </SelectItem>\n                ) : (\n                  sources.map((source) => (\n                    <SelectItem key={source.id} value={source.id} data-testid={`source-${source.id}`}>\n                      {source.name}\n                    </SelectItem>\n                  ))\n                )}\n              </SelectContent>\n            </Select>\n          )}\n          \n          {activeSource && (\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"h-8\"\n              onClick={stopSource}\n              data-testid=\"button-stop-source\"\n            >\n              Detener\n            </Button>\n          )}\n        </div>\n        \n        <div className=\"flex items-center gap-2\">\n          <div className=\"text-xs text-muted-foreground hidden sm:flex gap-3\">\n            <span>L√≠neas: {lineCount}</span>\n            {lastLineTime && (\n              <span className=\"text-cyan-400\" data-testid=\"terminal-last-line-time\">\n                √öltimo: {lastLineTime.toLocaleTimeString(\"es-ES\", { hour: \"2-digit\", minute: \"2-digit\", second: \"2-digit\" })}\n              </span>\n            )}\n          </div>\n          \n          <div className=\"flex items-center gap-1\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-8 w-8\"\n              onClick={() => {\n                setIsPaused(!isPaused);\n                if (isPaused) {\n                  prevLinesLengthRef.current = lines.length;\n                }\n              }}\n              title={isPaused ? \"Reanudar\" : \"Pausar\"}\n              data-testid=\"button-terminal-pause\"\n            >\n              {isPaused ? <Play className=\"h-4 w-4\" /> : <Pause className=\"h-4 w-4\" />}\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-8 w-8\"\n              onClick={clearLines}\n              title=\"Limpiar\"\n              data-testid=\"button-terminal-clear\"\n            >\n              <Trash2 className=\"h-4 w-4\" />\n            </Button>\n            {!isConnected && (\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className=\"h-8\"\n                onClick={connect}\n                data-testid=\"button-terminal-reconnect\"\n              >\n                Reconectar\n              </Button>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"bg-red-500/10 border border-red-500/30 text-red-400 rounded p-3 text-sm\" data-testid=\"terminal-error\">\n          {error}\n        </div>\n      )}\n\n      <Card className=\"border-border/50 bg-black/80\">\n        <CardContent className=\"p-0\">\n          <ScrollArea className=\"h-[calc(100vh-280px)]\" ref={scrollRef}>\n            <div className=\"font-mono text-xs p-3 text-green-400 whitespace-pre-wrap\">\n              {!isConnected ? (\n                <div className=\"text-muted-foreground\">\n                  {status === \"connecting\" ? \"Conectando al servidor...\" : \"Desconectado. Haz clic en 'Reconectar'.\"}\n                </div>\n              ) : !activeSource ? (\n                <div className=\"text-muted-foreground\">\n                  Selecciona una fuente de logs para comenzar...\n                  {!dockerEnabled && (\n                    <div className=\"mt-2 text-yellow-400\">\n                      Docker deshabilitado. Configura ENABLE_DOCKER_LOGS_STREAM=true en el servidor para habilitar logs de Docker.\n                    </div>\n                  )}\n                </div>\n              ) : displayLines.length === 0 ? (\n                <div className=\"text-muted-foreground\">\n                  Esperando l√≠neas de log...\n                </div>\n              ) : (\n                displayLines.map((logLine) => (\n                  <div \n                    key={logLine.id} \n                    className={cn(\n                      \"py-0.5\",\n                      logLine.isError && \"text-red-400\"\n                    )}\n                    data-testid={`log-line-${logLine.id}`}\n                  >\n                    {logLine.line}\n                  </div>\n                ))\n              )}\n            </div>\n          </ScrollArea>\n        </CardContent>\n      </Card>\n      \n      {isPaused && (\n        <div className=\"text-center text-yellow-400 text-sm\" data-testid=\"terminal-paused-indicator\">\n          Pausado - Nuevas l√≠neas no se muestran\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface DiagnosticPair {\n  pair: string;\n  signal: string;\n  razon: string;\n  cooldownSec?: number;\n  exposureAvailable: number | { maxPairAvailable: number; maxTotalAvailable: number; maxAllowed: number };\n  hasPosition: boolean;\n  positionUsd?: number;\n}\n\ninterface DiagnosticData {\n  pairs: DiagnosticPair[];\n  positionMode: string;\n  usdBalance: number;\n  totalOpenPositions: number;\n  lastScanAt: string | null;\n}\n\nfunction DiagnosticTab() {\n  const { data, isLoading, isFetching, error, refetch } = useQuery<DiagnosticData>({\n    queryKey: [\"/api/scan/diagnostic\"],\n    refetchInterval: 10000,\n    staleTime: 0,\n  });\n\n  const getSignalBadge = (signal: string) => {\n    switch (signal) {\n      case \"BUY\":\n        return (\n          <Badge className=\"bg-green-500/20 text-green-400 border-green-500/30 gap-1\">\n            <TrendingUp className=\"h-3 w-3\" />\n            COMPRA\n          </Badge>\n        );\n      case \"SELL\":\n        return (\n          <Badge className=\"bg-red-500/20 text-red-400 border-red-500/30 gap-1\">\n            <TrendingDown className=\"h-3 w-3\" />\n            VENTA\n          </Badge>\n        );\n      default:\n        return (\n          <Badge className=\"bg-muted text-muted-foreground border-muted-foreground/30 gap-1\">\n            <Minus className=\"h-3 w-3\" />\n            SIN SE√ëAL\n          </Badge>\n        );\n    }\n  };\n\n  const formatTime = (isoString: string | null) => {\n    if (!isoString) return \"Nunca\";\n    const date = new Date(isoString);\n    return date.toLocaleTimeString(\"es-ES\", { hour: \"2-digit\", minute: \"2-digit\", second: \"2-digit\" });\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\n          <CardTitle className=\"text-lg\">Diagn√≥stico de Escaneo</CardTitle>\n          <div className=\"flex items-center gap-2\">\n            {data && (\n              <span className=\"text-xs text-muted-foreground\">\n                √öltimo scan: {formatTime(data.lastScanAt)}\n              </span>\n            )}\n            <Button \n              variant=\"outline\" \n              size=\"sm\" \n              onClick={() => refetch()}\n              disabled={isFetching}\n              data-testid=\"btn-refresh-diagnostic\"\n            >\n              <RefreshCw className={cn(\"h-4 w-4\", isFetching && \"animate-spin\")} />\n              Actualizar\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {error ? (\n            <div className=\"text-red-400 text-sm\" data-testid=\"diagnostic-error\">\n              Error al cargar diagn√≥stico: {(error as Error).message}\n            </div>\n          ) : !data ? (\n            <div className=\"text-muted-foreground text-sm\">Cargando...</div>\n          ) : (\n            <>\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n                <div className=\"bg-muted/30 rounded-lg p-3\">\n                  <div className=\"text-xs text-muted-foreground\">Modo</div>\n                  <div className=\"text-lg font-semibold\" data-testid=\"diagnostic-mode\">{data.positionMode}</div>\n                </div>\n                <div className=\"bg-muted/30 rounded-lg p-3\">\n                  <div className=\"text-xs text-muted-foreground\">Balance USD</div>\n                  <div className=\"text-lg font-semibold\" data-testid=\"diagnostic-balance\">${data.usdBalance.toFixed(2)}</div>\n                </div>\n                <div className=\"bg-muted/30 rounded-lg p-3\">\n                  <div className=\"text-xs text-muted-foreground\">Posiciones Abiertas</div>\n                  <div className=\"text-lg font-semibold\" data-testid=\"diagnostic-positions\">{data.totalOpenPositions}</div>\n                </div>\n                <div className=\"bg-muted/30 rounded-lg p-3\">\n                  <div className=\"text-xs text-muted-foreground\">Pares Escaneados</div>\n                  <div className=\"text-lg font-semibold\" data-testid=\"diagnostic-pairs-count\">{data.pairs.length}</div>\n                </div>\n              </div>\n\n              {data.pairs.length === 0 ? (\n                <div className=\"text-muted-foreground text-sm text-center py-8\" data-testid=\"diagnostic-no-data\">\n                  No hay datos de escaneo. Activa el bot para comenzar a escanear pares.\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <table className=\"w-full text-sm\" data-testid=\"diagnostic-table\">\n                    <thead>\n                      <tr className=\"border-b border-muted\">\n                        <th className=\"text-left py-2 px-3 font-medium\">Par</th>\n                        <th className=\"text-left py-2 px-3 font-medium\">Se√±al</th>\n                        <th className=\"text-left py-2 px-3 font-medium\">Raz√≥n</th>\n                        <th className=\"text-right py-2 px-3 font-medium\">Cooldown</th>\n                        <th className=\"text-right py-2 px-3 font-medium\">Disponible</th>\n                        <th className=\"text-center py-2 px-3 font-medium\">Posici√≥n</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {data.pairs.map((p) => (\n                        <tr \n                          key={p.pair} \n                          className=\"border-b border-muted/50 hover:bg-muted/20\"\n                          data-testid={`diagnostic-row-${p.pair.replace(\"/\", \"-\")}`}\n                        >\n                          <td className=\"py-2 px-3 font-mono\">{p.pair}</td>\n                          <td className=\"py-2 px-3\">{getSignalBadge(p.signal)}</td>\n                          <td className=\"py-2 px-3 text-muted-foreground\">{p.razon}</td>\n                          <td className=\"py-2 px-3 text-right font-mono text-muted-foreground\">\n                            {p.cooldownSec && p.cooldownSec > 0 ? `${p.cooldownSec}s` : \"-\"}\n                          </td>\n                          <td className=\"py-2 px-3 text-right font-mono\">\n                            ${typeof p.exposureAvailable === 'object' \n                              ? (p.exposureAvailable?.maxAllowed?.toFixed(2) || \"0.00\")\n                              : (p.exposureAvailable?.toFixed(2) || \"0.00\")}\n                          </td>\n                          <td className=\"py-2 px-3 text-center\">\n                            {p.hasPosition ? (\n                              <Badge variant=\"secondary\" className=\"bg-blue-500/20 text-blue-400\">\n                                ${p.positionUsd?.toFixed(0) || \"?\"}\n                              </Badge>\n                            ) : (\n                              <span className=\"text-muted-foreground\">-</span>\n                            )}\n                          </td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              )}\n            </>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":35348,"size_tokens":null},"server/services/eventsWebSocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport type { Server } from \"http\";\nimport { db } from \"../db\";\nimport { botEvents } from \"@shared/schema\";\nimport { desc } from \"drizzle-orm\";\nimport { log } from \"../index\";\n\nconst WS_PATH = \"/ws/events\";\nconst SNAPSHOT_LIMIT = 50;\nconst HEARTBEAT_INTERVAL = 30000;\n\ninterface WsClient extends WebSocket {\n  isAlive: boolean;\n  connectedAt: Date;\n}\n\ninterface WsMessage {\n  type: \"EVENTS_SNAPSHOT\" | \"BOT_EVENT\" | \"WS_STATUS\" | \"ERROR\";\n  payload: any;\n}\n\nclass EventsWebSocketServer {\n  private wss: WebSocketServer | null = null;\n  private clients: Set<WsClient> = new Set();\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n\n  initialize(server: Server): void {\n    this.wss = new WebSocketServer({ \n      noServer: true,\n      perMessageDeflate: false,\n    });\n\n    this.wss.on(\"connection\", async (ws: WebSocket, req) => {\n      const client = ws as WsClient;\n      const url = new URL(req.url || \"\", `http://${req.headers.host}`);\n      const token = url.searchParams.get(\"token\");\n      const expectedToken = process.env.WS_ADMIN_TOKEN;\n\n      if (!expectedToken) {\n        log(`[WS] WS_ADMIN_TOKEN no configurado - conexi√≥n sin autenticaci√≥n permitida (desarrollo)`, \"websocket\");\n      } else if (token !== expectedToken) {\n        log(`[WS] Conexi√≥n rechazada - token inv√°lido desde ${req.socket.remoteAddress}`, \"websocket\");\n        this.sendMessage(client, { type: \"ERROR\", payload: { message: \"Token inv√°lido\" } });\n        client.close(4001, \"Unauthorized\");\n        return;\n      }\n\n      client.isAlive = true;\n      client.connectedAt = new Date();\n      this.clients.add(client);\n\n      log(`[WS] Cliente conectado. Total: ${this.clients.size}`, \"websocket\");\n\n      setTimeout(async () => {\n        if (client.readyState !== WebSocket.OPEN) {\n          log(`[WS] Cliente cerrado antes de enviar datos iniciales`, \"websocket\");\n          return;\n        }\n        \n        this.sendMessage(client, {\n          type: \"WS_STATUS\",\n          payload: {\n            connectedAt: client.connectedAt.toISOString(),\n            serverTime: new Date().toISOString(),\n            clientsConnected: this.clients.size,\n          },\n        });\n        \n        try {\n          const snapshot = await this.getEventsSnapshot();\n          if (client.readyState === WebSocket.OPEN) {\n            this.sendMessage(client, {\n              type: \"EVENTS_SNAPSHOT\",\n              payload: snapshot,\n            });\n          }\n        } catch (error) {\n          log(`[WS] Error enviando snapshot: ${error}`, \"websocket\");\n        }\n      }, 500);\n\n      client.on(\"pong\", () => {\n        client.isAlive = true;\n      });\n\n      client.on(\"close\", () => {\n        this.clients.delete(client);\n        log(`[WS] Cliente desconectado. Total: ${this.clients.size}`, \"websocket\");\n      });\n\n      client.on(\"error\", (error) => {\n        log(`[WS] Error en cliente: ${error.message}`, \"websocket\");\n        this.clients.delete(client);\n      });\n    });\n\n    this.startHeartbeat();\n    log(`[WS] Servidor WebSocket inicializado en ${WS_PATH}`, \"websocket\");\n  }\n\n  private startHeartbeat(): void {\n    this.heartbeatInterval = setInterval(() => {\n      this.clients.forEach((client) => {\n        if (!client.isAlive) {\n          log(`[WS] Cliente muerto detectado, cerrando conexi√≥n`, \"websocket\");\n          client.terminate();\n          this.clients.delete(client);\n          return;\n        }\n        client.isAlive = false;\n        client.ping();\n      });\n    }, HEARTBEAT_INTERVAL);\n  }\n\n  private sendMessage(client: WsClient, message: WsMessage): void {\n    if (client.readyState === WebSocket.OPEN) {\n      try {\n        client.send(JSON.stringify(message));\n      } catch (error) {\n        log(`[WS] Error enviando mensaje: ${error}`, \"websocket\");\n      }\n    }\n  }\n\n  private async getEventsSnapshot(): Promise<any[]> {\n    try {\n      const events = await db.select()\n        .from(botEvents)\n        .orderBy(desc(botEvents.timestamp))\n        .limit(SNAPSHOT_LIMIT);\n\n      return events.map(e => ({\n        id: e.id,\n        timestamp: e.timestamp,\n        level: e.level,\n        type: e.type,\n        message: e.message,\n        meta: e.meta ? JSON.parse(e.meta) : null,\n      }));\n    } catch (error) {\n      log(`[WS] Error obteniendo snapshot: ${error}`, \"websocket\");\n      return [];\n    }\n  }\n\n  broadcast(event: {\n    id?: number;\n    timestamp: string;\n    level: string;\n    type: string;\n    message: string;\n    meta?: any;\n    env?: string;\n    instanceId?: string;\n  }): void {\n    const message: WsMessage = {\n      type: \"BOT_EVENT\",\n      payload: event,\n    };\n\n    const messageStr = JSON.stringify(message);\n    let sentCount = 0;\n\n    this.clients.forEach((client) => {\n      if (client.readyState === WebSocket.OPEN) {\n        try {\n          client.send(messageStr);\n          sentCount++;\n        } catch (error) {\n          log(`[WS] Error en broadcast: ${error}`, \"websocket\");\n        }\n      }\n    });\n  }\n\n  getClientCount(): number {\n    return this.clients.size;\n  }\n\n  handleUpgrade(req: any, socket: any, head: any): void {\n    if (!this.wss) return;\n    this.wss.handleUpgrade(req, socket, head, (ws) => {\n      this.wss!.emit(\"connection\", ws, req);\n    });\n  }\n\n  shutdown(): void {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n    this.clients.forEach((client) => {\n      client.close(1001, \"Server shutting down\");\n    });\n    this.wss?.close();\n  }\n}\n\nexport const eventsWs = new EventsWebSocketServer();\n","path":null,"size_bytes":5564,"size_tokens":null},"client/src/hooks/useEventsWebSocket.ts":{"content":"import { useState, useEffect, useCallback, useRef, useSyncExternalStore } from \"react\";\n\nexport interface BotEvent {\n  id?: number;\n  timestamp: string;\n  level: \"INFO\" | \"WARN\" | \"ERROR\";\n  type: string;\n  message: string;\n  meta?: Record<string, any> | null;\n}\n\ntype WsStatus = \"connecting\" | \"connected\" | \"disconnected\" | \"reconnecting\";\n\ninterface WsState {\n  events: BotEvent[];\n  status: WsStatus;\n  error: string | null;\n}\n\ntype Listener = () => void;\n\ndeclare global {\n  interface Window {\n    __eventsWsSingleton?: EventsWebSocketSingleton;\n  }\n}\n\nclass EventsWebSocketSingleton {\n  private ws: WebSocket | null = null;\n  private state: WsState = { events: [], status: \"disconnected\", error: null };\n  private listeners: Set<Listener> = new Set();\n  private reconnectTimeout: NodeJS.Timeout | null = null;\n  private reconnectAttempts = 0;\n  private flushInterval: NodeJS.Timeout | null = null;\n  private eventBuffer: BotEvent[] = [];\n  private maxEvents = 500;\n  private refCount = 0;\n  private lastConnectTime = 0;\n  private connectLock = false;\n\n  static getInstance(): EventsWebSocketSingleton {\n    if (!window.__eventsWsSingleton) {\n      window.__eventsWsSingleton = new EventsWebSocketSingleton();\n    }\n    return window.__eventsWsSingleton;\n  }\n\n  subscribe(listener: Listener): () => void {\n    this.listeners.add(listener);\n    this.refCount++;\n    \n    if (this.refCount === 1 && this.state.status === \"disconnected\") {\n      this.connect();\n    }\n    \n    return () => {\n      this.listeners.delete(listener);\n      this.refCount--;\n    };\n  }\n\n  getSnapshot(): WsState {\n    return this.state;\n  }\n\n  private notify(): void {\n    this.listeners.forEach(listener => listener());\n  }\n\n  private setState(partial: Partial<WsState>): void {\n    this.state = { ...this.state, ...partial };\n    this.notify();\n  }\n\n  private getWsUrl(): string {\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const token = localStorage.getItem(\"WS_ADMIN_TOKEN\") || \"\";\n    return `${protocol}//${window.location.host}/ws/events${token ? `?token=${token}` : \"\"}`;\n  }\n\n  private flushBuffer = (): void => {\n    if (this.eventBuffer.length > 0) {\n      const newEvents = [...this.eventBuffer, ...this.state.events].slice(0, this.maxEvents);\n      this.eventBuffer = [];\n      this.setState({ events: newEvents });\n    }\n  };\n\n  connect(): void {\n    if (this.connectLock) return;\n    \n    if (this.ws?.readyState === WebSocket.OPEN || \n        this.ws?.readyState === WebSocket.CONNECTING) return;\n\n    const now = Date.now();\n    if (now - this.lastConnectTime < 2000) {\n      if (!this.reconnectTimeout) {\n        this.reconnectTimeout = setTimeout(() => {\n          this.reconnectTimeout = null;\n          this.connect();\n        }, 2000 - (now - this.lastConnectTime));\n      }\n      return;\n    }\n\n    this.connectLock = true;\n    this.lastConnectTime = now;\n    this.setState({ status: \"connecting\", error: null });\n\n    try {\n      const ws = new WebSocket(this.getWsUrl());\n      this.ws = ws;\n\n      ws.onopen = () => {\n        this.connectLock = false;\n        this.setState({ status: \"connected\", error: null });\n        this.reconnectAttempts = 0;\n\n        if (this.flushInterval) clearInterval(this.flushInterval);\n        this.flushInterval = setInterval(this.flushBuffer, 300);\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          \n          if (data.type === \"EVENTS_SNAPSHOT\") {\n            this.setState({ events: data.payload || [] });\n          } else if (data.type === \"BOT_EVENT\") {\n            this.eventBuffer.unshift(data.payload);\n          } else if (data.type === \"ERROR\") {\n            this.setState({ error: data.payload?.message || \"Error desconocido\" });\n          }\n        } catch (e) {\n          console.error(\"[WS] Error parseando mensaje:\", e);\n        }\n      };\n\n      ws.onclose = (event) => {\n        this.ws = null;\n        this.connectLock = false;\n        \n        if (this.flushInterval) {\n          clearInterval(this.flushInterval);\n          this.flushInterval = null;\n        }\n\n        if (event.code !== 4001 && event.code !== 1000 && this.refCount > 0) {\n          const delay = Math.max(2000, Math.min(2000 * Math.pow(2, this.reconnectAttempts), 30000));\n          this.reconnectAttempts++;\n          this.setState({ status: \"reconnecting\" });\n          \n          this.reconnectTimeout = setTimeout(() => {\n            if (this.refCount > 0) this.connect();\n          }, delay);\n        } else {\n          this.setState({ status: \"disconnected\" });\n        }\n      };\n\n      ws.onerror = () => {\n        this.setState({ error: \"Error de conexi√≥n WebSocket\" });\n      };\n    } catch (e) {\n      this.connectLock = false;\n      this.setState({ error: \"No se pudo establecer conexi√≥n WebSocket\", status: \"disconnected\" });\n    }\n  }\n\n  disconnect(): void {\n    if (this.reconnectTimeout) {\n      clearTimeout(this.reconnectTimeout);\n      this.reconnectTimeout = null;\n    }\n    if (this.flushInterval) {\n      clearInterval(this.flushInterval);\n      this.flushInterval = null;\n    }\n    if (this.ws) {\n      this.ws.close(1000, \"User disconnect\");\n      this.ws = null;\n    }\n    this.setState({ status: \"disconnected\" });\n  }\n\n  clearEvents(): void {\n    this.eventBuffer = [];\n    this.setState({ events: [] });\n  }\n}\n\ninterface UseEventsWebSocketOptions {\n  maxEvents?: number;\n  autoConnect?: boolean;\n}\n\nexport function useEventsWebSocket(_options: UseEventsWebSocketOptions = {}) {\n  const singleton = EventsWebSocketSingleton.getInstance();\n  \n  const state = useSyncExternalStore(\n    (listener) => singleton.subscribe(listener),\n    () => singleton.getSnapshot()\n  );\n\n  const connect = useCallback(() => singleton.connect(), [singleton]);\n  const disconnect = useCallback(() => singleton.disconnect(), [singleton]);\n  const clearEvents = useCallback(() => singleton.clearEvents(), [singleton]);\n\n  return {\n    events: state.events,\n    status: state.status,\n    error: state.error,\n    connect,\n    disconnect,\n    clearEvents,\n    isConnected: state.status === \"connected\",\n  };\n}\n","path":null,"size_bytes":6144,"size_tokens":null},"client/src/hooks/useTerminalWebSocket.ts":{"content":"import { useState, useEffect, useCallback, useRef } from \"react\";\n\nexport interface LogLine {\n  id: number;\n  timestamp: Date;\n  line: string;\n  sourceId: string;\n  isError?: boolean;\n}\n\nexport interface LogSource {\n  id: string;\n  name: string;\n  type: \"docker_compose\" | \"docker_container\" | \"file\";\n}\n\ntype WsStatus = \"connecting\" | \"connected\" | \"disconnected\" | \"reconnecting\";\n\ninterface UseTerminalWebSocketOptions {\n  maxLines?: number;\n  autoConnect?: boolean;\n}\n\nexport function useTerminalWebSocket(options: UseTerminalWebSocketOptions = {}) {\n  const { maxLines = 500, autoConnect = true } = options;\n  \n  const [lines, setLines] = useState<LogLine[]>([]);\n  const [status, setStatus] = useState<WsStatus>(\"disconnected\");\n  const [error, setError] = useState<string | null>(null);\n  const [sources, setSources] = useState<LogSource[]>([]);\n  const [activeSource, setActiveSource] = useState<string | null>(null);\n  const [dockerEnabled, setDockerEnabled] = useState(false);\n  const [lineCount, setLineCount] = useState(0);\n  const [lastLineTime, setLastLineTime] = useState<Date | null>(null);\n  \n  const wsRef = useRef<WebSocket | null>(null);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const reconnectAttemptsRef = useRef(0);\n  const lineIdRef = useRef(0);\n\n  const getWsUrl = useCallback(() => {\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const token = localStorage.getItem(\"TERMINAL_TOKEN\") || \"\";\n    return `${protocol}//${window.location.host}/ws/logs${token ? `?token=${token}` : \"\"}`;\n  }, []);\n\n  const connect = useCallback(() => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) return;\n\n    setStatus(\"connecting\");\n    setError(null);\n\n    try {\n      const ws = new WebSocket(getWsUrl());\n      wsRef.current = ws;\n\n      ws.onopen = () => {\n        setStatus(\"connected\");\n        setError(null);\n        reconnectAttemptsRef.current = 0;\n      };\n\n      ws.onmessage = (event) => {\n        try {\n          const data = JSON.parse(event.data);\n          \n          switch (data.type) {\n            case \"WS_STATUS\":\n              setSources(data.payload.availableSources || []);\n              setDockerEnabled(data.payload.dockerEnabled);\n              break;\n            case \"LOG_LINE\":\n              lineIdRef.current++;\n              const newLine: LogLine = {\n                id: lineIdRef.current,\n                timestamp: new Date(),\n                line: data.payload.line,\n                sourceId: data.payload.sourceId,\n                isError: data.payload.isError,\n              };\n              setLines((prev) => [...prev, newLine].slice(-maxLines));\n              setLineCount((c) => c + 1);\n              setLastLineTime(new Date());\n              break;\n            case \"SOURCE_CHANGED\":\n              setActiveSource(data.payload.sourceId);\n              setLines([]);\n              setLineCount(0);\n              break;\n            case \"SOURCE_STOPPED\":\n              setActiveSource(null);\n              break;\n            case \"ERROR\":\n              setError(data.payload?.message || \"Error desconocido\");\n              break;\n          }\n        } catch (e) {\n          console.error(\"[WS-LOGS] Error parseando mensaje:\", e);\n        }\n      };\n\n      ws.onclose = (event) => {\n        setStatus(\"disconnected\");\n        wsRef.current = null;\n        setActiveSource(null);\n\n        if (event.code !== 4001 && event.code !== 1000) {\n          const delay = Math.min(1000 * Math.pow(2, reconnectAttemptsRef.current), 10000);\n          reconnectAttemptsRef.current++;\n          setStatus(\"reconnecting\");\n          \n          reconnectTimeoutRef.current = setTimeout(() => {\n            connect();\n          }, delay);\n        }\n      };\n\n      ws.onerror = () => {\n        setError(\"Error de conexi√≥n WebSocket\");\n      };\n    } catch (e) {\n      setError(\"No se pudo establecer conexi√≥n WebSocket\");\n      setStatus(\"disconnected\");\n    }\n  }, [getWsUrl, maxLines]);\n\n  const disconnect = useCallback(() => {\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n      reconnectTimeoutRef.current = null;\n    }\n    if (wsRef.current) {\n      wsRef.current.close(1000, \"User disconnect\");\n      wsRef.current = null;\n    }\n    setStatus(\"disconnected\");\n    setActiveSource(null);\n  }, []);\n\n  const startSource = useCallback((sourceId: string) => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: \"START_SOURCE\", sourceId }));\n    }\n  }, []);\n\n  const stopSource = useCallback(() => {\n    if (wsRef.current?.readyState === WebSocket.OPEN) {\n      wsRef.current.send(JSON.stringify({ type: \"STOP_SOURCE\" }));\n    }\n  }, []);\n\n  const clearLines = useCallback(() => {\n    setLines([]);\n    setLineCount(0);\n  }, []);\n\n  useEffect(() => {\n    if (autoConnect) {\n      connect();\n    }\n    return () => {\n      disconnect();\n    };\n  }, [autoConnect, connect, disconnect]);\n\n  return {\n    lines,\n    status,\n    error,\n    sources,\n    activeSource,\n    dockerEnabled,\n    lineCount,\n    lastLineTime,\n    connect,\n    disconnect,\n    startSource,\n    stopSource,\n    clearLines,\n    isConnected: status === \"connected\",\n  };\n}\n","path":null,"size_bytes":5243,"size_tokens":null},"server/services/terminalWebSocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport type { Server } from \"http\";\nimport { spawn, ChildProcess } from \"child_process\";\nimport { log } from \"../index\";\n\nconst WS_PATH = \"/ws/logs\";\nconst MAX_LOG_HISTORY = 200;\nconst HEARTBEAT_INTERVAL = 30000;\n\ninterface WsClient extends WebSocket {\n  isAlive: boolean;\n  connectedAt: Date;\n  activeSource: string | null;\n  activeProcess: ChildProcess | null;\n}\n\ninterface WsMessage {\n  type: \"LOG_LINE\" | \"LOG_HISTORY\" | \"WS_STATUS\" | \"ERROR\" | \"SOURCE_CHANGED\" | \"SOURCE_STOPPED\";\n  payload: any;\n}\n\ninterface LogSource {\n  id: string;\n  name: string;\n  type: \"docker_compose\" | \"docker_container\" | \"file\";\n  command?: string[];\n  containerName?: string;\n  filePath?: string;\n}\n\nconst PREDEFINED_SOURCES: LogSource[] = [\n  {\n    id: \"docker_compose\",\n    name: \"Docker Compose (todos)\",\n    type: \"docker_compose\",\n    command: [\"docker\", \"compose\", \"logs\", \"-f\", \"--tail=200\"],\n  },\n  {\n    id: \"krakenbot_container\",\n    name: \"KrakenBot Container\",\n    type: \"docker_container\",\n    containerName: \"kraken-bot-app\",\n  },\n  {\n    id: \"postgres_container\",\n    name: \"PostgreSQL Container\",\n    type: \"docker_container\",\n    containerName: \"kraken-bot-db\",\n  },\n  {\n    id: \"app_log\",\n    name: \"App Log File\",\n    type: \"file\",\n    filePath: \"/var/log/krakenbot/app.log\",\n  },\n];\n\nclass TerminalWebSocketServer {\n  private wss: WebSocketServer | null = null;\n  private clients: Set<WsClient> = new Set();\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n  private dockerEnabled: boolean = false;\n\n  initialize(server: Server): void {\n    this.dockerEnabled = process.env.ENABLE_DOCKER_LOGS_STREAM === \"true\";\n\n    this.wss = new WebSocketServer({ \n      noServer: true,\n      perMessageDeflate: false,\n    });\n\n    this.wss.on(\"connection\", async (ws: WebSocket, req) => {\n      const client = ws as WsClient;\n      const url = new URL(req.url || \"\", `http://${req.headers.host}`);\n      const token = url.searchParams.get(\"token\");\n      const expectedToken = process.env.TERMINAL_TOKEN;\n\n      if (!expectedToken) {\n        log(`[WS-LOGS] TERMINAL_TOKEN no configurado - conexi√≥n rechazada`, \"websocket\");\n        this.sendMessage(client, { type: \"ERROR\", payload: { message: \"TERMINAL_TOKEN no configurado\" } });\n        client.close(4001, \"Unauthorized\");\n        return;\n      }\n\n      if (token !== expectedToken) {\n        log(`[WS-LOGS] Conexi√≥n rechazada - token inv√°lido desde ${req.socket.remoteAddress}`, \"websocket\");\n        this.sendMessage(client, { type: \"ERROR\", payload: { message: \"Token inv√°lido\" } });\n        client.close(4001, \"Unauthorized\");\n        return;\n      }\n\n      client.isAlive = true;\n      client.connectedAt = new Date();\n      client.activeSource = null;\n      client.activeProcess = null;\n      this.clients.add(client);\n\n      log(`[WS-LOGS] Cliente conectado. Total: ${this.clients.size}`, \"websocket\");\n\n      const availableSources = this.getAvailableSources();\n      this.sendMessage(client, {\n        type: \"WS_STATUS\",\n        payload: {\n          connectedAt: client.connectedAt.toISOString(),\n          serverTime: new Date().toISOString(),\n          dockerEnabled: this.dockerEnabled,\n          availableSources: availableSources.map(s => ({ id: s.id, name: s.name, type: s.type })),\n        },\n      });\n\n      client.on(\"message\", (data) => {\n        try {\n          const message = JSON.parse(data.toString());\n          this.handleClientMessage(client, message);\n        } catch (e) {\n          log(`[WS-LOGS] Error parseando mensaje: ${e}`, \"websocket\");\n        }\n      });\n\n      client.on(\"pong\", () => {\n        client.isAlive = true;\n      });\n\n      client.on(\"close\", () => {\n        this.stopClientProcess(client);\n        this.clients.delete(client);\n        log(`[WS-LOGS] Cliente desconectado. Total: ${this.clients.size}`, \"websocket\");\n      });\n\n      client.on(\"error\", (error) => {\n        log(`[WS-LOGS] Error en cliente: ${error.message}`, \"websocket\");\n        this.stopClientProcess(client);\n        this.clients.delete(client);\n      });\n    });\n\n    this.startHeartbeat();\n    log(`[WS-LOGS] Terminal WebSocket inicializado en ${WS_PATH} (docker: ${this.dockerEnabled})`, \"websocket\");\n  }\n\n  private getAvailableSources(): LogSource[] {\n    return PREDEFINED_SOURCES.filter(source => {\n      if (source.type === \"docker_compose\" || source.type === \"docker_container\") {\n        return this.dockerEnabled;\n      }\n      return true;\n    });\n  }\n\n  private handleClientMessage(client: WsClient, message: any): void {\n    switch (message.type) {\n      case \"START_SOURCE\":\n        this.startLogSource(client, message.sourceId);\n        break;\n      case \"STOP_SOURCE\":\n        this.stopClientProcess(client);\n        this.sendMessage(client, { type: \"SOURCE_STOPPED\", payload: { sourceId: client.activeSource } });\n        client.activeSource = null;\n        break;\n      default:\n        log(`[WS-LOGS] Mensaje desconocido: ${message.type}`, \"websocket\");\n    }\n  }\n\n  private startLogSource(client: WsClient, sourceId: string): void {\n    const source = this.getAvailableSources().find(s => s.id === sourceId);\n    \n    if (!source) {\n      this.sendMessage(client, { \n        type: \"ERROR\", \n        payload: { message: `Fuente no disponible: ${sourceId}` } \n      });\n      return;\n    }\n\n    this.stopClientProcess(client);\n\n    let command: string[];\n    \n    switch (source.type) {\n      case \"docker_compose\":\n        command = source.command || [\"docker\", \"compose\", \"logs\", \"-f\", \"--tail=200\"];\n        break;\n      case \"docker_container\":\n        command = [\"docker\", \"logs\", \"-f\", \"--tail=200\", source.containerName || \"\"];\n        break;\n      case \"file\":\n        command = [\"tail\", \"-f\", \"-n\", \"200\", source.filePath || \"\"];\n        break;\n      default:\n        this.sendMessage(client, { type: \"ERROR\", payload: { message: \"Tipo de fuente no soportado\" } });\n        return;\n    }\n\n    try {\n      const proc = spawn(command[0], command.slice(1), {\n        stdio: [\"ignore\", \"pipe\", \"pipe\"],\n      });\n\n      client.activeProcess = proc;\n      client.activeSource = sourceId;\n\n      log(`[WS-LOGS] Iniciando fuente ${sourceId}: ${command.join(\" \")}`, \"websocket\");\n\n      this.sendMessage(client, { \n        type: \"SOURCE_CHANGED\", \n        payload: { sourceId, sourceName: source.name } \n      });\n\n      proc.stdout?.on(\"data\", (data) => {\n        const lines = data.toString().split(\"\\n\").filter((l: string) => l.trim());\n        lines.forEach((line: string) => {\n          this.sendMessage(client, { type: \"LOG_LINE\", payload: { line, sourceId } });\n        });\n      });\n\n      proc.stderr?.on(\"data\", (data) => {\n        const lines = data.toString().split(\"\\n\").filter((l: string) => l.trim());\n        lines.forEach((line: string) => {\n          this.sendMessage(client, { type: \"LOG_LINE\", payload: { line, sourceId, isError: true } });\n        });\n      });\n\n      proc.on(\"close\", (code) => {\n        log(`[WS-LOGS] Proceso terminado (${sourceId}): c√≥digo ${code}`, \"websocket\");\n        if (client.activeSource === sourceId) {\n          this.sendMessage(client, { \n            type: \"SOURCE_STOPPED\", \n            payload: { sourceId, exitCode: code } \n          });\n          client.activeSource = null;\n          client.activeProcess = null;\n        }\n      });\n\n      proc.on(\"error\", (err) => {\n        log(`[WS-LOGS] Error en proceso (${sourceId}): ${err.message}`, \"websocket\");\n        this.sendMessage(client, { \n          type: \"ERROR\", \n          payload: { message: `Error al iniciar fuente: ${err.message}` } \n        });\n        client.activeSource = null;\n        client.activeProcess = null;\n      });\n\n    } catch (error: any) {\n      log(`[WS-LOGS] Error spawning proceso: ${error.message}`, \"websocket\");\n      this.sendMessage(client, { \n        type: \"ERROR\", \n        payload: { message: `Error al ejecutar comando: ${error.message}` } \n      });\n    }\n  }\n\n  private stopClientProcess(client: WsClient): void {\n    if (client.activeProcess) {\n      try {\n        client.activeProcess.kill(\"SIGTERM\");\n      } catch (e) {\n        // Process may already be dead\n      }\n      client.activeProcess = null;\n    }\n  }\n\n  private startHeartbeat(): void {\n    this.heartbeatInterval = setInterval(() => {\n      this.clients.forEach((client) => {\n        if (!client.isAlive) {\n          log(`[WS-LOGS] Cliente muerto detectado, cerrando conexi√≥n`, \"websocket\");\n          this.stopClientProcess(client);\n          client.terminate();\n          this.clients.delete(client);\n          return;\n        }\n        client.isAlive = false;\n        client.ping();\n      });\n    }, HEARTBEAT_INTERVAL);\n  }\n\n  private sendMessage(client: WsClient, message: WsMessage): void {\n    if (client.readyState === WebSocket.OPEN) {\n      try {\n        client.send(JSON.stringify(message));\n      } catch (error) {\n        log(`[WS-LOGS] Error enviando mensaje: ${error}`, \"websocket\");\n      }\n    }\n  }\n\n  getClientCount(): number {\n    return this.clients.size;\n  }\n\n  handleUpgrade(req: any, socket: any, head: any): void {\n    if (!this.wss) return;\n    this.wss.handleUpgrade(req, socket, head, (ws) => {\n      this.wss!.emit(\"connection\", ws, req);\n    });\n  }\n\n  shutdown(): void {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n    }\n    this.clients.forEach((client) => {\n      this.stopClientProcess(client);\n      client.close(1001, \"Server shutting down\");\n    });\n    if (this.wss) {\n      this.wss.close();\n    }\n  }\n}\n\nexport const terminalWsServer = new TerminalWebSocketServer();\n","path":null,"size_bytes":9606,"size_tokens":null},"client/src/context/EventsWebSocketContext.tsx":{"content":"import { ReactNode } from \"react\";\nimport { useEventsWebSocket } from \"@/hooks/useEventsWebSocket\";\n\ninterface EventsWebSocketProviderProps {\n  children: ReactNode;\n}\n\nexport function EventsWebSocketProvider({ children }: EventsWebSocketProviderProps) {\n  return <>{children}</>;\n}\n\nexport function useEventsFeed() {\n  return useEventsWebSocket();\n}\n","path":null,"size_bytes":350,"size_tokens":null},"server/services/environment.ts":{"content":"import { randomUUID } from \"crypto\";\nimport { hostname } from \"os\";\n\ntype EnvTag = \"REPLIT/DEV\" | \"NAS/PROD\";\n\nclass EnvironmentService {\n  private _envTag: EnvTag;\n  private _instanceId: string;\n  private _isReplit: boolean;\n\n  constructor() {\n    this._isReplit = !!(process.env.REPLIT_DEPLOYMENT || process.env.REPL_ID);\n    this._envTag = this._isReplit ? \"REPLIT/DEV\" : \"NAS/PROD\";\n    this._instanceId = `${hostname()}-${process.pid}-${randomUUID().slice(0, 8)}`;\n  }\n\n  get envTag(): EnvTag {\n    return this._envTag;\n  }\n\n  get instanceId(): string {\n    return this._instanceId;\n  }\n\n  get isReplit(): boolean {\n    return this._isReplit;\n  }\n\n  get isNAS(): boolean {\n    return !this._isReplit;\n  }\n\n  getMessagePrefix(dryRun: boolean): string {\n    if (this._isReplit || dryRun) {\n      return `[${this._envTag}][DRY_RUN] `;\n    }\n    return `[${this._envTag}] `;\n  }\n\n  getInfo(): { env: EnvTag; instanceId: string; isReplit: boolean; isNAS: boolean } {\n    return {\n      env: this._envTag,\n      instanceId: this._instanceId,\n      isReplit: this._isReplit,\n      isNAS: !this._isReplit,\n    };\n  }\n}\n\nexport const environment = new EnvironmentService();\n","path":null,"size_bytes":1170,"size_tokens":null},"client/src/components/dashboard/EnvironmentBadge.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Server, TestTube, AlertTriangle } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface EnvironmentData {\n  env: \"REPLIT/DEV\" | \"NAS/PROD\";\n  instanceId: string;\n  isReplit: boolean;\n  isNAS: boolean;\n  dryRun: boolean;\n  gitCommit?: string;\n}\n\nexport function EnvironmentBadge({ compact = false }: { compact?: boolean }) {\n  const { data, isLoading } = useQuery<EnvironmentData>({\n    queryKey: [\"environment\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/environment\");\n      if (!res.ok) throw new Error(\"Failed to fetch environment\");\n      return res.json();\n    },\n    staleTime: 60000,\n  });\n\n  if (isLoading || !data) return null;\n\n  const isProduction = data.env === \"NAS/PROD\";\n  const showDryRunWarning = data.dryRun;\n\n  if (compact) {\n    return (\n      <div className=\"flex items-center gap-2\" data-testid=\"environment-badge-compact\">\n        <Badge \n          variant=\"outline\"\n          className={cn(\n            \"font-mono text-xs\",\n            isProduction \n              ? \"bg-green-500/10 text-green-500 border-green-500/30\" \n              : \"bg-yellow-500/10 text-yellow-500 border-yellow-500/30\"\n          )}\n        >\n          {isProduction ? <Server className=\"w-3 h-3 mr-1\" /> : <TestTube className=\"w-3 h-3 mr-1\" />}\n          {data.env}\n        </Badge>\n        {showDryRunWarning && (\n          <Badge \n            variant=\"outline\"\n            className=\"font-mono text-xs bg-orange-500/10 text-orange-500 border-orange-500/30\"\n          >\n            <AlertTriangle className=\"w-3 h-3 mr-1\" />\n            DRY_RUN\n          </Badge>\n        )}\n      </div>\n    );\n  }\n\n  return (\n    <div \n      className={cn(\n        \"p-3 rounded-lg border flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4\",\n        isProduction \n          ? \"bg-green-500/5 border-green-500/20\" \n          : \"bg-yellow-500/5 border-yellow-500/20\"\n      )}\n      data-testid=\"environment-badge\"\n    >\n      <div className=\"flex items-center gap-2\">\n        {isProduction ? (\n          <Server className={cn(\"w-5 h-5\", isProduction ? \"text-green-500\" : \"text-yellow-500\")} />\n        ) : (\n          <TestTube className=\"w-5 h-5 text-yellow-500\" />\n        )}\n        <div>\n          <div className=\"flex items-center gap-2\">\n            <span className={cn(\n              \"font-mono font-bold text-sm\",\n              isProduction ? \"text-green-500\" : \"text-yellow-500\"\n            )}>\n              {data.env}\n            </span>\n            {showDryRunWarning && (\n              <Badge \n                variant=\"outline\"\n                className=\"font-mono text-xs bg-orange-500/10 text-orange-500 border-orange-500/30\"\n              >\n                DRY_RUN\n              </Badge>\n            )}\n          </div>\n          <p className=\"text-xs text-muted-foreground font-mono\">\n            ID: {data.instanceId} {data.gitCommit && <span className=\"opacity-60\">¬∑ v{data.gitCommit}</span>}\n          </p>\n        </div>\n      </div>\n      \n      {data.isReplit && (\n        <p className=\"text-xs text-muted-foreground\">\n          Entorno de desarrollo - No se env√≠an √≥rdenes reales\n        </p>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":3284,"size_tokens":null},"script/migrate.ts":{"content":"#!/usr/bin/env npx tsx\n/**\n * Non-interactive database migration script for Docker/NAS deployment.\n * This script runs before the app starts to ensure schema is up-to-date.\n * \n * Usage: npx tsx script/migrate.ts\n * \n * Features:\n * - No interactive prompts (unlike drizzle-kit push)\n * - Safe ADD COLUMN IF NOT EXISTS\n * - Backfills lot_id for existing positions\n * - Adds unique constraint only if safe\n */\n\nimport { drizzle } from \"drizzle-orm/node-postgres\";\nimport { sql } from \"drizzle-orm\";\nimport pg from \"pg\";\n\nconst { Pool } = pg;\n\nasync function runMigration() {\n  console.log(\"[migrate] Starting non-interactive database migration...\");\n  \n  const databaseUrl = process.env.DATABASE_URL;\n  if (!databaseUrl) {\n    console.error(\"[migrate] ERROR: DATABASE_URL not set\");\n    process.exit(1);\n  }\n  \n  const pool = new Pool({ connectionString: databaseUrl });\n  const db = drizzle(pool);\n  \n  try {\n    // bot_config columns\n    const botConfigMigrations = [\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_max_open_lots_per_pair INTEGER DEFAULT 1',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_pair_overrides JSONB',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS dry_run_mode BOOLEAN DEFAULT false',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_entry_usd DECIMAL(10,2) DEFAULT 100.00',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_allow_under_min BOOLEAN DEFAULT true',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_be_at_pct DECIMAL(5,2) DEFAULT 1.50',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_start_pct DECIMAL(5,2) DEFAULT 2.00',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_distance_pct DECIMAL(5,2) DEFAULT 1.50',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_trail_step_pct DECIMAL(5,2) DEFAULT 0.25',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_enabled BOOLEAN DEFAULT false',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_tp_fixed_pct DECIMAL(5,2) DEFAULT 10.00',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_enabled BOOLEAN DEFAULT false',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_pct DECIMAL(5,2) DEFAULT 35.00',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_min_part_usd DECIMAL(10,2) DEFAULT 50.00',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_scale_out_threshold DECIMAL(5,2) DEFAULT 80.00',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_pct DECIMAL(5,2) DEFAULT 0.45',\n      'ALTER TABLE bot_config ADD COLUMN IF NOT EXISTS sg_fee_cushion_auto BOOLEAN DEFAULT true',\n    ];\n    \n    // open_positions columns\n    const openPositionsMigrations = [\n      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS lot_id TEXT',\n      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_break_even_activated BOOLEAN DEFAULT false',\n      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_trailing_activated BOOLEAN DEFAULT false',\n      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_current_stop_price DECIMAL(18,8)',\n      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS sg_scale_out_done BOOLEAN DEFAULT false',\n      'ALTER TABLE open_positions ADD COLUMN IF NOT EXISTS config_snapshot_json JSONB',\n    ];\n    \n    console.log(\"[migrate] Applying bot_config migrations...\");\n    for (const migration of botConfigMigrations) {\n      try {\n        await db.execute(sql.raw(migration));\n      } catch (e) {\n        // Ignore errors (column may already exist)\n      }\n    }\n    \n    console.log(\"[migrate] Applying open_positions migrations...\");\n    for (const migration of openPositionsMigrations) {\n      try {\n        await db.execute(sql.raw(migration));\n      } catch (e) {\n        // Ignore errors\n      }\n    }\n    \n    // Backfill lot_id for existing positions\n    console.log(\"[migrate] Backfilling lot_id for existing positions...\");\n    try {\n      await db.execute(sql`\n        UPDATE open_positions \n        SET lot_id = 'LEGACY-' || id::text || '-' || SUBSTRING(MD5(pair || opened_at::text) FROM 1 FOR 6)\n        WHERE lot_id IS NULL\n      `);\n    } catch (e) {\n      console.log(\"[migrate] lot_id backfill note:\", e);\n    }\n    \n    // Add unique constraint if safe\n    console.log(\"[migrate] Checking lot_id uniqueness...\");\n    try {\n      const duplicates = await db.execute(sql`\n        SELECT lot_id, COUNT(*) FROM open_positions \n        WHERE lot_id IS NOT NULL \n        GROUP BY lot_id \n        HAVING COUNT(*) > 1\n      `);\n      \n      if (duplicates.rows.length === 0) {\n        // Check if constraint already exists\n        const constraintExists = await db.execute(sql`\n          SELECT constraint_name FROM information_schema.table_constraints \n          WHERE table_name = 'open_positions' AND constraint_name = 'open_positions_lot_id_unique'\n        `);\n        \n        if (constraintExists.rows.length === 0) {\n          console.log(\"[migrate] Adding unique constraint on lot_id...\");\n          await db.execute(sql`\n            ALTER TABLE open_positions ADD CONSTRAINT open_positions_lot_id_unique UNIQUE (lot_id)\n          `);\n        } else {\n          console.log(\"[migrate] lot_id unique constraint already exists\");\n        }\n      } else {\n        console.log(\"[migrate] WARNING: Duplicate lot_ids found, skipping unique constraint\");\n      }\n    } catch (e) {\n      console.log(\"[migrate] Constraint note:\", e);\n    }\n    \n    console.log(\"[migrate] Migration completed successfully!\");\n    await pool.end();\n    process.exit(0);\n  } catch (error) {\n    console.error(\"[migrate] Migration failed:\", error);\n    await pool.end();\n    process.exit(1);\n  }\n}\n\nrunMigration();\n","path":null,"size_bytes":5719,"size_tokens":null},"server/tests/smartguard-sizing-test.ts":{"content":"/**\n * SMART_GUARD Sizing Test Script\n * \n * Tests the following cases:\n * - Case A: balance=199, sgMinEntryUsd=100, allowUnderMin=true ‚Üí compra m√≠nima = 100\n * - Case B: balance=70, allowUnderMin=true ‚Üí compra = ~70 (>=20)\n * - Case C: balance=70, allowUnderMin=false ‚Üí bloqueo MIN_ORDER_USD\n * - Case D: maxTotalExposure alcanzada ‚Üí bloqueo EXPOSURE_ZERO\n * \n * Run with: npx tsx server/tests/smartguard-sizing-test.ts\n */\n\nconst SG_ABSOLUTE_MIN_USD = 20;\n\ninterface MinimumValidationParams {\n  positionMode: string;\n  orderUsdFinal: number;\n  orderUsdProposed: number;\n  usdDisponible: number;\n  exposureAvailable: number;\n  pair: string;\n  sgMinEntryUsd?: number;\n  sgAllowUnderMin?: boolean;\n  dryRun?: boolean;\n  env?: string;\n}\n\ninterface MinimumValidationResult {\n  valid: boolean;\n  skipReason?: \"MIN_ORDER_ABSOLUTE\" | \"MIN_ORDER_USD\";\n  message?: string;\n}\n\nfunction validateMinimumsOrSkip(params: MinimumValidationParams): MinimumValidationResult {\n  const {\n    positionMode,\n    orderUsdFinal,\n    sgMinEntryUsd = 100,\n    sgAllowUnderMin = true,\n  } = params;\n\n  if (orderUsdFinal < SG_ABSOLUTE_MIN_USD) {\n    return {\n      valid: false,\n      skipReason: \"MIN_ORDER_ABSOLUTE\",\n      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < m√≠nimo absoluto $${SG_ABSOLUTE_MIN_USD}`,\n    };\n  }\n\n  if (positionMode === \"SMART_GUARD\" && !sgAllowUnderMin && orderUsdFinal < sgMinEntryUsd) {\n    return {\n      valid: false,\n      skipReason: \"MIN_ORDER_USD\",\n      message: `Trade bloqueado: orderUsdFinal $${orderUsdFinal.toFixed(2)} < sgMinEntryUsd $${sgMinEntryUsd.toFixed(2)} (sgAllowUnderMin=OFF)`,\n    };\n  }\n\n  return { valid: true };\n}\n\ninterface TestCase {\n  name: string;\n  balance: number;\n  sgMinEntryUsd: number;\n  sgAllowUnderMin: boolean;\n  riskPerTradePct: number;\n  maxTradeUSD: number;\n  currentTotalExposure: number;\n  maxTotalExposurePct: number;\n  expectedOutcome: \"TRADE\" | \"MIN_ORDER_ABSOLUTE\" | \"MIN_ORDER_USD\" | \"EXPOSURE_ZERO\";\n  expectedOrderUsdFinal?: number;\n}\n\nfunction calculateSmartGuardSizing(\n  balance: number,\n  sgMinEntryUsd: number,\n  sgAllowUnderMin: boolean,\n  riskPerTradePct: number,\n  maxTradeUSD: number,\n  currentTotalExposure: number,\n  maxTotalExposurePct: number\n): { orderUsdFinal: number; skipReason?: string; message?: string } {\n  const usdDisponible = balance * 0.95;\n  \n  const riskBasedAmount = balance * (riskPerTradePct / 100);\n  const maxByRisk = Math.min(riskBasedAmount, maxTradeUSD);\n  const orderUsdProposed = Math.min(maxByRisk, usdDisponible);\n  \n  let tradeAmountUSD: number;\n  \n  if (usdDisponible >= sgMinEntryUsd) {\n    tradeAmountUSD = Math.max(orderUsdProposed, sgMinEntryUsd);\n    tradeAmountUSD = Math.min(tradeAmountUSD, usdDisponible, maxTradeUSD);\n  } else if (sgAllowUnderMin) {\n    tradeAmountUSD = usdDisponible;\n  } else {\n    tradeAmountUSD = usdDisponible;\n  }\n  \n  const maxTotalExposureUsd = balance * (maxTotalExposurePct / 100);\n  const maxTotalAvailable = Math.max(0, maxTotalExposureUsd - currentTotalExposure);\n  const maxByBalance = balance * 0.95;\n  const effectiveMaxAllowed = Math.min(maxTotalAvailable, maxByBalance);\n  \n  const minVolume = 0.00005;\n  const currentPrice = 90000;\n  const minRequiredUSD = minVolume * currentPrice;\n  \n  if (effectiveMaxAllowed < minRequiredUSD) {\n    return {\n      orderUsdFinal: 0,\n      skipReason: \"EXPOSURE_ZERO\",\n      message: `Sin exposici√≥n disponible. effectiveMaxAllowed=$${effectiveMaxAllowed.toFixed(2)} < minRequired=$${minRequiredUSD.toFixed(2)}`,\n    };\n  }\n  \n  const orderUsdFinal = tradeAmountUSD;\n  \n  const validation = validateMinimumsOrSkip({\n    positionMode: \"SMART_GUARD\",\n    orderUsdFinal,\n    orderUsdProposed,\n    usdDisponible,\n    exposureAvailable: effectiveMaxAllowed,\n    pair: \"BTC/USD\",\n    sgMinEntryUsd,\n    sgAllowUnderMin,\n  });\n  \n  if (!validation.valid) {\n    return {\n      orderUsdFinal,\n      skipReason: validation.skipReason,\n      message: validation.message,\n    };\n  }\n  \n  return { orderUsdFinal };\n}\n\nconst testCases: TestCase[] = [\n  {\n    name: \"Case A: balance=199, sgMinEntryUsd=100, allowUnderMin=true\",\n    balance: 199,\n    sgMinEntryUsd: 100,\n    sgAllowUnderMin: true,\n    riskPerTradePct: 15,\n    maxTradeUSD: 100,\n    currentTotalExposure: 0,\n    maxTotalExposurePct: 60,\n    expectedOutcome: \"TRADE\",\n    expectedOrderUsdFinal: 100,\n  },\n  {\n    name: \"Case B: balance=70, allowUnderMin=true ‚Üí compra ~66.5 (>=20)\",\n    balance: 70,\n    sgMinEntryUsd: 100,\n    sgAllowUnderMin: true,\n    riskPerTradePct: 15,\n    maxTradeUSD: 100,\n    currentTotalExposure: 0,\n    maxTotalExposurePct: 60,\n    expectedOutcome: \"TRADE\",\n    expectedOrderUsdFinal: 66.5,\n  },\n  {\n    name: \"Case C: balance=70, allowUnderMin=false ‚Üí bloqueo MIN_ORDER_USD\",\n    balance: 70,\n    sgMinEntryUsd: 100,\n    sgAllowUnderMin: false,\n    riskPerTradePct: 15,\n    maxTradeUSD: 100,\n    currentTotalExposure: 0,\n    maxTotalExposurePct: 60,\n    expectedOutcome: \"MIN_ORDER_USD\",\n  },\n  {\n    name: \"Case D: maxTotalExposure alcanzada ‚Üí bloqueo EXPOSURE_ZERO\",\n    balance: 199,\n    sgMinEntryUsd: 100,\n    sgAllowUnderMin: true,\n    riskPerTradePct: 15,\n    maxTradeUSD: 100,\n    currentTotalExposure: 120,\n    maxTotalExposurePct: 60,\n    expectedOutcome: \"EXPOSURE_ZERO\",\n  },\n  {\n    name: \"Case E: balance=15 (bajo absoluto) ‚Üí bloqueo MIN_ORDER_ABSOLUTE\",\n    balance: 15,\n    sgMinEntryUsd: 100,\n    sgAllowUnderMin: true,\n    riskPerTradePct: 15,\n    maxTradeUSD: 100,\n    currentTotalExposure: 0,\n    maxTotalExposurePct: 60,\n    expectedOutcome: \"MIN_ORDER_ABSOLUTE\",\n  },\n];\n\nconsole.log(\"=\".repeat(80));\nconsole.log(\"SMART_GUARD SIZING TEST SCRIPT\");\nconsole.log(\"=\".repeat(80));\nconsole.log(\"\");\n\nlet passed = 0;\nlet failed = 0;\n\nfor (const tc of testCases) {\n  const result = calculateSmartGuardSizing(\n    tc.balance,\n    tc.sgMinEntryUsd,\n    tc.sgAllowUnderMin,\n    tc.riskPerTradePct,\n    tc.maxTradeUSD,\n    tc.currentTotalExposure,\n    tc.maxTotalExposurePct\n  );\n  \n  const actualOutcome = result.skipReason || \"TRADE\";\n  const isOutcomeCorrect = actualOutcome === tc.expectedOutcome;\n  const isAmountCorrect = tc.expectedOrderUsdFinal === undefined || \n    Math.abs(result.orderUsdFinal - tc.expectedOrderUsdFinal) < 0.1;\n  \n  const testPassed = isOutcomeCorrect && isAmountCorrect;\n  \n  console.log(`TEST: ${tc.name}`);\n  console.log(`  Input: balance=$${tc.balance}, sgMinEntryUsd=$${tc.sgMinEntryUsd}, allowUnderMin=${tc.sgAllowUnderMin}`);\n  console.log(`  Input: riskPct=${tc.riskPerTradePct}%, maxTrade=$${tc.maxTradeUSD}, currentExposure=$${tc.currentTotalExposure}, maxExposurePct=${tc.maxTotalExposurePct}%`);\n  console.log(`  Expected: outcome=${tc.expectedOutcome}${tc.expectedOrderUsdFinal ? `, orderUsdFinal=$${tc.expectedOrderUsdFinal}` : \"\"}`);\n  console.log(`  Actual: outcome=${actualOutcome}, orderUsdFinal=$${result.orderUsdFinal.toFixed(2)}${result.message ? ` (${result.message})` : \"\"}`);\n  console.log(`  Result: ${testPassed ? \"‚úÖ PASSED\" : \"‚ùå FAILED\"}`);\n  console.log(\"\");\n  \n  if (testPassed) passed++;\n  else failed++;\n}\n\nconsole.log(\"=\".repeat(80));\nconsole.log(`SUMMARY: ${passed} passed, ${failed} failed`);\nconsole.log(\"=\".repeat(80));\n\nprocess.exit(failed > 0 ? 1 : 0);\n","path":null,"size_bytes":7235,"size_tokens":null},"server/services/fifoMatcher.ts":{"content":"import { db } from \"../db\";\nimport { storage } from \"../storage\";\nimport { sql, eq, and } from \"drizzle-orm\";\nimport { \n  openPositions as openPositionsTable,\n  lotMatches as lotMatchesTable,\n  tradeFills as tradeFillsTable\n} from \"@shared/schema\";\nimport type { TradeFill, OpenPosition, LotMatch } from \"@shared/schema\";\n\nexport interface MatchResult {\n  sellFillTxid: string;\n  pair: string;\n  totalMatched: number;\n  remainingUnmatched: number;\n  lotsUpdated: number;\n  lotsClosed: number;\n  matchesCreated: LotMatch[];\n  orphanQty: number;\n  pnlNet: number;\n  fullyMatched: boolean;\n}\n\nexport class FifoMatcher {\n  async processSellFill(sellFill: TradeFill): Promise<MatchResult> {\n    const result: MatchResult = {\n      sellFillTxid: sellFill.txid,\n      pair: sellFill.pair,\n      totalMatched: 0,\n      remainingUnmatched: parseFloat(sellFill.amount),\n      lotsUpdated: 0,\n      lotsClosed: 0,\n      matchesCreated: [],\n      orphanQty: 0,\n      pnlNet: 0,\n      fullyMatched: false,\n    };\n\n    const sellQty = parseFloat(sellFill.amount);\n    const sellPrice = parseFloat(sellFill.price);\n    const sellFeeTotal = parseFloat(sellFill.fee);\n    let sellRemaining = sellQty;\n\n    // Use transaction with row-level locking - ALL operations inside tx\n    await db.transaction(async (tx) => {\n      // SELECT FOR UPDATE to lock lots for this pair\n      const openLots = await tx.select().from(openPositionsTable)\n        .where(sql`${openPositionsTable.pair} = ${sellFill.pair} \n          AND (${openPositionsTable.qtyRemaining} > 0 OR ${openPositionsTable.qtyRemaining} IS NULL)`)\n        .orderBy(openPositionsTable.openedAt)\n        .for(\"update\");\n      \n      if (openLots.length === 0) {\n        console.log(`[FifoMatcher] No open lots for ${sellFill.pair}, orphan qty=${sellRemaining.toFixed(8)}`);\n        result.orphanQty = sellRemaining;\n        result.remainingUnmatched = sellRemaining;\n        return;\n      }\n\n      for (const lot of openLots) {\n        if (sellRemaining <= 0.00000001) break;\n\n        const lotQtyRemaining = parseFloat(lot.qtyRemaining || lot.amount);\n        if (lotQtyRemaining <= 0.00000001) continue;\n        \n        const matchQty = Math.min(sellRemaining, lotQtyRemaining);\n        \n        // Check for existing match WITHIN TRANSACTION (idempotency)\n        const existingMatches = await tx.select().from(lotMatchesTable)\n          .where(and(\n            eq(lotMatchesTable.sellFillTxid, sellFill.txid),\n            eq(lotMatchesTable.lotId, lot.lotId)\n          ));\n        \n        if (existingMatches.length > 0) {\n          const existingMatch = existingMatches[0];\n          console.log(`[FifoMatcher] Match already exists for ${sellFill.txid} + ${lot.lotId}, adjusting sellRemaining`);\n          sellRemaining -= parseFloat(existingMatch.matchedQty);\n          result.totalMatched += parseFloat(existingMatch.matchedQty);\n          result.pnlNet += parseFloat(existingMatch.pnlNet);\n          continue;\n        }\n\n        const buyPrice = parseFloat(lot.entryPrice);\n        const buyFeeTotal = this.getBuyFee(lot);\n        const buyFeeAllocated = (matchQty / parseFloat(lot.amount)) * buyFeeTotal;\n        const sellFeeAllocated = (matchQty / sellQty) * sellFeeTotal;\n\n        const revenue = matchQty * sellPrice;\n        const cost = matchQty * buyPrice;\n        const pnlGross = revenue - cost;\n        const pnlNet = pnlGross - buyFeeAllocated - sellFeeAllocated;\n\n        const newQtyRemaining = lotQtyRemaining - matchQty;\n        const newQtyFilled = parseFloat(lot.qtyFilled || \"0\") + matchQty;\n\n        try {\n          // Create lot match WITHIN TRANSACTION\n          const [match] = await tx.insert(lotMatchesTable).values({\n            sellFillTxid: sellFill.txid,\n            lotId: lot.lotId,\n            matchedQty: matchQty.toFixed(8),\n            buyPrice: buyPrice.toFixed(8),\n            sellPrice: sellPrice.toFixed(8),\n            buyFeeAllocated: buyFeeAllocated.toFixed(8),\n            sellFeeAllocated: sellFeeAllocated.toFixed(8),\n            pnlNet: pnlNet.toFixed(8),\n          }).returning();\n          \n          result.matchesCreated.push(match);\n          result.pnlNet += pnlNet;\n          sellRemaining -= matchQty;\n          result.totalMatched += matchQty;\n        } catch (error: any) {\n          if (error.code === '23505') {\n            // Duplicate - race condition, reconcile within tx\n            const existing = await tx.select().from(lotMatchesTable)\n              .where(and(\n                eq(lotMatchesTable.sellFillTxid, sellFill.txid),\n                eq(lotMatchesTable.lotId, lot.lotId)\n              ));\n            if (existing.length > 0) {\n              sellRemaining -= parseFloat(existing[0].matchedQty);\n              result.totalMatched += parseFloat(existing[0].matchedQty);\n              result.pnlNet += parseFloat(existing[0].pnlNet);\n            }\n            continue;\n          }\n          console.error(`[FifoMatcher] Error creating match:`, error.message);\n          throw error;\n        }\n\n        // Update lot quantities within transaction\n        await tx.update(openPositionsTable)\n          .set({ \n            qtyRemaining: newQtyRemaining.toFixed(8), \n            qtyFilled: newQtyFilled.toFixed(8),\n            updatedAt: new Date() \n          })\n          .where(eq(openPositionsTable.lotId, lot.lotId));\n        result.lotsUpdated++;\n\n        if (newQtyRemaining <= 0.00000001) {\n          await tx.delete(openPositionsTable)\n            .where(eq(openPositionsTable.lotId, lot.lotId));\n          result.lotsClosed++;\n          console.log(`[FifoMatcher] Lot ${lot.lotId} fully closed`);\n        }\n      }\n\n      // Only mark fill as matched if fully processed (sellRemaining ‚âà 0)\n      if (sellRemaining <= 0.00000001) {\n        await tx.update(tradeFillsTable)\n          .set({ matched: true })\n          .where(eq(tradeFillsTable.txid, sellFill.txid));\n        result.fullyMatched = true;\n      }\n    });\n\n    result.remainingUnmatched = sellRemaining;\n    if (sellRemaining > 0.00000001) {\n      result.orphanQty = sellRemaining;\n      console.log(`[FifoMatcher] ${sellRemaining.toFixed(8)} qty unmatched (no more open lots) - fill NOT marked as matched for retry`);\n    }\n    \n    console.log(`[FifoMatcher] Processed ${sellFill.txid}: matched=${result.totalMatched.toFixed(8)}, lots_closed=${result.lotsClosed}, pnl=${result.pnlNet.toFixed(2)}, fullyMatched=${result.fullyMatched}`);\n    \n    return result;\n  }\n\n  private getBuyFee(lot: OpenPosition): number {\n    // Try to get actual fee from config snapshot\n    if (lot.configSnapshotJson) {\n      const snapshot = lot.configSnapshotJson as any;\n      if (snapshot.entryFee) {\n        return parseFloat(snapshot.entryFee);\n      }\n    }\n    // Fallback: estimate from cost at Kraken rate (0.4% taker)\n    const amount = parseFloat(lot.amount);\n    const price = parseFloat(lot.entryPrice);\n    const cost = amount * price;\n    return cost * 0.004;\n  }\n\n  async processAllUnmatchedSells(): Promise<{ processed: number; errors: string[] }> {\n    const pairs = [\"BTC/USD\", \"ETH/USD\", \"SOL/USD\", \"XRP/USD\", \"TON/USD\"];\n    let processed = 0;\n    const errors: string[] = [];\n\n    for (const pair of pairs) {\n      const unmatchedSells = await storage.getUnmatchedSellFills(pair);\n      for (const sellFill of unmatchedSells) {\n        try {\n          await this.processSellFill(sellFill);\n          processed++;\n        } catch (error: any) {\n          errors.push(`${sellFill.txid}: ${error.message}`);\n        }\n      }\n    }\n\n    return { processed, errors };\n  }\n\n  async initializeLots(): Promise<number> {\n    return await storage.initializeQtyRemainingForAll();\n  }\n}\n\nexport const fifoMatcher = new FifoMatcher();\n","path":null,"size_bytes":7715,"size_tokens":null}},"version":2}

===== FILE: ./.local/state/replit/agent/.latest.json =====
{"latest": "main"}